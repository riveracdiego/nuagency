;/*FB_PKG_DELIM*/

__d("CoalescingLoader",[],(function(t,n,r,o,a,i){"use strict";function e(){return new Promise(function(e){return globalThis.setTimeout(e,0)})}var l=(function(){function t(t,n){n===void 0&&(n=e),this.$1=t,this.$2=[],this.$3=null,this.$4=n}var n=t.prototype;return n.gen=async function(t){this.$2.push(t);var e=this.$2.length-1,n=await this.$5();return n[e]},n.$5=function(){return this.$3!=null?this.$3:(this.$3=this.$6(),this.$3)},n.$6=async function(){await this.$4();var e=this.$2;return this.$2=[],this.$3=null,this.$1([].concat(e))},t})();i.CoalescingLoader=l}),66);
__d("EBAPI",["MAWEBCombinedSwitch","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(e=r("requireDeferred"))("EBAPIMinosVerifySingleEpoch").__setRef("EBAPI"),u=e("EBAPIWriteMinosPublicKeysForRecipient").__setRef("EBAPI"),c=e("EBGetContactEpochHead").__setRef("EBAPI"),d=e("EBGetMessageKeys").__setRef("EBAPI"),m=e("EBIsEbEnabled").__setRef("EBAPI"),p=e("EBMinosWriteKeyChangeAdminMessage").__setRef("EBAPI"),_=e("EBMinosWriteSecureStorageAlert").__setRef("EBAPI"),f={getContactEpochHead:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return c.load().then(function(e){return e.getContactEpochHead.apply(e,t)})},getMessageKeys:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return d.load().then(function(e){return e.getMessageKeys.apply(e,t)})},isEBEnabled:function(){return o("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled()},isEbEnabledEbSwitch:function(){return m.load().then(function(e){return e.isEbEnabledEbSwitch()})},minosVerifySingleEpoch:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return s.load().then(function(e){return e.minosVerifySingleEpoch.apply(e,t)})},writeMinosKeyChangeAdminMessage:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return p.load().then(function(e){return e.writeMinosKeyChangeAdminMessage.apply(e,t)})},writeMinosMailboxKeysForRecipientAPI:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return u.load().then(function(e){return e.writeMinosMailboxKeysForRecipientAPI.apply(e,t)})},writeMinosSecureStorageAlert:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return _.load().then(function(e){return e.writeMinosSecureStorageAlert.apply(e,t)})}},g=f;l.default=g}),98);
__d("MAWBridgeReceiverFetchInfo",["WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r,o){var a=o.accessibilitySummaryText,i=o.mimetype,l=o.previewHeight,s=o.previewUrl,u=o.previewUrlExpirationTimestampMs,m=o.previewWidth,p=o.receiverFetchId,_=o.type;return{accessibilitySummaryText:a,mimetype:i,msgId:t,previewHeight:l,previewUrl:s,previewUrlExpirationTimestampMs:d(u),previewWidth:m,receiverFetchId:p,sortOrderMs:c(n,r),threadJid:e,type:_}}function u(e,t,n,r,o){var a=o.mimetype,i=o.previewHeight,l=o.previewWidth,s=o.receiverFetchId,u=o.type;return{mimetype:a,msgId:t,previewHeight:i,previewWidth:l,receiverFetchId:s,sortOrderMs:c(n,r),threadJid:e,type:u}}function c(e,t){return o("WATimeUtils").castToMillisTime(e!=null?e:t*1e3)}function d(t){if(t!=null)try{return o("WATimeUtils").castLongIntToMillisTime(t)}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast previewUrlExpirationTimestampMs to millis time: ",""])),t);return}}l.createBridgeReceiverFetchInfoPayloadFromDbInfo=s,l.createBridgeReceiverFetchInfoPayloadFromUnstoredInfo=u}),98);
__d("MAWDbMsgTypeVersionTxns",["MAWDbAppMeta","MAWDexieTable","MAWTransactionMode","MAWTransactor","MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion}).then(function(e){return e==null?void 0:e.value.msgTypeVersion})}function u(e,t){return e.appMeta.add({key:o("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion,value:{msgTypeVersion:t}})}function c(e,t){return e.appMeta.put({key:o("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion,value:{msgTypeVersion:t}})}function d(e,t){return e.appMeta.add({key:o("MAWDbAppMeta").AppMetaKeysEnum.hmacKey,value:{hmacKey:t}})}function m(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.hmacKey}).then(function(e){return e==null?void 0:e.value.hmacKey})}function p(e,t){return e.appMeta.get({key:t})}function _(e,t){return o("MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor").setCachedShouldSaveSecurityAlert(t),e.appMeta.put({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert,value:{allowSecurityAlert:t}}).then(r("emptyFunction"))}function f(e,t){return e.appMeta.put({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlertForSelf,value:{allowSecurityAlertForSelf:t}}).then(r("emptyFunction"))}function g(){return o("MAWTransactor").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY},"handleInstructions",function(e){return function(){return h(e)}})()}function h(e){return p(e,o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlert)!=null?t:!1})}function y(e){return p(e,o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlertForSelf).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlertForSelf)!=null?t:!0})}function C(e,t){return e.appMeta.add({key:o("MAWDbAppMeta").AppMetaKeysEnum.hotlikeSticker,value:{hotlikeSticker:t}})}function b(e){return o("MAWDexieTable").dexieAll([y(e),h(e)]).then(function(e){var t=e[0],n=e[1];return{allowSecurityAlertForContact:n,allowSecurityAlertForSelf:t}})}l.MSG_TYPE_VERSION=(e=o("MAWDbAppMeta")).AppMetaKeysEnum.msgTypeVersion,l.ALLOW_SECURITY_ALERT_FOR_CONTACT=e.AppMetaKeysEnum.allowSecurityAlert,l.ALLOW_SECURITY_ALERT_FOR_SELF=e.AppMetaKeysEnum.allowSecurityAlertForSelf,l.HOT_LIKE=e.AppMetaKeysEnum.hotlikeSticker,l.getMsgTypeVersion=s,l.addMsgTypeVersion=u,l.updateMsgTypeVersion=c,l.addHMACKey=d,l.getHMACKey=m,l.getAppMetaValue=p,l.updateSecurityAlertValueForContact=_,l.updateSecurityAlertValueForSelf=f,l.getSecuritySettingForContactTxn=g,l.getSecuritySettingForContact=h,l.getSecuritySettingForSelf=y,l.addHotLike=C,l.maybeBulkGetSecuritySetting=b}),98);
__d("mergeMaps",[],(function(t,n,r,o,a,i){"use strict";function e(){for(var e=new Map,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var o=0;o<n.length;o++)for(var a=n[o].keys(),i=void 0;!(i=a.next()).done;)e.set(i.value,n[o].get(i.value));return e}i.default=e}),66);
__d("MpsPreprocessor",["Promise","getSafeQplErrorMessage","mergeMaps"],(function(t,n,r,o,a,i,l){"use strict";var e=["errors"],s;function u(t,a){return function(r){var o=r.payloadList.map(function(e){return e.message.messageId});r.ctx.messageToQpl.all(o).addPoint(a+"_start");var l=r.errors,u=babelHelpers.objectWithoutPropertiesLoose(r,e),c=t(u);return c instanceof(s||(s=n("Promise")))?c.then(function(e){return i(e,l!=null?l:new Map)}):i(c,l!=null?l:new Map)};function i(e,t){var n=e.payloadList.map(function(e){return e.message.messageId});return e.ctx.messageToQpl.all(n).addPoint(a+"_end"),e.errors.entries().forEach(function(t){var n=t[0],r=t[1];e.ctx.messageToQpl.endFail(n,a.toLowerCase()+"-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),babelHelpers.extends({},e,{errors:r("mergeMaps")(t,e.errors)})}}l.preprocessor=u}),98);
__d("MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor",["MAWDbMsgTypeVersionTxns","MAWProtobufDeserializers","MpsPreprocessor","WAGlobals"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){e=t}var u=o("MpsPreprocessor").preprocessor(async function(t){var n=t.ctx,r=t.payloadList,a=new Map,i=[];for(var l of r){var s,u,c=l.directive,d=l.insertionSource,m=l.message,p=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(m.payload),_=(s=p.payload().proto)==null||(s=s.event)==null?void 0:s.deviceChange;if(_==null){i.push({directive:c,insertionSource:d,message:m});continue}if(((u=p.proto.metadata)==null?void 0:u.senderId)===o("WAGlobals").getMyUserJid()){n.messageToQpl.addPoint(m.messageId,"drop_security_alert_my_device"),n.messageToQpl.endSuccess(m.messageId);continue}e===null&&(e=await o("MAWDbMsgTypeVersionTxns").getSecuritySettingForContactTxn()),e===!0?i.push({directive:c,insertionSource:d,message:m}):(n.messageToQpl.addPoint(m.messageId,"drop_security_alert_disabled"),n.messageToQpl.endSuccess(m.messageId))}return{ctx:n,errors:a,payloadList:i}},"maybe_drop_security_alerts");l.setCachedShouldSaveSecurityAlert=s,l.MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor=u}),98);
__d("MAWHMACKey",["MAWCryptoConsts","MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWKeychainUtil","MAWSubtleCrypto","MAWTransactionMode","WABase64","tweetnacl-auth"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e=o("MAWKeychainUtil").getBufferWithRandomValuesFromLength(o("MAWCryptoConsts").HKDF_SEED_LENGTH_IN_BYTES);return c(e).then(function(e){return o("MAWSubtleCrypto").MAWSubtleCrypto.exportKey("raw",e)})}function s(e,t){var n=new TextEncoder().encode(e),a=new Uint8Array(t),i=r("tweetnacl-auth")(n,a);return o("WABase64").encodeB64UrlSafe(i)}function u(){return e().then(function(e){return o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READWRITE},"generateAndInsertHMACKey",function(t){return function(){return o("MAWDbMsgTypeVersionTxns").getHMACKey(t).then(function(n){return n!=null?n:o("MAWDbMsgTypeVersionTxns").addHMACKey(t,e).then(function(){return e})})}})()})}function c(e){return o("MAWSubtleCrypto").MAWSubtleCrypto.importKey("raw",e,{hash:"SHA-256",name:"HMAC"},!0,["sign"])}l.genHMACKey=e,l.hmacTweetNaCl=s,l.generateAndInsertHMACKey=u}),98);
__d("MAWMediaUtils",["FBLogger","MAWDbMedia","MAWDexieTable","MAWHMACKey","MAWImageUtils","MAWMsgType","WABlobToArrayBuffer","WAGlobals","WAHashUtils","WAMsgType","WATimeUtils","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){switch(t===void 0&&(t="media"),e){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return t==="xma-media"?"xma-image":"image";case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return"video";case o("MAWDbMedia").MEDIA_TYPE.PTT:return"ptt";case o("MAWDbMedia").MEDIA_TYPE.GIF:return"gif";case o("MAWDbMedia").MEDIA_TYPE.STICKER:return"sticker";case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return"document";default:throw r("FBLogger")("messenger_web").mustfixThrow("get a wrong media file with type %s",e)}}function s(e){try{return o("WABlobToArrayBuffer").blobToArrayBuffer(e).then(u)}catch(e){var t=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").mustfixThrow("Got %s when convert the blob to Uint8Array",t.message)}}function u(e){return self.crypto.subtle.digest("SHA-256",e).then(function(e){return new Uint8Array(e)})}async function c(e){var t=await s(e),n=o("WAHashUtils").toPlaintextHash(t),r=m(n);return[n,r]}async function d(e){var t=await u(e),n=o("WAHashUtils").toPlaintextHash(t);return n}function m(e){var t=o("WAGlobals").getHMACKey();return o("WAHashUtils").toHashedPlaintextHash(o("MAWHMACKey").hmacTweetNaCl(e,t))}function p(e){if(e==null)return null;var t="preview-"+o("WATimeUtils").unixTime().toString()+".jpeg";return _(e,t,"image/jpeg")}function _(e,t,n){return new File([new Blob([new Uint8Array(e)],{type:n})],t,{type:n})}function f(e,t,n){var r=function(){return n!=null?o("MAWDexieTable").dexieResolve(n.filter(function(e){return e.type!==o("WAMsgType").REVOKED&&t.msgIds.includes(e.msgId)})):e.messages.where("msgId").anyOf(t.msgIds).filter(function(e){return e.type!==o("WAMsgType").REVOKED}).toArray()};return r().then(function(e){return h(t,e)})}function g(e){return e.reduce(function(e,t){var n=t.hdType;return n!=null&&(e[t.msgId]=n),e},{})}function h(e,t){var n=t.filter(function(t){return t.type!==o("WAMsgType").REVOKED&&e.msgIds.includes(t.msgId)}),a=n.map(function(e){return e.msgId}),i=babelHelpers.extends({},e,{msgIds:a}),l=n.reduce(function(e,t){return e[t.msgId]=o("WATimeUtils").castToMillisTime(t.sortOrderMs!=null?t.sortOrderMs:t.ts*1e3),e},{});if(i=babelHelpers.extends({},i,{messagesSortOrderMs:l}),n.every(function(e){return e.type===o("WAMsgType").STICKER})){var s=o("MAWImageUtils").boundHeightWidth(i.previewHeight,i.previewWidth,o("MAWImageUtils").STICKER_THUMBNAIL_MAX_SIZE),u=s.height,c=s.width;i=babelHelpers.extends({},i,{mediaType:o("MAWDbMedia").MEDIA_TYPE.STICKER,previewHeight:u,previewHeightLarge:u,previewWidth:c,previewWidthLarge:c})}var d=new Set(n.map(function(e){return e.type}));return d.forEach(function(t){t!==o("MAWMsgType").MSG_TYPE.RAVEN&&e.mediaType!==y(t)&&r("FBLogger")("messenger_web").mustfix("Message and media type mismatch: message with type %s is associated with media with type %s",t,e.mediaType)}),i}function y(e){switch(e){case o("MAWMsgType").MSG_TYPE.IMAGE:return o("MAWDbMedia").MEDIA_TYPE.IMAGE;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("MAWDbMedia").MEDIA_TYPE.VIDEO;case o("MAWMsgType").MSG_TYPE.PTT:return o("MAWDbMedia").MEDIA_TYPE.PTT;case o("MAWMsgType").MSG_TYPE.GIF:return o("MAWDbMedia").MEDIA_TYPE.GIF;case o("MAWMsgType").MSG_TYPE.STICKER:return o("MAWDbMedia").MEDIA_TYPE.STICKER;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE}}function C(e){var t,n,r,o=((t=e.ancillary)==null?void 0:t.gifPlayback)===!0,a=(n=(r=e.integral)==null||(r=r.transport)==null||(r=r.ancillary)==null||(r=r.mimetype)==null?void 0:r.startsWith("image"))!=null?n:!1;return o&&a}function b(e){var t,n,r,o=((t=e.ancillary)==null?void 0:t.gifPlayback)===!0,a=(n=(r=e.integral)==null||(r=r.transport)==null||(r=r.ancillary)==null||(r=r.mimetype)==null?void 0:r.startsWith("video"))!=null?n:!1;return o&&a}l.getServerMediaTypeFromMediaType=e,l.hashBlob=s,l.hashArrayBuffer=u,l.genBlobHashes=c,l.genHashFromArrayBuffer=d,l.genHMACPlaintextHash=m,l.convertJpegThumbnailArrayBufferToFile=p,l.getBridgeMediaAnnotatedForDisplay=f,l.createHdTypesForBridgeMedia=g,l.annotateBridgeMediaForDisplay=h,l.getMediaTypeFromMsgType=y,l.isTransportLegacyGif=C,l.isTransportVideoGif=b}),98);
__d("MAWLoadReplyMediaTxns",["MAWBridgeReceiverFetchInfo","MAWDbMedia","MAWDbMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWMediaUtils","MAWMsgType","MAWUserJidWrapper","MAWXMAUtils","MWPBumpEntityKey","WAAssertUnreachable","WAJids","WALogger","WAMsgType","WAResultOrError","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e,t,n){if(r("gkx")("2419")&&n!=null){var a=o("MAWMediaUtils").genHMACPlaintextHash(n);return e.media.where("hashedPlaintextHash").equals(a).first()}else return e.media.get(t)}var g=new Set([(_=o("MAWDbMedia")).MEDIA_TYPE.IMAGE,_.MEDIA_TYPE.GIF,_.MEDIA_TYPE.PTT,_.MEDIA_TYPE.STICKER,_.MEDIA_TYPE.VIDEO,_.MEDIA_TYPE.DOCUMENT_FILE]);function h(e){var t;switch(e.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.STICKER:t=e.validatedImageInfo;break;case o("MAWDbMedia").MEDIA_TYPE.VIDEO:t=e.validatedVideoInfo;break}var n=t||{},r=n.height,a=n.jpegThumbnailHeight,i=n.jpegThumbnailWidth,l=n.width;return{replyMediaPreviewHeight:a!=null?a:r,replyMediaPreviewWidth:i!=null?i:l}}function y(e){switch(e.type){case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return!0;case o("MAWMsgType").MSG_TYPE.XMA:return r("gkx")("9921")?!0:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(e.xmaMessageType)||o("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType);case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("WAMsgType").NOTE_REPLY:case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case o("MAWMsgType").MSG_TYPE.RAVEN:return!1;default:return r("WAAssertUnreachable")(e.type)}}function C(t,n,r){if(n==null)return o("MAWDexieTable").dexieResolve();var a=f(t,n,r).then(function(e){if(e==null)return o("WAResultOrError").makeError("reply_media_not_found");if(!g.has(e.mediaType))return o("WAResultOrError").makeError("reply_media_type_unknown");var t=h(e),r=t.replyMediaPreviewHeight,a=t.replyMediaPreviewWidth;return n!=null&&e.plaintextHash==null&&o("MWPBumpEntityKey").bumpEntityKeyWithAppId("maw.reply_attachment_media_missing_plaintext_hash","load_reply_media_txns_for_reply_type_'unknown'}"),o("WAResultOrError").makeResult({replyMediaId:n,replyMediaPreviewHeight:r,replyMediaPreviewWidth:a,replyPlaintextHash:e.plaintextHash})});return a.then(function(t){if(t.success!==!0){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media with id ",": ",""])),n,t.error);return}return t.value})}function b(e,t){var n=t.defaultPreviewMediaId;if(n==null)return o("MAWDexieTable").dexieResolve({replyXMAId:t.xmaId});var r=f(e,n).then(function(e){if(e==null)return o("WAResultOrError").makeError("reply_xma_media_not_found - "+t.targetType);if(!g.has(e.mediaType))return o("WAResultOrError").makeError("reply_xma_media_type_unknown");var n=h(e),r=n.replyMediaPreviewHeight,a=n.replyMediaPreviewWidth;return o("WAResultOrError").makeResult({replyMediaPreviewHeight:r,replyMediaPreviewWidth:a,replyPlaintextHash:e.plaintextHash,replyXMAId:t.xmaId})});return r.then(function(e){if(e.success!==!0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media XMA with id ",": ",""])),t.xmaId,e.error);return}return e.value})}function v(e,t,n){var a,i,l;n===void 0&&(n=!1);var s=((a=t.quote)==null?void 0:a.content)||{},u=s.author,c=s.externalId,d=s.mediaId,m=s.msgId,p=s.plaintextHash,_=s.type,f=s.xmaMessageType;if(((i=t.quote)==null?void 0:i.content)==null||!y((l=t.quote)==null?void 0:l.content))return o("MAWDexieTable").dexieResolve();var g=t.threadJid,h=u===o("MAWUserJidWrapper").getMyUserJid(),b=h?o("WAJids").AUTHOR_ME:u;return(r("gkx")("9921")?_===o("MAWMsgType").MSG_TYPE.XMA:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(f))?S(e,o("MAWJidUtils").maybeToProtocolMsgId(b,g,c)):_===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?E(e,m):C(e,d,n?null:p)}function S(e,t){return t==null?o("MAWDexieTable").dexieResolve():o("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(e,t).then(function(t){if(!(t==null||o("MAWXMAUtils").isXMAExpired(t.isTombstoned,t.targetExpiringAtSec)))return b(e,t)})}function R(e,t){var n=t.author,a=t.externalId,i=t.mediaId,l=t.plaintextHash,s=t.threadJid,u=t.type,c=t.xmaMessageType,d=r("gkx")("9921")?u===o("MAWMsgType").MSG_TYPE.XMA:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(c),m=u===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH;return!o("MAWDbMsg").isMediaMsg(t)&&!d&&!m?o("MAWDexieTable").dexieResolve():d?S(e,o("MAWJidUtils").maybeToProtocolMsgId(n,s,a)):m?L(e,t.receiverFetchId):C(e,i,l)}function L(e,t,n){return t==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing receiverFetchId for getReplyMediaForReceiverFetchWithReceiverFetchId"]))),o("MAWDexieTable").dexieResolve()):e.receiverFetchInfo.get({receiverFetchId:t}).then(function(e){if(e==null){o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Missing receiverFetchInfo for getReplyMediaForReceiverFetchWithReceiverFetchId"])));return}try{var t=o("MAWDbMedia").convertNumberToMediaId(parseInt(e.receiverFetchId,10));return n!=null&&o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(n.threadJid,n.msgId,n.sortOrderMs,n.ts,e)}),{replyMediaId:t,replyMediaPreviewHeight:e.previewHeight,replyMediaPreviewWidth:e.previewWidth}}catch(e){o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unable to convert receiver fetch id to media id: ",""])),e);return}})}function E(e,t){return t==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Missing msgId for getReplyMediaForReceiverFetch"]))),o("MAWDexieTable").dexieResolve()):e.messages.get({msgId:t}).then(function(t){if(t==null||t.type!==o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH||t.receiverFetchId==null){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Invalid msg for getReplyMediaForReceiverFetch with type: ",""])),t==null?void 0:t.type);return}return L(e,t.receiverFetchId,t)})}l.getMedia=f,l.MSG_MEDIA_TYPE=g,l.getImageAttributes=h,l.isMediaReplyContent=y,l.getReplyMediaForMsgQuote=v,l.getReplyMediaForMsg=R}),98);
__d("EncryptedBackupsUtils",["FBLogger","WAJids","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return Date.now()-t>o("WATimeUtils").DAY_MILLISECONDS*30},s=function(t){return Date.now()-t>o("WATimeUtils").DAY_MILLISECONDS*30};function u(e,t,n,r,o){var a={frankingTag:r==null?void 0:r.frankingTag,reportingTag:r==null?void 0:r.reportingTag},i={frankingMetadata:a,messageId:t,senderId:e,timestampMs:n};return{encryptedTransportMessage:o,metadata:i}}function c(e){return JSON.stringify([e.author,e.chat,e.externalId])}function d(e){var t=JSON.parse(e);if(!Array.isArray(t))throw r("FBLogger")("wmi_eb").mustfixThrow("Unable to parse msg id string as proper json");if(t.length!==3)throw r("FBLogger")("wmi_eb").mustfixThrow("Parsed array should have 3 components");var n=o("WAJids").unsafeCoerceToUserJid(t[0]),a=o("WAJids").unsafeCoerceToChatJid(t[1]),i=o("WAStanzaUtils").toStanzaId(t[2]);return{author:n,chat:a,externalId:i}}l.entryOlderThan30Days=e,l.timestampOlderThan30Days=s,l.asBackupMessage=u,l.convertWAMsgIdToStringId=c,l.convertStringIdToWAMsgId=d}),98);
__d("WAMsgMap",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e){var t=this;this.$1=new Map,e==null||e.forEach(function(e){var n=e[0],r=e[1];t.set(n,r)})}var t=e.prototype;return t.clear=function(){this.$1.clear()},t.delete=function(t){var e;(e=this.$1.get(t.externalId))==null||(e=e.get(t.author))==null||e.delete(t.chat)},t.get=function(t){var e;return(e=this.$1.get(t.externalId))==null||(e=e.get(t.author))==null?void 0:e.get(t.chat)},t.has=function(t){var e,n;return(e=(n=this.$1.get(t.externalId))==null||(n=n.get(t.author))==null?void 0:n.has(t.chat))!=null?e:!1},t.set=function(t,n){var e,r,o=(e=this.$1.get(t.externalId))!=null?e:new Map;this.$1.has(t.externalId)||this.$1.set(t.externalId,o);var a=(r=o.get(t.author))!=null?r:new Map;return o.has(t.author)||o.set(t.author,a),a.set(t.chat,n),this},t.keys=function(){var e=[],t=this.$1;for(var n of t.keys()){var r,o=(r=t.get(n))!=null?r:new Map;for(var a of o.keys()){var i,l=(i=o.get(a))!=null?i:new Map;for(var s of l.keys())e.push({externalId:n,author:a,chat:s})}}return e},t.entries=function(){var e=[],t=this.$1;for(var n of t.keys()){var r,o=(r=t.get(n))!=null?r:new Map;for(var a of o.keys()){var i,l=(i=o.get(a))!=null?i:new Map;for(var s of l.keys()){var u=l.get(s);u!=null&&e.push([{externalId:n,author:a,chat:s},u])}}}return e},t.values=function(){return this.entries().map(function(e){return e[1]})},e})();i.MsgMap=e}),66);
__d("MAWDbMsgUtil",["WAJids","WALogger","WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return t.reduce(function(t,n){var r=n.threadJid;return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Missing jid prevents adding message to array map"]))),t):n.author==="@system"?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Invalid author when converting msg array to map"]))),t):(t.set({author:n.author,chat:r,externalId:n.externalId},n),t)},new(o("WAMsgMap")).MsgMap)}function c(e){return o("WAJids").isAuthorSystem(e.author)||e.threadJid==null?null:{author:e.author,chat:e.threadJid,externalId:e.externalId}}l.convertMsgArrayToMap=u,l.getProtocolMsgIdFromDbMsg=c}),98);
__d("MAWDbUnrenderedMsgTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgUtil","MAWDexieTable","WAJids","WALogger","WAMsgMap","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=t.author,r=t.chat,a=t.externalId;return e.threads.get({jid:r}).then(function(t){return t==null?o("WAResultOrError").makeError("missing_thread_unrendered_msg"):m(e,a,r,n).then(function(e){return e==null?o("WAResultOrError").makeError("missing_unrendered_msg"):o("WAResultOrError").makeResult(e)})})}function d(e,t){var n=t.map(function(e){var t=e.externalId;return t});return e.unrenderedMessages.where("externalId").anyOf(n).toArray().then(function(e){var n=o("MAWDbMsgUtil").convertMsgArrayToMap(e),r=new(o("WAMsgMap")).MsgMap;return t.forEach(function(e){var t=n.get(e);t!=null&&r.set(e,t)}),r})}function m(e,t,n,r){return e.unrenderedMessages.where("externalId").equals(t).filter(function(e){return e.author===r&&e.threadJid===n}).first()}function p(e,t){return e+"_"+t}function _(e,t){var n=t.map(function(e){var t=e.externalId;return t}),r=Array.from(new Set(t.map(function(e){return e.chat})));return o("MAWDexieTable").dexieAll([e.threads.where("jid").anyOf(r).toArray(),e.unrenderedMessages.where("externalId").anyOf(n).toArray()]).then(function(e){var n=e[0],r=e[1];if(r.length===0||n.length===0)return[];var o=new Map;return t.forEach(function(e){var t=e.author,n=e.chat,r=e.externalId,a=o.get(r)||new Set;a.add(p(t,n)),o.set(r,a)}),r.filter(function(e){var t=e.author,n=e.externalId,r=e.threadJid,a=o.get(n);return a!=null&&r!=null&&a.has(p(t,r))})})}function f(t,n,r){return g(t,[{ack:r,msgId:n}]).then(function(t){var n=t[0];return n==null?(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAckForUnrenderedMsg on non existing message"]))),null):n})}function g(e,t){var n=t.map(function(e){return e.msgId}),r=new Map;return t.forEach(function(e){return r.set(e.msgId,{ack:e.ack})}),e.unrenderedMessages.where("msgId").anyOf(n).toArray().then(function(t){if(t.length===0)return t;var n=[],a=[];return t.forEach(function(e){var t;if(e.author!==o("WAJids").AUTHOR_ME){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on incoming message"]))),n.push(e);return}if(e.ack>o("MAWAckLevel").ACK.clock){o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on sent message"]))),n.push(e);return}var i=(t=r.get(e.msgId))==null?void 0:t.ack;if(i==null)return null;var l=babelHelpers.extends({},e,{ack:i});i===o("MAWAckLevel").ACK.sent&&delete l.resendCount,a.push(l)}),e.unrenderedMessages.bulkPut(a).then(function(){return[].concat(a,n)})})}function h(e,t){var n=t.map(function(t){return e.unrenderedMessages.get({msgId:t})});return o("MAWDexieTable").dexieAll(n)}function y(e,t){return e.unrenderedMessages.where("msgId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.msgId);return t+1})}l.maybeGetUnrenderedMsgByProtocolMsgId=c,l.getUnrenderedMsgMapByProtocolMsgId=d,l.maybeGetUnrenderedMsgByExternalId=m,l.getUnrenderedMsgsByProtocolMsgId=_,l.updateSystemAckForUnrenderedMsg=f,l.bulkUpdateSystemAckForUnrenderedMsgs=g,l.getUnrenderedMsgsByMsgIds=h,l.getNextUnrenderedMsgIdNumberForThread=y}),98);
__d("MAWExtractMsFromExternalId",["I64","MAWExternalId","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=2199023255551;function c(t){try{var n=(s||(s=o("I64"))).of_string_opt(t);if(n!=null){var r;return(r=d(n))!=null?r:0}}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to convert externalId to number: ",""])),t)}return 0}function d(e){var t=Number((s||(s=o("I64"))).to_string(s.and_(s.lsr_(e,22),s.of_float(u))));return o("MAWExternalId").getThreeMostSignificantDigitsForSortOrderTimestamp(t)}l.extractMsFromStanzaId=c,l.extractMsFromExternalId=d}),98);
__d("MAWMessageSortOrderUtils",["I64","MAWDbMsg","MAWExtractMsFromExternalId","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(t){var n=t.revokedExternalId!=null?t.revokedExternalId:t.externalId;n==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["generateAuthoritativeMessageSortOrder called without ID"])));var r=(d||(d=o("I64"))).of_string_opt(n);if(t.serverTs==null){var a;if(t.sortOrderMs!=null)return t.sortOrderMs;r==null&&o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] ExternalId is not present"])));var i=r==null?null:o("MAWExtractMsFromExternalId").extractMsFromExternalId(r);return Math.floor((a=t.originalTs)!=null?a:o("MAWDbMsg").getCanonicalTsFromMsg(t))*1e3+(i!=null?i:0)}if(r!=null){var l=o("MAWExtractMsFromExternalId").extractMsFromExternalId(r);if(l!=null){var m=t.originalTs!=null?t.originalTs:t.serverTs;return Number(m)*1e3+l}else o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Timestamp bits in externalId not valid"])))}else o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] externalId is not a valid int64"])));return o("MAWDbMsg").getSortOrderWithFallback(t)}l.generateAuthoritativeMessageSortOrder=m}),98);
__d("WAArrayGroupBy",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){for(var n=new Map,r=0;r<e.length;r++){var o=t(e[r]),a=n.get(o);a==null?n.set(o,[e[r]]):a.push(e[r])}return Array.from(n.entries())}i.groupBy=e}),66);
__d("MAWDbMsgTxns",["EncryptedBackupsUtils","FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbMsg","MAWDbMsgUtil","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWMessageSortOrderUtils","MAWMsgType","MAWODSProxy","MAWTransactionMode","MAWTransactor","Random","WAArrayGroupBy","WAJids","WALogger","WAMsg","WAMsgMap","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction","gkx","justknobx","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g;function h(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.messages.get({msgId:t})}function y(e,t){return e.messages.where("threadJid").equals(t).count().then(function(e){return e===0})}function C(e,t,n){return e.messages.where("threadJid").equals(t).filter(n).first().then(function(e){return e!=null})}function b(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).between([t,Number.MIN_SAFE_INTEGER],[t,Number.MAX_SAFE_INTEGER],n,r)}function v(e,t){return b(e,t,!1,!1).last()}function S(e,t){return v(e,t).then(function(e){return e==null?void 0:e.msgId})}function R(e,t){return v(e,t).then(function(e){return(e==null?void 0:e.sortOrderMs)==null?null:o("WATimeUtils").castToMillisTime(e.sortOrderMs)})}function L(e,t,n){return r("vulture")("ST6o7qk-BKGl46ZXS71LYr_2y6I="),b(e,t,!1,!1).reverse().limit(n).toArray()}function E(e,t){return b(e,t,!1,!1).first()}function k(e,t){return E(e,t).then(function(e){return e==null?void 0:e.msgId})}function I(e,t){return e.messages.where("externalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).toArray().then(D)}function T(e,t){var n=new Set(t.map(function(e){var t=e.author,n=e.chat,r=e.externalId;return o("WAMsg").craftWAMsgIdString({author:t,chat:n,externalId:r})}));return e.messages.where("externalId").anyOf(t.map(function(e){var t=e.externalId;return t})).filter(function(e){var t=e.author,r=e.externalId,a=e.threadJid;return n.has(o("WAMsg").craftWAMsgIdString({author:t,chat:a,externalId:r}))}).toArray().then(function(e){return o("WAArrayGroupBy").groupBy(e,function(e){return o("WAMsg").craftWAMsgIdString({author:e.author,chat:e.threadJid,externalId:e.externalId})}).map(function(e){var t=e[0],n=e[1];return D(n)}).filter(Boolean)})}function D(t){if(t.length>1){var n=t.map(function(e){var t,n;return e.type+":"+((t=e.serverTs)!=null?t:0).toString()+":"+((n=e.ts)!=null?n:0).toString()}),a=new Set(n).size===1;a?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Suspected multiple instances of same message!"]))):o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Can't have "," messages with the same protocolMsgId!"])),t.length),(r("gkx")("5039")||o("Random").coinflip(r("justknobx")._("3594")))&&x(t)}return t[0]}function x(e){var t=e.length;if(!(t<=1)){var n=t-1,a=e[n],i={editCount:0,mediaId:0,revokedStatus:0,serverTs:0,sortOrderMs:0,ts:0,type:0};e.slice(0,n).forEach(function(e){var t=[];if((e==null?void 0:e.editCount)!==(a==null?void 0:a.editCount)){var n,l;i.editCount++,t.push("editCount, reference: "+((n=a==null?void 0:a.editCount)!=null?n:"")+", duplicate: "+((l=e==null?void 0:e.editCount)!=null?l:"")+". ")}if((e==null?void 0:e.mediaId)!==(a==null?void 0:a.mediaId)&&(i.mediaId++,t.push("mediaId, reference: "+((a==null?void 0:a.mediaId)!=null?String(a.mediaId):"")+", duplicate: "+((e==null?void 0:e.mediaId)!=null?String(e.mediaId):"")+". ")),e.sortOrderMs!==a.sortOrderMs&&(i.sortOrderMs++,t.push("sortOrderMs, reference: "+String(a.sortOrderMs)+", duplicate: "+String(e.sortOrderMs)+". ")),e.serverTs!==a.serverTs&&(i.serverTs++,t.push("serverTs, reference: "+String(a.serverTs)+", duplicate: "+String(e.serverTs)+". ")),e.ts!==a.ts&&(i.ts++,t.push("ts, reference: "+String(a.ts)+", duplicate: "+String(e.ts)+". ")),e.type!==a.type){var s,u;(e.type===o("MAWMsgType").MSG_TYPE.REVOKED||a.type===o("MAWMsgType").MSG_TYPE.REVOKED)&&(i.revokedStatus++,r("FBLogger")("MAWDuplicateMessageComparison").info("Revoked duplicate msg conflict, duplicate message, %s, has type: %s, externalId: %s, revokedExternalId: %s, sortOrderMs: %s, serverTs: %s, ts: %s, rowId: %s, reference msg, %s, has type: %s, externalId: %s, revokedExternalId: %s, sortOrderMs: %s, serverTs: %s, ts: %s, rowId: %s",e.msgId,e.type,e.externalId,e.revokedExternalId,e.sortOrderMs,e.serverTs,e.ts,e.rowId,a.msgId,a.type,a.externalId,a.revokedExternalId,e.sortOrderMs,e.serverTs,e.ts,e.rowId)),i.type++,t.push("type, reference: "+((s=a.type)!=null?s:"")+", duplicate: "+((u=e.type)!=null?u:"")+". ")}var c=t.join("");c.length>0?r("FBLogger")("MAWDuplicateMessageComparison").info("Duplicate msg, %s, has conflicting field values to reference msg, %s: %s",e.msgId,a.msgId,c):r("FBLogger")("MAWDuplicateMessageComparison").info("Duplicate msg, %s, has no conflicting field values to reference msg, %s",e.msgId,a.msgId)}),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"sets_of_duplicate_msgs"}),Object.keys(i).forEach(function(e){var t=i[e];t>0&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"sets_of_duplicate_msgs_with_"+e+"_field_differences"})}),o("MAWODSProxy").odsBumpEntityKey({amount:t-1,entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"number_of_duplicate_msgs"}),Object.keys(i).forEach(function(e){var t=i[e];t>0&&o("MAWODSProxy").odsBumpEntityKey({amount:t,entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"number_of_duplicate_msgs_with_"+e+"_field_differences"})})}}function $(e,t,n,r){var o={author:r,chat:n,externalId:t};return I(e,o)}function P(e,t){return e.messages.where("msgId").equals(t).toArray()}function N(e,t){return A(e,t).then(function(e){return e.success,e})}function M(e,t){var n=t.map(function(e){var t=e.externalId;return t});return e.messages.where("externalId").anyOf(n).toArray().then(function(e){var n=o("MAWDbMsgUtil").convertMsgArrayToMap(e),r=new(o("WAMsgMap")).MsgMap;return t.forEach(function(e){var t=n.get(e);t!=null&&r.set(e,t)}),r})}function w(e,t){return e.messages.where("msgId").equals(t).first().then(function(e){return e==null?void 0:e.sortOrderMs})}function A(e,t){var n=t.author,r=t.chat,a=t.externalId;return e.threads.get({jid:r}).then(function(t){return t==null?o("WAResultOrError").makeError("missing_thread_msg"):$(e,a,t.jid,n).then(function(e){return e==null?o("WAResultOrError").makeError("missing_msg"):o("WAResultOrError").makeResult(e)})})}function F(e,t){var n=t.author,r=t.chat,o=t.externalId;return e.threads.get({jid:r}).then(function(t){if(t!=null)return e.messages.where("revokedExternalId").equals(o).filter(function(e){return e.author===n&&e.threadJid===t.jid&&e.type==="Revoked"}).first()})}function O(e,t,n,r){var a=e.messages.where("revokedExternalId").equals(t).filter(function(e){return e.author===r&&e.threadJid===n&&e.type===o("MAWMsgType").MSG_TYPE.REVOKED}).first(),i=o("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByExternalId(e,t,n,r).then(function(e){if((e==null?void 0:e.type)===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return e});return o("MAWDexieTable").dexieAll([a,i]).then(function(e){var t=e[0],n=e[1];return t!=null||n!=null})}function B(e,t){var n=new Array(t.length),r=new Set;return t.forEach(function(e){n.push(e.externalId),r.add(o("EncryptedBackupsUtils").convertWAMsgIdToStringId(e))}),e.messages.where("externalId").anyOf(n).filter(function(e){return r.has(o("EncryptedBackupsUtils").convertWAMsgIdToStringId({author:e.author,chat:e.threadJid,externalId:e.externalId}))}).toArray()}function W(e,t,n,r,a,i){return q(e,[{ack:n,applicationErrorCode:i,msgId:t,reportingMeta:a,serverTs:r}]).then(function(e){var n=e.find(function(e){return e.msgId===t});return n==null?(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAck on non existing message"]))),null):n})}function q(e,t){var n=t.map(function(e){return e.msgId});return o("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(e,n).then(function(r){var a=new Map;t.forEach(function(e){a.set(e.msgId,{ack:e.ack,applicationErrorCode:e.applicationErrorCode,reportingMeta:e.reportingMeta,serverTs:e.serverTs});var t=r.get(e.msgId);t!=null&&a.set(t,{ack:e.ack,applicationErrorCode:e.applicationErrorCode,reportingMeta:e.reportingMeta,serverTs:e.serverTs})});var i=Array.from(new Set(n.concat(Array.from(r.values()))));return e.messages.where("msgId").anyOf(i).toArray().then(function(t){if(t.length===0)return t;var n=[],r=[];return t.forEach(function(e){var t,i,l;if(e.author!==o("WAJids").AUTHOR_ME||e.ack>o("MAWAckLevel").ACK.clock){n.push(e);return}var s=(t=a.get(e.msgId))==null?void 0:t.ack,u=(i=a.get(e.msgId))==null?void 0:i.serverTs;if(s==null)return null;var c=babelHelpers.extends({},e,{ack:s});U(c,u);var d=(l=a.get(e.msgId))==null?void 0:l.reportingMeta;d!=null&&(c.reportingMeta=d),s===o("MAWAckLevel").ACK.sent&&delete c.resendCount,r.push(c)}),n.length>0&&o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck: not updating ",""])),n.map(function(e){return e.msgId}).toString()),e.messages.bulkPut(r).then(function(){return o("MAWDexieTable").dexieAll(r.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)}))}).then(function(e){return r.forEach(function(t,n){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e[n])})}),[].concat(r,n)})})})}function U(e,t){if(t!=null){e.serverTs=t;var n=e.sortOrderMs;e.type!==o("MAWMsgType").MSG_TYPE.REVOKED&&(e.sortOrderMs=o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(e),o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Message was acked by server (serverTs = ","), override sortOrderMs: "," -> ",""])),t,n,e.sortOrderMs))}}function V(e,t,n,a){return o("MAWDbThreadTxns").getThread(e,t).then(function(t){if(!(!t.success||a==null)){var i=t.value,l=[e.messages.where(["threadJid","sortOrderMs"]).above([i.jid,a]).first(),e.messages.where(["threadJid","sortOrderMs"]).below([i.jid,a]).last()];return o("MAWDexieTable").dexieAll(l).then(function(t){var a=t[0],l=t[1];return o("MAWDbThreadTxns").updateThread(e,babelHelpers.extends({},i,{newestMsgTs:(l==null?void 0:l.ts)==null?i.newestMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(l.ts),oldestMsg:i.oldestMsg===n?a==null?void 0:a.msgId:i.oldestMsg})).then(r("emptyFunction"))})}})}function H(e){return e.messages.where("altIndex").equals(o("MAWDbMsg").FUTUREPROOF_ALT_INDEX).toArray().then(function(e){var t=[];return e.forEach(function(e){if(e.type!==o("MAWMsgType").MSG_TYPE.FUTUREPROOF){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["getFutureproofMsg gets a message "," with unsupported type ",""])),e.msgId,e.type);return}t.push(e)}),t})}function G(e){return e.toString()}function z(e,t,n,a){var i=t.mediaId;if(i===n)return o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""])),t.msgId,n),o("MAWDexieTable").dexieResolve();var l=i!=null?e.media.get(i):o("MAWDexieTable").dexieResolve();return l.then(function(i){i&&o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Replacing mediaId for message with pre-existing media. type=",""])),t.type);var l=a!=null?a:void 0,s=babelHelpers.extends({},t,{mediaId:n,plaintextHash:l});return e.messages.put(s).then(r("emptyFunction"))})}function j(e,t){var n=Array.from(t.keys());return e.messages.where("msgId").anyOf(n).toArray().then(function(n){var a=[];return n.map(function(e){var n=t.get(e.msgId),i=e.mediaId;if(i!=null&&i!==n){if(n!=null)throw r("FBLogger")("messenger_web").mustfixThrow("mediaId "+G(i)+" in message "+e.msgId+" is different with the "+G(n)+" in bulkUpdateMediaId");o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""])),e.msgId,n);return}var l=babelHelpers.extends({},e,{mediaId:n,plaintextHash:e.plaintextHash});a.push(l)}),e.messages.bulkPut(a).then(r("emptyFunction"))})}function K(e,t){return Q(e,[t]).then(r("emptyFunction"))}function Q(e,t){return e.messages.where("msgId").anyOf(t).toArray().then(function(t){var n=t.map(function(e){return babelHelpers.extends({},e,{isExpiredXmaMsg:!0})});return e.messages.bulkPut(n).then(function(){return n})})}function X(e,t,n,r){if(r!=null&&r<=0)return o("MAWDexieTable").dexieResolve([]);var a=e.messages.where("altIndex").equals(o("MAWDbMsg").craftToBeReadAltIndex(t)).filter(function(e){return o("MAWDbMsg").getSortOrderWithFallback(e)<=n});return r!=null&&(a=a.limit(r)),a.toArray()}function Y(e,t,n){return X(e,t,n).then(function(t){var n=t.map(function(e){return babelHelpers.extends({altIndex:null},e)});return e.messages.bulkPut(n).then(function(){return n})})}function J(e,t){return e.messages.delete(t)}function Z(e,t){return e.messages.bulkDelete(t)}function ee(e,t,n){var r=t.map(function(e){return e.rowId}),a=n!=null?t.map(function(e){var t=o("MAWJidUtils").toProtocolMsgId(e);if(t)return babelHelpers.extends({},t,{reason:n})}).filter(Boolean):[];return o("MAWDexieTable").dexieAll([e.deletedMessages.bulkAdd(a),e.messages.bulkDelete(r)]).then(function(e){var t=e[0],n=e[1];o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Successfull deleted "," messages"])),n)})}function te(e,t){return e.messages.where("msgId").anyOf(t).toArray()}function ne(e){return e.messages.where("altIndex").anyOf([o("MAWDbMsg").SPAM_ALT_INDEX,o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX]).toArray()}function re(e,t,n,r,a,i,l,s){l===void 0&&(l="before"),s===void 0&&(s=null);var u=n==null?null:o("MAWDbMsg").getSortOrderWithFallback(n);return l==="before"?e.messages.where(["threadJid","sortOrderMs"]).between([t,s!=null?s:Number.MIN_SAFE_INTEGER],[t,u!=null?u:Number.MAX_SAFE_INTEGER],!0,r).reverse().filter(i).limit(a).toArray():e.messages.where(["threadJid","sortOrderMs"]).between([t,u!=null?u:Number.MIN_SAFE_INTEGER],[t,s!=null?s:Number.MAX_SAFE_INTEGER],r,!0).filter(i).limit(a).toArray().then(function(e){return e.sort(function(e,t){return t.ts-e.ts})})}function oe(e,t,n,r){var o=n.msgId;if(r==null){var a;return{oldestMsg:(a=e==null?void 0:e.msgId)!=null?a:o}}var i=[e,t,n].filter(Boolean);return{oldestMsg:i.reduce(function(e,t){return ae(e,o,r)<ae(t,o,r)?e:t}).msgId}}function ae(e,t,n){return e.msgId===t?n:o("MAWDbMsg").getSortOrderWithFallback(e)}function ie(e,t){return e.messages.where("msgId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.msgId);return t+1})}function le(e){return o("MAWTransactor").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"checkMessagesExistenceByProtocolMsgIds",function(t){return function(){return o("MAWDexieTable").dexieAll(e.map(function(e){return t.messages.get({protocolMsgId:e.chat+"."+e.externalId})}))}})()}function se(e,t){return e.messages.where("externalId").anyOf(t).toArray()}l.maybeGetMsg=h,l.getIsThreadEmpty=y,l.doesThreadHaveMsgsMatchCriteria=C,l.getThreadMessagesBySortOrder=b,l.getThreadNewestMessageBySortOrder=v,l.getThreadNewestMessageId=S,l.getThreadNewestMessageMs=R,l.getThreadNewestNumMessagesBySortOrder=L,l.getThreadOldestMessageBySortOrder=E,l.getThreadOldestMessageId=k,l.maybeGetMsgByProtocolMsgId=I,l.getUniqueMsgsByProtocolMsgIds=T,l.maybeGetMsgByExternalId=$,l.maybeGetMsgListByMsgId_I_KNOW_WHAT_I_AM_DOING=P,l.maybeGetMsgResultByProtocolMsgId=N,l.getMsgMapByProtocolMsgId=M,l.getSortOrderFromMsgId=w,l.maybeGetRevokedMsgByProtocolMsgId=F,l.checkIfMsgIsDeletedForMeOrRevoked=O,l.getMsgsByProtocolMsgId=B,l.updateSystemAck=W,l.bulkUpdateSystemAck=q,l.maybeUpdateThreadMsgsForDeleteForMe=V,l.getFutureProofMsgs=H,l.updateMediaId=z,l.bulkUpdateMediaId=j,l.updateDbMsgXMAExpiration=K,l.bulkUpdateDbMsgXMAExpired=Q,l.getMsgsNeedingRetroactiveReadReceiptsUpTo=X,l.clearRetroactiveReadReceiptStatusFromMsgsUpTo=Y,l.deleteDbMsg=J,l.bulkDeleteDbMsg=Z,l.deleteMessages=ee,l.getMsgsByMsgIds=te,l.getSpamMsgs=ne,l.fetchMessagesFromDbWithSortOrderMs=re,l.calculateOldestMsg=oe,l.getNextMsgIdNumberForThread=ie,l.checkMessagesExistenceByProtocolMsgIds=le,l.UNSAFE_getMultipleMsgsByExternalId=se}),98);
__d("MAWAuthoritativeThreadsCache",[],(function(t,n,r,o,a,i){"use strict";var e=new Set;i.AuthoritativeThreadsCache=e}),66);
__d("MAWBridgeTypesCreators",["FBLogger","MAWAudioUtils","MAWDbMsg","MAWImageUtils","MAWMsgType","MAWUserJidWrapper","WAJids","WAMediaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{threadJid:e}}function s(e){var t,n=e.ts;switch(e.type){case o("MAWMsgType").MSG_TYPE.REVOKED:n=(t=e.originalTs)!=null?t:e.ts;break;default:n=o("MAWDbMsg").getCanonicalTsFromMsg(e)}return{msgId:e.msgId,ts:n}}function u(e,t){var n=t.map(s);return{messages:n,threadJid:e}}function c(e){return{ravenMsgId:e.msgId,threadJid:e.threadJid}}function d(e,t){return e.filter(function(e){return t===e.threadJid}).map(function(e){return e.msgId})}function m(e){var t,n,a,i,l,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R=e.chatJid,L=e.filteredMsgIds,E=e.hasMediaForUI,k=e.hdTypes,I=e.media,T=e.offlineAttachmentId,D=e.ravenSettings,x=e.sortOrderMs,$=e.transportKey;switch(I.mediaType){case"Image":return{duration:null,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,hasMedia:E,hasPreviewMedia:((t=I.validatedImageInfo)==null?void 0:t.jpegThumbnail)!=null,hdTypes:k,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(n=I.validatedImageInfo)==null?void 0:n.jpegThumbnailHeight,previewHeightLarge:(a=I.validatedImageInfo)==null?void 0:a.height,previewWidth:(i=I.validatedImageInfo)==null?void 0:i.jpegThumbnailWidth,previewWidthLarge:(l=I.validatedImageInfo)==null?void 0:l.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Video":return{duration:((s=I.validatedVideoInfo)==null?void 0:s.duration)!=null?((u=I.validatedVideoInfo)==null?void 0:u.duration)*1e3:0,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,gifPlayback:((c=I.validatedVideoInfo)==null?void 0:c.gifPlayback)===!0||I.isVideoGif===!0,hasMedia:E,hasPreviewMedia:((d=I.validatedVideoInfo)==null?void 0:d.jpegThumbnail)!=null,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(m=I.validatedVideoInfo)==null?void 0:m.jpegThumbnailHeight,previewHeightLarge:(p=I.validatedVideoInfo)==null?void 0:p.height,previewWidth:(_=I.validatedVideoInfo)==null?void 0:_.jpegThumbnailWidth,previewWidthLarge:(f=I.validatedVideoInfo)==null?void 0:f.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Ptt":return{duration:(g=I.validatedAudioInfo)!=null&&g.duration?I.validatedAudioInfo.duration*1e3:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts),waveformData:((h=I.validatedAudioInfo)==null?void 0:h.waveform)!=null?o("MAWAudioUtils").serializeWaveform(I.validatedAudioInfo.waveform):void 0};case"Gif":return{accessibilitySummaryText:(y=I.accessibilitySummaryText)!=null?y:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(C=I.validatedImageInfo)==null?void 0:C.jpegThumbnailHeight,previewHeightLarge:(b=I.validatedImageInfo)==null?void 0:b.height,previewWidth:(v=I.validatedImageInfo)==null?void 0:v.jpegThumbnailWidth,previewWidthLarge:(S=I.validatedImageInfo)==null?void 0:S.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Sticker":{var P,N,M,w=o("MAWImageUtils").boundHeightWidth((P=I.validatedImageInfo)==null?void 0:P.jpegThumbnailHeight,(N=I.validatedImageInfo)==null?void 0:N.jpegThumbnailWidth,o("MAWImageUtils").STICKER_THUMBNAIL_MAX_SIZE),A=w.height,F=w.width;return{accessibilitySummaryText:(M=I.accessibilitySummaryText)!=null?M:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:A,previewHeightLarge:A,previewWidth:F,previewWidthLarge:F,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}case"DocumentFile":{var O,B={};for(var W of I.mediaEntries){var q=W[0],U=W[1],V=o("WAMediaUtils").mediaEntryDataToRawData(I.plaintextHash,U),H=V.filename;H!=null&&(B[q]=H)}return{defaultFilename:(O=I.validatedDocumentFileInfo)==null?void 0:O.filename,duration:null,filenames:B,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}default:throw I.mediaType,r("FBLogger")("messenger_web").mustfixThrow("[createBridgeMedia] Unsupported media type: "+I.mediaType)}}function p(e,t,n){return{chatJid:e,deliveredWatermarkTs:n!=null?n:o("WATimeUtils").castToUnixTime(0),fbid:t,lastReadActionTs:o("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0)}}function _(e){var t=e.cannotReplyReason,n=e.folder,r=e.snippetParams,o=e.snippetSenderContactId,a=e.snippetType,i=e.threadJid;return{cannotReplyReason:t,folder:n,snippetContactIDs:r==null?void 0:r.contactIDs,snippetMentionJIDs:r==null?void 0:r.mentionJIDs,snippetParams:r==null?void 0:r.strings,snippetSenderContactId:o,snippetType:a,threadJid:i}}function f(e){return{chatJid:e.groupJid,memberAddMode:e.memberAddMode,threadName:e.name}}var g={snippetContactIDs:[],snippetMentionJIDs:[],snippetParams:[],snippetSenderContactId:null,snippetType:null};function h(e){var t,n=e.bumpTimestampMs,r=e.description,o=e.isMessageAuthorMe,a=e.isUnbump,i=e.skipBumpTimestampValidation,l=e.skipServerThreadBump,s=e.snippetData,u=e.threadJid,c=s==null?g:{snippetContactIDs:s.params.contactIDs,snippetMentionJIDs:(t=s.params.mentionJIDs)!=null?t:[],snippetParams:s.params.strings,snippetSenderContactId:s.senderContactId,snippetType:s.type};return babelHelpers.extends({},c,{bumpTimestampMs:n,description:r,isMessageAuthorMe:o,isUnbump:a,skipBumpTimestampValidation:i!=null?i:!1,skipServerThreadBump:l!=null?l:!1,threadJid:u})}function y(e){var t=e.author,n=e.chatJid,r=e.reaction,a=e.reactToMsgId,i=e.ts;return{actorId:o("WAJids").authorToUserId(t,o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid())),chatJid:n,messageId:a,reaction:r,ts:i}}function C(e){var t=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),n=e.author,r=e.chatJid,a=e.reactToMsgId;return{actorId:o("WAJids").authorToUserId(n,t),chatJid:r,messageId:a}}function b(e){return{creationTs:e.creationTs,creator:e.creator,groupJid:e.groupJid,msgExpiration:e.msgExpiration,name:e.name,nameOwner:e.nameOwner,nameTs:e.nameTs,participantVersion:e.participantVersion}}function v(e){var t=e.threadJid,n=e.inviteeJid;return{caption:e.caption,inviteCode:e.inviteCode,inviteeId:n,inviteExpireTs:e.inviteExpirationTs,inviterId:o("WAJids").extractUserId(e.inviterJid),threadJid:t}}function S(e){return{threadJid:e}}function R(e,t,n){return{senderId:o("WAJids").extractUserId(t),state:n,threadJid:e}}l.createBridgeUpdateE2EEMetadataParticipants=e,l.createBridgeDeletedMessage=s,l.createBridgeDeleteMessages=u,l.createBridgeRavenAction=c,l.getMsgIdsFilteredByJid=d,l.createBridgeMedia=m,l.createBridgeReceivedReceipt=p,l.createBridgeUpdatedThread=_,l.createBridgeUpdatedGroupInfo=f,l.createBridgeBumpedThreadV2=h,l.createBridgeUpsertReaction=y,l.createBridgeDeleteReaction=C,l.createBridgeGroupInfo=b,l.createBridgeGroupInvite=v,l.createBridgeDeleteGroupInvite=S,l.createBridgeReceivedChatState=R}),98);
__d("MaybeCreateOrUpdateThreadResultCache",[],(function(t,n,r,o,a,i){"use strict";var e=new Map;function l(t){e.delete(t)}i.cache__I_KNOW_WHAT_I_AM_DOING=e,i.deleteCachedThreadResult=l}),66);
__d("MAWDbThreadTxns",["MAWAuthoritativeThreadsCache","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MaybeCreateOrUpdateThreadResultCache","WAArrayZip","WALogger","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return e.threads.get({deduplicationKey:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function d(e,t){return e.threads.get({jid:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function m(e,t){return e.threads.where("jid").anyOf(t).toArray()}function p(e,t){return e.threads.where("jid").startsWith(t+"@").first().then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function _(e){o("MaybeCreateOrUpdateThreadResultCache").deleteCachedThreadResult(e),o("MAWAuthoritativeThreadsCache").AuthoritativeThreadsCache.delete(e)}function f(e,t){return e.threads.where("jid").equals(t).delete().then(function(){return _(t)})}function g(e,t){return e.participants.where("userJid").equals(t).toArray().then(function(t){var n=t.map(function(e){return e.threadJid});return m(e,n)})}function h(e,t){return e.participants.where("userJid").anyOf(t).toArray().then(function(t){var n=new Map,r=new Set;return t.forEach(function(e){var t,o=e.userJid,a=(t=n.get(o))!=null?t:[];a.push(e.threadJid),n.set(o,a),r.add(e.threadJid)}),m(e,Array.from(r)).then(function(e){var t=e.reduce(function(e,t){return e.set(t.jid,t),e},new Map);return new Map(Array.from(n.entries()).map(function(e){var n=e[0],r=e[1];return[n,r.map(function(e){return t.get(e)}).filter(Boolean)]}))})})}function y(e,t,n){return(t==null?void 0:t.lastReadMsgReceiptSent)==null?o("MAWDexieTable").dexieResolve(!1):o("MAWDbMsgTxns").getSortOrderFromMsgId(e,t.lastReadMsgReceiptSent).then(function(e){return n.sortOrderMs==null||e==null?!1:n.sortOrderMs<=e})}function C(e,t){return e.threads.get({jid:t.threadJid}).then(function(n){return y(e,n,t)})}function b(e,t){return e.threads.where("jid").anyOf(t.map(function(e){return e.threadJid})).toArray().then(function(n){return o("MAWDexieTable").dexieAll(o("WAArrayZip").zip(t,n).map(function(t){var n=t[0],r=t[1];return y(e,r,n)}))})}function v(e,t,n){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var r=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{archived:!0,cannotReplyReason:n?"viewer_not_subscribed":e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.ARCHIVED})});return e.threads.bulkPut(r).then(function(){r.forEach(function(e){n&&o("WALogger").LOG(["[Occamadillo] Leaving a group thread\n          "+e.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.ARCHIVED,threadJid:e.jid})})})})})}function S(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{cannotReplyReason:null})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){var t={cannotReplyReason:null,threadJid:e.jid};o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(t)})})})})}function R(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{archived:!1,cannotReplyReason:e.cannotReplyReason==="viewer_not_subscribed"?e.cannotReplyReason:null,folder:o("MAWFolderTypes").FOLDER_ID.INBOX})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:e.jid})})})})})}function L(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{cannotReplyReason:"viewer_not_subscribed"})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){var t={cannotReplyReason:"viewer_not_subscribed",threadJid:e.jid};o("WALogger").LOG(["[Occamadillo] User is unsubscribed from thread\n          "+e.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(t)})})})})}function E(t,n){return d(t,n).then(function(n){if(!n.success){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed to get the thread"])));return}var a=n.value;if(a.isMigratedLocally===!0){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed because thread is already migrated"])));return}var i=babelHelpers.extends({},a,{isMigratedLocally:!0});return t.threads.put(i).then(r("emptyFunction"))})}function k(e,t){if(t.isMigratedLocally===!1)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["markCutoverThreadAsNotMigratedLocally failed because thread is already unmigrated"]))),o("MAWDexieTable").dexieResolve(t);var n=babelHelpers.extends({},t,{isMigratedLocally:!1});return e.threads.put(n).then(function(){return n})}function I(e,t){return e.threads.put(t).then(r("emptyFunction"))}function T(e,t,n,r,a){return I(e,babelHelpers.extends({},t,{newestMsgTs:(a==null?void 0:a.ts)==null?t.newestMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(a.ts),oldestMsg:r==null?void 0:r.msgId}))}l.getThreadByDeduplicationKey=c,l.getThread=d,l.getThreads=m,l.getThreadPrimaryId=p,l.deleteThread=f,l.getAllThreadsForUser=g,l.getAllThreadsForUsers=h,l.needsRetroactiveReadReceiptInThread=C,l.bulkNeedsRetroactiveReadReceiptInThread=b,l.archiveThreads=v,l.subscribeToThreads=S,l.unarchiveThreads=R,l.unsubscribeFromThreads=L,l.markCutoverThreadAsMigratedLocally=E,l.markCutoverThreadAsNotMigratedLocally=k,l.updateThread=I,l.updateThreadMsgsForUndefinedOldestOrNewestMsgs=T}),98);
__d("MAWDbChunkTxns",["MAWDexieTable","MAWMediaUtils","MAWODSProxy","MWFBLogger","WAErrorMessage","WAOdsEnums"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbChunkTxns"]),m=function(t,n,r,a,i,l){l===void 0&&(l=0);var e=o("MAWMediaUtils").genHMACPlaintextHash(n);return p(t,n,e,r,a,i,l)},p=function(n,r,a,i,l,m,_){return _===void 0&&(_=0),n.chunk.where("hashedPlaintextHash").equals(a).first().then(function(t){var f={blobData:i,hashedPlaintextHash:a,isProgressivePreview:m!=null?m:void 0,mimetype:l,plaintextHash:r};if(t){_>0&&d.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Chunk found after retry for hashedPlaintextHash: ",""])),a);var g=m!==!0&&t.isProgressivePreview===!0;if(g){var h=babelHelpers.extends({},f,{chunkId:t.chunkId});return n.chunk.put(h).then(function(){return h})}else return t}return n.chunk.add(f).then(function(e){return babelHelpers.extends({},f,{chunkId:e})}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);if(_>0)throw d.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk for hashedPlaintextHash: ",". Error: ",""])),a,t),d.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk after retry. Error: ",""])),t),e;return d.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk. Possible duplicate? Will attempt a retry. For hashedPlaintextHash: ",". Error: ",""])),a,t),o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_CHUNK,key:"retry"}),p(n,r,a,i,l,m,_+1)})})},_=function(t,n){return t.chunk.where("hashedPlaintextHash").equals(n)},f=function(t,n){return _(t,n).count().then(function(e){return e>0})},g=function(t,n){return o("MAWDexieTable").dexieAll(n.map(function(e){return f(t,e).then(function(t){return[e,t]})})).then(function(e){return new Map(e)})},h=function(t,n){return _(t,n).first()},y=function(t,n){return t.chunk.where("hashedPlaintextHash").anyOf(n).toArray().then(function(e){return new Map(e.map(function(e){return[e.hashedPlaintextHash,e]}))})},C=function(t,n){var e=n.map(o("MAWMediaUtils").genHMACPlaintextHash);return t.chunk.where("hashedPlaintextHash").anyOf(e).toArray().then(function(e){return new Map(e.map(function(e){return[e.plaintextHash,e]}))})};function b(e,t){return e.chunk.bulkGet(t)}l.getOrCreateMediaChunkWithPlaintextHash=m,l.getOrCreateMediaChunkWithHashedPlaintextHash=p,l.hasMediaChunk=f,l.hasMediaChunks=g,l.maybeGetChunkFromHash=h,l.maybeBulkGetChunksFromHash=y,l.maybeBulkGetChunksFromPlaintextHash=C,l.bulkGetChunks=b}),98);
__d("MAWDbMediaTxns",["MAWDbMsg","MAWDexieTable","MAWMediaUtils","MAWMsgType","MAWODSProxy","WAHashUtils","WALogger","WAOdsEnums","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.media.get({mediaId:t})}function m(e,t){return t.length===0?o("MAWDexieTable").dexieResolve(new Map):e.media.bulkGet(t).then(function(e){return new Map(e.filter(Boolean).map(function(e){return[e.mediaId,e]}))})}function p(e,t){return e.media.where("hashedPlaintextHash").equals(t).first()}function _(e,t){var n=o("MAWMediaUtils").genHMACPlaintextHash(t);return p(e,n)}function f(e,t){var n=t.map(function(e){return o("MAWMediaUtils").genHMACPlaintextHash(e)});return g(e,n)}function g(e,t){return e.media.where("hashedPlaintextHash").anyOf(t).toArray()}function h(e,t){return t==null?o("MAWDexieTable").dexieResolve():y(e,t).then(function(n){var r=n==null?void 0:n.mediaId;return r!=null?e.media.get({mediaId:r}):e.media.get({objectId:t})})}function y(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.mediaBackup.get({objectId:t})}function C(e,t){if(t==null)return o("MAWDexieTable").dexieResolve();var n=e.mediaBackup.where("msgId").equals(t).toArray();return n}function b(t,n){var a=n.filter(o("MAWDbMsg").isMediaMsg);if(a.length===0)return o("MAWDexieTable").dexieResolve([]);o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[getMsgMediaPairFromMsgs] msgs: ",""])),a.map(function(e){return""+e.msgId}));var i=a.reduce(function(e,t){return t.mediaId==null?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: "," and msg type ",""])),t.msgId,t.type),e):e.set(t.mediaId,t)},new Map),l=Array.from(i.keys());return R(t,l).then(function(e){var t=[];return e.forEach(function(e){if(e==null)throw r("err")("Error missing media");var n=i.get(e.mediaId);if(n==null)throw r("err")("Error missing media");var a=o("MAWMediaUtils").genHMACPlaintextHash(e.plaintextHash);a!==e.hashedPlaintextHash&&(o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[getMsgMediaPairFromMsgs] encountered mismatched hashedPlaintextHash for media. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(e.plaintextHash)),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MEDIA_MISMATCH_HASHED_PLAINTEXT_HASH,key:"mismatch."+n.type})),t.push([n,e])}),t})}function v(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.filter(o("MAWDbMsg").isMediaMsg).map(function(e){var t=e.mediaId;if(t==null)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: ",""])),e.msgId),r("err")("mediaId is missing");return t});return R(e,n).then(function(e){var t=[];return e.forEach(function(e){e!=null&&t.push(e)}),t})}function S(e,t){if(t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME||o("MAWDbMsg").isMediaMsg(t)){var n=t.mediaId;return n==null?t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult()):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing")):e.media.get(n).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}else return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult())}function R(e,t){return e.media.bulkGet(t)}function L(e,t){var n=t.previewMediaIds!=null?R(e,t.previewMediaIds):o("MAWDexieTable").dexieResolve(),r=t.headerMediaId!=null?e.media.get(t.headerMediaId):o("MAWDexieTable").dexieResolve(),a=t.faviconMediaId!=null?e.media.get(t.faviconMediaId):o("MAWDexieTable").dexieResolve(),i=t.defaultPreviewMediaId!=null?e.media.get(t.defaultPreviewMediaId):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([n,r,a,i]).then(function(e){var n=e[0],r=e[1],a=e[2],i=e[3];if(t.headerMediaId!=null&&r==null||t.faviconMediaId!=null&&a==null||n==null)return o("WAResultOrError").makeError("missing");var l=[];for(var s of n){if(s==null)return o("WAResultOrError").makeError("missing");l.push(s)}return o("WAResultOrError").makeResult({defaultPreview:i,favicon:a,header:r,previews:l})})}function E(e,t,n){var r=babelHelpers.extends({},t,n);return e.media.put(r)}l.maybeGetMediaFromMediaId=d,l.maybeBulkGetMediaFromMediaId=m,l.maybeGetMediaFromHashedPlaintextHash=p,l.maybeGetMediaFromPlaintextHash=_,l.maybeBulkGetMediaFromPlaintextHash=f,l.maybeBulkGetMediaFromHashedPlaintextHash=g,l.maybeGetMediaFromObjectId=h,l.maybeGetMediaBackupRowFromObjectId=y,l.maybeGetMediaBackupRowFromMsgId=C,l.getMsgMediaPairFromMsgs=b,l.getMediaFromMsgs=v,l.getAndCheckMediaFromMsg=S,l.bulkGetMedias=R,l.getMediaForXMA=L,l.updateMedia=E}),98);
__d("MAWDbXMATxns",["MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWJidUtils","MAWXMAUtils","WAResultOrError","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.xma.bulkGet(t)}function s(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.get({xmaId:t})}function u(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.where("associatedMessageId").equals(t).first()}function c(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.where("externalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).first()}function d(e,t){return c(e,t).then(function(t){return t==null?o("WAResultOrError").makeError("missing"):o("MAWDexieTable").dexieAll([o("MAWDbMediaTxns").getMediaForXMA(e,t),o("MAWDbMsgTxns").maybeGetMsg(e,t.associatedMessageId)]).then(function(e){var n=e[0],r=e[1];if(!n.success)return o("WAResultOrError").makeError("missing");var a=n.value,i=a.defaultPreview,l=a.favicon,s=a.header,u=a.previews;return o("WAResultOrError").makeResult({associatedMessage:r,defaultPreview:i,favicon:l,header:s,previews:u,xma:t})})})}function m(e,t){return u(e,t).then(function(t){if(t!=null)return o("MAWDbMsgTxns").maybeGetMsg(e,t.msgId)})}function p(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.filter(o("MAWDbMsg").isXMAMsg).map(function(e){return o("MAWJidUtils").maybeToProtocolMsgId(e.author,e.threadJid,e.externalId)}).filter(Boolean),r=n.map(function(t){return c(e,t)});return o("MAWDexieTable").dexieAll(r).then(function(e){return e.filter(Boolean)})}function _(e,t){return e.xma.where("associatedMessageId").anyOf(t).toArray().then(function(e){var t=e.filter(function(e){return e.msgId!=null&&r("gkx")("9841")?e.targetType!=null:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(e.targetType)});return t.reduce(function(e,t){return t.associatedMessageId!=null&&t.msgId!=null?e.set(t.associatedMessageId,t.msgId):e},new Map)})}function f(e,t){return e.xma.where("associatedMessageId").equals(t).first()}function g(e,t){return e.xma.where("associatedMessageId").equals(t).first().then(function(t){if(t!=null){var n=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.externalId);if(n!=null)return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,n)}})}function h(e,t){return f(e,t).then(function(t){return t==null?o("WAResultOrError").makeResult():o("MAWDexieTable").dexieAll([o("MAWDbMediaTxns").getMediaForXMA(e,t),o("MAWDbMsgTxns").maybeGetMsg(e,t.associatedMessageId)]).then(function(e){var n=e[0],r=e[1];if(!n.success)return o("WAResultOrError").makeError("missing");var a=n.value,i=a.defaultPreview,l=a.favicon,s=a.header,u=a.previews;return o("WAResultOrError").makeResult({associatedMessage:r,defaultPreview:i,favicon:l,header:s,previews:u,xma:t})})})}function y(e,t,n){return o("MAWDbThreadTxns").getThread(e,n).then(function(n){if(n.success){var r=n.value;if(t==null)return o("MAWDexieTable").dexieResolve();var a={author:t.author,chat:r.jid,externalId:t.externalId};return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,a)}})}function C(e,t){return c(e,t).then(function(t){if(t==null)return o("MAWDexieTable").dexieResolve();if(!o("MAWXMAUtils").isXMAStoryReply(t.targetType))return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t.defaultPreviewMediaId).then(function(n){return n==null?{hasMedia:!1,xma:t}:o("MAWDexieTable").dexieAll([n,o("MAWDbChunkTxns").hasMediaChunk(e,n.hashedPlaintextHash)]).then(function(e){var n=e[0],r=e[1];return{hasMedia:r,previewMedia:n,xma:t}})})})}function b(e,t){return e.xma.where("externalId").anyOf(t).toArray()}l.bulkGetXMAs=e,l.maybeGetXMAFromXMAId=s,l.maybeGetXMAFromAssociatedMsgId=u,l.maybeGetXMAFromProtocolMsgId=c,l.maybeGetXMAPayloadFromProtocolMsgId=d,l.getDbXMAMsgFromAssociatedMsgId=m,l.getXMAFromMsgs=p,l.getXMAMsgIdsFromAssociatedMsgIds=_,l.maybeGetDbXMAMsgByAssociatedMsgId=g,l.maybeGetXMAPayloadFromAssociatedMsgId=h,l.maybeGetAssociatedXMAMsg=y,l.maybeGetXMAAndDefaultPreviewMediaFromProtocolMsg=C,l.getMultipleXMAByExternalId=b}),98);
__d("MAWLocalizationUtils",["MAWAckLevel","MAWLocalizationType","MAWMsgType","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new Set([(e=o("MAWLocalizationType")).LOCALIZATION_TYPE.CURRENT_USER_CREATED_POLL,e.LOCALIZATION_TYPE.PARTICIPANT_CREATED_POLL,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_OPTION,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_OPTION,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_OPTIONS,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_OPTIONS,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.CURRENT_USER_MIXED_POLL_UPDATE,e.LOCALIZATION_TYPE.PARTICIPANT_MIXED_POLL_UPDATE,e.LOCALIZATION_TYPE.CURRENT_USER_CHANGED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_CHANGED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_CHANGED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_CHANGED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.POLL_UNSENT_UPDATE]);function u(e,t,n,r,a,i){return{ack:o("MAWAckLevel").ACK.sent,altIndex:a!=null?a:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:n,msgContent:e,sortOrderMs:i,threadJid:t,ts:r!=null?r:o("WATimeUtils").unixTime(),type:o("MAWMsgType").MSG_TYPE.ADMIN}}function c(e){if(s.has(e))return!0;switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SELF_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PROMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_DEMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_PROMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_PROMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SELF_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_HOTLIKE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_THEME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_PHOTO:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNPINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_HOTLIKE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_THEME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PHOTO:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNPINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_CURRENT_USER_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_CURRENT_USER_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_UK_OSA_ADMIN_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_LIMIT_SHARING_DISABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_LIMIT_SHARING_ENABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LIMIT_SHARING_DISABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LIMIT_SHARING_ENABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_OTHER_USER_NAME_UNKNOWN:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_SELF_THREAD:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_WITH_OTHER_USER_NAME:return!0}return!1}function d(e){switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:return!0}return!1}function m(e){switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_MORE_THAN_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:return!0}return!1}l.POLL_ADMIN_MSG_TYPES=s,l.buildUnstoredDbAdminMsg=u,l.isAdminMsgNormalized=c,l.isDeviceChangeAdminMsg=d,l.isParticipantChangeAdminMsg=m}),98);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(t){return!0},user:function(t){return!1}});return{authoritativeThreadKey:n,cannotReplyReason:e.cannotReplyReason,clientThreadKey:t,description:r,folder:e.folder,instanceKey:a,isGroup:i,jid:e.jid,lastReadTs:o("MAWTimeUtils").ensureValidMillisTime(e.lastReadMsgTs)||o("WATimeUtils").castToMillisTime(0)}}l.createBridgeThread=e}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWQplProxy","MAWThreadMappingQPL","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(e!=null&&t!=null){var n=o("WATimeUtils").fromMillisTime(e),r=o("WATimeUtils").fromMillisTime(t);return o("WATimeUtils").castToMillisTime(Math.max(n,r))}return e!=null?e:t}function s(e,t){return e.threads.get({jid:t})}function u(e,t){return(r("gkx")("10029")?o("MAWDexieTable").dexieAll(t.map(function(t){return e.threads.get({jid:t})})).then(function(e){return e.filter(Boolean)}):e.threads.where("jid").anyOf(t).toArray()).then(function(e){var n=new Map;for(var r of e)n.set(r.jid,r);return t.map(function(e){return n.get(e)})})}function c(e,t,n){var a=t.instanceKey,i=t.jid;return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_start",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_start",{instanceKey:n}),s(e,i).then(function(a){return a==null?(n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"create-1-1-thread-start",{instanceKey:n}),p(e,t,n).then(function(e){return{created:!0,thread:e}})):g(e,t,a).then(function(e){return{created:!1,thread:e}})}).then(function(e){return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_end",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_end",{instanceKey:n}),e})}function d(e,t,n){var r=n===void 0?{}:n,a=r.logState;return u(e,t.map(function(e){var t=e.jid;return t})).then(function(n){a==null||a("threadMapping2FetchedThreads");var r={},i=[],l=[];for(var s of n.entries()){var u=s[0],c=s[1];c==null?i.push(t[u]):l.push({params:t[u],thread:c})}return o("MAWDexieTable").dexieAll([i.length?_(e,i):o("MAWDexieTable").dexieResolve([]),l.length?h(e,l):o("MAWDexieTable").dexieResolve([])]).then(function(e){var n=e[0],o=e[1];a==null||a("threadMapping3ThreadsUpdated");for(var i of n){var l=i.adminMsgParams,s=i.thread;r[s.jid]={adminMsgParams:l,created:!0,thread:s}}for(var u of o)r[u.jid]={adminMsgParams:null,created:!1,thread:u};return t.map(function(e){var t=e.jid;return r[t]})})})}function m(e){var t,n=e.authoritativeThreadKey,r=e.clientThreadKey,a=e.createTs,i=e.deduplicationKey,l=e.folder,s=e.jid,u=e.lastActivityTimestamp,c=o("WATimeUtils").millisTime(),d=(t=u!=null?u:a)!=null?t:c,m={authoritativeThreadKey:n!=null?n:void 0,deduplicationKey:i,folder:l!=null?l:o("MAWFolderTypes").FOLDER_ID.INBOX,jid:s,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsgTs:d,oldestMsg:null,optimisticThreadKey:r!=null?r:void 0,threadOrder:o("MAWDbThread").craftThreadOrder(d,s)};return m}function p(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread,u=m(t);return e.threads.add(u).then(function(t){var c=babelHelpers.extends({},u,{chatId:t});return s!==!0&&(l!=null&&o("MAWThreadMappingQPL").addPoint("create_thread_verify_thread_exists",l),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)})),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-e2ee-admin-msg-in-new-thread",{instanceKey:n}),o("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(e,c,n)}).catch(function(e){var t=r("getErrorSafe")(e);throw l!=null&&o("MAWThreadMappingQPL").endFailureInWorker("create_thread_failed",l,{string:{createThreadFailureReason:t.message}}),t.message="Error creating thread: "+t.message,t})}function _(e,t){var n=t.map(m);return e.threads.bulkAdd(n,{allKeys:!0}).then(function(r){var a=r.map(function(e,r){return{data:babelHelpers.extends({},n[r],{chatId:e}),params:t[r]}});for(var i of a)i.params.skipVerifyThread!==!0&&(i.params.instanceKey!=null&&o("MAWThreadMappingQPL").addPoint("bulk_create_thread_verify_thread_exists",i.params.instanceKey),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(i.data,i.data.optimisticThreadKey,i.params.authoritativeThreadKey,i.params.description,i.params.instanceKey)}));return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns(e,a.map(function(e){return e.data}))}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk creating threads: "+t.message,t})}function f(t,n,r){var o=n.authoritativeThreadKey,a=n.clientThreadKey,i=n.deduplicationKey,l=n.folder,s=n.lastActivityTimestamp,u={authoritativeThreadKey:o!=null?o:t.authoritativeThreadKey,cannotReplyReason:l!=null||a!=null?null:t.cannotReplyReason,deduplicationKey:l!=null||a!=null?i:t.deduplicationKey,folder:l!=null?l:t.folder,newestMsgTs:e(r,s),optimisticThreadKey:a!=null?a:t.optimisticThreadKey};return babelHelpers.extends({},t,u)}function g(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,n.jid).then(function(u){var c=f(n,t,u);return e.threads.update(n.chatId,c).then(function(){var e;return s!==!0&&(l!=null&&o("MAWThreadMappingQPL").addPoint("update_thread_verify_thread_exists",l),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)})),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(e=c==null?void 0:c.folder)!=null?e:o("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:c.jid})}),c}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error updating thread: "+t.message,t})})}function h(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.params,r=t.thread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,r.jid).then(function(e){var t=f(r,n,e);return{params:n,thread:t}})})).then(function(t){return e.threads.bulkUpdate(t.map(function(e){var t=e.thread;return{changes:t,key:t.chatId}})).then(function(){for(var e of t){var n=e.params,r=n.authoritativeThreadKey,a=n.description,i=n.instanceKey,l=n.skipVerifyThread,s=e.thread;l!==!0&&(i!=null&&o("MAWThreadMappingQPL").addPoint("bulk_update_thread_verify_thread_exists",i),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(s,s.optimisticThreadKey,r,a,i)}))}return t.map(function(e){var t=e.thread;return t})})}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk updating threads: "+t.message,t})}l.getExistingThread=s,l.bulkGetExistingThread=u,l.getOrCreateThread=c,l.bulkGetOrCreateThread=d,l.createThread=p,l.prepareUpdatedThreadData=f}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=e.ts,a=o("WATimeUtils").castUnixTimeToMillisTime(r),i=o("MAWTimeUtils").ensureValidMillisTime(n)||o("WATimeUtils").castToMillisTime(0),l=a>i?a:i;return babelHelpers.extends({},t,{newestMsgTs:l,oldestMsg:e.msgId,snippetMsg:e.msgId,snippetMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(e)),threadOrder:o("MAWDbThread").craftThreadOrder(l,t.jid)})}function u(t,n){return o("MAWDbThreadTxns").getThread(t,n).then(function(n){if(!n.success){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"])));return}var a=n.value,i=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},a.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castMillisTimeToUnixTime(o("WATimeUtils").millisTime()));return o("MAWWriteMsgTxns").writeMsg(t,i,a).then(r("emptyFunction"))})}function c(e,t,n){return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(e,[t],n).then(function(e){var t=e[0];return t})}function d(e){var t=o("MAWDbMsg").craftE2eeAdminMsgAltIndex(e.chatId),n=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},e.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castToUnixTime(0),t);return babelHelpers.extends({},n,{msgId:o("MAWDbMsg").craftMsgIdV2(e.chatId,1,n),sortOrderMs:0})}l.getUpdatedThreadForAdminMsg=s,l.writeReachabilityErrorAdminMsg=u,l.writeE2EEThreadDescriptionMsg=c,l.buildE2EEThreadDescriptionMsg=d}),98);
__d("MAWBridgeTrace",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i,l,s){var u=e.ack,c=e.externalId,d=e.ts,m=e.type,p=o("WAJids").switchOnMsgrChatJidType(t,{group:function(t){return"Group"},user:function(t){return"User"}});return{ack:u,externalId:c,isFirstMsg:!!a,openMessageOtid:r,openMessageParticipantCount:i,participantCount:l,threadJid:t,threadKey:s,threadType:p,traceType:n,ts:d,type_:m}}function s(e,t,n){return{traceContext:n,traceId:t,traceType:e}}function u(e,t,n,r){return{errorMessage:r,event:t,externalIds:e,traceType:n}}function c(e,t,n,r,o,a){return{checkPointId:e,dataTraceId:t,errorMessage:n,shouldFlush:r,syncChannel:o,tags:a}}l.createBridgeStartTraceData=e,l.createBridgeStartTraceWithTraceIdData=s,l.createBridgeUpdateTraceData=u,l.createBridgeTraceRecordCheckpointData=c}),98);
__d("MAWAfterWriteMsgUtil",["$InternalEnum","ArmadilloDataTraceType","MAWBridgeMsg","MAWBridgeTrace","MAWDbMsg","MAWIndexedDb","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","BUMP_LOCAL_ONLY","BUMP_LOCAL_AND_SERVER"]);function s(e){var t=e.dbMsg,n=e.isFirstMsg,r=e.openMessageOtid,a=e.openMessageParticipantCount,i=e.participantCount,l=e.quotedReplyAttachmentMeta,s=e.updatedThread,u=s.authoritativeThreadKey,c=s.jid;t.altIndex===o("MAWDbMsg").SPAM_ALT_INDEX||t.altIndex===o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX||(o("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(t,c,o("ArmadilloDataTraceType").armadilloMessageSend,r,n,a,i,u)}),o("MAWXMAUtils").isXMAStoryReply(t.xmaMessageType)||o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t,l)}))}l.WriteMsgAfterTxnBumpThreadOption=e,l.writeMsgAfterTransaction=s}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMsgTxns","MAWDexieTable","MAWQplProxy","WALogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){var r=[],a=[],i=[],l=new Map,s=new Map,u=n.map(function(e){return o("MAWDbMsgTxns").getThreadOldestMessageId(t,e.jid).then(function(t){return l.set(e.jid,t)})}),c=n.map(function(e){return o("MAWDbMsgTxns").getThreadNewestMessageMs(t,e.jid).then(function(t){return s.set(e.jid,t)})});return o("MAWDexieTable").dexieAll([u,c]).then(function(){return n.forEach(function(t){t==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"])));var n=o("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(t),l=o("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(n,t,s.get(t.jid));r.push(n),i.push(l),a.push({dbMsg:n,isFirstMsg:!1,updatedThread:l})}),{afterTransactionSyncMsgsData:a,e2eeThreadAdminMsgs:r,threadsToUpdate:i}})}function u(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate,r=new Map;return t.forEach(function(e){var t=e.updatedThread.jid;r.set(t,{externalId:e.dbMsg.externalId,msgId:e.dbMsg.msgId})}),n.map(function(e){return{adminMsgParams:r.get(e.jid),thread:e}})})}function c(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate;return t.forEach(function(e){return o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(e)}),n})}function d(e,t,n){return s(e,t).then(function(t){var a=t.afterTransactionSyncMsgsData,i=t.e2eeThreadAdminMsgs,l=t.threadsToUpdate;return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-start",{instanceKey:n}),o("MAWDexieTable").dexieAll([e.messages.bulkAdd(i),e.threads.bulkPut(l)]).then(function(){return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-end",{instanceKey:n}),{afterTransactionSyncMsgsData:a,threadsToUpdate:l}})})}l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns=u,l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns=c}),98);
__d("WormPersistedQueueSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e}var s={autoIncrement:!1,primaryKey:"queueId",secure:!0},u={ebUploadQueueV3:babelHelpers.extends({},s,{indexes:{"[attemptCount+addedAtMs]":{fields:["attemptCount","addedAtMs"],unique:!1}},nonEncryptedFields:["attemptCount","addedAtMs"]}),ftsIndexQueue:babelHelpers.extends({},s,{indexes:{"[kind+addedAtMs]":{fields:["kind","addedAtMs"],unique:!1}},nonEncryptedFields:["kind","addedAtMs"]}),mediaDownloadQueue:babelHelpers.extends({},s,{indexes:{attemptCount:{fields:["attemptCount"],unique:!1}},nonEncryptedFields:["attemptCount"]})};function c(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="worm_pqdb",c=new(o("WormEAR")).WormEAR(u,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,u,c,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.toWormPersistedQueueId=e,l.makePersistedQueueSchema=c}),98);
__d("WormPersistedQueueDb",["FBLogger","WAResolvable","WormEAR","WormPersistedQueueSchema","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){var n=t.blockingErrorThreshold,a=t.dbName,i=t.onBlockingError,l=t.qplEvent,u=t.strEncKey;try{var c=o("WormPersistedQueueSchema").makePersistedQueueSchema(a,u,n,i,function(t){if(t instanceof o("WormEAR").DecryptionError){var n,a,i=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",i.store),r("promiseDone")((n=(a=e)==null?void 0:a.runInTransaction([i.store],"readwrite",function(e){var t=e.stores[i.store];return i.maybeHashedPk!=null?t.delete(i.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?n:Promise.resolve())}},l);return e=c,await c.init(),s.resolve(c),c}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing WORM PersistedQueue init"),e}}function c(){if(e==null)throw r("err")("PersistedQueue is not initialized");return e}function d(){return s.promise}l.makePersistedQueueDb=u,l.getPersistedQueues=c,l.getDbPromise=d}),98);
__d("WormPersistedQueue",["FBLogger","WAPubSub","WormPersistedQueueDb","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(){return r("FBLogger")("wmi").tags(["worm-persisted-queue"])},u=36e5,c=(function(){function t(e){this.$1=o("WAPubSub").simplePubSub(),this.$4=0,this.$2=o("WormPersistedQueueDb").getPersistedQueues(),this.$3=e}var n=t.prototype;return n.$5=function(t){return"WormPersistedQueue:"+this.$3+":"+t},n.$6=function(){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",async function(t){var n=t.stores[e.$3],r=await n.readAll({limit:1});r.length===0&&await n.clear()},this.$5("clearIfEmpty"))},n.$7=async function(){if(Date.now()-this.$4>u)try{await this.$6(),this.$4=Date.now()}catch(n){var t=r("getErrorSafe")(n);s().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during PersistedQueue cleanup: ",""])),t.message)}},n.subscribe=function(t){return this.$1.subscribe(t)},n.ack=function(t){return this.delete(t)},n.delete=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",async function(n){var r=n.stores[e.$3];await r.bulkDelete(t),e.$7()},this.$5("delete"))},n.read=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readonly",async function(n){var r=n.stores[e.$3];return await r.readAll(t)},this.$5("read"))},n.readFromIndex=function(t,n){var e=this;return this.$2.runInTransaction([this.$3],"readonly",async function(r){var o=r.stores[e.$3];return await o.readIndex(t,void 0,n)},this.$5("readIndex"))},n.readFromIndexRange=function(t,n,r){var e=this;return this.$2.runInTransaction([this.$3],"readonly",async function(o){var a=o.stores[e.$3];return await a.readIndexRange(t,n,r)},this.$5("readIndexRange"))},n.add=function(t){return this.put(t)},n.put=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",async function(n){var r=n.stores[e.$3];await r.bulkPut(t),e.$1.publish({type:"new_entities"})},this.$5("put"))},t})();l.WormPersistedQueue=c}),98);
__d("FtsIndexEntity",["WATimeUtils","WormPersistedQueue","WormPersistedQueueSchema","qex"],(function(t,n,r,o,a,i,l){"use strict";var e="migrate_fts_backlog_to_wpq";function s(e){var t=o("WATimeUtils").millisTime();return{addedAtMs:t,id:e,kind:"INDEX_MESSAGE",queueId:o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t.toString())}}function u(e){var t=o("WATimeUtils").millisTime();return{addedAtMs:t,id:e,kind:"PURGE_MESSAGE",queueId:o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t.toString())}}function c(e){var t=o("WATimeUtils").millisTime();return{addedAtMs:t,id:e,kind:"PURGE_THREAD",queueId:o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t.toString())}}function d(e){return e}var m=null;function p(){return m==null&&(m=new(o("WormPersistedQueue")).WormPersistedQueue("ftsIndexQueue")),m}function _(e){return(e==null?void 0:e.silent)===!0?r("qex")._("355")===!0:r("qex")._("427")===!0}l.MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME=e,l.toIndexMessageEntity=s,l.toPurgeMessageEntity=u,l.toPurgeThreadEntity=c,l.toFtsIndexId=d,l.getFtsIndexQueue=p,l.isFtsIndexQueueExperiment=_}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS;function s(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function u(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.failed,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(t,n){var r;return{ack:t.ack,author:t.author,externalId:t.externalId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e),msgContent:(r=o("MAWDbMsg").getMsgContent(t))==null?void 0:r.content,threadJid:n.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function d(t,n,r){return{ack:t.ack,altIndex:void 0,author:t.author,externalId:r.externalId,msgContent:o("MAWDbMsg").getMsgContent(t),originalTs:t.ts,revokedExternalId:r.revokedExternalId,threadJid:n.jid,ts:r.ts,type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e)}}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.buildUnstoredCiphertextMsg=s,l.buildUnstoredUnavailableMsg=u,l.buildUnstoredDeleteForMeMsg=c,l.buildUnstoredRevokedMsg=d}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWVault","MWFBLogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbEditMsgHistoryTxns"]);function m(t,n){var r=[];if(n.length===0)return o("MAWDexieTable").dexieResolve(r);var a=n.filter(function(e){return e.editCount!=null&&e.editCount>0}),i=a.map(function(e){return[e.externalId,e.threadJid]});if(i.length===0)return o("MAWDexieTable").dexieResolve([]);var l=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t.msgId),e},new Map),u=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t),e},new Map);return p(t,i).then(function(t){if(t.length===0)return d.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No edit history found for the messages despite there being an editCount greater than 0"]))),[];for(var n of t){var a=l.get(n.originalMsgExternalId);a!=null&&r.push(babelHelpers.extends({},n,{editMsgHistoryId:o("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(n.editMsgHistoryId),originalMsgId:a}));var i=u.get(n.originalMsgExternalId);i!=null&&n.threadJid!==i.threadJid&&d.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Edit history threadJid does not match original message threadJid"])))}return r})}function p(e,t){return e.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(t).toArray()}function _(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.editMsgHistory.get({editMsgHistoryId:t})}function f(e,t,n){return e.editMsgHistory.where("originalMsgExternalId").equals(n).filter(function(e){return e.editExternalId===t.externalId&&e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){if(e.length>1){var t=e.map(function(e){return""+e.editTs.toString()}),n=new Set(t).size===1;n?d.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"]))):d.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"])),e.length)}return e[0]})}function g(e,t){return t==null?o("MAWDexieTable").dexieResolve([]):e.editMsgHistory.where("originalMsgExternalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){var t=[];return e.forEach(function(e){e!=null&&t.push(e)}),t})}function h(e,t){return e.editMsgHistory.bulkGet(t)}function y(e,t){return e.editMsgHistory.bulkAdd(t,{allKeys:!0}).then(function(e){return o("MAWDexieTable").dexieResolve(e)})}function C(e,t,n,r){return r.then(function(r){return b(e,t,n,r)})}function b(e,t,n,r){var a=[];return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===r&&e.author===n&&(e.sendStatus==null||e.sendStatus>=o("MAWAckLevel").ACK.sent)}).toArray().then(function(e){return e.forEach(function(e){a.push({messageId:e.editExternalId,originalMessageId:e.originalMsgExternalId,text:o("MAWVault").unvault(e.msgContent.content),timestamp:e.editTs})}),a})}function v(e,t,n,o){return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===o&&e.author===n}).delete().then(r("emptyFunction"))}var S=function(t,n){return t.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(n).delete().then(function(){return o("MAWDexieTable").dexieResolve(n.length)})};function R(e,t,n){return e.editMsgHistory.put(babelHelpers.extends({},t,{msgContent:n.msgContent})).then(function(){})}l.loadEditMsgHistory=m,l.getEditHistoryByOriginalMsgExternalIdAndThreadJid=p,l.maybeGetEditMsgHistoryFromEditMsgHistoryId=_,l.getEditHistoryMsgByEditedProtocolMsgId=f,l.maybeGetEditMsgHistoryFromProtocolMsgId=g,l.bulkGetEditMsgHistorys=h,l.bulkAddEditMsgHistory=y,l.getEditHistoryAsEchoWithJidPromise=C,l.getEditHistoryAsEcho=b,l.bulkRemoveEditHistory=v,l.deleteExpiredEditMsgHistory=S,l.updateEditMsgHistoryWithNewIncomingMsg=R}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(t,n,r,o,a,i,l){"use strict";var e="revoked",s="deleteForMe",u="deleteThread",c="Revoked",d="DeleteForMe",m="DeleteThread",p={DELETE_FOR_ME:d,DELETE_THREAD:m,REVOKED:c};function _(t){switch(t){case"Revoked":return e;case"DeleteForMe":return s;case"DeleteThread":return u;default:return r("WAAssertUnreachable")(t)}}l.PENDING_REVOKED=e,l.PENDING_DELETE_FOR_ME=s,l.REVOKED=c,l.DELETE_FOR_ME=d,l.PENDING_TYPE=p,l.getPendingSuffix=_}),98);
__d("MAWDeleteThreadUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[];if(e.forEach(function(e){if(e.pendingContent.type==="DeleteThread"){var n=e.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;n!=null&&t.push(n)}}),t.length===0)return null;t.sort(function(e,t){return t-e});var n=t[0];return{lastMessageTimestamp:n}}function l(e,t){return t!=null&&t.lastMessageTimestamp>=e}i.getLatestDeleteThreadInfo=e,i.isMsgDeletedViaDeleteThread=l}),66);
__d("MAWMsgCleaner",["MAWLoggerUtils","MWFBLogger","Promise","WAAssertUnreachable","WAShiftTimer","WATimeUtils","WorkerScheduler","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="Unsend",m="Ephemeral",p="DeleteForMe",_="PendingStanza",f="Xma",g="IGDDM",h="Quote",y=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerUpdate]),C={DELETE_FOR_ME:p,EPHEMERAL:m,IGDDM:g,PENDING_STANZA:_,QUOTE:h,UNSEND:d,XMA:f},b;function v(){return b==null&&(b=o("WorkerScheduler").makeScheduler("cleaner",{concurrency:1,maxTaskLimit:1,maxThrottleMs:8e3})),b}var S=(function(){function t(e,t){var n=this;this.$1=new(o("WAShiftTimer")).ShiftTimer(function(){r("promiseDone")(n.$2())}),this.getNextTs=e.getNextTs,this.removeExpired=e.removeExpired,this.cleanerType=t,this.purgeEnabled=e.purgeEnabled,this.$1.forceRunNow()}var a=t.prototype;return a.update=function(n){var t=R(this.cleanerType);y.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""])),t,n),this.$1.onOrBefore(o("WATimeUtils").cappedMillisecondsUntil(n))},a.$2=function(){var e=this,t=function(){if(!e.purgeEnabled())return(c||(c=n("Promise"))).resolve();var t=R(e.cleanerType);return y.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"])),t),e.removeExpired().then(function(n){return n>0&&y.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"])),t,n),e.getNextTs()}).then(function(t){t!=null&&e.update(t)})};return this.$3!=null?(c||(c=n("Promise"))).resolve():(this.$3=v().task({fn:t,name:this.cleanerType,priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),this.$3.run().finally(function(){e.$3=null}))},t})();function R(e){switch(e){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";case"Quote":return"QuoteCleaner";default:return r("WAAssertUnreachable")(e)}}var L=S;l.CLEANER_TYPE=C,l.MsgCleaner=S,l.MSG_CLEANER_FOR_TESTING_ONLY=L}),98);
__d("MAWPendingStanzaCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function d(t){if(u==null){var n="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startPendingStanzaCleaner=c,l.addNewPendingStanzaCleanerTimestamp=d,l.getPendingStanzaCleaner_FOR_TESTING_ONLY=m,l.resetPendingStanzaCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+i).filter(function(e){var t=e.pendingContent;return t.type===a&&t.content.author===n&&t.content.threadJid===r}).first()}function s(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function u(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function c(e,t){var n=t.map(function(e){var t=e.expirationInSeconds;return o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+t)}),a=t.map(function(e,t){var r=e.content,a=e.externalId,i=e.pendingStanzaType;return{deleteTs:n[t],externalIdWithType:a+"_"+o("MAWDbPendingStanza").getPendingSuffix(i),pendingContent:r}});return e.pendingStanzas.bulkAdd(a).then(function(){return n.forEach(o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(r("emptyFunction"))}function d(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a),l=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+n),s={deleteTs:l,externalIdWithType:r+"_"+i,pendingContent:t};return e.pendingStanzas.add(s).then(function(){o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(l)})}function m(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+n).toArray().then(function(e){return o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e)})}function p(e){return e.pendingStanzas.toArray()}function _(e,t){var n=t.map(function(e){return e.rowId});return e.pendingStanzas.bulkDelete(n)}function f(e){var t,n;return(e==null||(t=e.pendingContent)==null?void 0:t.type)===o("MAWDbPendingStanza").PENDING_TYPE.REVOKED?e==null||(n=e.pendingContent)==null?void 0:n.content:null}function g(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD),r=t.map(function(e){return e+"_"+n});return e.pendingStanzas.where("externalIdWithType").anyOf(r).toArray().then(function(e){var t=e.reduce(function(e,t){var n=e.get(t.externalIdWithType);return n==null?e.set(t.externalIdWithType,[t]):n.push(t),e},new Map),n=new Map;return t.forEach(function(e,t){var r=o("WAJids").unsafeCoerceToChatJid(t.split("_")[0]),a=o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e);a!=null&&n.set(r,a)}),n})}l.maybeGetPendingStanzaByExternalId=e,l.maybeGetPendingRevokedStanza=s,l.maybeGetPendingDeletedStanza=u,l.bulkPutPendingStanzas=c,l.putPendingStanza=d,l.maybeGetDeleteThreadFromPendingStanza=m,l.getAllPendingStanzas=p,l.deletePendingStanzas=_,l.getRevokedContent=f,l.bulkGetDeleteThreadPendingStanzas=g}),98);
__d("MAWDbReactionsTxns",["FBLogger","MAWAuthor","MAWBridgeTypesCreators","MAWDbMsg","MAWDexieTable","MAWIndexedDb","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(t){return t};function d(e,t){return e.reactions.put(c(t))}function m(t,n){return t.reactions.delete(n.rowId).then(function(){var t=n.author,r=n.reactionId,a=n.reactToMsgId,i=n.threadJid;a!=null&&(o("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:i,reactToMsgId:a})}),o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted reaction with id : ","."])),r))})}function p(e,t){var n=o("MAWAuthor").getAuthorUserJid(t.author);return e.reactions.where("reactToExternalId").equals(t.externalId).filter(function(e){return(e.reactToAuthor===n||e.reactToAuthor===t.author)&&e.threadJid===t.chat}).toArray()}function _(e,t){var n=t.reduce(function(e,t){return e.set(t.msgId,t),e},new Map);return e.reactions.where("reactToMsgId").anyOf(t.map(function(e){return e.msgId})).toArray().then(function(e){var t=e.filter(function(e){var t,r=e.reactToExternalId,o=e.reactToMsgId;return o!=null&&r===((t=n.get(o))==null?void 0:t.externalId)});return t.length<e.length&&r("FBLogger")("messenger_web").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId"),t})}function f(e,t){return e.reactions.where("reactToMsgId").equals(t.msgId).toArray().then(function(e){var n=e.filter(function(e){var n=e.reactToExternalId;return n===t.externalId});return n.length<e.length&&r("FBLogger")("messenger_web").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId"),n})}function g(e,t){return _(e,[t])}function h(e,t){var n=t.author,r=t.chat,o=t.externalId;return e.reactions.where("externalId").equals(o).filter(function(e){return e.author===n&&e.threadJid===r}).first()}function y(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.author,r=t.externalId,a=o("MAWAuthor").getAuthorUserJid(n);return e.reactions.where("reactToExternalId").equals(r).filter(function(e){return o("MAWAuthor").getAuthorUserJid(e.reactToAuthor)===a}).toArray()})).then(function(t){var n=t.flat();if(n.forEach(function(e){var t=e.author,n=e.reactToMsgId,r=e.threadJid;n!=null&&o("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:r,reactToMsgId:n})})}),n.length!==0)return o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."])),n.length),e.reactions.bulkDelete(n.map(function(e){return e.rowId}))})}function C(e,t){return e.reactions.where("reactToMsgId").anyOf(t.map(function(e){return e.msgId})).delete().then(function(e){o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Deleted "," reactions"])),e)})}function b(e,t){return e.reactions.where("reactionId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.reactionId);return t+1})}function v(e,t,n,r,a,i,l){var s,u,c=(s=r==null?void 0:r.ts)!=null?s:o("WATimeUtils").unixTime();return e.reactions.where(["threadJid","ts"]).between([t,(u=o("WATimeUtils").castMillisTimeToUnixTime(n))!=null?u:o("WATimeUtils").castToUnixTime(0)],[t,c],!0,a).reverse().filter(l).limit(i).toArray()}l.coerceToReaction=c,l.putReaction=d,l.deleteReaction=m,l.getReactionForEcho=p,l.getReactionsFromMessages=_,l.getReactionsForMessage=f,l.getReactionsFromMessage=g,l.maybeGetReactionByProtocolMsgId=h,l.deleteReactionsByUniqueMsgIdentifiers=y,l.deleteAllReactionsForMessages=C,l.getNextReactionIdNumberForThread=b,l.fetchReactionsFromDbWithTimestamp=v}),98);
__d("MAWDeleteForMeMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function d(t){if(u==null){var n="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startDeleteForMeMsgContentCleaner=c,l.addNewDeleteForMeMsgContentCleanerTimestamp=d,l.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","MWFBLogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MWFBLogger").MWLogger().tags(["bridge",o("MAWLoggerUtils").Tag.Countdown]);function c(t){return{msgs:t.map(function(t){var n,r=t.messageExpirationTs,a=(n=t.ephemeralSetting)==null?void 0:n.ephemeralExpirationInSec;if(!(r==null||a==null)){var i=o("WATimeUtils").cappedMillisecondsUntil(r);if(i<=0){u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"])));return}var l=a*1e3;return i>l&&(i=l),u.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""])),t.msgId,r,i,a),{countdownTs:r,millisecondsUntilCountdownTs:i,msgId:t.msgId,threadJid:t.threadJid,ts:o("MAWDbMsg").getCanonicalTsFromMsg(t)}}}).filter(Boolean)}}function d(e,t){return{countdownTs:t,msgId:e}}l.createBridgeMsgsStartCountdown=c,l.createBridgeMsgClearCountdown=d}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"backend"]);function c(e){var t=e.expiryFns,n=e.purgeDeletionsFns;if(s==null){var r;s={expiry:new(r=o("MAWMsgCleaner")).MsgCleaner(t,r.CLEANER_TYPE.EPHEMERAL),purgeDeletions:new r.MsgCleaner(n,r.CLEANER_TYPE.EPHEMERAL)}}}function d(t,n){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");var r=s,o=r.expiry,a=r.purgeDeletions;u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",") and deletion(",")"])),t,n),o.update(t),a.update(n)}function m(){return s}function p(){s=null}l.startEphemeralCleaner=c,l.addNewEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWEphemeralMsgUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return function(t){return!e.has(t.msgId)&&t.ephemeralMsgDisappeared!==!0}}i.filterNonExpiredMsg=e}),66);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t,n){e.set(t,n)}function u(t){var n,r={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};return(n=e.get(t))!=null?n:r}async function c(t){var n={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};if(!e.has(t)){var r=await o("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:t});s(t,r!=null?r:n)}}l.setEphemeralSettingCache=s,l.getEphemeralSettingCache=u,l.requestLSDBCacheForJid=c}),98);
__d("MAWEphemeralUtil",["FBLogger","MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){var n=t.ephemeralExpirationInSec!==e.ephemeralExpirationInSec&&t.ephemeralLastUpdatedOrSetTimestamp===e.ephemeralLastUpdatedOrSetTimestamp;return n||e.ephemeralLastUpdatedOrSetTimestamp>t.ephemeralLastUpdatedOrSetTimestamp}function c(t,n,r){if(t==null)return!0;var a=t.ephemeralSetting;return a!=null&&a.ephemeralExpirationInSec===n?(o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"]))),!1):a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>r?(o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"]))),!1):!0}function d(e){var t={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:t,unstoredDbReaction:null}}function m(e,t){var n;switch(t){case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type")}var a={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:n},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:void 0}}function p(e){return o("WAJids").switchOnMsgrChatJidType(e,{group:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(t){return t}})}function _(e){e!=null&&e.messageExpirationTs!=null&&e.ephemeralCounterStarted===!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(e.msgId,e.messageExpirationTs)})}l.isLocalSettingOutdated=u,l.shouldUpdateForOutgoingUserEphemeralSettingChange=c,l.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=d,l.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=m,l.getUserJidForEphemeralSetting=p,l.maybeClearEphemeralMsgCountdown=_}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","MAWUserJidWrapper","MWFBLogger","WAJids","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MWFBLogger").MWLogger().tags(["maw_db","txn",(_=o("MAWLoggerUtils")).Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Incoming]),g=o("MWFBLogger").MWLogger().tags(["maw_db","txn",_.Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Outgoing]),h=null,y=90*o("DateConsts").SEC_PER_DAY;function C(t,n,r,a,i,l,d,m,p){if(r<0||r>y){var _=o("WAJids").interpretAndValidateJid(l.jid).toString();throw f.mustfixThrow("EphemeralSetting duration is invalid "+r+", jidType: "+_)}var g={ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:a};f.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",". Thread: ",", Author: ",""])),r,a,String(l),n);var C=o("WAJids").interpretAsUserJid(l.jid);if(C==null)return f.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"]))),o("MAWDexieTable").dexieResolve(h);var b=o("WAJids").isAuthorMe(n)?o("MAWUserJidWrapper").getMyUserJid():n,v=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(l.jid),S=v==null?void 0:v.ephemeralExpirationInSec,R=v==null?void 0:v.ephemeralLastUpdatedOrSetTimestamp;if(p)return v!=null&&!o("MAWEphemeralUtil").isLocalSettingOutdated(g,v)?a!==R?(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sending Sync Response with duration ",", timestamp ",""])),S,R),o("MAWDexieTable").dexieResolve({outOfSyncEphemeralSetting:{chatJid:l.jid,correctEphemeralExpirationInSec:v.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:v.ephemeralLastUpdatedOrSetTimestamp}})):(f.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Ephemeral setting in sync"]))),o("MAWDexieTable").dexieResolve(h)):(o("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:o("WAJids").userIdFromJid(b),chatJid:l.jid,ephemeralSettingArgs:g,isEphemeralSettingReset:i}}),o("MAWDexieTable").dexieResolve(h));var L={ephemeralSetting:g,ephemeralSyncResponseBackoffInfo:void 0,userJid:C};return t.ephemeralSettings.put(L).then(function(){return h})}function b(e,t,n,r,a){var i=n;if(i<0)throw g.mustfixThrow("Ephemeral duration should be 0 or more");var l=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return o("MAWDbThreadTxns").getThread(e,t).then(function(t){return t.success?e.ephemeralSettings.get({userJid:l}).then(function(t){if(!o("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(t,i,r))return o("WAResultOrError").makeResult({shouldUpdateSetting:!1});var n=t==null?{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r},userJid:l}:babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r}});return e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult({shouldUpdateSetting:!0})})}):o("WAResultOrError").makeResult({shouldUpdateSetting:!1})})}function v(e,t,n){var a=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return e.ephemeralSettings.get({userJid:a}).then(function(t){if(t==null||t.ephemeralSetting==null)throw g.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"])),a,String(t),String(t==null?void 0:t.ephemeralSetting)),g.mustfixThrow("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change");var o=babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:t.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:n}});return e.ephemeralSettings.put(o).then(r("emptyFunction"))})}function S(e,t){var n=o("WAJids").interpretAsUserJid(t);n==null&&g.mustfixThrow("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");var r=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(t);return r.ephemeralLastUpdatedOrSetTimestamp===o("WATimeUtils").castToUnixTime(0)?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting")):r!=null&&r.ephemeralExpirationInSec>0?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:t,correctEphemeralExpirationInSec:r.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:r.ephemeralLastUpdatedOrSetTimestamp}})):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting"))}function R(e,t){return e.ephemeralSettings.get({userJid:t}).then(function(n){return(n==null?void 0:n.ephemeralSyncResponseBackoffInfo)==null?(f.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""])),t),o("WAResultOrError").makeResult()):(n.ephemeralSyncResponseBackoffInfo=void 0,f.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""])),t),e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult()}))})}l.handleAndWriteIncomingEphemeralSetting=C,l.handleAndWriteOutgoingUserEphemeralSettingChange=b,l.updateContactWhenEphemeralSettingChangeMarkedSent=v,l.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=S,l.maybeResetEphemeralSyncResponseBackoffInfo=R}),98);
__d("MAWDbMsgOrReaction",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function l(e,t){return e==null?t.forNull():e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function s(e,t){return e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function u(e,t){return e==null?t.forNull():e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}i.switchOnMsgOrReaction=e,i.switchOnMsgOrReactionNullish=l,i.switchOnMsgOrReactionMaybeUnstored=s,i.switchOnMsgOrReactionMaybeUnstoredNullish=u}),66);
__d("MAWThreadUpdateType",[],(function(t,n,r,o,a,i){"use strict";var e=0,l=1,s=2,u=3,c=Object.freeze({BUMP_THREAD:s,MARK_THREAD_AS_UNREAD:u,NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:e,SNIPPET_ONLY:l});i.THREAD_UPDATE_TYPE=c}),66);
__d("MAWGetThreadUpdateTypeForAdminMsg",["FBLogger","MAWAdminMsgTypesGrouped","MAWLocalizationType","MAWThreadUpdateType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e;return t==null?(r("FBLogger")("messenger_web").mustfix("nullAdminType"),o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE):s(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:u(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:c(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:(d(t)||r("FBLogger")("messenger_web").mustfix("unsupportedAdminMsgType"),o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE)}function s(e){return o("MAWAdminMsgTypesGrouped").otherUserAddRemoveParticipant.includes(e)||o("MAWAdminMsgTypesGrouped").chatCustomizedByOtherUser.includes(e)||o("MAWAdminMsgTypesGrouped").callActionToNotifyAbout.includes(e)||o("MAWAdminMsgTypesGrouped").twoUsersConnected.includes(e)||o("MAWAdminMsgTypesGrouped").fallbackMsgFromOtherUser.includes(e)||o("MAWAdminMsgTypesGrouped").otherUserBumpsMessage.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeMarkedAsUnread.includes(e)||e===o("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR}function u(e){return o("MAWAdminMsgTypesGrouped").currentUserAddRemoveParticipant.includes(e)||o("MAWAdminMsgTypesGrouped").chatCustomizedByCurrentUser.includes(e)||o("MAWAdminMsgTypesGrouped").callActionNotToNotifyAbout.includes(e)||o("MAWAdminMsgTypesGrouped").fallbackMsgFromCurrentUser.includes(e)||o("MAWAdminMsgTypesGrouped").currentUserBumpsMessage.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeBumped.includes(e)||o("MAWAdminMsgTypesGrouped").limitSharingUpdate.includes(e)}function c(e){return e===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_ROLLBACK_ADMIN_MESSAGE||o("MAWAdminMsgTypesGrouped").dualThreadCutoverAdminMsgs.includes(e)||o("MAWAdminMsgTypesGrouped").ephemeralSettingChanges.includes(e)||o("MAWAdminMsgTypesGrouped").groupPermissionsChanged.includes(e)||o("MAWAdminMsgTypesGrouped").participantLeftGroup.includes(e)||o("MAWAdminMsgTypesGrouped").pinnedMessageUpdate.includes(e)}function d(e){return o("MAWAdminMsgTypesGrouped").cutoverAdminMsgs.includes(e)||o("MAWAdminMsgTypesGrouped").deviceChanges.includes(e)||o("MAWAdminMsgTypesGrouped").icdcAlerts.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToNotTriggerUpdate.includes(e)||e===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||e===o("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET||e===o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG||e===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_UK_OSA_ADMIN_MESSAGE}l.getThreadUpdateTypeForAdminMsg=e}),98);
__d("MAWGetThreadUpdateType",["FBLogger","MAWDbMsgOrReaction","MAWGetThreadUpdateTypeForAdminMsg","MAWThreadSnippetUtils","MAWThreadUpdateType","MAWUserJidWrapper","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.reaction==null;return u(e,t)}function s(e){return c(e.reactToAuthor)&&!c(e.author)}function u(e,t){return s(e)&&!t?e.senderTimestampMs==null?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE}function c(e){return e===o("WAJids").AUTHOR_ME||e===o("MAWUserJidWrapper").getMyUserJid()}function d(e){var t=e.adminType,n=e.author,a=e.msgType,i=e.xmaMessageType,l=function(t){var e=t.me,r=t.other;return o("WAJids").isAuthorMe(n)?e:r};switch(a){case"Text":case"ReceiverFetch":case"Sticker":case"Unavailable":case"Video":case"Futureproof":case"DocumentFile":case"EphemeralScreenshotAction":case"Gif":case"Image":case"Ptt":case"RavenAction":case"Raven":case"GroupPollCreate":case"GroupPollUpdate":case"BumpExistingMessage":return l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD});case"XMA":return o("MAWThreadSnippetUtils").shouldIgnoreXMAMsgForSnippet(i)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD});case"Revoked":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY;case"DeleteForMe":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE;case"EditAction":return l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE});case"GroupInvite":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"Admin":{if(a==="Admin")return o("MAWGetThreadUpdateTypeForAdminMsg").getThreadUpdateTypeForAdminMsg(t);throw r("FBLogger")("messenger_web").mustfixThrow("Non-admin msg passed in "+(a!=null?a:"UNKNOWN"))}case"SenderKeyDistribution":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE;case"AlertICDC":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"Ciphertext":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"EphemeralSettingAdmin":case"EphemeralSettingChangeFromCurrentDevice":case"EphemeralSyncResponse":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWGetThreadUpdateType] Unexpected message type: %s",a!=null?a:"UNKNOWN")}}function m(t){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstoredNullish(t,{forMessage:function(t){var e;return d({adminType:(e=t.msgContent)==null?void 0:e.adminType,author:t.author,msgType:t.type,xmaMessageType:t.xmaMessageType})},forNull:function(){return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE},forReaction:function(n){return e(n)}})}function p(e){var t=m(e);switch(t){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:return!1;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return!0;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate][snippet] Unhandled threadUpdateType: "+t)}}function _(e){var t=m(e);switch(t){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:return!1;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return!0;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate][bump] Unhandled threadUpdateType: "+t)}}l.getThreadUpdateTypeForReaction=e,l.canReactionAffectBump=s,l.getReactionThreadUpdateType=u,l.getThreadUpdateTypeForMsg=d,l.getThreadUpdateTypeForMsgOrReaction=m,l.isThreadUpdateTypeEligibleForSnippet=p,l.isThreadUpdateTypeEligibleForBump=_}),98);
__d("MAWGetBumpTimestampMs",["I64","MAWAckLevel","MAWDbMsgOrReaction","MAWExtractMsFromExternalId","MAWTimeUtils","WALongInt","WATimeUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){var r=n==null?null:o("MAWExtractMsFromExternalId").extractMsFromExternalId(n);return(e||(e=o("I64"))).add(o("MAWTimeUtils").millisTimeToTimestamp(t),e.of_int32(r!=null?r:0))}function u(t){var n=t.msg,a=t.throwIfNoServerTs,i=a?r("nullthrows")(n.serverTs):n.serverTs;return s(o("WATimeUtils").castUnixTimeToMillisTime(i!=null?i:n.ts),(e||(e=o("I64"))).of_string(n.externalId))}function c(t){return t.senderTimestampMs!=null?(e||(e=o("I64"))).of_string(o("WALongInt").longIntToDecimalString(t.senderTimestampMs)):s(o("WATimeUtils").castUnixTimeToMillisTime(t.ts),(e||(e=o("I64"))).of_string(t.externalId))}function d(t){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstoredNullish(t,{forMessage:function(n){return o("MAWAckLevel").isMsgAuthoritative(n.ack)&&n.sortOrderMs!=null?(e||(e=o("I64"))).of_float(n.sortOrderMs):u({msg:n,throwIfNoServerTs:!1})},forNull:function(){return(e||(e=o("I64"))).zero},forReaction:c})}l.calculateBumpTimestampMs=s,l.getBumpTimestampMs=d}),98);
__d("MAWDbReaction",["FBLogger","I64","MAWAckLevel","MAWGetBumpTimestampMs","MAWUserJidWrapper","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){var t=e.author,n=e.reaction,r=e.reactToAuthor,a=o("MAWUserJidWrapper").getMyUserJid();return!(n==null||n===""||r!=="@me"&&r!==a||t==="@me"||t==="@system"||t===a)}function u(e){var t=o("MAWUserJidWrapper").getMyUserJid();if(e.reactToAuthor!=="@me"&&e.reactToAuthor!==t||e.reaction==null)return null;var n=e.author==="@me"||e.author==="@system"?null:e.author;return n==null?null:babelHelpers.extends({},e,{author:n,reaction:e.reaction,reactToAuthor:"@me"})}function c(e){var t=u(e);if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot cast reaction to incomingDbReaction");return t}function d(e,t,n){var r=o("MAWUserJidWrapper").getMyUserJid();return e.find(function(e){return e.threadJid===t&&o("WAJids").authorToUserId(e.author,r)===o("WAJids").authorToUserId(n,r)})}function m(e){return e}function p(e,t,n,r,a,i,l,s,u,c,d,m,p){m===void 0&&(m=o("MAWAckLevel").ACK.clock);var _={ack:m,author:c,externalId:t,groupingKey:i,reaction:a,reactionId:n,reactToAuthor:l,reactToExternalId:r,reactToMsgId:s,senderTimestampMs:p,threadJid:e,ts:u};return d!=null?babelHelpers.extends({},_,{rowId:d}):_}function _(t){var n=o("MAWGetBumpTimestampMs").getBumpTimestampMs(t);return o("WATimeUtils").castToMillisTime((e||(e=o("I64"))).to_float(n))}l.isIncomingReaction=s,l.maybeCastToIncomingDbReaction=u,l.castToIncomingDbReaction=c,l.findMatchingReaction=d,l.reactionIdToMsgId=m,l.formatReactionForDb=p,l.getReactionTimeMs=_}),98);
__d("MAWThreadNewestMsgOrReactionUtils",["FBLogger","MAWDbMsg","MAWDbMsgTxns","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWGetThreadUpdateType","MAWODSProxy","MAWThreadUpdateType","WALogger","WAMsg","WAOdsEnums","WATimeUtils","first","last"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return _(e,t,u)}function u(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate] Unhandled threadUpdateType to create filter function : "+e)}}function c(e,t){return _(e,t,m)}function d(e){var t=e.db,n=e.jid,r=e.limit;return o("MAWDbMsgTxns").fetchMessagesFromDbWithSortOrderMs(t,n,null,!0,r,function(e){var t;return p(o("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg({adminType:(t=e.msgContent)==null?void 0:t.adminType,author:e.author,msgType:e.type,xmaMessageType:e.xmaMessageType}),e.ephemeralMsgDisappeared===!0)},"before")}function m(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate] Unhandled threadUpdateType to create filter function : %s",e)}}function p(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCacheService] Unhandled threadUpdateType to create filter function : %s",e)}}function _(t,n,r){var a=function(a){return a==null?o("MAWDexieTable").dexieResolve(null):g(t,n,r,a)};return f(t,n,r).then(function(t){return a(t).then(function(r){if(t==null&&r==null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[CentralizedThreadUpdate] No Reaction or Message in "," is eligible for snippet"])),n),null;if(r==null)return t;if(t==null)return r;var a=o("WATimeUtils").castToMillisTime(o("MAWDbMsg").getSortOrderWithFallback(t)),i=o("MAWDbReaction").getReactionTimeMs(r);return a>=i?t:r})})}function f(e,t,n){return o("MAWDbMsgTxns").fetchMessagesFromDbWithSortOrderMs(e,t,null,!0,1,function(e){var t;return n(o("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg({adminType:(t=e.msgContent)==null?void 0:t.adminType,author:e.author,msgType:e.type,xmaMessageType:e.xmaMessageType}),e.ephemeralMsgDisappeared===!0)},"before").then(r("first"))}function g(e,t,n,a){var i=o("MAWDbMsg").getSortOrderWithFallback(a),l=function(a,l){return o("MAWDbReactionsTxns").fetchReactionsFromDbWithTimestamp(e,t,o("WATimeUtils").castToMillisTime(i),l,l==null,a,function(e){return n(o("MAWGetThreadUpdateType").getThreadUpdateTypeForReaction(e),!1)&&o("MAWDbReaction").getReactionTimeMs(e)>i})},s=[1,10],u=100,c=new Set,d=function(n,a){var t;return l((t=s[n])!=null?t:u,a).then(function(t){var a=t.filter(function(e){return!c.has(C(e))});return a.length===0?(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_THREAD_GET_NEWEST_REACTION_BATCH_NUM,key:"new."+n}),null):h(e,a).then(function(e){var a=e.newestReaction,i=e.nullMsgIds;return a!=null?(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_THREAD_GET_NEWEST_REACTION_BATCH_NUM,key:"new."+n}),a):(i.forEach(function(e){return c.add(e)}),d(n+1,r("last")(t)))})})};return d(0,null)}function h(e,t){return o("MAWDbMsgTxns").getUniqueMsgsByProtocolMsgIds(e,t.map(y)).then(function(e){var n=new Set(e.map(b)),r=new Set,o=null;return t.forEach(function(e){var t=C(e);n.has(t)?o=v(o,e):r.add(t)}),{newestReaction:o,nullMsgIds:r}})}function y(e){return{author:e.reactToAuthor,chat:e.threadJid,externalId:e.reactToExternalId}}function C(e){return o("WAMsg").craftWAMsgIdString(y(e))}function b(e){return o("WAMsg").craftWAMsgIdString({author:e.author,chat:e.threadJid,externalId:e.externalId})}function v(e,t){return e==null?t:t==null||o("MAWDbReaction").getReactionTimeMs(e)>o("MAWDbReaction").getReactionTimeMs(t)?e:t}l.getNewestMsgOrReactionForBump=s,l.filterForBump=u,l.getNewestMsgOrReactionForSnippet=c,l.getNewestIncomingMsgsForSnippet=d,l.filterForSnippet=m,l.filterForSnippetNewestIncomingMessages=p,l.getNewestReactionToNonNullMsg=h}),98);
__d("MAWThreadSnippetForAdminOrEphemeralMsg",["FBLogger","MAWAdminMsgNormalized","MAWLocalizationType","MAWLocalizationUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.adminMsgContent,n=e.adminType,a=e.snippetSenderContactId,i=n;if(i==null||t==null)return r("FBLogger")("GroupPollsE2EE").mustfix("MAWThreadSnippetForAdminOrEphemeralMsg: snippetType or adminMsgContent is null"),{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:a,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET};var l=o("MAWLocalizationUtils").isAdminMsgNormalized(i)?o("MAWAdminMsgNormalized").deconstructContactIdsFromAdminContent(i,t):{contactIds:[],contents:t},s=l.contactIds,u=l.contents;return{snippetParams:{contactIDs:[].concat(s.map(function(e){return e==="Facebook User"?"0":e})),strings:[].concat(u)},snippetSenderContactId:a,snippetType:i}}l.default=e}),98);
__d("MAWThreadSnippetForBumpExistingMessageMsg",["MAWLocalizationType","WAGlobals","WAJids","WALogger","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n){return{snippetParams:{contactIDs:n!=null?n:[],strings:[]},snippetSenderContactId:e,snippetType:t}}var m=function(t){return d(t,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)};function p(t){var n=t.author,r=t.replyAuthor,a=t.replyType,i=t.snippetSenderContactId;if(o("WAJids").isAuthorSystem(n))return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Bumped message can not have AUTHOR_SYSTEM"]))),m(i);var l=a;if(l===o("WAMsgType").UNAVAILABLE)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Bump message has unavailable content type"]))),m(i);var p=r;return p==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Bump message has no quoted author"]))),m(i)):o("WAJids").isAuthorMe(n)||n===o("WAGlobals").getMyUserJid()?o("WAJids").isAuthorMe(p)||p===o("WAGlobals").getMyUserJid()?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_OWN_MESSAGE):d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE,[o("WAJids").userIdFromJid(p)]):i==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Bump message sender is null"]))),m(i)):o("WAJids").isAuthorMe(p)||p===o("WAGlobals").getMyUserJid()?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_CURRENT_USER_MESSAGE,[i]):p===n?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_OWN_MESSAGE,[i]):d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE,[i,o("WAJids").userIdFromJid(p)])}l.default=p}),98);
__d("MAWThreadSnippetForCiphertextMsg",["MAWLocalizationType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:e,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.USER_SEND_ENCRYPTED_MESSAGE_FALLBACK}}l.default=e}),98);
__d("MAWThreadSnippetForDocumentFileMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Document file message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForFallbackMessageMsg",["MAWLocalizationType","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return{snippetParams:{contactIDs:n!=null?n:[],strings:[]},snippetSenderContactId:e,snippetType:t}}function s(t){var n=t.author,r=t.snippetSenderContactId,a=t.unsupportedType;if(o("WAJids").isAuthorMe(n))switch(a){case"liveLocationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LIVE_LOCATION_FALLBACK);case"locationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION_FALLBACK);case"contactShareMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE_FALLBACK);case"storyMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION_FALLBACK);case"postMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POST_MENTION_FALLBACK);case"pollCreationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POLL_CREATION_FALLBACK);case"bumpMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE);case"stickerReceiverFetchMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER_RECEIVER_FETCH_MESSAGE_FALLBACK);case"messengerMemory":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.MESSENGER_MEMORY_ENCRYPTED_MESSAGE_FALLBACK);default:return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}else switch(a){case"liveLocationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LIVE_LOCATION_FALLBACK);case"locationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION_FALLBACK);case"contactShareMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE_FALLBACK);case"storyMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION_FALLBACK);case"postMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POST_MENTION_FALLBACK);case"pollCreationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POLL_CREATION_FALLBACK);case"bumpMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE);case"metaAiMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.META_AI_SEND_MESSAGE_FALLBACK);case"stickerReceiverFetchMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER_RECEIVER_FETCH_MESSAGE_FALLBACK);case"messengerMemory":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.MESSENGER_MEMORY_ENCRYPTED_MESSAGE_FALLBACK);default:return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}}l.default=s}),98);
__d("MAWThreadSnippetForGifMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForImageMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Image message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForPttMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_AUDIO:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Ptt message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_AUDIO,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForRavenMsg",["MAWLocalizationType","MAWMsg","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.ravenMediaType,i=t.snippetSenderContactId,l=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,s={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?l=a===o("MAWMsg").MAWRavenMsgMediaType.IMAGE?o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:o("WAJids").isAuthorSystem(n)||i==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]))):(l=a===o("MAWMsg").MAWRavenMsgMediaType.IMAGE?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,s.contactIDs.push(i)),{snippetParams:s,snippetSenderContactId:i,snippetType:l}}l.default=s}),98);
__d("MAWThreadSnippetForMsgUtils",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,i={contactIDs:[],mentionJIDs:n!=null?n:[],strings:[]};return o("WAJids").isAuthorMe(t)?a=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER:o("WAJids").isAuthorSystem(t)||r==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Sticker message can not have AUTHOR_SYSTEM"]))):(a=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER,i.contactIDs.push(r)),{snippetParams:i,snippetSenderContactId:r,snippetType:a}}l.getMAWThreadSnippetForStickerMsg=s}),98);
__d("MAWThreadSnippetForReceiverFetchMsg",["MAWThreadSnippetForMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.mentionedJids,r=e.snippetSenderContactId;return o("MAWThreadSnippetForMsgUtils").getMAWThreadSnippetForStickerMsg(t,n,r)}l.default=e}),98);
__d("MAWThreadSnippetForRevokedMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNSENT_MESSAGE:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Revoked message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNSENT_MESSAGE,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForStickerMsg",["MAWThreadSnippetForMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.mentionedJids,r=e.snippetSenderContactId;return o("MAWThreadSnippetForMsgUtils").getMAWThreadSnippetForStickerMsg(t,n,r)}l.default=e}),98);
__d("MAWThreadSnippetForTextMsg",["MAWLocalizationType","MAWVault","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.content,a=t.isGroup,i=t.mentionedJids,l=t.snippetSenderContactId,s=t.specialTextSize,u=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,c={contactIDs:[],mentionJIDs:i,strings:[]};if(o("WAJids").isAuthorMe(n)?u=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_TEXT:o("WAJids").isAuthorSystem(n)||l==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Text message can not have AUTHOR_SYSTEM"]))):(u=a?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT_IN_GROUP:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT,c.contactIDs.push(l)),r!=null)if(s===1||s===2||s===3){var d=o("MAWVault").unvault(r);c.strings.push(d==="\uD83D\uDC4D"?"(Y)":r)}else c.strings.push(r);return{snippetParams:c,snippetSenderContactId:l,snippetType:u}}l.default=s}),98);
__d("MAWThreadSnippetForVideoMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.gifPlayback,a=t.mentionedJids,i=t.snippetSenderContactId,l=r===!0,s=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,u={contactIDs:[],mentionJIDs:a,strings:[]};return o("WAJids").isAuthorMe(n)?s=l?o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:o("WAJids").isAuthorSystem(n)||i==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Video message can not have AUTHOR_SYSTEM"]))):(s=l?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,u.contactIDs.push(i)),{snippetParams:u,snippetSenderContactId:i,snippetType:s}}l.default=s}),98);
__d("MAWThreadSnippetForXMAMsg",["MAWLocalizationType","WAArmadilloXMA.pb","WAJids","WALogger","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N;function M(t){var n=t.author,a=t.chatJid,i=t.content,l=t.mentionedJids,M=t.snippetSenderContactId,A=t.xmaMessageType,F=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,O={contactIDs:[],mentionJIDs:l,strings:[]};switch(A==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["XMA message does not have xmaMessageType"]))),A){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.GEN_AI_RICH_RESPONSE:if(!r("gkx")("12661")){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet: ",""])),A);break}case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:if(o("WAJids").isAuthorMe(n))if(i!=null){var B=i;F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT,B!=null&&O.strings.push(B)}else F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT;else if(o("WAJids").isAuthorSystem(n)||M==null)o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"])));else{F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,O.contactIDs.push(M);var W=i;W!=null&&O.strings.push(W)}break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_POST_MENTION:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POST_MENTION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POST_MENTION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_MEMORIES_SHARE:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_MEMORIES_SHARE;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_AI_CONTACT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_REEL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_REEL;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY_HIGHLIGHT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY_HIGHLIGHT;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MENTIONED_STORY_IG;var q;if(a!=null&&(q=o("WAJids").interpretAsUserJid(a)),q!=null){var U=o("WAJids").userIdFromJid(q);O.contactIDs.push(U)}else o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["XMA story mentions must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)?o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_RECEIVED_STORY_MENTION_IG;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_AUDIO_CALLED;var V=w(a);V!=null?O.contactIDs.push(V):o("WALogger").ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_AUDIO_CALLED,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:if(o("WAJids").isAuthorMe(n)&&M!=null){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_VIDEO_CALLED;var H=w(a);H!=null?O.contactIDs.push(H):o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_VIDEO_CALLED,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_AUDIO_CALL;var G=w(a);G!=null?O.contactIDs.push(G):o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_AUDIO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_VIDEO_CALL;var z=w(a);z!=null?O.contactIDs.push(z):o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_VIDEO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:o("WAJids").isAuthorMe(n)&&M!=null?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_AUDIO_CALL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_AUDIO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:o("WAJids").isAuthorMe(n)&&M!=null?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_VIDEO_CALL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR($||($=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_VIDEO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_EVENT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(P||(P=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_EVENT,O.contactIDs.push(M));break;default:o("WALogger").ERROR(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet: ",""])),A)}return{snippetParams:O,snippetSenderContactId:M,snippetType:F}}function w(e){var t=e!=null?o("WAJids").interpretAsUserJid(e):null;return t!=null?o("WAJids").userIdFromJid(t):null}l.default=M}),98);
__d("MAWThreadSnippet",["FBLogger","MAWLocalizationType","MAWMsgType","MAWThreadSnippetForAdminOrEphemeralMsg","MAWThreadSnippetForBumpExistingMessageMsg","MAWThreadSnippetForCiphertextMsg","MAWThreadSnippetForDocumentFileMsg","MAWThreadSnippetForFallbackMessageMsg","MAWThreadSnippetForGifMsg","MAWThreadSnippetForImageMsg","MAWThreadSnippetForPttMsg","MAWThreadSnippetForRavenMsg","MAWThreadSnippetForReceiverFetchMsg","MAWThreadSnippetForRevokedMsg","MAWThreadSnippetForStickerMsg","MAWThreadSnippetForTextMsg","MAWThreadSnippetForVideoMsg","MAWThreadSnippetForXMAMsg","MAWUserJidWrapper","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return/^\d+$/.test(e)}function s(t){if(!o("WAJids").isAuthorSystem(t)){var n=o("WAJids").isAuthorMe(t)?o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid()):o("WAJids").userIdFromJid(t);if(!e(n)){r("FBLogger")("messenger_web").mustfix("[MAWThreadSnippetBuildTxns] Snippet sender contact id is invalid");return}return n}}function u(e){var t=e.adminMsgContent,n=e.adminType,a=e.author,i=e.chatJid,l=e.content,u=e.gifPlayback,c=e.mentionedJids,d=e.msgType,m=e.ravenMediaType,p=e.replyAuthor,_=e.replyType,f=e.specialTextSize,g=e.unsupportedType,h=e.xmaMessageType,y=o("WAJids").switchOnMsgrChatJidType(i,{group:function(t){return!0},user:function(t){return!1}}),C=s(a);switch(d){case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return r("MAWThreadSnippetForCiphertextMsg")(C);case o("MAWMsgType").MSG_TYPE.TEXT:return r("MAWThreadSnippetForTextMsg")({author:a,content:l,isGroup:y,mentionedJids:c,snippetSenderContactId:C,specialTextSize:f});case o("MAWMsgType").MSG_TYPE.IMAGE:return r("MAWThreadSnippetForImageMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.VIDEO:return r("MAWThreadSnippetForVideoMsg")({author:a,gifPlayback:u,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.PTT:return r("MAWThreadSnippetForPttMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:return r("MAWThreadSnippetForAdminOrEphemeralMsg")({adminMsgContent:t,adminType:n,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.GIF:return r("MAWThreadSnippetForGifMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.STICKER:return r("MAWThreadSnippetForStickerMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return r("MAWThreadSnippetForDocumentFileMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.REVOKED:return r("MAWThreadSnippetForRevokedMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.XMA:return r("MAWThreadSnippetForXMAMsg")({author:a,chatJid:i,content:l,mentionedJids:c,snippetSenderContactId:C,xmaMessageType:h});case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return r("MAWThreadSnippetForBumpExistingMessageMsg")({author:a,replyAuthor:p,replyType:_,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return r("MAWThreadSnippetForFallbackMessageMsg")({author:a,snippetSenderContactId:C,unsupportedType:g});case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return r("MAWThreadSnippetForReceiverFetchMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.RAVEN:return r("MAWThreadSnippetForRavenMsg")({author:a,mentionedJids:c,ravenMediaType:m,snippetSenderContactId:C});default:return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:C,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET}}}l.getSnippetContactId=s,l.buildThreadSnippet=u}),98);
__d("WAProtocolMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.externalId===t.externalId&&e.author===t.author&&e.chat===t.chat}i.equals=e}),66);
__d("MAWThreadSnippetBuildTxns",["FBLogger","MAWDbMsg","MAWDbMsgOrReaction","MAWDbReaction","MAWDexieTable","MAWJidUtils","MAWLocalizationType","MAWThreadSnippet","MAWThreadSnippetUtils","MAWUserJidWrapper","WAJids","WAProtocolMsgId","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("WAJids").switchOnMsgrChatJidType(n,{group:function(r){return u(e,t,!0)},user:function(r){return u(e,t,!1)}})}function s(t,n){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstored(n,{forMessage:function(n){var e,r,a,i,l,s,u;return o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(e=n.msgContent)==null?void 0:e.adminMsgContent,adminType:(r=n.msgContent)==null?void 0:r.adminType,author:n.author,chatJid:t,content:(a=n.msgContent)==null?void 0:a.content,mentionedJids:(i=n.msgContent)==null?void 0:i.mentionedJids,msgType:n.type,ravenMediaType:n.ravenMediaType,replyAuthor:(l=n.quote)==null?void 0:l.content.author,replyType:(s=n.quote)==null?void 0:s.content.type,specialTextSize:n.specialTextSize,unsupportedType:(u=n.msgContent)==null?void 0:u.subtype,xmaMessageType:n.xmaMessageType})},forReaction:function(n){var t=o("MAWDbReaction").castToIncomingDbReaction(n);return e(t.author,t.reaction,t.threadJid)}})}function u(e,t,n){var a;o("WAJids").isAuthorMe(e)?(r("FBLogger")("messenger_web").warn("[MAWThreadSnippetBuildTxns] Reaction snippet author should not be @me"),a=o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid())):a=o("WAJids").userIdFromJid(e);var i={contactIDs:[],strings:[]},l=n?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE_IN_GROUP:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE;return i.contactIDs.push(a),i.strings.push(t),{snippetParams:i,snippetSenderContactId:a,snippetType:l}}function c(e,t,n,r){var a,i=n.newestReaction,l=n.reactionsToClear;if(i!=null&&o("WATimeUtils").castUnixTimeToMillisTime(i.ts)>((a=t.snippetMsgTs)!=null?a:0))return o("MAWDexieTable").dexieResolve({newestReaction:i,thread:d(t,i,r)});var s=l!=null&&l.length>0;return s&&t.snippetMsg!=null?e.reactions.get({reactionId:t.snippetMsg}).then(function(n){var r=!1;if(n==null)r=!0;else{var a=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.threadJid,n.reactToExternalId);a!=null&&(r=l.some(function(e){var t=o("MAWJidUtils").maybeToProtocolMsgId(e.author,e.threadJid,e.reactToExternalId);return t!=null&&o("WAProtocolMsgId").equals(t,a)}))}return r?m(e,t).then(function(e){return{newestReaction:null,thread:e}}):o("MAWDexieTable").dexieResolve({newestReaction:null,thread:t})}):o("MAWDexieTable").dexieResolve({newestReaction:null,thread:t})}function d(e,t,n){return babelHelpers.extends({},e,{snippetMsg:t.reactionId,snippetMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(t.ts)})}function m(e,t){return o("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(e,t).then(function(e){if(e==null)return r("FBLogger")("messenger_web").mustfix("[Occamadillo] ThreadUpdated handler called for clear snippet when centralized thread bump is enabled"),babelHelpers.extends({},t,{snippetMsg:void 0,snippetMsgTs:void 0});var n=o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(e));return babelHelpers.extends({},t,{snippetMsg:e.msgId,snippetMsgTs:n})})}function p(e,t){return m(e,t).then(function(t){return e.threads.put(t).then(r("emptyFunction"))})}l.buildReactionThreadSnippet=e,l.buildThreadSnippetForMsgOrIncomingReaction=s,l.getReactionSnippetParams=u,l.getThreadChangesetForReactionChanges=c,l.getThreadChangesetForNewReaction=d,l.refreshThreadSnippet=p}),98);
__d("MAWThreadSnippetUtils",["MAWDbReaction","MAWEphemeralMsgUtils","MAWJidUtils","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWThreadNewestMsgOrReactionUtils","MAWThreadSnippet","MAWThreadSnippetBuildTxns","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;if(d(e.xmaMessageType))return!0;var n=((t=e.msgContent)==null?void 0:t.adminType)!=null?o("MAWLocalizationUtils").isDeviceChangeAdminMsg(e.msgContent.adminType):!1;if(e.type!==o("MAWMsgType").MSG_TYPE.ADMIN)return!1;var r=e.msgContent.adminType;return r===o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG?!0:n}function s(t,n,r){return t.messages.where("[threadJid+sortOrderMs]").between([n.jid,Number.MIN_SAFE_INTEGER],[n.jid,Number.MAX_SAFE_INTEGER],!1,!1).filter(function(t){return(r==null||o("MAWEphemeralMsgUtils").filterNonExpiredMsg(r)(t))&&!e(t)}).reverse().first()}var u={snippetParams:{contactIDs:[],mentionJIDs:[],strings:[]},snippetSenderContactId:null,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET};function c(e,t,n,r){return r==null||r.addPoint("fetching_from_db_from_scratch_"+(n!=null?n:0)+"_start"),o("MAWThreadNewestMsgOrReactionUtils").getNewestMsgOrReactionForSnippet(e,t).then(function(e){return r==null||r.addPoint("fetching_from_db_from_scratch_"+(n!=null?n:0)+"_end"),e==null?{snippet:u}:m(t,e)})}function d(e){return o("MAWXMAUtils").isXMAStoryReply(e)||o("MAWXMAUtils").isXMAMsgHighlightsTabFriendUpdatesReply(e)}function m(e,t){var n,r,a,i,l,s,c;if(t.reactionId!=null){var d=o("MAWDbReaction").maybeCastToIncomingDbReaction(t);return d==null?{snippet:u}:{snippet:o("MAWThreadSnippetBuildTxns").buildReactionThreadSnippet(d.author,d.reaction,e),snippetMsgOrReaction:t}}switch(t.type){case o("MAWMsgType").MSG_TYPE.XMA:{var m,p,_,f,g,h,y,C=o("MAWJidUtils").toProtocolMsgId(t);return C==null?{snippet:u}:{snippet:o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(m=t.msgContent)==null?void 0:m.adminMsgContent,adminType:(p=t.msgContent)==null?void 0:p.adminType,author:t.author,chatJid:t.threadJid,content:(_=t.msgContent)==null?void 0:_.content,mentionedJids:(f=t.msgContent)==null?void 0:f.mentionedJids,msgType:t.type,ravenMediaType:t.ravenMediaType,replyAuthor:(g=t.quote)==null?void 0:g.content.author,replyType:(h=t.quote)==null?void 0:h.content.type,specialTextSize:t.specialTextSize,unsupportedType:(y=t.msgContent)==null?void 0:y.subtype,xmaMessageType:t.xmaMessageType}),snippetMsgOrReaction:t}}default:return{snippet:o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(n=t.msgContent)==null?void 0:n.adminMsgContent,adminType:(r=t.msgContent)==null?void 0:r.adminType,author:t.author,chatJid:t.threadJid,content:(a=t.msgContent)==null?void 0:a.content,mentionedJids:(i=t.msgContent)==null?void 0:i.mentionedJids,msgType:t.type,ravenMediaType:t.ravenMediaType,replyAuthor:(l=t.quote)==null?void 0:l.content.author,replyType:(s=t.quote)==null?void 0:s.content.type,specialTextSize:t.specialTextSize,unsupportedType:(c=t.msgContent)==null?void 0:c.subtype,xmaMessageType:t.xmaMessageType}),snippetMsgOrReaction:t}}}l.isDbMsgDisabledForThreadSnippet=e,l.recalculateSnippetFromScratch_EXPENSIVE=s,l.EMPTY_SNIPPET_DATA=u,l.getThreadSnippetFromScratch=c,l.shouldIgnoreXMAMsgForSnippet=d}),98);
__d("MAWEphemeralMsgTxns",["EBLogger","MAWBridgeMsgCountdown","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLoggerUtils","MAWODSProxy","MAWThreadSnippetUtils","MWFBLogger","WAJids","WAOdsEnums","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("MWFBLogger").MWLogger().tags([(p=o("MAWLoggerUtils")).Tag.Ephemeral,p.Tag.SettingSync,p.Tag.Incoming]),f=o("MWFBLogger").MWLogger().tags([p.Tag.Ephemeral,p.Tag.OnRead,p.Tag.Countdown]);function g(e,t,n){return n===void 0&&(n=function(){return!0}),o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,t,!1,!0).filter(n).limit(1).toArray().then(function(e){var t;return{needsUpdate:!0,value:(t=e[0])!=null?t:null}})}function h(e,t,n){return n.size===0?o("MAWDexieTable").dexieResolve():o("MAWDbThreadTxns").getThread(e,t).then(function(t){if(t.success){var r=t.value;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").getThreadOldestMessageId(e,r.jid),o("MAWDbMsgTxns").getThreadNewestMessageId(e,r.jid)]).then(function(t){var a=t[0],i=t[1];if(!(a==null||i==null)){var l=o("MAWEphemeralMsgUtils").filterNonExpiredMsg(n),s=n.has(a)?g(e,r.jid,l):o("MAWDexieTable").dexieResolve({needsUpdate:!1}),u=n.has(i)?o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,r.jid,!0,!1).filter(l).reverse().limit(1).toArray().then(function(t){var a=t[0];return a!=null&&o("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(a)?o("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(e,r,n).then(function(e){return{needsUpdate:!0,value:e!=null?e:null}}):{needsUpdate:!0,value:a!=null?a:null}}):o("MAWDexieTable").dexieResolve({needsUpdate:!1});return o("MAWDexieTable").dexieAll([s,u]).then(function(t){var n,l,s,u,c=t[0],d=t[1];if(!(!c.needsUpdate&&!d.needsUpdate)){var m=d.needsUpdate?(n=(l=d.value)==null?void 0:l.msgId)!=null?n:void 0:i,p=d.needsUpdate?d.value!=null?o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(d.value)):void 0:r.snippetMsgTs,_=babelHelpers.extends({},r,{oldestMsg:c.needsUpdate?(s=(u=c.value)==null?void 0:u.msgId)!=null?s:null:a,snippetMsg:m,snippetMsgTs:p});e.threads.put(_)}})}})}})}function y(t,n,r){if(r===void 0&&(r=!0),n==null||n.ephemeralSetting==null||n.ephemeralSetting.ephemeralExpirationInSec===0)return o("MAWDexieTable").dexieResolve(n);var a=o("WATimeUtils").castToUnixTime(n.ts+n.ephemeralSetting.ephemeralExpirationInSec),i=o("WATimeUtils").castToUnixTime(a+o("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);return n.ebTimestampMs!=null&&(o("EBLogger").EBLogger().tags(["eb_restore"]).WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Delete DM backup - S472027 follow up"]))),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"restore_dm_s472027"})),C(t,[{messageDeleteTs:i,messageExpirationTs:a,msgId:n.msgId,readTsForLogging:n.ts}]).then(function(e){var t=e[0],n=e[1],a=e[2];return a.length>0&&(f.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""])),String(a.map(function(e){return e.msgId}))),r&&o("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)})),t!=null&&n!=null&&o("MAWEphemeralCleaner").addNewEphemeralTimestamp(t,n),a[0]})}function C(e,t){var n=t.map(function(e){return e.msgId});return o("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(e,n).then(function(r){var o=new Map;t.forEach(function(e){o.set(e.msgId,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging});var t=r.get(e.msgId);t!=null&&o.set(t,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging})});var a=null,i=null,l=[],s=Array.from(new Set(n.concat(Array.from(r.values()))));return e.messages.where("msgId").anyOf(s).toArray().then(function(t){if(t.length!==0)return t.forEach(function(e){var t=e.messageExpirationTs,n=e.messageDeleteTs,r=o.get(e.msgId),s=r==null?void 0:r.messageExpirationTs,c=r==null?void 0:r.messageDeleteTs;if(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""])),e.msgId,t,n,s,c),!(s==null||c==null)&&e.ephemeralCounterStarted!==!0){(a==null||s<a)&&(a=s),(i==null||c<i)&&(i=c);var d=babelHelpers.extends({},e,{ephemeralCounterStarted:!0,messageDeleteTs:c,messageExpirationTs:s});l.push(d)}}),e.messages.bulkPut(l)}).then(function(){return[a,i,l]})})}function b(e,t){if(t.size===0)return o("MAWDexieTable").dexieResolve();var n=[];return t.forEach(function(t,r){n.push(h(e,r,t))}),o("MAWDexieTable").dexieAll(n).then(r("emptyFunction"))}function v(e,t,n,a,i){if(t==null)return o("MAWDexieTable").dexieResolve();_.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""])),n,a.jid,t.type);var l=o("MAWDexieTable").dexieResolve();if(t.ephemeralSetting==null)o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(){return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))},user:function(){o("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(t)&&(l=o("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(e,a.jid).then(function(e){var t;return e==null||(t=e.value)==null?void 0:t.outOfSyncEphemeralSetting}))}});else if(t.messageExpirationTs!=null&&t.messageDeleteTs!=null){var s=t.ephemeralSetting,u=t.messageDeleteTs,p=t.messageExpirationTs;_.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""])),s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp),o("MAWEphemeralCleaner").addNewEphemeralTimestamp(p,u),l=o("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(e,n,s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp,!1,a,i,null,!0).then(function(e){return e==null?void 0:e.outOfSyncEphemeralSetting})}return l.then(function(t){if(t!=null)_.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""])),t.correctEphemeralExpirationInSec,t.correctEphemeralLastUpdatedOrSetTimestamp);else return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))})}l.markEphemeralMessageAsSent=y,l.bulkUpdateEphemeralMessageTimestamps=C,l.updateThreadsOnMessagesExpiredFromUi=b,l.syncEphemeralSettingOnIncomingMsg=v}),98);
__d("MAWExpiredQuoteCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.QUOTE))}function d(t){if(u==null){var n="Trying to add new addNewExpiredQuoteCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ExpiredQuoteCleaner: Adding timestamps backend(",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startExpiredQuoteCleaner=c,l.addNewExpiredQuoteCleanerTimestamp=d,l.getExpiredQuoteCleaner_FOR_TESTING_ONLY=m,l.resetExpiredQuoteCleaner_FOR_TESTING_ONLY=p}),98);
__d("isE2EEConversationSearchEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("4741")}l.default=e}),98);
__d("isMAWUniversalSearchEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("4741")}l.default=e}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isMAWUniversalSearchEnabled"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("isE2EEConversationSearchEnabled")()||r("isMAWUniversalSearchEnabled")()}l.default=e}),98);
__d("MAWFTSTxns",["FtsIndexEntity","MAWDexieTable","ODS","isWAFTSContentSearchEnabled","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("justknobx")._("1146");function u(t,n){return r("isWAFTSContentSearchEnabled")()?((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"purge_message_backlog.put"),t.ftsPurgeBacklog.put({externalId:n})):o("MAWDexieTable").dexieResolve(null)}function c(t,n){return!r("isWAFTSContentSearchEnabled")()||!s?o("MAWDexieTable").dexieResolve(null):((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"index_message_backlog.put"),t.ftsBackloggedMessages.put({rowId:n}))}function d(t,n){return!r("isWAFTSContentSearchEnabled")()||!s?o("MAWDexieTable").dexieResolve(null):((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"index_message_backlog.put",n.length),t.ftsBackloggedMessages.bulkPut(n.map(function(e){return{rowId:e}})))}function m(t,n){return r("isWAFTSContentSearchEnabled")()?((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"purge_thread_backlog.put"),t.ftsPurgeThreadBacklog.put({chatJid:n})):o("MAWDexieTable").dexieResolve(null)}function p(e,t,n){return e?t():n()}l.maybePutMessageToPurgeBacklog=u,l.maybePutMessageToBacklog=c,l.maybePutMessagesToBacklog=d,l.maybePutThreadToPurgeBacklog=m,l.dexieIfElse=p}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum")({MSGR:"msgr",IGD:"igd"}),l=e;i.default=l}),66);
__d("MAWMainTraceUtils",["LSRequestId"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("LSRequestId").generate()}l.createTraceId=e}),98);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.actionType,n=e.attachmentContext,r=e.attachmentContextArray,o=e.authTs,a=e.echoDocument,i=e.echoEncodingLatencyNs,l=e.errorCode,s=e.errorMessage,c=e.messageId,d=e.messageType,m=e.productType,p=e.protoMsg,_=e.sortOrderMs,f=e.threadId,g=e.traceId,h=e.uploadTrackingInstanceKey,y=u(n,m!=null?m:"msgr",r);return{actionType:t,attachmentBackupContext:y,authTs:o,echoDocument:a,echoEncodingLatencyNs:i,errorCode:l,errorMessage:s,messageId:c,messageType:d,protoMsg:p,sortOrderMs:_,threadId:f,traceId:g,uploadTrackingInstanceKey:h}}function s(e,t,n,r,o,a){return{actionType:a,echoDocument:o,folderType:t,threadId:e,transportKey:n,ts:r}}function u(e,t,n){if(n!=null){var r=n.map(function(e){return{attachmentTraceId:o("MAWMainTraceUtils").createTraceId(),mediaType:e.mediaType,zippyObjectId:e.mediaObjectId}}),a={attachmentInfos:r,productType:t};return a}}l.createBridgeUploadMessage=e,l.createBridgeDeleteMessagesOfThread=s,l.createBridgeUploadAttachmentBackupContext=u}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function s(t){switch(t){case o("MAWFolderTypes").FOLDER_ID.INBOX:return e.INBOX;case o("MAWFolderTypes").FOLDER_ID.PENDING:return e.PENDING;case o("MAWFolderTypes").FOLDER_ID.ARCHIVED:return e.ARCHIVED;default:return e.INBOX}}function u(e){return s(e).toString()}l.FolderType=e,l.getFolderTypeAsText=u}),98);
__d("MpsDeletedCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new MpsDeletedTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MpsDeletedCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startMpsDeletedCleaner=c,l.addNewMpsDeletedTimestamp=d,l.getMpsDeletedCleaner_FOR_TESTING_ONLY=m,l.resetMpsDeletedCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"purgeDeletions"]);function c(e){s==null&&(s=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.EPHEMERAL))}function d(t){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",")"])),t),s.update(t)}function m(){return s}function p(){s=null}l.startMpsEphemeralCleaner=c,l.addNewMpsEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsReverbDbDump",["WebReverbDB","WormDump"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t=o("WebReverbDB").getWebReverbDB();return t.dump({dbMetadata:{customFields:{mawDBMigrationCurrentMessageId:(e=o("WormDump")).wormNonSensitiveField,mawDBMigrationCurrentThread:e.wormNonSensitiveField,mawDBMigrationStartMs:e.wormNonSensitiveField,mawDBMigrationState:e.wormNonSensitiveField,pk:e.wormNonSensitiveField}},deleted:{customFields:{deletedMessageId:e.wormNonSensitiveField,deletionMessageId:e.wormNonSensitiveField,deletionTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},message:{customFields:{debugFlags:e.wormNonSensitiveField,expiryTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,isTransportErrorPlaceholder:e.wormNonSensitiveField,messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,senderId:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:2500},supplemental:{customFields:{messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},tags:{customFields:{messageId:e.wormNonSensitiveField,messagePk:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:1e3}})}l.debugGetReverbDbDump=e}),98);
__d("QPLMultiplexedFlow",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=Array.from(new Set(e));return{addAnnotations:function(n){t.forEach(function(e){return e.addAnnotations(n)})},addPoint:function(n,r){t.forEach(function(e){return e.addPoint(n,r)})},endCancel:function(n,r){t.forEach(function(e){return e.endCancel(n,r)})},endFail:function(n,r){t.forEach(function(e){return e.endFail(n,r)})},endSuccess:function(n){t.forEach(function(e){return e.endSuccess(n)})},getQPLAttrs:function(){return t.map(function(e){return e.getQPLAttrs()})[0]},isActive:function(){return t.some(function(e){return e.isActive()})},start:function(){}}}i.makeQplMultiplexedFlow=e}),66);
__d("WebMpsGetDistinctSupplementals",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=new Map(e),r=new Map;return t.forEach(function(e,t){var o=n.get(t);if(o==null)n.set(t,e),r.set(t,e);else{var a=o.timestampMs,i=e.timestampMs;i>a&&(n.set(t,e),r.set(t,e))}}),{supplementals:n,supplementalsToWriteToReverb:r}}i.getDistinctSupplementals=e}),66);
__d("WebMpsGetDistinctMessages",["WebMpsGetDistinctSupplementals"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"],s=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function u(t,n){var r=new Map,a=new Map;t.forEach(function(t){var n=t.reverbTopLevel,o=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=babelHelpers.objectWithoutPropertiesLoose(n,e);a.set(t.reverbTopLevel.messageId,t),r.set(t.reverbTopLevel.messageId,{expiryTimestampMs:i,supplementalProtobufs:t.supplementalProtobufs,tags:t.tags,toplevelProtobuf:c})});var i=new Map,l=new Map,u=new Map;return n.forEach(function(e){var t=e.supplementalProtobufs,n=e.tags,c=e.toplevelProtobuf,d=c.messageId,m=a.get(d);if(m==null||m.reverbTopLevel.isTransportErrorPlaceholder===!0)r.set(d,e),i.set(d,c),l.set(d,new Map(t)),u.set(d,n);else{var p=m.supplementalProtobufs,_=o("WebMpsGetDistinctSupplementals").getDistinctSupplementals(p,t),f=_.supplementals,g=_.supplementalsToWriteToReverb,h=m.reverbTopLevel,y=h.debugFlags,C=h.expiryTimestampMs,b=h.isLocalOnlyMessage,v=h.isTransportErrorPlaceholder,S=h.pk,R=babelHelpers.objectWithoutPropertiesLoose(h,s);r.set(d,{expiryTimestampMs:C,supplementalProtobufs:f,tags:m.tags,toplevelProtobuf:R}),g.size>0&&l.set(d,new Map(g))}}),{messages:Array.from(r.values()),supplementalMessagesToWriteToReverb:l,tagsToWriteToReverb:u,topLevelMessagesToWriteToReverb:i}}l.getDistinctMessages=u}),98);
__d("WebMpsGetIsMessageExpired",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e!=null&&o("WATimeUtils").cappedMillisecondsUntil(o("WATimeUtils").castMilliSecondsToUnixTime(e))<=0}l.getIsMessageExpired=e}),98);
__d("WebMpsReverbWrites",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n,r,o,a,i){var l=[o,r,n];return i(async function(i){var s,u=await i.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",l);if(!(((s=u==null?void 0:u.timestampMs)!=null?s:0)>=a)){var c={messageId:e,payload:t,supplementalKey:n,threadId:o,timestampMs:a,topLevelMessageId:r};await i.stores.supplemental.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:c,selector:l}])}})}function l(e,t,n){var r=e.messageId,o=e.threadId;return n(async function(n){var a,i=await n.stores.message.getByIndex("[threadId+messageId]",[o,r]);if(!(i!=null&&!i.isTransportErrorPlaceholder)&&!(i!=null&&i.isTransportErrorPlaceholder&&t.isTransportErrorPlaceholder)){var l=await n.stores.deleted.getByIndex("[threadId+deletedMessageId]",[e.threadId,e.messageId]),s=babelHelpers.extends({},e,{debugFlags:t.debugFlags,expiryTimestampMs:t.expiryTimestampMs,isLocalOnlyMessage:t.isLocalOnly,isTransportErrorPlaceholder:t.isTransportErrorPlaceholder,timestampMs:(a=i==null?void 0:i.timestampMs)!=null?a:e.timestampMs});if(l)l.payload=s.payload,await n.stores.deleted.bulkPut([l]),i!=null&&(i.timestampMs=e.timestampMs,await n.stores.message.bulkPut([i]));else{var u=await n.stores.message.bulkUpsert("[threadId+messageId]",[{item:s,selector:[o,r]}]),c=u[0],d=await n.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[o,r]});d.length>0&&await n.stores.tags.bulkDelete(d.map(function(e){return e.pk})),t.tags.length>0&&await n.stores.tags.bulkAdd(t.tags.map(function(e){return{messageId:s.messageId,messagePk:c,tag:e,threadId:s.threadId,timestampMs:s.timestampMs}}))}}})}i.upsertSupplementalToReverb=e,i.upsertTopLevelToReverb=l}),66);
__d("WebMpsPersistMessagesFromEb",["FBLogger","MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){if(!(t.length===0||t.every(function(e){return e.topLevelProtobufs.size===0&&e.supplementalProtobufs.size===0&&e.tags.size===0})))try{await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(n){var o=t.map(function(t){var o=t.supplementalProtobufs,a=t.tags,i=t.threadId,l=t.topLevelProtobufs;return r("FBLogger")("mps").INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Persisting EB messages thread: "," topLevelProtobufs: "," supplementalProtobufs: ",""])),i,Array.from(l.keys()).join(","),Array.from(o.keys()).join(",")),u(l,o,a,i,function(e){return e(n)})}).flat();return Promise.all(o)},"mps-persist-messages-from-eb")}catch(e){var n=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(n).mustfix("Runtime error performing persistMessagesFromEB"),n}}function u(e,t,n,r,a){var i=[];return e.forEach(function(e,t){var r;i.push(o("WebMpsReverbWrites").upsertTopLevelToReverb(e,{actionType:o("MpsTypes").ActionType.UpsertTopLevel,debugFlags:["EB"],isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:(r=n.get(t))!=null?r:[],targetMessageId:t},a))}),t.forEach(function(e,t){e.forEach(function(e,n){i.push(o("WebMpsReverbWrites").upsertSupplementalToReverb(e.messageId,e.payload,n,t,r,e.timestampMs,a))})}),i}l.persistMessagesFromEB=s}),98);
__d("WebMpsBatchLoadMessage",["CoalescingLoader","MpsLogger","QPLMultiplexedFlow","WebMpsGetDistinctMessages","WebMpsGetIsMessageExpired","WebMpsPersistMessagesFromEb","WebReverbDB","getErrorSafe","getSafeQplErrorMessage","groupBy"],(function(t,n,r,o,a,i,l){"use strict";var e=["messageId"],s=["config","ctx","messageId","threadId"],u=["pk","supplementalKey","threadId","topLevelMessageId"],c=(function(){function t(t){var n=this;this.$3=async function(t){var a=r("groupBy")(t,function(e){return n.$4(e)}),i=new Map;return await Promise.all(Object.entries(a).map(async function(t){var r=t[0],a=t[1],l=a.map(function(e){return e.ctx.metric}),s=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(l);s.addAnnotations({int:{coalesced_batch_size:a.length}});var u=a[0],c=u.messageId,d=babelHelpers.objectWithoutPropertiesLoose(u,e),m=babelHelpers.extends({},d,{ctx:{metric:s},messageIds:a.map(function(e){return e.messageId})}),p=await n.batchLoad(m);i.set(r,p)})),t.map(function(e){var t=i.get(n.$4(e));return t==null?void 0:t.find(function(t){return(t==null?void 0:t.toplevelProtobuf.messageId)===e.messageId})})},this.$1=t,this.$2=new(o("CoalescingLoader")).CoalescingLoader(this.$3)}var n=t.prototype;return n.$4=function(t){var e=t.config,n=t.ctx,r=t.messageId,o=t.threadId,a=babelHelpers.objectWithoutPropertiesLoose(t,s);return JSON.stringify({config:e,threadId:o})},n.$5=async function(t,n,a,i){try{i.metric.addPoint("load-message-from-reverb_start");var e=o("WebReverbDB").getWebReverbDB(),l=await e.runInTransaction(["message","supplemental","tags"],"readonly",function(e){return Promise.all(n.map(function(n){var r=e.stores.message.readIndex("[threadId+messageId]",[t,n],{limit:1}),o=a.shouldFetchTags?e.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[t,n]}):[],i=a.shouldFetchSupplementals?e.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[t,n]}):[];return Promise.all([n,r,i,o])}))},"mps-load-message");i.metric.addPoint("load-message-from-reverb_end");var s=new Map;return l.forEach(function(e){var t=e[0],n=e[1],r=n[0],a=e[2],i=e[3];if(r==null||o("WebMpsGetIsMessageExpired").getIsMessageExpired(r.expiryTimestampMs))return null;var l=new Map;a.forEach(function(e){var t=e.pk,n=e.supplementalKey,r=e.threadId,o=e.topLevelMessageId,a=babelHelpers.objectWithoutPropertiesLoose(e,u);l.set(n,a)});var c=i.map(function(e){var t=e.tag;return t});s.set(t,{reverbTopLevel:r,supplementalProtobufs:l,tags:c})}),s}catch(e){return i.metric.addPoint("load-message-from-reverb_fail"),o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Runtime error performing loadMessageFromReverb"),new Map}},n.$6=async function(t,n,a){try{var e=this.$1,i=e.decryptedProtobufToFullMessage,l=e.eb,s=l.isEbEnabled(),u=s===!0?"true":s===!1?"false":"unset";if(a.metric.addAnnotations({string:{ebEnabled:u}}),s!==!0)return new Map;a.metric.addPoint("load-message-from-eb_start");var c=l.messagePointQuery,d=await c({ctx:a,messageIds:n,threadId:t});if(d.success===!1)return new Map;var m=i(d.value,t);return a.metric.addPoint("load-message-from-eb_end"),new Map(m.map(function(e){return[e.toplevelProtobuf.messageId,e]}))}catch(e){a.metric.addPoint("load-message-from-eb_fail");var p=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(p).mustfix("Runtime error performing loadFromEB"),new Map}},n.batchLoad=async function(t){var e=this,n=t.config,a=t.ctx,i=t.messageIds,l=t.threadId;try{a.metric.addPoint("load-message_start");var s=function(){return e.$5(l,i,n,a)},u=function(){return e.$6(l,i,a)},c=n.strategy==="local-first"?async function(){var e=await s(),t=e.size===i.length;return t?[e,new Map]:[e,await u()]}:n.strategy==="full-fetch"?function(){return Promise.all([s(),u()])}:n.strategy==="local-only"?async function(){return[await s(),new Map]}:n.strategy==="remote-only"?async function(){return[new Map,await u()]}:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n.strategy)})(),d=await c(),m=d[0],p=d[1],_=i.map(function(e){var t=m.get(e),n=p.get(e);return o("WebMpsGetDistinctMessages").getDistinctMessages([t].filter(Boolean),[n].filter(Boolean))});return n.persistToReverb==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(_.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:l,topLevelProtobufs:r}})),a.metric.addPoint("load-message_end"),_.map(function(e){return e.messages[0]})}catch(e){var f=r("getErrorSafe")(e);throw a.metric.addPoint("load-message_fail",{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(f)}}),o("MpsLogger").MpsLogger().catching(f).mustfix("Runtime error performing loadMessage"),f}},n.load=function(t){return this.$2.gen(t)},t})();l.WebMpsPointQueryApi=c}),98);
__d("PackedMpsRange",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.packMpsRange=e}),66);
__d("WebMpsBatchLoadFromReverb",["MpsLogger","WebMpsGetIsMessageExpired","WebReverbDB","WormRangeIterator","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"];async function s(t,n,r,a,i,l,s,u,c,d,m){var p,_=r[0],f=r[1],g=u?function(e){return e.isLocalOnlyMessage===!1}:function(e){return!0},h=function(t){return!o("WebMpsGetIsMessageExpired").getIsMessageExpired(t.expiryTimestampMs)},y=function(t){return g(t)&&h(t)};function C(){var e=t.stores.message.getIndexRangeIterator("[threadId+timestampMs+messageId]",a,{greaterThanOrEqual:[n],lessThanOrEqual:[n]},y),r=f==null?[n,_]:[n,_,f];return e.read(r,i)}async function b(e){var r="[threadId+tag+timestampMs]",l=await Promise.all(Array.from(e).map(function(e){return t.stores.tags.getIndexRangeIterator(r,a,{greaterThanOrEqual:[n,e],lessThanOrEqual:[n,e]}).read([n,e,_],i)})),s=o("WormRangeIterator").mergeRanges(l,["timestampMs","messageId"],a,i),u=await Promise.all(s.data.map(function(e){return t.stores.message.getByIndex("[threadId+messageId]",[e.threadId,e.messageId],{filter:y})})).then(function(e){return e.filter(Boolean)}),c=o("WormRangeIterator").makeCursorInfoFromList(u,["threadId","timestampMs","messageId"],s.cursorInfo.hasNext,s.cursorInfo.hasPrevious);return{cursorInfo:c,data:u}}var v;c!=="all"?(d.metric.addPoint("load_messages_with_tags_"+m+"_start"),v=await b(c),d.metric.addPoint("load_messages_with_tags_"+m+"_end")):(d.metric.addPoint("load_messages_canoincal_"+m+"_start"),v=await C(),d.metric.addPoint("load_messages_canonical_"+m+"_end"));var S=v,R=S.cursorInfo,L=S.data;d.metric.addPoint("load_message_results_"+m+"_start"),d.metric.addAnnotations({bool:{shouldFetchTags:s}});var E=await Promise.all(L.map(async function(r){var o=l?await t.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[n,r.messageId]}):[],a=new Map;o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,i=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e);a.set(r,l)});var i=s?await t.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[n,r.messageId]}):[],u=i.map(function(e){var t=e.tag;return t});return{reverbTopLevel:r,supplementalProtobufs:a,tags:u}})),k=E.reduce(function(e,t){return e+t.supplementalProtobufs.size},0);return d.metric.addAnnotations({int:(p={},p["supplementalCount_"+m]=k,p)}),d.metric.addPoint("load_message_results_"+m+"_end"),{cursorInfo:{endCursor:R.endCursor!=null?[R.endCursor[1],R.endCursor[2]]:null,hasNext:R.hasNext,hasPrevious:R.hasPrevious,startCursor:R.startCursor!=null?[R.startCursor[1],R.startCursor[2]]:null},messages:E,threadId:n}}async function u(e,t,n,a,i,l){try{i.metric.addPoint("reverb_fetch_start");var u=o("WebReverbDB").getWebReverbDB(),c=new Map(await u.runInTransaction(["message","supplemental","tags"],"readonly",function(r){return Promise.all(e.map(function(e,o){return s(r,e.threadId,e.from,e.direction,e.numMessages,t,n,a,l,i,o).then(function(t){return[e,t]})}))},"mps-load-messages"));return i.metric.addPoint("reverb_fetch_end"),c}catch(e){var d=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(d).mustfix("Runtime error performing WebMpsBatchLoadFromReverb"),i.metric.addPoint("reverb_fetch_end",{bool:{reverbFail:!0}}),new Map}}l.batchLoadMessagesFromReverb=u}),98);
__d("WebMpsLoadMessagesFromEb",["MpsLogger","WAPromiseDelays","WAResultOrError","getErrorSafe","getSafeQplErrorMessage","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e={endCursor:null,hasNext:!1,hasPrevious:!1,startCursor:null};async function s(e,t,n,a,i,l){function s(){throw a.metric.addPoint("eb_fetch_timeout"),o("MpsLogger").MpsLogger().mustfixThrow("Timed out waiting for EB Fetch")}var u=e.reduce(function(e,t){return e+t.numMessages},0),c=Math.min(Math.max((u-20)/180,0),1),d=r("justknobx")._("3429")*(1+c*2),m=await o("WAPromiseDelays").withTimeout(t.messageRangeQuery({ctx:a,ranges:e,source:l,tagsFilter:i}),d,s),p=m.map(function(t,r){var a=e[r],i=a.threadId;if(t.success===!1)return t;var l=t.value,s=l.cursorInfo,u=l.messages,c=n(u,i);return o("WAResultOrError").makeResult({cursorInfo:s,messages:c,threadId:i})});return a.metric.addPoint("eb_fetch_end"),p}async function u(t,n,a,i,l){var u=n.decryptedProtobufToFullMessage,c=n.eb;try{var d=c.isEbEnabled(),m=d===!0?"true":d===!1?"false":"unset";if(a.metric.addAnnotations({string:{ebEnabled:m}}),d!==!0)return new Map(t.map(function(t){return[t,o("WAResultOrError").makeResult({cursorInfo:e,messages:[],threadId:t.threadId})]}));var p=!1;a.metric.addPoint("load-messages-from-eb_start");var _=await s(t,c,u,a,i,l),f=new Map(t.map(function(e,t){var n=_[t];return n.success===!1&&(p=!0),[e,n]}));return p&&a.metric.addAnnotations({bool:{ebFetchFailed:!0}}),a.metric.addPoint("load-messages-from-eb_end"),f}catch(e){var g=r("getErrorSafe")(e);return a.metric.addPoint("load-messages-from-eb_fail",{string:{ebFetchFailReason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}}),o("MpsLogger").MpsLogger().catching(g).mustfix("Error fetching from EB"),new Map}}l.loadMessagesFromEb=u}),98);
__d("WebMpsMergeMessageRangesFromDifferentSources",["WebMpsGetDistinctMessages","err","first","last"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function s(t,n,a,i,l){var s,u,c=o("WebMpsGetDistinctMessages").getDistinctMessages((s=n==null?void 0:n.messages)!=null?s:[],(u=t==null?void 0:t.messages)!=null?u:[]),d=c.messages,m=c.supplementalMessagesToWriteToReverb,p=c.tagsToWriteToReverb,_=c.topLevelMessagesToWriteToReverb;if(n==null||t==null){var f=n!=null?babelHelpers.extends({},n,{messages:n.messages.map(function(t){var n=t.reverbTopLevel,r=t.supplementalProtobufs,o=n.debugFlags,a=n.expiryTimestampMs,i=n.isLocalOnlyMessage,l=n.isTransportErrorPlaceholder,s=n.pk,u=babelHelpers.objectWithoutPropertiesLoose(n,e);return{expiryTimestampMs:a,supplementalProtobufs:r,tags:[],toplevelProtobuf:u}})}):t;if(f==null)throw r("err")("data-fetching-error");return{range:f,supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}var g=t,h=[].concat(d).sort(function(e,t){return a==="asc"?e.toplevelProtobuf.timestampMs-t.toplevelProtobuf.timestampMs:t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}),y=h.slice(0,i),C=r("first")(y),b=r("last")(y),v=C!=null?[C.toplevelProtobuf.timestampMs,C.toplevelProtobuf.messageId]:void 0,S=b!=null?[b.toplevelProtobuf.timestampMs,b.toplevelProtobuf.messageId]:void 0,R=S!=null?g.cursorInfo.hasNext||n.cursorInfo.hasNext:!1,L=v!=null?g.cursorInfo.hasPrevious||n.cursorInfo.hasPrevious:!1;return{range:{cursorInfo:{endCursor:S,hasNext:R,hasPrevious:L,startCursor:v},messages:y,threadId:l},supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}l.mergeMessageRangesFromDifferentSources=s}),98);
__d("WebMpsEbCache",["MpsTypes","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i){var l=o("WAJids").validateChatJid(t);if(l==null)return[];var s=e.getMetadataFromCache({chatJid:l,direction:n,numberOfMessages:r,referenceMessage:i,referenceTimestamp:a==null?null:o("WATimeUtils").castToMillisTime(a)});return s.success===!1?[]:s.value.map(function(e){var t=e.offlineThreadingId,n=e.sortOrderMs;return{offlineThreadingId:t,sortOrderMs:o("MpsTypes").toTimestamp(n)}})}function s(e,t){if(e==null||t.length===0)return"no-match";if(e.cursorInfo.hasNext!==!0)return"reverb-cursor-ended";var n=new Set(e.messages.map(function(e){return e.reverbTopLevel.messageId})),r=new Set(t.map(function(e){return e.offlineThreadingId}));if(n.size!==r.size)return"no-match";if(Array.from(n).every(function(e){return r.has(e)}))return"match";for(var o=e.messages.map(function(e){return e.reverbTopLevel.timestampMs}).sort(function(e,t){return t-e}),a=t.map(function(e){return e.sortOrderMs}).sort(function(e,t){return t-e}),i=0,l=0;l<o.length;l++){var s=o[l],u=a[i];if(s<u)return"no-match";s>u||i++}return"reverb-newer"}l.loadEBMetadataCache=e,l.compareReverbVsMetadataCache=s}),98);
__d("WebMpsValidateReverbViaCacheAndFetchFromEb",["MpsLogger","WebMpsEbCache","WebMpsLoadMessagesFromEb"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n,r,a){var i=await t;if(a!=="all")return r.metric.addAnnotations({string:{ebMetadataCache:"skip"}}),{eb:await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(e,n,r,a),reverb:i};var l=e.filter(function(e){var t=e.direction,a=e.from,l=e.numMessages,s=e.threadId,u=o("WebMpsEbCache").loadEBMetadataCache(n.eb,s,t,l,a[0],a[1]),c=o("WebMpsEbCache").compareReverbVsMetadataCache(i.get(e),u);return r.metric.addAnnotations({string:{ebMetadataCache:c}}),o("MpsLogger").MpsLogger().debug("MPS Range query metadata comparison: ",c),!(c==="match"||t==="desc"&&c==="reverb-newer")});return l.length===0?{eb:new Map,reverb:i}:{eb:await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(l,n,r,a),reverb:i}}l.validateReverbViaCacheAndFetchFromEb=e}),98);
__d("WebMpsBatchLoadMessages",["MpsLogger","PackedMpsRange","WebMpsBatchLoadFromReverb","WebMpsLoadMessagesFromEb","WebMpsMergeMessageRangesFromDifferentSources","WebMpsPersistMessagesFromEb","WebMpsValidateReverbViaCacheAndFetchFromEb","err","getErrorSafe","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n,a){var i=n.persistToReverb,l=n.shouldFetchSupplementals,s=n.shouldFetchTags,u=n.shouldIgnoreLocalOnly,c=n.source,d=n.strategy,m=n.tagsFilter,p=e.map(function(e){return o("PackedMpsRange").packMpsRange(e)});try{a.metric.addPoint("mps_fetch_start");var _=function(){return o("WebMpsBatchLoadFromReverb").batchLoadMessagesFromReverb(p,l,s,u,a,m)},f,g;switch(d){case"full-fetch":{var h=await o("WebMpsValidateReverbViaCacheAndFetchFromEb").validateReverbViaCacheAndFetchFromEb(p,_(),t,a,m);f=h.reverb,g=h.eb;break}case"local-only":f=await _(),g=new Map;break;case"remote-only":g=await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(p,t,a,m,c),f=new Map;break;default:throw r("err")("empty strategy")}var y=p.map(function(e){var t,n=e.direction,r=e.numMessages,a=e.threadId,i=f.get(e),l=(t=g.get(e))==null?void 0:t.value;if(!(i==null&&l==null)){var s=o("WebMpsMergeMessageRangesFromDifferentSources").mergeMessageRangesFromDifferentSources(l,i,n,r,a),u=s.range,c=s.supplementalMessagesToWriteToReverb,d=s.tagsToWriteToReverb,m=s.topLevelMessagesToWriteToReverb;return{range:u,supplementalMessagesToWriteToReverb:c,tagsToWriteToReverb:d,threadId:a,topLevelMessagesToWriteToReverb:m}}}).filter(Boolean);return i==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(y.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.threadId,o=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:r,topLevelProtobufs:o}})),y.map(function(e){var t=e.range;return t})}catch(e){var C=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(C).mustfix("Runtime error performing loadMessages"),a.metric.addAnnotations({string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(C)}}),C}}l.batchLoadMessages=e}),98);
__d("MAWMpsCleanersContants",["DateConsts"],(function(t,n,r,o,a,i,l){"use strict";var e=30*o("DateConsts").MS_PER_DAY,s=6*o("DateConsts").MS_PER_HOUR;l.PURGE_DELETED_MESSAGES_WINDOW_IN_MS=e,l.REPORTING_WINDOW_IN_MS=s}),98);
__d("WebMpsInsertionCleaners",["MAWMpsCleanersContants","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsTypes","WATimeUtils","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){try{await Promise.all(e.map(s)),await Promise.all(e.map(c))}catch(e){var t=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(t).mustfix("Failed to run side effects")}}function s(e){return e.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevel||e.directive.actionType===o("MpsTypes").ActionType.DeleteSupplemental||e.directive.actionType===o("MpsTypes").ActionType.DeleteThread?u(e.message.timestampMs):e.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel||e.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental||e.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder||e.directive.actionType===o("MpsTypes").ActionType.Noop?Promise.resolve():e.directive.actionType===o("MpsTypes").ActionType.Unknown||e.directive.actionType===o("MpsTypes").ActionType.Preprocess?Promise.reject(r("err")("this should not happen")):(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e.directive.actionType)})()}function u(e){var t=o("WATimeUtils").castToUnixTime(Math.ceil((e+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)/1e3));return o("MpsDeletedCleaner").addNewMpsDeletedTimestamp(t),Promise.resolve()}function c(e){var t,n=(t=e.directive)==null?void 0:t.expiryTimestampMs;if(n==null)return Promise.resolve();var r=o("WATimeUtils").castToUnixTime(Math.ceil(n/1e3));return o("MpsEphemeralCleaner").addNewMpsEphemeralTimestamp(r),Promise.resolve()}l.scheduleCleaners=e}),98);
__d("WebMpsInsertionFlow",["MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","err","getErrorSafe","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){try{return await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",async function(t){for(var n of e)await u(n,function(e){return e(t)})},"mps-insertion-flow-shared"),new Map}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Failed to persist messages")}return s(e)}async function s(e){var t=new Map,n=async function(n){await u(n,function(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(t){return e(t)},"mps-insertion-flow-separate")}).catch(function(e){t.set(n.message.messageId,e)})};for(var r of e)await n(r);return t}function u(e,t){switch(e.directive.actionType){case o("MpsTypes").ActionType.UpsertTopLevel:return c(e,t);case o("MpsTypes").ActionType.UpsertSupplemental:return d(e,t);case o("MpsTypes").ActionType.DeleteTopLevel:return m(e,t);case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return p(e,t);case o("MpsTypes").ActionType.DeleteSupplemental:return _(e,t);case o("MpsTypes").ActionType.DeleteThread:return f(e,t);case o("MpsTypes").ActionType.Noop:return Promise.resolve();case o("MpsTypes").ActionType.Unknown:case o("MpsTypes").ActionType.Preprocess:return Promise.reject(r("err")("this should not happen"))}}async function c(e,t){var n=e.directive,r=e.message;await o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}async function d(e,t){var n=e.directive,a=e.message,i=r("nullthrows")(n.supplementalKey);await o("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,i,n.targetMessageId,a.threadId,a.timestampMs,t)}function m(e,t){var n=e.message,r=e.directive.targetMessageId,o=[n.threadId,r];return t(async function(e){var t,a=await e.stores.message.getByIndex("[threadId+messageId]",o),i=await e.stores.deleted.getByIndex("[threadId+deletedMessageId]",o);if(!(((t=i==null?void 0:i.deletionTimestampMs)!=null?t:0)>=n.timestampMs)){var l={deletedMessageId:r,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:!1,payload:a==null?void 0:a.payload,threadId:n.threadId,timestampMs:a==null?void 0:a.timestampMs};await e.stores.deleted.bulkUpsert("[threadId+deletedMessageId]",[{item:l,selector:o}]),a&&await e.stores.message.bulkDelete([a.pk])}})}function p(e,t){var n=e.directive,r=e.message;return o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}function _(e,t){var n=e.message,o=r("nullthrows")(e.directive.supplementalKey),a=e.directive.targetMessageId,i=[n.threadId,a,o];return t(async function(t){var r=await t.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",i);if(r!=null){var l=await t.stores.deleted.getByIndex("[threadId+topLevelMessageId+supplementalKey]",i,{filter:function(t){return t.deletionTimestampMs>=n.timestampMs}});if(!l){var s={deletedMessageId:r.messageId,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:e.directive.isLocalOnly,payload:r.payload,supplementalKey:o,threadId:n.threadId,timestampMs:r.timestampMs,topLevelMessageId:a};await t.stores.deleted.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:s,selector:i}]),await t.stores.supplemental.bulkDelete([r.pk])}}})}function f(e,t){var n=e.message;return t(async function(e){var t=await e.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[n.threadId]});await e.stores.supplemental.bulkDelete(t);var r=await e.stores.message.readIndexRange("[threadId+messageId]",{only:[n.threadId]});await e.stores.message.bulkDelete(r.map(function(e){return e.pk}));var o=await e.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:[n.threadId]});await e.stores.tags.bulkDelete(o);var a=await e.stores.deleted.readKeysByIndexRange("[threadId+deletedMessageId]",{only:[n.threadId]});await e.stores.deleted.bulkDelete(a),await e.stores.deleted.bulkAdd(r.map(function(e){return{deletedMessageId:e.messageId,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:e.isLocalOnlyMessage,payload:e.payload,threadId:e.threadId,timestampMs:e.timestampMs}}))})}l.persistNewMessages=e}),98);
__d("WebMpsLoadDeletedMessages",["MpsTypes","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"];async function s(t,n){var r=o("WebReverbDB").getWebReverbDB(),a=await r.runInTransaction(["deleted","supplemental"],"readonly",async function(n){var r=await n.stores.deleted.readIndexRange("[threadId+timestampMs+deletedMessageId]",{lessThanOrEqual:[t.threadId,o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER)]},{limit:t.numMessages});return Promise.all(r.map(async function(r){var o=await n.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[t.threadId,r.deletedMessageId]}),a=new Map;return o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,i=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e);a.set(r,l)}),{deletedEntity:r,supplementalProtobufs:a}}))},"get-deleted-messages-for-spam-report"),i=a.map(function(e){if(e.deletedEntity.payload!=null){var r=e.deletedEntity.payload;if(e.deletedEntity.timestampMs!=null){var o=e.deletedEntity.timestampMs;return n([{otid:e.deletedEntity.deletedMessageId,supplementalProtobufs:new Map(e.supplementalProtobufs.entries().map(function(e){var t=e[0],n=e[1];return[t,{decryptedProtobuf:n.payload,protobufTimestampMS:n.timestampMs}]})),tags:[],toplevelProtobuf:{decryptedProtobuf:r,protobufTimestampMS:o}}],t.threadId)[0]}}}).filter(Boolean);return{messages:i,tombstones:new Set(a.map(function(e){return e.deletedEntity.deletionMessageId}))}}l.loadDeletedMessages=s}),98);
__d("WebMpsPostprocess",["MpsLogger","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n){await Promise.all(t.map(async function(t){var r=t.process(e,n),a=r instanceof Promise?await r.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):r;a!=null&&a.size>0&&a.forEach(function(e,t){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessor fails %s",t)})})).catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessors runtime failure")})}async function s(e,t,n){var r=new Map,a=async function(a){n.messageToQpl.all(e.map(function(e){return e.message.messageId})).addPoint(a.name+"_start");var t=a.process(e,n),i=t instanceof Promise?await t.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):t;i!=null&&i.size>0&&i.forEach(function(e,t){r.set(t,e),o("MpsLogger").MpsLogger().catching(e).mustfix("Critical postprocessor fails %s",t),n.messageToQpl.endFail(t,a.name.toLowerCase()+"-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e))}),n.messageToQpl.all(e.map(function(e){return e.message.messageId})).addPoint(a.name+"_end")};for(var i of t)await a(i);return r}l.runNonCriticalPostprocessor=e,l.runCriticalPostprocessor=s}),98);
__d("WebMpsPurgeDeletedPayload",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(t){var n=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),r=await t.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[n]}),a=r.filter(function(e){return e.payload!=null});return e.metric.addAnnotations({int:{num_deletions:a.length}}),await t.stores.deleted.bulkPut(a.map(function(e){return babelHelpers.extends({},e,{payload:null,timestampMs:null})})),a.length},"web-mps-purge-deletions")}function s(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted"],"readonly",async function(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),n=await e.stores.deleted.readIndexRange("deletionTimestampMs",{greaterThan:[t]},{order:"asc"}),r=n.filter(function(e){return e.payload!=null});if(!(r.length===0||r[0].deletionTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(r[0].deletionTimestampMs+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)},"web-mps-next-deletion-timestamp-ms")}catch(e){throw e}}l.purgeDeletedPayload=e,l.getNextDeletionTimestampMs=s}),98);
__d("WebMpsPurgeDeletions",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(t){var n=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").PURGE_DELETED_MESSAGES_WINDOW_IN_MS),r=await t.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[n]}),a=r.map(function(e){return[e.threadId,e.deletedMessageId]});e.metric.addAnnotations({int:{num_deletions:r.length}});var i=Promise.all(a.map(function(e){return t.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return t.stores.supplemental.bulkDelete(e)}),l=Promise.all(a.map(function(e){return t.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return t.stores.tags.bulkDelete(e)}),s=t.stores.deleted.bulkDelete(r.map(function(e){return e.pk}));return await Promise.all([i,l,s]),r.length},"web-mps-purge-deletions")}l.purgeDeletions=e}),98);
__d("WebMpsScheduler",["WorkerScheduler","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){if(e==null){var t;e=o("WorkerScheduler").makeScheduler("MPS",{concurrency:(t=r("justknobx"))._("4338"),defaultSamplingRate:t._("4540"),maxTaskLimit:t._("4338"),maxThrottleMs:t._("4339"),timeoutMs:t._("4337")})}return e}l.mpsScheduler=s}),98);
__d("WmiMultiQplTracker",["QPLMultiplexedFlow"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map,s=(function(){function e(e){var t=this;this.$1=new Map,e.forEach(function(e){t.$1.set(e[0],e[1])})}e.from=function(n){return new e(n)};var t=e.prototype;return t.addAnnotations=function(t,n){var e;(e=this.$1.get(t))==null||e.addAnnotations(n)},t.addPoint=function(t,n,r){var e;(e=this.$1.get(t))==null||e.addPoint(n,r)},t.endSuccess=function(t){var e=this.$1.get(t);e!=null&&(e.endSuccess(),this.$1.delete(t),this.$2=null)},t.endFail=function(t,n,r){var e=this.$1.get(t);e!=null&&(e.endFail(n,{string:{errorDescription:r}}),this.$1.delete(t),this.$2=null)},t.size=function(){return this.$1.size},t.all=function(t){var e=this;if(t!=null){var n=t.map(function(t){return e.$1.get(t)}).filter(Boolean);return o("QPLMultiplexedFlow").makeQplMultiplexedFlow(n)}if(!this.$2){var r=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(Array.from(this.$1.values()));return this.$2=r,r}return this.$2},t.failAllPending=function(t){this.$1.forEach(function(e){return e.endFail(t)}),this.$1.clear(),this.$2=null},e.empty_TEST_ONLY=function(){return new e([])},e})();function u(t,n){e.set(t,n)}function c(t){return e.get(t)}l.WmiMultiQplTracker=s,l.trackQplForSeqId=u,l.getQplForSeqId=c}),98);
__d("schedulePeriodicTask",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=async function(){try{await e()}finally{globalThis.setTimeout(n,t)}};globalThis.setTimeout(n,0)}i.schedulePeriodicTask=e}),66);
__d("WebMps",["DateConsts","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsReverbDbDump","MpsReverbInit","MpsTypes","QPLFlow","WAPromiseQueue","WAResultOrError","WATimeUtils","WAWaitForUserUnblocked","WebMpsBatchLoadMessage","WebMpsBatchLoadMessages","WebMpsInsertionCleaners","WebMpsInsertionFlow","WebMpsLoadDeletedMessages","WebMpsPostprocess","WebMpsPurgeDeletedPayload","WebMpsPurgeDeletions","WebMpsPurgeExpiredMessages","WebMpsScheduler","WmiMultiQplTracker","WorkerScheduler","err","getErrorSafe","getSafeQplErrorMessage","justknobx","memoizeWithArgsLFUCache","mergeMaps","qpl","schedulePeriodicTask"],(function(t,n,r,o,a,i,l){"use strict";var e=["debug"],s=["config"],u=["debug"],c;function d(e){return JSON.stringify(e)}async function m(e){var t=e.db,n=e.dependencies,a=e.getMpsExtensionConfiguration;if(c!=null)throw r("err")("MPS already initialised");await o("MpsReverbInit").initReverb(t);var i=new p(a(),n);return c=i,i}var p=(function(){function t(t,n){var a=this;this.$3=[],this.$6=new(o("WAPromiseQueue")).PromiseQueue,this.batchLoadMessage=function(e){var t,n,i,l,s=e.config,u=e.debug,c=e.messageIds,d=e.threadId,m={persistToReverb:(t=s==null?void 0:s.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=s==null?void 0:s.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=s==null?void 0:s.shouldFetchTags)!=null?i:!0,strategy:(l=s==null?void 0:s.strategy)!=null?l:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:u.purpose,strategy:m.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return a.$2.batchLoad({config:m,ctx:t,messageIds:c,threadId:d})},name:"batch-load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY}).then(function(e){return a.$10(e.filter(Boolean),m),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in batchLoadMessage"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$11=r("memoizeWithArgsLFUCache")(function(e){var t,n,i,l,s=e.config,u=e.debug,c=e.messageId,d=e.threadId,m={persistToReverb:(t=s==null?void 0:s.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=s==null?void 0:s.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=s==null?void 0:s.shouldFetchTags)!=null?i:!0,strategy:(l=s==null?void 0:s.strategy)!=null?l:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:u.purpose,strategy:m.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4536"),fn:async function(t){var e=await a.$2.load({config:m,ctx:t,messageId:c,threadId:d});return e!=null&&a.$10([e],m),e},name:"load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY})},function(t){var n=t.debug,r=babelHelpers.objectWithoutPropertiesLoose(t,e);return d(babelHelpers.extends({},r,{ebEnabled:a.$1.eb.isEbEnabled()}))},1,function(e){a.$3.push(e)}),this.loadMessage=function(e){return a.$11(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){a.$7();var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in loadMessage"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$12=function(e){var t,n,i=e.config,l=e.debug,s=e.ranges;return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:l.purpose,strategy:(t=i==null?void 0:i.strategy)!=null?t:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages(s.map(function(e){var t=e.direction,n=e.from,r=e.numMessages,a=e.threadId;return{direction:t,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(n[0])),n[1]],numMessages:r,threadId:a}}),a.$1,i,t)},name:"batch-load-messages",priority:(n=i.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY})},this.batchLoadMessages=function(e){var t,n,i,l,u,c,d,m=e.config,p=babelHelpers.objectWithoutPropertiesLoose(e,s),_={persistToReverb:(t=m==null?void 0:m.persistToReverb)!=null?t:"persist",priority:(n=m==null?void 0:m.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY,shouldFetchSupplementals:(i=m==null?void 0:m.shouldFetchSupplementals)!=null?i:!0,shouldFetchTags:(l=m==null?void 0:m.shouldFetchTags)!=null?l:!0,shouldIgnoreLocalOnly:(u=m==null?void 0:m.shouldIgnoreLocalOnly)!=null?u:!1,strategy:(c=m==null?void 0:m.strategy)!=null?c:"full-fetch",tagsFilter:(d=m==null?void 0:m.tagsFilter)!=null?d:"all"};return a.$12(babelHelpers.extends({},p,{config:_})).then(function(e){var t=e.flatMap(function(e){return e.messages});return a.$10(t,_),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in batchLoadMessages"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$13=r("memoizeWithArgsLFUCache")(function(e){var t,n,i,l,s,u,c,d=e.config,m=e.debug,p=e.direction,_=e.from,f=e.numMessages,g=e.source,h=e.threadId,y={persistToReverb:(t=d==null?void 0:d.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=d==null?void 0:d.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=d==null?void 0:d.shouldFetchTags)!=null?i:!0,shouldIgnoreLocalOnly:(l=d==null?void 0:d.shouldIgnoreLocalOnly)!=null?l:!1,source:g,strategy:(s=d==null?void 0:d.strategy)!=null?s:"full-fetch",tagsFilter:(u=d==null?void 0:d.tagsFilter)!=null?u:"all"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:m.purpose,strategy:y.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages([{direction:p,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(_[0])),_[1]],numMessages:f,threadId:h}],a.$1,y,t).then(function(e){e.length>1&&o("MpsLogger").MpsLogger().mustfix("loadMessages returned more than one range");var t=e.at(0);if(t==null)throw r("err")("loadMessages returned no result. Likely this is the result of both reverb and EB queries failing");return a.$10(t.messages,y),t})},name:"load-messages",priority:(c=d==null?void 0:d.priority)!=null?c:o("WorkerScheduler").BLOCKING_PRIORITY})},function(e){var t,n=e.debug,r=babelHelpers.objectWithoutPropertiesLoose(e,u);return d(babelHelpers.extends({},r,{config:babelHelpers.extends({},r.config,{tagsFilter:(function(e){if(e==="all"||e===void 0)return"all";{var t=e;return Array.from(t.values())}})((t=r.config)==null?void 0:t.tagsFilter)}),ebEnabled:a.$1.eb.isEbEnabled()}))},10/60,function(e){a.$3.push(e)}),this.loadMessages=function(e){return a.$13(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){a.$7();var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in loadMessages"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.extensionConfiguration=t,this.$1=n,this.$2=new(o("WebMpsBatchLoadMessage")).WebMpsPointQueryApi(n),this.$4(),this.$5(function(e){return n.generateDeletionMessage(e)})}var n=t.prototype;return n.saveNewMessages=function(t,n){var e=this,a=o("WebMpsScheduler").mpsScheduler().task({annotations:{string:{source:n.source}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4535"),fn:async function(){e.$7();var n={messageToQpl:o("WmiMultiQplTracker").WmiMultiQplTracker.from(t.map(function(e){return[e.message.messageId,o("QPLFlow").startQPLFlow(r("qpl")._(1056834650,"494"),{annotations:{string:{messageId:e.message.messageId,senderId:e.message.senderId,threadId:e.message.threadId}}})]}))};n.messageToQpl.all(t.map(function(e){return e.message.messageId})).addPoint("preprocess_start");var a=await e.extensionConfiguration.preprocessors.run({ctx:n,payloadList:t}),i=a.errors,l=a.payloadList;n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("preprocess_end"),i.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"preprocess-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_start"),await o("WebMpsInsertionCleaners").scheduleCleaners(l),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_end"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_start");var s=await o("WebMpsInsertionFlow").persistNewMessages(l);n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_end"),s.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"persist-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persisted"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_start");var u=await e.$8(l,n);return n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_end"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_start"),e.$9(l,n),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_end"),l.forEach(function(e){n.messageToQpl.endSuccess(e.message.messageId)}),r("mergeMaps")(i,s,u)},name:"save-new-messages",priority:o("WorkerScheduler").BLOCKING_PRIORITY});return this.$6.enqueue(function(){return a.run()})},n.$9=function(t,n){o("WebMpsPostprocess").runNonCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.nonCritical,n).catch(function(e){var t=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(t).mustfix("Non-critical postprocessor failed with runtime error")})},n.$8=function(t,n){return o("WebMpsPostprocess").runCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.critical,n).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Critical postprocessor failed with runtime error"),new Map})},n.purgeDeletions=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletions").purgeDeletions,name:"purge-deletions",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletions"),0}},n.purgeDeletedPayload=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").purgeDeletedPayload,name:"purge-deleted-payload",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletedPayload"),0}},n.getNextDeletionTimestampMs=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").getNextDeletionTimestampMs,name:"get-next-deletion-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextDeletionTimestampMs")}},n.purgeExpiredMessages=async function(t){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:function(n){return o("WebMpsPurgeExpiredMessages").purgeExpiredMessages(t,n)},name:"purge-expired-messages",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeExpiredMessages"),0}},n.getNextExpiryTimestampMs=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:o("WebMpsPurgeExpiredMessages").getNextExpiryTimestampMs,name:"get-next-expire-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextExpiryTimestampMs")}},n.debugDbDump=function(){return o("MpsReverbDbDump").debugGetReverbDbDump()},n.spamReportLoadMessages=function(t){var e=this;return o("WebMpsScheduler").mpsScheduler().runTask({fn:async function(){var n=await Promise.all([e.$13({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!0,shouldFetchTags:!1,shouldIgnoreLocalOnly:!1,strategy:"local-only",tagsFilter:"all"},debug:{purpose:"get-latest-msgs-for-spam-report"},direction:"desc",from:[o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),null],numMessages:t.numMessages,threadId:t.threadId}),o("WebMpsLoadDeletedMessages").loadDeletedMessages(t,e.$1.decryptedProtobufToFullMessage)]),r=n[0],a=n[1],i=r.messages.filter(function(e){return!a.tombstones.has(e.toplevelProtobuf.messageId)});return[].concat(i,a.messages).toSorted(function(e,t){return t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}).slice(0,t.numMessages)},name:"get-latest-msgs-for-spam-report"})},n.$7=function(){this.$3.forEach(function(e){return e()})},n.$10=function(t,n){var e=this.extensionConfiguration.readSideEffects;if(!(e==null||t.length===0))try{e(t,n)}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("readSideEffects failed")}},n.$4=function(){var e=this;o("schedulePeriodicTask").schedulePeriodicTask(function(){return e.purgeDeletions()},o("DateConsts").MS_PER_MIN*20)},n.$5=function(t){var e=this;o("MpsEphemeralCleaner").startMpsEphemeralCleaner({getNextTs:function(){return e.getNextExpiryTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeExpiredMessages(t)}}),o("MpsDeletedCleaner").startMpsDeletedCleaner({getNextTs:function(){return e.getNextDeletionTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeDeletedPayload()}})},t})();function _(){if(c==null)throw r("err")("MPS not initialised");return c}function f(){c=void 0}l.makeMps=m,l.mps=_,l.resetMps_TEST_ONLY=f}),98);
__d("WebMpsPurgeExpiredMessages",["MpsTypes","WATimeUtils","WebMps","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk","timestampMs"];async function s(t,n){var r=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),a=await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","deleted"],"readonly",async function(e){var t=await e.stores.message.readIndexRange("expiryTimestampMs",{lessThanOrEqual:[r]});return n.metric.addAnnotations({int:{num_expired_messages:t.length}}),t},"web-mps-purge-deletions");if(a.length===0)return 0;var i=a.map(function(n){var a=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=n.timestampMs,d=babelHelpers.objectWithoutPropertiesLoose(n,e);return{directive:null,insertionSource:o("MpsTypes").InsertionSource.Send,message:t(babelHelpers.extends({},d,{timestampMs:r}))}});return await o("WebMps").mps().saveNewMessages(i,{source:"purge-expired-messages"}),a.length}function u(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["message"],"readonly",async function(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),n=await e.stores.message.readIndexRange("expiryTimestampMs",{greaterThan:[t]},{limit:1,order:"asc"});if(!(n.length===0||n[0].expiryTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(n[0].expiryTimestampMs)},"web-mps-next-expiry-timestamp-ms")}catch(e){throw e}}l.purgeExpiredMessages=s,l.getNextExpiryTimestampMs=u}),98);
__d("MAWBridgeEventTransmitter",["EBAPI","EBLogger","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWJobDefinitions","MAWUploadThreadTxns","MpsTypes","WAJids","WALogger","WATimeUtils","WebMps"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n,a){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Issuing point query for message: ",""])),t),r("EBAPI").isEBEnabled()!==!1&&o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"full-fetch"},debug:{purpose:"issuePointQueryOutsideTxn"},messageId:o("MpsTypes").toMessageId(t),threadId:o("MpsTypes").toThreadId(a)}).then(function(e){var t=e.value;t!=null&&o("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:a,decryptedMessagesProtobufs:[o("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage(t)],isPointQuery:!0,taskSource:(s||(s=o("LSIntEnum"))).ofNumber(n!=null?n:r("LSMEBTaskCreationSource").UNKNOWN)}}]}).catch(function(e){return o("EBLogger").EBLogger().tags(["eventTransmitter","mps"]).catching(e).warn("failure while executing UI update")})})}function c(e,t){o("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:o("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(o("WAJids").threadIdForChatJid(e.jid),o("MAWUploadThreadTxns").getFolderTypeAsText(e.folder),"AdvancedCrypto",t!=null?t:o("WATimeUtils").castToMillisTime(1),null,2)})}function d(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(e,t,n)}]})}function m(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e,folder:t,threadJid:n})}]})}l.issuePointQueryOutsideTxn=u,l.deleteMessagesOfThreadAfterTxn=c,l.startTraceOutsideTxn=d,l.updateThreadOutsideTxn=m}),98);
__d("MAWQuotedMsgUtils",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.content.type==="NoteReply"?e.content.msgContent==null?e:babelHelpers.extends({},e,{content:babelHelpers.extends({},e.content,{msgContent:void 0})}):e}function s(t){return t.content.expirationTs==null||t.content.expirationTs>o("WATimeUtils").unixTime()?t:e(t)}l.dbQuotedMsgWithoutExpirableContent=e,l.dbQuotedMsgWithoutExpiredContent=s}),98);
__d("MAWGetMsgQuoteTxn",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWQuotedMsgUtils","MAWTransactionMode","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return t==null||t===o("WAJids").AUTHOR_SYSTEM?null:o("WAJids").authorAsUserJid(t)};function s(t,n,a,i){var l=n.quote,s=(l==null?void 0:l.content)||{},u=s.author,c=s.externalId;if(u==null)return o("MAWDexieTable").dexieResolve(null);var d=o("WAJids").isAuthorMe(u)?o("WAJids").AUTHOR_ME:e(u);if(l==null||d==null||c==null)return o("MAWDexieTable").dexieResolve(null);var m={author:d,chat:a,externalId:c};if(l.content.type==="NoteReply")return o("MAWDexieTable").dexieResolve({quote:o("MAWQuotedMsgUtils").dbQuotedMsgWithoutExpiredContent(l),quoteExternalId:l.content.externalId});var p=i!=null&&i==="ebrestore"?r("LSMEBTaskCreationSource").EB_POINT_QUERY_RESTORE_PROTOBUF:r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT;return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,m).then(function(e){if(o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(m.externalId,p,m.chat),e==null||!o("MAWMsgType").isQuotedMsgType(e.type))return{quote:l,quoteExternalId:l.content.externalId};o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(e,null,!0)});var t=e.author,n=e.externalId,r=e.mediaId,a=e.msgContent,i=e.msgId,s=e.plaintextHash,u=e.specialTextSize,c=e.ts,d=e.type,_=e.xmaMessageType,f={author:t,externalId:n,mediaId:r,msgContent:a,msgId:i,plaintextHash:s,specialTextSize:u,ts:c,type:d,xmaMessageType:_};return e.messageExpirationTs!=null&&e.messageExpirationTs<o("WATimeUtils").unixTime()&&(f=babelHelpers.extends({},f,{mediaId:void 0,msgContent:void 0,type:o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})),{quote:babelHelpers.extends({},l,{content:f}),quoteExternalId:e.externalId}})}function u(e,t,n){return s(e,t,n).then(function(e){return babelHelpers.extends({},t,{quote:e==null?void 0:e.quote,quoteExpirationTs:e==null?void 0:e.quote.content.expirationTs,quoteExternalId:e==null?void 0:e.quoteExternalId})})}function c(e,t){return e.messages.where("quoteExternalId").anyOf(t).toArray()}var d=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"maybeBatchGetMsgsByQuoteExternalId",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return c.apply(void 0,[e].concat(n))})});l.getMsgQuoteInfo=s,l.enhanceMsgWithQuoteInfo=u,l.maybeBatchGetMsgsByQuoteExternalId=c,l.maybeBatchGetMsgsByQuoteExternalIdWithTransaction=d}),98);
__d("MAWThreadEventConst",[],(function(t,n,r,o,a,i){"use strict";var e="placeholderConvertSubscription";i.PLACEHOLDER_CONVERT_SUBSCRIPTION=e}),66);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,r,a,i,l,s){var e=o("MAWAuthor").getAuthorUserJid(a);return t.messages.where("quoteExternalId").equals(r).toArray().then(function(r){if(r.length!==0){var a=r;(s==null||!s)&&(a=r.filter(function(t){var r=t.quote,a=t.threadJid;return o("MAWAuthor").getAuthorUserJid(r==null?void 0:r.content.author)===e&&a===n}));var u=a.map(function(e){var t,n=Object.assign({},(t=e.quote)==null?void 0:t.content,i.content),r=babelHelpers.extends({},e.quote,i,{content:n});return r.content.msgId==null&&l!=null&&(r.content.msgId=l),babelHelpers.extends({},e,{quote:r})});return t.messages.bulkPut(u).then(function(){return u})}})},s=function(n,r,a,i,l){l===void 0&&(l=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var t={content:{mediaId:void 0,msgContent:void 0,type:l}};return e(n,r,a,i,t).then(function(e){e!=null&&e.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})},u=function(t,n,r){r===void 0&&(r=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=n.author,a=n.chat,i=n.externalId;return t.threads.get({jid:a}).then(function(n){if(n!=null)return s(t,n.jid,i,e,r)})},c=function(n,r,a,i){var t=a.author,l=a.externalId,s=a.mediaId,u=a.msgContent,c=a.msgId,d=a.plaintextHash,m=a.ts,p=a.type;if(o("WAJids").isAuthorSystem(t))return o("MAWDexieTable").dexieResolve();var _={author:t,chat:r,externalId:l};if(!o("MAWMsgType").isQuotedMsgType(p))return o("MAWDexieTable").dexieResolve();var f=o("MAWDexieTable").dexieResolve(null);return a.type===o("MAWMsgType").MSG_TYPE.XMA&&(f=o("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(n,_).then(function(e){return e.success===!1?o("MAWDexieTable").dexieResolve(null):o("MAWDexieTable").dexieResolve(e.value)})),f.then(function(o){var a,_,f,g,h,y={author:t,externalId:l,mediaId:(a=o==null||(_=o.defaultPreview)==null?void 0:_.mediaId)!=null?a:s,msgContent:u,plaintextHash:(f=o==null||(g=o.defaultPreview)==null?void 0:g.plaintextHash)!=null?f:d,ts:m,type:p,xmaMessageType:o==null||(h=o.xma)==null?void 0:h.targetType};return e(n,r,l,t,{content:y},c,i)})};function d(e,t,n){return o("MAWDexieTable").dexieAll([c(e,n,t),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)]).then(function(n){var r=n[0],a=n[1];return r!=null?o("MAWDexieTable").dexieResolve(m(t,a)).then(function(){o("MAWDexieTable").dexieAll(r.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){return m(t,e),t})}))}):o("MAWDexieTable").dexieResolve([])})}function m(e,t){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,t)})}l.disassociateQuotedMsg=s,l.disassociateQuotedMessageByProtocolMsgId=u,l.associateQuotedMessage=c,l.associateAllReplies=d,l.issueReplyMsgUpdate=m}),98);
__d("MAWUseProtocolMsgIdForMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(){return!0}i.shouldUseProtocolMsgIdForMsgId=e}),66);
__d("MAWBridgeParticipants",["MAWBridgeParticipantsUpdatedHandler","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.deliveredWatermarkTs,n=e.threadJid,r=e.type,a=e.userJid;return babelHelpers.extends({deliveredWatermarkTs:t||o("WATimeUtils").castToUnixTime(0),fbid:o("WAJids").extractUserId(a)},o("MAWBridgeParticipantsUpdatedHandler").mawToLsParticipantTypeConversion(r),{lastReadActionTs:o("WATimeUtils").castToUnixTime(0),readWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n})}function s(t){return{participants:t.map(function(t){return e(t)})}}l.createBridgeParticipant=e,l.createBridgeParticipants=s}),98);
__d("MAWDbParticipantTxns",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWUserJidWrapper","MWFBLogger","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t,n,r){return r===void 0&&(r=!0),p(e,n.map(function(e){return babelHelpers.extends({},e,{chatJid:t})}),r)}function d(e,t){o("WAJids").switchOnMsgrChatJidType(e.threadJid,{group:r("emptyFunction"),user:function(r){e.userJid!==r&&e.userJid!==o("MAWUserJidWrapper").getMyUserJid()&&o("MWFBLogger").MWLogger().tags(["db","txn"]).mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",t)}})}function m(e){var t=e.addressable,n=e.chatJid,r=e.type,a=e.userJid;return{addressable:t,deliveredWatermarkTs:o("WATimeUtils").castToUnixTime(0),id:o("MAWDbParticipant").craftParticipantId(n,a),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n,type:r!=null?r:"participant",userJid:a}}function p(e,t,n){if(n===void 0&&(n=!0),t.length===0)return o("MAWDexieTable").dexieResolve([]);var r=t.map(function(e){return m(e)});return r.forEach(function(e){return d(e,"bulkAddParticipantsInThreads")}),e.participants.bulkPut(r).then(function(){return n&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(r)}),r})}function _(e,t,n,r){r===void 0&&(r=!0);var a=new Set([t,o("MAWUserJidWrapper").getMyUserJid()]),i=n.filter(function(e){var t=e.userJid;return!a.has(t)}).map(function(e){var t=e.threadJid,n=e.userJid;return[t,n]});return i.length>0&&o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:o("MAWCurrentUser").isEmployee()?"employee":"public"}),b(e,i,r)}function f(e,t,n,r){r===void 0&&(r=!0);var a=Array.from(new Set([t,o("MAWUserJidWrapper").getMyUserJid()])),i=new Set(n.map(function(e){return e.userJid})),l=a.filter(function(e){return!i.has(e)}),s=l.map(function(e){return{type:"participant",userJid:e}});return c(e,t,s,r).then(function(e){var t=a.reduce(function(t,r){var o=e.find(function(e){return e.userJid===r}),a=n.find(function(e){return e.userJid===r});return o!=null&&a==null?t.push(o):a!=null&&t.push(a),t},[]);return t})}function g(e,t,n){return n===void 0&&(n=!0),L(e,t).then(function(r){return _(e,t,r,n).then(function(o){return f(e,t,r,n)})})}function h(e,t){return t.forEach(function(e){return d(e,"bulkUpdateParticipants")}),e.participants.bulkPut(t).then(function(){return t.length>0&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(t)}),t})}function y(e,t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve();var r=n.map(function(e){return[t,e]});return b(e,r)}function C(e,t,n){if(t.length===0)return o("MAWDexieTable").dexieResolve();var r=t.map(function(e){return[e,n]});return b(e,r)}function b(e,t,n){return n===void 0&&(n=!0),e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(t){return e.participants.bulkDelete(t.map(function(e){return e.id})).then(function(){n&&t.forEach(function(e){var t=e.threadJid,n=e.userJid;return o("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:t,userId:o("WAJids").extractUserId(n)}})})})})}function v(e,t){return e.participants.where("threadJid").equals(t).delete()}function S(e,t,n,r,o){return R(e,[{deliveredWatermarkTs:n,lastReadActionTs:o,lastReadWatermarkTs:r,participantKey:t}]).then(function(e){return e[0]})}function R(t,n,r){if(n.length===0)return o("MAWDexieTable").dexieResolve([]);var a=new Map,i=[];return n.forEach(function(e){i.push(e.participantKey),a.set(JSON.stringify(e.participantKey),e)}),t.participants.where(["threadJid","userJid"]).anyOf(i).toArray().then(function(n){n.length!==i.length&&r!=null&&r.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing participants "," vs ",""])),n.length,i.length);var l=[],c=[];return n.forEach(function(e){var t=a.get(JSON.stringify([e.threadJid,e.userJid]));if(t==null){r!=null&&r.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing tsData for participant ",", ",""])),e.threadJid,e.userJid);return}var n=t.deliveredWatermarkTs,o=t.lastReadActionTs,i=t.lastReadWatermarkTs,d=e.deliveredWatermarkTs,m=e.lastReadWatermarkTs,p=e.lastReadActionTs,_=n>d,f=i>m,g=p==null||o>p;if(r!=null&&r.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: participant ",", "," deliveredWatermarkTs: ",", lastReadWatermarkTs: ",", lastReadActionTs: ",""])),e.threadJid,e.userJid,n,i,o),!_&&!f&&!g){c.push(e);return}l.push(babelHelpers.extends({},e,{deliveredWatermarkTs:_?n:d,lastReadActionTs:g?o:p,lastReadWatermarkTs:f?i:m}))}),l.forEach(function(e){return d(e,"bulkUpdateParticipantTimestamps")}),t.participants.bulkPut(l).then(function(){return l.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:o("MAWBridgeTypesCreators").createBridgeReceivedReceipt(e.threadJid,o("WAJids").extractUserId(e.userJid),e.deliveredWatermarkTs)})}),[].concat(l,c)})})}function L(e,t){return e.participants.where("threadJid").equals(t).toArray()}function E(e,t){return e.participants.where("threadJid").anyOf(t).toArray()}function k(e,t){return L(e,t).then(function(e){return e.filter(function(e){return e.type==="invitedParticipant"})})}function I(e,t,n){return e.participants.where(["threadJid","userJid"]).equals([t,n]).first().then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function T(e,t){return e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(e){var n=new Map(e.map(function(e){return[JSON.stringify([e.threadJid,e.userJid]),e]}));return t.map(function(e){return n.get(JSON.stringify(e))})})}l.bulkAddParticipants=c,l.logIfIllegalParticipant=d,l.bulkAddParticipantsInThreads=p,l.deleteIncorrectParticipantsInOneToOneThread=_,l.addMissingParticipantsInOneToOneThread=f,l.bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread=g,l.bulkUpdateParticipants=h,l.bulkDeleteParticipantsInThread=y,l.bulkDeleteParticipantAcrossThreads=C,l.bulkDeleteParticipants=b,l.deleteAllParticipantsForThread=v,l.updateParticipantTimestamps=S,l.bulkUpdateParticipantTimestamps=R,l.getParticipantsInThread=L,l.getParticipantsInThreads=E,l.getInvitedParticipantsInThread=k,l.getParticipant=I,l.bulkGetParticipants=T}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=o("MAWDbMsg").getCanonicalTsFromMsg(t),r=t.author;return r!=="@me"&&r!=="@system"?o("MAWDbParticipantTxns").updateParticipantTimestamps(e,[t.threadJid,r],n,n,n):o("MAWDexieTable").dexieResolve()}l.updateParticipantTimestampsForMsg=e}),98);
__d("MAWWriteMsgTxns",["FBLogger","FtsIndexEntity","MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBuildIncomingMsgs","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEphemeralMsgTxns","MAWExpiredQuoteCleaner","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWLocalizationType","MAWLocalizationUtils","MAWMessageSortOrderUtils","MAWMsgType","MAWThreadEventConst","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWUseProtocolMsgIdForMsgId","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","ODS","Promise","WAJids","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["rowId"],s,u,c,d;function m(e,t,n,a){var i=n.ts,l=[o("WATimeUtils").castUnixTimeToMillisTime(i),n.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN],s=l[0],u=l[1];return o("MAWGetOrCreateThreadTxns").getExistingThread(e,t.jid).then(function(t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");var i=o("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(e,t.jid),l=o("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(e,t.jid);return o("MAWDexieTable").dexieAll([i,l]).then(function(e){var r,i,l,c=e[0],d=e[1],m=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?null:d==null?1:o("MAWDbMsg").getInChatMsgIdFromMsgId(d.msgId)+1,p=o("WATimeUtils").castToMillisTime((r=d==null?void 0:d.sortOrderMs)!=null?r:0),_=s>p&&!u?s:p,f=(i=o("MAWTimeUtils").ensureValidMillisTime(t.lastReadMsgTs))!=null?i:0,g=o("WATimeUtils").castToMillisTime((l=d==null?void 0:d.sortOrderMs)!=null?l:0),h=f<g,y=n.author===o("WAJids").AUTHOR_ME||n.type===o("MAWMsgType").MSG_TYPE.ADMIN&&o("MAWLocalizationUtils").isParticipantChangeAdminMsg(n.msgContent.adminType)&&!h,C=babelHelpers.extends({},n,{msgId:m!=null?o("MAWDbMsg").craftMsgIdV2(t.chatId,m,n):o("MAWJidUtils").formatProtocolMsgIdFromMsg(n)}),b=o("MAWDbMsgTxns").calculateOldestMsg(c,d,C,a),v=b.oldestMsg;return{isOldestMsgUpdated:c!=null&&v!==c.msgId,msgId:C.msgId,prevOldestMsg:c,updatedSnippet:void 0,updatedThread:babelHelpers.extends({},t,{lastReadMsg:y?C.msgId:t.lastReadMsg,lastReadMsgTs:y?_:t.lastReadMsgTs,newestMsgTs:_,oldestMsg:v,snippetMsg:t.snippetMsg,snippetMsgTs:t.snippetMsgTs,threadOrder:o("MAWDbThread").craftThreadOrder(_,t.jid)})}})})}function p(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN&&e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION?!1:e.type===t.type&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?r:h(e,t,n)})}function _(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?((d||(d=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):h(e,t,n)})}function f(e,t,n){return e.messages.where("threadJid").equals(n.jid).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&(e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED||e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT)}).first().then(function(r){return r!=null?((d||(d=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):h(e,t,n)})}function g(e,t){return e.messages.add(t).then(function(e){return babelHelpers.extends({},t,{rowId:e})})}function h(e,t,r,a){a===void 0&&(a={});var i=a,l=i.isFirstMsg,u=l===void 0?!1:l,d=i.isOutgoing,p=d===void 0?!1:d,_=i.openMessageOtid,f=i.openMessageParticipantCount,h=i.optimisticMsg,y=i.participantCount,C=i.quotedReplyAttachmentMeta,b=i.shouldUpdateUi,v=b===void 0?!0:b,S=i.sortOrderMs;return m(e,r,t,S).then(function(r){var a=r.isOldestMsgUpdated,i=r.msgId,l=r.prevOldestMsg,d=r.updatedThread,m=babelHelpers.extends({},t,{msgId:i,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t)});return o("MAWDexieTable").dexieAll([g(e,m),e.threads.put(d),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(c||(c=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToBacklog(e,m.externalId)})]).then(function(e){var t=e[0],n=e[1];return p&&o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""])),t.sortOrderMs),v&&o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({dbMsg:t,isFirstMsg:u,openMessageOtid:_,openMessageParticipantCount:f,optimisticMsg:h,participantCount:y,quotedReplyAttachmentMeta:C,updatedThread:d}),t})})}function y(e,t,n){return o("MAWGetOrCreateThreadTxns").getExistingThread(e,n.jid).then(function(a){if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");return(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?o("MAWDexieTable").dexieResolve(null):o("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(e,a)).then(function(r){var i=babelHelpers.extends({},t,{msgId:r!=null?o("MAWDbMsg").craftUnrenderedMsgId(a.chatId,r):o("MAWJidUtils").formatProtocolMsgIdFromExternalId(n.jid,t.externalId)});return o("MAWDexieTable").dexieAll([e.unrenderedMessages.add(i),e.threads.put(a)]).then(function(e){var t=e[0],n=e[1];return babelHelpers.extends({},i,{rowId:t})})})})}function C(e,t,n){return o("MAWDexieTable").dexieAll([b(e,t,n),o("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(e,[[t.externalId,n.jid]]).then(function(e){return{editMsgHistories:e,originalEditMsgHistory:e.find(function(e){return e.editExternalId===t.externalId})}})]).then(function(e){var t=e[0],n=e[1],r=n.editMsgHistories,o=n.originalEditMsgHistory;return babelHelpers.extends({},t,{editMsgHistories:r,existingEditMsgHistory:o!=null?o:null})})}function b(e,t,n){var r=[t.externalId,n.jid,t.author],a=r[0],i=r[1],l=r[2];return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,a,l,i),o("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(e,a,l,i),o("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(e,i).then(function(e){return o("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(t.ts,e)})]).then(function(e){var t=e[0],n=e[1],r=e[2],o=e[3],a=e[4];return{existingMsg:t!=null?t:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:o,pendingDeleteForMeStanza:r!=null?r:null,pendingRevokedStanza:n!=null?n:null}})}function v(e,t,n,r,a){return r===void 0&&(r=!0),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,t.externalId,t.author,n.jid).then(function(i){if(i!=null)return L(e,t,n,i,!0);var l=t.author;o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""])),t.type,l,n.jid);var s=babelHelpers.extends({},babelHelpers.extends({},t,{threadJid:n.jid}));return n.folder===o("MAWFolderTypes").FOLDER_ID.OTHER&&(s.altIndex=s.altIndex===o("MAWDbMsg").FUTUREPROOF_ALT_INDEX?o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:o("MAWDbMsg").SPAM_ALT_INDEX),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(e,s,n.jid,a).then(function(t){t!=null&&(s=babelHelpers.extends({},s,{quote:t==null?void 0:t.quote,quoteExpirationTs:t==null?void 0:t.quote.content.expirationTs,quoteExternalId:t==null?void 0:t.quoteExternalId}));var a=s.quoteExpirationTs;return a!=null&&a>o("WATimeUtils").unixTime()&&o("MAWExpiredQuoteCleaner").addNewExpiredQuoteCleanerTimestamp(a),o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,n.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(e,s)]).then(function(t){var a=t[0],i=t[1],l=t[2];return h(e,s,n,{quotedReplyAttachmentMeta:i,shouldUpdateUi:r}).then(function(t){return o("MAWDexieTable").dexieAll([o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(e,s),o("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(e,t,r)]).then(function(e){var n=e[1];return a!=null&&r&&a.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,l)})}),n||t})})})})})}function S(t,n,r,a,i,l){var s=babelHelpers.extends({},babelHelpers.extends({},n,{msgId:r.msgId,protocolMsgId:r.protocolMsgId,rowId:r.rowId,serverTs:r.serverTs,sortOrderMs:r.sortOrderMs,threadJid:a.jid,ts:r.ts}));return o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(t,a.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(t,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(t,s),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(t,s,a.jid,l),o("MAWDbMsgTxns").getThreadNewestMessageId(t,a.jid)]).then(function(l){var u,c=l[0],d=l[1],m=l[2],p=l[3],_=l[4];return s=babelHelpers.extends({},s,{quote:p==null?void 0:p.quote,quoteExternalId:p==null?void 0:p.quoteExternalId}),((u=r.editCount)!=null?u:0)>0&&i!=null&&n.type===o("MAWMsgType").MSG_TYPE.TEXT?o("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(t,i,n).then(function(){return r}):t.messages.put(s).then(function(){return o("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(t,s)}).then(function(e){if(e)return s.altIndex=o("MAWDbMsg").craftToBeReadAltIndex(a.chatId),t.messages.put(s)}).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,m)}),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,d)}),o("MAWIndexedDb").afterTransactionThreadEvent({chatJid:a.jid,msgId:s.msgId},o("MAWThreadEventConst").PLACEHOLDER_CONVERT_SUBSCRIPTION),c!=null&&c.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,m)})}),s.msgId===_){var n=s,r=n.rowId,i=babelHelpers.objectWithoutPropertiesLoose(n,e);o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(t,i)}return s})})}function R(e,t,r,a){var i=o("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(t,r);return o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:i.author,chatJid:i.threadJid,externalId:i.externalId}]),y(e,i,r),e.pendingStanzas.delete(a.rowId),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(c||(c=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,t.externalId)})]).then(function(e){var t=e[0],n=e[1];return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(i.messageDeleteForMeTs),babelHelpers.extends({},i,{msgId:n.msgId,rowId:n.rowId})})}function L(e,t,n,a,i){i===void 0&&(i=!1);var l=o("MAWDbPendingStanzaTxns").getRevokedContent(a);if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing revoked content");var s=o("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(t,n,l);return o("MAWDexieTable").dexieAll([h(e,s,n),e.pendingStanzas.delete(a.rowId)]).then(function(t){var r=t[0];return o("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(e,r,n).then(function(){return r})})}l.writeDedupedEphemeralSettingAdminMessage=p,l.writeDedupedAdminMessage=_,l.writeDedupedUsersConnectedAdminMessage=f,l.writeMsg=h,l.writeUnrenderedMsg=y,l.prepareTextMsgWriteData=C,l.prepareMsgWriteData=b,l.writeNewIncomingMsg=v,l.writeCiphertextUpdate=S,l.handleDeleteForMeMessage=R,l.handleOutOfOrderRevokedMessage=L}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});i.DbDeletedMsgReasonEnum=e}),66);
__d("MAWMediaManagerDeferred",["promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("MAWMediaManager").__setRef("MAWMediaManagerDeferred");function s(t){r("promiseDone")(e.load().then(function(e){e.getMawMediaManager().dequeueDownload(t)}))}l.dequeueDownload=s}),98);
__d("MAWUnsendMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startUnsendMsgContentCleaner=c,l.addNewUnsendMsgContentCleanerTimestamp=d,l.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWWriteDeleteMessageTxns",["FtsIndexEntity","MAWAckLevel","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWXMAUtils","Promise","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=6*o("WATimeUtils").HOUR_SECONDS,u=30*o("WATimeUtils").DAY_SECONDS;function c(t,r){var a=r.protocolMsgId,i=a.author,l=a.chat,s=a.externalId;return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(t,l),t.unrenderedMessages.get({externalId:s}),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(e||(e=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(t,s)})]).then(function(e){var n=e[0],r=e[1];return n.success?r!=null&&r.threadJid===n.value.jid&&r.author===i?o("WAResultOrError").makeError("duplicate_delete_for_me"):o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,a).then(function(e){if(e==null){var r={ack:o("MAWAckLevel").ACK.received,author:i,externalId:s,threadJid:n.value.jid,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},l=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+u),c={deleteTs:l,externalIdWithType:s+"_"+o("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:r,type:o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return t.pendingStanzas.add(c).then(function(){return o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(l),o("WAResultOrError").makeResult()})}return o("MAWDexieTable").dexieResolve(d(t,e,i,a.chat,n.value)).then(function(){return o("WAResultOrError").makeResult()})}):o("WAResultOrError").makeError("missing_thread")})}function d(e,t,n,a,i){var l,u,c=o("MAWDexieTable").dexieResolve();o("MAWXMAUtils").isXMAStoryReply((l=t.quote)==null?void 0:l.content.xmaMessageType)&&(c=m(e,t));var d={ack:t.ack,author:n,externalId:t.externalId,mediaId:t.mediaId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s),msgContent:(u=o("MAWDbMsg").getMsgContent(t))==null?void 0:u.content,msgId:t.msgId,quote:t.quote,reportingMeta:t.reportingMeta,serverTs:void 0,threadJid:a,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:t.xmaMessageType},_=o("MAWDexieTable").dexieAll([p(e,t.author,t.externalId,t.threadJid),o("MAWDbMsgTxns").deleteDbMsg(e,t.rowId),c]).then(function(){if(o("MAWDbMsg").isMediaMsg(t)){var n=t.mediaId,a=t.plaintextHash;n!=null&&(a!=null?(o("MAWMediaManagerDeferred").dequeueDownload(a),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:n,msgId:t.msgId,plaintextHash:a,threadJid:t.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:n,msgId:t.msgId,threadJid:t.threadJid}}))}return o("MAWDexieTable").dexieAll([o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,i)]).then(r("emptyFunction"))});return _.then(function(){return o("MAWDexieTable").dexieAll([e.unrenderedMessages.add(d),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:n,chatJid:t.threadJid,externalId:t.externalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(e,t.threadJid,t.externalId,t.author,o("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return o("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(e,i.jid,t.msgId,t.sortOrderMs).then(function(){return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(d.messageDeleteForMeTs),o("WAResultOrError").makeResult()})})})}function m(e,t){return o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(t){return o("MAWDbMsgTxns").maybeGetMsg(e,t==null?void 0:t.msgId).then(function(t){if(t!=null)return o("MAWDbMsgTxns").deleteDbMsg(e,t.rowId)})})}function p(e,t,n,r){return e.messages.where("quoteExternalId").equals(n).filter(function(e){var n;return e.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE&&((n=e.quote)==null?void 0:n.content.author)===t&&e.threadJid===r}).toArray().then(function(t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.map(function(e){return e.rowId});return o("MAWDbMsgTxns").bulkDeleteDbMsg(e,n).then(function(){return t})})}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=s,l.handleDeleteForMe=c,l.deleteXMAStoryReplyMsg=m,l.deleteBumpMsgs=p}),98);
__d("MAWWriteRevokeMessageTxns",["FBLogger","FtsIndexEntity","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbProtocolMsgIdMiddleware","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWWriteDeleteMessageTxns","MAWWriteMsgTxns","MAWXMAUtils","Promise","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=6*o("WATimeUtils").HOUR_SECONDS,u=30*o("WATimeUtils").DAY_SECONDS;function c(t,a,i,l,s,c){if(c!=null&&l==null){var m,p=babelHelpers.extends({},a,{originalTs:o("WATimeUtils").castMilliSecondsToUnixTime(c),threadJid:i.jid,unsendMsgContentDeleteTs:(m=a.serverTs)!=null?m:a.ts});return o("MAWWriteMsgTxns").writeMsg(t,p,i).then(function(e){return e.type==="Revoked"?e:null})}var f=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+u),g=a.author,h=a.externalId,y=a.revokedExternalId,C=s!=null?_(t,s):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([l==null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(t,a.revokedExternalId,i.jid,a.author):o("MAWDexieTable").dexieResolve(l),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(e||(e=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(t,h)})]).then(function(e){var n=e[0];if((l==null||n!=null)&&r("FBLogger")("messenger_web").warn("Revoked message missing originalMsg incorrectly"),n==null){var s={deleteTs:f,externalIdWithType:y+"_"+o("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:g,externalId:h,revokedExternalId:y,threadJid:i.jid,ts:a.ts,type:"Revoked"},type:o("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return o("MAWDexieTable").dexieAll([t.pendingStanzas.add(s),C]).then(function(e){var n=e[0],a=e[1];o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(f),o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(y,r("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,i.jid),a===!0&&o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(t,i)})}return C.then(function(){return d(t,n,i,a.externalId,a.revokedExternalId,a.serverTs,a.ts,!1)})})}function d(e,t,n,r,a,i,l,u){var c,d=babelHelpers.extends({},t,{altIndex:void 0,externalId:r,msgContent:o("MAWDbMsg").getMsgContent(t),originalTs:(c=t.serverTs)!=null?c:t.ts,revokedExternalId:a,serverTs:i,threadJid:n.jid,ts:l,type:"Revoked",unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s)});return o("MAWDbProtocolMsgIdMiddleware").appendProtocolMsgId(d),u?o("MAWDexieTable").dexieResolve(d):m(e,t,d,n).then(function(){return d})}function m(t,r,a,i){var l,s=o("MAWXMAUtils").isXMAStoryReply((l=r.quote)==null?void 0:l.content.xmaMessageType)?o("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(t,r):o("MAWDexieTable").dexieResolve(),u=o("MAWJidUtils").toProtocolMsgId(r),c=u!=null?t.deletedMessages.add(babelHelpers.extends({},u,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(t,r.author,r.externalId,r.threadJid).then(function(){return o("MAWDexieTable").dexieAll([t.messages.put(a),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(t,[{author:a.author,chatJid:a.threadJid,externalId:a.revokedExternalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(t,a.threadJid,a.revokedExternalId,a.author,o("MAWMsgType").MSG_TYPE.REVOKED),s,c,o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(e||(e=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(t,r.externalId)})]).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(a)}),r!=null&&o("MAWDbMsg").isMediaMsg(r)){var e=r.mediaId,n=r.plaintextHash;e!=null&&(n!=null?(o("MAWMediaManagerDeferred").dequeueDownload(n),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:r.msgId,plaintextHash:n,threadJid:r.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:r.msgId,threadJid:r.threadJid}}))}return o("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(r),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(t,i)})})}function p(e,t,n){if(t.type!==o("MAWMsgType").MSG_TYPE.REVOKED)throw r("FBLogger")("messenger_web").mustfixThrow("Cant mark unrevoked message revoked");var a=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.revokedExternalId),i=a!=null?e.deletedMessages.add(babelHelpers.extends({},a,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(e,t.author,t.revokedExternalId,t.threadJid).then(function(r){return r.length>0&&o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,r)}),o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:t.author,chatJid:t.threadJid,externalId:t.revokedExternalId}]),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,n),i]).then(function(){o("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(t.unsendMsgContentDeleteTs),o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t)})})})}function _(e,t){return t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?e.messages.delete(t.rowId).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,[t])}),!0}):o("MAWDexieTable").dexieResolve(!1)}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=s,l.writeIncomingRevokeMsg=c,l.revokeUnstoredMsg=d,l.markExistingMsgRevoked=m,l.markIncomingMessageRevoked=p}),98);
__d("MAWAdminWriteUserDeviceMsgTxn",["MAWAckLevel","MAWAdminMsgHelpers","MAWDbMsgTxns","MAWDexieTable","MAWExternalId","MAWGetUserDeviceChangeAdminType","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e={add:"add",remove:"remove",update:"update"};function s(e,t,n,a,i){return o("MAWDbMsgTxns").getIsThreadEmpty(e,n.jid).then(function(l){if(l)return o("MAWDexieTable").dexieResolve();var s=t===o("MAWUserJidWrapper").getMyUserJid(),u=o("MAWGetUserDeviceChangeAdminType").getUserDeviceAdminType(a,s),c=s?[]:[o("WAJids").userIdFromJid(t)],d=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:c,adminType:u,version:1},n.jid,o("MAWExternalId").generateExternalId(),i);return o("MAWWriteMsgTxns").writeMsg(e,d,n).then(r("emptyFunction"))})}function u(e,t,n,a){var i=o("MAWAdminMsgHelpers").UNKNOWN_USER,l=t===o("MAWUserJidWrapper").getMyUserJid(),s={ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:l?o("WAJids").AUTHOR_ME:t,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.ICDC_ALERT_ADMIN_MESSAGE,authorName:i},threadJid:n.jid,ts:a!=null?a:o("WATimeUtils").unixTime(),type:o("MAWMsgType").MSG_TYPE.ICDC_ALERT};return o("MAWWriteMsgTxns").writeMsg(e,s,n).then(r("emptyFunction"))}l.DeviceChange=e,l.writeUserDeviceAdminMsg=s,l.writeICDCAlert=u}),98);
__d("MpsFutureProofKey",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({WCEPlaintextPayloadFutureProofPlaceholder:0,WCEPlaintextPayloadFutureProofNoPlaceholder:1,WCEPlaintextPayloadFutureProofIgnore:2});i.WCEPlaintextPayloadFutureProof=e}),66);
__d("WABuildMpsPayload",["MpsFutureProofKey","MpsTypes","WAArmadilloBackupMessage.pb","WAArmadilloMiTransportAdminMessage.pb","WAArmadilloTransportEvent.pb","WAGlobals","WAJids","WALogger","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=o("WAJids").extractUserId(t.senderJid),r;t.hideDecryptionFailure!=null&&(r=t.hideDecryptionFailure?o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder:o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofPlaceholder);var a=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloBackupMessage.pb").BackupMessageSpec,babelHelpers.extends({},e,{metadata:{frankingMetadata:{frankingTag:t.frankingTag,reportingTag:t.reportingTag},messageId:t.externalId,payloadVersion:2,senderId:n,futureProofBehavior:r,timestampMs:t.timestampMs}})).readBuffer();return a}function d(e,t){var n=o("WAJids").extractUserId(t.senderJid),r=o("MpsTypes").toThreadId(t.threadId),a=t.millisServerTs!=null?t.millisServerTs:t.serverTs*1e3+o("WAGlobals").getDependencies().extractMsFromStanzaId(t.externalId),i=c(e,{senderJid:t.senderJid,externalId:t.externalId,frankingTag:t.frankingTag,reportingTag:t.reportingTag,hideDecryptionFailure:t.hideDecryptionFailure,threadId:t.threadId,timestampMs:o("MpsTypes").toTimestamp(a)});return{messageId:o("MpsTypes").toMessageId(t.externalId),payload:o("MpsTypes").toBytes(i),senderId:n,threadId:r,timestampMs:o("MpsTypes").toTimestamp(a)}}function m(t,n,r){try{var a={};switch(r.type){case"message":a={encryptedTransportMessage:r.applicationPayload};break;case"ciphertext":a={encryptedTransportEvent:{payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;case"unavailable":a={encryptedTransportEvent:{payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;default:r.type}var i=n.type==="Available"?n.originalMsgTimestampMs:null;return d(a,babelHelpers.extends({senderJid:o("WAJids").extractUserJid(n.from),externalId:t.stanzaId},i!=null?{millisServerTs:o("WATimeUtils").castToMillisTime(i)}:{serverTs:t.serverTs},{frankingTag:t.frankingTag,reportingTag:t.reportingTag,hideDecryptionFailure:t.hideDecryptionFailure,threadId:n.chat}))}catch(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["buildMpsMessagePayload: ",""])),t),null}}function p(e,t,n){if(n.payload==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: No appdata payload"]))),null;try{return d({encryptedTransportMessage:n.payload},{senderJid:o("WAJids").extractUserJid(e.from),externalId:e.stanzaId,serverTs:t,threadId:o("WAJids").extractUserJid(e.from)})}catch(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: ",""])),e),null}}function _(e,t,n,r,a){var i={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupMembershipAddModeChanged:{mode:n}}).readBuffer(),version:3};return d({miTransportAdminMessage:i},{serverTs:r!=null?r:o("WATimeUtils").unixTime(),externalId:a,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function f(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupAdminChanged:{targetUserId:n.map(o("WAJids").extractUserId),action:r}}).readBuffer(),version:3};return d({miTransportAdminMessage:l},{serverTs:a!=null?a:o("WATimeUtils").unixTime(),externalId:i,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function g(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupParticipantChanged:{targetUserId:n.map(o("WAJids").extractUserId),action:r}}).readBuffer(),version:3};return d({miTransportAdminMessage:l},{serverTs:a!=null?a:o("WATimeUtils").unixTime(),externalId:i,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function h(e,t,n,r,a){var i={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupNameChanged:{groupName:n}}).readBuffer(),version:3};return d({miTransportAdminMessage:i},{serverTs:r!=null?r:o("WATimeUtils").unixTime(),externalId:a,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function y(e,t,n){var r={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{icdcAlert:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$IcdcAlert$Type.DETECTED}}}).readBuffer(),version:3};return d({encryptedTransportEvent:r},{serverTs:t!=null?t:o("WATimeUtils").unixTime(),externalId:n,hideDecryptionFailure:!1,senderJid:e,threadId:e})}function C(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{deviceChange:{type:r,devicePlatform:a,deviceModel:i}}}).readBuffer(),version:3};return d({encryptedTransportEvent:l},{serverTs:t!=null?t:o("WATimeUtils").unixTime(),externalId:n,hideDecryptionFailure:!1,senderJid:e,threadId:e})}l.buildBackupProtobufBytes=c,l.buildMpsMessage=d,l.buildMpsMessageFromIncomingMessage=m,l.buildMpsAppdataPayload=p,l.buildMpsGroupMemberAddType=_,l.buildMpsGroupAdminChangedMsg=f,l.buildMpsGroupParticipantsChanged=g,l.buildMpsGroupNameChangedMsg=h,l.buildMpsIcdcAdminMessage=y,l.buildMpsDeviceChangeAdminMessage=C}),98);
__d("EBMinosWriteKeyChangeAdminMessage",["EBMinosTypes","FBLogger","MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAppMeta","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWTransactionMode","MpsTypes","WAArmadilloTransportEvent.pb","WABuildMpsPayload","WADbContact","WAGlobals","WAJids","WAStanzaUtils","WebMps","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert}).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlert)!=null?t:!1})}function u(e,t){var n=o("WAGlobals").getMyUserJid()===t;return!n&&e}async function c(e){var t=e.deviceChangeType,n=t===void 0?o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED:t,a=e.epochHeadCreationTime,i=e.userJid;try{var l=o("MAWExternalId").generateExternalId(),s=o("WABuildMpsPayload").buildMpsDeviceChangeAdminMessage(i,a,o("WAStanzaUtils").toStanzaId(l),n),u={directive:null,insertionSource:o("MpsTypes").InsertionSource.Receive,message:s};await o("WebMps").mps().saveNewMessages([u],{source:"eb-minos-device-change"}),r("FBLogger")("wmi_minos").info("Sent device change transport event for user %s with type %s",i,String(n))}catch(e){var c=r("getErrorSafe")(e);throw r("FBLogger")("wmi_minos").catching(c).mustfix("Failed to send device change transport event for user %s",i),c}}async function d(t){var n=t.contactId,a=t.epochHeadCreationTime,i=o("EBMinosTypes").userFbidToUserJid(n);if(i==null)return r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid userJid generated in writeKeyChangeAdminMessage"]))),Promise.resolve();var l=await o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDbThreadTxns").getAllThreadsForUsers(e,[i])}})(),d=l.get(i),m=await o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:[i]});if(d==null||(d==null?void 0:d.length)===0)return Promise.resolve();var p=d.filter(function(e){var t=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return"group"},user:function(){return"one_to_one"}});return t==="one_to_one"}),_=await Promise.all([c({deviceChangeType:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED,epochHeadCreationTime:a,userJid:i}),o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY,ftsBackloggedMessages:o("MAWTransactionMode").READWRITE,groupInfo:o("MAWTransactionMode").READONLY,messages:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDexieTable").dexieAll(p.map(function(t){return s(e).then(function(n){u(n,i)&&m.get(i)===o("WADbContact").TWO_WAY_CONTACT?o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,i,t,"update",a):o("MAWDexieTable").dexieResolve()})}))}})()]),f=_[1];return f}l.saveDeviceChangeTransportEvent=c,l.writeMinosKeyChangeAdminMessage=d}),98);
__d("MAWDbAddDeviceChangeAlertsTxn",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.deviceChangeAlerts.add(t)}i.addDeviceChangeAlertsTxn=e}),66);
__d("MAWDbDeviceChangeAlerts",[],(function(t,n,r,o,a,i){"use strict";var e="add",l="keyChange",s="remove";function u(e){return e}i.ADD=e,i.KEY_CHANGE=l,i.REMOVE=s,i.unsafeCoerceToDeviceChangeAlertsID=u}),66);
__d("WATypedArraysCast",["WABase64"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return t instanceof e?t:typeof t=="string"?new e(o("WABase64").decodeB64(t)):new e(t)}l.castTypedArrays=e}),98);
__d("WACryptoHmac",["WACryptoDependencies","WATypedArraysCast"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=new Uint8Array(e),u={name:"HMAC",hash:"SHA-256"},c={name:"HMAC",hash:"SHA-512"},d={name:"HMAC",hash:"SHA-1"};function m(e,t){var n=o("WATypedArraysCast").castTypedArrays(Uint8Array,t);return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",n,e,!1,["sign"]).then(function(t){return{key:t,algo:e}})}function p(e){return m(u,e)}function _(e,t,n){var r=e.algo,a=e.key;return o("WACryptoDependencies").getCrypto().subtle.sign(r,a,t).then(function(e){return n!=null&&n!==0?e.slice(0,n):e})}function f(e,t){return m(u,e!=null?e:s).then(function(e){return _(e,t)})}function g(e,t,n){return m(u,e).then(function(e){return _(e,t,n)})}function h(e,t,n){return m(c,e).then(function(e){return _(e,t,n)})}function y(e,t,n){return m(d,e).then(function(e){return _(e,t,n)})}l.SHA256_BYTE_LENGTH=e,l.DEFAULT_SALT=s,l.encodeKeySha256=p,l.sign=_,l.extractSha256=f,l.hmacSha256=g,l.hmacSha512=h,l.hmacSha1=y}),98);
__d("WACryptoHkdf",["Promise","WABinary","WACryptoHmac","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s=255*o("WACryptoHmac").SHA256_BYTE_LENGTH;function u(t,a,i){if(i<0||i>s)return(e||(e=n("Promise"))).reject(r("err")("HKDF::expand given bad length "+i));for(var l,u=Math.ceil(i/o("WACryptoHmac").SHA256_BYTE_LENGTH),c=o("WABinary").Binary.build(a).readByteArrayView(),d=new(o("WABinary")).Binary,m=o("WACryptoHmac").encodeKeySha256(t).then(function(e){return l=e,new Uint8Array(0)}),p=function(t){m=m.then(function(e){return o("WACryptoHmac").sign(l,o("WABinary").Binary.build(e,c,t).readByteArrayView())}).then(function(e){var t=new Uint8Array(e);return d.writeByteArray(t),t})},_=1;_<=u;_++)p(_);return m.then(function(){return d.readBuffer(i)})}function c(e,t,n){return o("WACryptoHmac").extractSha256(null,e).then(function(e){return u(new Uint8Array(e),t,n)})}function d(e,t,n,r){return o("WACryptoHmac").extractSha256(t,e).then(function(e){return u(new Uint8Array(e),n,r)})}l.expand=u,l.extractAndExpand=c,l.extractWithSaltAndExpand=d}),98);
__d("WACryptoPrimitives",["tweetnacl"],(function(t,n,r,o,a,i,l){"use strict";var e,s={scalarbase:(e=o("tweetnacl")).lowlevel.scalarbase,crypto_hash:e.lowlevel.crypto_hash,modL:e.lowlevel.modL,pack25519:e.lowlevel.pack25519,S:e.lowlevel.S,M:e.lowlevel.M,A:e.lowlevel.A,Z:e.lowlevel.Z,D:e.lowlevel.D,unpack25519:e.lowlevel.unpack25519,pow2523:e.lowlevel.pow2523,crypto_verify_32:e.lowlevel.crypto_verify_32,set25519:e.lowlevel.set25519,add:e.lowlevel.add,scalarmult:e.lowlevel.scalarmult};l.hash=e.hash,l.scalarMult=e.scalarMult,l.verify=e.verify,l.secretbox=e.secretbox,l.lowlevel=s,l.keypairFromSecretKey=e.box.keyPair.fromSecretKey,l.keyPair=e.box.keyPair,l.signDetachedVerify=e.sign.detached.verify}),98);
__d("WACryptoUtils",["WACryptoDependencies","WACryptoPrimitives","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return u(new Uint8Array(e),new Uint8Array(t))}function s(e,t){var n=new TextDecoder;return n.decode(e).toLowerCase()===n.decode(t).toLowerCase()}function u(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function c(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function d(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function m(e){if(e!==(e|0))throw r("err")("bound must be int32");if(e<=0)throw r("err")("bound must not be positive");for(var t=new Int32Array(1),n=-1>>>1,a=e*Math.floor(n/e),i=-1;i===-1;){o("WACryptoDependencies").getCrypto().getRandomValues(t);var l=t[0]>>>1;l<a&&(i=l%e)}return i}l.arrayBuffersEqual=e,l.arrayBuffersEqualCaseInsensitive=s,l.uint8ArraysEqual=u,l.rawKeysEqual=c,l.serializedPubKeysEqual=d,l.randomNumberLessThan=m}),98);
__d("WAXmlParsingFailure",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.parser=e,this.reason=t}var t=e.prototype;return t.toString=function(){return"XmlParsingFailure: "+this.parser+": "+this.reason},e})();i.XmlParsingFailure=e}),66);
__d("WAParsableXmlNode",["WAHasProperty","WAXmlParsingFailure","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){throw new TypeError('"'+e+'" is read-only')}var s=(function(){function e(e,t){var n=this;this.$1=e,this.$2=t,this.$3=Array.isArray(t.content)?t.content.map(function(t){return new n.constructor(e,t)}):null}var t=e.prototype;return t.name=function(){return this.$1},t.node=function(){return this.$2},t.hasAttr=function(t){return r("WAHasProperty")(this.$2.attrs,t)},t.assertTag=function(t){this.$2.tag!==t&&this.throw("to be <"+t+">")},t.tag=function(){return this.$2.tag},t.maybeChild=function(t){var e=this.$3;if(!e)return null;for(var n=0;n<e.length;n++)if(e[n].tag()===t)return e[n];return null},t.hasChild=function(t){return!!this.maybeChild(t)},t.child=function(t){var e=this.maybeChild(t);return e||this.throw("to have child <"+t+">")},t.assertAttr=function(t,n){var e=this.attrString(t);e!==n&&this.throw('to have "'+t+'"="'+n+'", but instead has "'+e+'"')},t.attrString=function(t){return r("WAHasProperty")(this.$2.attrs,t)?this.decodeAsString(this.$2.attrs[t]):this.throw('to have attribute "'+t+'"')},t.forEachAttributeKey=function(t){var e=this.$2.attrs;Object.keys(e).forEach(function(e){return t(e)})},t.maybeAttrString=function(t){return this.hasAttr(t)?this.decodeAsString(this.$2.attrs[t]):null},t.maybeAttrInt=function(t,n,r){return this.hasAttr(t)?this.attrInt(t,n,r):null},t.attrEnumValues=function(t,n,r){var e=new Set(n),o=this.attrString(t);if(!e.has(o)){if(r!=null)return r;var a=Array.from(e).join("|");return this.throw('to have "'+t+'"={'+a+'} but has value "'+o+'"')}return o},t.attrEnum=function(t,n){var e=this.attrString(t);if(!r("WAHasProperty")(n,e)){var o=Object.keys(n).join("|");return this.throw('to have "'+t+'"={'+o+'} but has value "'+e+'"')}return n[e]},t.attrEnumOrNullIfUnknown=function(t,n){var e=this.attrString(t);return r("WAHasProperty")(n,e)?n[e]:null},t.maybeAttrEnum=function(t,n){return this.hasAttr(t)?this.attrEnum(t,n):null},t.attrInt=function(t,n,r){var e=this.attrString(t);return this.$4(e,t,n,r)},t.$4=function(t,n,r,o){var e=parseInt(t,10);return Number.isNaN(e)?this.throw('to have "'+n+'"={integer} but has value "'+t+'"'):r!==void 0&&e<r?this.throw('to have "'+n+'"={at least '+r+"} but has value "+e):o!==void 0&&e>=o?this.throw('to have "'+n+'"={below '+o+"} but has value "+e):e},t.forEachChild=function(t){var e=this.$3;if(e)e.forEach(function(e){return t(e)});else if(this.$2.content!=null)return this.throw("to have children")},t.forEachChildWithTag=function(t,n){this.forEachChild(function(e){e.tag()===t&&n(e)})},t.mapChildren=function(t){var e=this.$3;return!e&&this.$2.content!=null?this.throw("to have children"):e?e.map(function(e){return t(e)}):[]},t.mapChildrenWithTag=function(t,n){var e=this.$3;return!e&&this.$2.content!=null?this.throw("to have children"):e?e.filter(function(e){return e.tag()===t}).map(function(e){return n(e)}):[]},t.mapFirstChild=function(t){var e=this.$3;return!e||e.length===0?this.throw("to have children"):t(e[0])},t.hasContent=function(){return!this.$3&&!!this.$2.content},t.hasChildren=function(){return this.$3!=null},t.getChildren=function(){return this.$3},t.mapAttrKeys=function(t){var e=this.getAttrKeys();return e&&e.length?e.map(t):[]},t.getAttrKeys=function(){return Object.keys(this.$2.attrs)},t.hasAttrs=function(){var e=this.$2.attrs?Object.keys(this.$2.attrs):[];return e.length>0},t.getNode=function(){return this.$2},t.unsafeSetChildren=function(t){this.$3=t},t.unsafeSetNodeContent=function(t){this.$2.content=t},t.contentUint=function(t){var e=this.contentBytes(t);return u(e,t)},t.contentBytes=function(t){if(t===void 0&&(t=-1),this.$3)return this.throw("to have binary content, but has children instead");if(this.$2.content!=null){var e=this.$2.content;return t!==-1&&e.length!==t?this.throw("to be "+t+" bytes, but got "+e.length+" instead"):e}else return this.throw("to have content")},t.contentString=function(){return this.$3?this.throw("to have string content, but has children instead"):this.$2.content!=null?this.$2.content:this.throw("to have content")},t.contentInt=function(t,n){var e=this.contentString();return this.$4(e,"content",t,n)},t.contentEnum=function(t){var e=this.contentString();if(!r("WAHasProperty")(t,e)){var n=Object.keys(t).join("|");return this.throw("to have content {"+n+'} but has value "'+e+'"')}return t[e]},t.decodeAsString=function(t){if(typeof t!="string")throw r("err")("decodeAsString: attribute is "+typeof t+" not a string: "+t);return t},t.throw=function(t){throw new(o("WAXmlParsingFailure")).XmlParsingFailure(this.$1,"expected <"+this.$2.tag+"> "+t)},t.toString=function(){return this.$2.toString()},e})();function u(e,t){for(var n=0,r=0;r<t;r++)n=n*256+e[r];return n}l.ParsableXmlNode=s,l.convertBytesToUint=u}),98);
__d("WASignalOther",["WACryptoDependencies","WACryptoHkdf","WACryptoUtils","WAParsableXmlNode","decodeProtobuf","encodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e={name:"AES-CBC"},s={name:"HMAC",hash:"SHA-256"};function u(e,t){if(e.length!==t)throw r("err")("Signal expected "+t+" bytes, given "+e.length);return e}function c(e,t){return u(new Uint8Array(e),t)}function d(e){var t=e.buffer,n=e.byteOffset,r=e.length;return n===0&&r===t.byteLength?t:t.slice(n,n+r)}function m(e,t){return e.readByteArrayView(t)}function p(e){return new Uint8Array(e)}function _(e,t,n){if(e.length-t<n)throw r("err")("Can not split off "+n+" bytes from index "+t+" of "+e.length+" bytes");return e.slice(t,t+n)}function f(e){var t=e==="extendedRange"?2147483646:16380;return o("WACryptoUtils").randomNumberLessThan(t)+1}function g(e){return b(e)}function h(e){return o("WAParsableXmlNode").convertBytesToUint(e,4)}function y(){var e=2147483647;return o("WACryptoUtils").randomNumberLessThan(e)+1}function C(e){return b(e)}function b(e,t,n){if(t===void 0&&(t=0),n===void 0&&(n=4294967296),typeof e=="number"&&t<=e&&e<n&&Math.floor(e)===e)return e;throw r("err")("Expected integer in range ["+t+", "+n+"), given "+String(e))}function v(e,t){return o("encodeProtobuf").encodeProtobuf(e,t).readByteArrayView()}function S(e,t,n){return n(o("decodeProtobuf").decodeProtobuf(e,t))}function R(e,t,n,r){return o("WACryptoHkdf").extractWithSaltAndExpand(e,t,n,r).then(function(e){return new Uint8Array(e)})}function L(t,n){var r,a;return n==="hmac-sha256"?(r=s,a=["sign"]):(r=e,a=["encrypt","decrypt"]),o("WACryptoDependencies").getCrypto().subtle.importKey("raw",t,r,!1,a)}function E(e){return e}function k(e){return e}function I(e,t){return o("WACryptoUtils").arrayBuffersEqual(e,t)}l.AES_CBC=e,l.HMAC_SHA256=s,l.ensureSize=u,l.toBytes=c,l.toBuffer=d,l.readBytes=m,l.makeBytes=p,l.sliceBytes=_,l.makeRegistrationId=f,l.castRegistrationId=g,l.castRegistrationIdFromBytes=h,l.makeSenderKeyId=y,l.castSenderKeyId=C,l.ensureIntInRange=b,l.encodeSignalProto=v,l.decodeSignalProto=S,l.hkdf=R,l.makeCryptoKey=L,l.castToByteEncoded=E,l.castToSessionHash=k,l.areSessionHashesEqual=I}),98);
__d("EBMinosWriteSecureStorageAlert",["EBMinosTypes","FBLogger","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWIndexedDb","MAWTransactionMode","MAWUnsafeCoerce","Promise","WAJids","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){var a=t.contactId,i=t.epochHead,l=t.epochHeadCreationTime,u=o("WAJids").validateDeviceJid(o("EBMinosTypes").userFbidToUserJid(o("EBMinosTypes").unsafeCastToUserFbId(a)));return u==null?(r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid deviceJid generated in writeMinosSecureStorageAlert"]))),(s||(s=n("Promise"))).resolve()):o("MAWIndexedDb").makeMsgrTransactor({deviceChangeAlerts:o("MAWTransactionMode").READWRITE},"writeMinosSecureStorageAlert",function(e){return function(){return o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:u,epochHead:i,identity:o("MAWUnsafeCoerce").unsafeCoerce(o("WASignalOther").toBytes(i,32)),isArchived:!1,model:"secure_storage",platform:"Meta",ts:l})}})()}l.writeMinosSecureStorageAlert=u}),98);
__d("EchoCommonUtils",[],(function(t,n,r,o,a,i){"use strict";var e="Echo-Doc-Version";function l(e,t){var n=e.localKey,r=e.transportKey;return n+"@"+r+"-"+t}function s(e,t,n){return e==null?{localKey:t,transportKey:n}:{displayName:e,localKey:t,transportKey:n}}i.ECHO_COMMON_FIELD_DOCUMENT_VERSION=e,i.getEchoAddressFieldNameWithSuffix=l,i.craftEchoAddress=s}),66);
__d("EchoConstants",[],(function(t,n,r,o,a,i){"use strict";var e=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);i.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=e}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(t,n,r,o,a,i,l,s){"use strict";var e,u,c,d,m,p,_,f,g,h,y,C,b,v=new Set([]);function S(t,n){if(t.length!==0){var r=t.indexOf(":");if(r===-1){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."])));return}var a=t.substring(0,r).trim(),i=t.substring(r+1).trim();if(a.length===0){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"])));return}if(i.length===0){n.has(a)&&n.delete(a);return}n.set(a,i)}}function R(e,t,n,r){n===void 0&&(n=new Set);for(var a=!1,i=t==="conditional"&&e[0]==='"',l="",s=i?1:0;s<e.length;){var u=e[s];if(t==="conditional"&&!i&&u==='"'||!i&&n.has(u))break;if(i&&!a&&u==='"'){i=!1,s++;break}if(i&&!a&&u==="\\"){if(s===e.length-1)break;a=!0}else a&&u==="r"?l+="\r":a&&u==="n"?l+="\n":l+=u,a=!1;s++}if(i||l.length===0){var d=r!=null?r:"unknown";return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""])),d),{remainder:e,result:null,success:!1}}return{remainder:e.substring(s),result:l,success:!0}}function L(e,t){if(e.length===0)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"]))),{remainder:e,result:null,success:!1};var n=e.trimLeft(),r=R(n,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,t);if(!r.success)return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"]))),{remainder:e,result:null,success:!1};if(r.result!=null||s(0,47923),r.remainder[0]==="@"){var a=E(r.remainder,r.result,t);return{remainder:a.remainder,result:a.result,success:a.success}}var i=r.result,l=r.remainder.trimLeft();if(l.startsWith("<")){var u=E(l.substring(1),void 0,t),c=u.result,_=u.remainder;if(u.success&&c!=null&&_.startsWith(">"))return i.length===0?{remainder:_.substring(1),result:c,success:!0}:{remainder:_.substring(1),result:babelHelpers.extends({},c,{displayName:i}),success:!0}}return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"]))),{remainder:e,result:null,success:!1}}function E(e,t,n){var r=t==null?e.trimLeft():e,a=t;if(a==null){var i=R(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n);if(!i.success)return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"]))),{remainder:e,result:null,success:!1};a=i.result,r=i.remainder}if(a==null||a.length===0||r[0]!=="@")return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"]))),{remainder:e,result:null,success:!1};var l=R(r.substring(1),"never",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n),s=l.result;return l.success&&s!=null&&s.length>0?{remainder:l.remainder,result:{localKey:a,transportKey:s},success:!0}:(o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"]))),{remainder:e,result:null,success:!1})}function k(e,t){if(e.length===0)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"]))),{result:null,success:!1};var n=L(e,t);if(!n.success)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""])),e),{result:null,success:!1};n.result!=null||s(0,47927);for(var r=[n.result],a=n.remainder;a.startsWith(",");){var i=L(a.substring(1).trimLeft(),t);if(i.success)i.result!=null&&r.push(i.result),a=i.remainder;else break}return{result:r,success:!0}}function I(e){var t=new Map,n=e.split("\r\n");return n.length===1&&n[0]===e?(o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"]))),t):(n.forEach(function(e){return S(e,t)}),t)}function T(e,t){var n=e.get(t);if(n==null||n.length===0||n==='""')return{result:null,success:!1};var r=R(n,"conditional",v,t),o=r.result,a=r.success;return{result:o,success:a}}function D(e,t){var n,r=x(e,t);return{result:(n=r.result)!=null?n:0,success:r.success}}function x(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=parseInt(n,10);return isNaN(r)?(o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"])),t),{result:null,success:!1}):Number.isSafeInteger(r)?{result:r,success:!0}:{result:r>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function $(e,t){var n,r=P(e,t);return{result:(n=r.result)!=null?n:!1,success:r.success}}function P(e,t){var n=x(e,t);return!n.success||n.result!==0&&n.result!==1?{result:null,success:!1}:{result:n.result===1,success:!0}}function N(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=L(n,t),o=r.result,a=r.success;return{result:o,success:a}}function M(e,t){var n=e.get(t);return n==null||n.length===0?{result:null,success:!1}:k(n,t)}function w(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=n.split(",").map(function(e){return e.trim()}).filter(Boolean);return r.length===0?{result:null,success:!1}:{result:r,success:!0}}l.echoDecodeFields=I,l.echoDecodeStringField=T,l.echoDecodeIntField=D,l.echoDecodeNullableIntField=x,l.echoDecodeBooleanField=$,l.echoDecodeNullableBooleanField=P,l.echoDecodeAddressField=N,l.echoDecodeAddressListField=M,l.echoDecodeObjectIdListField=w}),98);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","FBLogger","MAWMsgType","WABase64"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set(['"',"\\","\n","\r","\0"]),s=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"',"\\"]);function u(e,t){for(var n of t)if(e.indexOf(n)>=0)return!0;return!1}function c(t,n,o){if(o===void 0&&(o=new Set),t.length<=0)throw r("FBLogger")("wmi_eb").mustfixThrow("The input string must be non-empty");var a=n;if(n==="conditional"&&(u(t,o)?a="always":a="never"),a==="never")return t;for(var i='"',l=0;l<t.length;l++){var s=t[l];e.has(s)?(i+="\\",s==="\r"?i+="r":s==="\n"?i+="n":i+=s):i+=s}return i+'"'}function d(e){if(!Number.isSafeInteger(e))throw r("FBLogger")("wmi_eb").mustfixThrow("The input value must be a safe integer");return e.toString()}function m(e){var t="",n=e.displayName,r=e.localKey,a=e.transportKey;return n!=null&&n.length>0&&(t+=c(n,"always")+" <"),t+=c(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a,n!=null&&n.length>0&&(t+=">"),t}function p(e,t,n){n!=null&&n.length!==0&&e.set(t,c(n,"conditional",s))}function _(e,t,n){if(n!=null){var r=d(n);p(e,t,r)}}function f(e,t,n){if(n!=null){var r=d(n?1:0);p(e,t,r)}}function g(e,t,n){n!=null&&e.set(t,m(n))}function h(e,t,n){if(n!=null){var r="";n.forEach(function(e,t){r+=m(e),t<n.length-1&&(r+=", ")}),e.set(t,r)}}function y(e){var t="";return e.forEach(function(e,n){t=t+n+": "+e+"\r\n"}),t}function C(e){return o("WABase64").encodeB64UrlSafe(e)}function b(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("EchoMessage").EchoXMessageContentType.TEXT;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("EchoMessage").EchoXMessageContentType.IMAGE;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("EchoMessage").EchoXMessageContentType.VIDEO;case o("MAWMsgType").MSG_TYPE.PTT:return o("EchoMessage").EchoXMessageContentType.AUDIO;case o("MAWMsgType").MSG_TYPE.STICKER:return o("EchoMessage").EchoXMessageContentType.STICKER;case o("MAWMsgType").MSG_TYPE.GIF:return o("EchoMessage").EchoXMessageContentType.GIF;case o("MAWMsgType").MSG_TYPE.XMA:return o("EchoMessage").EchoXMessageContentType.XMA;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("EchoMessage").EchoXMessageContentType.DOCUMENT;case o("MAWMsgType").MSG_TYPE.REACTION:return o("EchoMessage").EchoXMessageContentType.REACTION;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("EchoMessage").EchoXMessageContentType.UNSEND;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("EchoMessage").EchoXMessageContentType.BUMP;default:return o("EchoMessage").EchoXMessageContentType.UNKNOWN}}l.echoSetStringField=p,l.echoSetIntField=_,l.echoSetBooleanField=f,l.echoSetAddressField=g,l.echoSetAddressListField=h,l.echoEncodeFields=y,l.convertMediaKeyToString=C,l.convertDbMsgTypeToXMessageContentType=b}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f="Message-ID",g="Thread-ID",h="Sort-Order",y="Display-Timestamp",C="Authoritative-Timestamp",b="From",v="Text",S="Text-Size",R="Send-Error",L="Is-Tombstoned",E="Expire-Timestamp",k="Delete-Timestamp",I="Ephemeral-Duration",T="Message-Content-Type",D="X-Message-Content-Type",x="Message-Content-Subtype",$="Is-Forwarded",P="X-Offline-Threading-ID",N="X-Thread-ID",M="X-Message-Placeholder-Type",w="Reactions",A="Reaction-Authoritative-Timestamps",F="X-Reaction-Offline-Threading-IDs",O="Echo-Serialization-Origin",B="Revoke-Sent-Timestamp",W="Revoke-Unsent-Timestamp",q="Edit-Count",U="Edit-Contents-",V="Edit-Timestamps-",H="Group-ID",G="Group-Index",z="Group-Size",j="Receiver-Fetch-Id",K="Message-Ephemerality-Type",Q=1,X=(_=n("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),Y=_({NONE:"none",UNSEND:"unsend"}),J=_({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),Z=_({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),ee=_({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),te=_({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function ne(e){var t=new Map;return de(t,e),"mediaData"in e&&e.mediaData&&o("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(t,e.mediaData),o("EchoEncodingUtils").echoEncodeFields(t)}function re(e,t){var n,r=[],a=0,i=new Set;return t.forEach(function(n,a,l){var s=a.startsWith(U),u=a.startsWith(V);if(s||u){var c=a.slice(s?U.length:V.length);if(!i.has(c)){var d,m;i.add(c);var p=(d=o("EchoDecodingUtils").echoDecodeStringField(t,""+U+c).result)!=null?d:"",_=((m=o("EchoDecodingUtils").echoDecodeIntField(t,""+V+c).result)!=null?m:0)/1e3;r.push({messageId:c,originalMessageId:e,text:p,timestamp:_})}}}),a=(n=o("EchoDecodingUtils").echoDecodeIntField(t,q).result)!=null?n:0,{editCount:a,editHistory:r}}function oe(t){var n=o("EchoDecodingUtils").echoDecodeFields(t);if(n.size===0)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"]))),null;var a=o("EchoDecodingUtils").echoDecodeStringField(n,f),i=o("EchoDecodingUtils").echoDecodeStringField(n,g),l=o("EchoDecodingUtils").echoDecodeIntField(n,h),_=o("EchoDecodingUtils").echoDecodeIntField(n,y),q=o("EchoDecodingUtils").echoDecodeStringField(n,T),U=o("EchoDecodingUtils").echoDecodeStringField(n,D),V=o("EchoDecodingUtils").echoDecodeStringField(n,x);if(a.success&&i.success&&l.success){var H=a.result;if(H==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded messageId cannot be null");var G=i.result;if(G==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded threadId cannot be null");var z=q==null?void 0:q.result;if(z==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded contentTypeString cannot be null");var X=re(H,n),Z=X.editCount,ee=X.editHistory,te={contentSubtype:se(V.result),contentType:ie(z),displayTimestampMs:_.success?_.result:l.result,editCount:Z,editHistory:ee,messageId:H,sortOrderMs:l.result,threadId:G},ne=le(U.result);ne!=null&&(te.xContentType=ne);var oe=o("EchoDecodingUtils").echoDecodeAddressField(n,b);oe.success&&oe.result!=null&&(te.from=oe.result);var de=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,L);de.success&&de.result!=null&&(te.isTombstoned=de.result);var me=o("EchoDecodingUtils").echoDecodeStringField(n,v);me.success&&me.result!=null&&(te.text=me.result);var pe=o("EchoDecodingUtils").echoDecodeStringField(n,S);if(pe.success&&pe.result!=null){var _e=ae(pe.result);te.textSize=_e}var fe=o("EchoDecodingUtils").echoDecodeStringField(n,M);if(fe.success&&fe.result!=null){var ge=ue(fe.result);te.xMessagePlaceholderType=ge}var he=o("EchoDecodingUtils").echoDecodeStringField(n,R);he.success&&he.result!=null&&(te.sendError=he.result);var ye=o("EchoDecodingUtils").echoDecodeNullableIntField(n,E);ye.success&&ye.result!=null&&(te.expireTimestampMs=ye.result);var Ce=o("EchoDecodingUtils").echoDecodeNullableIntField(n,k);Ce.success&&Ce.result!=null&&(te.deleteTimestampMs=Ce.result);var be=o("EchoDecodingUtils").echoDecodeNullableIntField(n,I);be.success&&be.result!=null&&(te.ephemeralDurationInSec=be.result);var ve=o("EchoDecodingUtils").echoDecodeStringField(n,K);ve.success&&ve.result!=null&&ve.result==="view_once"&&(te.viewOnce=!0);var Se=o("EchoDecodingUtils").echoDecodeNullableIntField(n,C);Se.success&&Se.result!=null&&(te.authoritativeTimestampMs=Se.result);var Re=o("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(n);Re.length>0&&(te.receiptStatusList=Re);var Le=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,$);Le.success&&Le.result!=null&&(te.isForwarded=Le.result),o("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(n,te);var Ee=o("EchoDecodingUtils").echoDecodeStringField(n,P);Ee.success&&Ee.result!=null&&(te.xOfflineThreadingId=Ee.result);var ke=o("EchoDecodingUtils").echoDecodeStringField(n,N);ke.success&&ke.result!=null&&(te.xThreadId=ke.result);var Ie=o("EchoDecodingUtils").echoDecodeStringField(n,O);Ie.success&&Ie.result!=null&&(te.serializationOrigin=ce(Ie.result));var Te=o("EchoDecodingUtils").echoDecodeNullableIntField(n,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);te.version=Te.success&&Te.result!=null?Te.result:Q;var De=o("EchoDecodingUtils").echoDecodeAddressListField(n,w);De.success&&De.result!=null&&(te.reactions=De.result);var xe=o("EchoDecodingUtils").echoDecodeAddressListField(n,A);xe.success&&xe.result!=null&&(te.reactionAuthoritativeTimestampMs=xe.result);var $e=o("EchoDecodingUtils").echoDecodeAddressListField(n,F);$e.success&&$e.result!=null&&(te.reactionXOfflineThreadingIds=$e.result);var Pe=o("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(n);Pe!=null&&(te.quoteData=Pe);var Ne=(te==null?void 0:te.contentType)===J.XMA&&n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS)),Me=n.has(j);if(n.has(j)){var we=o("EchoMessageMediaFieldUtils").decodeReceiverFetchData(n),Ae=o("EchoDecodingUtils").echoDecodeStringField(n,j),Fe=Ae.result,Oe=Ae.success;we==null||!Oe||Fe==null?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode media data for Receiver Fetch, Message origin: ",""])),te.serializationOrigin):(te.receiverFetchData=we,te.receiverFetchId=Fe)}if(((te==null?void 0:te.contentType)===J.MEDIA||Ne)&&!Me){var Be=o("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(n,te==null?void 0:te.contentType,te==null?void 0:te.xContentType),We="[labyrinth_web] mandatory media data is missing from media message, msgId: "+te.messageId+".";Be!=null?(Be.length!==1&&Be.length!==2&&((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin)),te.mediaData=Be[0],Be.length===2&&(te.previewMediaData=Be[1])):((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin))}if(te.contentType===J.PLACEHOLDER&&te.contentSubtype===Y.UNSEND){var qe=o("EchoDecodingUtils").echoDecodeNullableIntField(n,B);qe.success&&qe.result!=null&&(te.revokeSentTimestampMs=qe.result);var Ue=o("EchoDecodingUtils").echoDecodeNullableIntField(n,W);Ue.success&&Ue.result!=null&&(te.revokeUnsentTimestampMS=Ue.result)}if(te.contentType===J.XMA){var Ve=o("EchoMessageXMAFieldUtils").decodeXMAFields(n);if(Ve!=null)te.xmaData=Ve;else return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""])),te.messageId),null}return te}else return null}function ae(e){var t;return(t=X.cast(e))!=null?t:X.NONE}function ie(e){var t;return(t=J.cast(e))!=null?t:J.TEXT}function le(e){return Z.cast(e)}function se(e){var t;return(t=Y.cast(e))!=null?t:Y.NONE}function ue(e){var t;return(t=ee.cast(e))!=null?t:ee.NO_PLACEHOLDER}function ce(e){var t;return(t=te.cast(e))!=null?t:te.UNKNOWN}function de(e,t){var n,r;(r=o("EchoEncodingUtils")).echoSetStringField(e,f,t.messageId),r.echoSetStringField(e,g,t.threadId),r.echoSetIntField(e,h,t.sortOrderMs),r.echoSetIntField(e,y,t.displayTimestampMs),r.echoSetIntField(e,C,t.authoritativeTimestampMs),r.echoSetAddressField(e,b,t.from),r.echoSetStringField(e,v,t.text),t.textSize!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.textSize),t.xMessagePlaceholderType!=null&&o("EchoEncodingUtils").echoSetStringField(e,M,t.xMessagePlaceholderType),o("EchoEncodingUtils").echoSetStringField(e,R,t.sendError),o("EchoEncodingUtils").echoSetBooleanField(e,L,t.isTombstoned),o("EchoEncodingUtils").echoSetIntField(e,E,t.expireTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,k,t.deleteTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,I,t.ephemeralDurationInSec),t.contentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.contentType),t.xContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,D,t.xContentType),o("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(e,t.receiptStatusList),o("EchoEncodingUtils").echoSetBooleanField(e,$,t.isForwarded),o("EchoEncodingUtils").echoSetStringField(e,P,t.xOfflineThreadingId),o("EchoEncodingUtils").echoSetStringField(e,N,t.xThreadId),o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,t.version),t.contentSubtype!=null&&o("EchoEncodingUtils").echoSetStringField(e,x,t.contentSubtype),o("EchoEncodingUtils").echoSetAddressListField(e,w,t.reactions),o("EchoEncodingUtils").echoSetAddressListField(e,A,t.reactionAuthoritativeTimestampMs),o("EchoEncodingUtils").echoSetAddressListField(e,F,t.reactionXOfflineThreadingIds),o("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(e,t),t.serializationOrigin!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.serializationOrigin),t.revokeSentTimestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,B,t.revokeSentTimestampMs),t.revokeUnsentTimestampMS!=null&&o("EchoEncodingUtils").echoSetIntField(e,W,t.revokeUnsentTimestampMS),o("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(e,t);var a=t.xmaData;a!=null&&o("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(e,a),((n=t.editHistory)==null?void 0:n.length)>0&&(o("EchoEncodingUtils").echoSetIntField(e,q,t.editCount),t.editHistory.forEach(function(t){var n=t.messageId;n!=null&&(o("EchoEncodingUtils").echoSetStringField(e,U+n,t.text),o("EchoEncodingUtils").echoSetIntField(e,V+n,t.timestamp*1e3))})),t.receiverFetchId!=null&&o("EchoEncodingUtils").echoSetStringField(e,j,t.receiverFetchId)}l.ECHO_SERIALIZATION_ORIGIN=O,l.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=q,l.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=U,l.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=V,l.ECHO_MESSAGE_FIELD_GROUP_ID=H,l.ECHO_MESSAGE_FIELD_GROUP_INDEX=G,l.ECHO_MESSAGE_FIELD_GROUP_SIZE=z,l.ECHO_MESSAGE_FIELD_RECEIVER_FETCH_ID=j,l.ECHO_MESSAGE_FIELD_NAME_EPHEMERALITY_TYPE=K,l.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=Q,l.MessageTextSize=X,l.EchoMessageContentSubtype=Y,l.EchoMessageContentType=J,l.EchoXMessageContentType=Z,l.EchoMessagePlaceholderType=ee,l.EchoSerializationOriginType=te,l.encodeEchoMessage=ne,l.decodeEchoMessage=oe}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R="X-Object-Id",L="X-Attachment-Object-Ids",E="Attachment-Type",k="Content-Type",I="X-Encrypted-Hash",T="X-Attachment-Type",D="X-Backup-Ent-Fbid",x="X-Backup-Status",$="X-Content-Type",P="X-Direct-Path",N="Height",M="X-Media-Key",w="X-Media-Key-Timestamp",A="Playable-Duration",F="Preview-Height",O="Preview-Content-Type",B="Preview-Width",W="Size",q="Width",U="X-Plaintext-Hash",V="File-Name",H="Header-Attribution-Content-Type",G=(S=n("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),z=S({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),j=S({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),K=S({FULL:"full",PREVIEW:"preview"});function Q(t,n){var r=t.attachmentObjectId,a=t.attachmentType,i=t.backupEntFbid,l=t.directPath,p=t.filename,_=t.encryptedHash,f=t.height,g=t.mediaBackupStatus,h=t.mediaContentType,y=t.mediaKey,C=t.mediaKeyTimestamp,b=t.mediaPlayableDuration,v=t.plaintextHash,S=t.previewContentHeight,R=t.previewContentType,L=t.previewContentWidth,E=t.size,k=t.width,I=t.xAttachmentType,T=t.xContentType,D=t.xmaData,x=t.mediaEntryData;if(r==null)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields, msgId: ",""])),n);else if(a==null)o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields, msgId: ",""])),n);else if(l==null)o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields, msgId: ",""])),n);else if(v==null)o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields, msgId: ",""])),n);else if(T==null)o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields, msgId: ",""])),n);else if(I==null)o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields, msgId: ",""])),n);else return{attachmentObjectId:r,attachmentType:a,backupEntFbid:i,directPath:l,encryptedHash:_,filename:p,height:f,mediaBackupStatus:g,mediaContentType:h,mediaEntryData:x,mediaKey:y,mediaKeyTimestamp:C,mediaPlayableDuration:b,plaintextHash:v,previewContentHeight:S,previewContentType:R,previewContentWidth:L,size:E,width:k,xAttachmentType:I,xContentType:T,xmaData:D}}function X(e,t){var n;(n=o("EchoEncodingUtils")).echoSetStringField(e,R,t.attachmentObjectId),n.echoSetStringField(e,E,t.attachmentType),n.echoSetStringField(e,U,t.plaintextHash),n.echoSetStringField(e,I,t.encryptedHash),n.echoSetIntField(e,W,t.size),n.echoSetStringField(e,M,t.mediaKey),n.echoSetIntField(e,w,t.mediaKeyTimestamp),n.echoSetStringField(e,P,t.directPath),t.mediaContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.mediaContentType),o("EchoEncodingUtils").echoSetIntField(e,q,t.width),o("EchoEncodingUtils").echoSetIntField(e,N,t.height),t.previewContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.previewContentType),t.headerAttributionContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,H,t.headerAttributionContentType),o("EchoEncodingUtils").echoSetIntField(e,B,t.previewContentWidth),o("EchoEncodingUtils").echoSetIntField(e,F,t.previewContentHeight),o("EchoEncodingUtils").echoSetIntField(e,A,t.mediaPlayableDuration),t.xAttachmentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.xAttachmentType),o("EchoEncodingUtils").echoSetStringField(e,$,t.xContentType),o("EchoEncodingUtils").echoSetStringField(e,D,t.backupEntFbid),o("EchoEncodingUtils").echoSetStringField(e,x,t.mediaBackupStatus),o("EchoEncodingUtils").echoSetStringField(e,V,t.filename)}function Y(e,t,n){var r={},a=!1,i=!1,l=!1;if(ne(e)){var s=re(e,t,n);if(s==null)return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""])),t,n),null;s.length!==2&&o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"])));var u=!1,c=!1,d=!1,m=s[0],f=s[1],g={};if(a=ee(e,r,m),u=ee(e,g,f),i=Z(e,r,t,m,m),c=Z(e,g,t,f,m),l=J(e,r,m),d=J(e,g,f),!a||!i||!l||!u||!c||!d)return null;var h=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,y=Q(r,h),C=Q(g,h);if(y!=null&&C!=null)return[y,C]}else{if(a=ee(e,r),i=Z(e,r,t),l=J(e,r),!a||!i||!l)return null;var b=Q(r);if(b!=null)return[b]}return null}function J(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=[{fieldName:"height",id:N},{fieldName:"width",id:q},{fieldName:"size",id:W},{fieldName:"previewContentHeight",id:F},{fieldName:"previewContentWidth",id:B},{fieldName:"mediaKeyTimestamp",id:n!=null?n+"-"+w:w}],s=[{attachmentTypes:[j.VIDEO,j.AUDIO],fieldName:"mediaPlayableDuration",id:A}];for(var u of s){var c=u.attachmentTypes,d=u.fieldName,m=u.id,p=o("EchoDecodingUtils").echoDecodeIntField(e,m),_=p.result,g=p.success;if(g&&_!=null)t[d]=_;else if(!(t.xAttachmentType!=null&&!te(c,t.xAttachmentType)||t.attachmentType===G.XMA))return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: "," xOfflineThreadingId: ",""])),d,t.xAttachmentType,t.attachmentType,i,a),!1}return l.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeIntField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function Z(e,t,n,r,a){var i,l=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,s,u,c,d=(i=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?i:"",m=[{fieldName:"filename",id:V}];r!=null&&a!=null?(t.attachmentObjectId=r,s=[{fieldName:"plaintextHash",id:r+"-"+U},{fieldName:"directPath",id:r+"-"+P},{fieldName:"xContentType",id:r+"-"+$}],m.push({fieldName:"mediaKey",id:r+"-"+M}),u=a+"-"+D,c=r+"-"+I):(s=[{fieldName:"attachmentObjectId",id:R},{fieldName:"plaintextHash",id:U},{fieldName:"directPath",id:P},{fieldName:"xContentType",id:$}],m.push({fieldName:"mediaKey",id:M}),u=D,c=I),m.push({fieldName:"backupEntFbid",id:u}),m.push({fieldName:"mediaContentType",id:k}),m.push({fieldName:"encryptedHash",id:c});var p=a!=null?a+"-"+x:x;m.push({fieldName:"mediaBackupStatus",id:p});var _=[];for(var f of s){var y=f.fieldName,C=f.id,b=o("EchoDecodingUtils").echoDecodeStringField(e,C),v=b.result,S=b.success;S&&v!=null?t[y]=v:_.push(y)}if(_.length>0){var L=_.join(", ");return n===o("EchoMessage").EchoMessageContentType.XMA?o("WALogger").WARN(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""])),L,t.attachmentType,d):o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),L,t.attachmentType,d,l),!1}return m.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeStringField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function ee(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=o("EchoDecodingUtils").echoDecodeStringField(e,E),s=l.result==="file"?G.DOCUMENT:G.cast(l.result);s!=null&&(t.attachmentType=s);var u=o("EchoDecodingUtils").echoDecodeStringField(e,O),c=z.cast(u.result);c!=null&&(t.previewContentType=c);var d=o("EchoDecodingUtils").echoDecodeStringField(e,H),m=d.result;m!=null&&(t.headerAttributionContentType=m);var p=o("EchoDecodingUtils").echoDecodeStringField(e,n!=null?n+"-"+T:T),_=null;return p.success&&p.result!=null&&(_=oe(p.result),_!=null&&(t.xAttachmentType=_)),s!=null&&(c!=null||s===G.DOCUMENT||s===G.PTT)?!0:(o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),s,c,p,i,a),!1)}function te(e,t){return e.reduce(function(e,n){return e||n===t},!1)}function ne(e){return e.has(L)}function re(e,t,n){var r=o("EchoDecodingUtils").echoDecodeObjectIdListField(e,L),a=r.result,i=r.success;if(!i||a==null||a.length!==2)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""])),a,t,n),null;var l=a.find(function(t){var n=t+"-"+x,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null)return!0});if(l!=null){var s=l===a[0]?a[1]:a[0];return[l,s]}if(l=a.find(function(t){var n=t+"-"+$,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null&&K.cast(a)===K.FULL)return!0}),l!=null){var u=l===a[0]?a[1]:a[0];return[l,u]}return a}function oe(e){var t=j.cast(e);return t==null&&o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""])),e),t!=null?t:j.INVALID}function ae(e){var t={},n=ee(e,t);if(!n)return null;var r=o("EchoDecodingUtils").echoDecodeStringField(e,k),a=o("EchoDecodingUtils").echoDecodeIntField(e,N),i=o("EchoDecodingUtils").echoDecodeIntField(e,q),l=o("EchoDecodingUtils").echoDecodeStringField(e,E);return!r.success||!a.success||!i.success||!l.success||r.result==null||a.result==null||i.result==null||l.result==null?(o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing media fields for receiver fetch"]))),null):{mimetype:r.result,previewHeight:a.result,previewWidth:i.result,type:l.result}}l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=R,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=L,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=E,l.AttachmentType=G,l.EchoMessageMediaPreviewType=z,l.EchoMessageActMediaAttachmentType=j,l.convertMediaMetadataDetailsToMediaMetadata=Q,l.echoMessageSetMediaMetadataFields=X,l.echoMessageDecodeMediaDataFields=Y,l.setMediaIntFields=J,l.setMediaEnumFields=ee,l.getAttachmentObjectIdsFromMultiBlobMediaMsg=re,l.decodeReceiverFetchData=ae}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){t.groupId!=null&&o("EchoEncodingUtils").echoSetStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,t.groupId),t.groupIndex!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,t.groupIndex),t.groupSize!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,t.groupSize)}function s(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);n.success&&n.result!=null&&(t.groupId=n.result);var r=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);r.success&&r.result!=null&&(t.groupIndex=r.result);var a=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);a.success&&a.result!=null&&(t.groupSize=a.result)}l.echoMessageSetMediaGroupFields=e,l.decodeMessageMediaGroupFields=s}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(t,n,r,o,a,i,l){"use strict";var e="Reply-Message-Id",s="Reply-Message-Sender",u="Reply-Sort-Order",c="Reply-Type",d="Reply-Status",m=n("$InternalEnum").Mirrored(["BUMP"]),p=n("$InternalEnum")({VALID:"valid"});function _(e){var t={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},n=g(e,t),r=h(e,t),o=y(e,t),a=C(e,t);return!n||!r||!o||!a?null:t}function f(t,n){var r=n.quoteData;r!=null&&(o("EchoEncodingUtils").echoSetStringField(t,e,r.quoteMessageId),o("EchoEncodingUtils").echoSetAddressField(t,s,r.quoteMessageSender),o("EchoEncodingUtils").echoSetIntField(t,u,r.quoteSortOrderInMs),r.status!=null&&o("EchoEncodingUtils").echoSetStringField(t,d,r.status),r.replyType!=null&&o("EchoEncodingUtils").echoSetStringField(t,c,r.replyType))}function g(e,t){var n=[{fieldName:"quoteMessageSender",id:s}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeAddressField(e,i),u=l.result,c=l.success;if(c&&u!=null)t[a]=u;else return!1}return!0}function h(t,n){var r=[{fieldName:"quoteMessageId",id:e}];for(var a of r){var i=a.fieldName,l=a.id,s=o("EchoDecodingUtils").echoDecodeStringField(t,l),u=s.result,c=s.success;if(c&&u!=null)n[i]=u;else return!1}return!0}function y(e,t){var n=[{fieldName:"quoteSortOrderInMs",id:u}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeIntField(e,i),s=l.result,c=l.success;if(c&&s!=null)t[a]=s;else return!1}return!0}function C(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,c),r=m.cast(n.result);r!=null&&(t.replyType=r);var a=o("EchoDecodingUtils").echoDecodeStringField(e,d),i=p.cast(a.result);return i!=null&&(t.status=i),!0}l.EchoMessageQuoteReplyType=m,l.EchoMessageQuoteStatus=p,l.echoMessageDecodeQuoteFields=_,l.echoMessageSetQuoteFields=f}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s="Receipt-Status",u="Receipt-Timestamp",c=n("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function d(e,t){t==null||t.length===0||t.forEach(function(t){o("EchoEncodingUtils").echoSetStringField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,s),t.status),t.timestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,u),t.timestampMs)})}function m(e){var t=[];return p(e).forEach(function(n){var r=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,s),a=o("EchoDecodingUtils").echoDecodeStringField(e,r);if(a.success){var i,l=(i=c.cast(a.result))!=null?i:c.UNKNOWN,d=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,u),m=o("EchoDecodingUtils").echoDecodeNullableIntField(e,d);m.result!=null?t.push({address:n,status:l,timestampMs:m.result}):t.push({address:n,status:l})}}),t}function p(t){var n=new Set;for(var r of t.keys())if(r.includes(s))try{var a=r.split("@"),i=a[0],l=_(a[1]);n.add({localKey:i,transportKey:l})}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""])),t)}return Array.from(n)}function _(e){var t=e.split(s);return t[0].split("-")[0]}l.MessageReceiptStatus=c,l.echoMessageSetReceiptStatusDataFields=d,l.echoMessageDecodeReceiptStatusDataFields=m}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="XMA-Default-CTA",m="XMA-Gating-Type",p="XMA-Header-Subtitle",_="XMA-Header-Title",f="XMA-Is-Tombstoned",g="XMA-Layout-Type",h="XMA-Max-Subtitle-Num-Lines",y="XMA-Max-Title-Num-Lines",C="XMA-Subtitle-Text",b="XMA-Target-Expiry",v="XMA-Target-ID",S="XMA-Target-Type",R="XMA-Target-Username",L="XMA-Title-Text",E="XMA-Content-Ref",k="XMA-Dataclass",I=n("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT","STANDARD_DXMA","LIST_DXMA","GRID"]),T=n("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","FB_PROFILE_DIRECTORY_ITEM","FB_FEED_POST_REACTION_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT","FB_SHORT","MSG_LOCATION_SHARING","MSG_LOCATION_SHARING_V2","MSG_MEMORIES_SHARE"]),D=n("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function x(e,t){t.xmaLayoutType!=null&&o("EchoEncodingUtils").echoSetStringField(e,g,t.xmaLayoutType),t.xmaTargetType!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.xmaTargetType),o("EchoEncodingUtils").echoSetStringField(e,R,t.xmaTargetUsername),o("EchoEncodingUtils").echoSetStringField(e,v,t.xmaTargetId),t.xmaTargetExpiry!=null&&o("EchoEncodingUtils").echoSetIntField(e,b,t.xmaTargetExpiry),o("EchoEncodingUtils").echoSetStringField(e,d,t.xmaDefaultCTA),o("EchoEncodingUtils").echoSetStringField(e,_,t.xmaHeaderTitle),o("EchoEncodingUtils").echoSetStringField(e,p,t.xmaHeaderSubtitle),o("EchoEncodingUtils").echoSetStringField(e,L,t.xmaTitleText),o("EchoEncodingUtils").echoSetStringField(e,C,t.xmaSubtitleText),t.xmaMaxTitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,y,t.xmaMaxTitleNumLines),t.xmaMaxSubtitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,h,t.xmaMaxSubtitleNumLines),t.xmaGatingType!=null&&o("EchoEncodingUtils").echoSetStringField(e,m,t.xmaGatingType),t.xmaDataclass!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.xmaDataclass),o("EchoEncodingUtils").echoSetBooleanField(e,f,t.xmaIsTombstoned),t.xmaContentRef!=null&&o("EchoEncodingUtils").echoSetStringField(e,E,t.xmaContentRef)}function $(t){var n=M(t,f);if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"]))),null;var r=D.cast(o("EchoDecodingUtils").echoDecodeStringField(t,m).result),a=I.cast(o("EchoDecodingUtils").echoDecodeStringField(t,g).result),i=T.cast(o("EchoDecodingUtils").echoDecodeStringField(t,S).result);return{xmaContentRef:P(t,E),xmaDataclass:P(t,k),xmaDefaultCTA:P(t,d),xmaGatingType:r,xmaHeaderSubtitle:P(t,p),xmaHeaderTitle:P(t,_),xmaIsTombstoned:n,xmaLayoutType:a,xmaMaxSubtitleNumLines:N(t,h),xmaMaxTitleNumLines:N(t,y),xmaSubtitleText:P(t,C),xmaTargetExpiry:N(t,b),xmaTargetId:P(t,v),xmaTargetType:i,xmaTargetUsername:P(t,R),xmaTitleText:P(t,L)}}function P(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"])),t)}function N(e,t){var n=o("EchoDecodingUtils").echoDecodeIntField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}function M(e,t){var n=o("EchoDecodingUtils").echoDecodeBooleanField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}l.XMALayoutType=I,l.XMAContentType=T,l.XMAGatingType=D,l.echoMessageSetXMAFields=x,l.decodeXMAFields=$}),98);
__d("EncryptedBackupsResignCdnUrl",["EBLSResignCdnUrlDeferred","WAResultOrError","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new Map;function u(e){return s.get(e)}function c(t){var n=t.deliveryObjectId,r=t.logger,a=t.mediaDownloadFlow,i=t.mediaKey,l=t.mediaType,s=t.msgId,u=t.protocolMsgId,c=t.sortOrderMs;return a.addPoint("resign_cdn_url_start"),d({deliveryObjectId:n,mediaDownloadFlow:{addAnnotations:function(t){a==null||a.addAnnotations(babelHelpers.extends({},t))},addPoint:function(t,n){a==null||a.addPoint(t,babelHelpers.extends({},n))}},mediaKey:i,mediaType:l,msgId:s,protocolMsgId:u,sortOrderMs:c}).then(function(e){return e.success?(a==null||a.addPoint("resign_cdn_url_end"),e):(a.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:e.error}}),e)}).catch(function(t){return r.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["resignCdnUrl runtime-error: ",""])),t),a.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(t)}}),o("WAResultOrError").makeError("resign-cdn-url-runtime-error")})}async function d(e){var t=e.deliveryObjectId,n=e.mediaDownloadFlow,r=e.mediaKey,a=e.mediaType,i=e.msgId,l=e.protocolMsgId,s=e.sortOrderMs,u=await o("EBLSResignCdnUrlDeferred").eblsResignCdnUrlWithGraphQL({chatJid:l.chat,deliveryObjectId:t,externalId:l.externalId,mediaDownloadFlow:n,mediaKey:r,mediaType:a,sortOrderMs:s});return u.success?o("WAResultOrError").makeResult(u.value):u}l.getRestoredCdnUrlResolvable=u,l.resignCdnUrl=c}),98);
__d("IGDWEBUploadMessageUtils",["I64","MAWExtractMsFromExternalId","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){var r=o("MAWExtractMsFromExternalId").extractMsFromExternalId((s||(s=o("I64"))).of_string(t));return r==null&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Could not extract ms from externalId: ",""])),t),o("WATimeUtils").castToMillisTime(Number(n)*1e3+(r!=null?r:0))}l.generateProtobufServerTs=u}),98);
__d("EncryptedBackupsUploadEntity",["$InternalEnum","EncryptedBackupsUtils","IGDWEBUploadMessageUtils","WAArmadilloBackupMessage.pb","WAByteArray","WAGlobals","WAJids","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e instanceof ArrayBuffer?new Uint8Array(e):e}var s=n("$InternalEnum").Mirrored(["NEEDS_BACKUP","COMPLETED","NEEDS_BACKUP_RETRY","PERMANENT_FAILURE","EXPIRED","THREAD_DELETED","DELETION_PURGED","MESSAGE_DELETED","UPLOADING"]),u=n("$InternalEnum")({INVALID:"-1",IMAGE:"0",PTT:"1",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",XMA:"22",MESSENGER_PREVIEW:"25"});function c(e){return e}function d(e){var t=e.messageApplication,n=e.msgId,r=e.reportingMeta,a=e.sortOrderMs,i=o("WAJids").authorToUserId(n.author,o("WAJids").extractUserId(o("WAGlobals").getMyUserJid()));return o("encodeProtobuf").encodeProtobuf(o("WAArmadilloBackupMessage.pb").BackupMessageSpec,o("EncryptedBackupsUtils").asBackupMessage(i,n.externalId,a,r!=null?r:{frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},t)).readByteArrayView()}function m(e){return o("WAByteArray").uint8ArrayToBuffer(e)}function p(e){var t=e.attachmentContext,n=e.backupDirective,r=e.dbMsgType,a=e.instanceKey,i=e.isOpenEB,l=e.isRetroactiveUpload,u=e.legacyAttachmentContext,c=e.messageApplication,m=e.msgId,p=e.originalMsgProtocolId,_=e.reportingMeta,f=e.retryCount,g=e.senderId,h=e.serverTs,y=e.sortOrderMs,C=e.tags,b=e.triggerSource,v=d({messageApplication:c,msgId:m,reportingMeta:_,sortOrderMs:n.actionType===4?o("IGDWEBUploadMessageUtils").generateProtobufServerTs(m.externalId,h):y}),S={backupActionType:n.actionType,backupDirective:n,dbMsgType:r,failTsMs:o("WATimeUtils").castToMillisTime(0),instanceKey:a,isOpenEB:i,isRetroactiveUpload:l,msgId:m,msgIdKey:o("EncryptedBackupsUtils").convertWAMsgIdToStringId(m),msgType:"text",originalMsgProtocolId:p,protobuf:v,retryCount:f,senderId:g,serverTs:h,sortOrderMs:y,supplementalKey:n.supplementalKey,tags:C,triggerSource:b,uploadStatus:s.NEEDS_BACKUP,uploadTsSec:o("WATimeUtils").unixTime()};return t!=null&&(S=babelHelpers.extends({},S,{attachmentContext:t,legacyAttachmentContext:u,msgType:"media"})),S}l.toEbBackupMessageBytes=e,l.EbUploadStatus=s,l.AttachmentContextMediaType=u,l.castToEBQueueId=c,l.encodeBackupMessage=d,l.getEbBackupMessageBytesBuffer=m,l.asEBUploadEntity=p}),98);
__d("validateMAWMediaAndComposeEntryForProtoMsg",["FBLogger","WAMediaUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbMedia is null in validateMediaAndComposeEntryForProtoMsg");var n=null;if(e!=null&&t.mediaId!=null){if(!t.msgIds.includes(e))throw r("FBLogger")("messenger_web").mustfixThrow("the media ("+t.mediaId+") is not linked to the msg ("+e+")");n=t.mediaEntries.get(e)}else n=t.mediaEntry;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media entry not found in validateMediaAndComposeEntryForProtoMsg");var o=t.plaintextHash,a=s(o,n);return[t,a]}function s(e,t){var n=o("WAMediaUtils").mediaEntryDataToRawData(e,t);if(n.fileSha256==null||n.mediaKey==null||n.fileEncSha256==null||n.directPath==null||n.mediaKeyTimestamp==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing fields in mediaEntryData");return babelHelpers.extends({},n,{directPath:n.directPath,fileEncSha256:n.fileEncSha256,fileSha256:n.fileSha256,mediaKey:n.mediaKey,mediaKeyTimestamp:n.mediaKeyTimestamp})}l.validateMAWMediaAndComposeEntryForProtoMsg=e,l.validateMediaEntry=s}),98);
__d("MAWAsArmadilloApplication",["FBLogger","MAWEncodeMediaTransportProtocol","MAWMsg","MAWMsgType","MAWVault","MAWXMAEncodeUtils","WAArmadilloApplication.pb","WAGlobals","WAJids","WATimeUtils","getErrorSafe","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.XMA:{if((t==null?void 0:t.xma)==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA content should have XMA payload");var i=o("MAWXMAEncodeUtils").encodeXMA(e,t);return i}case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return u(e,n);case o("MAWMsgType").MSG_TYPE.RAVEN:return p(e,a);case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d(e);default:throw r("FBLogger")("messenger_web").mustfixThrow(e.type+" should not be handled as ArmadilloApplication")}}function u(e,t){var n;if(e.type!==o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE||((n=e.quote)==null?void 0:n.content)==null||t==null)return null;var r=e.quote.content,a=o("WAJids").interpretAndValidateJid(t),i=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author,l=o("WAJids").isAuthorMe(r.author)?o("WAGlobals").getMyUserJid():r.author;function s(){return a.jidType==="msgrUser"?l:a.jidType==="group"?a.groupJid:null}function u(){return i===l?null:a.jidType==="group"?l:null}var c=s(),d=u();if(c==null)return null;if(e)return{payload:{content:{bumpExistingMessage:{key:{fromMe:i===l,id:r.externalId,participant:d,remoteJid:c}}}}}}function c(e){var t,n,r,a=(t=e.quote)==null?void 0:t.content,i=a==null||(n=a.msgContent)==null?void 0:n.content,l=a==null?void 0:a.expirationTs,s=e==null||(r=e.msgContent)==null?void 0:r.content;if(a==null||i==null||s==null)return null;var u=l!=null?o("WATimeUtils").castUnixTimeToMillisTime(l):void 0;return{payload:{content:{noteReplyMessage:{noteText:{text:o("MAWVault").unvault(i)},noteTimestampMs:u,textContent:{text:o("MAWVault").unvault(s)}}}}}}function d(e){var t=e.ravenActionToMsgExternalId;if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg ravenActionToMsgExternalId is null in encodeRavenActionMessage");var n=Number(e.actionType),a;if(n===0)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.PLAYED;else if(n===1)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.SCREENSHOT;else if(n===2)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.FORCE_DISABLE;else throw r("FBLogger")("messenger_web").mustfixThrow("msg actionType is not in enum in encodeRavenActionMessage");var i=e.actionTimestamp==null?Date.now():o("WATimeUtils").castUnixTimeToMillisTime(e.actionTimestamp),l={actionTimestamp:i,actionType:a,key:{id:t}};return{payload:{content:{ravenActionNotifMessage:l}}}}function m(e){return e===o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE?0:e===o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY?1:e===o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?2:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}function p(t,n){if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media is null in encodeRavenMessage");var a,i;try{var l=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(t.msgId,n);a=l[0],i=l[1]}catch(t){var s=r("getErrorSafe")(t);r("FBLogger")("messenger_web").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media entry is invalid, fallback to the placeholder: ",""])),s.message),a=void 0,i=void 0}if(a==null||i==null)return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType)}}}};switch(t.ravenMediaType){case o("MAWMsg").MAWRavenMsgMediaType.IMAGE:{var u=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),imageMessage:{payload:u,version:1}}}}}}case o("MAWMsg").MAWRavenMsgMediaType.VIDEO:{var c=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToVideoTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),videoMessage:{payload:c,version:1}}}}}}}}l.asArmadilloApplication=s,l.encodeNoteReplyMessage=c}),98);
__d("MAWAsConsumerApplication",["FBLogger","I64","LSIntEnum","MAWDbMedia","MAWEncodeMediaTransportProtocol","MAWJids","MAWMsgType","MAWVault","WAAssertUnreachable","WAConsumerApplication.pb","WAGlobals","WAJids","WAMediaTransport.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.TEXT:return p(e);case o("MAWMsgType").MSG_TYPE.IMAGE:return _(e,t);case o("MAWMsgType").MSG_TYPE.VIDEO:return C(e,t);case o("MAWMsgType").MSG_TYPE.PTT:return v(e,t);case o("MAWMsgType").MSG_TYPE.REVOKED:return R(e.revokedExternalId);case o("MAWMsgType").MSG_TYPE.GIF:return C(e,t);case o("MAWMsgType").MSG_TYPE.STICKER:return h(e,t);case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return x(e,t);case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return null;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:throw r("FBLogger")("messenger_web").mustfixThrow("Implemented ephemeral setting message in MAWAsConsumerApplication");case o("MAWMsgType").MSG_TYPE.XMA:throw r("FBLogger")("messenger_web").mustfixThrow("XMA content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support converting to protoMsg with "+e.type+" type","maw_db");case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("Raven content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.EDIT_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support editing messages right now since the sending flow is not implemented yet. ");case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return E(e,n);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:throw r("FBLogger")("messenger_web").mustfixThrow("Bump message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return T(e,a);case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll creation messages yet as the sending flow is not implemented.");case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll update messages yet as the sending flow is not implemented.");default:return r("WAAssertUnreachable")(e.type)}}function c(e,t){if(t==null)return d(e);switch(t.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return f(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.PTT:return S(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.GIF:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.STICKER:return y(e.msgId,t);default:return null}}function d(e){var t=null;if(e.type===o("MAWMsgType").MSG_TYPE.REVOKED&&e.msgContent!=null&&e.msgContent.content!=null)t=e.msgContent.content;else if(e.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME&&e.msgContent!=null)t=e.msgContent;else return null;return{payload:{content:{messageText:{mentionedJid:[],text:o("MAWVault").unvault(t)}}}}}function m(e){if(e!=null){var t=e===1?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:e===2?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;return{specialTextSize:t}}}function p(e){var t={payload:{content:{messageText:{commands:e.msgContent.commands,mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)}}}},n=m(e.specialTextSize);return n!=null&&(t.metadata=n),t}function _(e,t){return f(e.msgId,t,e)}function f(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedImageMessage(a,i,n)}function g(e){function t(){var t=o("WAJids").validateGroupJid(e.threadJid);return t!=null?t:o("WAJids").isAuthorMe(e.author)?e.threadJid:o("WAGlobals").getMyUserJid()}var n=t();return{payload:{content:{editMessage:{key:{fromMe:!0,id:e.originalMsgExternalId,remoteJid:n},message:{mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)},timestampMs:e.editTs*1e3}}}}}function h(e,t){return y(e.msgId,t)}function y(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedStickerMessage(r,a)}function C(e,t){return b(e.msgId,t)}function b(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedVideoMessage(r,a)}function v(e,t){return S(e.msgId,t)}function S(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedAudioMessage(r,a)}function R(e){return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:e}}}}}}function L(e){var t=o("WAJids").isAuthorMe(e.reactToAuthor)?o("WAGlobals").getMyUserJid():e.reactToAuthor;function n(){var n=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author;return n===t}var r=n(),a=o("WAJids").interpretAsGroupJid(e.threadJid)!=null,i={groupingKey:e.groupingKey==null?void 0:e.groupingKey,key:{fromMe:r,id:e.reactToExternalId,participant:a&&!r?t:void 0,remoteJid:e.threadJid},senderTimestampMs:e.senderTimestampMs,text:e.reaction==null?void 0:e.reaction};return{payload:{content:{reactionMessage:i}}}}function E(e,t){if(e.threadJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg threadJid is null in encodeGroupInviteMessage");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbGroupInvite is null in encodeGroupInviteMessage");var n=o("WAJids").interpretAsGroupJid(e.threadJid);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("groupJid is null in encodeGroupInviteMessage");return{payload:{content:{groupInviteMessage:{groupJid:n,groupName:e.groupName,inviteCode:t.inviteCode,inviteExpiration:t.inviteExpirationTs}}}}}function k(t){return(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(1))||(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(256))||t.textHasLinks||t.isUnsent?I(t):null}function I(e){var t,n=(t=e.mentionIds)==null||(t=t.split(","))==null?void 0:t.map(o("MAWJids").toUserJid);return{payload:{content:{messageText:{mentionedJid:n!=null?n:[],text:e.text}}}}}function T(e,t){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch id");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch info");switch(t.type){case"sticker":return D(t);default:throw r("FBLogger")("messenger_web").mustfixThrow("Unsupported receiver fetch type: "+t.type)}}function D(e){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch sticker message without receiver fetch id");var t={ancillary:{accessibilityLabel:e.accessibilitySummaryText,height:e.previewHeight,isThirdParty:!1,receiverFetchId:e.receiverFetchId,width:e.previewWidth},integral:{receiverFetchId:e.receiverFetchId,transport:{ancillary:{mimetype:o("MAWEncodeMediaTransportProtocol").STICKER_MIME_TYPE,thumbnail:{thumbnailHeight:e.previewHeight,thumbnailWidth:e.previewWidth}},integral:{}}}},n=o("encodeProtobuf").encodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,t);return{payload:{content:{stickerMessage:{sticker:{payload:n.readBuffer(),version:1}}}}}}function x(e,t){return $(e.msgId,t)}function $(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedFileMessage(r,a)}l.asConsumerApplication=u,l.deletedMsgAsConsumerApplicationForSpamReporting=c,l.encodeConsumerApplicationMetadata=m,l.encodeEditMessage=g,l.encodeReactionMessage=L,l.asConsumerApplicationLSDb=k,l.encodeReceiverFetchStickerMessage=D,l.encodeFileMessage=x}),98);
__d("WAMsgIdToMessageKey",["WAGlobals","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.chat,r=e.externalId,a=o("WAJids").isAuthorMe(t),i=o("WAJids").interpretAsGroupJid(n),l=a?o("WAGlobals").getMyUserJid():t,s=n,u=i!=null?l:void 0;return{fromMe:a,id:r,remoteJid:s,participant:u}}l.msgIdToMessageKey=e}),98);
__d("WAAsConsumerApplication",["WAAssertUnreachable","WAConsumerApplication.pb","WAMsgIdToMessageKey","WAMsgType","err"],(function(t,n,r,o,a,i,l){"use strict";var e="image/jpeg",s="video/mp4",u="audio/wav",c="image/gif",d="image/webp";function m(e){switch(e.type){case o("WAMsgType").MSG_TYPE.TEXT:return p(e);case o("WAMsgType").MSG_TYPE.REACTION:return _(e);case o("WAMsgType").MSG_TYPE.REVOKED:return f(e);default:return r("WAAssertUnreachable")(e.type)}}function p(e){var t={payload:{content:{messageText:{mentionedJid:[],text:e.msgContent.content}}}};if(e.specialTextSize!=null){var n=e.specialTextSize===1?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:e.specialTextSize===2?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;t.metadata={specialTextSize:n}}return t}function _(e){if(e.reactToMsgId==null)throw r("err")("cannot send reaction that reacts to no message");var t=o("WAMsgIdToMessageKey").msgIdToMessageKey(e.reactToMsgId),n={groupingKey:e.groupingKey==null?void 0:e.groupingKey,key:t,senderTimestampMs:e.ts,text:e.reaction==null?void 0:e.reaction};return{payload:{content:{reactionMessage:n}}}}function f(e){var t={remoteJid:e.id.chat,fromMe:!0,id:e.revokedExternalId};return{payload:{applicationData:{revoke:{key:t}}}}}l.IMAGE_MIME_TYPE=e,l.VIDEO_MIME_TYPE=s,l.AUDIO_MIME_TYPE=u,l.GIF_MIME_TYPE=c,l.STICKER_MIME_TYPE=d,l.asConsumerApplication=m,l.encodeTextMessage=p,l.encodeReactionMessage=_}),98);
__d("WAFranking",["$InternalEnum","QPLFlow","WACryptoDependencies","WACryptoHmac","WACryptoUtils","WAFrankingTypes","WAGlobals"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=0,u=n("$InternalEnum").Mirrored(["KEEP","DROP"]);function c(){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WAFrankingTypes").castToFrankingKey(t)}function d(e){return e!=null?e:s}function m(e,t){return o("WACryptoHmac").hmacSha256(e,t).then(function(e){return o("WAFrankingTypes").castToFrankingTag(new Uint8Array(e))})}async function p(e,t,n,r){switch(r){case void 0:case 0:{var a=await o("WACryptoHmac").hmacSha256(t,e);return o("WACryptoUtils").uint8ArraysEqual(new Uint8Array(a),n)}default:return!0}}async function _(e,t){var n,r,a,i=o("WAGlobals").getConfig().isFrankingDropOnInvalid(),l=o("QPLFlow").startQPLFlow(o("WAGlobals").getWaQpl().franking);if((t==null?void 0:t.frankingTag)!=null&&((n=e.metadata)==null?void 0:n.frankingKey)==null){var s;return t.frankingTag=null,t.reportingTag=null,l.endFail("missingFrankingKey",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((s=e.metadata)==null?void 0:s.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),{decision:u.KEEP,updatedReportingMeta:t}}if((t==null?void 0:t.frankingTag)!=null&&e.version==="v3"&&e.type==="subprotocol"&&((r=e.metadata)==null?void 0:r.frankingKey)!=null&&e.frankingContent!=null){var c=t.frankingTag,d=e.frankingContent,m=e.metadata.frankingVersion,_=o("WAFrankingTypes").castToFrankingKey(new Uint8Array(e.metadata.frankingKey));return _==null?(l.endFail("tagButNoKey"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}):await p(new Uint8Array(d),_,c,m)?(t.frankingKey=_,t.reportingContent=d,l.endSuccess(),{decision:u.KEEP,updatedReportingMeta:t}):(l.endFail("tagMismatch"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t})}return l.endFail("potentialDropCandidate",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((a=e.metadata)==null?void 0:a.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),o("WAGlobals").getConfig().isFrankingDropOnMissing()?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}}l.FrankingDecision=u,l.createFrankingKey=c,l.getFrankingVersion=d,l.genFrankingTag=m,l.validateFrankingTag=p,l.handleAndValidateFrankingFromIncomingMsg=_}),98);
__d("WAAsMessageApplication",["WAAsConsumerApplication","WAConsumerApplication.pb","WAFranking","WAMsgApplication.pb","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;switch(e.type){default:t=o("WAAsConsumerApplication").asConsumerApplication(e)}var n=e.forwardingScore!=null?e.forwardingScore:0,r=e.isForwarded!=null?e.isForwarded:!1,a={metadata:{chatEphemeralSetting:null,forwardingScore:n,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),isForwarded:r,quotedMessage:null}};if(t!=null){var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);a.payload={subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}return o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()}function s(e){return e}function u(e){return e.buffer}l.asMessageApplication=e,l.castToMessageApplicationBytes=s,l.castMessageApplicationBytesToBytes=u}),98);
__d("MAWAsMessageApplication",["I64","LSIntEnum","LSMessageReplySourceTypeV2","MAWAsArmadilloApplication","MAWAsConsumerApplication","MAWJids","MAWMsgType","WAArmadilloApplication.pb","WAAsMessageApplication","WAConsumerApplication.pb","WAFranking","WAGlobals","WAJids","WAMsgApplication.pb","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,a,i){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,c(e,t,n,r,a,i)).readByteArrayView())}function c(e,t,n,r,a,i){var l,s;switch(e.type){case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,void 0,t);break;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,a);break;case o("MAWMsgType").MSG_TYPE.XMA:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,r);break;default:s=o("MAWAsConsumerApplication").asConsumerApplication(e,t,n,i)}var u,c,d=e.forwardingScore!=null?e.forwardingScore:0,m=e.isForwarded!=null?e.isForwarded:!1;if(e.quote!=null){var p=e.quote;u={participant:p.content.author===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():p.content.author,stanzaId:p.content.externalId}}if(e.ephemeralSetting){var _=e.ephemeralSetting;e.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?c={ephemeralExpiration:_.ephemeralExpirationInSec,isEphemeralSettingReset:e.isEphemeralSettingReset}:c={ephemeralExpiration:_.ephemeralExpirationInSec,ephemeralSettingTimestamp:_.ephemeralLastUpdatedOrSetTimestamp*1e3}}var f={metadata:{chatEphemeralSetting:c,forwardingScore:d,frankingKey:y(e.reportingMeta),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:m,quotedMessage:u}};if(s!=null){var g=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,s);f.payload={subProtocol:{consumerMessage:{payload:g.readBuffer(),version:1}}}}else if(l!=null){var h=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,l);f.payload={subProtocol:{armadillo:{payload:h.readBuffer(),version:1}}}}return f}function d(t){var n,a=o("MAWAsConsumerApplication").asConsumerApplicationLSDb(t),i,l,u=t.isForwarded!=null?t.isForwarded:!1,c=u?1:0;t.replySourceTypeV2&&!(e||(e=o("I64"))).equal(t.replySourceTypeV2,(s||(s=o("LSIntEnum"))).ofNumber(r("LSMessageReplySourceTypeV2").NONE))&&t.replyToUserId!=null&&(i={participant:t.replyToUserId===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():o("MAWJids").toUserJid((e||(e=o("I64"))).to_string(t.replyToUserId)),stanzaId:t.messageId});var d={metadata:{chatEphemeralSetting:l,forwardingScore:c,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:(n=t==null?void 0:t.groupId)!=null?n:void 0,groupIndex:t.groupIndex!=null?(e||(e=o("I64"))).to_float(t.groupIndex):void 0,groupSize:t.groupSize!=null?(e||(e=o("I64"))).to_float(t.groupSize):void 0,isForwarded:u,quotedMessage:i}};if(a!=null){var m=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);d.payload={subProtocol:{consumerMessage:{payload:m.readBuffer(),version:1}}}}return d}function m(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,p(e)).readByteArrayView())}function p(e){var t=o("MAWAsConsumerApplication").encodeReactionMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function _(e){var t=o("MAWAsArmadilloApplication").encodeNoteReplyMessage(e);if(t==null)return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()}};var n=e.ephemeralSetting,r=n?{ephemeralExpiration:n.ephemeralExpirationInSec,ephemeralSettingTimestamp:n.ephemeralLastUpdatedOrSetTimestamp*1e3}:void 0,a=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,t);return{metadata:{chatEphemeralSetting:r,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{armadillo:{payload:a.readBuffer(),version:1}}}}}function f(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,g(e)).readByteArrayView())}function g(e){var t=o("MAWAsConsumerApplication").encodeEditMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function h(e,t){var n,r,a=o("MAWAsConsumerApplication").deletedMsgAsConsumerApplicationForSpamReporting(e,t);if(a==null)return null;var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);return{metadata:{frankingKey:y(e.reportingMeta),frankingVersion:((n=e.reportingMeta)==null?void 0:n.frankingVersion)!=null?(r=e.reportingMeta)==null?void 0:r.frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}}function y(e){return(e==null?void 0:e.frankingKey)!=null?e.frankingKey:o("WAFranking").createFrankingKey()}l.encodeMessageApplication=u,l.asMessageApplication=c,l.asMessageApplicationLSDb=d,l.encodeReactionMessageApplication=m,l.asReactionMessageApplication=p,l.asNoteReplyMessageApplication=_,l.encodeEditMessageApplication=f,l.asEditMessageApplication=g,l.deletedMsgAsMessageApplicationForSpamReporting=h}),98);
__d("MAWParseSubprotocolVersionConsts",[],(function(t,n,r,o,a,i){"use strict";var e=2,l=2,s=1,u=2,c=1,d=1;i.ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION=e,i.XMA_PREVIEW_SUBPROTOCOL_VERSION=l,i.XMA_FAVICON_SUBPROTOCOL_VERSION=s,i.XMA_HEADER_SUBPROTOCOL_VERSION=u,i.RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION=c,i.RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION=d}),66);
__d("MAWXMAEncodeUtils",["MAWAsMessageApplication","MAWEncodeMediaTransportProtocol","MAWMsgType","MAWParseSubprotocolVersionConsts","MAWVault","WALogger","WAMsgApplication.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return{payload:o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i),version:n}}function u(t,n){var r=t.msgContent,a=t.msgId,i=r||{},l=i.commands,u=i.content,c=i.mentionedJids,d=n.associatedMessage,m=n.favicon,p=n.header,_=n.previews,f=n.xma,g=null;if(d!=null)if(d.type!==o("MAWMsgType").MSG_TYPE.TEXT)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Non-text associated message for the XMA content is not supported"])));else{var h=o("MAWAsMessageApplication").asMessageApplication(d),y=o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,h);g={payload:y.readBuffer(),version:o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION}}var C=p!=null&&a!=null?s(a,p,o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION):null,b=m!=null&&a!=null?s(a,m,o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION):null,v=_!=null&&a!=null?_.map(function(e){return s(a,e,o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)}):null,S=f.defaultCTA==null?void 0:[f.defaultCTA].concat(f.ctas).filter(Boolean);return{payload:{content:{extendedContentMessage:{associatedMessage:g!=null?g:void 0,commands:l,contentRef:f.contentRef,ctas:S,favicon:b!=null?b:void 0,headerImage:C!=null?C:void 0,headerTitle:f.headerTitle,maxSubtitleNumOfLines:f.maxSubtitleNumOfLines,maxTitleNumOfLines:f.maxTitleNumOfLines,mentionedJid:c,messageText:u==null?void 0:o("MAWVault").unvault(u),overlayDescription:f.overlayDescription,overlayIconGlyph:f.overlayIconGlyph,overlayTitle:f.overlayTitle,previews:v!=null?v:[],sentWithMessageId:g?f.externalId:void 0,subtitleText:f.subtitleText,targetExpiringAtSec:f.targetExpiringAtSec,targetId:f.targetId,targetType:f.targetType,targetUsername:f.targetUsername,titleText:f.titleText,xmaDataclass:f.xmaDataclass,xmaLayoutType:f.xmaLayoutType}}}}}l.encodeXMA=u}),98);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","WAJids","WAMsgMap","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=new Set,r=[];return t.forEach(function(e){var t=e.chatJid,o=e.msg;n.add(t),r.push(o.originalMsgExternalId)}),o("MAWDexieTable").dexieAll([e.messages.where("externalId").anyOf(r).toArray(),e.messages.where("quoteExternalId").anyOf(r).toArray(),e.editMsgHistory.where("originalMsgExternalId").anyOf(r).toArray()]).then(function(e){var t=e[0],n=e[1],r=e[2];return{editMsgHistory:r,originalMsgs:t,quoteMessages:n}})}function s(e,t,n){var a=n.editMsgHistory,i=n.originalMsgs,l=n.quoteMessages,s=i.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),u=a.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),d=c(t,{messageHistoriesToEdit:u,messagesToEdit:s}),m=d[0],p=d[1],_=d[2];return o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,m).then(function(){var t=new(o("WAMsgMap")).MsgMap;p.entries().forEach(function(e){var n,a,i=e[0],l=e[1],u=s.get(i);if(u==null){r("FBLogger")("messenger_web").warn("Cannot find the original msg for the edit action.");return}if(u.type!==o("WAMsgType").MSG_TYPE.TEXT&&u.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",u.type);var c=babelHelpers.extends({},u,{editCount:((n=u.editCount)!=null?n:0)+((a=_.get(i))!=null?a:0),msgContent:l.editMsgContent,type:o("WAMsgType").MSG_TYPE.TEXT});t.set(i,c)});var n=l.map(function(e){var n=e.quote,a=e.quoteExternalId,i=e.threadJid;if(n==null){r("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",e.externalId);return}var l=n.content.author,s=o("MAWJidUtils").maybeToProtocolMsgId(l==="@me"?o("MAWUserJidWrapper").getMyUserJid():l,i,a);if(s!=null){var u=t.get(s);if(u!=null)return babelHelpers.extends({},e,{quote:babelHelpers.extends({},n,{content:babelHelpers.extends({},n.content,{msgContent:babelHelpers.extends({},u.msgContent)})})})}}).filter(Boolean);return e.messages.bulkPut(t.values().concat(n)).then(function(){t.values().forEach(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(){n.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})})}function u(e,t){var n,a,i,l;switch(e.type){case o("WAMsgType").MSG_TYPE.TEXT:case o("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:e.author,editExternalId:e.externalId,editTs:(n=e.serverTs)!=null?n:e.ts,msgContent:(a=e.editMsgContent)!=null?a:o("MAWUnsafeCoerce").unsafeCoerce(e.msgContent),originalMsgExternalId:(i=e.originalMsgExternalId)!=null?i:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};case o("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:e.author,editExternalId:e.externalId,editTs:(l=e.serverTs)!=null?l:e.ts,msgContent:{content:""},originalMsgExternalId:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};default:throw e.type,r("FBLogger")("messenger_web").mustfixThrow("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function c(e,t){var n=t.messageHistoriesToEdit,a=t.messagesToEdit,i=[],l=new(o("WAMsgMap")).MsgMap,s=new(o("WAMsgMap")).MsgMap;return e.forEach(function(e){var t=e.chatJid,c=e.msg,d=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.originalMsgExternalId);if(d==null)throw r("FBLogger")("messenger_web").mustfixThrow("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.originalMsgExternalId);var m=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.externalId);if(m==null)throw r("FBLogger")("messenger_web").mustfixThrow("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.externalId);if(n.get(m)==null){var p;i.push(u(c,t));var _=(p=s.get(d))!=null?p:0,f=a.get(d);if(s.set(d,_+1),n.get(d)==null&&_===0&&f!=null){if(f.type!==o("WAMsgType").MSG_TYPE.TEXT&&f.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",f.type);i.push(u(f,t))}}var g=l.get(d),h=g==null?void 0:g.serverTs,y=c==null?void 0:c.serverTs;(h==null||y==null||h<y)&&l.set(d,c)}),[i,l,s]}l.prepareDataForMessageEdit=e,l.bulkEditMsgs=s,l.getMessageHistory=u}),98);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["FBLogger","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","WAArrayGroupBy","WAJids","WAMsgMap","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.reduce(function(e,t){var n=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.reactToExternalId);return n==null||e.set(n,o("MAWDbReactionsTxns").coerceToReaction(t)),e},new(o("WAMsgMap")).MsgMap).values()}function s(t,n,a){if(n.length===0)return o("MAWDexieTable").dexieResolve();var i=e(n),l=i.map(function(e){var t=a.get(e.threadJid);if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Should not have got here - expect thread to exist for flow");return e}),s=o("WAArrayGroupBy").groupBy(l,function(e){var t=e.threadJid;return t}),u=s.map(function(e){var n=e[0],r=e[1],i=a.get(n);if(i==null||r.length===0)return null;for(var l=null,s=r.length-1;s>=0&&(l=o("MAWDbReaction").maybeCastToIncomingDbReaction(r[s]),l==null);s--);var u=r.filter(function(e){return e.reaction==null}),c=o("WAJids").interpretAsGroupJid(i.jid)!=null;return o("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(t,i,{newestReaction:l,reactionsToClear:u},c)}).filter(Boolean);return o("MAWDexieTable").dexieAll(u).then(function(e){return o("MAWDexieTable").dexieAll([t.threads.bulkPut(e.map(function(e){var t=e.thread;return t})),t.reactions.bulkPut(l)]).then(r("emptyFunction"))})}l.bulkPutReactionsWithThreadUpdates=s}),98);
__d("MAWDeletedReactionsCache",["WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAMsgMap")).MsgMap;l.DeletedReactionsCache=e}),98);
__d("MAWBulkWriteReactionsTxns",["FBLogger","LSMEBTaskCreationSource","MAWAuthor","MAWBridgeEventTransmitter","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWJidUtils","MAWODSProxy","MAWUseProtocolMsgIdForMsgId","WAArrayGroupBy","WAJids","WAOdsEnums","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],a=[];return t.forEach(function(e){var t=e.chatJid,r=e.unstoredReaction,o=r.reactToExternalId;n.push(t),a.push(o)}),o("MAWDexieTable").dexieAll([e.threads.where("jid").anyOf(n).toArray(),e.messages.where("externalId").anyOf(a).toArray(),e.reactions.where("reactToExternalId").anyOf(a).toArray()]).then(function(n){var a=n[0],i=n[1],l=n[2],u=new Map(a.map(function(e){return[e.jid,e]})),c=new Map(o("WAArrayGroupBy").groupBy(i,function(e){return e.externalId})),d=new Map(o("WAArrayGroupBy").groupBy(l,function(e){return e.reactToExternalId})),m=[],p=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId(),_=function(n){return t.forEach(function(e){var t=e.chatJid,a=e.unstoredReaction,i=a.author,l=a.externalId,_=a.groupingKey,f=a.reaction,g=a.reactToAuthor,h=a.reactToExternalId,y=a.senderTimestampMs,C=a.ts,b=u.get(t);if(b==null)return"missing_thread";var v=null;if(!p&&n!=null){var S=new Map(n),R=S.get(b.jid);if(R==null)throw r("FBLogger")("messenger_web").mustfixThrow("nextInChatReactionId should not be null");S.set(b.jid,R+1),v=o("MAWDbMsg").craftReactionId(b.chatId,R)}else v=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,l);var L=d.get(a.reactToExternalId)||[],E=o("MAWDbReaction").findMatchingReaction(L,b.jid,i);if(E!=null&&o("MAWDbReaction").getReactionTimeMs(E)>o("MAWDbReaction").getReactionTimeMs(a))return"newer_reaction_exists";if(E!=null&&a.reaction==null){var k={author:a.author,chat:a.threadJid,externalId:a.externalId};o("MAWDeletedReactionsCache").DeletedReactionsCache.set(k,E)}var I=o("MAWAuthor").getAuthorUserJid(g),T=c.get(a.reactToExternalId);T==null&&(a.reactToExternalId===a.externalId?r("FBLogger")("messenger_web").warn("reactToExternalId is same as externalId"):r("gkx")("16596")||o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.reactToExternalId,r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT_REACTIONS,b.jid));var D=s(b,I,T),x=o("MAWDbReaction").formatReactionForDb(b.jid,l,v,h,f,_,g,D==null&&p?o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,h):D==null?void 0:D.msgId,C,i!=null?i:o("WAJids").AUTHOR_ME,E==null?void 0:E.rowId,void 0,y);m.push(x)}),{chatJidToDbThread:u,unstoredDbReactionsForInsertion:m}};if(!p){var f=a.map(function(t){return o("MAWDbReactionsTxns").getNextReactionIdNumberForThread(e,t).then(function(e){return[t.jid,e]})});return o("MAWDexieTable").dexieAll(f).then(_)}return _(null)})}function s(e,t,n){var a,i=(a=n==null?void 0:n.filter(function(n){return n.threadJid===e.jid&&t===o("MAWAuthor").getAuthorUserJid(n.author)}))!=null?a:[];return i.length>1&&(r("FBLogger")("maw_mutation_validator").warn("%s matching duplicate messages found for a reaction",i.length),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MUTATION_VALIDATOR,key:"match_reaction_to_message.invalid"})),i[0]}function u(e,t){var n=t.chatJidToDbThread,r=t.unstoredDbReactionsForInsertion;return o("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(e,r,n)}l.prepareReactionsData=e,l.bulkWriteReactions=u}),98);
__d("MAWCacheServiceQPL",["ExecutionEnvironment","MAWCurrentUser","MAWQplProxy","QPLUserFlow","performanceAbsoluteNow","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new Set,c=new Set,d=3e3,m=r("qpl")._(1056836703,"2955");function p(t,n){var a=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(a){if(c.has(t))return;f(t),o("MAWQplProxy").startQplUserFlow(m,{},{callBridgeWithTimestamp:!0,providedInstanceKey:t})}else{if(u.has(t))return;_(t),r("QPLUserFlow").start(m,{annotations:{string:{service:n}},instanceKey:t})}}function _(e){u.add(e)}function f(e){c.add(e)}function g(t,n,a){var i=b(a),l=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(l){if(!c.has(t))return;o("MAWQplProxy").sendQplPointThroughBridge(m,"worker@"+i+n,{instanceKey:t},!0)}else{if(!u.has(t))return;var p=(s||(s=r("performanceAbsoluteNow")))();a==="realtime-update"?window.setTimeout(function(){r("QPLUserFlow").addPoint(m,"ui@"+n,{instanceKey:t,timestamp:p})},d):r("QPLUserFlow").addPoint(m,"ui@"+n,{instanceKey:t})}}function h(t,n){var a=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(a){if(!c.has(t))return;o("MAWQplProxy").sendQPLAnnotationsThroughBridge(m,n,t)}else{if(!u.has(t))return;r("QPLUserFlow").addAnnotations(m,n,{instanceKey:t})}}function y(t){var n=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(n){if(!c.has(t))return;c.delete(t),o("MAWQplProxy").sendQPLSuccessThroughBridge(m,{},t,!0)}else{if(!u.has(t))return;var a=(s||(s=r("performanceAbsoluteNow")))();window.setTimeout(function(){u.delete(t),r("QPLUserFlow").endSuccess(m,{instanceKey:t,timestamp:a})},d)}}function C(t,n,a){var i=b(a),l=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(l){if(!c.has(t))return;o("MAWQplProxy").sendQPLFailThroughBridge(m,"worker@"+i+n,{},t,!0)}else{if(!u.has(t))return;var p=(s||(s=r("performanceAbsoluteNow")))();window.setTimeout(function(){u.delete(t),r("QPLUserFlow").endFailure(m,"ui@"+n,{instanceKey:t,timestamp:p})},d),u.delete(t)}}function b(e){return e?e.replace(/-/g,"_")+"_":""}function v(e){return o("MAWCurrentUser").isEmployee()||o("MAWCurrentUser").isTestUser()?e:void 0}var S={addAnnotationsQPL:h,addPointQPL:g,endFailureQPL:C,endSuccessQPL:y,redactKeysForNonEmployee:v,registerInstanceKeyInUI:_,registerInstanceKeyInWorker:f,startQPL:p};l.default=S}),98);
__d("MAWCacheServiceUtils",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e="maw_cache_service_broadcast",s=typeof window!="undefined"?window:self,u=function(){return s.BroadcastChannel?new s.BroadcastChannel(e):(r("FBLogger")("messenger_e2ee_web").warn("BroadcastChannel is not supported in this browser"),null)},c={concurrency:1,maxTaskLimit:1,maxThrottleMs:500};function d(e){return"maw-cache-service-"+e}function m(e,t){var n=new Set,r=[];return e.forEach(function(e){var o=t(e);if(n.has(o)){r.push(e);return}n.add(o)}),r}l.MAW_CACHE_SERVICE_BROADCAST_CHANNEL=e,l.globalScope=s,l.getMAWCacheServiceBroadcastChannel=u,l.SCHEDULER_CONFIG=c,l.getSchedulerName=d,l.findDuplicates=m}),98);
__d("MAWCastToMsgrServerMediaType",["EncryptedBackupsUploadEntity","MAWDbMedia","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n){if(n===void 0&&(n=!1),n&&t==="image")return"xma";switch(t){case"image":case"video":case"gif":case"sticker":return t;case"document":return"file";case"ptt":return"audio";case"xma-image":return"xma";case"preview":return"preview";default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"])),t),null}}function d(e,t){if(t===void 0&&(t=!1),t&&e===o("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(e){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"file";case"Ptt":return"audio";default:return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"])),e),null}}function m(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return"image";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return"video";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return"gif";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER:return"sticker";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return"file";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return"audio";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA:return"xma";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW:return"preview";default:return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["invalid attachment mediaType: "," for castMediaAttachmentTypeToServerMediaType method"])),e),null}}l.castToMsgrServerMediaType=c,l.castClientMediaTypeToServerMediaType=d,l.castMediaAttachmentTypeToServerMediaType=m}),98);
__d("MAWJobsIndexedDb",["FBLogger","MAWCurrentUser","MAWErrorObject","MAWIndexedDbMetadata","MAWQplProxy","MAWTransactionMode","Promise","WAExceededStorageQuota","WALogger","WAWorkerGlobalScope","emptyFunction","promiseDone","qex","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null,c=null,d="jobs";function m(){return r("qex")._("940")}function p(){if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return u}function _(){if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return c.then(function(){return p()})}function f(){return u!=null}var g=[function(e){var t=e.target.result,n=t.createObjectStore(d,{autoIncrement:!0,keyPath:"jobId"});n.createIndex("uniqKey","uniqKey")},r("emptyFunction"),r("emptyFunction")];function h(e){return c=null,u=null,y(e).then(function(){return u.version})}function y(t){var a;if(c!=null)return c;if(u!=null)return(s||(s=n("Promise"))).resolve();var i=o("MAWCurrentUser").getID(),l=o("MAWIndexedDbMetadata").jobsDbName(i),d=(a=t!=null?t:m())!=null?a:g.length,p=r("qpl")._(25310776,"6155");return c=new(s||(s=n("Promise")))(function(t,n){var r=indexedDB.open(l,d);r.onupgradeneeded=function(e){for(var t=0;t<g.length;t++){var n=g[t],r=t+1;C(e,r)&&n(e)}},r.onsuccess=function(n){var r=n.target.result;r.onversionchange=function(){var t;o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_versionchange"),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[JobsDb initialization] upgradeneeded is triggered in another worker. This should not happen."]))),r.close(),(t=o("WAWorkerGlobalScope").workerGlobalScope.location)==null||t.reload==null||t.reload()},u=r,o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_ready"),t()},r.onerror=function(){o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_failed"),n(r.error)}}),c}function C(e,t){var n=e.newVersion,r=e.oldVersion;return r<t&&n>=t}function b(e){return e===o("MAWTransactionMode").READWRITE?"readwrite":"readonly"}function v(e,t,n,a){var i=b(t);return function(t){return function(){for(var l=arguments.length,s=new Array(l),d=0;d<l;d++)s[d]=arguments[d];var m=a!=null?o("MAWQplProxy").startQplUserFlow(a):null,p=function(l){return _().then(function(n){var r=function(r){var t=n.transaction(e,r!=null?b(r):i,{durability:"relaxed"});return o("WAExceededStorageQuota").listenToQuotaExceededError(t),t.objectStore(e)};return t.apply(void 0,[r].concat(s))}).then(function(e){return m==null||m.endSuccess(),e}).catch(function(t){m==null||m.endFail("job_transaction_fail");var a=o("MAWErrorObject").getErrorObject(t);if((a==null?void 0:a.name)==="InvalidStateError"&&l===1)return c=null,u=null,r("promiseDone")(y()),p(l-1);throw a instanceof Error?r("FBLogger")("maw_db").catching(a).mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e):r("FBLogger")("maw_db").mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e)})};return p(1)}}}l.getJobsDbVersion=m,l.getJobDB=p,l.isJobDBInitted=f,l.dbMigrations=g,l.makeJobsDbIgnoringPreviousCreations=h,l.makeJobsDb=y,l.makeJobsTransactor=v}),98);
__d("WADbTransactor",["MAWDexie","MAWIndexedDb","MAWTransactionMode","WAExceededStorageQuota","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var r=Object.keys(e),a=r.some(function(t){return e[t]===o("MAWTransactionMode").READWRITE})?o("MAWTransactionMode").READWRITE:o("MAWTransactionMode").READONLY;return function(){for(var e=arguments.length,i=new Array(e),l=0;l<e;l++)i[l]=arguments[l];return o("MAWIndexedDb").getSignalDB(t).then(function(e){return s(a,r,function(){return n(e.stores).apply(void 0,i)})}).then(function(e){return e}).catch(function(e){throw d(e,t)})}}function s(e,t,n){if(r("MAWDexie").currentTransaction!=null)throw r("err")("protocolDB transactor %s cannot be called within another transaction");return o("MAWIndexedDb").getSignalDB().then(function(r){return r.transact(e,t,n)})}function u(e){return e instanceof Error?e:typeof e=="string"?r("err")(e):null}async function c(e,t,n,r){var a=e+"_"+r,i=await o("MAWIndexedDb").getDB(a);return i.transact(t,[e],function(){return n(i.stores[e])}).then(function(e){return e}).catch(function(e){throw d(e,a)})}function d(e,t){var n;o("WAExceededStorageQuota").checkQuotaExceededError(e);var a=u(e);return a?(a.message="["+((n=a==null?void 0:a.toString())!=null?n:"unknown error")+"] Error performing %s transaction "+t,a):r("err")("[unknown error] Error performing %s transaction "+t)}l.makeSignalTransactor=e,l.persistedQueueTransactor=c}),98);
__d("WAClearSignalStores",["MAWDexieTable","MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({tasks:o("MAWTransactionMode").READWRITE},"clearSignalStores",function(e){return function(){return o("MAWDexieTable").dexieAll([e.tasks.clear()]).then(function(){})}});l.clearSignalStores=e}),98);
__d("WAClearSignalStoresV2",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return o("WASignalDB").getDb().runInTransaction(["identity","contacts","meta","prekey","prekeyGeneration","senderKeySessions","session","signedPrekey","personalSenderKeyStatuses"],"readwrite",async function(e){await Promise.all([e.stores.identity.clear(),e.stores.contacts.clear(),e.stores.meta.clear(),e.stores.prekey.clear(),e.stores.prekeyGeneration.clear(),e.stores.senderKeySessions.clear(),e.stores.session.clear(),e.stores.signedPrekey.clear(),e.stores.personalSenderKeyStatuses.clear()])},o("WASignalDB").signalOp("clearSignalStores"))};l.clearSignalStores=e}),98);
__d("MAWClearSignalAndTempStores",["MAWDeleteOldLogsFromDisk","MAWJobActionsV2","MAWJobsIndexedDb","MAWLoggingSwitches","MAWTransactionMode","Promise","WAClearSignalStores","WAClearSignalStoresV2","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWJobsIndexedDb").makeJobsTransactor("jobs",o("MAWTransactionMode").READWRITE,"clearJob")(o("MAWJobActionsV2").clearJobs),u=function(){return(e||(e=n("Promise"))).all([o("MAWLoggingSwitches").removeLoggingFromBridge&&o("MAWDeleteOldLogsFromDisk").clearLogs(),o("WAClearSignalStores").clearSignalStores(),s(),o("WAClearSignalStoresV2").clearSignalStores()]).then(r("emptyFunction"))};l.clearSignalAndTempStores=u}),98);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case o("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case o("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case o("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}l.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=s}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case o("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;case o("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL;case o("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.GRID:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}l.convertXMALayoutTypeToExtendedContentXMLLayoutType=s}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_POST_REACTION_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}l.convertXMATargetTypeToExtendedContentTargetType=s}),98);
__d("MAWCreateMaybeAddPointForMediaRender",["MAWQplProxy","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return function(t,n){e!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25302828,"2195"),t,{annotations:n,instanceKey:e},!0)}}l.createMaybeAddPointForMediaRender=e}),98);
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t,n;return{deletePersistedJob:(e=o("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(t=o("MAWTransactionMode")).READWRITE,"deletePersistedJob")((n=o("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:e.makeJobsTransactor("jobs",t.READONLY,"loadAllJobs")(n.readAllPersistedJobs),maybeCreateJob:e.makeJobsTransactor("jobs",t.READWRITE,"maybeCreateJob")(n.maybeCreateJob),readPersistedJob:e.makeJobsTransactor("jobs",t.READONLY,"readPersistedJob")(n.readPersistedJob),updatePersistedJob:e.makeJobsTransactor("jobs",t.READWRITE,"updatePersistedJob")(n.updatePersistedJob)}}l.getJobPersistenceAccessors=e}),98);
__d("WAJobRequirement",["Promise","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t=this;this.$1=(s||(s=n("Promise"))).resolve(),this.$2=!0,this.$3=null,this.$4=function(){var e=t.$3;if(e!=null)return t.$3=null,(s||(s=n("Promise"))).all(e).then(t.$4);t.$2=!0},this.name=e}var r=t.prototype;return r.addBlocker=function(r){var t=this,a=r.catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["JobRequirement[","] blocker errored ",""])),t.name,n).sendLogs("job-blocker-rejected")});if(this.$2)this.$2=!1,this.$1=(s||(s=n("Promise"))).all([this.$1,a]).then(this.$4);else{var i=this.$3;i!=null?i.push(a):this.$3=[a]}},r.waitUntilSatisfied=function(){return this.$1},r.isSatisfied=function(){return this.$2},r.isSatisfiable=function(){return!0},t})(),c=(function(e){function t(t){var r;return r=e.call(this,t)||this,e.prototype.addBlocker.call(r,new(s||(s=n("Promise")))(function(){})),r}babelHelpers.inheritsLoose(t,e);var r=t.prototype;return r.addBlocker=function(){},r.isSatisfiable=function(){return!1},t})(u);function d(e,t){var r=e.filter(function(e){return!e.isSatisfiable()});if(r.length>0){var o=r.map(function(e){return e.name});return function(e){return t==null||t("unsatisfiable",o,e),r[0].waitUntilSatisfied()}}var a=e.map(function(){return(s||(s=n("Promise"))).resolve()}),i=(s||(s=n("Promise"))).resolve(),l=null,u=function(){if(a.every(function(t,n){return t===e[n].waitUntilSatisfied()})){l=null;return}var t=[],r=e.map(function(e){var n=e.waitUntilSatisfied();return e.isSatisfied()||(t.push(e.name),n.then(function(){var n=t.indexOf(e.name);t.splice(n,1)})),n});return a=r,l=t,(s||(s=n("Promise"))).all(r).then(u)};return function(e){if(l==null){var n=u();n!=null&&(i=i.then(function(){return n}))}return t==null||t(l==null?"satisfied":"unsatisfied",l,e),i}}l.JobRequirement=u,l.UnsatisfiableJobRequirement=c,l.joinRequirements=d}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t;this.tasks=[],this.pendingTasks=[],this.lastJobStartedTimestampMs=null,this.jobMaxConcurrency=(t=e.jobMaxConcurrencyMap)!=null?t:{}}var n=t.prototype;return n.updateConfig=function(t){var e;this.jobMaxConcurrency=(e=t.jobMaxConcurrencyMap)!=null?e:{}},n.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(e,t){var n,r=(n=e[t.jobName])!=null?n:0;return e[t.jobName]=r+1,e},{})},n.next=function(){var e=this;if(this.tasks.length===0)return null;var t=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.tasks.filter(function(n){var r,a;return((r=t.get(n.jobName))!=null?r:0)<((a=e.jobMaxConcurrency[n.jobName])!=null?a:o("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return n.length>0?[n[0]]:null},n.add=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.tasks.push(e),e},n.markJobTaskPending=function(n){this.pendingTasks.includes(function(e){return e.jobId===n.jobId})&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),n.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(n),this.tasks=this.tasks.filter(function(e){return e.jobId!==n.jobId})},n.markJobTaskDone=function(t){this.pendingTasks=this.pendingTasks.filter(function(e){return e.jobId!==t}),this.tasks.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},n.count=function(){return this.tasks.length},n.pendingCount=function(){return this.pendingTasks.length},n.clearWaitingTasks=function(){this.tasks=[]},n.clear=function(){this.tasks=[],this.pendingTasks=[]},n.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs},t})(),c=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.next=function(){var e=this,t,n;if(this.tasks.length===0)return null;var r=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),o=this.tasks.filter(function(t){var n,o;return((n=r.get(t.jobName))!=null?n:0)<((o=e.jobMaxConcurrency[t.jobName])!=null?o:1)});if(o.length===0)return null;var a=(t=this.jobMaxConcurrency[o[0].jobName])!=null?t:1,i=(n=r.get(o[0].jobName))!=null?n:0;if(a>1&&i<a){var l=o.filter(function(e){return e.jobName===o[0].jobName}),s=Math.min(l.length,a-i);return l.slice(0,s)}return[o[0]]},t})(u);l.BaseJobBucket=u,l.LowJobBucket=c}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=o("WATimeUtils").performanceAbsoluteNow();return new(e||(e=n("Promise")))(function(e){setTimeout(function(){e(o("WATimeUtils").performanceAbsoluteNow()-t)},0)})}l.getEventLoopDelay=s}),98);
__d("WAConcurrentBucketJobQueue",["WABase64","WACryptoDependencies","WACustomError","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=30,c=new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);function d(e){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WABase64").encodeB64(t)}var m=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map,this.$6=new Map,this.$7=new Map,this.$9=0}var n=t.prototype;return n.init=function(t,n){var e,a,i,l,s,c;if(this.$1)throw r("err")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=t==null?void 0:t.bestEffortWaitTimeoutSec)!=null?e:u,this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$8=n,this.$7=this.$11(t==null?void 0:t.jobPrioritiesQuota),this.$6=new Map(this.$7),this.$5=new Map,this.$9=Date.now();var d=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(a=t.maxConcurrencyPerJob)!=null?a:{}}),m=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(i=t.maxConcurrencyPerJob)!=null?i:{}}),p=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(l=t.maxConcurrencyPerJob)!=null?l:{}}),_=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(s=t.maxConcurrencyPerJob)!=null?s:{}}),f=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(c=t.maxConcurrencyPerJob)!=null?c:{}});this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,_),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,f),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,m),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,p),this.$1=!0},n.updateConfig=function(n){this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$5.forEach(function(e){var t;return e.updateConfig({jobMaxConcurrencyMap:(t=n.maxConcurrencyPerJob)!=null?t:{}})}),this.$7=this.$11(n==null?void 0:n.jobPrioritiesQuota),o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"])))},n.isInitialized=function(){return this.$1},n.clearQueue=function(){if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(e){return e.clear()})},n.clearQueueByPriority=function(t){var e;if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");(e=this.$5.get(t))==null||e.clearWaitingTasks()},n.getIntStats=function(){var e=this,t=function(n){var t,r,o=e.$5.get(n);return((t=o==null?void 0:o.count())!=null?t:0)+((r=o==null?void 0:o.pendingCount())!=null?r:0)};return{highPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},n.getStringStats=function(){var e=this,t=function(n){var t,r,o=(t=(r=e.$5.get(n))==null?void 0:r.getStats())!=null?t:{},a=Object.keys(o).reduce(function(e,t){var n=e[0],r=e[1],a=o[t];return a>n?[a,t]:[n,r]},[0,null]),i=a[1];return i};return{highPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},n.enqueue=function(t,n,a,i){var e,l,s=this;if(!this.$1)return Promise.reject(r("err")("WAConcurrentBucketJobQueue not initialized"));var u,c,m=new Promise(function(e,t){u=e,c=t}),p=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},a),_=this.getJobBucketByType(p.priority);if(!_)return Promise.reject(r("err")("WAConcurrentBucketJobQueue no bucket for job with name "+t+" was found."));o("WAMetrics").getEventLoopDelay().then(function(e){i!=null&&i.isActive()&&(i==null||i.addPoint("measure_event_loop_delay",{int:{eventLoopDelay:e}}))}),i==null||i.addPoint("scheduling_job",{string:babelHelpers.extends({},this.getStringStats(),{priority:p.priority}),int:babelHelpers.extends({},this.getIntStats(),{maxTimeoutMs:(e=a==null?void 0:a.maxTimeoutMs)!=null?e:0})});var f=p.priority+"-"+t+"-"+((l=a==null?void 0:a.jobId)!=null?l:d(8)),g=_.add(t,p,f,async function(){try{s.$8.logJobStarted(f);var e=await s.$12(n(),a==null?void 0:a.maxTimeoutMs);s.$8.logJobCompleted(f),u(e)}catch(e){e instanceof o("WACustomError").TimeoutError?s.$8.logJobTimeout(f):s.$8.logJobError(f),c(e)}});return this.$8.logJobCreated({jobId:f,jobName:t,jobPriority:p.priority,pendingJobsCount:_.count()}),a&&a.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$13(g),this.$14(),m},n.getAvailableThreadsCount=function(){return this.$3},n.getJobQuotaConfig=function(){return this.$7},n.getRemainingJobCountMap=function(){return this.$6},n.getJobBucketByType=function(t){return this.$5.get(t)},n.getSnapshot=function(t){var e=this.getJobBucketByType(t);return e?e.getStats():null},n.$11=function(t){var e;return t?e=new Map(t):e=new Map(c),e.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0),e},n.$15=function(t){var e;return(e=this.$6.get(t))!=null?e:0},n.$16=function(){this.$6=new Map(this.$7)},n.$17=function(t){var e=this;t===void 0&&(t=!0);var n=0,r=null,a=0;this.$5.forEach(function(t,o){n+=t==null?void 0:t.count(),a+=e.$15(o),r==null&&t.count()>0&&e.$15(o)>0&&(r=t)});var i=r==null||a===0;return i&&this.$16(),this.$18(n,i)?this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT):r==null&&t?this.$17(!1):r},n.$18=function(t,n){var e,r=this;function a(e,t){var n=Date.now();return e>n?!1:n-e<t*1e3}function i(e,t){var n=Math.ceil(e-Date.now())+t*1e3;return n>0?n:0}var l=this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT),s=t-((e=l==null?void 0:l.count())!=null?e:0),u=l==null?void 0:l.getLastJobStartedTimestamp();if((l==null?void 0:l.count())===0)return!1;if(u==null&&a(this.$9,this.$4)){if(this.$10==null){var c=i(this.$9,this.$4);this.$10=setTimeout(function(){r.$14(),r.$10=null},c)}return!1}return s>0&&u!=null&&a(u,this.$4)?!1:n},n.$19=function(t){var e=this.$20(t);return r("WANullthrows")(this.$5.get(e))},n.$20=function(t){var e=t.split("-")[0],n=o("WAJobOrchestratorTypes").JOB_PRIORITY.cast(e);if(!n)throw r("err")("ConcurrentBucketQueue cannot extract known job priority type from id: "+t);return n},n.$21=function(t){var e=this.$20(t);this.$15(e)>0?this.$6.set(e,this.$15(e)-1):this.$6.set(e,0)},n.$14=function(){for(var e=this;this.$3>0;){var t=this.$17(),n=t==null?void 0:t.next();if(n==null)break;n.forEach(function(t){e.$21(t.jobId),e.$13(t)})}},n.$12=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},n.$13=async function(t){var e=this,n=this.$19(t.jobId);this.$3--,n.markJobTaskPending(t);var r=t.jobId,a=t.jobName,i=t.run;try{var l;await this.$12(i(),((l=t.jobInfo)==null?void 0:l.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$8.logJobTimeout(r),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),a);else throw e}finally{this.$3++,n.markJobTaskDone(r),this.$3>0&&setTimeout(function(){return e.$14()},0)}},t})();l.WAConcurrentBucketJobQueue=m}),98);
__d("WAConcurrentPreemptiveJobQueue",["WACustomError","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","WARandomHex","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var n=t.prototype;return n.init=function(t,n){var e;if(this.$1)throw r("err")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$4=(e=t.maxConcurrencyPerJob)!=null?e:{},this.$7=n,this.$1=!0},n.updateConfig=function(n){var t;this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$4=(t=n.maxConcurrencyPerJob)!=null?t:{},o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"])))},n.isInitialized=function(){return this.$1},n.clearQueueByPriority=function(t){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(e){var n;return((n=e.jobInfo)==null?void 0:n.priority)!==t})},n.clearQueue=function(){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[],this.$6=[]},n.enqueue=function(t,n,a){var e,i=this;if(!this.$1)return Promise.reject(r("err")("ConcurrentPreemptiveJobQueue not initialized"));var l,s,u=new Promise(function(e,t){l=e,s=t}),c=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},a),d=(e=a==null?void 0:a.jobId)!=null?e:o("WARandomHex").randomHex(8).substr(0,64),m=this.$8(t,c,d,async function(){try{i.$7.logJobStarted(d);var e=await i.$9(n(),a==null?void 0:a.maxTimeoutMs);i.$7.logJobCompleted(d),l(e)}catch(e){e instanceof o("WACustomError").TimeoutError?i.$7.logJobTimeout(d):i.$7.logJobError(d),s(e)}});return a&&a.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(m),this.$11(),u},n.getAvailableThreadsCount=function(){return this.$3},n.getJobMaxConcurrency=function(){return this.$4},n.getSnapshot=function(t){},n.$11=function(){for(;this.$3>0;){var e=this.$12();if(e==null)break;this.$10(e)}},n.$9=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},n.$10=async function(t){var e=this;this.$3--,this.$13(t);var n=t.jobId,r=t.jobName,a=t.run;try{var i;await this.$9(a(),((i=t.jobInfo)==null?void 0:i.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$7.logJobTimeout(n),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),r);else throw e}finally{this.$3++,this.$14(n),setTimeout(function(){return e.$11()},0)}},n.$8=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.$7.logJobCreated({jobId:r,jobName:t,jobPriority:n.priority,pendingJobsCount:this.$5.length}),this.$5.push(e),e},n.$13=function(t){this.$6.includes(function(e){return e.jobId===t.jobId})&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),t.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(t),this.$5=this.$5.filter(function(e){return e.jobId!==t.jobId})},n.$14=function(t){this.$6=this.$6.filter(function(e){return e.jobId!==t}),this.$5.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},n.$12=function(){var e=this;if(this.$5.length===0)return null;var t=this.$6.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.$5.filter(function(n){var r,o;return((r=t.get(n.jobName))!=null?r:0)<((o=e.$4[n.jobName])!=null?o:1)});return n[0]},t})();l.WAConcurrentPreemptiveJobQueue=d}),98);
__d("WADefaultJobNoQueue",["WAJobOrchestratorTypes","WARandomHex","err"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(){this.$2=!1}var t=e.prototype;return t.init=function(t,n){if(this.$2)throw r("err")("DefaultNoQueue has already initialized");this.$1=n,this.$2=!0},t.updateConfig=function(t){},t.isInitialized=function(){return this.$2},t.clearQueue=function(){},t.clearQueueByPriority=function(t){},t.getSnapshot=function(){throw r("err")("getSnapshot is not implemented for DefaultNoQueue")},t.enqueue=async function(t,n,r){var e,a,i=(e=r==null?void 0:r.jobId)!=null?e:o("WARandomHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:i,jobName:t,jobPriority:(a=r==null?void 0:r.priority)!=null?a:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});try{this.$1.logJobStarted(i);var l=await n();return this.$1.logJobCompleted(i),l}catch(e){throw this.$1.logJobError(i),e}},e})();l.WADefaultJobNoQueue=e}),98);
__d("WAOrchestratorJobStatsLogger",["QPLFlow"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n){this.jobName=e,this.pendingJobsCount=n,this.jobPriority=t}var t=e.prototype;return t.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=o("QPLFlow").startNoopQPLFlow()},t.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{int:{startedAt:this.webcJobStartedT}})},t.logJobCompleted=function(t){this.webcJobCompletedT=Date.now(),this.jobResultType=t;var e={int:{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};t==="completed"?this.eventFlow.endSuccess(e):this.eventFlow.endFail(t,e)},e})(),s=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.logJobCreated=function(n){var t=n.jobId,r=n.jobName,o=n.jobPriority,a=n.pendingJobsCount,i=new e(r,o,a);i.logJobAdded(),this.$1.set(t,i)},n.logJobStarted=function(t){var e=this.$1.get(t);e==null||e.logJobStarted()},n.logJobCompleted=function(t){this.$2(t,"completed")},n.logJobError=function(t){this.$2(t,"error")},n.logJobTimeout=function(t){this.$2(t,"timeout")},n.logJobAborted=function(t){this.$2(t,"aborted")},n.$2=function(t,n){var e=this.$1.get(t);e==null||e.logJobCompleted(n),this.$1.delete(t)},t})();l.JobInfoEvent=e,l.JobStatsLogger=s}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e={maxConcurrency:1},t="default",n={},r=e,a=new(o("WAOrchestratorJobStatsLogger")).JobStatsLogger;return function(i,l){var c,d,m,p,_;i===void 0&&(i=!1);var f=i?t:o("WAGlobals").getConfig().orchestratorVersion(),g=(c=u())!=null?c:e,h;if(l==null||l.addPoint("get_orchestrator",{string:{orchestrator:f},int:{maxConcurrency:g.maxConcurrency,highPriorityQuota:(d=(m=g.jobPrioritiesQuota)==null?void 0:m.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?d:0,lowPriorityQuota:(p=(_=g.jobPrioritiesQuota)==null?void 0:_.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?p:0}}),n[f])return s(r,g)&&(r=g,n[f].updateConfig(g)),n[f];switch(f){case"preemptive":{h=new(o("WAConcurrentPreemptiveJobQueue")).WAConcurrentPreemptiveJobQueue;break}case"bucket":{h=new(o("WAConcurrentBucketJobQueue")).WAConcurrentBucketJobQueue;break}default:h=new(o("WADefaultJobNoQueue")).WADefaultJobNoQueue;break}return h.init(g,a),n[f]=h,r=g,h}}function s(e,t){var n,r,o,a;return e.maxConcurrency!==t.maxConcurrency||((n=e.jobPrioritiesQuota)==null?void 0:n.size)!==((r=t.jobPrioritiesQuota)==null?void 0:r.size)||Object.keys((o=e.maxConcurrencyPerJob)!=null?o:{}).length!==Object.keys((a=t.maxConcurrencyPerJob)!=null?a:{}).length?!0:JSON.stringify(e)!==JSON.stringify(t)}function u(){var e={jobPrioritiesQuota:new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return e}l.getInstanceDelegate=e}),98);
__d("WAPromiseBackoffs",["Promise","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){if(e===0)return 0;for(var n=g(t.algo),r=1;r<e;r++)n();return d(t,n())}function u(e){var t=e.relativeDelay,n=t===void 0?!1:t,r=null,o=g(e.algo);return function(){var t=r;if(t==null)return r=n?Date.now():0,0;var a=d(e,o());if(n){var i=Date.now(),l=i-t;l>0&&(a=Math.max(0,a-l)),r=i}return a}}function c(t){var r=u(t);return function(o){return new(e||(e=n("Promise")))(function(e){var t=r();t>0?setTimeout(e,t,o):e(o)})}}function d(e,t){var n=e.jitter,r=n===void 0?.1:n,o=e.max,a=e.min,i=t;return o!=null&&i>o&&(i=o),a!=null&&i<a&&(i=a),r!==0&&(i=Math.ceil(i*(1+r*Math.random()))),i}function m(e){var t=e.second-e.first,n=e.first-t;return function(){var e=t+n;return n=t,t=e,e}}function p(e){var t=e.base,n=t===void 0?2:t,r=e.first;return function(){var e=r;return r*=n,e}}function _(e){var t=e.delay;return function(){return t}}function f(e){var t=e.backoff,n=e.toMs,r=g(t);return function(){return n(r())}}function g(e){switch(e.type){case"fibonacci":return m(e);case"exponential":return p(e);case"constant":return _(e);case"adjust":return f(e);default:throw r("err")("makeTimeFunc unrecognized backoff "+e.type)}}l.getDelay=s,l.createTimer=u,l.createPromiseTimer=c}),98);
__d("WAPersistedJobManager",["WAJobRequirement","WALogger","WAPromiseBackoffs","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M=1,w=(function(){function e(e){this.feature=e}var t=e.prototype;return t.toString=function(){return"RequiresPage: "+this.feature},e})(),A=(function(){function e(e){this.backoffOptions=e}var t=e.prototype;return t.toString=function(){return"RetryOnBackoff"},e})(),F=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"NonRetryableError"},t})(babelHelpers.wrapNativeSuper(Error)),O=function(t){this.result=t},B="$unstarted",W="$finished",q=(function(){function t(t){var n=this,r=t.accessors,a=t.isRestartAfterCrash,i=t.unfinishedJobEntries,l=new Map,u=i.then(function(t){var i=[],u=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?i.push(e):u.push(e)}),Promise.all(i.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),V(t),t.step).sendLogs("job-stuck-"+t.type),r.deletePersistedJob(t.jobId)})).then(function(){u.forEach(function(e){l.has(e.jobId)||(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": restarting"])),U(e)),l.set(e.jobId,n.$1(e,a)))})})});this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=r,this.activeJobs=l,this.initialJobsPromise=u,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs}var n=t.prototype;return n.loadAndRunJobFromId=function(t){var e=this.activeJobs.get(t);if(e!=null)return e;var n=this.$2(t);return this.activeJobs.set(t,n),n},n.$2=async function(t){var e=this.accessors,n=this.initialJobsPromise;await n;var r=await e.readPersistedJob(t);return r?this.$1(r,!1):(o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))),null)},n.$3=function(t){var e=this.implementationLoaders,n=this.implementations,r=n.get(t);if(r)return r;var o=e.get(t);if(!o)return null;var a=o();return n.set(t,a),a},n.$4=function(t,n){if(n==null||n.length===0)return Promise.resolve();var e=this.stepBlockers,r=e.get(n);return r==null&&(r=o("WAJobRequirement").joinRequirements(n.map(function(e){return e()}),G),e.set(n,r)),r(t)},n.$5=function(t,n,r,a){var e=this;r===void 0&&(r=!1);var i=t.step,l=n.findIndex(function(e){return e.stepName===i}),s=n[l].info(t.current,t.original,z(t,r)),u=s.code,m=s.requirements,p=this.$4(t,m);return a&&(p=p.then(a)),p.then(function(){return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),H(t)),u(t.current,t.original,z(t,r))}).then(function(a){if(a instanceof O)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),H(t)),a.result;var i=l+1;if(i>=n.length)return a;var s=n[i];return t.step=s.stepName,t.current=a,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,e.accessors.updatePersistedJob(t).then(function(){return e.$5(t,n,r)})})},n.$1=async function(t,n){var e,r=this,a=this.accessors,i=this.activeJobs,l=this.deprecatedJobs,s=this.listeners,u=s.onJobFinished,c=s.onJobStarted,d=await this.$3(t.type),D=l[t.type];if(!d){if(D){if(D==="NOOP")return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),t.type),await a.deletePersistedJob(t.jobId),null}else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),t.type).sendLogs("missing-job-implementation"),await a.deletePersistedJob(t.jobId),null;d=await D()}var x=d;D&&o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),t.type);var $=(e=t.stepFirstStartTime)!=null?e:o("WATimeUtils").unixTime();if(t.stepFirstStartTime=$,t.stepUnexpectedErrorCount=t.stepUnexpectedErrorCount||0,t.backedOffCount=t.backedOffCount||0,t.step===W){var P=t.waitUntil,N=o("WATimeUtils").secondsUntil($);return P!=null&&o("WATimeUtils").isInFuture(P)&&N>0&&(o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),U(t)),P=o("WATimeUtils").castToUnixTime(P-N),o("WATimeUtils").isInFuture(P)&&(t.stepFirstStartTime=o("WATimeUtils").castToUnixTime($-N),t.waitUntil=P,await this.accessors.updatePersistedJob(t))),(P==null||!o("WATimeUtils").isInFuture(P))&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),U(t)),await a.deletePersistedJob(t.jobId)),i.delete(t.jobId),t.current}var F=t.step!==B?d.find(function(e){return e.stepName===t.step}):d[0];if(!F)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),t.type,t.step).sendLogs("missing-job-step"),await a.deletePersistedJob(t.jobId),null;t.step=F.stepName;var O=function(){var e=t.waitUntil,a=Promise.resolve();if(e!=null){var i=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);e>i?(o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),H(t),e,i),t.waitUntil=i,a=r.accessors.updatePersistedJob(t).then(function(){return o("WATimeUtils").delayUntil(i)})):(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),H(t),e),a=o("WATimeUtils").delayUntil(e))}return a.then(function(){var e=function(){return t.waitUntil=null,o("WATimeUtils").happenedWithin($,o("WATimeUtils").DAY_SECONDS)||t.stepHardStartCountAfterTimeout++,r.accessors.updatePersistedJob(t)};return r.$5(t,x,n,e).catch(function(e){if(e instanceof w)return o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": requires page"])),H(t)),t.stepHardStartCountAfterTimeout>0&&(--t.stepHardStartCountAfterTimeout,r.accessors.updatePersistedJob(t)),new Promise(function(){});if(e instanceof A){o("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),H(t));var n=o("WAPromiseBackoffs").getDelay(++t.backedOffCount,e.backoffOptions);return t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(n/1e3)),t.stepHardStartCountAfterTimeout>0&&--t.stepHardStartCountAfterTimeout,r.accessors.updatePersistedJob(t).then(O)}else if(t.stepUnexpectedErrorCount<M)return o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),H(t),t.stepUnexpectedErrorCount),o("WALogger").WARN(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),H(t),e),t.stepUnexpectedErrorCount++,r.accessors.updatePersistedJob(t).then(O);throw e})})},q=O(),V=q.then(async function(e){o("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),H(t));var n=null;try{n=u(t.jobId,t.type,t.original,e)}catch(e){o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),t.type,e).sendLogs("onJobFinished-threw")}n!=null&&n>0?(t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(n/1e3)),t.step=W,t.current=e,t.stepFirstStartTime=o("WATimeUtils").unixTime(),await r.accessors.updatePersistedJob(t)):(await a.deletePersistedJob(t.jobId),i.delete(t.jobId))},async function(e){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),t.type,e).sendLogs("job-threw-exception-"+t.type);var r=x.find(function(e){return e.stepName===t.step});if(!r)o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),t.type,t.step);else{var l=r.info(t.current,t.original,z(t,n));l.stopRetryIf!=null&&await l.stopRetryIf.onStopRetry(t.current,t.original,z(t,n))}await a.deletePersistedJob(t.jobId),i.delete(t.jobId)});try{c(t.jobId,t.type,t.original)}catch(e){o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),t.type,e).sendLogs("onJobStarted-threw")}return V.then(function(){return q})},n.addPersistedJobImplementation=function(t,n){var e=this.deprecatedJobs,r=this.implementationLoaders;if(r.has(t)){o("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}e&&e[t],r.set(t,n)},n.fireAndForget=function(t){var e=this;this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},n.waitUntilPersisted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;e.loadAndRunJobFromId(n)})},n.waitUntilCompleted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},n.fireAndForgetNonPersisted=function(t){o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["fireAndForgetNonPersisted not implemented in PersistedJobManager"])))},n.waitUntilCompletedNonPersisted=function(t){return Promise.resolve(function(){return o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["waitUntilCompletedNonPersisted not implemented in PersistedJobManager"])))})},t})();function U(e){return"Job["+e.jobId+"] ("+e.type+")"}function V(e){return"[Job "+e.type+"] "}function H(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function G(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),H(n),t):e==="unsatisfied"&&o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),H(n),t)}function z(e,t){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:j}}function j(e){return new O(e)}l.RequiresPage=w,l.RetryOnBackoff=A,l.NonRetryableError=F,l.InterruptJob=O,l.UNSTARTED_JOB=B,l.FINISHED_JOB=W,l.PersistedJobManager=q}),98);
__d("WaJobInMemoryAccessors",["Promise","WARandomHex","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=-1,r=new Map;return{deletePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.delete(o))},loadAllJobs:function(){return(e||(e=n("Promise"))).resolve(Array.from(r.values()))},maybeCreateJob:function(i){var a,l=JSON.stringify([i.type,(a=i.uniqKey)!=null?a:o("WARandomHex").randomHex(32)]),s={backedOffCount:0,current:i.args,original:i.args,startTime:o("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:i.type,uniqKey:l,version:i.version,waitUntil:null,scheduleConfig:i.scheduleConfig},u=function(){var o=t--,a=babelHelpers.extends({},s,{jobId:o});return r.set(o,a),(e||(e=n("Promise"))).resolve({id:o,newlyCreated:!0})};if(i.uniqKey!=null){var c=Array.from(r.values()).filter(function(e){return e.uniqKey===l});if(c.length===0)return u();var d=null;return c.forEach(function(e){e.step!=="$finished"?d=e:r.delete(e.jobId)}),d!=null?(e||(e=n("Promise"))).resolve({id:d.jobId,newlyCreated:!1}):u()}return u()},readPersistedJob:function(o){var t=r.get(o);return(e||(e=n("Promise"))).resolve(t&&babelHelpers.extends({},t))},updatePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.set(o.jobId,babelHelpers.extends({},o)))}}}l.getJobInMemoryAccessors=s}),98);
__d("WAPersistedJobManagerV2",["QPLFlow","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F=1;function O(e){var t=e.code,n=e.annotations,r=n===void 0?{}:n,o=e.eventFlow,a=o===void 0?B(r):o;return t(a).then(function(e){return a.endSuccess(),e}).catch(function(e){throw a.endFail("error",{string:{error:""+e}}),e})}function B(e){return e===void 0&&(e={}),o("QPLFlow").startNoopQPLFlow()}var W=(function(){function t(t){var n=this;this.$1=[];var r=t.accessors,a=t.ignoreForceNonPersistedJobList,i=t.isRestartAfterCrash,l=t.unfinishedJobEntries;this.getOrchestratorDelegate=o("WAOrchestrator").getInstanceDelegate(),this.activeJobs=new Map,this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=r,this.isRestartAfterCrash=i||!1,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs,this.inMemoryAccessors=o("WaJobInMemoryAccessors").getJobInMemoryAccessors(),this.offlineQueueMode=!0,this.$1=a,t.offlineQueueCompletePromise!=null?t.offlineQueueCompletePromise.finally(function(){n.offlineQueueMode=!1}):this.offlineQueueMode=!1,this.initialJobsPromise=l.then(function(t){var r=[],a=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?r.push(e):a.push(e)}),Promise.all(r.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),U(t),t.step).sendLogs("job-stuck-"+t.type),n.accessors.deletePersistedJob(t.jobId)})).then(function(){a.forEach(function(e){var t=n.$2(e.jobId);if(t.alreadyActive===!0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"])));return}t.deferred.resolve(O({code:function(r){return n.$3(e,n.accessors,{eventFlow:r})},annotations:{string:{name:e.type},bool:{offlineQueueMode:n.offlineQueueMode}}}))})})})}var n=t.prototype;return n.$4=async function(t,n,a){var e;a===void 0&&(a={});var i=this.$2(t);if((e=a.eventFlow)==null||e.addPoint("start_load_and_run",{bool:{skipped:i.alreadyActive}}),i.alreadyActive===!0)return i.deferred;var l=await n.readPersistedJob(t);if(l==null)throw o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))).sendLogs("missing-job-entry"),r("err")("Persisted job missing for given ID "+t);return i.deferred.resolve(this.$3(l,n,a)),i.deferred.promise},n.$3=function(t,n,r){var e,a;return r===void 0&&(r={}),(e=r.eventFlow)==null||e.addPoint("enqueueing_job",{string:{name:t.type}}),this.getOrchestratorDelegate(((a=t.scheduleConfig)==null?void 0:a.priority)===o("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,r.eventFlow).enqueue(t.type,this.$5(t,n,r),t.scheduleConfig,r.eventFlow)},n.$6=function(t,n,r){var e=this;return r===void 0&&(r={}),n.maybeCreateJob(t).then(function(t){var o,a=t.id;return(o=r.eventFlow)==null||o.addPoint("job_persisted",{int:{jobId:a},bool:{nonPersisted:n===e.inMemoryAccessors}}),a})},n.$2=function(t){var e=this.activeJobs.get(t);if(e!=null)return{alreadyActive:!0,deferred:e};var n=new(o("WAResolvable")).Resolvable;return this.activeJobs.set(t,n.promise),{alreadyActive:!1,deferred:n}},n.$5=function(t,n,r){var e=this;return function(){return e.$7(t,n,r)}},n.$8=function(t){var e=this.implementationLoaders,n=this.implementations,r=n.get(t);if(r)return r;var o=e.get(t);if(!o)return null;var a=o();return n.set(t,a),a},n.$9=function(t,n){if(n==null||n.length===0)return Promise.resolve();var e=this.stepBlockers,r=e.get(n);return r==null&&(r=o("WAJobRequirement").joinRequirements(n.map(function(e){return e()}),H),e.set(n,r)),r(t)},n.$10=function(t,n,r,a,i){var e,l=this;i===void 0&&(i={});var s=t.step;(e=i.eventFlow)==null||e.addPoint("start_step");var u=n.findIndex(function(e){return e.stepName===s}),m=n[u].info(t.current,t.original,G(t,this.isRestartAfterCrash)),p=m.code,_=m.requirements,f=this.$9(t,_);return a&&(f=f.then(a)),f.then(function(){var e;return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),V(t)),(e=i.eventFlow)==null||e.addPoint("run_step"),p(t.current,t.original,G(t,l.isRestartAfterCrash,i.eventFlow))}).then(function(e){var a;if((a=i.eventFlow)==null||a.addPoint("step_is_complete"),e instanceof o("WAPersistedJobManager").InterruptJob)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),V(t)),e.result;var s=u+1;if(s>=n.length)return e;var c=n[s];return t.step=c.stepName,t.current=e,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,r.updatePersistedJob(t).then(function(){return l.$10(t,n,r,void 0,i)})})},n.$7=async function(t,n,r){var e,a,i=this;r===void 0&&(r={});var l=this.activeJobs,s=this.deprecatedJobs,u=this.listeners,c=u.onJobFinished,d=u.onJobStarted;(e=r.eventFlow)==null||e.addPoint("run_job");var T=await this.$8(t.type),D=s[t.type];if(!T){if(D){if(D==="NOOP")return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),t.type),await n.deletePersistedJob(t.jobId),null}else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),t.type).sendLogs("missing-job-implementation"),await n.deletePersistedJob(t.jobId),null;T=await D()}var x=T;D&&o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),t.type);var $=(a=t.stepFirstStartTime)!=null?a:o("WATimeUtils").unixTime();if(t.stepFirstStartTime=$,t.stepUnexpectedErrorCount=t.stepUnexpectedErrorCount||0,t.backedOffCount=t.backedOffCount||0,t.step===o("WAPersistedJobManager").FINISHED_JOB){var P=t.waitUntil,N=o("WATimeUtils").secondsUntil($);return P!=null&&o("WATimeUtils").isInFuture(P)&&N>0&&(o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),q(t)),P=o("WATimeUtils").castToUnixTime(P-N),o("WATimeUtils").isInFuture(P)&&(t.stepFirstStartTime=o("WATimeUtils").castToUnixTime($-N),t.waitUntil=P,await n.updatePersistedJob(t))),(P==null||!o("WATimeUtils").isInFuture(P))&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),q(t)),await n.deletePersistedJob(t.jobId)),l.delete(t.jobId),t.current}var M=t.step!==o("WAPersistedJobManager").UNSTARTED_JOB?T.find(function(e){return e.stepName===t.step}):T[0];if(!M)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),t.type,t.step).sendLogs("missing-job-step"),await n.deletePersistedJob(t.jobId),null;t.step=M.stepName;var w=function(){var e=t.waitUntil,a=Promise.resolve();if(e!=null){var l=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);e>l?(o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),V(t),e,l),t.waitUntil=l,a=n.updatePersistedJob(t).then(function(){return o("WATimeUtils").delayUntil(l)})):(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),V(t),e),a=o("WATimeUtils").delayUntil(e))}return a.then(function(){var e=function(){return t.waitUntil=null,o("WATimeUtils").happenedWithin($,o("WATimeUtils").DAY_SECONDS)||t.stepHardStartCountAfterTimeout++,n.updatePersistedJob(t)};return i.$10(t,x,n,e,r).catch(function(e){if(e instanceof o("WAPersistedJobManager").RetryOnBackoff){var a;o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),V(t)),(a=r.eventFlow)==null||a.addPoint("retry_on_backoff");var i=o("WAPromiseBackoffs").getDelay(++t.backedOffCount,e.backoffOptions);return t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(i/1e3)),t.stepHardStartCountAfterTimeout>0&&--t.stepHardStartCountAfterTimeout,n.updatePersistedJob(t).then(w)}else{if(!(e instanceof o("WAPersistedJobManager").NonRetryableError)&&t.stepUnexpectedErrorCount<F){var l;return(l=r.eventFlow)==null||l.addPoint("retry_on_unexpected_error"),o("WALogger").WARN(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),V(t),t.stepUnexpectedErrorCount),o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),V(t),e),t.stepUnexpectedErrorCount++,n.updatePersistedJob(t).then(w)}throw e}})})},A=w(),O=A.then(async function(e){o("WALogger").LOG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),V(t));var r=null;try{r=c(t.jobId,t.type,t.original,e)}catch(e){o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),t.type,e).sendLogs("onJobFinished-threw")}r!=null&&r>0?(t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(r/1e3)),t.step=o("WAPersistedJobManager").FINISHED_JOB,t.current=e,t.stepFirstStartTime=o("WATimeUtils").unixTime(),await n.updatePersistedJob(t)):(await n.deletePersistedJob(t.jobId),l.delete(t.jobId))},async function(e){o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),t.type,e).sendLogs("job-threw-exception-"+t.type);var r=x.find(function(e){return e.stepName===t.step});if(!r)o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),t.type,t.step);else{var a=r.info(t.current,t.original,G(t,i.isRestartAfterCrash));a.stopRetryIf!=null&&await a.stopRetryIf.onStopRetry(t.current,t.original,G(t,i.isRestartAfterCrash))}await n.deletePersistedJob(t.jobId),l.delete(t.jobId)});try{d(t.jobId,t.type,t.original)}catch(e){o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),t.type,e).sendLogs("onJobStarted-threw")}return O.then(function(){return A})},n.addPersistedJobImplementation=function(t,n){var e=this.deprecatedJobs,r=this.implementationLoaders;if(r.has(t)){o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}e&&e[t],r.set(t,n)},n.fireAndForget=function(t){var e=this;if(this.$1.indexOf(t.type)===-1){o("WALogger").LOG(D||(D=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.fireAndForgetNonPersisted(t);return}o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,n).then(function(t){return e.$4(t,e.accessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},n.waitUntilPersisted=async function(t){var e=this;if(this.$1.indexOf(t.type)===-1)return o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.fireAndForgetNonPersisted(t),Promise.resolve();o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type);var n=B({string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}});return await this.initialJobsPromise,n.addPoint("initial_jobs_promise_fulfilled"),this.$6(t,this.accessors,{eventFlow:n}).then(function(t){O({code:function(r){var n={eventFlow:r};return e.$4(t,e.accessors,n)},eventFlow:n})}).catch(function(e){throw n.endFail("error",{string:{error:""+e}}),e})},n.waitUntilCompleted=function(t){var e=this;return this.$1.indexOf(t.type)===-1?(o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.waitUntilCompletedNonPersisted(t)):(o("WALogger").LOG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,n).then(function(t){return e.$4(t,e.accessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}}))},n.fireAndForgetNonPersisted=function(t){var e=this;O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,n).then(function(t){return e.$4(t,e.inMemoryAccessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},n.waitUntilCompletedNonPersisted=function(t){var e=this;return O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,n).then(function(t){return e.$4(t,e.inMemoryAccessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},t})();function q(e){return"Job["+e.jobId+"] ("+e.type+")"}function U(e){return"[Job "+e.type+"] "}function V(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function H(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),V(n),t):e==="unsatisfied"&&o("WALogger").LOG(A||(A=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),V(n),t)}function G(e,t,n){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:z,eventFlow:n}}function z(e){return new(o("WAPersistedJobManager")).InterruptJob(e)}l.PersistedJobManager=W}),98);
__d("WACommsConnectionState",["WAGenericStateManager"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(e){function t(){return e.call(this,!1)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.isConnected=function(){return this.get()},n.waitForConnection=function(){return this.waitForValue(!0)},t})(o("WAGenericStateManager").WAGenericStateManager),s=new e;l.WACommsConnectionState=s}),98);
__d("WAWaitForComms",["WACommsConnectionState","WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAResolvable")).Resolvable;function s(){return e.promise}function u(){o("WACommsConnectionState").WACommsConnectionState.set(!1),e.isSettled&&(e=new(o("WAResolvable")).Resolvable)}function c(){o("WACommsConnectionState").WACommsConnectionState.set(!0),e.resolve()}function d(){return!e.resolveWasCalled()}function m(t){return e.reject(t)}l.waitForComms=s,l.commsConnectionLost=u,l.unblockComms=c,l.isStillWaitingForComms=d,l.failComms=m}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAPersistedJobManagerV2")).PersistedJobManager({accessors:o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendBumpMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(t,n,r,a){return o("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:t,originalArgs:r,result:a,type:n},!0),null},onJobStarted:r("emptyFunction")},offlineQueueCompletePromise:o("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:o("WAWaitForComms").waitForComms().then(function(){return o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function s(){return o("MAWDefinePersistedJob").persistedJobsApi}function u(){return e}l.getPersistedJobsApi=s,l.getJobManager=u}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function e(e){this.steps=e}var t=e.prototype;return t.step=function(t,n){return this.$1(t,typeof n=="function"?{code:n}:n)},t.$1=function(n,r){var t=r.code,a=r.requirements,i=r.stopRetryIf,l=d(a,t,i);if(i){var s=i.appCrashed,u=i.onStopRetry,p=i.timePassedSeconds,_=d(null,m(u),i);p!=null&&(l=c(function(e,t,n){var r=n.jobStartTime;return o("WATimeUtils").happenedWithin(r,p)},l,_)),s&&(l=c(function(e,t,n){var r=n.afterCrash;return!r},l,_))}return new e([].concat(this.steps,[{stepName:n,info:l}]))},t.finalStep=function(t,n){var e=this.step(t,n);return{end:function(){return e.steps}}},e})();function u(){return new s([])}function c(e,t,n){return function(r,o,a){return e(r,o,a)?t(r,o,a):n(r,o,a)}}function d(e,t,n){var r={requirements:e,code:t,stopRetryIf:n};return function(){return r}}function m(t){return function(r,a,i){return(e||(e=n("Promise"))).resolve(t(r,a,i)).then(function(e){return e instanceof o("WAPersistedJobManager").InterruptJob?e:new(o("WAPersistedJobManager")).InterruptJob(e)})}}l.JobBuilder=s,l.definePersistedJob=u}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(t,n,r,o,a,i,l){"use strict";var e,s={definePersistedJob:function(){return o("WAJobBuilder").definePersistedJob()}};function u(t){var r=o("MAWJobManager").getJobManager();Object.keys(t).forEach(function(o){var a=t[o];r.addPersistedJobImplementation(o,function(){return(e||(e=n("Promise"))).resolve(a)})})}function c(e){var t=o("MAWJobManager").getJobManager();Object.keys(e).forEach(function(n){var r=e[n];t.addPersistedJobImplementation(n,r)})}l.persistedJobsApi=s,l.setMsgrJobImplementations=u,l.setMsgrDeferredJobImplementations=c}),98);
__d("MAWDexieCastToPromise",["Promise","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return(e||(e=n("Promise"))).resolve(t)}function u(e){return r("vulture")("Fs7u2qpGsgGUHBjaeXKvgOwLL5I="),e}l.dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING=s,l.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=u}),98);
__d("MAWEchoToProtobufConversionLoggingUtils",["QPLUserFlow","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){r("QPLUserFlow").start(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function s(e,t,n){r("QPLUserFlow").endFailure(r("qpl")._(521484676,"2684"),t,{annotations:n,instanceKey:e})}function u(e,t){r("QPLUserFlow").endSuccess(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function c(e,t,n){n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521484676,"2684"),n,{instanceKey:e}),r("QPLUserFlow").addPoint(r("qpl")._(521484676,"2684"),t,{instanceKey:e})}l.startQplUserFlow=e,l.endFailure=s,l.endSuccess=u,l.addPoint=c}),98);
__d("MAWGetMsgForProtocolMsgIdTxn",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"getMsgForProtocolMsgIdTxn",function(e){return function(t){return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(e){return e!=null?o("WAResultOrError").makeResult(e):o("WAResultOrError").makeError("message-not-found")})}});l.getMsgForProtocolMsgIdTxn=e}),98);
__d("MAWMediaPreviewDownloadManager",["WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e=1e4,s=[],u=new Map;function c(e){if(!u.has(e)){_();var t=new(o("WAResolvable")).Resolvable;u.set(e,t),s.push(e)}}function d(e,t){var n=u.get(e);n!=null&&(n.reject(t),p(e))}function m(e){return u.get(e)}function p(e){u.delete(e)}function _(){if(s.length>=e){var t=s.shift();t!=null&&u.delete(t)}}function f(){s=[],u.clear()}l.markMediaPreviewAsDownloading=c,l.markMediaPreviewAsFailed=d,l.getMediaPreviewDownloadingResolvable=m,l.removeMediaPreviewDownloadingResolvable=p,l.clear=f}),98);
__d("WATypedArraysConcat",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){n===void 0&&(n=0);var r=t.reduce(function(e,t){return e+t.length},n),o=new e(r),a=0;return t.forEach(function(e){o.set(e,a),a+=e.length}),o}i.concatTypedArrays=e}),66);
__d("WACryptoAesCbc",["WABinary","WACryptoDependencies","WAPromiseDelays","WATypedArraysCast","WATypedArraysConcat","err"],(function(t,n,r,o,a,i,l){"use strict";var e=16,s=1024,u=16,c=1024*1024,d=e*c,m=(function(){function t(e,t,n,r){this.$4=null,this.$6=!1,this.$1=e,this.$2=t,this.$3=n;var a={name:"AES-CBC",iv:r};this.$5=o("WACryptoDependencies").getCrypto().subtle.importKey("raw",n,"AES-CBC",!1,[t]).then(function(e){return{algo:a,key:e}})}var n=t.prototype;return n.append=function(n){var t=this;this.$7("append");var r,a=this.$4;if(a)if(a.writeByteArray(n),a.size()>s){var i=a.size()%e;r=a.readByteArrayView(a.size()-i),a.size()||(this.$4=null)}else r=null;else if(n.length>s){var l=n.length%e;l?(this.$4=new(o("WABinary")).Binary(n),r=this.$4.readByteArrayView(n.length-l)):r=n}else this.$4=new(o("WABinary")).Binary(n),r=null;var u=r;return u&&(this.$5=this.$5.then(function(n){var r=n.algo,a=n.key;if(t.$2==="encrypt")return o("WACryptoDependencies").getCrypto().subtle.encrypt(r,a,u).then(function(n){return t.$1.writeByteArray(new Uint8Array(n,0,n.byteLength-e)),new Uint8Array(n,n.byteLength-2*e,e)});var i=u.slice(-e);return o("WACryptoDependencies").getCrypto().subtle.decrypt(r,a,u).then(function(e){return t.$1.writeBuffer(e),i})}).then(function(e){var n={name:"AES-CBC",iv:e};return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",t.$3,"AES-CBC",!1,[t.$2]).then(function(e){return{algo:n,key:e}})})),this.$5.then(function(){})},n.finalize=function(t){var e=this;this.$7("finalize");var n;if(this.$4){var r=this.$4;t&&r.writeByteArray(t),n=r.readByteArrayView(),this.$4=null}else t&&(n=t);if(n){var a=n;return this.$5.then(function(t){var n=t.algo,r=t.key;return e.$2==="encrypt"?o("WACryptoDependencies").getCrypto().subtle.encrypt(n,r,a):o("WACryptoDependencies").getCrypto().subtle.decrypt(n,r,a)}).then(function(t){e.$1.writeBuffer(t)})}else return this.$5.then(function(){})},n.$7=function(t){if(this.$6)throw r("err")("AesCbcStream."+t+" called after finalize")},t})();function p(e){return{name:"AES-CBC",iv:o("WATypedArraysCast").castTypedArrays(Uint8Array,e)}}function _(e){return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",o("WATypedArraysCast").castTypedArrays(Uint8Array,e),"AES-CBC",!1,["encrypt"])}function f(e){if(e)return o("WATypedArraysCast").castTypedArrays(Uint8Array,e);var t=new Uint8Array(u);return o("WACryptoDependencies").getCrypto().getRandomValues(t),t}function g(t){var n=t.byteLength,r=e-n%e;return Number.isNaN(r)?n:n+r}function h(e,t,n){var r=p(t);return Promise.resolve(o("WACryptoDependencies").getCrypto().subtle.importKey("raw",o("WATypedArraysCast").castTypedArrays(Uint8Array,e),"AES-CBC",!1,["decrypt"])).then(function(e){return o("WACryptoDependencies").getCrypto().subtle.decrypt(r,e,n)})}function y(e,t){return Promise.resolve().then(function(){var n=t.slice(0,u),r=t.slice(u);return h(e,n,r)})}function C(e,t,n){return Promise.resolve().then(function(){var r=f(n),a=p(r);return Promise.resolve(_(e)).then(function(e){return o("WACryptoDependencies").getCrypto().subtle.encrypt(a,e,t)}).then(function(e){return o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[r,new Uint8Array(e)]).buffer})})}async function b(t){var n=t.encKey,a=t.plaintext,i=t.optionalIv,l=t.chunkSize,s=l===void 0?d:l,u=t.delayInBetween,c=u===void 0?!1:u;if(s%e!==0)throw r("err")("chunkSize must be a multiple of "+e+", "+s+" received");var m=await _(n),p=new Uint8Array(a),h=Math.ceil(p.byteLength/s),y=f(i),C=new Uint8Array(g(p)+y.byteLength);C.set(y);for(var b=0,S=y,R;b<h;b++){var L=b===h-1,E=b*s;R=p.subarray(E,E+s);var k=await v(L,R,S,m),I=k.encryptedChunk,T=k.nextIv;C.set(I,y.byteLength+b*s),S=T,c===!0&&await o("WAPromiseDelays").releaseToMainThread()}return C.buffer}async function v(t,n,r,a){var i=await o("WACryptoDependencies").getCrypto().subtle.encrypt(p(r),a,n).then(function(n){return t?new Uint8Array(n):new Uint8Array(n).subarray(0,-e)}),l=i.slice(-e);return{encryptedChunk:i,nextIv:l}}l.AES_CBC_BLOCK_SIZE=e,l.AesCbcStream=m,l.importRawKey=_,l.getIv=f,l.aesCbcDecrypt=h,l.aesCbcDecryptSplit=y,l.aesCbcEncrypt=C,l.aesCbcEncryptWithChunking=b,l.aesCbcEncryptChunk=v}),98);
__d("WAConcurrentIterate",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){for(var r=[],o=[],a=0,i=async function(){for(;a<e;){var n=a;a++,o[n]=await t(n)}},l=Math.min(e,n),s=0;s<l;s++)r.push(i());return Promise.all(r).then(function(){return o})}i.concurrentIterate=e}),66);
__d("WAMediaCryptoSidecar",["WAConcurrentIterate","WACryptoHmac","WAMediaUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e==="video"}var s=16,u=10,c=64*1024;function d(e,t,n){n===void 0&&(n=1);var r=t.buffer.byteLength,a=Math.ceil((r-s)/c),i=new Uint8Array(u*a);return o("WAConcurrentIterate").concurrentIterate(a,function(n){var r=n*c,a=r+s+c,l=t.subarray(r,a);return o("WACryptoHmac").sign(e,l).then(function(e){var t=new Uint8Array(e,0,u);i.set(t,n*u)})},n).then(function(){return o("WAMediaUtils").castToStreamingSidecar(i.buffer)})}l.shouldHaveStreamingSidecar=e,l.calculateStreamingSidecar=d}),98);
__d("WAMediaHkdfInfo",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"document":return"WhatsApp Document Keys";case"image":case"sticker":case"xma-image":return"WhatsApp Image Keys";case"video":case"gif":return"WhatsApp Video Keys";case"audio":case"ptt":return"WhatsApp Audio Keys";case"md-app-state":return"WhatsApp App State Keys";case"md-msg-hist":return"WhatsApp History Keys";default:throw r("err")("getMediaHkdfInfo: unexpected media type "+e)}}function s(){return"Messenger Preview Keys"}l.getMediaHkdfInfo=e,l.getPreviewMediaHkdfInfo=s}),98);
__d("WAMediaCrypto",["WABinary","WACryptoAesCbc","WACryptoDependencies","WACryptoHkdf","WACryptoHmac","WACryptoSha256","WACryptoUtils","WACustomError","WAHashUtils","WAMediaCryptoSidecar","WAMediaHkdfInfo","WATagsLogger","WATypedArraysConcat","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["WAMediaCrypto"]),c=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="HmacValidationError",n}return babelHelpers.inheritsLoose(t,e),t})(o("WACustomError").CustomError),d=new Uint8Array([2,2]);function m(e,t){return o("WACryptoHkdf").extractAndExpand(new Uint8Array(e),t,112).then(function(e){return{iv:new Uint8Array(e,0,16),cipherKey:new Uint8Array(e,16,32),hmacKey:new Uint8Array(e,48,32),refKey:new Uint8Array(e,80,32)}})}function p(e,t){var n=o("WAMediaHkdfInfo").getMediaHkdfInfo(t);return m(e,n)}function _(e){var t=o("WAMediaHkdfInfo").getPreviewMediaHkdfInfo();return m(e,t)}async function f(e){var t=new Map,n=await _(e);t.set("preview",n);var r=["document","image","video","audio","md-app-state","md-msg-hist"];return await Promise.all(r.map(function(n){return p(e,n).then(function(e){t.set(n,e)})})),t}function g(e){switch(e){case"image":case"video":return e;default:return null}}var h=16,y=16,C=10,b=64*1024;async function v(e,t,n,r,a){var i=new(o("WABinary")).Binary;i.ensureCapacity(y+r.byteLength+h+C),i.writeByteArray(t);for(var l=new(o("WACryptoAesCbc")).AesCbcStream(i,"encrypt",e,t),s=0,u=s+b;u<r.byteLength;){var c=r.slice(s,u);await l.append(new Uint8Array(c)),s=u,u+=b}var d=await r.slice(s);await l.finalize(new Uint8Array(d));var m=i.peek(function(e){return e.readByteArrayView()}),p=await o("WACryptoHmac").encodeKeySha256(n),_=await o("WACryptoHmac").sign(p,m);i.writeByteArray(new Uint8Array(_,0,C));var f=i.readByteArrayView(),g=f.subarray(y),v=await Promise.all([o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",g),o("WAMediaCryptoSidecar").shouldHaveStreamingSidecar(a)?o("WAMediaCryptoSidecar").calculateStreamingSidecar(p,f):void 0]),S=v[0],R=v[1];return{ciphertext:g,ciphertextHash:S,sidecar:R,ivCiphertext:m,ivCiphertextHmac:f}}async function S(e,t,n){var r=await o("WACryptoHmac").encodeKeySha256(e),a=o("WABinary").Binary.build(t,n).readByteArrayView();return o("WACryptoHmac").sign(r,a)}async function R(e,t,n,r,a){if(!(10<=a.length&&a.length<=32))throw new c("Bad hmac size "+a.length);var i=o("WABinary").Binary.build(t,n).readByteArrayView(),l=await o("WACryptoHmac").hmacSha256(r,i).then(function(e){return new Uint8Array(e)}),s=l.slice(0,a.length);if(!I(s,a))throw new c("hmacAndDecrypt hmac mismatch");var u=await o("WACryptoAesCbc").aesCbcDecrypt(e,t,n),d=await o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",u);return{plaintextHash:o("WAHashUtils").toPlaintextHash(d),plaintext:u}}function L(e,t,n,r,a){if(!(10<=a.length&&a.length<=32))throw new c("Bad hmac size "+a.length);var i=o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[t,n]);return o("WACryptoHmac").hmacSha256(r,i,a.length).then(function(e){return new Uint8Array(e)}).then(function(e){if(!o("WACryptoUtils").uint8ArraysEqual(e,a))throw new c("hmacAndDecrypt hmac mismatch")}).then(function(){var e=n.byteLength%h===C;return e===!0?n.subarray(0,-10):n}).then(function(n){return E(e,t,n)})}function E(e,t,n){var r=n.subarray(-h);return o("WACryptoAesCbc").aesCbcEncrypt(e,d,r).then(function(e){return e.slice(y)}).then(function(e){return o("WABinary").Binary.build(n,e).readByteArrayView()}).then(function(n){return o("WACryptoAesCbc").aesCbcDecrypt(e,t,n)}).then(function(e){return new Uint8Array(e,0,e.byteLength-d.byteLength)}).then(function(e){return{plaintext:e,nextIv:r}})}async function k(t,n,a,i,l,c){l>c.scanLengths.length&&u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["decryptPartialChunks targetScan greater length of scanLength array"])));var d=Math.min(l,c.scanLengths.length);if(d<1)throw u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt partial due to invalid target scan"]))),r("err")("Unable to decrypt partial due to invalid target scan");for(var m=new(o("WABinary")).Binary,p=[],_=0;_<d;_++)p.push(new Uint8Array(c.sidecar,_*10,10));for(var f=0,g=n,h=0,y=0;y<d;y++){var C=c.alignedScanLengths[y],b=f+C,v=a.subarray(f,b),S=await L(t,g,v,i,p[y]),R=S.nextIv,E=S.plaintext;m.write(E),f+=C,g=R,h+=c.scanLengths[y]}var k=m.readBuffer(h),I=await o("WACryptoSha256").sha256(k);return{plaintextHash:o("WAHashUtils").toPlaintextHash(I),plaintext:k}}function I(e,t){if(e.length!==t.length)return!1;for(var n=1,r=e.length,o=0;o<r;o++)n&=e[o]===t[o]?1:0;return n!==0}l.HmacValidationError=c,l.DEFAULT_PADDING=d,l.computeMediaKeys=p,l.computeMediaKeysForPreview=_,l.deprecated_getAllCommonComputedMediaKeys=f,l.convertServerMediaTypeToPreviewMediaType=g,l.CBC_BLOCK_SIZE=h,l.IV_LENGTH=y,l.HMAC_LENGTH=C,l.encryptAndHmac=v,l.hmacCiphertext=S,l.hmacAndDecrypt=R,l.hmacAndDecryptPartial=L,l.decryptPartialChunks=k}),98);
__d("WAAlignChunkLengthsToMultipleOfAesBlockSize",[],(function(t,n,r,o,a,i){"use strict";function e(e){return parseInt((e+15)/16,10)*16}function l(t,n){for(var r=[],o=0,a=0,i=0,l=0;l<t.length;++l)if(o+=t[l],l===t.length-1&&n!=null&&n>0){o>a?r.push(n-a):(r.pop(),r.push(n-i));break}else if(o>a){var s=e(o-a);i=a,r.push(s),a+=s}return r}i.alignChunkSizeToMultipleAesBlockSize=e,i.alignChunkLengthsToMultipleOfAesBlockSize=l}),66);
__d("WAProgressiveJpegAlignScanLengths",["WAAlignChunkLengthsToMultipleOfAesBlockSize"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.scanLengths,n=e.totalEncryptedBytes;return o("WAAlignChunkLengthsToMultipleOfAesBlockSize").alignChunkLengthsToMultipleOfAesBlockSize(t.map(function(e){return e}),n).map(function(e){return e})}function s(e){return e}l.progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize=e,l.toProgressiveJpegAlignedScanLength=s}),98);
__d("WAProgressiveJpegGetPJpegDetails",["WAMediaCrypto","WAProgressiveJpegAlignScanLengths","WAProgressiveJpegGetScanLengths","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS(["WAProgressiveJpegDetails"]);function m(e){var t=e.ciphertextLength,n=e.progressiveJpegDetails;return babelHelpers.extends({},n,{alignedScanLengths:o("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:n.scanLengths,totalEncryptedBytes:t})})}async function p(e,t,n){var r=t.byteLength-o("WAMediaCrypto").IV_LENGTH,a=o("WAProgressiveJpegGetScanLengths").getProgressiveJpegScanLengths(e),i=o("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:a,totalEncryptedBytes:r}),l=await _(i,t,n);return{scanLengths:a,sidecar:l}}async function _(e,t,n){for(var r=new Uint8Array(e.length*10),a=0,i=0,l=t.slice(0,16),s=t.slice(16),u=0;u<e.length;u++){var c=e[u];i=a+c;var d=s.subarray(a,i),m=(await o("WAMediaCrypto").hmacCiphertext(n,l,d)).slice(0,10);r.set(new Uint8Array(m),u*10),l=d.slice(d.length-16,d.length),a=i}return r.buffer}function f(t){return t.sidecar.byteLength%o("WAMediaCrypto").HMAC_LENGTH!==0?(d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar has an invalid length"]))),o("WAResultOrError").makeError("pjpeg-check-sidecar-invalid-length")):t.scanLengths.length>0&&t.sidecar.byteLength===0?(d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar is missing"]))),o("WAResultOrError").makeError("pjpeg-check-no-sidecar")):t.scanLengths.length===0?o("WAResultOrError").makeResult(!1):t.scanLengths.length*o("WAMediaCrypto").HMAC_LENGTH!==t.sidecar.byteLength?(d.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar size mismatch"]))),o("WAResultOrError").makeError("pjpeg-check-scan-length-mismatch")):t.scanLengths.length<3?(d.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg has too few scans"]))),o("WAResultOrError").makeError("pjpeg-too-few-scans")):o("WAResultOrError").makeResult(!0)}function g(e,t){var n=0;if(t===0)return 0;for(var r=0;r<t;r++){var o=e[r];o!=null&&(n+=o)}return n}function h(e){var t=e.progressiveJpegDetails;if(t==null)return o("WAResultOrError").makeResult(null);var n=f(t);return n.success===!1?n:n.value===!0?o("WAResultOrError").makeResult({scanLengths:t.scanLengths,sidecar:t.sidecar}):o("WAResultOrError").makeResult(null)}l.getExtendedProgressiveJpegDetails=m,l.getProgressiveJpegDetails=p,l.isValidProgressiveJpegDetails=f,l.getTotalByteSizeForScan=g,l.maybeGetProgressiveJpegDetailsUsingMediaEntry=h}),98);
__d("WAStartMediaDownloadQplFlow",["QPLFlow","WAGetPlatformFromStanzaId","WAGetStorageQplAnnotations","WAJids","WAMediaUtils","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=6e5;function s(t){var n=t.downloadEntry,a=t.isPreview,i=t.msgType,l=t.protocolMsgId,s=t.triggerUIView,u=t.xmaMediaType,c=o("QPLFlow").startQPLFlow(r("qpl")._(25312150,"83"),{annotations:{bool:{isTransformStreamSupported:o("WAMediaUtils").isTransformStreamSupported()},string:{chat_type:l==null?null:o("WAJids").switchOnMsgrChatJidType(l.chat,{group:function(){return"group"},user:function(){return"user"}}),downloadEntry:a===!0?n+"-preview":n,e2eePlatform:l==null?null:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(l.externalId),msgType:i,trigger_ui_view:s,xmaMediaType:u!=null?u:void 0}},timeoutInMs:e});return o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){c.addAnnotations(e)}),babelHelpers.extends({},c,{downloadEntry:n,triggerUIView:s})}l.QPL_MEDIA_DOWNLOAD_TIMEOUT_IN_MS=e,l.startMediaDownloadQplFlow=s}),98);
__d("WADownloadDownloadablePreview",["WADownloadMedia","WAMediaCrypto","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAStartMediaDownloadQplFlow"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WADownloadMedia").mediaDownloadLogger.TAGS(["DownloadDownloadablePreview"]);async function f(t,n,r,a,i,l,f){var g=l.handleMediaPreviewBeforeDownload,h=l.handleMediaPreviewDownloadFailed,y=a.downloadableThumbnail,C=y==null?void 0:y.directPath,b=C!=null,v=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(a);if(_.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["thumbnail_available: ",""])),b),y==null||C==null)return _.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No downloadableThumbnail. Skipping..."]))),o("WAResultOrError").makeError("preview-not-supported");_.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["DownloadableThumbnail exists. Attempting to download."])));var S=y.fileEncSha256,R=y.fileSha256,L=y.mediaKey,E=y.objectId,k=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:t,downloadEntry:i,msgType:null,triggerUIView:f,isPreview:!0});if(k.addAnnotations({bool:{duplicateDirectPath:C===a.directPath,isProgressiveJpeg:v.success===!0,hasObjectId:E!=null},string:{mediaType:"preview",fullSizeMediaType:a.serverMediaType}}),k.addPoint("wa_protocol_media_download_start"),C==null||S==null||R==null||L==null)return _.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - mediaEntryData "," is incomplete for media preview"])),a),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-incomplete-media-entry"}}),o("WAResultOrError").makeError("media-entry-invalid");var I=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(r);if(I==null)return _.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""])),r),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-unsupported-type"}}),o("WAResultOrError").makeError("request-error");await g(n);var T=await o("WADownloadMedia").downloadMediaImpl({downloadFlow:k,mediaTypeDetails:{messageType:I,type:"preview"},directPath:C,fileEncSha256:S,fileSha256:R,mediaKey:L});return T.success===!1?(_.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["failed to download media. Reason: ",""])),T.error),h(n,T.error),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:T.error}}),T):(_.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["finished downloading"]))),k.addPoint("wa_protocol_media_download_end"),k.endSuccess(),o("WAResultOrError").makeResult(T.value))}l.maybeDownloadDownloadablePreview=f}),98);
__d("WADecryptMedia",["WAMediaCrypto","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["WADecryptMedia"]);async function f(t,n,r,a){_.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Encountered enc-hash-mismatch - looking for a potential working hmac salt"])));var i=r.type==="preview"?"preview":r.mediaType,l=await o("WAMediaCrypto").deprecated_getAllCommonComputedMediaKeys(a),d;for(var m of l){var p=m[0],f=m[1];try{if(p===i)continue;_.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Trying "," as an alternative hmac salt."])),p);var g=o("WAResultOrError").makeResult(await o("WAMediaCrypto").hmacAndDecrypt(f.cipherKey,f.iv,t,f.hmacKey,n));return d={hmacAndDecryptResult:g,alternativeHmacSaltUsed:p},_.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Found a working hmac salt using ","."])),p),d}catch(e){_.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," is not a working hmac salt."])),p);continue}}return{hmacAndDecryptResult:o("WAResultOrError").makeError("enc-hash-mismatch")}}async function g(e){var t=e.ciphertextHmac,n=e.mediaKey,r=e.mediaTypeDetails,a=e.plaintextHash;_.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Using default plaintext verifier"])));var i=t.byteLength-o("WAMediaCrypto").HMAC_LENGTH,l=new Uint8Array(t,i),s=new Uint8Array(t,0,i),u;r.type==="preview"?u=o("WAMediaCrypto").computeMediaKeysForPreview(n):u=o("WAMediaCrypto").computeMediaKeys(n,r.mediaType);var c,g=null;if(c=await u.then(function(e){var t=e.cipherKey,n=e.hmacKey,r=e.iv;return o("WAMediaCrypto").hmacAndDecrypt(t,r,s,n,l)}).then(o("WAResultOrError").makeResult).catch(function(e){return _.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""])),e),e instanceof o("WAMediaCrypto").HmacValidationError?o("WAResultOrError").makeError("enc-hash-mismatch"):o("WAResultOrError").makeError("decryption-error")}),c.success===!1&&c.error==="enc-hash-mismatch"){var h=await f(s,l,r,n);c=h.hmacAndDecryptResult,g=h.alternativeHmacSaltUsed}if(!c.success)return c;var y=c.value,C=y.plaintext,b=y.plaintextHash;return a!==b?o("WAResultOrError").makeError("hash-mismatch"):(_.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Success"]))),o("WAResultOrError").makeResult({plaintext:C,alternativeHmacSaltUsed:g}))}l.decryptMedia=g}),98);
__d("WAArrayUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}function l(e,t){var n=e.pop();t<e.length&&(e[t]=n)}function*s(e,t){for(var n=0;n<e.length;n+=t)yield e.slice(n,n+t)}function u(t,n){return c(t,n,e)}function c(e,t,n){var r=new Map;for(var o of e){var a,i=t(o),l=(a=r.get(i))!=null?a:[];l.push(n(o)),r.set(i,l)}return r}i.removeIndexWithoutPreservingOrder=l,i.peekEvery=s,i.groupBy=u,i.groupByAndMap=c}),66);
__d("WABaseGlobals",["err"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){e=t}function u(){if(e==null)throw r("err")("Trying to access WAGlobals before being set");return e}function c(e){var t=u();t.myJids=e}function d(){var e,t=(e=u().myJids)==null?void 0:e.deviceJid;if(t==null)throw r("err")("Trying to access myDeviceJid, but it's not set");return t}function m(){var e,t=(e=u().myJids)==null?void 0:e.userJid;if(t==null)throw r("err")("Trying to access myUserJid, but it's not set");return t}function p(){return u().jidUtils}function _(){return u().qpl}function f(){return e==null?!1:u().newClockSkewCalculation()}l.setGlobals=s,l.setMyJids=c,l.getMyDeviceJid=d,l.getMyUserJid=m,l.getJidUtilsApi=p,l.getQplConfig=_,l.newClockSkewCalculation=f}),98);
__d("WAErrors",["WACustomError"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="BufferTooLargeError",n}return babelHelpers.inheritsLoose(t,e),t})((e=o("WACustomError")).CustomError),u=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Disconnected",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError),c=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Offline",n}return babelHelpers.inheritsLoose(t,e),t})(u),d=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="MaxRetries",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError),m=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Aborted",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError);l.BufferTooLargeError=s,l.Disconnected=u,l.Offline=c,l.MaxRetries=d,l.Aborted=m}),98);
__d("WANotifyConnectionChangeFactory",[],(function(t,n,r,o,a,i){"use strict";var e=15e3;function l(t,n,r){r===void 0&&(r=e);var o={timeoutID:null,connectionStatus:"disconnected",optimismLevel:"optimist"},a=function(){var e=o.connectionStatus,t=o.optimismLevel;t==="optimist"?o.timeoutID=setTimeout(function(){o.optimismLevel="realist",n(e)},r):n(e)};return function(e){o.connectionStatus=e,e==="disconnected"||e==="in_handshake"?a():(o.timeoutID!=null&&(clearTimeout(o.timeoutID),o.timeoutID=null),n(e)),t(e)}}i.notifyConnectionChangeFactory=l}),66);
__d("WAPromiseRetryLoop",["Promise","WALogger","WAPromiseBackoffs","WAPromiseDelays","WAResolvable","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=(function(){function t(e){var t=this;this.$2=new(o("WAResolvable")).Resolvable,this.$3=null,this.$4=null,this.$5=0,this.$6=new(o("WAResolvable")).Resolvable,this.endWithValue=function(e){t.$5++,t.$2.resolve(e)},this.$1=e}var a=t.prototype;return a.resetTimeoutAfter=function(t){this.$4=Date.now()+t},a.cancelReset=function(){this.$4=null},a.reset=function(){this.$2.resolveWasCalled()||(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: resetting ",""])),this.$1.name),this.$5++,this.$6.resolve(),this.$7())},a.start=function(){this.$2.resolveWasCalled()||(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: starting ",""])),this.$1.name),this.$5!==0&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop was called several times. You may have race conditions"]))),this.$5++,this.$6.resolve(),this.$7())},a.pauseOnNextIteration=function(){o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: pause requested on next iteration"]))),this.$6.resolve(),this.$6=new(o("WAResolvable")).Resolvable},a.unpause=function(){this.$6.resolveWasCalled()||o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: loop unpaused"]))),this.$6.resolve()},a.$7=function(){var e=this,t=this.$1,r=this.$5,a=o("WAPromiseBackoffs").createTimer(this.$1.timer);a();var i=function(){return e.$1.isPauseEnabled!==!0?(f||(f=n("Promise"))).resolve():(e.$6.resolveWasCalled()||o("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: loop paused - waiting for unpause"]))),e.$6.promise)},l=function(){if(!e.$2.resolveWasCalled()&&r===e.$5){var n=Date.now();return e.$3=(0,t.code)(e.endWithValue).then(function(){if(!e.$2.resolveWasCalled()){var r=t.resetDelay;(r!==void 0&&Date.now()>=n+r||e.$4!=null&&e.$4<=Date.now())&&(o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: resetting ",""])),t.name),a=o("WAPromiseBackoffs").createTimer(e.$1.timer)),e.$4=null;var s=a();return o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: retrying "," in ","ms"])),t.name,s),o("WAPromiseDelays").delayMs(s).then(i).then(l)}}),e.$3}};this.$3=(f||(f=n("Promise"))).resolve().then(l)},a.promise=function(){var e=this;return this.$2.resolveWasCalled()?this.$2.promise:this.$3?(f||(f=n("Promise"))).race([this.$2.promise,this.$3.then(function(){return e.$2.promise})]):(f||(f=n("Promise"))).reject(r("err")("PromiseRetryLoop "+this.$1.name+" had promise() called before start()"))},t})();l.PromiseRetryLoop=g}),98);
__d("WASmaxInPingsEnums",["WAJids"],(function(t,n,r,o,a,i,l){var e={validators:[o("WAJids").validateDomainJid,o("WAJids").validateUserJid],typeName:"DomainJid|UserJid"};l.DOMAINJID_USERJID=e}),98);
__d("WADeepEquals",[],(function(t,n,r,o,a,i){"use strict";function e(t,n){if(t===n)return!0;if(!t||!n||typeof t!="object"&&typeof n!="object")return!1;var r=Array.isArray(t),o=Array.isArray(n);if(r!==o)return!1;var a=!0;if(r){var i=t.length;if(i!==n.length)return!1;for(var l=0;a&&l<i;l++)a=e(t[l],n[l]);return a}for(var s=Object.keys(t),u=0;a&&u<s.length;u++){var c=s[u];a=n.propertyIsEnumerable(c)&&e(t[c],n[c])}return a&&Object.keys(n).length===s.length}i.deepEqual=e}),66);
__d("WAWapJid",["$InternalEnum","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e={JID:0,JID_U:1,JID_AD:1,JID_FB:3,JID_INTEROP:4},s=n("$InternalEnum")({WHATSAPP:0,LID:1,HOSTED:128,HOSTED_LID:129}),u=(function(){function t(e){this.$1=e}t.createAD=function(r,o,a){return new t({type:e.JID_AD,user:r,device:a==null?0:a,agent:o==null?0:o,domainType:s.WHATSAPP})},t.createJidU=function(r,o,a){return new t({type:e.JID_U,user:r,device:a==null?0:a,domainType:o==null?s.WHATSAPP:o})},t.createFbJid=function(r,o){var n=o==null?0:o;return new t({type:e.JID_FB,user:r,device:n})},t.createInteropJid=function(r,o,a){var n=o==null?0:o;return new t({type:e.JID_INTEROP,user:r,device:n,integrator:a})},t.create=function(r,o){return new t({type:e.JID,user:r,server:o})};var n=t.prototype;return n.toString=function(){if(this.$1.type===e.JID_AD||this.$1.type===e.JID_U){var t=this.$1,n=t.device,r=t.domainType,a=t.user,i="";return r===s.WHATSAPP?i=o("WAJids").WA_USER_JID_SUFFIX:r===s.HOSTED?i=o("WAJids").HOSTED_SUFFIX:r===s.HOSTED_LID?i=o("WAJids").HOSTED_LID_SUFFIX:i=o("WAJids").LID_SUFFIX,n===0?a+"@"+i:a+":"+n+"@"+i}else if(this.$1.type===e.JID_FB){var l=this.$1,u=l.device,c=l.user,d=o("WAJids").MSGR_USER_JID_SUFFIX;return c+":"+u+"@"+d}else if(this.$1.type===e.JID_INTEROP){var m=this.$1,p=m.device,_=m.integrator,f=m.user,g=o("WAJids").INTEROP_USER_JID_SUFFIX;return _+"-"+f+":"+p+"@"+g}else{this.$1.type;var h=this.$1,y=h.server,C=h.user;return C!=null?C+"@"+y:y}},n.getInnerJid=function(){return this.$1},t})();l.WAP_JID_SUBTYPE=e,l.DomainType=s,l.WapJid=u}),98);
__d("WASmaxParseUtils",["WABase64","WABinary","WACryptoUtils","WADeepEquals","WAHasProperty","WAResultOrError","WAStanzaUtils","WAWapJid","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WAResultOrError").makeResult();function s(t,n){return t.tag!==n?O(t,"to be <"+n+">"):e}function u(e,t){return B(e,t)?W(e,e.attrs[t]):O(e,'to have attribute "'+t+'"')}function c(e,t,n,r){var a=u(e,t);if(!a.success)return a;var i=n(a.value);return i!=null?o("WAResultOrError").makeResult(i):O(e,'to have "'+t+'"={'+r+'}, but instead has "'+a.value+'"')}function d(e,t,n){var r=P(e);if(!r.success)return r;var a=t(r.value);return a!=null?o("WAResultOrError").makeResult(a):O(e,"to have "+n+' content, but instead has "'+r.value+'"')}function m(t,n,r){var o=u(t,n);if(o.success){if(o.value!==r)return O(t,'to have "'+n+'"="'+r+'", but instead has "'+o.value+'"')}else return o;return e}function p(e,t){return c(e,t,o("WAStanzaUtils").toStanzaId,"stanzaID")}function _(e,t){return c(e,t,o("WAStanzaUtils").validateCallId,"callID")}function f(e,t){return c(e,t,q,"integer")}function g(e,t,n,r){var a=f(e,t);if(!a.success)return a;var i=a.value;return n!==void 0&&i<n?O(e,'to have "'+t+'"={at least '+n+"} but has value "+i):r!==void 0&&i>r?O(e,'to have "'+t+'"={at most '+r+"} but has value "+i):o("WAResultOrError").makeResult(i)}function h(e){var t=e.content;return t instanceof Uint8Array?O(e,"to have children"):o("WAResultOrError").makeResult(t)}function y(t,n){var r=h(t);if(!r.success)return r;var a=r.value;if(a==null)return e;for(var i=null,l=0;l<a.length;l++){var s=a[l];if(s.tag===n){if(i!=null)return O(t,"to have 1 child <"+n+">, but found more than 1");i=s}}return o("WAResultOrError").makeResult(i)}function C(t,n,r){var o=y(t,n);return o.success?o.value==null?e:r(o.value):o}function b(e,t,n){var r=C(e,t,n);if(!r.success)return r;var a=r.value;return a==null?O(e,"to have 1 child <"+t+">, but found 0"):o("WAResultOrError").makeResult(a)}function v(e,t){var n=y(e,t);return n.success?n.value==null?O(e,"to have 1 child <"+t+">, but found 0"):o("WAResultOrError").makeResult(n.value):n}function S(e,t,n,r,a){var i=U(e,t,n,r);if(!i.success)return i;for(var l=[],s=0;s<i.value.length;s++){var u=a(i.value[s]);if(!u.success)return u;l.push(u.value)}return o("WAResultOrError").makeResult(l)}function R(e,t,n,r,a){var i=U(e,t,n,r);if(!i.success)return i;for(var l=i.value.length,s=0;s<l;s++){var u=a(i.value[s]);if(!u.success)return u}return o("WAResultOrError").makeResult(l)}function L(e,t,n){var r=S(e,t,0,1/0,n);if(!r.success)return r;for(var a=0;a<r.value.length;a++)if(!o("WADeepEquals").deepEqual(r.value[0],r.value[a]))return O(e,"to have homogeneous children, but found two children that are not equal");return r}function E(e,t,n){var r=L(e,t,n);return r.success?o("WAResultOrError").makeResult(r.value.length):r}function k(t,n,r,o,a){return B(n,r)?t(n,r,o,a):e}function I(t,n,r,a){if(a==null)return e;var i=k(t,n,r);return i.success?i.value===a?o("WAResultOrError").makeResult(a):i.value==null?e:O(n,'to have "'+r+'"={'+a+'}, but instead has "'+i.value+'"'):i}function T(e,t,n,r){var a=e(t,n);return a.success?a.value===r?o("WAResultOrError").makeResult(r):O(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"'):a}function D(e,t,n){var r=e(t);return r.success?r.value===n?o("WAResultOrError").makeResult(n):O(t,'to have content "'+n+'", but instead has "'+r.value+'"'):r}function x(e,t,n){var r=u(e,t);if(!r.success)return r;var a=n[r.value];if(a!=null)return o("WAResultOrError").makeResult(a);var i=Object.values(n).join("|");return O(e,'to have "'+t+'"={'+i+'}, but instead has "'+r.value+'"')}function $(e,t){var n=P(e);if(!n.success)return n;var r=t[n.value];if(r!=null)return o("WAResultOrError").makeResult(r);var a=Object.values(t).join("|");return O(e,'to have content "'+a+'", but instead has "'+n.value+'"')}function P(e){var t=N(e);if(t.success)try{var n=new(o("WABinary")).Binary(t.value),a=n.readString(n.size());return o("WAResultOrError").makeResult(a)}catch(t){return O(e,"to have string content, but run into decoding error: "+r("getErrorSafe")(t).message)}else return t}function N(e){var t=e.content;return t==null?O(e,"to have content"):Array.isArray(t)?O(e,"to have content, but has children instead"):o("WAResultOrError").makeResult(t)}function M(e,t){var n=N(e);return n.success?o("WACryptoUtils").uint8ArraysEqual(n.value,t)?o("WAResultOrError").makeResult(t):O(e,'to have content ":binary:'+o("WABase64").encodeB64(t)+'", but instead has ":binary:'+o("WABase64").encodeB64(n.value)+'"'):n}function w(e,t,n){var r=e.content;if(r==null)return t===void 0||t<1?o("WAResultOrError").makeResult(new Uint8Array([])):O(e,"to have content");if(Array.isArray(r))return O(e,"to have content, but has children instead");var a=r.length;return t!==void 0&&a<t?O(e,"to have binary content at least "+t+" bytes but has "+a+" bytes"):n!==void 0&&a>n?O(e,"to have binary content at most "+n+" bytes but has "+a+" bytes"):o("WAResultOrError").makeResult(r)}function A(e){return d(e,q,"integer")}function F(e){return e}function O(e,t){return o("WAResultOrError").makeError("expected <"+e.tag+">: "+t)}function B(e,t){return r("WAHasProperty")(e.attrs,t)}function W(e,t){return t instanceof o("WAWapJid").WapJid?o("WAResultOrError").makeResult(t.toString()):typeof t=="string"?o("WAResultOrError").makeResult(t):O(e,"decodeAsString: attribute is "+typeof t+" not a string: "+String(t))}function q(e){var t=parseInt(e,10);return Number.isNaN(t)?null:t}function U(e,t,n,r){var a=h(e);if(!a.success)return a;var i=a.value;if(i==null)return n!==0?O(e,"to have at least "+n+" <"+t+"> children, but found 0"):o("WAResultOrError").makeResult([]);for(var l=[],s=0;s<i.length;s++){var u=i[s];u.tag===t&&l.push(u)}var c=l.length;return c<n?O(e,"to have at least "+n+" <"+t+"> children, but found "+c):c>r?O(e,"to have at most "+r+" <"+t+"> children, but found "+c):o("WAResultOrError").makeResult(l)}var V={};function H(e,t,n){var r=t.map(function(e,t){return e+": "+n[t].error});return O(e,["to match any of following mixins: "+t.join(", ")+", but all mixins failed."].concat(r).join(" "))}l.voidSuccess=e,l.assertTag=s,l.attrString=u,l.attrValidate=c,l.contentValidate=d,l.assertAttr=m,l.attrStanzaId=p,l.attrCallId=_,l.attrInt=f,l.attrIntRange=g,l.maybeChildren=h,l.optionalChild=y,l.optionalChildWithTag=C,l.childWithTag=b,l.flattenedChildWithTag=v,l.mapChildrenWithTag=S,l.countChildrenWithTag=R,l.mapHomogeneousChildrenWithTag=L,l.countHomogeneousChildrenWithTag=E,l.optional=k,l.optionalLiteral=I,l.literal=T,l.literalContent=D,l.attrStringEnum=x,l.contentStringEnum=$,l.contentString=P,l.contentBytes=N,l.contentLiteralBytes=M,l.contentBytesRange=w,l.contentInt=A,l.identity=F,l.errorMessage=O,l.emptyObject=V,l.errorMixinDisjunction=H}),98);
__d("WASmaxParseJid",["WAJids","WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateUserJid,"UserJid")}function s(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateLidUserJid,"LidUserJid")}function u(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateDeviceJid,"DeviceJid")}function c(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateGroupJid,"GroupJid")}function d(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateCallJid,"CallJid")}function m(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateDomainJid,"DomainJid")}function p(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateBroadcastJid,"BroadcastJid")}function _(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateStatusJid,"StatusJid")}function f(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateNewsletterJid,"NewsletterJid")}function g(e,t,n){var r=o("WASmaxParseUtils").attrString(e,t);if(!r.success)return r;for(var a=n.typeName,i=n.validators,l=0;l<i.length;l++){var s=i[l](r.value);if(s!=null)return o("WAResultOrError").makeResult(s)}return o("WASmaxParseUtils").errorMessage(e,'to have "'+t+'"={'+a+'}, but instead has "'+r.value+'"')}function h(e,t,n,r){var a=e(t,n);return!a.success||a.value===r?a:o("WASmaxParseUtils").errorMessage(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"')}function y(e,t,n,r){var a=o("WASmaxParseUtils").optional(e,t,n);return!a.success||a.value==null||a.value===r?a:o("WASmaxParseUtils").errorMessage(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"')}l.attrUserJid=e,l.attrLidUserJid=s,l.attrDeviceJid=u,l.attrGroupJid=c,l.attrCallJid=d,l.attrDomainJid=m,l.attrBroadcastJid=p,l.attrStatusJid=_,l.attrNewsletterJid=f,l.attrJidEnum=g,l.literalJid=h,l.optionalLiteralJid=y}),98);
__d("WASmaxParseReference",["WAHasProperty","WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,o){var a=m(t,n);if(!a.success)return _(a);var i=e(a.value,n[n.length-1],r,o);return i.success?i:_(i)}function s(t,n,r,a,i){return p(n,r)?e(t,n,r,a,i):o("WASmaxParseUtils").voidSuccess}function u(t,n){return e(o("WASmaxParseUtils").attrString,t,n)}function c(e,t){return p(e,t)?u(e,t):o("WASmaxParseUtils").voidSuccess}function d(e,t){var n=m(e,t);if(!n.success)return _(n);var r=o("WASmaxParseUtils").contentString(n.value);return r.success?r:_(r)}function m(e,t){for(var n=t.length,r=e,a=0;a<n-1;a++){var i=t[a],l=o("WASmaxParseUtils").flattenedChildWithTag(r,i);if(!l.success)return l;r=l.value}return o("WAResultOrError").makeResult(r)}function p(e,t){var n=m(e,t);return n.success&&r("WAHasProperty")(n.value.attrs,t[t.length-1])}function _(e){return o("WAResultOrError").makeError("in the reference, "+e.error)}l.attrFromReference=e,l.optionalAttrFromReference=s,l.attrStringFromReference=u,l.optionalAttrStringFromReference=c,l.contentStringFromReference=d}),98);
__d("WASmaxInPingsClientResponseServerResponse",["WAResultOrError","WASmaxInPingsEnums","WASmaxParseJid","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseJid").attrJidEnum(e,"from",o("WASmaxInPingsEnums").DOMAINJID_USERJID);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","result");if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").attrInt(e,"t");return s.success?o("WAResultOrError").makeResult({from:r.value,type:a.value,t:s.value}):s}l.parseClientResponseServerResponse=e}),98);
__d("WAWapDict",[],(function(t,n,r,o,a,i){"use strict";var e=3,l=["xmlstreamstart","xmlstreamend","s.whatsapp.net","type","participant","from","receipt","id","notification","disappearing_mode","status","jid","broadcast","user","devices","device_hash","to","offline","message","result","class","xmlns","duration","notify","iq","t","ack","g.us","enc","urn:xmpp:whatsapp:push","presence","config_value","picture","verified_name","config_code","key-index-list","contact","mediatype","routing_info","edge_routing","get","read","urn:xmpp:ping","fallback_hostname","0","chatstate","business_hours_config","unavailable","download_buckets","skmsg","verified_level","composing","handshake","device-list","media","text","fallback_ip4","media_conn","device","creation","location","config","item","fallback_ip6","count","w:profile:picture","image","business","2","hostname","call-creator","display_name","relaylatency","platform","abprops","success","msg","offline_preview","prop","key-index","v","day_of_week","pkmsg","version","1","ping","w:p","download","video","set","specific_hours","props","primary","unknown","hash","commerce_experience","last","subscribe","max_buckets","call","profile","member_since_text","close_time","call-id","sticker","mode","participants","value","query","profile_options","open_time","code","list","host","ts","contacts","upload","lid","preview","update","usync","w:stats","delivery","auth_ttl","context","fail","cart_enabled","appdata","category","atn","direct_connection","decrypt-fail","relay_id","mmg-fallback.whatsapp.net","target","available","name","last_id","mmg.whatsapp.net","categories","401","is_new","index","tctoken","ip4","token_id","latency","recipient","edit","ip6","add","thumbnail-document","26","paused","true","identity","stream:error","key","sidelist","background","audio","3","thumbnail-image","biz-cover-photo","cat","gcm","thumbnail-video","error","auth","deny","serial","in","registration","thumbnail-link","remove","00","gif","thumbnail-gif","tag","capability","multicast","item-not-found","description","business_hours","config_expo_key","md-app-state","expiration","fallback","ttl","300","md-msg-hist","device_orientation","out","w:m","open_24h","side_list","token","inactive","01","document","te2","played","encrypt","msgr","hide","direct_path","12","state","not-authorized","url","terminate","signature","status-revoke-delay","02","te","linked_accounts","trusted_contact","timezone","ptt","kyc-id","privacy_token","readreceipts","appointment_only","address","expected_ts","privacy","7","android","interactive","device-identity","enabled","attribute_padding","1080","03","screen_height"],s=["read-self","active","fbns","protocol","reaction","screen_width","heartbeat","deviceid","2:47DEQpj8","uploadfieldstat","voip_settings","retry","priority","longitude","conflict","false","ig_professional","replaced","preaccept","cover_photo","uncompressed","encopt","ppic","04","passive","status-revoke-drop","keygen","540","offer","rate","opus","latitude","w:gp2","ver","4","business_profile","medium","sender","prev_v_id","email","website","invited","sign_credential","05","transport","skey","reason","peer_abtest_bucket","America/Sao_Paulo","appid","refresh","100","06","404","101","104","107","102","109","103","member_add_mode","105","transaction-id","110","106","outgoing","108","111","tokens","followers","ig_handle","self_pid","tue","dec","thu","joinable","peer_pid","mon","features","wed","peer_device_presence","pn","delete","07","fri","audio_duration","admin","connected","delta","rcat","disable","collection","08","480","sat","phash","all","invite","accept","critical_unblock_low","group_update","signed_credential","blinded_credential","eph_setting","net","09","background_location","refresh_id","Asia/Kolkata","privacy_mode_ts","account_sync","voip_payload_type","service_areas","acs_public_key","v_id","0a","fallback_class","relay","actual_actors","metadata","w:biz","5","connected-limit","notice","0b","host_storage","fb_page","subject","privatestats","invis","groupadd","010","note.m4r","uuid","0c","8000","sun","372","1020","stage","1200","720","canonical","fb","011","video_duration","0d","1140","superadmin","012","Opening.m4r","keystore_attestation","dleq_proof","013","timestamp","ab_key","w:sync:app:state","0e","vertical","600","p_v_id","6","likes","014","500","1260","creator","0f","rte","destination","group","group_info","syncd_anti_tampering_fatal_exception_enabled","015","dl_bw","Asia/Jakarta","vp8/h.264","online","1320","fb:multiway","10","timeout","016","nse_retry","urn:xmpp:whatsapp:dirty","017","a_v_id","web_shops_chat_header_button_enabled","nse_call","inactive-upgrade","none","web","groups","2250","mms_hot_content_timespan_in_seconds","contact_blacklist","nse_read","suspended_group_deletion_notification","binary_version","018","https://www.whatsapp.com/otp/copy/","reg_push","shops_hide_catalog_attachment_entrypoint","server_sync",".","ephemeral_messages_allowed_values","019","mms_vcache_aggregation_enabled","iphone","America/Argentina/Buenos_Aires","01a","mms_vcard_autodownload_size_kb","nse_ver","shops_header_dropdown_menu_item","dhash","catalog_status","communities_mvp_new_iqs_serverprop","blocklist","default","11","ephemeral_messages_enabled","01b","original_dimensions","8","mms4_media_retry_notification_encryption_enabled","mms4_server_error_receipt_encryption_enabled","original_image_url","sync","multiway","420","companion_enc_static","shops_profile_drawer_entrypoint","01c","vcard_as_document_size_kb","status_video_max_duration","request_image_url","01d","regular_high","s_t","abt","share_ext_min_preliminary_image_quality","01e","32","syncd_key_rotation_enabled","data_namespace","md_downgrade_read_receipts2","patch","polltype","ephemeral_messages_setting","userrate","15","partial_pjpeg_bw_threshold","played-self","catalog_exists","01f","mute_v2"],u=["reject","dirty","announcement","020","13","9","status_video_max_bitrate","fb:thrift_iq","offline_batch","022","full","ctwa_first_business_reply_logging","h.264","smax_id","group_description_length","https://www.whatsapp.com/otp/code","status_image_max_edge","smb_upsell_business_profile_enabled","021","web_upgrade_to_md_modal","14","023","s_o","smaller_video_thumbs_status_enabled","media_max_autodownload","960","blocking_status","peer_msg","joinable_group_call_client_version","group_call_video_maximization_enabled","return_snapshot","high","America/Mexico_City","entry_point_block_logging_enabled","pop","024","1050","16","1380","one_tap_calling_in_group_chat_size","regular_low","inline_joinable_education_enabled","hq_image_max_edge","locked","America/Bogota","smb_biztools_deeplink_enabled","status_image_quality","1088","025","payments_upi_intent_transaction_limit","voip","w:g2","027","md_pin_chat_enabled","026","multi_scan_pjpeg_download_enabled","shops_product_grid","transaction_id","ctwa_context_enabled","20","fna","hq_image_quality","alt_jpeg_doc_detection_quality","group_call_max_participants","pkey","America/Belem","image_max_kbytes","web_cart_v1_1_order_message_changes_enabled","ctwa_context_enterprise_enabled","urn:xmpp:whatsapp:account","840","Asia/Kuala_Lumpur","max_participants","video_remux_after_repair_enabled","stella_addressbook_restriction_type","660","900","780","context_menu_ios13_enabled","mute-state","ref","payments_request_messages","029","frskmsg","vcard_max_size_kb","sample_buffer_gif_player_enabled","match_last_seen","510","4983","video_max_bitrate","028","w:comms:chat","17","frequently_forwarded_max","groups_privacy_blacklist","Asia/Karachi","02a","web_download_document_thumb_mms_enabled","02b","hist_sync","biz_block_reasons_version","1024","18","web_is_direct_connection_for_plm_transparent","view_once_write","file_max_size","paid_convo_id","online_privacy_setting","video_max_edge","view_once_read","enhanced_storage_management","multi_scan_pjpeg_encoding_enabled","ctwa_context_forward_enabled","video_transcode_downgrade_enable","template_doc_mime_types","hq_image_bw_threshold","30","body","u_aud_limit_sil_restarts_ctrl","other","participating","w:biz:directory","1110","vp8","4018","meta","doc_detection_image_max_edge","image_quality","1170","02c","smb_upsell_chat_banner_enabled","key_expiry_time_second","pid","stella_interop_enabled","19","linked_device_max_count","md_device_sync_enabled","02d","02e","360","enhanced_block_enabled","ephemeral_icon_in_forwarding","paid_convo_status","gif_provider","project_name","server-error","canonical_url_validation_enabled","wallpapers_v2","syncd_clear_chat_delete_chat_enabled","medianotify","02f","shops_required_tos_version","vote","reset_skey_on_id_change","030","image_max_edge","multicast_limit_global","ul_bw","21","25","5000","poll","570","22","031","1280","WhatsApp","032","bloks_shops_enabled","50","upload_host_switching_enabled","web_ctwa_context_compose_enabled","ptt_forwarded_features_enabled","unblocked","partial_pjpeg_enabled","fbid:devices","height","ephemeral_group_query_ts","group_join_permissions","order","033","alt_jpeg_status_quality","migrate","popular-bank","win_uwp_deprecation_killswitch_enabled","web_download_status_thumb_mms_enabled","blocking","url_text","035","web_forwarding_limit_to_groups","1600","val","1000","syncd_msg_date_enabled","bank-ref-id","max_subject","payments_web_enabled","web_upload_document_thumb_mms_enabled","size","request","ephemeral","24","receipt_agg","ptt_remember_play_position","sampling_weight","enc_rekey","mute_always","037","034","23","036","action","click_to_chat_qr_enabled","width","disabled","038","md_blocklist_v2","played_self_enabled","web_buttons_message_enabled","flow_id","clear","450","fbid:thread","bloks_session_state","America/Lima","attachment_picker_refresh","download_host_switching_enabled","1792","u_aud_limit_sil_restarts_test2","custom_urls","device_fanout","optimistic_upload","2000","key_cipher_suite","web_smb_upsell_in_biz_profile_enabled","e","039","siri_post_status_shortcut","pair-device","lg","lc","stream_attribution_url","model","mspjpeg_phash_gen","catalog_send_all","new_multi_vcards_ui","share_biz_vcard_enabled","-","clean","200","md_blocklist_v2_server","03b","03a","web_md_migration_experience","ptt_conversation_waveform","u_aud_limit_sil_restarts_test1"],c=["64","ptt_playback_speed_enabled","web_product_list_message_enabled","paid_convo_ts","27","manufacturer","psp-routing","grp_uii_cleanup","ptt_draft_enabled","03c","business_initiated","web_catalog_products_onoff","web_upload_link_thumb_mms_enabled","03e","mediaretry","35","hfm_string_changes","28","America/Fortaleza","max_keys","md_mhfs_days","streaming_upload_chunk_size","5541","040","03d","2675","03f","...","512","mute","48","041","alt_jpeg_quality","60","042","md_smb_quick_reply","5183","c","1343","40","1230","043","044","mms_cat_v1_forward_hot_override_enabled","user_notice","ptt_waveform_send","047","Asia/Calcutta","250","md_privacy_v2","31","29","128","md_messaging_enabled","046","crypto","690","045","enc_iv","75","failure","ptt_oot_playback","AIzaSyDR5yfaG7OG8sMTUj8kfQEb8T9pN8BM6Lk","w","048","2201","web_large_files_ui","Asia/Makassar","812","status_collapse_muted","1334","257","2HP4dm","049","patches","1290","43cY6T","America/Caracas","web_sticker_maker","campaign","ptt_pausable_enabled","33","42","attestation","biz","04b","query_linked","s","125","04a","810","availability","1411","responsiveness_v2_m1","catalog_not_created","34","America/Santiago","1465","enc_p","04d","status_info","04f","key_version","..","04c","04e","md_group_notification","1598","1215","web_cart_enabled","37","630","1920","2394","-1","vcard","38","elapsed","36","828","peer","pricing_category","1245","invalid","stella_ios_enabled","2687","45","1528","39","u_is_redial_audio_1104_ctrl","1025","1455","58","2524","2603","054","bsp_system_message_enabled","web_pip_redesign","051","verify_apps","1974","1272","1322","1755","052","70","050","1063","1135","1361","80","1096","1828","1851","1251","1921","key_config_id","1254","1566","1252","2525","critical_block","1669","max_available","w:auth:backup:token","product","2530","870","1022","participant_uuid","web_cart_on_off","1255","1432","1867","41","1415","1440","240","1204","1608","1690","1846","1483","1687","1749","69","url_number","053","1325","1040","365","59","Asia/Riyadh","1177","test_recommended","057","1612","43","1061","1518","1635","055","1034","1375","750","1430","event_code","1682","503","55","865","78","1309","1365","44","America/Guayaquil","535","LIMITED","1377","1613","1420","1599","1822","05a","1681","password","1111","1214","1376","1478","47","1082","4282","Europe/Istanbul","1307","46","058","1124","256","rate-overlimit","retail","u_a_socket_err_fix_succ_test","1292","1370","1388","520","861","psa","regular","1181","1766","05b","1183","1213","1304","1537"],d=["1724","profile_picture","1071","1314","1605","407","990","1710","746","pricing_model","056","059","061","1119","6027","65","877","1607","05d","917","seen","1516","49","470","973","1037","1350","1394","1480","1796","keys","794","1536","1594","2378","1333","1524","1825","116","309","52","808","827","909","495","1660","361","957","google","1357","1565","1967","996","1775","586","736","1052","1670","bank","177","1416","2194","2222","1454","1839","1275","53","997","1629","6028","smba","1378","1410","05c","1849","727","create","1559","536","1106","1310","1944","670","1297","1316","1762","en","1148","1295","1551","1853","1890","1208","1784","7200","05f","178","1283","1332","381","643","1056","1238","2024","2387","179","981","1547","1705","05e","290","903","1069","1285","2436","062","251","560","582","719","56","1700","2321","325","448","613","777","791","51","488","902","Asia/Almaty","is_hidden","1398","1527","1893","1999","2367","2642","237","busy","065","067","233","590","993","1511","54","723","860","363","487","522","605","995","1321","1691","1865","2447","2462","NON_TRANSACTIONAL","433","871","432","1004","1207","2032","2050","2379","2446","279","636","703","904","248","370","691","700","1068","1655","2334","060","063","364","533","534","567","1191","1210","1473","1827","069","701","2531","514","prev_dhash","064","496","790","1046","1139","1505","1521","1108","207","544","637","final","1173","1293","1694","1939","1951","1993","2353","2515","504","601","857","modify","spam_request","p_121_aa_1101_test4","866","1427","1502","1638","1744","2153","068","382","725","1704","1864","1990","2003","Asia/Dubai","508","531","1387","1474","1632","2307","2386","819","2014","066","387","1468","1706","2186","2261","471","728","1147","1372","1961"],m=[s,u,c,d];i.DICT_VERSION=e,i.SINGLE_BYTE_TOKEN=l,i.DICTIONARY_0_TOKEN=s,i.DICTIONARY_1_TOKEN=u,i.DICTIONARY_2_TOKEN=c,i.DICTIONARY_3_TOKEN=d,i.DICTIONARIES=m}),66);
__d("WAXmlFormatter",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=e.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns:/g,"~::~xmlns:").replace(/\s*xmlns=/g,"~::~xmlns=").split("~::~"),n=t.length,r=!1,o=0,a="",i=0,s=["\n"];for(i=0;i<100;i++)s.push(s[i]+"    ");var u=function(t,n){var e=/^<[\w:\-.,]+/.exec(t[n-1]),r=/^<\/[\w:\-.,]+/.exec(t[n]);return e!=null&&r!=null&&e[0]===r[0]};for(i=0;i<n;i++)t[i].search(/<!/)>-1?(a+=s[o]+t[i],r=!0,(t[i].search(/-->/)>-1||t[i].search(/\]>/)>-1||t[i].search(/!DOCTYPE/)>-1)&&(r=!1)):t[i].search(/-->/)>-1||t[i].search(/\]>/)>-1?(a+=t[i],r=!1):u(t,i)?(a+=t[i],r||o--):t[i].search(/<\w/)>-1&&t[i].search(/<\//)===-1&&t[i].search(/\/>/)===-1?(t[i]=l(t[i]),a=r?a+=t[i]:a+=s[o++]+t[i]):t[i].search(/<\w/)>-1&&t[i].search(/<\//)>-1?a=r?a+=t[i]:a+=s[o]+t[i]:t[i].search(/<\//)>-1?a=r?a+=t[i]:a+=s[o===0?o:--o]+t[i]:t[i].search(/\/>/)>-1?a=r?a+=t[i]:a+=s[o]+t[i]:t[i].search(/<\?/)>-1||t[i].search(/xmlns:/)>-1||t[i].search(/xmlns=/)>-1?a+=s[o]+t[i]:a+=t[i];return a[0]==="\n"?a.slice(1):a}function l(e){var t=e.match(/(<query.*>|<result>)(\{.*\})/);if(t===null)return e;try{var n=t[1],r=JSON.stringify(JSON.parse(t[2]),null,2);return n+"\n"+r}catch(t){return e+"[Error formatting JSON]"}}i.default=e}),66);
__d("WAXmlNode",["WAHex"],(function(t,n,r,o,a,i,l){"use strict";var e={},s=(function(){function t(t,n,r){n===void 0&&(n=e),r===void 0&&(r=null),this.tag=t,this.attrs=n,this.content=r}var n=t.prototype;return n.toString=function(){var e="<"+this.tag;e+=u(this.attrs);var t=this.content;return Array.isArray(t)?e+=">"+t.map(String).join("")+"</"+this.tag+">":t instanceof Uint8Array?e+=">"+c(t)+"</"+this.tag+">":t!=null?e+=">"+String(t)+"</"+this.tag+">":e+=" />",e},t})();function u(e){for(var t=Object.keys(e),n="",r=0;r<t.length;r++){var o=t[r];n+=" "+o+'="'+e[o].toString()+'"'}return n}function c(e){var t="";return e.length===0?t="<!-- empty binary -->":e.length<50?t=o("WAHex").bytesToDebugString(e):t="<!-- "+e.length+" bytes -->",t}l.XmlNode=s,l.attrsToString=u,l.uint8ArrayToDebugString=c}),98);
__d("WAWap",["WAAssertUnreachable","WABinary","WACryptoDependencies","WAJids","WALogger","WALongInt","WATextEncoding","WAWapDict","WAWapJid","WAXmlFormatter","WAXmlNode","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=(s=o("WAJids")).MSGR_USER_DOMAIN.replace("@",""),d=s.WA_USER_DOMAIN.replace("@",""),m=s.LID_DOMAIN.replace("@",""),p=s.INTEROP_DOMAIN.replace("@",""),_=s.HOSTED_DOMAIN.replace("@",""),f=2,g=128,h=0,y=236,C=237,b=238,v=239,S=[y,C,b,v],R=245,L=246,E=247,k=248,I=249,T=250,D=251,x=252,$=253,P=254,N=255,M=["0","1","2","3","4","5","6","7","8","9","-",".","\uFFFD","\uFFFD","\uFFFD","\uFFFD"],w=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],A="",F=1,O={sentinel:"DROP_ATTR"},B=(u=o("WAWapJid")).WapJid.create(null,"g.us"),W=u.WapJid.create(null,s.WA_SERVER_JID_SUFFIX),q=u.WapJid.create("status","broadcast"),U=u.WapJid.create(null,"newsletter"),V=u.WapJid.create(null,"hosted"),H=u.WapJid.create(null,"hosted.lid"),G=u.WapJid.create(null,"call"),z={},j=!1;function K(){j=!0}var Q=o("WATextEncoding").newTextEncoder(),X=(function(){function e(e,t,n){t===void 0&&(t=z),n===void 0&&(n=null),this.tag=e,this.attrs=t,this.content=n}var t=e.prototype;return t.toString=function(){var e="<"+this.tag;e+=o("WAXmlNode").attrsToString(this.attrs);var t=this.content;return Array.isArray(t)?e+=">"+t.map(String).join("")+"</"+this.tag+">":t?e+=">"+o("WAXmlNode").uint8ArrayToDebugString(t)+"</"+this.tag+">":e+=" />",j&&(e=r("WAXmlFormatter")(e)),e},e})();function Y(e,t,n){var a=null;if(t&&t.children!=null)throw r("err")('Children should not be passed via props (see eslint check "react/no-children-props")');if(Array.isArray(n))a=n.filter(Boolean);else if(typeof n=="string")a=o("WABinary").Binary.build(n).readByteArrayView();else if(n instanceof ArrayBuffer)a=new Uint8Array(n);else if(n instanceof Uint8Array)a=n;else{for(var i=[],l=2;l<arguments.length;l++){var s=arguments[l];s&&i.push(s)}a=i}Array.isArray(a)&&a.length===0&&(a=null);var u={};if(t){var c=t;Object.keys(c).forEach(function(t){if(!["__self","__source"].includes(t)){var n=c[t];if(n==null)throw r("err")("Attr "+t+" in <"+e+"> is null");n!==O&&(u[t]=n)}})}return new X(e,u,a)}var J=Y;function Z(e){return e instanceof o("WAWapJid").WapJid?e.toString():e}function ee(e){var t=e.content;return Array.isArray(t)?t=t.map(ee):typeof t=="string"&&(t=o("WABinary").Binary.build(t).readByteArrayView()),new X(e.tag,e.attrs||z,t)}function te(e){var t=e instanceof X?e:ee(e),n=new(o("WABinary")).Binary;ne(t,n);var r=0,a=n.readByteArrayView(),i=new Uint8Array(1+a.length);return i[0]=r,i.set(a,1),i}function ne(e,t){if(e==null)t.writeUint8(h);else if(e instanceof X)oe(e,t);else if(e instanceof o("WAWapJid").WapJid)re(e,t);else if(typeof e=="string")se(e,t);else if(e instanceof Uint8Array)ce(e,t);else{var n=typeof e;throw r("err")("Invalid payload type "+n)}}function re(e,t){var n=e.getInnerJid();if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_U){var r=n.device,a=n.domainType,i=n.user;t.writeUint8(E),t.writeUint8(a),t.writeUint8(r),ne(i,t)}else if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_FB){var l=n.device,s=n.user;t.writeUint8(L),ne(s,t),t.writeUint16(l),ne(c,t)}else if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_INTEROP){var u=n.device,d=n.integrator,m=n.user;t.writeUint8(R),ne(m,t),t.writeUint16(u),t.writeUint16(d)}else{var p=n.server,_=n.user;t.writeUint8(T),_!=null?ne(_,t):t.writeUint8(h),ne(p,t)}}function oe(e,t){if(e.tag===void 0){t.writeUint8(k),t.writeUint8(h);return}var n=1;e.attrs&&(n+=Object.keys(e.attrs).length*2),e.content&&n++,n<256?(t.writeUint8(k),t.writeUint8(n)):n<65536&&(t.writeUint8(I),t.writeUint16(n)),ne(e.tag,t),e.attrs&&Object.keys(e.attrs).forEach(function(n){se(n,t),ne(e.attrs[n],t)});var r=e.content;if(Array.isArray(r)){r.length<256?(t.writeUint8(k),t.writeUint8(r.length)):r.length<65536&&(t.writeUint8(I),t.writeUint16(r.length));for(var o=0;o<r.length;o++)oe(r[o],t)}else r&&ne(r,t)}var ae,ie;function le(e){for(var t=new Map,n=0;n<e.length;n++)t.set(e[n],n);return t}function se(e,t){if(e===""){t.writeUint8(x),t.writeUint8(0);return}ae==null&&(ae=le(o("WAWapDict").SINGLE_BYTE_TOKEN));var n=ae.get(e);if(n!=null){t.writeUint8(n+1);return}if(ie==null){ie=[];for(var r=0;r<o("WAWapDict").DICTIONARIES.length;++r)ie.push(le(o("WAWapDict").DICTIONARIES[r]))}for(var a=0;a<ie.length;++a){var i=ie[a].get(e);if(i!=null){t.writeUint8(S[a]),t.writeUint8(i);return}}var l=o("WABinary").numUtf8Bytes(e);if(l<128){var s=/[^0-9.-]+?/,u=/[^0-9A-F]+?/;if(s.exec(e)){if(!u.exec(e)){ue(e,D,t);return}}else{ue(e,N,t);return}}de(l,t),t.writeString(e)}function ue(e,t,n){var o=e.length%2===1;n.writeUint8(t);var a=Math.ceil(e.length/2);o&&(a|=g),n.writeUint8(a);for(var i=0,l=0;l<e.length;l++){var s=e.charCodeAt(l),u=null;if(48<=s&&s<=57?u=s-48:t===N?s===45?u=10:s===46&&(u=11):t===D&&65<=s&&s<=70&&(u=s-55),u==null)throw r("err")("Cannot nibble encode "+s);l%2===0?(i=u<<4,l===e.length-1&&(i|=15,n.writeUint8(i))):(i|=u,n.writeUint8(i))}}function ce(e,t){de(e.length,t),t.writeByteArray(e)}function de(e,t){if(e<256)t.writeUint8(x),t.writeUint8(e);else if(e<1048576)t.writeUint8($),t.writeUint8(e>>>16&255),t.writeUint8(e>>>8&255),t.writeUint8(e&255);else if(e<4294967296)t.writeUint8(P),t.writeUint32(e);else throw r("err")("Binary with length "+e+" is too big for WAP protocol")}function me(t,n){var r=new(o("WABinary")).Binary(t),a=r.readUint8(),i=a&f;return i?(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Decoding compressed stanza"]))),n(r.readByteArrayView()).then(function(e){return ge(new(o("WABinary")).Binary(e))})):Promise.resolve(ge(r))}function pe(e){var t=new(o("WABinary")).Binary(e),n=t.readUint8(),a=n&f;if(a)throw r("err")("Cannot pass compressed stanza to decodeStanzaDebug");return ge(t)}function _e(e,t){var n=e.readUint8();if(n===h)return null;if(n===k)return fe(e,e.readUint8());if(n===I)return fe(e,e.readUint16());if(n===x){var a=e.readUint8();return Re(e,a,t)}if(n===$){var i=e.readUint8(),l=e.readUint8(),s=e.readUint8(),u=((i&15)<<16)+(l<<8)+s;return Re(e,u,t)}if(n===P){var c=e.readUint32();return Re(e,c,t)}if(n===T)return Ce(e);if(n===L)return be(e);if(n===R)return ve(e);if(n===E)return Se(e);if(n===N){var d=e.readUint8(),m=d>>>7,p=d&127;return Le(e,M,m,p)}if(n===D){var _=e.readUint8(),f=_>>>7,g=_&127;return Le(e,w,f,g)}if(n<=0||n>=240)throw r("err")("Unable to decode WAP buffer");if(n>=y&&n<=v){var C=n-y,b=o("WAWapDict").DICTIONARIES[C];if(b===void 0)throw r("err")("Missing WAP dictionary "+C);var S=e.readUint8(),A=b[S];if(A===void 0)throw r("err")("Invalid value index "+S+" in dict "+C);return A}var F=o("WAWapDict").SINGLE_BYTE_TOKEN[n-1];if(F===void 0)throw r("err")("Undefined token with index "+n);return F}function fe(e,t){for(var n=[],r=0;r<t;r++)n.push(ge(e));return n}function ge(e){var t=e.readUint8(),n;if(t===k)n=e.readUint8();else if(t===I)n=e.readUint16();else throw r("err")("Failed to decode node since type byte "+String(t)+" is invalid");var a=void 0,i=null;if(n===0)throw r("err")("Failed to decode node, list cannot be empty");var l=he(e);for(n-=1;n>1;){a||(a={});var s=he(e),u=_e(e,!0);a[s]=u,n-=2}return n===1&&(i=_e(e,!1),i instanceof o("WAWapJid").WapJid&&(i=String(i)),typeof i=="string"&&(i=Q.encode(i))),new X(l,a,i)}function he(e){var t=_e(e,!0);if(typeof t!="string")throw r("err")("WAWap:decodeString got invalid value, string expected");return t}function ye(e){var t=_e(e,!0);if(t!=null&&typeof t!="string")throw r("err")("WAWap:decodeNullableString got invalid value, string expected");return t}function Ce(e){var t=ye(e),n=he(e);return o("WAWapJid").WapJid.create(t,n)}function be(e){var t=he(e),n=e.readUint16();return he(e),o("WAWapJid").WapJid.createFbJid(t,n)}function ve(e){var t=he(e),n=e.readUint16(),r=e.readUint16();return he(e),o("WAWapJid").WapJid.createInteropJid(t,n,r)}function Se(e){var t=null,n=e.readUint8();if(n===0)t=o("WAWapJid").DomainType.WHATSAPP;else if(n===1)t=o("WAWapJid").DomainType.LID;else if((1&n)===0&&(128&n)!==0)t=o("WAWapJid").DomainType.HOSTED;else if(n===129)t=o("WAWapJid").DomainType.HOSTED_LID;else throw r("err")("decodeJidU - Invalid domain type encoding "+n);var a=e.readUint8(),i=he(e);return o("WAWapJid").WapJid.createJidU(i,t,a)}function Re(e,t,n){return n===void 0&&(n=!1),n?e.readString(t):e.readByteArrayView(t)}function Le(e,t,n,r){for(var o=new Array(r*2-n),a=0;a<o.length-1;a+=2){var i=e.readUint8();o[a]=t[i>>>4],o[a+1]=t[i&15]}if(n){var l=e.readUint8();o[o.length-1]=t[l>>>4]}return o.join("")}function Ee(){if(!A){var e=new Uint16Array(2);o("WACryptoDependencies").getCrypto().getRandomValues(e),A=String(e[0])+"."+String(e[1])+"-"}return""+A+F++}function ke(e){switch(e.type){case"group":return e.groupJid;case"status":return o("WAJids").STATUS_JID;case"device":return e.deviceJid;case"newsletter":return e.newsletterJid;case"hosted":return e.hostedDeviceJid;case"hostedLid":return e.hostedLidDeviceJid;default:return e.type,e.broadcastJid}}function Ie(e){switch(e.type){case"group":return e.author;case"status":return e.author;case"broadcast":return e.author;default:return e.type,null}}function Te(e){return e.type==="status"||e.type==="group"||e.type==="broadcast"?xe(e.author):O}function De(e){return xe(ke(e))}function xe(e){var t=o("WAJids").validateDomainJid(e);if(t!=null)return $e(t);var n=e.split("@"),a=n[0],i=n[1],l=null,s=null;if((i===d||i===c||i===p||i===m||i===_||i===o("WAJids").HOSTED_LID_SUFFIX)&&a.indexOf(":")!==-1){var u=a.split(":");a=u[0],l=u[1],s=parseInt(l,10)}if(i===p){var f=a.split("-"),g=f[0],h=f[1];return o("WAWapJid").WapJid.createInteropJid(h,s,parseInt(g,10))}else if(i===c)return o("WAWapJid").WapJid.createFbJid(a,s);var y=null;if(i===m)y=o("WAWapJid").DomainType.LID;else if(i===_){if(s!==99)throw r("err")("wid unexpected deviceId");y=o("WAWapJid").DomainType.HOSTED}else if(i===o("WAJids").HOSTED_LID_SUFFIX){if(s!==99)throw r("err")("lid invalid deviceId");y=o("WAWapJid").DomainType.HOSTED_LID}else y=o("WAWapJid").DomainType.WHATSAPP;return s!=null&&s!==0?o("WAWapJid").WapJid.createJidU(a,y,s):o("WAWapJid").WapJid.create(a,i)}function $e(e){return e==="s.whatsapp.net"?W:e==="g.us"?B:e==="newsletter"?U:e==="call"?G:r("WAAssertUnreachable")(e)}function Pe(e){return xe(e)}function Ne(e){return xe(e)}function Me(e){return xe(e)}function we(e){return xe(e)}function Ae(e){return xe(e)}function Fe(e){return xe(e)}function Oe(e){return e.jidType==="phoneDevice"||e.jidType==="msgrDevice"||e.jidType==="lidDevice"?xe(e.deviceJid):e.jidType==="phoneUser"||e.jidType==="msgrUser"||e.jidType==="lidUser"?xe(e.userJid):e.jidType==="group"?xe(e.groupJid):e.jidType==="status"?xe(e.statusJid):e.jidType==="call"?xe(e.callJid):e.jidType==="interopDevice"?xe(e.deviceJid):e.jidType==="interopUser"?xe(e.userJid):e.jidType==="newsletter"?xe(e.newsletterJid):e.jidType==="hosted"?xe(e.hostedDeviceJid):e.jidType==="hostedLid"?xe(e.hostedLidDeviceJid):e.jidType==="bot"?xe(e.botJid):(e.jidType,xe(e.broadcastJid))}function Be(e){return e}function We(e){return e.toString()}function qe(e){return e}function Ue(e){return e}function Ve(e){return e==null?O:e}function He(e){return e.toString()}function Ge(e){return o("WALongInt").longIntToDecimalString(e)}function ze(e,t){t===void 0&&(t=4);for(var n=e,r=new Uint8Array(t),o=t-1;o>=0;o--)r[o]=n&255,n>>>=8;return r}l.DROP_ATTR=O,l.G_US=B,l.S_WHATSAPP_NET=W,l.STATUS_BROADCAST=q,l.NEWSLETTER=U,l.HOSTED=V,l.HOSTED_LID=H,l.CALL=G,l.enableXMLFormat=K,l.WapNode=X,l.makeWapNode=Y,l.wap=J,l.decodeAsString=Z,l.makeStanza=ee,l.encodeStanza=te,l.decodeStanza=me,l.decodeStanzaDebug=pe,l.generateId=Ee,l.extractToJid=ke,l.extractParticipantJid=Ie,l.PARTICIPANT_JID=Te,l.TO_JID=De,l.JID=xe,l.DOMAIN_JID=$e,l.USER_JID=Pe,l.DEVICE_JID=Ne,l.GROUP_JID=Me,l.BROADCAST_JID=we,l.CALL_JID=Ae,l.NEWSLETTER_JID=Fe,l.TO_WAP_JID=Oe,l.STANZA_ID=Be,l.SMAX_ID=We,l.CUSTOM_STRING=qe,l.CALL_ID=Ue,l.MAYBE_CUSTOM_STRING=Ve,l.INT=He,l.LONG_INT=Ge,l.BIG_ENDIAN_CONTENT=ze}),98);
__d("WASmaxJsx",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";l.smax=o("WAWap").wap}),98);
__d("WASmaxMixins",["WAArrayBufferUtils","WAWapJid"],(function(t,n,r,o,a,i,l){"use strict";var e="smax$any";function s(e,t){return c(e,t),d(e,t),t.content instanceof Uint8Array?p(e,t.content):t.content!=null&&_(e,t.content),e}function u(e,t,n,r){return n!=null?e(t,n,r):t}function c(t,n){var r=t.tag,o=n.tag;if(o!==e&&r!==o)throw new Error("tag mismatch: "+r+" != "+o)}function d(e,t){var n=e.attrs,r=t.attrs;Object.keys(r).forEach(function(e){var t=r[e],o=n[e];if(t!=null&&o!=null){if(m(t,o))return;throw new Error("conflict for key: "+e)}n[e]=t})}function m(e,t){return typeof e=="string"&&typeof t=="string"?e===t:e instanceof o("WAWapJid").WapJid&&t instanceof o("WAWapJid").WapJid?e.toString()===t.toString():!1}function p(e,t){var n=e.content;if(n instanceof Uint8Array){if(!o("WAArrayBufferUtils").uint8ArraysEqualUNSAFE(n,t))throw new Error("elementValue mismatch: bytes dose not equal");return}if(n!=null)throw new Error("elementValue mismatch: destination has children");e.content=t}function _(e,t){var n=e.content;if(n instanceof Uint8Array)throw new Error("children mismatch: destination has element value");if(n==null||n.length===0){e.content=t;return}if(!f(n,t))throw new Error("children mismatch: child counts are not compatible");var r=[],o=Array.from(n);t.forEach(function(e){var t=o.findIndex(function(t){return t.tag===e.tag});if(t===-1)r.push(e);else{var n=o.splice(t,1),a=s(n[0],e);r.push(a)}}),o.forEach(function(e){return r.push(e)}),e.content=r}function f(e,t){for(var n=g(t),r=g(e),o=Object.keys(n),a=0;a<o.length;a++){var i=o[a],l=n[i],s=r[i];if(l!=null&&s!=null&&l!==s)return!1}return!0}function g(e){return e.reduce(function(e,t){var n=t.tag,r=e[n];return e[n]=r==null?1:r+1,e},{})}l.mergeStanzas=s,l.optionalMerge=u}),98);
__d("WASmaxOutPingsClientWellFormedToMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("iq",{to:o("WAWap").S_WHATSAPP_NET});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeClientWellFormedToMixin=s}),98);
__d("WASmaxOutPingsClientRequest",["WASmaxJsx","WASmaxOutPingsClientWellFormedToMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutPingsClientWellFormedToMixin").mergeClientWellFormedToMixin(o("WASmaxJsx").smax("iq",{id:o("WAWap").generateId(),type:"get",xmlns:"w:p"}));return e}l.makeClientRequest=e}),98);
__d("WAComms",["WAArrayUtils","WABaseGlobals","WAErrors","WALogger","WANotifyConnectionChangeFactory","WAPromiseRetryLoop","WAResolvable","WAShiftTimer","WASmaxInPingsClientResponseServerResponse","WASmaxOutPingsClientRequest","WASmaxParseUtils","WATimeUtils","WAWap","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O,B,W=null,q=null,U=1,V=0,H=(function(){function t(t,n,r){var a=this,i,l,c;this.nextSocketId=1,this.pendingIqs=new Map,this.ackHandlers=[],this.pendingSmaxStanzas=new Map,this.$2=new(o("WAResolvable")).Resolvable,this.socketAbortController=null,this.activePing=null,this.$3=new Set,this.socketId=V,this.socket=null,this.softCloseSocket=null,this.handleStanza=function(t,n,r){var i=o("WASmaxParseUtils").attrString(t,"id");if(i.success&&t.tag!=="receipt"){var l=i.value,u=a.pendingSmaxStanzas.get(l);if(u)return a.pendingSmaxStanzas.delete(l),u.resolve(t),a.maybeScheduleHealthCheck(),"NO_ACK"}var c=_e(t);if(c!=null){var d=a.pendingIqs.get(c);d?(a.pendingIqs.delete(c),d.resolve(t),a.maybeScheduleHealthCheck()):(o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["handleIq no handler for iq with id ",""])),c),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleIq no handler for iq"]))))}else if(t.tag==="ack")a.handleAck(t);else return t.tag==="failure"&&a.config.shouldBlockReceivingUntilSuccess?a.$1(t,n,r):a.$2.promise.then(function(){return a.$1(t,n,r)});return"NO_ACK"},this.healthCheckTimer=new(o("WAShiftTimer")).ShiftTimer(function(){a.socketId&&a.sendPing()}),this.deadSocketTimer=new(o("WAShiftTimer")).ShiftTimer(function(e){e===a.socketId&&(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," expired"])),e),a.softCloseSocket&&a.softCloseSocket())}),this.$1=t,this.onConnectionChange=o("WANotifyConnectionChangeFactory").notifyConnectionChangeFactory((i=n.handlers.onConnectionChange)!=null?i:function(){},(l=n.handlers.onOptimisticConnectionChange)!=null?l:function(){}),this.gzipInflate=r,this.config=n,this.socketLoop=new(o("WAPromiseRetryLoop")).PromiseRetryLoop({name:"MainSocketLoop",code:ne,timer:(c=n.socketReconnectBackoffAlgo)!=null?c:{jitter:.1,max:n.maxSocketLoopWaitTime,algo:{type:"fibonacci",first:1e4,second:1e4},relativeDelay:!0},resetDelay:3e4,isPauseEnabled:n.isPauseEnabled===!0})}var n=t.prototype;return n.filterPending=function(t){var e=[];function n(n){t(n)&&e.push(n)}return this.pendingIqs.forEach(n),this.ackHandlers.forEach(n),this.pendingSmaxStanzas.forEach(n),e},n.sendPendingStanza=function(t){t.cleanup==null||t.cleanup(),t.cleanup=void 0,this.callStanza(t.stanza)},n.maybeSendPendingStanza=function(t){if(t.attempt>=this.config.maxRetries){var e,n;(e=(n=this.config.handlers).onDropStanza)==null||e.call(n,t),t.cleanup==null||t.cleanup(),t.cleanup=void 0,this.removeHandler(t,"max-retries")}else if(this.socket){t.attempt+=1,this.sendPendingStanza(t);return}else o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will resend stanza when socket opens"])))},n.callStanzaAsync=async function(t,n){var e=await this.callStanza(t,n);return e},n.callStanza=function(t,n){var e=this.castStanza(t,n);return this.deadSocketTimer.onOrBefore(this.config.deadSocketTime,this.socketId),this.healthCheckTimer.cancel(),e},n.castStanzaAsync=async function(t){var e=await this.castStanza(t);return e},n.castStanza=function(t,n){var e=this;try{var r,a,i=(r=(a=this.config.handlers).onBeforeCastStanzaForE2E)==null?void 0:r.call(a,t,n);if(i!=null)return o("WALogger").DEV_XMPP(d||(d=babelHelpers.taggedTemplateLiteralLoose([`Dropping stanza since onBeforeCastStanza matched:
`,". We return mock response directly."],["Dropping stanza since onBeforeCastStanza matched:\\n",". We return mock response directly."])),t),o("WALogger").DEV_XMPP(m||(m=babelHelpers.taggedTemplateLiteralLoose([`--- Receive (via SMAX+E2E) ---
`,""],["--- Receive (via SMAX+E2E) ---\\n",""])),i),o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Dropping stanza since onBeforeCastStanza matched. We return mock response directly."]))),Array.isArray(i)?Promise.all(i.map(function(t){return Promise.resolve(e.handleStanza(t,e.socketId,V))})):(this.handleStanza(i,this.socketId,V),Promise.resolve())}catch(e){o("WALogger").DEV_XMPP(_||(_=babelHelpers.taggedTemplateLiteralLoose([`Error in onBeforeCastStanza, we consumed and continue with normal stanza sending to the server:
`,""],["Error in onBeforeCastStanza, we consumed and continue with normal stanza sending to the server:\\n",""])),e)}var l=this.socketOrThrow("castStanza");try{return o("WALogger").DEV_XMPP(f||(f=babelHelpers.taggedTemplateLiteralLoose([`--- Sending ---
`,""],["--- Sending ---\\n",""])),t),l.sendFrame(o("WAWap").encodeStanza(t)).then(function(){e.config.handlers.onCastStanza==null||e.config.handlers.onCastStanza(t,n)}).catch(function(e){if(o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["castStanza async error ",""])),e),e instanceof o("WAErrors").BufferTooLargeError)return Promise.reject(e)})}catch(e){o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["castStanza error ",""])),e)}return Promise.resolve()},n.socketOrThrow=function(t){var e=this.socket;if(e)return e;throw r("err")("Comms."+t+" called while no socket")},n.startHandlingRequests=function(){return o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Comms.startHandlingRequests"]))),this.$2.resolve(),this.$2.promise.then(function(){})},n.parseAndHandleStanza=function(t,n){var e=this;t===this.socketId&&(this.deadSocketTimer.cancel(),q&&(q.resolve(),q=null));var r=o("WAWap").decodeStanza(n,this.gzipInflate).catch(function(e){throw o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Failure parsing stanza!"]))),e}).then(function(r){o("WALogger").DEV_XMPP(b||(b=babelHelpers.taggedTemplateLiteralLoose([`--- Receiving ---
`,""],["--- Receiving ---\\n",""])),r),e.config.handlers.onHandleStanza==null||e.config.handlers.onHandleStanza(r,t,n.byteLength);var a=e.activePing;return a&&a.socketId===t&&a.stanzaId===_e(r)?(e.activePing=null,a.handler.resolve(r),e.maybeScheduleHealthCheck(),"NO_ACK"):e.handleStanza(r,t,n.byteLength)}).then(function(n){if(t===e.socketId){if(n==="CLOSE_SOCKET"){o("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[comms] job response is CLOSE_SOCKET"])));var r=e.socket;r&&r.close()}else n==="NO_ACK"||e.castStanza(n);return"NO_ACK"}});this.$3.add(r),r.finally(function(){return void e.$3.delete(r)})},n.handleAck=function(t){for(var e=this.ackHandlers,n=-1,r=null;!r&&++n<e.length;)r=e[n].parseAndTest(t);if(r){var a,i,l=e[n];o("WAArrayUtils").removeIndexWithoutPreservingOrder(e,n),(a=(i=this.config.handlers).onHandleAck)==null||a.call(i,t),l.resolve(r),this.maybeScheduleHealthCheck()}else o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["handleAck: unrecognized ",""])),t)},n.removeHandler=function(t,n){if(n===void 0&&(n="disconnect"),t.type==="iq"||t.type==="smax"){var e=t.stanza.attrs.id;if(!e||typeof e!="string"||t.type==="iq"&&!this.pendingIqs.delete(e)||t.type==="smax"&&!this.pendingSmaxStanzas.delete(e))return}else{t.type;var r=this.ackHandlers.indexOf(t);if(r===-1)return;o("WAArrayUtils").removeIndexWithoutPreservingOrder(this.ackHandlers,r)}n==="disconnect"?t.resolve(Promise.reject(new(o("WAErrors")).Disconnected)):n==="abort"?t.resolve(Promise.reject(new(o("WAErrors")).Aborted)):t.resolve(Promise.reject(new(o("WAErrors")).MaxRetries))},n.maybeScheduleHealthCheck=function(){if(!this.healthCheckTimer.isScheduled()&&!(this.activePing||this.ackHandlers.length||this.pendingIqs.size||this.pendingSmaxStanzas.size)){var e=this.config.healthCheckInterval,t=Math.ceil(e*1e3*(1+Math.random()));this.healthCheckTimer.onOrBefore(t)}},n.sendPing=async function(){var e=pe("sendPing");if(!e.socketId)return o("WALogger").LOG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[comms] sendPing when socket dead"]))),!1;if(e.activePing&&e.activePing.socketId===e.socketId)return o("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[comms] sendPing ping still pending"]))),!1;e.activePing&&e.activePing.handler.resolve();var t=o("WASmaxOutPingsClientRequest").makeClientRequest(),n=t.attrs.id;if(typeof n!="string")return o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[comms] No stanzaId in ping request stanza"]))),!1;var r=new(o("WAResolvable")).Resolvable;e.activePing={socketId:e.socketId,stanzaId:n,handler:r};var a=Date.now();e.callStanza(t);var i=await r.promise,l=Date.now();if(i){var s=o("WASmaxInPingsClientResponseServerResponse").parseClientResponseServerResponse(i,t);if(s.success){var u=l-a,c=Math.round(u/2),d=o("WATimeUtils").castToUnixTime(s.value.t),m=o("WABaseGlobals").newClockSkewCalculation()?Math.round((a+c)/1e3-d):Math.round(Date.now()/1e3-d);return e.config.handlers.onClockSkewUpdate==null||e.config.handlers.onClockSkewUpdate(m),!0}}return!1},t})();function G(){return W}function z(e,t,n,r){r===void 0&&(r=!0),!W&&(W=new H(e,t,n),r&&setTimeout(Y,0))}function j(){var e=pe("stopComms");e.socketLoop.endWithValue(),e.socket&&re(),W=null}function K(){var e=pe("closeSocketAndPreventRetry");e.socketLoop.endWithValue(),e.socket&&(o("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndPreventRetry called"]))),re())}function Q(){var e=pe("closeSocketAndPause");e.socketLoop.pauseOnNextIteration(),e.socket&&(o("WALogger").LOG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndPause called"]))),re())}function X(){var e=pe("closeSocketAndResume");e.socketLoop.unpause(),e.socket&&(o("WALogger").LOG(T||(T=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndResume called"]))),re())}function Y(){pe("openSocketLoop").socketLoop.start()}function J(){o("WALogger").LOG(D||(D=babelHelpers.taggedTemplateLiteralLoose(["[comms] maybeResetSocketLoop"]))),te()||pe("maybeResetSocketLoop").socketLoop.reset()}function Z(){pe("forceResetSocketLoop").socketLoop.reset()}function ee(){var e,t=pe("socketAbortController");(e=t.socketAbortController)==null||e.abort(),t.softCloseSocket==null||t.softCloseSocket()}function te(){var e;return!!((e=W)!=null&&e.socket)}function ne(){var e,t=pe("socketLoopIteration"),n=t.nextSocketId++;o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," opening"])),n);var r=function(){t.onConnectionChange("in_handshake")};return t.config.handlers.onSocketLoopIteration==null||t.config.handlers.onSocketLoopIteration(t.socketAbortController),typeof AbortController=="function"&&(t.socketAbortController=new AbortController),t.config.openChatSocket(r,(e=t.socketAbortController)==null?void 0:e.signal).then(function(e){if(e.success){var r=e.value;t.config.handlers.onSocketOpen==null||t.config.handlers.onSocketOpen();var a=new(o("WAResolvable")).Resolvable;return o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," opened"])),n),t.socketId=n,t.socket=r,t.softCloseSocket=function(){t.softCloseSocket=null,t.socket&&t.config.shouldCloseStaleSocket&&(re(),t.socket=null),a.resolve()},t.socketLoop.resetTimeoutAfter(1e4),t.deadSocketTimer.cancel(),t.maybeScheduleHealthCheck(),r.setOnFrame(function(e){return t.parseAndHandleStanza(n,e)}),r.setOnClose(function(){o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," closed"])),n),t.activePing&&n===t.activePing.socketId&&(t.activePing.handler.resolve(),t.activePing=null),t.filterPending(function(e){return e.attachedToSocketId===n}).forEach(function(e){return void t.removeHandler(e)}),n===t.socketId&&(t.socketId=V,t.socket=null,t.onConnectionChange("disconnected"),t.config.handlers.onDisconnect==null||t.config.handlers.onDisconnect(),a.resolve())}),t.onConnectionChange("connected"),t.config.handlers.onConnect==null||t.config.handlers.onConnect(),t.filterPending(function(e){return!e.attachedToSocketId}).sort(function(e,t){return e.orderedId-t.orderedId}).forEach(function(e){switch(e.type){case"smax":case"iq":t.maybeSendPendingStanza(e);break;case"ack":t.callStanza(e.stanza);break;default:e.type;break}}),a.promise}else{var i=e.error;switch(i){case"max-hunters":o("WALogger").WARN(N||(N=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket closed while in noise handshake using treasureHunt strategy"])));break;case"disconnected":o("WALogger").WARN(M||(M=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket disconnected while in noise handshake"])));break;default:return}}}).catch(function(e){e instanceof o("WAErrors").Disconnected?o("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket closed while in noise handshake"]))):o("WALogger").ERROR(A||(A=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration failed ",""])),e)})}function re(){var e=pe("closeSocket");e.socket&&(o("WALogger").LOG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," closed"])),e.socketId),o("WALogger").LOG(O||(O=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocket called"]))),e.socket.close())}function oe(){pe("onStreamErrorReceived").socketLoop.cancelReset()}function ae(){return pe("waitForConnection").sendPing(),q||(q=new(o("WAResolvable")).Resolvable),q.promise}function ie(e,t){var n=pe("castStanza");n.socket?n.castStanza(e,t):o("WALogger").LOG(B||(B=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket"])))}function le(e){var t=pe("castStanza");return t.socketId===e}function se(e,t,n,a,i){return n===void 0&&(n=0),i===void 0&&(i="iq"),new Promise(function(l){var s=pe("sendIq"),u=e.attrs.id;if(!u||typeof u!="string")throw r("err")("[comms] sendIq given iq without id: "+String(e));var c=s.socketId;if(t&&!c){l(Promise.reject(new(o("WAErrors")).Offline));return}var d=function(t){t===void 0&&(t="disconnect");var e=i==="iq"?s.pendingIqs.get(u):s.pendingSmaxStanzas.get(u);if(!e){l(Promise.reject(r("err")("[comms] _sendIq unexisting stanza to be cancelled: "+u)));return}s.removeHandler(e,t)},m=null;if(n>0){var p=setTimeout(d,n*1e3);m=function(){clearTimeout(p)}}if(a!=null)if(a.aborted){l(Promise.reject(new(o("WAErrors")).Disconnected));return}else{var _=function(){d("abort")};a.addEventListener("abort",_),m=function(){a.removeEventListener("abort",_)}}var f={resolve:l,stanza:e,attachedToSocketId:t?c:V,orderedId:U++,attempt:0,cleanup:m};if(i==="iq"){var g=babelHelpers.extends({type:i},f);s.pendingIqs.set(u,g),s.config.handlers.onSendIq==null||s.config.handlers.onSendIq(e),s.maybeSendPendingStanza(g)}else{var h=babelHelpers.extends({type:i},f);s.pendingSmaxStanzas.set(u,h),s.maybeSendPendingStanza(h)}})}function ue(e,t){var n,r,o,a=(n=t==null?void 0:t.withoutRetry)!=null?n:!1,i=(r=t==null?void 0:t.timeoutSeconds)!=null?r:0,l=(o=t==null?void 0:t.signal)!=null?o:null;return se(e,a,i,l,"smax")}function ce(){var e=pe("sendPing");return e.sendPing()}function de(){return pe("startHandlingRequests").startHandlingRequests()}function me(){W&&W.deadSocketTimer.cancel()}function pe(e){if(W)return W;throw r("err")("[comms] "+e+" called before startComms")}function _e(e){if(e.tag==="iq"){var t=e.attrs.type;if(t==="result"||t==="error")return o("WAWap").decodeAsString(e.attrs.id)||null}return null}function fe(){return U++}function ge(){W=null,q=new(o("WAResolvable")).Resolvable,U=1}l.DEFAULT_SOCKET_ID=V,l.getComms=G,l.startComms=z,l.stopComms=j,l.closeSocketAndPreventRetry=K,l.closeSocketAndPause=Q,l.closeSocketAndResume=X,l.openSocketLoop=Y,l.maybeResetSocketLoop=J,l.forceResetSocketLoop=Z,l.forceAbortSocketConnection=ee,l.isSocketConnected=te,l.socketLoopIteration=ne,l.closeSocket=re,l.onStreamErrorReceived=oe,l.waitForConnection=ae,l.castSmaxStanza=ie,l.isActiveSocket=le,l._sendIq=se,l.sendSmaxStanza=ue,l.sendPing=ce,l.startHandlingRequests=de,l.cancelDeadSocketTimer=me,l.singletonOrThrowIfUninitialized=pe,l.getAndIncrementNextOrderedId=fe,l.resetStateForTests=ge}),98);
__d("WADecimalStringMod",["WALogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){if(!/^\d+$/.test(t))throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(['"','" is not a valid decimal string'])),t),r("err")("decimalStringMod is given an invalid decimal string");var a=t.length;if(a<16||a===16&&t<="9007199254740991")return Number(t)%n;if(a>20||a===20&&t>"18446744073709551615")throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(['"','" is over 64 bits'])),t),r("err")("decimalStringMod is given value over 64 bits");for(var i=0,l=0;l<t.length;l++){var u=Number(t[l]);i=(i*10+u)%n}return i}l.decimalStringMod=u}),98);
__d("WACreateGetVcaEnabledBucket",["WAArrayBufferUtils","WADecimalStringMod","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return function(){return t==null?null:o("WAArrayBufferUtils").arrayBufferMod(e,t)+100}}function u(t,n){return function(){if(n==null)return null;var r=t.split("/"),a=r[r.length-1],i=a.split("_")[1];return/^\d+$/.test(i)?i==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["mediaRouteSelection: can't get fbId from mediaDirectPath"]))),null):o("WADecimalStringMod").decimalStringMod(i,n)+100:null}}l.createGetVcaEnabledBucket=s,l.msgrCreateGetVcaEnabledBucket=u}),98);
__d("WAExtractNcHotTimestamp",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e==null)return null;var t=s(e);if(t.has("_nc_hot")){var n=parseInt(t.get("_nc_hot"),10);return Number.isInteger(n)?o("WATimeUtils").castToUnixTime(n):null}else return null}function s(e){var t=e.split("?");return new URLSearchParams(t.length===2?t[1]:"")}l.extractNcHotTimestamp=e}),98);
__d("WASignalLocalStorageProtocol.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={},b={},v={},S={};s.name="SessionStructure",s.internalSpec={sessionVersion:[1,(e=o("WAProtoConst")).TYPES.UINT32],localIdentityPublic:[2,e.TYPES.BYTES],remoteIdentityPublic:[3,e.TYPES.BYTES],rootKey:[4,e.TYPES.BYTES],previousCounter:[5,e.TYPES.UINT32],senderChain:[6,e.TYPES.MESSAGE,d],receiverChains:[7,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d],pendingKeyExchange:[8,e.TYPES.MESSAGE,c],pendingPreKey:[9,e.TYPES.MESSAGE,u],remoteRegistrationId:[10,e.TYPES.UINT32],localRegistrationId:[11,e.TYPES.UINT32],needsRefresh:[12,e.TYPES.BOOL],aliceBaseKey:[13,e.TYPES.BYTES]},u.name="SessionStructure$PendingPreKey",u.internalSpec={preKeyId:[1,e.TYPES.UINT32],signedPreKeyId:[3,e.TYPES.INT32],baseKey:[2,e.TYPES.BYTES]},c.name="SessionStructure$PendingKeyExchange",c.internalSpec={sequence:[1,e.TYPES.UINT32],localBaseKey:[2,e.TYPES.BYTES],localBaseKeyPrivate:[3,e.TYPES.BYTES],localRatchetKey:[4,e.TYPES.BYTES],localRatchetKeyPrivate:[5,e.TYPES.BYTES],localIdentityKey:[7,e.TYPES.BYTES],localIdentityKeyPrivate:[8,e.TYPES.BYTES]},d.name="SessionStructure$Chain",d.internalSpec={senderRatchetKey:[1,e.TYPES.BYTES],senderRatchetKeyPrivate:[2,e.TYPES.BYTES],chainKey:[3,e.TYPES.MESSAGE,p],messageKeys:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,m]},m.name="SessionStructure$Chain$MessageKey",m.internalSpec={index:[1,e.TYPES.UINT32],cipherKey:[2,e.TYPES.BYTES],macKey:[3,e.TYPES.BYTES],iv:[4,e.TYPES.BYTES]},p.name="SessionStructure$Chain$ChainKey",p.internalSpec={index:[1,e.TYPES.UINT32],key:[2,e.TYPES.BYTES]},_.name="RecordStructure",_.internalSpec={currentSession:[1,e.TYPES.MESSAGE,s],previousSessions:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,s]},f.name="PreKeyRecordStructure",f.internalSpec={id:[1,e.TYPES.UINT32],publicKey:[2,e.TYPES.BYTES],privateKey:[3,e.TYPES.BYTES]},g.name="SignedPreKeyRecordStructure",g.internalSpec={id:[1,e.TYPES.UINT32],publicKey:[2,e.TYPES.BYTES],privateKey:[3,e.TYPES.BYTES],signature:[4,e.TYPES.BYTES],timestamp:[5,e.TYPES.FIXED64]},h.name="IdentityKeyPairStructure",h.internalSpec={publicKey:[1,e.TYPES.BYTES],privateKey:[2,e.TYPES.BYTES]},y.name="SenderKeyStateStructure",y.internalSpec={senderKeyId:[1,e.TYPES.UINT32],senderChainKey:[2,e.TYPES.MESSAGE,v],senderSigningKey:[3,e.TYPES.MESSAGE,C],senderMessageKeys:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,b]},C.name="SenderKeyStateStructure$SenderSigningKey",C.internalSpec={public:[1,e.TYPES.BYTES],private:[2,e.TYPES.BYTES]},b.name="SenderKeyStateStructure$SenderMessageKey",b.internalSpec={iteration:[1,e.TYPES.UINT32],seed:[2,e.TYPES.BYTES]},v.name="SenderKeyStateStructure$SenderChainKey",v.internalSpec={iteration:[1,e.TYPES.UINT32],seed:[2,e.TYPES.BYTES]},S.name="SenderKeyRecordStructure",S.internalSpec={senderKeyStates:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,y]},l.SessionStructureSpec=s,l.SessionStructure$PendingPreKeySpec=u,l.SessionStructure$PendingKeyExchangeSpec=c,l.SessionStructure$ChainSpec=d,l.SessionStructure$Chain$MessageKeySpec=m,l.SessionStructure$Chain$ChainKeySpec=p,l.RecordStructureSpec=_,l.PreKeyRecordStructureSpec=f,l.SignedPreKeyRecordStructureSpec=g,l.IdentityKeyPairStructureSpec=h,l.SenderKeyStateStructureSpec=y,l.SenderKeyStateStructure$SenderSigningKeySpec=C,l.SenderKeyStateStructure$SenderMessageKeySpec=b,l.SenderKeyStateStructure$SenderChainKeySpec=v,l.SenderKeyRecordStructureSpec=S}),98);
__d("WASignalKeys",["WACryptoDependencies","WACryptoPrimitives","WASignalLocalStorageProtocol.pb","WASignalOther","decodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e=5,s=16777215;function u(e,t){return{publicKey:e,privateKey:t}}function c(e){var t=o("WACryptoPrimitives").keypairFromSecretKey(e),n=t.publicKey,r=t.secretKey;return u(o("WASignalOther").ensureSize(n,32),o("WASignalOther").ensureSize(r,32))}function d(e,t){return{publicKey:o("WASignalOther").toBytes(e,32),privateKey:o("WASignalOther").toBytes(t,32)}}function m(){var e=o("WACryptoPrimitives").keyPair(),t=e.publicKey,n=e.secretKey;return n[0]&=248,n[31]=64|n[31]&63,u(o("WASignalOther").ensureSize(t,32),o("WASignalOther").ensureSize(n,32))}function p(e,t){return u(o("WASignalOther").sliceBytes(t,1,32),e)}function _(e,t){return{serializedPubKey:t,privateKey:e}}function f(){var e=m();return _(e.privateKey,g(e))}function g(t){var n=o("WASignalOther").makeBytes(33);return n[0]=e,n.set(t.publicKey,1),n}function h(t){var n=o("WASignalOther").makeBytes(33);return n[0]=e,n.set(o("WASignalOther").ensureSize(t,32),1),n}function y(e){return _(e.privateKey,g(e))}function C(e,t){for(var n=e>=s?0:e-1,r=[],a=0;a<t;a++){var i=n+1>=s?1:n+1,l=m(),u=o("WASignalOther").encodeSignalProto(o("WASignalLocalStorageProtocol.pb").PreKeyRecordStructureSpec,{id:i,publicKey:g(l),privateKey:l.privateKey});r.push({plainObject:{id:i,keyPair:l},record:u}),n=i}return r}function b(e){try{var t=o("decodeProtobuf").decodeProtobuf(o("WASignalLocalStorageProtocol.pb").PreKeyRecordStructureSpec,e),n=t.id,r=t.privateKey,a=t.publicKey;return n==null||a==null||r==null?null:{id:v(n),keyPair:p(o("WASignalOther").toBytes(r,32),R(new Uint8Array(a)))}}catch(e){return null}}function v(e){return o("WASignalOther").ensureIntInRange(e,1,s)}function S(e){return o("WASignalOther").ensureIntInRange(e,0,s)}function R(t){if(t.length===0||t[0]!==e)throw r("err")("Unrecognized public key type");return o("WASignalOther").ensureSize(t,33)}function L(){var e=o("WASignalOther").makeBytes(32);return o("WACryptoDependencies").getCrypto().getRandomValues(e),e}function E(e,t){return o("WACryptoPrimitives").scalarMult(e,t.subarray(1)).buffer}l.KEY_TYPE=e,l.PRE_KEY_NON_INCLUSIVE_UPPER_BORDER=s,l.makeKeyPairFrom=c,l.makeKeyPairFromArrayBuffers=d,l.makeKeyPair=m,l.makeKeyPairFromSerialized=p,l.makeSerializedKeyPairFrom=_,l.makeSerializedKeyPair=f,l.serializePubKey=g,l.serializeIdentity=h,l.toSerializedKeyPair=y,l.makePreKeys=C,l.deserializePreKey=b,l.castToPreKeyId=v,l.castToSignedPreKeyId=S,l.castToSerializedPubKey=R,l.makeRawSenderKey=L,l.ecdh=E}),98);
__d("WAParsableWapNode",["WABinary","WAJids","WALogger","WALongInt","WAParsableXmlNode","WASignalKeys","WATimeUtils","WAWap","WAWapJid","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(e){function t(t,n){var r;return r=e.call(this,"XmppParsingFailure: "+t+": "+n)||this,r.name="XmppParsingFailure",r.parser=t,r.reason=n,r}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"XmppParsingFailure: "+this.parser+": "+this.reason},t})(babelHelpers.wrapNativeSuper(Error)),c=(function(t){function n(e,n){return t.call(this,e,n)||this}babelHelpers.inheritsLoose(n,t);var a=n.prototype;return a.assertFromServer=function(){var e=this.attrString("from");e!==o("WAJids").WA_SERVER_JID_SUFFIX&&this.throw('to have "from"="s.whatsapp.net", but instead has "'+e+'"')},a.attrUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.botJid!=null?n.botJid:n.userJid==null?this.throw('to have "'+t+'"={UserJid}, but instead has "'+e+'"'):n.userJid},a.attrPhoneUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneUser"?n.userJid:this.throw('to have "'+t+'"={PhoneUserJid}, but instead has "'+e+'"')},a.attrLidUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="lidUser"?n.userJid:this.throw('to have "'+t+'"={LidUserJid}, but instead has "'+e+'"')},a.maybeAttrUserJid=function(t){return this.hasAttr(t)?this.attrUserJid(t):null},a.maybeAttrPhoneUserJid=function(t){return this.hasAttr(t)?this.attrPhoneUserJid(t):null},a.maybeAttrLidUserJid=function(t){return this.hasAttr(t)?this.attrLidUserJid(t):null},a.attrGroupJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.groupJid==null?this.throw('to have "'+t+'"={GroupJid}, but instead has "'+e+'"'):n.groupJid},a.maybeAttrGroupJid=function(t){return this.hasAttr(t)?this.attrGroupJid(t):null},a.attrChatJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.userJid!=null?n.userJid:n.groupJid!=null?n.groupJid:n.botJid!=null?n.botJid:this.throw('to have "'+t+'"={ChatJid}, but instead has "'+e+'"')},a.attrPhoneChatJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneUser"?n.userJid:n.jidType==="group"?n.groupJid:this.throw('to have "'+t+'"={ChatJid}, but instead has "'+e+'"')},a.attrDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.deviceJid!=null?n.deviceJid:n.userJid!=null?o("WAJids").defaultDeviceJidForUser(n.userJid):n.hostedDeviceJid!=null?n.hostedDeviceJid:n.hostedLidDeviceJid!=null?n.hostedLidDeviceJid:n.botJid!=null?n.botJid:this.throw('to have "'+t+'"={DeviceJid}, but instead has "'+e+'"')},a.attrPhoneDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneDevice"?n.deviceJid:n.jidType==="phoneUser"?o("WAJids").defaultPhoneDeviceJidForUser(n.userJid):this.throw('to have "'+t+'"={PhoneDeviceJid}, but instead has "'+e+'"')},a.attrLidDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="lidDevice"?n.deviceJid:n.jidType==="lidUser"?o("WAJids").defaultLidDeviceJidForLidUserJid(n.userJid):this.throw('to have "'+t+'"={LidDeviceJid}, but instead has "'+e+'"')},a.attrDeviceId=function(t){var e=this.attrInt(t);return o("WAJids").interpretAsDeviceId(e)},a.attrFromJidChat=function(){var t=this.attrJidWithType();switch(t.jidType){case"msgrUser":{var n=t.userJid,a=o("WAJids").defaultDeviceJidForUser(n);return{type:"device",chat:n,deviceJid:a,author:a}}case"interopUser":{var i=t.userJid,l=o("WAJids").defaultDeviceJidForUser(i);return{type:"device",chat:i,deviceJid:l,author:l}}case"phoneUser":{var s=t.userJid,u=o("WAJids").defaultDeviceJidForUser(s);return{type:"device",chat:s,deviceJid:u,author:u}}case"lidUser":{var c=t.userJid,d=o("WAJids").defaultLidDeviceJidForLidUserJid(c);return{type:"device",chat:c,deviceJid:d,author:d}}case"phoneDevice":{var m=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(m),deviceJid:m,author:m}}case"msgrDevice":{var p=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(p),deviceJid:p,author:p}}case"interopDevice":{var _=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(_),deviceJid:_,author:_}}case"lidDevice":{var f=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(f),deviceJid:f,author:f}}case"group":{var g=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return g==null?this.throw("expected to have participant JID for group"):{type:"group",chat:t.groupJid,groupJid:t.groupJid,author:g}}case"broadcast":{var h=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return h==null?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:t.broadcastJid,chat:o("WAJids").extractUserJid(h),author:h}}case"hosted":{var y=t.hostedDeviceJid;return{type:"device",chat:o("WAJids").extractUserJid(y),deviceJid:y,author:y}}case"hostedLid":{var C=t.hostedLidDeviceJid;return{type:"device",chat:o("WAJids").extractUserJid(C),deviceJid:C,author:C}}case"call":throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""])),t.callJid),r("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:return t.jidType,this.throw("attrFromJidChat should not be used with jid of type "+t.jidType)}},a.attrFromJidPhoneChat=function(){var e=this.attrJidWithType();switch(e.jidType){case"phoneUser":{var t=e.userJid,n=o("WAJids").defaultPhoneDeviceJidForUser(t);return{type:"device",chat:t,deviceJid:n,author:n}}case"phoneDevice":{var a=e.deviceJid;return{type:"device",chat:o("WAJids").extractPhoneUserJid(a),deviceJid:a,author:a}}case"group":{var i=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return i==null?this.throw("expected to have participant JID for group"):{type:"group",chat:e.groupJid,groupJid:e.groupJid,author:i}}case"broadcast":{var l=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return l==null?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:e.broadcastJid,chat:o("WAJids").extractPhoneUserJid(l),author:l}}case"call":throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""])),e.callJid),r("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:return e.jidType,this.throw("attrFromJidChat should not be used with jid of type "+e.jidType)}},a.attrFromPhoneJid=function(){var e=this.attrJidWithType();if(e.jidType==="status"){var t=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return t==null?this.throw("to have participant for status msg"):{type:"status",author:t}}else return this.attrFromJidPhoneChat()},a.attrFromJid=function(){var e=this.attrJidWithType();if(e.jidType==="status"){var t=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return t==null?this.throw("to have participant for status msg"):{type:"status",author:t}}return e.jidType==="newsletter"?{type:"newsletter",newsletterJid:e.newsletterJid}:e.jidType==="hosted"?{type:"hosted",hostedDeviceJid:e.hostedDeviceJid}:e.jidType==="hostedLid"?{type:"hostedLid",hostedLidDeviceJid:e.hostedLidDeviceJid}:this.attrFromJidChat()},a.attrJidWithType=function(t){t===void 0&&(t="from");var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="unknown"?this.throw('to have "'+t+'"={Jid}, but instead has "'+e+'"'):n},a.attrWapJid=function(t){t===void 0&&(t="from");var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="unknown"?o("WAWapJid").WapJid.create(null,e):o("WAWap").JID(o("WAJids").extractFromJid(n))},a.attrLongInt=function(t){var e=this.attrString(t);return o("WALongInt").decimalStringToLongInt(e)},a.attrTime=function(t){return o("WATimeUtils").castToUnixTime(this.attrInt(t))},a.maybeAttrTime=function(t){return this.hasAttr(t)?this.attrTime(t):null},a.attrFutureTime=function(t){var e=this.attrInt(t);return o("WATimeUtils").futureUnixTime(e)},a.contentString=function(){if(this.hasChildren())return this.throw("to have string content, but has children instead");if(this.hasContent()){var e=new(o("WABinary")).Binary(this.contentBytes());return e.readString(e.size())}else return this.throw("to have content")},a.decodeAsString=function(t){return o("WAWap").decodeAsString(t)},a.contentSerializedPubKey=function(){return this.hasContent()?o("WASignalKeys").serializeIdentity(this.contentBytes()):this.throw("to have content")},a.createParseError=function(t){return new u(this.name(),"expected <"+this.tag()+"> "+t)},a.throw=function(t){throw this.createParseError(t)},n})(o("WAParsableXmlNode").ParsableXmlNode);l.XmppParsingFailure=u,l.ParsableWapNode=c}),98);
__d("WADeprecatedWapParser",["WAParsableWapNode","err"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t){this.$1=e,this.$2=t}var t=e.prototype;return t.parse=function(t){var e=new(o("WAParsableWapNode")).ParsableWapNode(this.$1,t);try{return{success:this.$2(e)}}catch(e){if(e instanceof o("WAParsableWapNode").XmppParsingFailure)return{error:e};throw e}},t.parseOrThrow=function(t){var e=this.parse(t);if(e.error)throw r("err")(String(e.error));return e.success},e})();l.default=e}),98);
__d("WAAckParser",["WADeprecatedWapParser","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("ack",function(e){return e.assertTag("ack"),{id:e.attrString("id"),ts:e.maybeAttrString("t"),class:e.attrString("class"),type:e.maybeAttrString("type"),from:e.attrJidWithType(),participant:e.hasAttr("participant")?e.attrDeviceJid("participant"):null,recipient:e.hasAttr("recipient")?e.attrUserJid("recipient"):null}});function s(e,t){return e.id===t.id&&(t.class===void 0||e.class===t.class)&&(t.type===void 0||e.type===t.type)&&(t.from===void 0||u(e.from,t.from))&&(t.participant===void 0||e.participant===t.participant)&&(t.recipient===void 0||e.recipient===t.recipient)&&(t.ts===void 0||e.ts===t.ts)}function u(e,t){if(o("WAJids").extractFromJid(e)===t)return!0;if(e.userJid!=null)return o("WAJids").defaultDeviceJidForUser(e.userJid)===t;if(e.deviceJid!=null){var n=e.deviceJid;return o("WAJids").extractDeviceId(n)===0&&o("WAJids").extractUserJid(n)===t}return!1}l.AckParser=e,l.ackMatchesTemplate=s,l.fromJidsAreEqual=u}),98);
__d("WAParseIqResponse",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var r=e.content;if(r&&Array.isArray(r)&&r[0]){var a=r[0];if(a.tag==="error"){var i=a.attrs||{},l;n&&(typeof n=="function"?l=n(e):l=n.parseOrThrow(a));var u=l;return{success:!1,errorCode:parseInt(i.code,10),errorText:o("WAWap").decodeAsString(i.text)||"",errorType:o("WAWap").decodeAsString(i.type)||"",errorBackoff:parseInt(i.backoff,10),toString:s,customError:u}}}return typeof t=="function"?{success:!0,result:t(e)}:{success:!0,result:t.parseOrThrow(e)}}function s(){return"IqError "+this.errorCode+": "+this.errorText}l.parseIqResponse=e}),98);
__d("WADeprecatedSendIq",["Promise","WAAckParser","WAArrayUtils","WAComms","WALogger","WAParseIqResponse"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){return o("WAComms")._sendIq(e,!1).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function c(e,t,n){return o("WAComms")._sendIq(e,!1).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t,n)})}function d(e,t,n){return o("WAComms")._sendIq(e,!1,n).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function m(e,t){return o("WAComms")._sendIq(e,!0).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function p(e,t){return _(e,t).then(function(){})}function _(t,r){return new(s||(s=n("Promise")))(function(a){var i=o("WAComms").singletonOrThrowIfUninitialized("deprecatedSendStanzaAndReturnAck"),l=function(t){var e=o("WAAckParser").AckParser.parse(t);return!e.error&&o("WAAckParser").ackMatchesTemplate(e.success,r)?t:null},u={type:"ack",parseAndTest:l,resolve:a,stanza:t,attachedToSocketId:o("WAComms").DEFAULT_SOCKET_ID,orderedId:o("WAComms").getAndIncrementNextOrderedId()};if(i.ackHandlers.push(u),!i.socket){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will send stanza when socket opens"])));return}i.callStanza(t).catch(function(e){var t=i.ackHandlers.indexOf(u);t!==-1&&(o("WAArrayUtils").removeIndexWithoutPreservingOrder(i.ackHandlers,t),u.resolve((s||(s=n("Promise"))).reject(e)))})})}function f(e,t){o("WAComms").castSmaxStanza(e,t)}l.deprecatedSendIq=u,l.deprecatedSendIqErrorParser=c,l.deprecatedSendIqIfConnectedWithin=d,l.deprecatedSendIqWithoutRetry=m,l.deprecatedSendStanzaAndWaitForAck=p,l.deprecatedSendStanzaAndReturnAck=_,l.deprecatedCastStanza=f}),98);
__d("WAMediaConnParser",["WADeprecatedWapParser","WAServerMediaType"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("mediaConnParser",function(e){var t,n,r=e.child("media_conn"),o=c(r);return{hosts:o,authToken:r.attrString("auth"),authTokenExpiryTs:r.attrFutureTime("auth_ttl"),routesExpiryTs:r.attrFutureTime("ttl"),maxBuckets:r.attrInt("max_buckets"),maxManualRetry:(t=r.maybeAttrInt("max_manual_retry",0,4))!=null?t:3,maxAutoDownloadRetry:(n=r.maybeAttrInt("max_auto_download_retry",0,4))!=null?n:3}});function s(e){var t,n;if(e.hasAttr("fallback_hostname"))return{domain:e.attrString("fallback_hostname"),class:e.maybeAttrString("fallback_class"),ip4:(t=e.maybeAttrString("fallback_ip4"))!=null?t:void 0,ip6:(n=e.maybeAttrString("fallback_ip6"))!=null?n:void 0}}function u(e){var t,n,r,o;return{domain:e.attrString("hostname"),fallback:s(e),uploadable:d(e,"upload"),downloadable:d(e,"download"),isFallback:e.maybeAttrString("type")==="fallback",downloadBuckets:(t=(n=e.maybeChild("download_buckets"))==null?void 0:n.mapChildren(function(e){return parseInt(e.tag(),10)}))!=null?t:[],class:e.maybeAttrString("class"),ip4:(r=e.maybeAttrString("ip4"))!=null?r:void 0,ip6:(o=e.maybeAttrString("ip6"))!=null?o:void 0}}function c(e){return e.mapChildrenWithTag("host",u)}function d(e,t){return e.hasChild(t)?e.child(t).mapChildren(function(e){var t=e.tag();return o("WAServerMediaType").castToServerMediaType(t)}).filter(Boolean):o("WAServerMediaType").SERVER_MEDIA}l.mediaConnParser=e}),98);
__d("WAGatherMediaInfo",["WADeprecatedSendIq","WAErrors","WALogger","WAMediaConnParser","WAPromiseManagement","WAPromiseRetryLoop","WAResultOrError","WAWap"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=507,p=o("WAPromiseManagement").cacheWhilePending(function(){return"gatherMediaInfo"},_);function _(){var e=new(o("WAPromiseRetryLoop")).PromiseRetryLoop({name:"gatherMediaInfo",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:g});return e.start(),e.promise()}var f=60;function g(t){var n,r=(n=o("WAWap")).wap("iq",{id:n.generateId(),to:n.S_WHATSAPP_NET,type:"set",xmlns:"w:m"},n.wap("media_conn",null));return o("WADeprecatedSendIq").deprecatedSendIqIfConnectedWithin(r,o("WAMediaConnParser").mediaConnParser,f).then(function(n){if(n.success)o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," hosts"])),n.result.hosts.length),t(o("WAResultOrError").makeResult(n.result));else if(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo failure ",""])),n),n.errorCode===m){var r=n.errorBackoff;o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," seconds backoff"])),r),t(o("WAResultOrError").makeError({type:"backoff",backoffMs:r*1e3}))}else n.errorCode<500&&(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got client error: ",""])),n.errorCode),t(o("WAResultOrError").makeError({type:"client-error",code:n.errorCode,text:n.errorText})))}).catch(function(e){e instanceof o("WAErrors").Disconnected?t(o("WAResultOrError").makeError("disconnected")):o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo error ",""])),e)})}l.gatherMediaInfo=p}),98);
__d("WAMediaRouteSelection",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=null,n=null,r=null,a=e.hosts,i=e.mediaType,l=e.operation;if(e.operation==="download"){var s,u=e.catHotTimespan,c=e.getVcaEnabledBucket,d=e.ncHot,m=new Map;a.forEach(function(e){e.downloadBuckets.forEach(function(t){m.set(t,e)})});var p=m.get(0);u>0&&d!=null&&o("WATimeUtils").happenedWithin(o("WATimeUtils").castToUnixTime(d),u)?t=1:c&&(t=c());var _=null;t!=null&&(_=m.get(t)),(s=_)!=null&&s.downloadable.includes(i)?n=_:p!=null&&p.downloadable.includes(i)&&(n=p)}for(var f=0;f<a.length;f++){var g=a[f];if((l==="upload"&&g.uploadable.includes(i)||l==="download"&&g.downloadable.includes(i))&&(n==null?n=g:g.isFallback&&r==null&&(r=g)),n!=null&&r!=null)break}return{selectedHost:n,fallbackHost:r,bucket:t}}l.mediaRouteSelection=e}),98);
__d("WAGetMediaRoute",["$InternalEnum","WACreateGetVcaEnabledBucket","WAExtractNcHotTimestamp","WAGatherMediaInfo","WAMediaRouteSelection","WAPromiseManagement","WAResultOrError","WATagsLogger","WATimeUtils","WAWaitForComms","WAWorkerGlobalScope"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("WATagsLogger").TAGS(["GetMediaRoute"]),g=86400,h=n("$InternalEnum")({Fresh:"fresh",Cached:"cached",Stale:"stale"}),y=null,C=!1,b=null;async function v(t,n){n==null||n.addPoint("get_cached_or_fresh_media_access_start");var r=await E();if(n==null||n.addPoint("get_cached_or_fresh_media_access_end"),!r.success)return f.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to get mediaAccess: ",""])),r.error),n==null||n.addPoint("get_media_access_failed",{string:{mediaAccessStatus:r.error}}),r;n==null||n.addAnnotations({string:{mediaAccessStatus:r.value.state}});var a=r.value.mediaAccess,i=a.authToken,l=a.hosts,u=a.maxBuckets,c=t.operation==="upload"?o("WAMediaRouteSelection").mediaRouteSelection({operation:"upload",mediaType:t.serverMediaType,hosts:l}):o("WAMediaRouteSelection").mediaRouteSelection({operation:"download",mediaType:t.serverMediaType,hosts:l,catHotTimespan:g,ncHot:o("WAExtractNcHotTimestamp").extractNcHotTimestamp(t.directPath),getVcaEnabledBucket:o("WACreateGetVcaEnabledBucket").msgrCreateGetVcaEnabledBucket(t.directPath,u)}),d=c.bucket,m=c.fallbackHost,p=c.selectedHost;return p==null?(f.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error: no media host"]))),o("WAResultOrError").makeError("no-host")):o("WAResultOrError").makeResult({authToken:i,selectedHost:p,fallbackHost:m,bucket:d})}function S(){var e=b;e!=null&&(o("WAWorkerGlobalScope").workerGlobalScope.clearTimeout(e),b=null)}function R(e){S();var t=Math.max(e.authTokenExpiryTs-o("WATimeUtils").unixTime(),0);if(!(t<=300)){var n=o("WATimeUtils").pastUnixTime(300,e.authTokenExpiryTs),r=o("WATimeUtils").pastUnixTime(Math.floor(t*.2),e.authTokenExpiryTs),a=n<r?n:r,i=o("WATimeUtils").cappedMillisecondsUntil(a),l=Math.floor(Math.random()*o("WATimeUtils").MINUTE_MILLISECONDS),s=o("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){f.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["AuthTTL approaching expiry, refreshing MediaAccess routes"]))),L().catch(function(e){f.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Error occurred during authTTL automatic refresh: ",""])),e)})},i+l);b=s}}var L=o("WAPromiseManagement").cacheWhilePending(function(){return"all"},async function(){if(C)return f.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, but we are still locked by backoff"]))),o("WAResultOrError").makeError("backoff");await o("WAWaitForComms").waitForComms(),f.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, gather a new one"]))),S();var e=await o("WAGatherMediaInfo").gatherMediaInfo();if(e.success)return y=e.value,R(e.value),o("WAResultOrError").makeResult({mediaAccess:e.value,state:h.Fresh});var t=e.error,n=t==="disconnected"?"disconnected":t.type;return f.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Can not get mediaAccess: ",""])),n),t==="disconnected"||t.type==="client-error"?o("WAResultOrError").makeError("disconnected"):(t.type,C=!0,o("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){C=!1,L().catch(function(e){f.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Error occurred on gather after backoff expiry: ",""])),e)})},t.backoffMs),o("WAResultOrError").makeError("backoff"))}),E=function(){var e=y;if(e==null)return L();if(o("WATimeUtils").isInFuture(e.routesExpiryTs))return Promise.resolve(o("WAResultOrError").makeResult({mediaAccess:e,state:h.Cached}));var t=L();return o("WATimeUtils").isInFuture(e.authTokenExpiryTs)?Promise.resolve(o("WAResultOrError").makeResult({mediaAccess:e,state:h.Stale})):t};function k(){y=null,C=!1,S()}l.getMediaRoute=v,l.getCachedOrFreshMediaAccess=E,l.clearCachedMediaAccessForTest=k}),98);
__d("WAMediaOperationsRetrier",["WALogger","WAPromiseBackoffs"],(function(t,n,r,o,a,i,l){"use strict";var e,s=4,u={algo:{type:"constant",delay:1e3},jitter:0},c=(function(){function t(e,t,n){this.$1=e,this.routesInfo=t,this.$2=o("WAPromiseBackoffs").createPromiseTimer(u),this.$3=0,this.$4=!1,this.$5=n}var n=t.prototype;return n.run=async function(n,r){for(;this.$3<s;){await this.$2();var t=void 0;if(this.$3>0){var a;t=this.$3>=s-2&&!this.$4,o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MediaOperationsRetrier:"," wait for internet, attempt = ",""])),this.$1,this.$3),await((a=this.$5)==null?void 0:a.call(this))}else t=!1;var i=this.routesInfo;if(!i)return null;var l=i.host;t&&i.fallbackHost&&(l=i.fallbackHost);var u=await n(l,i.authToken,this.$3,r);if(u.success)return u.value;++this.$3,this.$4=u.error.progressMade}return null},t})();l.MAX_ATTEMPTS=s,l.BACKOFF_OPTIONS=u,l.MediaOperationsRetrier=c}),98);
__d("WACreateMediaDownloadRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=e.directPath,n=e.eventFlow,r=e.fileEncSha256,a=e.mediaTypeDetails,i=a.type==="regular"?a.mediaType:"preview";n==null||n.addPoint("get_media_route_start");var l=await o("WAGetMediaRoute").getMediaRoute({operation:"download",serverMediaType:i,fileEncSha256:r,directPath:t},n);if(!l.success)return n==null||n.addPoint("get_media_route_fail"),l;n==null||n.addPoint("get_media_route_end");var s=l.value,u=s.authToken,c=s.fallbackHost,d=s.selectedHost,m=new(o("WAMediaOperationsRetrier")).MediaOperationsRetrier("download",{host:{domain:d.domain,class:d.class},fallbackHost:c&&{domain:c.domain,class:c.class},authToken:u,timeElapsed:null},o("WAComms").waitForConnection);return o("WAResultOrError").makeResult({retrier:m,mediaRouteDetails:l.value})}l.createMediaDownloadRetrier=e}),98);
__d("WAHttpDownloadMedia",["WAErrorMessage","WALogger","WAMediaQplHelper","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="URL signature expired";async function m(t,n){var r=n!=null?n:{},a=r.abortSignal,i=r.mediaMetrics;i==null||i.addPoint("http_fetch_start");var l=await self.fetch(t,{method:"GET",mode:"cors",cache:"no-store",signal:a}).then(function(e){return i==null||i.addPoint("http_fetch_end"),o("WAResultOrError").makeResult(e)}).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return i==null||i.addPoint("http_fetch_fail",{string:{httpFetchError:n}}),o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to initiate fetch: ",", message: ",""])),t,n),t.name==="AbortError"?o("WAResultOrError").makeError("http-fetch-aborted"):o("WAResultOrError").makeError("http-fetch-exception")});if(l.success===!1)return l;var m=l.value,p=m.headers.get("content-length"),_=m.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""])),_),i==null||i.addAnnotations({string:{ciphertextMediaSizeBucket:p!=null?o("WAMediaQplHelper").convertIntegerSizeToStringBucket(Number(p)):null},int:{httpStatus:_}}),_){case 200:case 206:return o("WAResultOrError").makeResult(m);case 401:return o("WAResultOrError").makeError("access-expired");case 403:return m.text().then(function(e){return e===d?o("WAResultOrError").makeError("signature-expired"):o("WAResultOrError").makeError("access-expired")}).catch(function(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body: ",""])),e),o("WAResultOrError").makeError("access-expired")});case 404:case 410:return o("WAResultOrError").makeError("media-not-found");case 408:return o("WAResultOrError").makeError("server-timeout");case 416:return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: can not resume from offset"]))),o("WAResultOrError").makeError("request-error");case 429:case 507:return o("WAResultOrError").makeError("download-throttled");default:return _>=400&&_<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}l.httpDownloadMedia=m}),98);
__d("WAHttpUtils",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){if(!/^https:\/\/[-\w.]+\.\w+$/.test(e))throw r("err")('buildUrl given invalid host "'+e+'"');if(!t.startsWith("/"))throw r("err")('buildUrl given invalid path "'+t+'"');var o=n,a=""+e+t;if(!o)return a;var i=Object.keys(o).map(function(e){var t=o[e];t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n=t instanceof Uint8Array?Array.from(t).map(function(e){return"%"+e.toString(16)}).join(""):encodeURIComponent(t.toString());return encodeURIComponent(e)+"="+n});if(i.length>0){var l=i.join("&");return a.includes("?")?a+"&"+l:a+"?"+l}else return a}l.buildUrl=e}),98);
__d("WAMediaUrl",["WABase64","WAGlobals","WAHttpUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=1;function s(t,n,r,a,i,l,s){var u=o("WAGlobals").getDependencies().mediaUploadRoot(),c=o("WABase64").encodeB64UrlSafe(r),d=o("WABase64").encodeB64UrlSafe(n),m={auth:i,token:d};return l&&(m.resume=e),s!=null&&s>0&&(m.bytestart=s),o("WAHttpUtils").buildUrl("https://"+a,u+"/"+t+"/"+c,m)}function u(e,t,n,r,a,i,l){var s=o("WABase64").encodeB64UrlSafe(t),u={hash:s,mode:r};return a!=null&&(u._nc_cat=a),i!=null&&i>=0&&(u.bytestart=i),l!=null&&l>0&&(u.byteend=l),o("WAHttpUtils").buildUrl("https://"+n,e,u)}l.RESUME_PARAM=e,l.buildUploadUrl=s,l.buildDownloadUrl=u}),98);
__d("WADownloadCiphertext",["WAAssertUnreachable","WABase64","WACreateMediaDownloadRetrier","WACryptoSha256","WACryptoUtils","WAHashUtils","WAHttpDownloadMedia","WALogger","WAMediaUrl","WAPromiseManagement","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;async function _(t){var n=t.abortSignal,a=t.directPath,i=t.eventFlow,l=t.fileEncSha256,_=t.fromBytes,f=t.mediaTypeDetails,h=t.plaintextHash,y=t.toBytes;o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Start download ciphertext for hash: ",""])),o("WAHashUtils").sanitisePlaintextHash(h)),i.addPoint("create_retrier_start");var C=await o("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({mediaTypeDetails:f,directPath:a,eventFlow:i,fileEncSha256:l});if(!C.success)return i.addPoint("create_retrier_fail"),C;i.addPoint("create_retrier_end");var b=C.value,v=b.mediaRouteDetails,S=b.retrier,R=await S.run(function(e,t,r){var m=e.domain,p="http_download_media_"+r,f=o("WAMediaUrl").buildDownloadUrl(a,l,m,"manual",v.bucket,_,y);return o("WALogger").DEV_XMPP(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Downloading ciphertext for hash : "," from ",". Attempt: ",""])),o("WAHashUtils").sanitisePlaintextHash(h),f,r),i.addPoint(p+"_start"),o("WAHttpDownloadMedia").httpDownloadMedia(f,{mediaMetrics:i,abortSignal:n,cachePolicy:r>0?"no-store":"force-cache"}).then(function(e){if(e.success)return e.value.arrayBuffer().then(function(e){return i.addPoint(p+"_end"),o("WAResultOrError").makeResult(o("WAResultOrError").makeResult(e))}).catch(function(e){return i.addPoint("response_array_buffer_error"),i.addPoint(p+"_fail"),o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body ",""])),e),o("WAResultOrError").makeResult(o("WAResultOrError").makeError("body-network-error"))});i.addPoint(p+"_fail");var t=e.error;switch(o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: ",""])),t),i.addPoint(t),t){case"signature-expired":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("signature-expired"));case"http-fetch-aborted":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("http-fetch-aborted"));case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":return o("WAResultOrError").makeError({progressMade:!0});default:return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(t))}}).catch(function(e){return i.addPoint(p+"_fail"),o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["downloadCiphertext http download exception: ",""])),e),o("WAResultOrError").makeError({progressMade:!1})})});if(R==null)return o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded");if(R.success===!1){var L=R.error;switch(o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext failed: ",""])),L),L){case"signature-expired":case"http-fetch-aborted":case"media-not-found":case"download-throttled":case"body-network-error":case"request-error":return o("WAResultOrError").makeError(L);case"access-expired":return o("WAResultOrError").makeError("disconnected");default:throw r("WAAssertUnreachable")(L)}}else{var E=R.value;return!g(_,y)&&!o("WACryptoUtils").arrayBuffersEqual(await o("WACryptoSha256").sha256(E),l)?o("WAResultOrError").makeError("ciphertext-hash-mismatch"):(i.addPoint("download_finish",{int:{byteLength:E.byteLength},bool:{isPartialDownload:g(_,y)}}),o("WAResultOrError").makeResult(E))}}var f=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.fileEncSha256,n=e.fromBytes,r=e.toBytes;return o("WABase64").encodeB64UrlSafe(t)+"-"+(n!=null?n:"X")+"-"+(r!=null?r:"X")},_);function g(e,t){return e!=null&&e>0?!0:t!=null}l.cachedDownloadCiphertext=f}),98);
__d("WADownloadAndDecryptMedia",["WADecryptMedia","WADownloadCiphertext","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=e.abortSignal,n=e.directPath,r=e.eventFlow,a=e.fileEncSha256,i=e.mediaKey,l=e.mediaTypeDetails,s=e.plaintextHash,u=await o("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:t,mediaTypeDetails:l,fileEncSha256:a,directPath:n,eventFlow:r,plaintextHash:s});if(u.success!==!0)return u;var c=await o("WADecryptMedia").decryptMedia({mediaKey:i,mediaTypeDetails:l,plaintextHash:s,ciphertextHmac:u.value});return c.success!==!0?c:(c.value.alternativeHmacSaltUsed!=null&&r.addAnnotations({string:{alternativeHmacSaltUsed:c.value.alternativeHmacSaltUsed}}),o("WAResultOrError").makeResult(c.value.plaintext))}l.downloadAndDecryptMedia=e}),98);
__d("WACreateMediaDecrypterStream",["WABinary","WAMediaCrypto","WAResultOrError","WATagsLogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["WADecryptStream"]);function f(t,n,r,a,i){if(a.byteLength===0)return _.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs must have at least one element"]))),o("WAResultOrError").makeError("missing-expected-hmacs");if(a.byteLength!==i.length*o("WAMediaCrypto").HMAC_LENGTH)return _.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs and ciphertextLengths must have the same length"]))),o("WAResultOrError").makeError("hmac-chiphertext-array-mismatch");var l=g(a),m=n,p=new(o("WABinary")).Binary,f=0,y=async function(n,a){for(p.writeByteArray(n);f<l.length&&p.size()>=i[f];f++){var e=p.readByteArrayView(i[f]);_.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," of size ",""])),f,e.length);var s=f===i.length-1;try{var d=await o("WAMediaCrypto").hmacAndDecryptPartial(t,m,e,r,l[f]),g=d.nextIv,y=d.plaintext;s?a.enqueue(h(y)):a.enqueue(y),m=g}catch(e){_.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt chunk. isLastChunk: "," error: ",""])),s,e),e instanceof o("WAMediaCrypto").HmacValidationError?a.error("enc-hash-mismatch"):a.error("decryption-error")}}},C=new TransformStream({transform:function(t,n){var e=t;return y(e,n)},flush:function(t){p.size()>0&&_.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unexpected ciphertext in buffer following flush"])))}});return o("WAResultOrError").makeResult(C)}function g(e){var t=[];if(e.byteLength%o("WAMediaCrypto").HMAC_LENGTH!==0)throw r("err")("Sidecar length is not a multiple of hmac length");for(var n=0;n<e.byteLength;n+=o("WAMediaCrypto").HMAC_LENGTH){var a=new Uint8Array(e,n,o("WAMediaCrypto").HMAC_LENGTH);t.push(a)}return t}function h(e){if(e.length<o("WAMediaCrypto").CBC_BLOCK_SIZE)return _.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Plaintext size is less than CBC_BLOCK_SIZE"]))),e;var t=e[e.length-1];return t===0||t>o("WAMediaCrypto").CBC_BLOCK_SIZE?(_.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Invalid PKCS padding length"]))),e):e.subarray(0,-t)}l.createDefaultDecryptStream=f}),98);
__d("WAMediaProgressiveJpegTransformStream",["WABinary"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.scanLengths,n=[],r=0;for(var a of t)r+=a,n.push(r);var i=new(o("WABinary")).Binary,l=0,s=0,u=new TransformStream({transform:function(r,o){var e=r;for(s+=e.byteLength,i.writeByteArray(e);l<t.length&&n[l]<s;l++){var a=i.readByteArrayView(t[l]);o.enqueue(a)}},flush:function(t){t.enqueue(i.readByteArrayView())}});return u}l.makeProgressiveJpegHandlerTransformStream=e}),98);
__d("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry",["WACreateMediaDecrypterStream","WAHttpDownloadMedia","WAMediaCrypto","WAMediaProgressiveJpegTransformStream","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function c(e){return e}async function d(t){var n=t.abortSignal,r=t.cachePolicy,a=t.downloadUrl,i=t.eventFlow,l=t.mediaKey,c=t.progressiveJpegDetails,d=t.serverMediaType,m=await o("WAHttpDownloadMedia").httpDownloadMedia(a,{mediaMetrics:i,abortSignal:n,cachePolicy:r});if(m.success!==!0)return m;var p=m.value.body;if(p==null)return o("WAResultOrError").makeError("body-network-error");var _=m.value.headers.get("Content-Length");if(_==null)return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is missing"]))),o("WAResultOrError").makeError("missing-content-length-header");var f=Number(_);if(Number.isNaN(f))return u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is not a number"]))),o("WAResultOrError").makeError("invalid-content-length-header");var g=o("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:c,ciphertextLength:f}),h=await o("WAMediaCrypto").computeMediaKeys(l,d),y=o("WACreateMediaDecrypterStream").createDefaultDecryptStream(h.cipherKey,h.iv,h.hmacKey,g.sidecar,g.alignedScanLengths);if(y.success!==!0)return y;var C=y.value,b=o("WAMediaProgressiveJpegTransformStream").makeProgressiveJpegHandlerTransformStream(g),v=p.pipeThrough(C).pipeThrough(b);return o("WAResultOrError").makeResult(v)}l.unsafeCastToDownloadAndDecryptPJpegStream=c,l.downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry=d}),98);
__d("WADownloadProgressiveJpegPlaintextStreamer",["WAAssertUnreachable","WACreateMediaDownloadRetrier","WADownloadProgressiveJpegPlaintextStreamerWithoutRetry","WAMediaUrl","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);async function u(t){var n=t.abortSignal,a=t.directPath,i=t.eventFlow,l=t.fileEncSha256,u=t.mediaKey,c=t.progressiveJpegDetails,d=t.serverMediaType,m=await o("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({directPath:a,eventFlow:i,fileEncSha256:l,mediaTypeDetails:{type:"regular",mediaType:d}});if(!m.success)return m;var p=m.value,_=p.mediaRouteDetails,f=p.retrier,g=_.bucket,h=await f.run(async function(e,t,s){var m=e.domain,p=o("WAMediaUrl").buildDownloadUrl(a,l,m,"manual",g),_=await o("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry").downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry({abortSignal:n,downloadUrl:p,eventFlow:i,mediaKey:u,progressiveJpegDetails:c,serverMediaType:d,cachePolicy:s>0?"no-store":"force-cache"});if(_.success===!0)return o("WAResultOrError").makeResult(_);var f=_.error;switch(f){case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":case"invalid-content-length-header":case"missing-content-length-header":return o("WAResultOrError").makeError({progressMade:!0});case"access-expired":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("disconnected"));case"body-network-error":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("request-error"));case"media-not-found":case"request-error":case"download-throttled":case"signature-expired":case"http-fetch-aborted":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(f));case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(f));default:throw r("WAAssertUnreachable")(f)}});return h==null?(s.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Download with stream given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded")):h}l.downloadProgressiveJpegPlaintextUsingStreams=u}),98);
__d("WAGetAgeBucketForMediaKeyTimestamp",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e==null)return"Missing";if(o("WATimeUtils").isInFuture(e))switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day in future";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days in future";default:return"> 7 days in future"}switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days";case o("WATimeUtils").happenedWithin(e,14*o("WATimeUtils").DAY_SECONDS):return"7-14 days";case o("WATimeUtils").happenedWithin(e,21*o("WATimeUtils").DAY_SECONDS):return"14-21 days";case o("WATimeUtils").happenedWithin(e,30*o("WATimeUtils").DAY_SECONDS):return"21-30 days";case o("WATimeUtils").happenedWithin(e,40*o("WATimeUtils").DAY_SECONDS):return"30-40 days";case o("WATimeUtils").happenedWithin(e,50*o("WATimeUtils").DAY_SECONDS):return"40-50 days";case o("WATimeUtils").happenedWithin(e,60*o("WATimeUtils").DAY_SECONDS):return"50-60 days";default:return"> 60 days"}}l.getAgeBucketForMediaKeyTimestamp=e}),98);
__d("WAPrepareMediaDownload",["Promise","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAHashUtils","WAMediaQplHelper","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=typeof((e=navigator.storage)==null?void 0:e.getDirectory)=="function",m=typeof self.caches=="object",p=0;function _(e){var t,r=e.hash,a=e.logger,i=e.mediaDownloadFlow,l=e.mediaEntry,_=l.directPath,f=l.downloadableThumbnail,g=l.mediaKeyTimestamp,h=l.serverMediaType,y=l.size,C=o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(g);a.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start download ",". mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""])),o("WAHashUtils").sanitisePlaintextHash(r),C,y,h);var b=(t=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(l).value)!=null?t:null;return i.addPoint("wa_protocol_media_download_start",{string:{mediaType:h,mediaKeyTimestampAgeBucket:C,sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)},bool:{isOPFSSupported:d,isWebCacheSupported:m,duplicateDirectPath:(f==null?void 0:f.directPath)===_,hasDownloadableThumbnail:(f==null?void 0:f.directPath)!=null,isProgressiveJpeg:b!=null}}),{logDownloadResult:function(t){return p++,i.addAnnotations({int:{concurrentDownloadCount:p}}),t.then(function(e){if(e.success){var t=e.value.plaintext.byteLength;i.addPoint("wa_protocol_media_download_end",{string:{media_size:o("WAMediaQplHelper").convertIntegerSizeToStringBucket(t)}})}else i.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:e.error}});return e}).catch(function(e){i.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"runtime-error"}});var t=o("WAErrorMessage").maybeGetMessageFromError(e);return a.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""])),t),(c||(c=n("Promise"))).resolve(o("WAResultOrError").makeError("runtime-error"))}).finally(function(){p--})}}}l.prepareMediaDownload=_}),98);
__d("WAProgressiveJpegAddJPEGTrailingTag",["WATypedArraysConcat"],(function(t,n,r,o,a,i,l){"use strict";var e=new Uint8Array([255,217]);function s(t){return o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[new Uint8Array(t),e]).buffer}l.JPEG_TRAILING_TAG=e,l.addJPEGTrailingTag=s}),98);
__d("WAStreamAsyncIterator",[],(function(t,n,r,o,a,i){"use strict";function e(e){return l.apply(this,arguments)}function l(){return l=babelHelpers.wrapAsyncGenerator(function*(e){var t=e.getReader();try{for(;;){var n=yield babelHelpers.awaitAsyncGenerator(t.read()),r=n.done,o=n.value;if(r)return;yield o}}finally{t.releaseLock()}}),l.apply(this,arguments)}i.streamAsyncIterator=e}),66);
__d("WADownloadMedia",["WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadAndDecryptMedia","WADownloadDownloadablePreview","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAHashUtils","WAMediaCrypto","WAMediaUtils","WAPrepareMediaDownload","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAPromiseManagement","WAResultOrError","WAStreamAsyncIterator","WATagsLogger","WATypedArraysConcat"],(function(t,n,r,o,a,i,l){"use strict";var e=["hash"],s,u,c,d,m,p,_,f,g,h,y,C,b,v,S=o("WATagsLogger").TAGS(["MediaDownload"]);function R(e){var t=e.downloadMediaMetric,n=e.handleMediaPreviewBeforeDownload,r=e.handleMediaPreviewDownload,a=e.handleMediaPreviewDownloadFailed,i=e.hash,l=e.mediaEntry,s=e.protocolMsgId,u=o("WAPrepareMediaDownload").prepareMediaDownload({mediaDownloadFlow:t,mediaEntry:l,hash:i,logger:S}),c=u.logDownloadResult;return c(E({downloadMediaMetric:t,hash:i,mediaEntry:l,protocolMsgId:s,handleMediaPreviewDownload:r,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:a}))}var L=async function(t){var e=t.downloadMediaMetric,n=t.handleMediaPreviewBeforeDownload,r=t.handleMediaPreviewDownload,a=t.handleMediaPreviewDownloadFailed,i=t.hash,l=t.mediaEntry,p=t.protocolMsgId,_=o("WAMediaUtils").validateDecodedMediaEntryForDownload(l);if(!_.success)return S.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mediaEntry is incomplete. ",""])),_.error),_;var f=_.value,g=f.directPath,h=f.fileEncSha256,y=f.fileSha256,C=f.mediaKey,b=f.serverMediaType,v=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(l);v.success===!1&&(S.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to get ProgressiveJpeg details: ",""])),v.error),e.addPoint(v.error));var R=v.success===!0?v.value:null,L=function(t){if(t==null)return Promise.resolve();var e=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(b);return e==null?(S.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""])),b),Promise.resolve()):r(i,t,e,p).then(function(){})};if(R!=null&&o("WAMediaUtils").isTransformStreamSupported()&&b==="image"){var E=await x({directPath:g,downloadFlow:e,fileEncSha256:h,handleMediaPreviewBlob:L,hash:i,mediaKey:C,progressiveJpegDetails:R,serverMediaType:b,fileSha256:y,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:a});if(E.success)return o("WAResultOrError").makeResult({mimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(b),plaintext:E.value,serverMediaType:b});var I=E.error;switch(S.WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Media Streaming failed to download progressive jpeg. Reason: ",". PlaintextHash: ",""])),I,o("WAHashUtils").sanitisePlaintextHash(i)),I){case"signature-expired":case"request-error":return S.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Skipping fallback for ",". PlaintextHash: ",""])),I,o("WAHashUtils").sanitisePlaintextHash(i)),o("WAResultOrError").makeError(I)}}e==null||e.addPoint("fallback_to_non_streaming_download");var T=D({hash:i,mediaEntry:l,progressiveJpegDetails:R,protocolMsgId:p,serverMediaType:b,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:a,downloadEntry:e.downloadEntry,triggerUIView:e.triggerUIView});return T.then(function(e){return e.success===!1?L(null):L(e.value)}),k({downloadMediaMetric:e,mediaEntry:_.value})},E=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.hash;return t},L),k=async function(t){var e=t.abortSignal,n=t.downloadMediaMetric,r=t.mediaEntry,a=r.directPath,i=r.fileEncSha256,l=r.fileSha256,s=r.mediaKey,u=r.serverMediaType,c=await T({abortSignal:e,downloadFlow:n,mediaTypeDetails:{mediaType:u,type:"regular"},directPath:a,fileEncSha256:i,fileSha256:l,mediaKey:s});return c.success?o("WAResultOrError").makeResult({mimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(u),plaintext:c.value,serverMediaType:u}):c},I=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.hash;return t},function(t){var n=t.hash,r=babelHelpers.objectWithoutPropertiesLoose(t,e),a=o("WAPrepareMediaDownload").prepareMediaDownload({hash:n,mediaDownloadFlow:r.downloadMediaMetric,mediaEntry:r.mediaEntry,logger:S}),i=a.logDownloadResult;return i(k(r))});async function T(e){var t=e.abortSignal,n=e.directPath,r=e.downloadFlow,a=e.fileEncSha256,i=e.fileSha256,l=e.mediaKey,s=e.mediaTypeDetails,u=o("WAHashUtils").toPlaintextHash(i),c=await o("WADownloadAndDecryptMedia").downloadAndDecryptMedia({abortSignal:t,directPath:n,eventFlow:r,fileEncSha256:a,mediaKey:l,mediaTypeDetails:s,plaintextHash:u});if(c.success===!1){var d=c.error;switch(d){case"signature-expired":case"media-not-found":return o("WAResultOrError").makeError(d);case"enc-hash-mismatch":return S.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia: enc-hash-mismatch"]))),o("WAResultOrError").makeError(d);default:return o("WAResultOrError").makeError(d)}}else{var m=c.value;return o("WAResultOrError").makeResult(m)}}function D(e){var t=e.downloadEntry,n=e.handleMediaPreviewBeforeDownload,r=e.handleMediaPreviewDownloadFailed,a=e.hash,i=e.mediaEntry,l=e.progressiveJpegDetails,s=e.protocolMsgId,u=e.serverMediaType,c=e.triggerUIView;return l==null?o("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(s,a,u,i,t,{handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r},c):o("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreview({protocolMsgId:s,hash:a,serverMediaType:u,mediaEntry:i,progressiveJpegDetails:l,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r,downloadEntry:t,triggerUIView:c}).then(function(e){return e.success!==!0?o("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(s,a,u,i,t,{handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r},c):e})}async function x(e){var t=e.directPath,n=e.downloadFlow,r=e.fileEncSha256,a=e.fileSha256,i=e.handleMediaPreviewBeforeDownload,l=e.handleMediaPreviewBlob,s=e.handleMediaPreviewDownloadFailed,u=e.hash,c=e.mediaKey,d=e.progressiveJpegDetails,m=e.serverMediaType,p=S.TAGS(["MediaStreaming"]);p.LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_start");var R=o("WADownloadProgressiveJpegPreview").getPreviewTargetScan(d.scanLengths)-1;p.LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Targeting scanIndex "," for preview. PlaintextHash: ",""])),R,o("WAHashUtils").sanitisePlaintextHash(u)),n.addAnnotations({int:{scans:d.scanLengths.length}}),i(u);var L=await o("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({directPath:t,eventFlow:n,fileEncSha256:r,mediaKey:c,progressiveJpegDetails:d,serverMediaType:m});if(L.success===!1)return n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:L.error}}),s(u,L.error),L;n.addPoint("download_pjpeg_preview_start");var E=[],k=0;try{var I=!1,T=!1,D;try{for(var x=babelHelpers.asyncIterator(o("WAStreamAsyncIterator").streamAsyncIterator(L.value)),$;I=!($=await x.next()).done;I=!1){var P=$.value;{if(P==null)continue;if(p.LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," for plaintextHash ",""])),k,o("WAHashUtils").sanitisePlaintextHash(u)),E.push(P),k===R){n.addPoint("media_streaming_preview_processed"),p.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Handling preview from scan "," for plaintextHash ",""])),k,o("WAHashUtils").sanitisePlaintextHash(u));var N=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(E,[o("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));l(N),n.addPoint("download_pjpeg_preview_end")}k++}}}catch(e){T=!0,D=e}finally{try{I&&x.return!=null&&await x.return()}finally{if(T)throw D}}k<R&&(p.ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["pjpeg stream ended before reaching previewTargetScanIndex for plaintextHash ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("download_pjpeg_preview_fail"));var M=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(E))),w=await o("WACryptoSha256").sha256(M);return o("WACryptoUtils").arrayBuffersEqual(a,w)?(p.LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download successful. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_end"),o("WAResultOrError").makeResult(M)):(p.WARN(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:"hash-mismatch"}}),o("WAResultOrError").makeError("hash-mismatch"))}catch(e){return p.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""])),e),k<R&&(n.addPoint("download_pjpeg_preview_fail"),s(u,o("WAErrorMessage").maybeGetMessageFromError(e))),n==null||n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WAResultOrError").makeError("stream-error")}}l.mediaDownloadLogger=S,l.downloadMedia=R,l.downloadFullMediaOnly=k,l.cachedDownloadFullMediaOnly=I,l.downloadMediaImpl=T}),98);
__d("WADownloadProgressiveJpegPlaintext",["WADownloadCiphertext","WAMediaCrypto","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["DownloadProgressiveJpeg"]);async function d(e){var t=e.abortSignal,n=e.directPath,r=e.eventFlow,a=e.fileEncSha256,i=e.mediaKey,l=e.mediaTypeDetails,s=e.plaintextHash,u=e.progressiveJpegDetails,c=e.size,d=e.targetScan,_=o("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:u,ciphertextLength:p(c)}),f=o("WAProgressiveJpegGetPJpegDetails").getTotalByteSizeForScan(_.alignedScanLengths,d),g=await o("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:t,mediaTypeDetails:l,fileEncSha256:a,directPath:n,fromBytes:0,toBytes:f-1,eventFlow:r,plaintextHash:s});return g.success!==!0?g:m(i,l,d,_,g.value)}async function m(t,n,r,a,i){c.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Using progressiveJpeg decryptAndVerify"])));var l=new Uint8Array(i),d;n.type==="preview"?d=o("WAMediaCrypto").computeMediaKeysForPreview(t):d=o("WAMediaCrypto").computeMediaKeys(t,n.mediaType);var m=await d.then(function(e){var t=e.cipherKey,n=e.hmacKey,i=e.iv;return o("WAMediaCrypto").decryptPartialChunks(t,i,l,n,r,a)}).then(o("WAResultOrError").makeResult).catch(function(e){return c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""])),e),e instanceof o("WAMediaCrypto").HmacValidationError?o("WAResultOrError").makeError("enc-hash-mismatch"):o("WAResultOrError").makeError("decryption-error")});if(!m.success)return m;c.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ProgressiveJpeg download and decrypt successful. Partial: ",""])),r<a.scanLengths.length);var p=o("WAProgressiveJpegAddJPEGTrailingTag").addJPEGTrailingTag(m.value.plaintext);return o("WAResultOrError").makeResult(p)}function p(e){if(e==null)return null;var t=o("WAMediaCrypto").CBC_BLOCK_SIZE-e%o("WAMediaCrypto").CBC_BLOCK_SIZE;return e+t+o("WAMediaCrypto").HMAC_LENGTH}l.downloadProgressiveJpegPlaintext=d}),98);
__d("WALoggerTag",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum").Mirrored(["CryptoManager","MediaPreview","PrekeyGenerateAndUpload","SignedPrekey","SignedPrekeyRotation","OneTimePrekey"]),l=e;i.default=l}),66);
__d("WAProgressiveJpegGetTargetScanLengthForBytes",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){for(var n=0,r=0,o=0;o<e.length&&(r=o+1,n+=e[o],!(n>=t));o++);return r}i.getTargetScanBasedOnByteSize=e}),66);
__d("WADownloadProgressiveJpegPreview",["WADownloadMedia","WADownloadProgressiveJpegPlaintext","WAGlobals","WALoggerTag","WAProgressiveJpegGetTargetScanLengthForBytes","WAResultOrError","WAStartMediaDownloadQplFlow"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WADownloadMedia").mediaDownloadLogger.TAGS([r("WALoggerTag").MediaPreview]),c=3;async function d(t){var n=t.downloadEntry,r=t.handleMediaPreviewBeforeDownload,a=t.handleMediaPreviewDownloadFailed,i=t.hash,l=t.mediaEntry,c=t.progressiveJpegDetails,d=t.protocolMsgId,p=t.serverMediaType,_=t.triggerUIView,f=l.directPath,g=l.fileEncSha256,h=l.mediaKey,y=l.size;if(f==null||g==null||h==null)return o("WAResultOrError").makeError("pjpeg-failed");var C=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:d,downloadEntry:n,isPreview:!0,msgType:null,triggerUIView:_});C.addAnnotations({bool:{isProgressiveJpeg:!0},string:{mediaType:"preview",fullSizeMediaType:l.serverMediaType},int:{mediaEntrySize:l.size}}),u.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Starting progressiveJpeg preview download"]))),C.addPoint("wa_protocol_media_download_start");var b=o("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?c.scanLengths.length-1:c.scanLengths.length,v=Math.min(m(c.scanLengths,y),b);await r(i);var S=await o("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({directPath:f,eventFlow:C,fileEncSha256:g,mediaKey:h,mediaTypeDetails:{mediaType:p,type:"regular"},progressiveJpegDetails:c,plaintextHash:i,targetScan:v,size:y});if(!S.success)return a(i,S.error),C.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:S.error}}),o("WAResultOrError").makeError("pjpeg-failed");var R=S.value;return u.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Finished progressiveJpeg preview download"]))),C.addPoint("wa_protocol_media_download_end"),C.endSuccess(),o("WAResultOrError").makeResult(R)}function m(e,t){var n=o("WAGlobals").getConfig().jpegThumbnailTargetByteSizeKB()*1024,r=o("WAProgressiveJpegGetTargetScanLengthForBytes").getTargetScanBasedOnByteSize(e,n);return(t==null||t===0)&&(r=Math.min(r,e.length-1)),r=Math.max(r,c),r}function p(e){var t=e.abortSignal,n=e.hash,r=e.mediaDownloadFlow,a=e.mediaEntry,i=e.progressiveJpegDetails,l=e.serverMediaType,s=a.directPath,u=a.fileEncSha256,c=a.mediaKey,d=a.size,p=o("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?i.scanLengths.length-1:i.scanLengths.length,_=Math.min(m(i.scanLengths,d),p);return o("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({abortSignal:t,directPath:s,fileEncSha256:u,mediaKey:c,mediaTypeDetails:{mediaType:l,type:"regular"},progressiveJpegDetails:i,plaintextHash:n,targetScan:_,size:d,eventFlow:r})}l.maybeDownloadProgressiveJpegPreview=d,l.getPreviewTargetScan=m,l.maybeDownloadProgressiveJpegPreviewV2=p}),98);
__d("WAFindMostRecentMediaEntry",["WAMediaUtils","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=null;for(var n of e){var r,a,i=n[0],l=n[1],s=o("WAMediaUtils").decodeMediaEntryData(l);(((r=t)==null?void 0:r[1].mediaKeyTimestamp)==null||s.mediaKeyTimestamp!=null&&s.mediaKeyTimestamp>((a=t)==null?void 0:a[1].mediaKeyTimestamp))&&(t=[i,s])}return t!=null?o("WAResultOrError").makeResult(t):o("WAResultOrError").makeError("no-media-entry")}l.findMostRecentMediaEntry=e}),98);
__d("WAIsMediaExpiredError",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){switch(t){case"signature-expired":return!0;case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return!1;default:return!0}};i.isMediaExpiredError=e}),66);
__d("WAGetKaleidoscopeWasm",["WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("33861")),s=function(){return o("WAWasmModuleCache").loadWasmModule(e)};l.getKaleidoscopeWasm=s}),98);
__d("WAMediaUtilsWasmUrl",["bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("237"));l.WAMediaUtilsWasmUrl=e}),98);
__d("WAPreloadWamediaUtilsWasm",["WAMediaUtilsWasmUrl","WAWasmModuleCache"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){o("WAWasmModuleCache").loadWasmModule(o("WAMediaUtilsWasmUrl").WAMediaUtilsWasmUrl)};l.preloadWamediaUtilsWasm=e}),98);
__d("WAPreloadWebpCheckWasm",["WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("6946")),s=function(){o("WAWasmModuleCache").loadWasmModule(e)};l.preloadWebpCheckWasm=s}),98);
__d("WAPrewarmMediaValidate",["WAGetKaleidoscopeWasm","WALogger","WAPreloadWamediaUtilsWasm","WAPreloadWebpCheckWasm","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){if(r("gkx")("3272")){o("WAGetKaleidoscopeWasm").getKaleidoscopeWasm().catch(function(t){var n=r("getErrorSafe")(t);o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["prewarm Kaleidoscop wasm failed with error: ",""])),n.message)});return}if(t==null){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["prewarmMediaValidate: serverMediaType is null"])));return}(t==="sticker"||t==="image")&&o("WAPreloadWebpCheckWasm").preloadWebpCheckWasm(),(t==="video"||t==="audio")&&o("WAPreloadWamediaUtilsWasm").preloadWamediaUtilsWasm()}l.prewarmMediaValidate=u}),98);
__d("WAMediaManagerPrepareMediaDownload",["Promise","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAHashUtils","WAMediaQplHelper","WAPrewarmMediaValidate","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=0;function d(t){var r,a=t.hash,i=t.logger,l=t.mediaDownloadFlow,d=t.mediaEntry,m=d.directPath,p=d.downloadableThumbnail,_=d.mediaKeyTimestamp,f=d.serverMediaType,g=d.size;o("WAPrewarmMediaValidate").prewarmMediaValidate(f);var h=o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(_);i.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start download ",". entry: "," mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),l.downloadEntry,h,g,f);var y=(r=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(d).value)!=null?r:null;return l.addPoint("wa_protocol_media_download_start",{bool:{duplicateDirectPath:(p==null?void 0:p.directPath)===m,hasDownloadableThumbnail:(p==null?void 0:p.directPath)!=null,isProgressiveJpeg:y!=null},string:{mediaKeyTimestampAgeBucket:h,mediaType:f}}),{logDownloadResult:function(t){return c++,l.addAnnotations({int:{concurrentDownloadCount:c}}),t.then(function(e){if(e.success){var t=e.value.validatedResult.validatedPlaintext.byteLength;l.addPoint("wa_protocol_media_download_end",{string:{media_size:o("WAMediaQplHelper").convertIntegerSizeToStringBucket(t)}})}else l.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:e.error}});return e}).catch(function(e){l.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"runtime-error"}});var t=o("WAErrorMessage").maybeGetMessageFromError(e);return i.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""])),t),(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("runtime-error"))}).finally(function(){c--})}}}l.mediaManagerPrepareMediaDownload=d}),98);
__d("WAIsMp4",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112}i.isMp4=e}),66);
__d("WAIsWebP",[],(function(t,n,r,o,a,i){"use strict";function e(e){return!(e.length<12||e[0]!==82||e[1]!==73||e[2]!==70||e[3]!==70||e[8]!==87||e[9]!==69||e[10]!==66||e[11]!==80)}i.isWebP=e}),66);
__d("WAKaleidoscopeLogger",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return r("FBLogger")("wmi").tags(["Kaleidoscope"])};l.ksLogger=e}),98);
__d("WAKaleidoscopeCheck",["WAGetKaleidoscopeWasm","WAKaleidoscopeLogger","WAResultOrError","WASI","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_="input",f="output",g="/"+_,h="/"+f;function y(e){var t,n=e.input,r=e.mediaType,o=e.rawMimeType,a=e.stderr,i=e.stdout;return{args:["kaleidoscope","check","--json-report="+f,"--mimetype-hint="+o,_],fs:(t={},t[g]={path:g,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(n)},t[h]={path:h,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"string",content:""},t),stdout:i,stderr:a,moduleName:"WAKaleidoscopeCheck_CLI"}}function C(t){var n=t.getWasmModule;return async function(a){var t,i,l,_,f=a.input,g=a.mediaType,C=a.rawMimeType,b=o("WASI").createWasi(y({input:f,rawMimeType:C,mediaType:g,stderr:function(n){o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n)},stdout:function(t){o("WAKaleidoscopeLogger").ksLogger().DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)}})),v=b.getImportObject,S=b.start,R=await n(),L=await WebAssembly.instantiate(R,v()),E=S(L),k=E.exitCode,I=E.fs;if(k!==0)return o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed with exit code ",""])),k),o("WAResultOrError").makeError("wasm-runtime-error");var T=(t=I[h])==null?void 0:t.content;if(typeof T!="string")return o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed invalid result type"]))),o("WAResultOrError").makeError("wasm-result-not-json");var D={};try{D=JSON.parse(T)}catch(e){return o("WAKaleidoscopeLogger").ksLogger().catching(r("getErrorSafe")(e)).MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed to parse JSON"]))),o("WAResultOrError").makeError("wasm-invalid-json")}return typeof((i=D)==null?void 0:i.score)!="number"?(o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck score is null"]))),o("WAResultOrError").makeError("wasm-invalid-json")):(o("WAKaleidoscopeLogger").ksLogger().DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck called with rawMimeType: ",", mediaType: ",""])),C,g),o("WAResultOrError").makeResult({mimetype:((l=D)==null?void 0:l.mimetype)||"application/octet-stream",extension:((_=D)==null?void 0:_.extension)||null,score:D.score}))}}var b=C({getWasmModule:o("WAGetKaleidoscopeWasm").getKaleidoscopeWasm});l.kaleidoscopeCheck=b}),98);
__d("WAMp4Check",["WAMediaUtilsWasmUrl","WAResultOrError","WASI","WAWasmModuleCache"],(function(t,n,r,o,a,i,l){"use strict";var e="input",s="output",u="/"+e,c="/"+s;function d(t){var n,r=t.input,o=t.stderr,a=t.stdout;return{args:["wamediautil","mp4check","--error-tolerance=2","--json-report="+s,e],fs:(n={},n[u]={path:u,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(r)},n[c]={path:c,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"string",content:""},n),stdout:a,stderr:o,moduleName:"WAMp4Check_CLI"}}function m(e){var t=e.getWasmModule,n=e.logError,r=e.logMessage;return async function(a){var e,i,l,s,u,m,p,_,f,g,h,y,C,b=a.input,v=o("WASI").createWasi(d({input:b,stderr:n,stdout:r})),S=v.getImportObject,R=v.start,L=await t(),E=await WebAssembly.instantiate(L,S()),k=R(E),I=k.exitCode,T=k.fs;if(I!==0)return n("mp4Check failed with exit code "+I),o("WAResultOrError").makeError("invalid-media");var D=(e=T[c])==null?void 0:e.content;if(typeof D!="string")return n("mp4check failed invalid result type"),o("WAResultOrError").makeError("runtime-error");var x=(i=JSON.parse(D))!=null?i:{};return o("WAResultOrError").makeResult({videoStreamReport:(x==null?void 0:x.video_stream_report)==null?null:{streamType:(l=x.video_stream_report)==null?void 0:l.stream_type,calculatedFps:(s=x.video_stream_report)==null?void 0:s.calculated_fps,nominalFps:(u=x.video_stream_report)==null?void 0:u.nominal_fps,videoWidth:(m=x.video_stream_report)==null?void 0:m.video_width,videoHeight:(p=x.video_stream_report)==null?void 0:p.video_height,duration:(_=x.video_stream_report)==null?void 0:_.duration,avgBitsPerSecond:(f=x.video_stream_report)==null?void 0:f.avg_bits_per_second},audioStreamReport:(x==null?void 0:x.audio_stream_report)==null?null:{streamType:(g=x.audio_stream_report)==null?void 0:g.stream_type,samplingRate:(h=x.audio_stream_report)==null?void 0:h.sampling_rate,numberOfChannels:(y=x.audio_stream_report)==null?void 0:y.number_of_channels,avgBitsPerSecond:(C=x.audio_stream_report)==null?void 0:C.avg_bits_per_second}})}}var p=function(){return o("WAWasmModuleCache").loadWasmModule(o("WAMediaUtilsWasmUrl").WAMediaUtilsWasmUrl)};l.createMp4Check=m,l.getMp4CheckWasm=p}),98);
__d("WAParseWav",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=new DataView(e);return e.byteLength<44||t.getUint32(0)!==1380533830||t.getUint32(8)!==1463899717?null:e}function l(e){var t=new DataView(e),n=t.getUint16(22,!0),r=t.getUint32(24,!0);return{numChannels:n,sampleRate:r}}i.validateWav=e,i.parseWav=l}),66);
__d("WAWebPCheck",["WAResultOrError","WASI","WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e="input",s="/"+e;function u(t){var n,r=t.input,o=t.stderr,a=t.stdout;return{args:["webpcheck",e],fs:(n={},n[s]={path:s,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(r)},n),stdout:a,stderr:o,moduleName:"WAWebPCheck_CLI"}}function c(e){var t=e.getWasmModule,n=e.logError,r=e.logMessage;return async function(a){var e=a.input,i=o("WASI").createWasi(u({input:e,stderr:n,stdout:r})),l=i.getImportObject,s=i.start,c=await t(),d=await WebAssembly.instantiate(c,l()),m=s(d),p=m.exitCode;return p!==0?(n("WebPCheck failed with exit code "+p),o("WAResultOrError").makeError("invalid-media")):o("WAResultOrError").makeResult()}}var d=r("bx").getURL(r("bx")("6946")),m=function(){return o("WAWasmModuleCache").loadWasmModule(d)};l.createWebPCheck=c,l.getWebpCheckWasm=m}),98);
__d("WAValidateMedia",["FBLogger","WAIsMp4","WAIsOgg","WAIsWebP","WAKaleidoscopeCheck","WAMp4Check","WAParseWav","WAResultOrError","WAWebPCheck","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=function(){return r("FBLogger")("wmi").tags(["WAValidateMedia"])};function m(t,n){return n.addPoint("media_validation_start"),(r("gkx")("3272")?p(t):_(t)).then(function(e){return e.success?n.addPoint("media_validation_end",{bool:{is_validation_setup_failed:e.value.validationSetupFailed,is_validation_skipped:e.value.skipValidation},string:{validated_mime_type:e.value.mimeType}}):n.addPoint("media_validation_fail",{string:{validationError:e.error}}),e}).catch(function(a){var i=r("getErrorSafe")(a);return d().catching(i).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["validateMedia threw an exception: ",""])),i.message),n.addPoint("media_validation_fail",{string:{validationError:i.message}}),o("WAResultOrError").makeResult({skipValidation:!0,mimeType:null,validatedPlaintext:t,validationSetupFailed:!0})})}async function p(e){var t=await o("WAKaleidoscopeCheck").kaleidoscopeCheck({input:e,rawMimeType:"application/octet-stream",mediaType:"unknown"});if(!t.success)return d().MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed with error: ",""])),t.error),o("WAResultOrError").makeError("runtime-error");var n=t.value,r=n.mimetype,a=n.score;return a>=80?o("WAResultOrError").makeError("invalid-media"):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:r,validatedPlaintext:e,validationSetupFailed:!1,isKaleidoscopeCheck:!0})}function _(e){var t=new Uint8Array(e);if(o("WAIsWebP").isWebP(t))return h(e);if(o("WAIsMp4").isMp4(t))return y(e);if(o("WAIsOgg").isOgg(t))return Promise.resolve(o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/ogg",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:null}));var n=o("WAParseWav").validateWav(e);return n!=null?Promise.resolve(C(n)):Promise.resolve(o("WAResultOrError").makeResult({mimeType:null,skipValidation:!0,validatedPlaintext:e,validationSetupFailed:!1}))}var f=function(t){t!==""&&d().WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)},g=function(t){t!==""&&d().DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)};async function h(e){var t=o("WAWebPCheck").createWebPCheck({getWasmModule:o("WAWebPCheck").getWebpCheckWasm,logError:f,logMessage:g}),n=await t({input:e});return n.success?o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"image/webp",validatedPlaintext:e,validationSetupFailed:!1}):n}async function y(e){var t=o("WAMp4Check").createMp4Check({getWasmModule:o("WAMp4Check").getMp4CheckWasm,logError:f,logMessage:g}),n=await t({input:e});if(!n.success)return o("WAResultOrError").makeError(n.error);var r=n.value,a=r.audioStreamReport,i=r.videoStreamReport;return i==null?a==null?o("WAResultOrError").makeError("invalid-media"):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/mp4",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:a}):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"video/mp4",validatedPlaintext:e,validationSetupFailed:!1,videoStreamReport:i,audioStreamReport:a})}function C(e){var t=o("WAParseWav").parseWav(e),n=t.numChannels,r=t.sampleRate;return o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/wav",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:{streamType:"LPCM",samplingRate:r,numberOfChannels:n}})}l.validateMedia=m}),98);
__d("WADownloadFullSizeOnlyTask",["EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWEBSwitch","WADownloadMedia","WAFindMostRecentMediaEntry","WAIsMediaExpiredError","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAResultOrError","WAValidateMedia","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;async function c(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.logger,i=e.mediaDownloadFlow;i.addPoint("get_media_entries_start");var l=await n.getMediaEntries(r);if(!l.success)return i.addPoint("get_media_entries_fail"),{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var s=l.value;i.addPoint("get_media_entries_end");var u=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(s);if(!u.success)return{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var c=u.value,m=c[0],p=c[1],_=o("WAMediaUtils").validateDecodedMediaEntryForDownload(p);if(!_.success)return{fullsizePromise:Promise.resolve(_)};var f=_.value,g=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:a,mediaDownloadFlow:i,mediaEntry:f}),h=g.logDownloadResult,y=d({abortSignal:t,dbCallbacks:n,logger:a,mediaDownloadFlow:i,mediaEntries:s,msgIdOfRecentMediaEntry:m,recentMediaEntry:f}).then(async function(e){if(!e.success)return e;var t=await o("WAValidateMedia").validateMedia(e.value.plaintext,i);return t.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:[m,f],serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.mimeType,validatedResult:t.value}):t});return{fullsizePromise:h(y)}}async function d(t){var n=t.abortSignal,a=t.dbCallbacks,i=t.logger,l=t.mediaDownloadFlow,c=t.mediaEntries,d=t.msgIdOfRecentMediaEntry,m=t.recentMediaEntry,p=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");p&&l.addPoint("forcing_eb_download");var _=p?o("WAResultOrError").makeError("signature-expired"):await o("WADownloadMedia").downloadFullMediaOnly({abortSignal:n,downloadMediaMetric:l,mediaEntry:m});if(_.success||!o("WAIsMediaExpiredError").isMediaExpiredError(_.error)||!r("MAWEBSwitch").isEnabled())return _;var f=await a.getProtocolMsgIdAndSortOrderMs(d);if(f==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var g=f.protocolMsgId,h=f.sortOrderMs,y=m,C=d,b=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(y.serverMediaType);if(b==null||y.objectId==null)return i.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and can not restore: ",""])),_.error),_;var v=await o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:y.objectId,logger:i,mediaDownloadFlow:l,mediaKey:y.mediaKey,mediaType:b,msgId:C,protocolMsgId:g,sortOrderMs:h});if(!v.success)return i.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and restore failed: ",""])),v.error),v;var S=await o("WADownloadMedia").downloadFullMediaOnly({abortSignal:n,downloadMediaMetric:babelHelpers.extends({},l,{addPoint:function(t,n){l.addPoint("second_"+t,n)}}),mediaEntry:babelHelpers.extends({},y,{directPath:v.value})});return S.success?o("WAResultOrError").makeResult(S.value):(i.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media after restore CDN URL: ",""])),S.error),S)}l.startDownloadFullSizeTask=c,l.downloadOrRestoreFullSize=d}),98);
__d("WADownloadMediaPreviewV2",["WADownloadMedia","WADownloadProgressiveJpegPreview","WAMediaCrypto","WAMediaUtils","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){var n=t.abortSignal,r=t.hash,a=t.logger,i=t.mediaDownloadFlow,l=t.mediaEntry,s=t.progressiveJpegDetails,u=l.serverMediaType,c=o("WAMediaUtils").getMimeTypeFromServerMediaType(u),d=s==null?o("WAResultOrError").makeError("jpeg-stream-not-supported"):await o("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreviewV2({abortSignal:n,hash:r,serverMediaType:u,mediaEntry:l,progressiveJpegDetails:s,mediaDownloadFlow:i});if(d.success===!0)return o("WAResultOrError").makeResult({plaintext:d.value,mimeType:c,serverMediaType:u});i.addPoint("fallback_to_downloadable_thumbnail");var m=l.downloadableThumbnail;if((m==null?void 0:m.directPath)==null)return o("WAResultOrError").makeError("media-not-found");var p=o("WAMediaUtils").validateDownloadableThumbnailForDownload(m);if(p.success===!1)return a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["preview mediaEntry is incomplete: ",""])),p.error),o("WAResultOrError").makeError(p.error[0]);var _=p.value,f=_.directPath,g=_.fileEncSha256,h=_.fileSha256,y=_.mediaKey,C=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(u);if(C==null)return o("WAResultOrError").makeError("request-error");var b=await o("WADownloadMedia").downloadMediaImpl({abortSignal:n,downloadFlow:i,mediaTypeDetails:{messageType:C,type:"preview"},directPath:f,fileEncSha256:g,fileSha256:h,mediaKey:y});return b.success===!1?b:o("WAResultOrError").makeResult({plaintext:b.value,mimeType:c,serverMediaType:u})}l.downloadMediaPreview=s}),98);
__d("WAIsPreviewSupported",["$InternalEnum","WAProgressiveJpegGetPJpegDetails"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["NO","YES"]),s=n("$InternalEnum").Mirrored(["NO","YES","DuplicatedWithFullSize"]);function u(t){var n=t.serverMediaType;switch(n){case"image":{var r,a,i=(r=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(t).value)!=null?r:null,l=i!=null?e.YES:e.NO;if(((a=t.downloadableThumbnail)==null?void 0:a.directPath)==null)return[l,s.NO];t.downloadableThumbnail.directPath;var u=t.downloadableThumbnail.directPath===t.directPath?s.DuplicatedWithFullSize:s.YES;return[l,u]}case"video":{var c;if(((c=t.downloadableThumbnail)==null?void 0:c.directPath)==null)return[e.NO,s.NO];t.downloadableThumbnail.directPath;var d=t.downloadableThumbnail.directPath===t.directPath?s.NO:s.YES;return[e.NO,d]}case"sticker":case"ptt":case"audio":case"document":case"gif":case"ppic":case"md-app-state":case"md-msg-hist":case"kyc-id":case"template":case"thumbnail-image":case"thumbnail-video":case"thumbnail-gif":case"thumbnail-document":case"thumbnail-link":case"novi-video":case"novi-image":case"payment-bg-image":case"xma-image":case"biz-cover-photo":case"preview":case"newsletter-audio":case"newsletter-document":case"newsletter-image":case"newsletter-gif":case"newsletter-music-artwork":case"newsletter-ptt":case"newsletter-sticker":case"newsletter-sticker-pack":case"newsletter-thumbnail-link":case"newsletter-video":case"newsletter-ptv":case"sticker-pack":case"thumbnail-sticker-pack":case"music-artwork":case"group-history":case"ads-image":case"ads-video":case"ptv":return[e.NO,s.NO];default:return[e.NO,s.NO]}}l.PjpegPreviewSupport=e,l.DownloadablePreviewSupport=s,l.checkPreviewSupport=u}),98);
__d("WADownloadPreviewOnlyTask",["EncryptedBackupsResignCdnUrl","MAWEBSwitch","WADownloadMediaPreviewV2","WAFindMostRecentMediaEntry","WAIsMediaExpiredError","WAIsPreviewSupported","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAValidateMedia","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s;async function u(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.logger,i=e.mediaDownloadFlow;i.addPoint("get_media_entries_start");var l=await n.getMediaEntries(r);if(!l.success)return i.addPoint("get_media_entries_fail"),{previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};i.addPoint("get_media_entries_end");var s=l.value,u=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(s);if(!u.success)return{previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var d=u.value,m=d[0],p=d[1],_=o("WAMediaUtils").validateDecodedMediaEntryForDownload(p);if(!_.success)return{previewPromise:Promise.resolve(_)};var f=_.value,g=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:a,mediaDownloadFlow:i,mediaEntry:f}),h=g.logDownloadResult,y=c({abortSignal:t,dbCallbacks:n,fullSizePlaintextHash:r,logger:a,mediaDownloadFlow:i,mediaEntries:l.value,msgIdOfRecentMediaEntry:m,recentMediaEntry:f}).then(async function(e){if(!e.success)return e;var t=await o("WAValidateMedia").validateMedia(e.value.plaintext,i);return t.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:[m,f],serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.mimeType,validatedResult:t.value}):t});return{previewPromise:h(y)}}async function c(t){var n,a=t.abortSignal,i=t.dbCallbacks,l=t.fullSizePlaintextHash,u=t.logger,c=t.mediaDownloadFlow,d=t.mediaEntries,m=t.msgIdOfRecentMediaEntry,p=t.recentMediaEntry,_=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");_&&c.addPoint("forcing_eb_download");var f=o("WAIsPreviewSupported").checkPreviewSupport(p),g=f[0],h=f[1];if(g===o("WAIsPreviewSupported").PjpegPreviewSupport.NO&&h===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return o("WAResultOrError").makeError("preview-not-supported");var y=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(p),C=y.success===!0?y.value:null,b={abortSignal:a,hash:l,logger:u,mediaDownloadFlow:c,progressiveJpegDetails:C};c.addPoint("download_preview_start",{string:{preview_downloadable_support:h,preview_pjpeg_support:g}});var v=_?o("WAResultOrError").makeError("signature-expired"):await o("WADownloadMediaPreviewV2").downloadMediaPreview(babelHelpers.extends({},b,{mediaEntry:p}));if(v.success)return c.addPoint("download_preview_end"),o("WAResultOrError").makeResult({mimeType:v.value.mimeType,plaintext:v.value.plaintext,serverMediaType:v.value.serverMediaType});if(c.addPoint("download_preview_fail"),!o("WAIsMediaExpiredError").isMediaExpiredError(v.error)||!r("MAWEBSwitch").isEnabled()||r("gkx")("1327")!==!0)return v;var S=await i.getProtocolMsgIdAndSortOrderMs(m);if(S==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var R=S.protocolMsgId,L=S.sortOrderMs,E=p,k=m,I=h===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO||((n=E.downloadableThumbnail)==null?void 0:n.objectId)==null?null:o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:E.downloadableThumbnail.objectId,logger:u,mediaDownloadFlow:c,mediaKey:E.mediaKey,mediaType:"preview",msgId:k,protocolMsgId:R,sortOrderMs:L}),T=g===o("WAIsPreviewSupported").PjpegPreviewSupport.NO||E.objectId==null?null:o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:E.objectId,logger:u,mediaDownloadFlow:c,mediaKey:E.mediaKey,mediaType:"image",msgId:k,protocolMsgId:R,sortOrderMs:L}),D=await Promise.all([I,T]),x=D[0],$=D[1];if((x==null?void 0:x.success)!==!0&&($==null?void 0:$.success)!==!0){var P;return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and restore failed. downloadableThumbnail error: ",". pjpegPreview error: ",""])),x==null?void 0:x.error,$==null?void 0:$.error),(P=$!=null?$:x)!=null?P:o("WAResultOrError").makeError("preview-not-supported")}c.addPoint("second_download_preview_start");var N=await o("WADownloadMediaPreviewV2").downloadMediaPreview(babelHelpers.extends({},b,{mediaDownloadFlow:babelHelpers.extends({},c,{addPoint:function(t,n){c.addPoint("second_"+t,n)}}),mediaEntry:babelHelpers.extends({},E,{directPath:($==null?void 0:$.success)===!0?$.value:E.directPath,downloadableThumbnail:E.downloadableThumbnail==null?null:babelHelpers.extends({},E.downloadableThumbnail,{directPath:(x==null?void 0:x.success)===!0?x.value:E.downloadableThumbnail.directPath})})}));return N.success?(c.addPoint("second_download_preview_end"),o("WAResultOrError").makeResult({mimeType:N.value.mimeType,plaintext:N.value.plaintext,serverMediaType:N.value.serverMediaType})):(u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media after restore CDN URL: ",""])),N.error),c.addPoint("second_download_preview_fail"),N)}l.startDownloadPreviewTask=u,l.downloadOrRestorePreviewOnly=c}),98);
__d("WADownloadProgressiveJpegUsingMediaStreaming",["WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAMediaUtils","WAProgressiveJpegAddJPEGTrailingTag","WAResolvable","WAResultOrError","WAStreamAsyncIterator","WATypedArraysConcat"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;async function f(t){var n=t.abortSignal,r=t.directPath,a=t.downloadFlow,i=t.fileEncSha256,l=t.fileSha256,m=t.logger,p=t.mediaKey,_=t.progressiveJpegDetails,f=t.serverMediaType,h=m.TAGS(["MediaStreaming"]);h.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg."]))),a.addPoint("create_pjpeg_stream_start");var y=await o("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({abortSignal:n,directPath:r,eventFlow:a,fileEncSha256:i,mediaKey:p,progressiveJpegDetails:_,serverMediaType:f}).catch(function(e){return h.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["create DownloadAndDecryptPJpegStream unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});if(y.success===!1)return a.addPoint("create_pjpeg_stream_fail"),y;a.addPoint("create_pjpeg_stream_end");var C=new(o("WAResolvable")).Resolvable,b=!1,v=g({downloadFlow:a,fileSha256:l,mediaStreamingLogger:h,previewResolvable:C,progressiveJpegDetails:_,progressiveJpegDownloadStream:y.value,serverMediaType:f}).then(function(e){return b=!0,h.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handleProgressiveJpegDownloadStream completed"]))),e}).catch(function(e){return b=!0,h.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["handleProgressiveJpegDownloadStream unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),C.reject(e),o("WAResultOrError").makeError("runtime-error")}),S=o("WAMediaUtils").getMimeTypeFromServerMediaType(f);function R(e){return e.success===!1?e:o("WAResultOrError").makeResult({mimeType:S,plaintext:e.value,serverMediaType:f})}var L=v.then(R),E=C.promise.then(R),k=await C.promise;if(k.success===!0&&b===!0&&h.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["fullsizeResolvable is settled before previewResolvable"]))),k.success===!0)return o("WAResultOrError").makeResult({fullsizePromise:L,previewPromise:E});var I=await v;return k.success,I.success===!0?o("WAResultOrError").makeResult({fullsizePromise:L,previewPromise:E}):(I.success,I)}async function g(e){var t=e.downloadFlow,n=e.fileSha256,r=e.mediaStreamingLogger,a=e.previewResolvable,i=e.progressiveJpegDetails,l=e.progressiveJpegDownloadStream;t.addPoint("download_pjpeg_preview_start");var s=0,u=o("WADownloadProgressiveJpegPreview").getPreviewTargetScan(i.scanLengths)-1;try{var c=[],d=!1,f=!1,g;try{for(var h=babelHelpers.asyncIterator(o("WAStreamAsyncIterator").streamAsyncIterator(l)),y;d=!(y=await h.next()).done;d=!1){var C=y.value;{if(C==null)continue;if(c.push(C),s===u){t.addPoint("media_streaming_preview_processed");var b=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(c,[o("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));a.resolve(o("WAResultOrError").makeResult(b)),t.addPoint("download_pjpeg_preview_end")}s++}}}catch(e){f=!0,g=e}finally{try{d&&h.return!=null&&await h.return()}finally{if(f)throw g}}a.isSettled===!1&&(r.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["pjpeg stream ended before reaching previewTargetScanIndex"]))),a.resolve(o("WAResultOrError").makeError("runtime-error")),t.addPoint("download_pjpeg_preview_fail"));var v=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(c))),S=await o("WACryptoSha256").sha256(v);return o("WACryptoUtils").arrayBuffersEqual(n,S)?o("WAResultOrError").makeResult(v):(r.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch."]))),o("WAResultOrError").makeError("hash-mismatch"))}catch(e){return r.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""])),e),a.isSettled===!1&&(a.resolve(o("WAResultOrError").makeError("runtime-error")),t.addPoint("download_pjpeg_preview_fail")),o("WAResultOrError").makeError("runtime-error")}}l.downloadProgresiveJpegUsingMediaStreaming=f}),98);
__d("WADownloadFullSizeAndPreviewTask",["EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWEBSwitch","UserAgent","WADownloadFullSizeOnlyTask","WADownloadPreviewOnlyTask","WADownloadProgressiveJpegUsingMediaStreaming","WAErrorMessage","WAFindMostRecentMediaEntry","WAHashUtils","WAIsMediaExpiredError","WAIsPreviewSupported","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAStartMediaDownloadQplFlow","WAValidateMedia","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h;async function y(t){var n=t.abortSignal,r=t.dbCallbacks,a=t.fullSizePlaintextHash,i=t.logger,l=t.mediaDownloadFlow;l.addPoint("get_media_entries_start");var c=await r.getMediaEntries(a);if(!c.success)return l.addPoint("get_media_entries_fail"),{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry")),previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};l.addPoint("get_media_entries_end");var d=c.value,m=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(d);if(!m.success)return{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry")),previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var p=m.value,_=p[0],f=p[1],g=o("WAMediaUtils").validateDecodedMediaEntryForDownload(f);return g.success?b({abortSignal:n,dbCallbacks:r,fullSizePlaintextHash:a,logger:i,mediaDownloadFlow:l,mediaEntries:d,msgIdOfRecentMediaEntry:_,recentMediaEntry:g.value}).then(function(e){return i.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["outter promise: ",""])),e.success===!0?"success":e.error),e.success?e.value:(i.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["outter promise failed: ",""])),e.error),{fullsizePromise:Promise.resolve(e),previewPromise:Promise.resolve(e)})}):(i.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaEntry for download: ",""])),g.error),{fullsizePromise:Promise.resolve(g),previewPromise:Promise.resolve(g)})}async function C(e,t,n){var r=await e;if(!r.success)return Promise.resolve(r);var a=await o("WAValidateMedia").validateMedia(r.value.plaintext,n);return a.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:t,serverMediaType:r.value.serverMediaType,unvalidatedMimeType:r.value.mimeType,validatedResult:a.value}):a}async function b(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.logger,i=e.mediaDownloadFlow,l=e.mediaEntries,s=e.msgIdOfRecentMediaEntry,u=e.recentMediaEntry,d=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:a,mediaDownloadFlow:i,mediaEntry:u}),m=d.logDownloadResult,p={abortSignal:t,dbCallbacks:n,logger:a,mediaDownloadFlow:i,mediaEntries:l,msgIdOfRecentMediaEntry:s,recentMediaEntry:u},_=await v(babelHelpers.extends({},p,{fullSizePlaintextHash:r}));if(_.success){var f=_.value,g=f.fullsizePromise,h=f.previewPromise,y=g.then(function(e){return e.success?e:(i.addPoint("fallback_to_non_streaming_download",{string:{streaming_fallback_reason:e.error}}),o("WADownloadFullSizeOnlyTask").downloadOrRestoreFullSize(p))}),b=[s,u];return o("WAResultOrError").makeResult({fullsizePromise:m(C(y,b,i)),previewPromise:C(h,b,i)})}var R=L(_.error);if(!R.shouldFallback)return o("WAResultOrError").makeError(R.error);i.addPoint("fallback_to_non_streaming_download",{string:{streaming_fallback_reason:R.error}}),a.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["fallback to non-streaming download"])));var E=C(o("WADownloadFullSizeOnlyTask").downloadOrRestoreFullSize(p),[s,u],i),k=S(babelHelpers.extends({},p,{fullSizePlaintextHash:r,fullsizePromise:E}));return o("WAResultOrError").makeResult({fullsizePromise:m(E),previewPromise:k})}async function v(e){var t,n=e.abortSignal,a=e.dbCallbacks,i=e.logger,l=e.mediaDownloadFlow,s=e.mediaEntries,u=e.msgIdOfRecentMediaEntry,c=e.recentMediaEntry,g=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");g&&l.addPoint("forcing_eb_download");var h=c.directPath,y=c.fileEncSha256,C=c.fileSha256,b=c.mediaKey,v=c.serverMediaType,S=(t=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(c).value)!=null?t:null;if(S==null||c.serverMediaType!=="image"||!o("WAMediaUtils").isTransformStreamSupported()||r("UserAgent").isBrowser("Safari < 18")||r("UserAgent").isBrowser("Mobile Safari < 18"))return c.serverMediaType==="image"&&S==null&&(i.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["skip pjpeg streaming because pjpeg metadata is null"]))),i.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["media entry: ",""])),c)),o("WAResultOrError").makeError("jpeg-stream-not-supported");l.addPoint("media_streaming_start");var L=g?o("WAResultOrError").makeError("signature-expired"):await o("WADownloadProgressiveJpegUsingMediaStreaming").downloadProgresiveJpegUsingMediaStreaming({abortSignal:n,directPath:h,downloadFlow:l,fileEncSha256:y,fileSha256:C,logger:i,mediaKey:b,progressiveJpegDetails:S,serverMediaType:v}).catch(function(e){return i.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["downloadProgresiveJpegUsingMediaStreaming unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});if(L.success)return l.addPoint("media_streaming_end"),L;if(!o("WAIsMediaExpiredError").isMediaExpiredError(L.error)||!r("MAWEBSwitch").isEnabled())return R(l,L),L;var E=await a.getProtocolMsgIdAndSortOrderMs(u);if(E==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var k=E.protocolMsgId,I=E.sortOrderMs,T=c,D=u,x=T.fileEncSha256,$=T.fileSha256,P=T.mediaKey,N=T.serverMediaType,M=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(N);if(M==null||T.objectId==null)return i.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and can not restore: ",""])),L.error),L;var w=await o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:T.objectId,logger:i,mediaDownloadFlow:l,mediaKey:T.mediaKey,mediaType:M,msgId:D,protocolMsgId:k,sortOrderMs:I});if(!w.success)return w;l.addPoint("second_media_streaming_start");var A=await o("WADownloadProgressiveJpegUsingMediaStreaming").downloadProgresiveJpegUsingMediaStreaming({abortSignal:n,directPath:w.value,downloadFlow:babelHelpers.extends({},l,{addPoint:function(t,n){l.addPoint("second_"+t,n)}}),fileEncSha256:x,fileSha256:$,logger:i,mediaKey:P,progressiveJpegDetails:S,serverMediaType:N}).catch(function(e){return i.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["downloadProgresiveJpegUsingMediaStreaming unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});return A.success?(l.addPoint("second_media_streaming_end"),A):(R(l,A),A)}function S(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.fullsizePromise,i=e.logger,l=e.mediaDownloadFlow,s=e.mediaEntries,u=e.msgIdOfRecentMediaEntry,c=e.recentMediaEntry,d=c.serverMediaType,m=o("WAIsPreviewSupported").checkPreviewSupport(c),p=m[0],_=m[1];if(p===o("WAIsPreviewSupported").PjpegPreviewSupport.NO&&_===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return i.LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["preview not supported"]))),Promise.resolve(o("WAResultOrError").makeError("preview-not-supported"));if(_===o("WAIsPreviewSupported").DownloadablePreviewSupport.DuplicatedWithFullSize)return i.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["preview duplicated with fullsize"]))),a;var f=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:l.downloadEntry,isPreview:!0,msgType:null,protocolMsgId:null,triggerUIView:null}),y=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:i,mediaDownloadFlow:f,mediaEntry:c}),b=y.logDownloadResult;f.addAnnotations({bool:{isMediaManager:!0},string:{downloadKind:"fullsizeAndPreview",fullSizeMediaType:d,mediaType:"preview",sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var v=o("WADownloadPreviewOnlyTask").downloadOrRestorePreviewOnly({abortSignal:t,dbCallbacks:n,fullSizePlaintextHash:r,logger:i,mediaDownloadFlow:f,mediaEntries:s,msgIdOfRecentMediaEntry:u,recentMediaEntry:c});return b(C(v,[u,c],f)).then(function(e){return e.success?f.endSuccess():f.endFail(e.error,{string:{failReason:e.error}}),e}).catch(function(e){return f.endFail("runtime-error",{string:{failReason:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WAResultOrError").makeError("runtime-error")})}function R(e,t){e.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:o("WAErrorMessage").maybeGetMessageFromError(t.error)}})}function L(e){switch(e){case"runtime-error":case"jpeg-stream-not-supported":return{error:e,shouldFallback:!0};case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return{error:e,shouldFallback:!0};case"missing-media-entry":case"missing-media-entry-for-restore":case"missing-sort-order-ms-for-restore":case"preview-not-supported":return{error:e,shouldFallback:!1};case"derive-primary-key-secret-error":case"derive-access-token-secret-error":case"direct-path-undefined":case"direct-path-corrupted":case"direct-path-empty":case"create-payload-failed":case"resign-cdn-url-request-error":case"resign-cdn-url-runtime-error":case"resign-cdn-url-timeout":case"resign-cdn-url-gql-error":return{error:e,shouldFallback:!1};case"invalid-media":return{error:e,shouldFallback:!1};case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":return{error:e,shouldFallback:!0};case"access-expired":case"disconnected":case"backoff":case"body-network-error":case"http-fetch-exception":case"http-fetch-aborted":case"no-host":case"server-timeout":case"unspecified-http-error":case"media-not-found":case"download-throttled":case"request-error":case"max-attempts-exceeded":case"signature-expired":case"media-entry-invalid":return{error:e,shouldFallback:!1};case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":return{error:e,shouldFallback:!1}}}l.startDownloadFullSizeAndPreviewTask=y}),98);
__d("WAMediaManagerLogger",["WAHashUtils","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WATagsLogger").TAGS(["MediaManager"]);function s(t){var n=t.downloadKind,r=t.fullSizePlaintextHash,a=e.TAGS(["download","hash:"+o("WAHashUtils").sanitisePlaintextHash(r),n]);return a}function u(t){var n=t.plaintextHash,r=t.uploadKind,a=e.TAGS(["upload","hash:"+o("WAHashUtils").sanitisePlaintextHash(n),r]);return a}l.baseLogger=e,l.createDownloadLogger=s,l.createUploadLogger=u}),98);
__d("WAMediaManagerTypes",["WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.success?o("WAResultOrError").makeResult({serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.unvalidatedMimeType,validatedResult:e.value.validatedResult}):e}l.transformInternalMediaDownloadResult=e}),98);
__d("WAMediaManagerWorkerScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("MediaManager",{concurrency:16,maxTaskLimit:32,maxThrottleMs:3e4,timeoutMs:6e4})),e}l.mediaManagerWorkerScheduler=s}),98);
__d("WACreateRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t){var n=await o("WAGetMediaRoute").getMediaRoute({operation:"upload",serverMediaType:e},t);if(!n.success)return n;var r=n.value,a=r.authToken,i=r.fallbackHost,l=r.selectedHost,s=new(o("WAMediaOperationsRetrier")).MediaOperationsRetrier("upload",{host:{domain:l.domain,class:l.class},fallbackHost:i&&{domain:i.domain,class:i.class},authToken:a,timeElapsed:null},o("WAComms").waitForConnection);return o("WAResultOrError").makeResult(s)}l.createUploadRetrier=e}),98);
__d("WAHttpRegularUploadMedia",["WADirectPath","WALogger","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;async function c(t,n){var a;try{a=await fetch(t,{method:"POST",mode:"cors",cache:"no-store",headers:{"Content-Type":"text/plain"},body:new Blob([n])})}catch(t){throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to initiate fetch ",""])),t),t}var i=a,l=i.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""])),l),l){case 200:return a.json().then(function(e){if(!Object.prototype.hasOwnProperty.call(e,"direct_path"))throw r("err")("direct_path not available in wa upload http response");if(typeof e.direct_path!="string")throw r("err")('directPath: "'+e.direct_path+'" is not a string');if(e.object_id&&typeof e.object_id!="string")throw r("err")('objectId: "'+e.object_id+'" is not a string');if(e.handle&&typeof e.handle!="string")throw r("err")('handle: "'+e.handle+'" is not a string');var t={directPath:o("WADirectPath").unsafeCastToDirectPath(e.direct_path),objectId:e.object_id,handle:e.handle};return o("WAResultOrError").makeResult(t)}).catch(function(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to parse request body ",""])),e),o("WAResultOrError").makeError("body-network-error")});case 408:return o("WAResultOrError").makeError("server-timeout");case 413:return o("WAResultOrError").makeError("payload-too-large");case 415:return o("WAResultOrError").makeError("invalid-media");case 429:case 507:return o("WAResultOrError").makeError("upload-throttled");default:return l>=400&&l<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}l.httpRegularUploadMedia=c}),98);
__d("WAHttpResumeCheck",["WADirectPath","WALogger","WAMediaUtils","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;async function p(t){var n;try{n=await fetch(t,{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"text/plain"}})}catch(t){throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to initiate fetch ",""])),t),t}var r=n,a=r.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: response status ",""])),a),a){case 200:return n.json().then(function(e){var t=e.direct_path,n=e.object_id,r=e.resume;if(r==="complete")return t==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: direct_path is missing"]))),o("WAResultOrError").makeResult({type:"media-not-found"})):n==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: object_id is missing"]))),o("WAResultOrError").makeResult({type:"media-not-found"})):o("WAResultOrError").makeResult({type:"media-found",directPath:o("WADirectPath").unsafeCastToDirectPath(t),objectId:o("WAMediaUtils").stringToDeliveryObjectId(n)});var a=parseInt(r,10);return a===0?o("WAResultOrError").makeResult({type:"media-not-found"}):Number.isNaN(a)?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: resume is NaN: ",""])),r),o("WAResultOrError").makeResult({type:"media-not-found"})):o("WAResultOrError").makeResult({type:"media-partial-found",resumeFromBytes:a})}).catch(function(e){return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to parse request body ",""])),e),o("WAResultOrError").makeError("body-network-error")});case 404:return o("WAResultOrError").makeResult({type:"media-not-found"});case 408:return o("WAResultOrError").makeError("server-timeout");case 429:case 507:return o("WAResultOrError").makeError("upload-throttled");default:return a>=400&&a<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}l.httpResumeCheck=p}),98);
__d("WAEncryptAndUploadPlaintext",["WABase64","WAErrorMessage","WAGlobals","WAHttpRegularUploadMedia","WAHttpResumeCheck","WALogger","WAMediaCrypto","WAMediaUrl","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;async function f(t){var n=t.fromOffset,r=n===void 0?0:n,a=t.mediaKey,i=t.mediaKeyTimestamp,l=t.mediaUploadFlow,f=t.plaintext,g=t.plaintextHash,h=t.serverMediaType,y=t.uploadRetrier,C=t.uploadToken;l.addPoint("encrypt_and_upload_plaintext_start"),l.addPoint("compute_media_keys_start");var b=h==="preview"?await o("WAMediaCrypto").computeMediaKeysForPreview(a):await o("WAMediaCrypto").computeMediaKeys(a,h),v=b.cipherKey,S=b.hmacKey,R=b.iv;l.addPoint("compute_media_keys_end"),l.addPoint("encrypt_and_hmac_start");var L=await o("WAMediaCrypto").encryptAndHmac(v,R,S,f,h),E=L.ciphertext,k=L.ciphertextHash,I=L.ivCiphertextHmac,T=L.sidecar;l.addPoint("encrypt_and_hmac_end");var D=null;if(h==="image"){l.addPoint("get_progressive_jpeg_details_start");var x=await o("WAProgressiveJpegGetPJpegDetails").getProgressiveJpegDetails(new Uint8Array(f),I,S),$=o("WAProgressiveJpegGetPJpegDetails").isValidProgressiveJpegDetails(x);$.success===!1?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Created invalid progressiveJpeg details during encrypt and upload: ",""])),$.error),l.addPoint($.error)):$.value===!0&&o("WAGlobals").getConfig().isProgressiveJpegSendEnabled()&&(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Found valid progressiveJpeg details. Adding to media entry."]))),D=x,l.addPoint("get_progressive_jpeg_details_end"))}var P={fileSha256:o("WABase64").decodeB64UrlSafe(g),fileEncSha256:k,mediaKey:a,mediaKeyTimestamp:i,serverMediaType:h,uploadToken:C,sidecar:T,progressiveJpegDetails:D,size:f.byteLength,filename:void 0,lastDownloadAttemptTimestamp:void 0,directPath:void 0},N,M=await y.run(async function(e,t,n){var a=e.domain,i=r;if(n>0){l.addPoint("network_retry",{int:{network_retry_attempt:n}});try{l.addPoint("resume_check_start");var s=o("WAMediaUrl").buildUploadUrl(h,C,k,a,t,!0),p=await o("WAHttpResumeCheck").httpResumeCheck(s);if(p.success){l.addPoint("resume_check_end");var _=p.value;if(_.type==="media-found")return l.addAnnotations({bool:{existingMediaFound:!0}}),o("WAResultOrError").makeResult(o("WAResultOrError").makeResult({directPath:_.directPath,objectId:null,handle:null}));_.type==="media-partial-found"&&(i=_.resumeFromBytes)}l.addPoint("resume_check_fail",{string:{resume_check_error:p.error}})}catch(e){l.addPoint("resume_check_fail",{string:{resume_check_error:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: error during retrier ",""])),e)}}i>0&&i<E.byteLength?(l.addAnnotations({int:{fromOffset:i},bool:{continuedFromOffset:!0}}),N=E.subarray(i)):N=E;var f=o("WAMediaUrl").buildUploadUrl(h,C,k,a,t,!1,i);return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: start upload media to ",""])),f),l.addPoint("http_upload_start"),o("WAHttpRegularUploadMedia").httpRegularUploadMedia(f,N).then(function(e){if(e.success)return l.addPoint("http_upload_end",{int:{attempt:n}}),o("WAResultOrError").makeResult(e);var t=e.error;switch(l.addPoint("http_upload_fail",{string:{http_upload_error:t}}),o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""])),t),t){case"server-timeout":case"unspecified-http-error":return o("WAResultOrError").makeError({progressMade:!0});default:return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(t))}}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return l.addPoint("http_upload_fail",{string:{http_upload_error:t}}),o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""])),t),o("WAResultOrError").makeError({progressMade:!1})})});if(M==null)return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded");if(M.success===!1)return M;var w=M.value,A=w.directPath,F=w.handle,O=w.objectId,B=babelHelpers.extends({},P,{directPath:A,handle:F,objectId:O});o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: upload success "," ",""])),{directPath:A},{objectId:O});var W="undefined";return O!=null&&(W=O.length>60?"new":"old"),l.addPoint("encrypt_and_upload_plaintext_end",{string:{object_id_type:W}}),o("WAResultOrError").makeResult(B)}l.encryptAndUploadPlaintext=f}),98);
__d("WAUploadMediaQuick",["WACreateRetrier","WAEncryptAndUploadPlaintext","WAMediaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){var n=t.logger,r=t.mediaUploadFlow,a=t.plaintext,i=t.plaintextHash,l=t.serverMediaType;n.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start uploadMediaQuick"]))),r.addPoint("create_upload_retrier_start");var s=await o("WACreateRetrier").createUploadRetrier(l,r);if(!s.success)return r.addPoint("create_upload_retrier_fail"),s;r.addPoint("create_upload_retrier_end"),r.addPoint("create_media_key_start");var u=o("WAMediaUtils").createMediaKey(),c=o("WAMediaUtils").createUploadToken(),d=o("WATimeUtils").unixTime();r.addPoint("create_media_key_end");var m=await o("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({mediaKey:u,mediaKeyTimestamp:d,serverMediaType:l,mediaUploadFlow:r,plaintext:a,plaintextHash:i,uploadRetrier:s.value,uploadToken:c});return m}l.uploadMediaQuick=s}),98);
__d("mapWorkerSchedulerTask",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return babelHelpers.extends({},e,{promise:e.promise.then(t),run:function(){return e.run().then(t)}})}i.mapWorkerSchedulerTask=e}),66);
__d("WAMediaManager",["$InternalEnum","WADownloadFullSizeAndPreviewTask","WADownloadFullSizeOnlyTask","WADownloadPreviewOnlyTask","WAErrorMessage","WAHashUtils","WAMediaManagerCache","WAMediaManagerLogger","WAMediaManagerTypes","WAMediaManagerWorkerScheduler","WAResultOrError","WAUploadMediaQuick","WorkerScheduler","gkx","mapWorkerSchedulerTask"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S=n("$InternalEnum").Mirrored(["HIGH","MEDIUM","LOW"]);function R(){return{fullsizeCache:new Map,previewCache:new Map,uploadCache:new Map}}function L(t){var n=t.createCacheState,a=t.dbCallbacks,i=o("WAMediaManagerWorkerScheduler").mediaManagerWorkerScheduler(),l=o("WAMediaManagerCache").createAttachmentCache(a.getProtocolMsgIdAndSortOrderMs,n),v=function(n){var t=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"fullsize",fullSizePlaintextHash:n.fullSizePlaintextHash}),r=l.getFullsize(n);if(t.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),r.type),r.type==="cache-hit")return r.cache;var c=new AbortController,d=i.task({fn:function(){return o("WADownloadFullSizeOnlyTask").startDownloadFullSizeTask({abortSignal:c.signal,dbCallbacks:a,fullSizePlaintextHash:n.fullSizePlaintextHash,logger:t,mediaDownloadFlow:n.mediaDownloadFlow})},name:"media-manager-download-fullsize-only",priority:E(n.priority)}),m=d.run();return r.setDownloadCache({abortController:c,fullSizePlaintextHash:n.fullSizePlaintextHash,mediaDownloadFlow:n.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(d,function(e){return e.fullsizePromise})}),m.then(function(e){return e.fullsizePromise}).then(function(e){return x(n.fullSizePlaintextHash,e,r.setDownloadedAttachmentToUploadCache)}).catch(function(e){return t.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){t.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["end"])))})},S=function(t){var e=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"preview",fullSizePlaintextHash:t.fullSizePlaintextHash}),n=l.getPreview(t);if(e.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",""])),n.type),n.type==="cache-hit")return n.cache;var r=new AbortController,s=i.task({fn:function(){return o("WADownloadPreviewOnlyTask").startDownloadPreviewTask({abortSignal:r.signal,dbCallbacks:a,fullSizePlaintextHash:t.fullSizePlaintextHash,logger:e,mediaDownloadFlow:t.mediaDownloadFlow})},name:"media-manager-download-preview-only",priority:E(t.priority)});n.setDownloadCache({abortController:r,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(s,function(e){return e.previewPromise})});var u=s.run();return u.then(function(e){return e.previewPromise}).then(function(e){return $(e,n.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["end"])))})},R=function(t){var e=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"fullsizeAndPreview",fullSizePlaintextHash:t.fullSizePlaintextHash}),n=l.getFullsizeAndPreview(t),r=n.fullsizeCacheResult,s=n.previewCacheResult;if(e.DEV(p||(p=babelHelpers.taggedTemplateLiteralLoose(["fullsize: ",", preview: ",""])),r.type,s.type),r.type==="cache-hit"&&s.type==="cache-hit")return{fullsizePromise:r.cache,previewPromise:s.cache};if(s.type==="cache-hit"){var u=v(t);return{fullsizePromise:u,previewPromise:s.cache}}if(r.type==="cache-hit"){var c=S(t);return{fullsizePromise:r.cache,previewPromise:c}}r.type,s.type;var d=new AbortController,m=i.task({fn:function(){return o("WADownloadFullSizeAndPreviewTask").startDownloadFullSizeAndPreviewTask({abortSignal:d.signal,dbCallbacks:a,fullSizePlaintextHash:t.fullSizePlaintextHash,logger:e,mediaDownloadFlow:t.mediaDownloadFlow})},name:"media-manager-download-fullsize-and-preview",priority:E(t.priority)});r.setDownloadCache({abortController:d,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(m,function(e){return e.fullsizePromise})}),s.setDownloadCache({abortController:d,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(m,function(e){return e.previewPromise})});var y=m.run();return{fullsizePromise:y.then(function(e){return e.fullsizePromise}).then(function(e){return x(t.fullSizePlaintextHash,e,r.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["fullsizePromise runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(f||(f=babelHelpers.taggedTemplateLiteralLoose(["fullsize end"])))}),previewPromise:y.then(function(e){return e.previewPromise}).then(function(e){return $(e,s.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["previewPromise runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["preview end"])))})}},L=function(t){var e=o("WAMediaManagerLogger").createUploadLogger({plaintextHash:t.plaintextHash,uploadKind:"fullsize"}),n;if(r("gkx")("19103")&&(n=l.getUploadedAttachment(t),e.DEV(y||(y=babelHelpers.taggedTemplateLiteralLoose(["cache result: ",""])),n.type),t.mediaUploadFlow.addAnnotations({string:{dedupe_result:n.type}}),n.type==="in-thread-cache-hit"))return n.cache;var a=o("WAUploadMediaQuick").uploadMediaQuick({logger:e,mediaUploadFlow:t.mediaUploadFlow,plaintext:t.plaintext,plaintextHash:t.plaintextHash,serverMediaType:t.serverMediaType}).catch(function(t){return e.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(b||(b=babelHelpers.taggedTemplateLiteralLoose(["upload end"])))});return n!=null&&r("gkx")("19103")&&n.setUploadCache({chatJid:t.chatJid,plaintextHash:t.plaintextHash,scheduledTask:a}),a};return{clearCache:l.clearCache,dequeueDownload:l.cancelTask,enqueueDownloadFullSize:T("fullsize",v),enqueueDownloadFullSizeAndPreview:T("fullsizeAndPreview",R),enqueueDownloadPreview:T("preview",S),enqueueUploadFullSize:D(L)}}function E(e){return e===S.HIGH?o("WorkerScheduler").BLOCKING_PRIORITY:e===S.MEDIUM?o("WorkerScheduler").REGULAR_PRIORITY:e===S.LOW?o("WorkerScheduler").BACKGROUND_PRIORITY:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}var k=typeof((v=navigator.storage)==null?void 0:v.getDirectory)=="function",I=typeof self.caches=="object";function T(e,t){return function(n){var r=n.fullSizePlaintextHash,a=n.mediaDownloadFlow;try{a.addPoint("enqueue_start",{bool:{isOPFSSupported:k,isWebCacheSupported:I},string:{downloadKind:e,sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var i=t(n);return a.addPoint("enqueue_end"),i}catch(e){throw a.addPoint("enqueue_fail"),e}}}function D(e){return function(t){var n=t.mediaUploadFlow,r=t.plaintextHash;try{n.addPoint("enqueue_start",{string:{sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var a=e(t);return n.addPoint("enqueue_end"),a}catch(e){throw n.addPoint("enqueue_fail"),e}}}function x(e,t,n){if(!t.success)return t;if(r("gkx")("19103")===!1)return o("WAMediaManagerTypes").transformInternalMediaDownloadResult(t);var a=t.value.msgIdAndMediaEntry,i=a[0],l=a[1];return n({mediaEntry:l,msgId:i,plaintextHash:e}),o("WAMediaManagerTypes").transformInternalMediaDownloadResult(t)}function $(e,t){if(!e.success)return e;if(r("gkx")("19103")===!1)return o("WAMediaManagerTypes").transformInternalMediaDownloadResult(e);var n=e.value.msgIdAndMediaEntry,a=n[0],i=n[1],l=i.downloadableThumbnail;return l==null||l.directPath==null||l.fileEncSha256==null||l.fileSha256==null||l.mediaKey==null||l.mediaKeyTimestamp==null||l.objectId==null||t({mediaEntry:babelHelpers.extends({},i,{directPath:l.directPath,downloadableThumbnail:null,fileSha256:l.fileSha256,mediaKey:l.mediaKey,mediaKeyTimestamp:l.mediaKeyTimestamp,objectId:l.objectId,serverMediaType:"preview",size:e.value.validatedResult.validatedPlaintext.byteLength}),msgId:a,plaintextHash:o("WAHashUtils").toPlaintextHash(l.fileSha256)}),o("WAMediaManagerTypes").transformInternalMediaDownloadResult(e)}l.MediaTaskPriority=S,l.createCacheState=R,l.createMediaManager=L,l.toWorkerSchedulerPriority=E}),98);
__d("WAMediaManagerCache",["Promise","WAErrorMessage","WAHashUtils","WAMediaManager","WAMediaManagerLogger","WAMediaManagerTypes","WAPromiseDelays","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["mediaKeyTimestamp","objectId","size"],s,u,c,d,m,p,_,f=3e4,g=1e3*60*60*24*2;function h(e,t){t===void 0&&(t=o("WAMediaManager").createCacheState);var r=t(),a=r.fullsizeCache,i=r.previewCache,l=r.uploadCache,h=function(t){var e=t.abortController,n=t.fullSizePlaintextHash,r=t.mediaDownloadFlow,i=t.scheduledTask;a.set(n,{abortController:e,mediaDownloadFlow:r,task:i}),i.promise.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(f):void 0}).finally(function(){a.delete(n)})},b=function(t){var e=t.abortController,n=t.fullSizePlaintextHash,r=t.mediaDownloadFlow,a=t.scheduledTask;i.set(n,{abortController:e,mediaDownloadFlow:r,task:a}),a.promise.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(f):void 0}).finally(function(){i.delete(n)})},v=function(t){var e=t.chatJid,n=t.plaintextHash,r=t.scheduledTask,a=t.cacheTtlMs,i=a===void 0?g:a,s=l.get(n)||new Map;s.set(e,r),l.set(n,s),r.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(i):void 0}).finally(function(){l.delete(n)})},S=function(r){var t=r.mediaEntry,a=r.msgId,i=r.plaintextHash;e(a).then(function(e){if(e==null){o("WAMediaManagerLogger").baseLogger.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["missing chatJid, skip setDownloadedAttachmentToUploadCache"])));return}var r=e.protocolMsgId.chat,a=C(t);if(a==null){o("WAMediaManagerLogger").baseLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["can not covert mediaEntry from download to upload for cache"])));return}var l=o("WATimeUtils").timeoutFor(a.mediaKeyTimestamp,g/1e3);if(l!==0){var c=o("WATimeUtils").pastUnixTime(o("WATimeUtils").DAY_SECONDS,a.mediaKeyTimestamp);o("WATimeUtils").isInFuture(c)||v({cacheTtlMs:l,chatJid:r,plaintextHash:i,scheduledTask:(_||(_=n("Promise"))).resolve(o("WAResultOrError").makeResult(a))})}}).catch(function(e){o("WAMediaManagerLogger").baseLogger.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["setDownloadedAttachmentToUploadCache getProtocolMsgIdAndSortOrderMs: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e))})};return{cancelTask:function(t){var e=o("WAMediaManagerLogger").baseLogger.TAGS(["hash:"+o("WAHashUtils").sanitisePlaintextHash(t),"cancelTask"]);e.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["start"])));var n=[a,i];for(var r of n){var l=r.get(t);if(l!=null){var s=l.task.cancel();l.mediaDownloadFlow.addPoint("cancel_download_triggered"),s===!1?(l.abortController.abort(),l.mediaDownloadFlow.addPoint("http_abort_cancel"),e.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["http abort cancel"])))):(l.mediaDownloadFlow.addPoint("worker_task_cancel_cancel"),e.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["worker task cancel"])))),r.delete(t)}}},clearCache:function(){i.clear(),a.clear(),l.clear()},getFullsize:function(t){var e=a.get(t.fullSizePlaintextHash);return e!=null?(y(t.mediaDownloadFlow,"hit","fullsize"),e.task.promote(o("WAMediaManager").toWorkerSchedulerPriority(t.priority)),{cache:e.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}):(y(t.mediaDownloadFlow,"miss","fullsize"),{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"})},getFullsizeAndPreview:function(t){var e=o("WAMediaManager").toWorkerSchedulerPriority(t.priority),n=a.get(t.fullSizePlaintextHash),r=i.get(t.fullSizePlaintextHash);return n!=null&&r!=null?(y(t.mediaDownloadFlow,"hit","fullsize-and-preview"),n.task.promote(e),r.task.promote(e),{fullsizeCacheResult:{cache:n.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"},previewCacheResult:{cache:r.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}}):n!=null?(y(t.mediaDownloadFlow,"hit","fullsize"),n.task.promote(e),{fullsizeCacheResult:{cache:n.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"},previewCacheResult:{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"}}):r!=null?(y(t.mediaDownloadFlow,"hit","preview"),r.task.promote(e),{fullsizeCacheResult:{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"},previewCacheResult:{cache:r.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}}):(y(t.mediaDownloadFlow,"miss","fullsize-and-preview"),{fullsizeCacheResult:{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"},previewCacheResult:{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"}})},getPreview:function(t){var e=i.get(t.fullSizePlaintextHash);return e!=null?(y(t.mediaDownloadFlow,"hit","preview"),e.task.promote(o("WAMediaManager").toWorkerSchedulerPriority(t.priority)),{cache:e.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}):(y(t.mediaDownloadFlow,"miss","preview"),{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"})},getUploadedAttachment:function(t){var e=l.get(t.plaintextHash);if(e==null)return{setUploadCache:v,type:"cache-miss-no-plaintext-hash"};var n=e.get(t.chatJid);return n==null?{setUploadCache:v,type:"cache-miss-no-thread"}:{cache:n,type:"in-thread-cache-hit"}}}}function y(e,t,n){e.addAnnotations({string:{media_manager_cache_result:t,media_manager_cache_type:n}})}function C(t){var n=t.mediaKeyTimestamp,r=t.objectId,o=t.size,a=babelHelpers.objectWithoutPropertiesLoose(t,e);return n==null||r==null||o==null?null:babelHelpers.extends({},a,{mediaKeyTimestamp:n,objectId:r,size:o})}l.DOWNLOAD_TASK_CACHE_TTL_MS=f,l.UPLOAD_TASK_CACHE_TTL_MS=g,l.createAttachmentCache=h}),98);
__d("blobToDataUri",["err"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=new FileReader,n=new Promise(function(e,n){t.onloadend=e,t.onerror=n});t.readAsDataURL(e),await n;var o=t.result;if(typeof o!="string")throw r("err")('Unexpected result type "%s" when reading Blob as DataURL.',o instanceof ArrayBuffer?"ArrayBuffer":typeof o);return o}l.default=e}),98);
__d("MAWGetThumbnailBlobDataUrlByMediaIdApi",["MAWCreateMaybeAddPointForMediaRender","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWIndexedDb","MAWMaybeWithTimeout","MAWMediaManager","MAWMediaPreviewDownloadManager","MAWTransactionMode","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaManager","WAResultOrError","WAStartMediaDownloadQplFlow","blobToDataUri"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v=o("MWFBLogger").MWMediaLogger().tags(["getThumbnailBlobDataUrlByMediaId"]),S=async function(n,a,i){v.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from , from ",""])),n,a);var t=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(i),l={string:{description:a,fetch_by:"mediaId"}};t("fetch_thumbnail_blob_api_start",l),t("get_media_from_db_start",l);var g=await k(n);if(t("get_media_from_db_finish",{bool:{db_media_found:g!=null}}),g==null)throw v.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No media found for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_media_found_in_db",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because media is not in the media db. mediaId is %s, from %s",n,a);var h=T(g);if(h.success===!0){v.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Found jpegThumbnail entry for ",""])),n),t("fetch_thumbnail_blob_api_success",l);var y=await r("blobToDataUri")(h.value);if(!y)throw v.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_data_uri",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",n,a);return v.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),n),y}var C=h.error;switch(C){case"missing_jpeg_thumbnail":if(g.mediaType===o("MAWDbMedia").MEDIA_TYPE.IMAGE||g.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO){var b=await L(g,i);if(b!=null){t("fetch_thumbnail_blob_api_success",l);var S=await r("blobToDataUri")(b);if(!S)throw v.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_data_uri",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",n,a);return v.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),n),S}if((g==null?void 0:g.mediaType)===o("MAWDbMedia").MEDIA_TYPE.VIDEO)throw t("fetch_thumbnail_blob_api_fail_not_able_to_generate_video_thumbnail_on_the_fly",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time (for video). mediaId is %s, from %s",n,a);var R=await E(g,i);if(R==null)throw t("fetch_thumbnail_blob_api_fail_not_able_to_generate_image_thumbnail_on_the_fly",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time or to generate thumnbail on the fly. mediaId is %s, from %s",n,a);t("fetch_thumbnail_blob_api_success",l);var I=await r("blobToDataUri")(R);if(!I)throw v.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_data_uri",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",n,a);return v.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),n),I}throw t("fetch_thumbnail_blob_api_fail_missing_thumbnail",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media (missing_jpeg_thumbnail). mediaId is %s, from %s",n,a);case"invalid_media":throw t("fetch_thumbnail_blob_api_fail_invalid_media",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media. mediaId is %s, from %s",n,a)}},R=async function(t,n,a){var e=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(a),i={string:{description:n,fetch_by:"hashedPlaintextHash"}};e("fetch_thumbnail_blob_api_start",i),v.DEBUG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from ",""])),o("WAHashUtils").sanitisePlaintextHash(t),n);var l=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"UILayout",msgType:null,protocolMsgId:null,triggerUIView:null}),s=o("MAWMediaManager").getMawMediaManager(),u=s.enqueueDownloadFullSizeAndPreview({fullSizePlaintextHash:t,mediaDownloadFlow:l,priority:o("WAMediaManager").MediaTaskPriority.HIGH}),c=await u.previewPromise;if(c.success){var d;l.endSuccess();var m=c.value.validatedResult.validatedPlaintext,p=new Blob([m],{type:(d=c.value.validatedResult.mimeType)!=null?d:void 0}),_=await r("blobToDataUri")(p);return _}if(c.error!=="preview-not-supported")throw l.endFail(c.error,{string:{failReason:c.error}}),o("MWFBLogger").MPSLogger().mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",o("WAHashUtils").sanitisePlaintextHash(t),n,c.error);var f=await u.fullsizePromise;if(f.success){var h;l.endSuccess();var y=f.value.validatedResult.validatedPlaintext,C=new Blob([y],{type:(h=f.value.validatedResult.mimeType)!=null?h:void 0}),b=await r("blobToDataUri")(C);return b}throw l.endFail(f.error,{string:{failReason:f.error}}),o("MWFBLogger").MPSLogger().mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",o("WAHashUtils").sanitisePlaintextHash(t),n,f.error)},L=function(t,n){var e=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(n);e("fetch_thumbnail_blob_api_thumbnail_download_start");var r=o("MAWMediaPreviewDownloadManager").getMediaPreviewDownloadingResolvable(t.plaintextHash);return r==null?(e("fetch_thumbnail_blob_api_thumbnail_download_fail_no_resolvable"),Promise.resolve(null)):o("MAWMaybeWithTimeout").maybeWithTimeout(r.promise,1e4,function(){throw v.mustfixThrow("timeout waiting for thumbnail to download")}).then(function(t){return e("fetch_thumbnail_blob_api_thumbnail_download_success"),t}).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return v.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Exception when waiting for thumbnail to download: ",""])),n),e("fetch_thumbnail_blob_api_thumbnail_download_fail_exception",{string:{wait_for_thumbnail_download_exception:n}}),null})},E=o("MAWIndexedDb").makeMsgrTransactor({chunk:(b=o("MAWTransactionMode")).READONLY,media:b.READONLY},"generateThumbnailFromMediaChunk",function(e){return function(t,n){var r=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(n);return r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_start"),o("MAWDbChunkTxns").maybeGetChunkFromHash(e,t.hashedPlaintextHash).then(function(e){if(e==null){v.MUSTFIX(y||(y=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: unable to get a thumbnail as the media chunk is missing"]))),r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_fail_chunk_missing");return}return v.WARN(C||(C=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: using media chunk as the thumbnail"]))),r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_success"),new Blob([e.blobData],{type:e.mimetype})})}}),k=o("MAWIndexedDb").makeMsgrTransactor({media:b.READONLY},"getFullMedia",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t)}}),I=o("MAWIndexedDb").makeMsgrTransactor({media:b.READONLY},"getFullMedia",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,t)}}),T=function(t){var e=D(t);if(e.success===!1)return e;var n=e.value.jpegThumbnail;return n!=null?o("WAResultOrError").makeResult(new Blob([n],{type:"image/jpeg"})):o("WAResultOrError").makeError("missing_jpeg_thumbnail")},D=function(t){var e,n;switch(t.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return o("WAResultOrError").makeResult({jpegThumbnail:(e=t.validatedImageInfo)==null?void 0:e.jpegThumbnail});case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return o("WAResultOrError").makeResult({jpegThumbnail:(n=t.validatedVideoInfo)==null?void 0:n.jpegThumbnail});case o("MAWDbMedia").MEDIA_TYPE.PTT:case o("MAWDbMedia").MEDIA_TYPE.STICKER:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return o("WAResultOrError").makeError("invalid_media");default:return t.mediaType,o("WAResultOrError").makeError("invalid_media")}};l.getThumbnailBlobDataUrlByMediaId=S,l.getThumbnailBlobDataUrlByHashedPlaintextHash=R,l.getFullMediaWithPlaintextHash=I}),98);
__d("MAWMediaManager",["MpsMediaManager","WAMediaManager","memoize"],(function(t,n,r,o,a,i,l){"use strict";var e=r("memoize")(function(){return o("WAMediaManager").createCacheState()}),s=r("memoize")(function(){return o("MpsMediaManager").getMpsMediaManager(e)}),u=function(){return s()};l.getMawMediaManager=u}),98);
__d("MpsMediaEntryCache",["FBLogger","MpsMessageToBridgeWrapper","WADirectPath","WAHashUtils","WALongInt","WAMediaUtils","WAProgressiveJpegGetScanLengths","WATimeUtils","getErrorSafe","getMediaTypeFromConsumerMessage","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t){var n,r,o=e.get(t.plaintextHash);if(((n=t.mediaKeyTimestamp)!=null?n:0)>=((r=o==null?void 0:o.mediaKeyTimestamp)!=null?r:0))return e.set(t.plaintextHash,t),t}function u(e){try{var t=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(e);return[c(t),p(t)].concat(m(t)).filter(Boolean)}catch(e){var n=r("getErrorSafe")(e);if(n.message.includes("FormatError"))return r("FBLogger")("mps").catching(n).warn("Error in hydrateCache"),[];throw r("FBLogger")("mps").catching(n).mustfixThrow("Error in hydrateCache")}}function c(e){var t,n=e.deserialize(),r=(t=n.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(r!=null)return d(e,r)}function d(e,t){var n,r,a,i,l,s,u,c,d,m=(n=(r=(a=(i=(l=t.audioMessage())==null?void 0:l.payload)!=null?i:(s=t.documentMessage())==null?void 0:s.payload)!=null?a:(u=t.imageMessage())==null?void 0:u.payload)!=null?r:(c=t.stickerMessage())==null?void 0:c.payload)!=null?n:(d=t.videoMessage())==null?void 0:d.payload;if(m!=null){var p=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(t.proto);return _(m,p,e)}}function m(e){var t,n,r=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),o=r==null?void 0:r.extendedContentMessage();if(o==null||r==null)return[];var a="xma-image",i=o.previews().map(function(t){return _(t,a,e)}),l=o.headerImage();l!=null&&i.push(_(l,a,e));var s=o.favicon();s!=null&&i.push(_(s,a,e));var u=(n=o.associatedMessage())==null?void 0:n.consumerMessage();return u!=null&&i.push(d(e,u)),i.filter(Boolean)}function p(e){var t,n=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),a=n==null?void 0:n.noteReply(),i=a==null?void 0:a.stickerContent(),l=a==null?void 0:a.videoContent(),s=i!=null?i:l;if(s!=null){var u=l!=null?o("getMediaTypeFromConsumerMessage").getMediaTypeForVideo(l):void 0,c=i!=null?"sticker":void 0,d=r("nullthrows")(u!=null?u:c);return _(s,d,e)}}function _(e,t,n){var a,i,l,u,c,d,m,p,_,f,g,h,y,C=e.ancillary,b=e.integral;if(C==null||b==null){var v=Object.entries({ancillary:C,integral:b}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("invalid media entry, missing %s. type %s",v,t);return}var S=o("WADirectPath").validateDirectPath((a=b.transport)==null||(a=a.integral)==null?void 0:a.directPath).value,R=(i=b.transport)==null||(i=i.integral)==null?void 0:i.mediaKeyTimestamp,L=R!=null?o("WATimeUtils").castLongIntToUnixTime(R):void 0,E=(l=b.transport)==null||(l=l.integral)==null?void 0:l.fileSha256,k=E!=null?o("WAHashUtils").toPlaintextHash(E):void 0;if(S==null||E==null||k==null||t==null){var I=Object.entries({directPath:S,fileSha256:E,mediaType:t,plaintextHash:k}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("Missing media entry fields: %s. type :%s",I,t);return}var T=null,D=C.scanLengths,x=C.scansSidecar;x!=null&&D!=null&&(T={scanLengths:D.map(o("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength),sidecar:x});var $=void 0,P=(u=b.transport)==null||(u=u.ancillary)==null||(u=u.thumbnail)==null?void 0:u.downloadableThumbnail;if(P!=null){var N;$={directPath:o("WADirectPath").validateDirectPath(P.directPath).value,fileEncSha256:P.fileEncSha256,fileSha256:P.fileSha256,mediaKey:P.mediaKey==null?void 0:o("WAMediaUtils").castToMediaKey(P.mediaKey),mediaKeyTimestamp:o("WATimeUtils").castLongIntToUnixTime((N=P.mediaKeyTimestamp)!=null?N:0),objectId:P.objectId==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(P.objectId)}}var M={directPath:S,downloadableThumbnail:$,fileEncSha256:(c=b.transport)==null||(c=c.integral)==null?void 0:c.fileEncSha256,filename:null,fileSha256:E,mediaKey:((d=b.transport)==null||(d=d.integral)==null?void 0:d.mediaKey)==null?void 0:o("WAMediaUtils").castToMediaKey((m=b.transport)==null||(m=m.integral)==null?void 0:m.mediaKey),mediaKeyTimestamp:L,objectId:(b==null||(p=b.transport)==null||(p=p.ancillary)==null?void 0:p.objectId)==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(b==null||(_=b.transport)==null||(_=_.ancillary)==null?void 0:_.objectId),progressiveJpegDetails:T,serverMediaType:t,size:o("WALongInt").numberOrThrowIfTooLarge((f=b==null||(g=b.transport)==null||(g=g.ancillary)==null?void 0:g.fileLength)!=null?f:0),uploadToken:void 0},w=o("WAMediaUtils").encodeMediaEntryWithUpdatedPath(M,S);return s({decodedMediaEntry:M,mediaEntry:w,mediaKeyTimestamp:L,message:{messageId:n.message.messageId,threadId:n.message.threadId},plaintextHash:k,serverMediaType:t,thumbnailHash:((h=$)==null?void 0:h.fileSha256)!=null?o("WAHashUtils").toPlaintextHash((y=$)==null?void 0:y.fileSha256):void 0})}function f(t){return e.get(t)}function g(){e.clear()}l.storeEntry=s,l.hydrateCache=u,l.getEntry=f,l.clear__TEST_ONLY=g}),98);
__d("WmiChunkApi",["CoalescingLoader","MAWDbChunkTxns","MAWDexieTable","MAWIndexedDb","MAWMediaUtils","MAWTransactionMode","emptyFunction","memoizeWithArgsLFUCache"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READONLY},"wms_getCachedChunkResult",function(e){return function(t){return o("MAWDbChunkTxns").maybeBulkGetChunksFromPlaintextHash(e,t)}}),n=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READWRITE},"wms_storeChunk",function(t){return function(n){return n.map(function(t){return e(t[0])}),o("MAWDexieTable").dexieAll(n.map(function(e){return o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(t,e[0],e[1],e[2],e[3])})).then(r("emptyFunction"))}}),a=new(o("CoalescingLoader")).CoalescingLoader(async function(n){var r=await t(n);return n.map(function(t){var n=r.get(t);return n==null&&e(t),n})}),i=new(o("CoalescingLoader")).CoalescingLoader(async function(e){return await n(e),[]}),l=r("memoizeWithArgsLFUCache")(function(e){return a.gen(e)},function(e){return e},1,function(t){e=t}),s=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READWRITE},"wms_deleteChunk",function(t){return function(n){n.map(e);var r=n.map(o("MAWMediaUtils").genHMACPlaintextHash);return t.chunk.where("hashedPlaintextHash").anyOf(r).delete()}});return{delete:s,get:l,store:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.gen(t)}}}l.getChunkApi=e}),98);
__d("MediaServiceLogger",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return r("FBLogger")("wmi_media_service",t)};l.MediaServiceLogger=e}),98);
__d("WmiMediaServiceSchema",["$InternalEnum","MAWWormOdsLogger","MediaServiceLogger","WAHex","Worm","WormEAR","WormIDbDriver","WormMemoryDriver"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["XMA","Sticker"]),s={autoIncrement:!0,indexes:{"[plaintextHash+updatedAtMs]":{fields:["plaintextHash","updatedAtMs"],unique:!1},"[threadId+messageId+plaintextHash]":{fields:["threadId","messageId","plaintextHash"],unique:!0}},nonEncryptedFields:["updatedAtMs","messageId"],primaryKey:"pk",secure:!0},u={autoIncrement:!1,indexes:{},nonEncryptedFields:["refCount"],primaryKey:"mediaId",secure:!0},c={autoIncrement:!1,indexes:{receiverFetchType:{fields:["receiverFetchType"],unique:!1}},nonEncryptedFields:["receiverFetchType"],primaryKey:"receiverFetchId",secure:!0},d={mediaReferrenceCount:u,messageChunk:s,receiverFetchInfo:c};function m(e){var t=e.blockingErrorThreshold,n=e.dbName,r=e.onBlockingError,a=e.qplEvent,i=e.strEncKey,l=o("WAHex").parseHex(i),s="wmi_media_service",u=new(o("WormEAR")).WormEAR(d,s,l),c=new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(n,s,d,u,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:t,onBlockingError:r,onTransactionError:function(t){if(t instanceof o("WormEAR").DecryptionError){if(o("MediaServiceLogger").MediaServiceLogger().mustfix("EAR decryption error in store: %s. Dropping corrupted entity %s",t.store,t.maybeHashedPk),t.store==="messageChunk"){var e=t.maybeHashedPk;c.runInTransaction(["messageChunk"],"readwrite",function(t){return e!=null?t.stores.messageChunk.delete(e):t.stores.messageChunk.clear()},"delete-corrupted-entity")}else if(t.store==="mediaReferrenceCount"){var n=t.maybeHashedPk;c.runInTransaction(["mediaReferrenceCount"],"readwrite",function(e){return n!=null?e.stores.mediaReferrenceCount.delete(n):e.stores.mediaReferrenceCount.clear()},"delete-corrupted-entity")}else if(t.store==="receiverFetchInfo"){var r=t.maybeHashedPk;c.runInTransaction(["receiverFetchInfo"],"readwrite",function(e){return r!=null?e.stores.receiverFetchInfo.delete(r):e.stores.receiverFetchInfo.clear()},"delete-corrupted-entity")}}}}),a);return c}function p(e){return new(o("Worm")).WormDatabase(new(o("WormMemoryDriver")).WormMemoryDriver("wmi_media_service_test",d,o("MAWWormOdsLogger").wormOdsWorkerLogger),e)}l.ReceiverFetchType=e,l.SCHEMA=d,l.makeSchema=m,l.makeInMemorySchema_TEST_ONLY=p}),98);
__d("WmiMediaServiceDb",["MediaServiceLogger","WAResolvable","WmiMediaServiceSchema","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){try{var n=o("WmiMediaServiceSchema").makeSchema(t);return e=n,await n.init(),s.resolve(n),n}catch(e){throw o("MediaServiceLogger").MediaServiceLogger().catching(r("getErrorSafe")(e)).mustfix("Error performing Media Service init"),e}}function c(){if(e==null)throw r("err")("DB is not initialized");return e}l.makeMediaServiceDb=u,l.getDb=c}),98);
__d("WmiMediaServiceDownloadQueue",["WormPersistedQueue","WormPersistedQueueSchema"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WormPersistedQueueSchema").toWormPersistedQueueId(e)}var s=null;function u(){return s==null&&(s=new(o("WormPersistedQueue")).WormPersistedQueue("mediaDownloadQueue")),s}l.generateDownloadQueueId=e,l.getDownloadQueue=u}),98);
__d("WmiMediaService",["MpsTypes","WmiChunkApi","WmiMediaServiceDb","WmiMediaServiceDownloadQueue","err","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e){this.$1=e,this.$2=o("WmiChunkApi").getChunkApi()}var t=e.prototype;return t.enqueueMediaDownload=async function(t){await o("WmiMediaServiceDownloadQueue").getDownloadQueue().put(t.map(function(e){return{attemptCount:0,queueId:o("WmiMediaServiceDownloadQueue").generateDownloadQueueId(e)}}))},t.getChunk=async function(t){var e,n=await this.$2.get(t);return n==null?null:{blobData:n.blobData,isProgressivePreview:(e=n.isProgressivePreview)!=null?e:!1,mimetype:n.mimetype,plaintextHash:n.plaintextHash}},t.getMessageChunkForHash=function(t){return this.$1.runInTransaction(["messageChunk"],"readonly",async function(e){var n=await e.stores.messageChunk.readIndexRange("[plaintextHash+updatedAtMs]",{only:[t]},{limit:1,order:"desc"});return n.at(0)},"WmiGetMessagesForHash")},t.handleMessageDeletion=function(t,n){return this.$3(function(e){return e.stores.messageChunk.readIndexRange("[threadId+messageId+plaintextHash]",{only:[t,n]})})},t.handleThreadDeletion=function(t){return this.$3(function(e){return e.stores.messageChunk.readIndexRange("[threadId+messageId+plaintextHash]",{only:[t]})})},t.storeChunk=function(t){var e=t.blobData,n=t.isProgressivePreview,r=t.mimetype,o=t.plaintextHash;return this.$2.store(o,e,r,n)},t.storeMessageChunks=function(t){return this.$1.runInTransaction(["messageChunk"],"readwrite",async function(e){await e.stores.messageChunk.bulkUpsert("[threadId+messageId+plaintextHash]",t.map(function(e){return{item:{messageId:e.messageId,plaintextHash:e.plaintextHash,threadId:e.threadId,updatedAtMs:o("MpsTypes").toTimestamp(Date.now())},selector:[e.threadId,e.messageId,e.plaintextHash]}}))},"WmiMediaServiceStoreChunkMessage")},t.$3=async function(t){var e=await this.$1.runInTransaction(["messageChunk"],"readwrite",async function(e){var n=await t(e);await e.stores.messageChunk.bulkDelete(n.map(function(e){return e.pk}));var r=new Set(n.map(function(e){return e.plaintextHash})),o=await e.stores.messageChunk.readIndexAnyOf("[plaintextHash+updatedAtMs]",Array.from(r).map(function(e){return[e]}));return o.forEach(function(e){return r.delete(e.plaintextHash)}),Array.from(r)},"WmiMediaServiceDeleteMessageChunkEntries");e.length>0&&await this.$2.delete(Array.from(e))},e})(),s=null;async function u(t){if(s!=null)throw r("err")("Media Service already initialised");var n=await o("WmiMediaServiceDb").makeMediaServiceDb(t);s=new e(n)}function c(){return r("nullthrows")(s,"Media Service not initialised")}function d(){s=null}l.MediaService=e,l.wmiMediaServiceSetup=u,l.mediaService=c,l.wmiMediaServiceClear__TESTONLY=d}),98);
__d("MpsMediaManager",["MAWGetThumbnailBlobDataUrlByMediaIdApi","MpsMediaEntryCache","MpsMessageToBridgeWrapper","MpsToBridgeMessageId","WAIsPreviewSupported","WAJids","WAMediaManager","WAMediaManagerCache","WAMediaUtils","WAResultOrError","WAStanzaUtils","WAValidateMedia","WebMps","WmiMediaService","getErrorSafe","memoize","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=["kind"];function s(e){throw new TypeError('"'+e+'" is read-only')}async function u(e){var t=e.fullSizePlaintextHash,n=e.mediaDownloadFlow,r=o("MpsMediaEntryCache").getEntry(t);if(r!=null)return n.addPoint("media_entry_cache_hit"),r;var a=await o("WmiMediaService").mediaService().getMessageChunkForHash(t);if(a==null){n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"missing_message_chunk"}});return}var i=await o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"MpsMediaManager-getEntryWithFallback"},messageId:a.messageId,threadId:a.threadId}),l=i.value;if(l==null){n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"missing_reverb_message"}});return}o("MpsMediaEntryCache").hydrateCache(l.toplevelProtobuf);var s=o("MpsMediaEntryCache").getEntry(t);return s==null?(n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"unable_to_cache"}}),null):(n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"success"}}),s)}async function c(e){var t=o("MpsToBridgeMessageId").bridgeMsgIdToMps(e),n=t.messageId,r=t.threadId,a=await o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-first"},debug:{purpose:"mps_media_manager"},messageId:n,threadId:r});if(a.value){var i=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.value.toplevelProtobuf),l=i.getAuthor();if(!o("WAJids").isAuthorSystem(l))return{protocolMsgId:{author:l,chat:i.getChatJid(),externalId:o("WAStanzaUtils").toStanzaId(i.getExternalId())},sortOrderMs:i.message.timestampMs}}}var d=function(t){return o("WAMediaManager").createMediaManager({createCacheState:t,dbCallbacks:{getMediaEntries:function(t){var e=o("MpsMediaEntryCache").getEntry(t);if(e==null)return Promise.resolve(o("WAResultOrError").makeError("no-media-by-plaintext-hash"));var n=e.mediaEntry,r=e.message,a=o("MpsToBridgeMessageId").mpsToBridgeMsgId(r.threadId,r.messageId);return Promise.resolve(o("WAResultOrError").makeResult(new Map([[a,n]])))},getProtocolMsgIdAndSortOrderMs:c}})};function m(e){var t=o("WAIsPreviewSupported").checkPreviewSupport(e.decodedMediaEntry),n=t[0],r=t[1];return(function(t){if(Array.isArray(t)&&t.length===2&&t[0]===o("WAIsPreviewSupported").PjpegPreviewSupport.YES)return{kind:"progressive",thumbnailHash:e.plaintextHash};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.YES)return e.thumbnailHash!=null?{kind:"withThumbnail",thumbnailHash:e.thumbnailHash}:{kind:"noPreview"};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.DuplicatedWithFullSize)return{kind:"duplicatedWithFullSize",thumbnailHash:e.plaintextHash};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return{kind:"noPreview"};throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+t)})([n,r])}async function p(e,t,n){if(e!=null){var r=await o("WAValidateMedia").validateMedia(e,t);if(r.value!=null)return o("WAResultOrError").makeResult({serverMediaType:n,unvalidatedMimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(n),validatedResult:r.value})}}async function _(e,t,n){var r=await o("WmiMediaService").mediaService().getChunk(e),a=await p(r==null?void 0:r.blobData,t,n);if(!(r==null||a==null))return t.addAnnotations({bool:{from_chunk:!0}}),{chunk:r,result:a}}function f(e,t,n,a){if(n.success===!0){var i;o("WmiMediaService").mediaService().storeChunk({blobData:n.value.validatedResult.validatedPlaintext,isProgressivePreview:a,mimetype:(i=n.value.validatedResult.mimeType)!=null?i:n.value.unvalidatedMimeType,plaintextHash:e}).then(function(){return t.addAnnotations({string:{chunk_store_result:"success"}})}).catch(function(e){var n=r("getErrorSafe")(e).message;t.addAnnotations({string:{chunk_store_result:n}})})}}async function g(e,t,n){var r,a=n.fullSizePlaintextHash,i=n.mediaDownloadFlow;if(e.success||e.error!=="signature-expired")return e;var l=await o("MAWGetThumbnailBlobDataUrlByMediaIdApi").getFullMediaWithPlaintextHash(a);if(l==null)return i.addAnnotations({string:{signature_expired_fallback:"media not found"}}),e;var s=(r=l.validatedAudioInfo)!=null?r:l.validatedVideoInfo,u=s==null?void 0:s.jpegThumbnail;if(u==null)return i.addAnnotations({string:{signature_expired_fallback:"thumbnail not found"}}),e;var c=await o("WAValidateMedia").validateMedia(u,i);return c.value==null?(i.addAnnotations({string:{signature_expired_fallback:"validation failed"}}),e):(i.addAnnotations({string:{signature_expired_fallback:"success"}}),o("WAResultOrError").makeResult({serverMediaType:t.serverMediaType,unvalidatedMimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType("image"),validatedResult:c.value}))}var h=function(n){var t=d(n),a=o("WAMediaManagerCache").createAttachmentCache(c,n),i={clearCache:t.clearCache,dequeueDownload:t.dequeueDownload,enqueueDownloadFullSize:async function(n){n.mediaDownloadFlow.addAnnotations({string:{downloadKind:"fullsize"}});var e=a.getFullsize(n);if(e.type==="cache-hit")return e.cache;var r=await u(n);if(!r)return o("WAResultOrError").makeError("missing-media-entry");var i=await _(n.fullSizePlaintextHash,n.mediaDownloadFlow,r.serverMediaType);if(i!=null&&!i.chunk.isProgressivePreview)return i.result;n.mediaDownloadFlow.addPoint("mps_actual_download");var l=await t.enqueueDownloadFullSize(n);return f(n.fullSizePlaintextHash,n.mediaDownloadFlow,l,!1),l},enqueueDownloadFullSizeAndPreview:function(i){i.mediaDownloadFlow.addAnnotations({string:{downloadKind:"fullsizeAndPreview"}});var n=a.getFullsizeAndPreview(i),l=n.fullsizeCacheResult,s=n.previewCacheResult;if(l.type==="cache-hit"&&s.type==="cache-hit")return{fullsizePromise:l.cache,previewPromise:s.cache};var c=r("memoize")(function(){return u(i)}),d=r("memoize")(async function(){var e=r("nullthrows")(await c()),t=_(i.fullSizePlaintextHash,i.mediaDownloadFlow,e.serverMediaType);return t});i.mediaDownloadFlow.addPoint("mps_actual_download");var p=r("memoize")(function(){return t.enqueueDownloadFullSizeAndPreview(i)});return{fullsizePromise:(async function(){var e=await c();if(e==null)return o("WAResultOrError").makeError("missing-media-entry");var t=await d();if(t!=null&&!t.chunk.isProgressivePreview)return t.result;var n=await p().fullsizePromise;return f(i.fullSizePlaintextHash,i.mediaDownloadFlow,n,!1),n})(),previewPromise:(async function(){var t=await c();if(t==null)return o("WAResultOrError").makeError("missing-media-entry");var n=m(t);if(n.kind==="noPreview")return o("WAResultOrError").makeError("preview-not-supported");var r=await(function(n){if((typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="duplicatedWithFullSize"||(typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="progressive")return d();if((typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="withThumbnail"){var r=n.kind,o=babelHelpers.objectWithoutPropertiesLoose(n,e);return _(o.thumbnailHash,i.mediaDownloadFlow,t.serverMediaType)}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n)})(n);if(r!=null)return r.result;var a=await p().previewPromise,l=await g(a,t,i);return n.kind==="withThumbnail"&&f(n.thumbnailHash,i.mediaDownloadFlow,l,!1),l})()}},enqueueDownloadPreview:async function(n){n.mediaDownloadFlow.addAnnotations({string:{downloadKind:"preview"}});var e=a.getPreview(n);if(e.type==="cache-hit")return e.cache;var r=await u(n);if(r==null)return o("WAResultOrError").makeError("missing-media-entry");var i=m(r),l=i.kind==="progressive";if(i.kind==="noPreview")return o("WAResultOrError").makeError("preview-not-supported");var s=i.thumbnailHash,c=await _(s,n.mediaDownloadFlow,r.serverMediaType);if(c!=null)return c.result;n.mediaDownloadFlow.addPoint("mps_actual_download");var d=await t.enqueueDownloadPreview(n),p=await g(d,r,n);return f(s,n.mediaDownloadFlow,p,l),p},enqueueUploadFullSize:function(){return t.enqueueUploadFullSize.apply(t,arguments)}};return i};l.getMpsMediaManager=h}),98);
__d("WADbDeviceRegistration",["gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=25,s=6,u=s,c="https://reg-e2ee.facebook.com",d=r("gkx")("13108")?"https://reg-e2ee.messenger.com":c,m="https://v.whatsapp.net",p="https://reg-e2ee.instagram.com",_="/v2/fb_icdc_fetch",f="/v2/fb_register_v2",g="Device has already been registered to WA servers",h="Device registration finished successfully",y="Device registration retries failed "+s+" times. No longer attempting registration.",C="Device registration response was null",b="Current user id is zero",v="CryptoAuthToken is empty",S="CryptoAuthToken is expired",R={failed:"failed",finished:"finished"};l.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=e,l.MAX_DEVICE_REGISTRATION_RETRIES=s,l.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=u,l.REG_FB_DOMAIN=c,l.REG_MSGR_DOMAIN=d,l.REG_WA_DOMAIN=m,l.REG_IGD_DOMAIN=p,l.ICDC_ENDPOINT=_,l.REGISTRATION_ENDPOINT=f,l.DEVICE_ALREADY_REGISTERED=g,l.DEVICE_SUCCESSFULLY_REGISTERED=h,l.FAILED_REGISTRATION_RETRIES=y,l.NULL_RESPONSE_FROM_SERVER=C,l.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=b,l.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=v,l.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=S,l.RegistrationStatesEnum=R}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t){var n=!1;return e!=null&&t.defaultPreviewMediaId===e.mediaId&&(n=await _(e)),o("MAWBridgeXMA").createBridgeXMA(e,t,{hasMedia:n,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function s(e,t,n){return u(e,t,n).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function u(e,t,n){var r=n==null?o("MAWDexieTable").dexieResolve(!1):o("MAWDbChunkTxns").hasMediaChunk(e,n.hashedPlaintextHash);return r.then(function(e){return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:e,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})}function c(e,t,n,r,a){return d(e,t,n,r,a).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function d(e,t,n,r,a){var i=m(n,r,a,e);return i.then(function(e){var r=e.hasMedia,a=e.hasXmaFaviconMedia,i=e.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:r,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})})}function m(e,t,n,r){if(e!=null||t!=null||n!=null){var a=[e,t,n].filter(Boolean).map(function(e){return e.hashedPlaintextHash});return o("MAWDbChunkTxns").hasMediaChunks(r,a).then(function(r){return{hasMedia:e!=null&&r.get(e.hashedPlaintextHash)===!0,hasXmaFaviconMedia:t!=null&&r.get(t.hashedPlaintextHash)===!0,hasXmaHeaderMedia:n!=null&&r.get(n.hashedPlaintextHash)===!0}})}else return o("MAWDexieTable").dexieResolve({hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function p(e,t,n,r,a){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(m(e,t,n,a).then(function(t){var n=t.hasMedia,a=t.hasXmaFaviconMedia,i=t.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(e,r,{hasMedia:n,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})}))}var _=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(e){return(function(t){return o("MAWDbChunkTxns").hasMediaChunk(e,t.hashedPlaintextHash)})});l.checkMediaChunkTransactionAndCreatedBridgeXma=e,l.checkMediaChunkAndHandleXmaAfterTransaction=s,l.checkMediaChunkAndCreatedBridgeXma=u,l.checkAllMediaChunksAndHandleXmaAfterTransaction=c,l.checkAllMediaChunksAndCreateBridgeXma=d,l.verifyAllMediaChunksForXMA=m,l.checkAllMediaChunksAndCreateBridgeXma_DEPRECATED=p}),98);
__d("MAWLegacyDownloadManager",[],(function(t,n,r,o,a,i){"use strict";var e=1e4,l=(function(){function t(){this.$1=[],this.$2=new Map}var n=t.prototype;return n.setToDownloadManager=function(t,n){this.$3(),this.$2.set(t,n),this.$1.push(t)},n.getFromDownloadManager=function(t){return this.$2.get(t)},n.removeFromMediaDownloadManager=function(t){this.$2.delete(t);var e=this.$1.filter(function(e){return e!==t});this.setDownloadManagerQueue(e)},n.setDownloadManagerQueue=function(t){this.$1=t},n.$3=function(){if(this.$1.length>=e){var t=this.$1.shift();this.$2.delete(t)}},t})();i.LegacyDownloadManager=l}),66);
__d("MAWLegacyMediaDownloadManager",["MAWLegacyDownloadManager"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager,s=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager;function u(t,n){e.setToDownloadManager(t,n)}function c(t){return e.getFromDownloadManager(t)}function d(t){e.removeFromMediaDownloadManager(t)}function m(e,t){s.setToDownloadManager(e,t)}function p(e){return s.getFromDownloadManager(e)}function _(e){s.removeFromMediaDownloadManager(e)}l.setToMediaDownloadManager=u,l.getFromMediaDownloadManager=c,l.removeFromMediaDownloadManager=d,l.setToMediaPlaintextDownloadManager=m,l.getFromMediaPlaintextDownloadManager=p,l.removeFromMediaPlaintextDownloadManager=_}),98);
__d("MAWMediaType",["WAServerMediaType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"XMA":return"xma-image";case"EphemeralScreenshotAction":case"Raven":case"RavenAction":case"EditAction":case"NoteReply":case"BumpExistingMessage":return null;default:return o("WAServerMediaType").getMediaType(e)}}l.getMediaType=e}),98);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieTable","MAWIndexedDb","MAWMediaType","MAWMediaUtils","MAWRavenUtils","MpsMediaEntryCache","MpsTypes","WAHashUtils","WAMediaUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a,i,l,u){return a.messages.where("msgId").anyOf(t.msgIds).toArray().then(function(c){var d=e.threadJid,m=o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(c,d),p=o("MAWMediaUtils").createHdTypesForBridgeMedia(c),_=e.ravenEphemeralType!=null&&e.ravenEphemeralMediaState!=null?o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,ravenSettings:o("MAWRavenUtils").deriveRavenSettings(e.ravenEphemeralType,e.ravenEphemeralMediaState),sortOrderMs:e.sortOrderMs,transportKey:l}):o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,sortOrderMs:e.sortOrderMs,transportKey:l});if(u===!0){var f,g,h,y=r("nullthrows")(t.mediaEntries.get(e.msgId)),C=o("WAMediaUtils").decodeMediaEntryData(y),b=(f=(g=t.validatedImageInfo)==null?void 0:g.thumbnailPlaintextHash)!=null?f:(h=t.validatedVideoInfo)==null?void 0:h.thumbnailPlaintextHash;if(b==null){var v=C.downloadableThumbnail;(v==null?void 0:v.fileSha256)!=null&&(b=o("WAHashUtils").toPlaintextHash(v.fileSha256))}o("MpsMediaEntryCache").storeEntry({decodedMediaEntry:C,mediaEntry:y,mediaKeyTimestamp:t.ts,message:{messageId:o("MpsTypes").toMessageId(e.externalId),threadId:o("MpsTypes").toThreadId(e.threadJid)},plaintextHash:t.plaintextHash,serverMediaType:r("nullthrows")(o("MAWMediaType").getMediaType(t.mediaType)),thumbnailHash:b})}return s(a,babelHelpers.extends({},_,{skipShouldUpdateHasMore:i}),void 0,u)})}function s(e,t,n,r){return u(t)?o("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(e,t,n).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e},r)}):(o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:t},r),o("MAWDexieTable").dexieResolve())}function u(e){if(e.ephemeralMediaState!=null||e.ephemeralMediaViewMode!=null)return!1;switch(e.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:case o("MAWDbMedia").MEDIA_TYPE.VIDEO:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}l.handleNewMediaAfterTxn=e,l.handleNewMediaAfterTxnWithBridgeMedia=s}),98);
__d("MAWVideoAudioValidationUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return{audioAvgBitsPerSecond:e.audioAvgBitsPerSecond!=null?Math.round(e.audioAvgBitsPerSecond):null,audioNumberOfChannels:e.audioNumberOfChannels!=null?Math.round(e.audioNumberOfChannels):null,audioSamplingRate:e.audioSamplingRate!=null?Math.round(e.audioSamplingRate):null,audioStreamType:e.audioStreamType,validatedMimeType:e.validatedMimeType,videoAvgBitsPerSecond:e.videoAvgBitsPerSecond!=null?Math.round(e.videoAvgBitsPerSecond):null,videoCalculatedFps:e.videoCalculatedFps!=null?Math.round(e.videoCalculatedFps):null,videoDuration:e.videoDuration!=null?Math.round(e.videoDuration):null,videoHeight:e.videoHeight!=null?Math.round(e.videoHeight):null,videoNominalFps:e.videoNominalFps!=null?Math.round(e.videoNominalFps):null,videoStreamType:e.videoStreamType,videoWidth:e.videoWidth!=null?Math.round(e.videoWidth):null}}i.normalizeValidationResult=e}),66);
__d("MAWHandleMediaDownloadApi",["MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLegacyMediaDownloadManager","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaUtils","MAWMsgType","MAWTransactionMode","MAWVideoAudioValidationUtils","MAWXMAUtils","MWFBLogger","Promise","WAArmadilloXMA.pb","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function p(t,r,a,i,l,c){m.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start persisting media blob"])));var p=t.db,_=o("MAWMediaUtils").genHMACPlaintextHash(r),h=t.persistChunk?o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(t.db,r,i,a):null;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(p,l),p.media.where("hashedPlaintextHash").equals(_).first(),h]).then(function(e){var t=e[0],l=e[1],_=e[2];if(l==null)return m.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"]))),o("WAResultOrError").makeError("missing-media-on-save");var h,y=!1;return h=o("MAWLegacyMediaDownloadManager").getFromMediaPlaintextDownloadManager(r),h==null&&(h=o("MAWLegacyMediaDownloadManager").getFromMediaDownloadManager(l.mediaId),y=!0),h!=null&&(m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["resolve MediaPlaintextDownloadManager promise"]))),h((d||(d=n("Promise"))).resolve(new Blob([i],{type:a}))),o("MAWLegacyMediaDownloadManager").removeFromMediaPlaintextDownloadManager(r),y&&o("MAWLegacyMediaDownloadManager").removeFromMediaDownloadManager(l.mediaId)),f(p,t).then(function(e){return e?p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return o("MAWDbXMATxns").getXMAFromMsgs(p,e).then(function(e){return o("MAWDexieTable").dexieAll(e.map(function(e){if(!o("MAWXMAUtils").isXMAStoryReply(e.targetType)&&e.defaultPreviewMediaId===l.mediaId)return o("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(p,e,l)}))}).then(function(){return e})}).then(function(e){return g(p,e)}):p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return p.threads.where("jid").anyOf(e.map(function(e){return e.threadJid})).toArray().then(function(n){return o("MAWDexieTable").dexieAll(n.map(function(n){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(e),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.jid,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(e,n.jid),hasMediaForUI:!0,hdTypes:r,media:l,sortOrderMs:t==null?void 0:t.sortOrderMs});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(p,a,e)}))}).then(function(){return e})}).then(function(e){return g(p,e)})}).then(function(){var e,t,n,r,a,s,u,d,m,_,f,g=l.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO?o("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:c==null||(e=c.audioStreamReport)==null?void 0:e.avgBitsPerSecond,audioNumberOfChannels:c==null||(t=c.audioStreamReport)==null?void 0:t.numberOfChannels,audioSamplingRate:c==null||(n=c.audioStreamReport)==null?void 0:n.samplingRate,audioStreamType:c==null||(r=c.audioStreamReport)==null?void 0:r.streamType,validatedMimeType:c==null?void 0:c.mimeType,videoAvgBitsPerSecond:c==null||(a=c.videoStreamReport)==null?void 0:a.avgBitsPerSecond,videoCalculatedFps:c==null||(s=c.videoStreamReport)==null?void 0:s.calculatedFps,videoDuration:c==null||(u=c.videoStreamReport)==null?void 0:u.duration,videoHeight:c==null||(d=c.videoStreamReport)==null?void 0:d.videoHeight,videoNominalFps:c==null||(m=c.videoStreamReport)==null?void 0:m.nominalFps,videoStreamType:c==null||(_=c.videoStreamReport)==null?void 0:_.streamType,videoWidth:c==null||(f=c.videoStreamReport)==null?void 0:f.videoWidth}):void 0,h=o("MAWDbMediaTxns").updateMedia(p,l,{size:i.byteLength,validatedResult:g});return h}).then(function(){return o("WAResultOrError").makeResult()})})}var _=o("MAWIndexedDb").makeMsgrTransactor({chunk:(c=o("MAWTransactionMode")).READONLY,media:c.READWRITE,messages:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READONLY,xma:c.READONLY},"handleMediaDownload",function(e){return(function(t,n,r,o,a){return p({db:e,persistChunk:!1},t,n,r,o,a)})});function f(e,t){var n;return t==null?o("MAWDexieTable").dexieResolve(!1):t.type===o("MAWMsgType").MSG_TYPE.XMA?o("MAWDexieTable").dexieResolve(!0):((n=t.quote)==null?void 0:n.content.xmaMessageType)===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?o("MAWDexieTable").dexieResolve(t.type===o("MAWMsgType").MSG_TYPE.TEXT):o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(e){return e!=null})}function g(e,t){return o("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalId(e,t.map(function(e){return e.externalId})).then(function(t){return t.map(function(t){return t.source="eb_restore",o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})})}l.handleMediaDownload=_}),98);
__d("MAWMediaDownloadStatusForUI",["MAWBridge","MAWLoggerUtils","MAWMediaDownloadStatus","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function u(e){var t=e.details,n=e.hash,r=e.status,o=e.type,a=e.validationResult;c({details:t,hash:n,status:r,type:o,validationResult:a})}function c(e){var t=e.details,n=e.hash,r=e.status,a=e.type,i=e.validationResult;o("MAWBridge").getBridge().fireAndForget("event","updateMediaStatus",{details:t,key:n,status:r,type:a,validationResult:i})}function d(t){switch(t){case"disconnected":case"backoff":case"body-network-error":case"no-host":case"download-throttled":case"max-attempts-exceeded":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":return r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE;case"request-error":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":case"signature-expired":return r("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE;default:return s.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["getStatusTypeFromWAAPIDownloadMediaError: Unknown error type ",""])),String(t)),r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE}}l.sendMediaDownloadStatusToUI=u,l.getStatusFromWAAPIDownloadMediaError=d}),98);
__d("MAWMediaBackupTxns",["FBLogger","MAWDbMediaTxns","MAWDexieTable","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=1;function m(t,n,a,i,l,p){return p===void 0&&(p=0),i==null?o("MAWDexieTable").dexieResolve():o("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(t,i).then(function(_){if(_==null){var f={mediaId:n,msgId:a,objectId:i};return l!=null&&(f=babelHelpers.extends({},f,{fbid:l})),t.mediaBackup.add(f).then(function(e){return babelHelpers.extends({},f,{mediaBackupId:e})}).catch(function(u){if(u.name==="ConstraintError"){if(p<d)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""])),u),m(t,n,a,i,l,p+1);throw r("FBLogger")("messenger_web").mustfixThrow("Failed to add mediaBackup entry. Original error: %s, %s",u.name,u.message)}throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""])),u),u})}else{if(_.mediaId!==n||_.msgId!==a)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]))),_;if(_.fbid==null&&l!=null){var g=babelHelpers.extends({},_,{fbid:l});return t.mediaBackup.put(g).then(function(e){return g})}else o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"])));return _}})}l.linkMediaBackup=m}),98);
__d("MAWSupportedDocumentTypes",[],(function(t,n,r,o,a,i){"use strict";var e=["apk","pyc","7z","z","gz","xz","rar","zip","zipx","ace","arc","zpaq","quad","balz","cab","arj","lzh","uue","bz","bz2","bzip2","jar","iso","tar","ade","adp","air","app","application","bas","bat","chm","cmd","com","command","cpl","crt","dll","dmg","dpkg","exe","hlp","hta","inf","ins","isp","jnlp","js","jse","lib","lnk","lua","mde","msc","msi","msp","mst","ocx","pcd","pif","pkg","ps1","reg","scr","sct","sh","shb","shs","sys","term","url","vb","vbe","vbs","vxd","webarchive","wsc","wsf","wsh","xbap"];function l(t){if(t==null)return!1;var n=t.includes(".")?t.split(".").pop():null;return n!=null&&!e.includes(n)}i.isAllowedType=l}),66);
__d("WASortedLists",[],(function(t,n,r,o,a,i){"use strict";function e(){return[]}function l(){return[]}function s(e,t){return e.filter(t)}function u(e,t){return g(e.map(t))}function c(e,t){for(var n=e.length===t.length,r=0;n&&r<e.length;r++)e[r]!==t[r]&&(n=!1);return n}function d(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return e;return e.concat([t]).sort()}function m(e,t){if(e.length<t.length)return!1;for(var n=!0,r=0,o=0;n&&o<t.length;o++)do n=e[r]===t[o];while(!n&&++r<e.length);return n}function p(e,t){for(var n=[],r=0,o=0;r<e.length;r++){for(var a=e[r];o<t.length&&a>t[o];)o++;(o===t.length||a<t[o])&&n.push(a)}return n}function _(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;){var a=e[r],i=t[o];a<i?r++:(a===i&&(n.push(a),r++),o++)}return n}function f(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;)e[r]<t[o]?n.push(e[r++]):e[r]===t[o]?(n.push(e[r++]),o++):n.push(t[o++]);for(;r<e.length;)n.push(e[r++]);for(;o<t.length;)n.push(t[o++]);return n}function g(e){return h(e.slice().sort())}function h(e){for(var t=!1,n=0;n<e.length-1;n++)e[n]===e[n+1]&&(t=!0);if(!t)return e;for(var r=[],o=0;o<e.length-1;o++)e[o]!==e[o+1]&&r.push(e[o]);return r.push(e[e.length-1]),r}function y(e){return Array.from(e).sort()}function C(e){return e.slice().sort()}function b(e,t,n){for(var r=null,o=0;!r&&o<e.length;o++)e[o]===t&&(r=e.slice(),r[o]=n,r=h(r.sort()));return r||e}function v(e){return[e]}function S(e){return e.length<1}function R(e,t,n){return e.slice(t,n)}i.emptySet=e,i.emptyList=l,i.filter=s,i.map=u,i.areEqual=c,i.addToSet=d,i.contains=m,i.subtract=p,i.intersect=_,i.joinUniq=f,i.sortAndDedupe=g,i.asSortedSet=y,i.sort=C,i.swapIn=b,i.singleElement=v,i.isEmpty=S,i.slice=R}),66);
__d("MAWMediaManagementTxns",["EBLogger","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWODSProxy","MAWSupportedDocumentTypes","MAWWriteMsgTxns","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaUtils","WAOdsEnums","WASortedLists","WATimeUtils","emptyFunction","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=o("MWFBLogger").MWMediaLogger().tags(["MAWMediaManagementTxns"]),h=r("gkx")("23924");function y(e,t,n,r){var a,i=n==null||t.type===o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(h||!o("MAWSupportedDocumentTypes").isAllowedType((a=n.validatedDocumentFileInfo)==null?void 0:a.filename));return o("MAWWriteMsgTxns").prepareMsgWriteData(e,t,r).then(function(e){return babelHelpers.extends({},e,{shouldDropDocument:i})})}function C(e,t,n,r,a){a===void 0&&(a=!1);var i={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},l=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),s=l.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(l.objectId):null;return R(e,n,r,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,i,s,void 0,a,void 0,t.accessibilitySummaryText)}function b(e,t,n,r,a,i,l){a===void 0&&(a=!1),l===void 0&&(l=!0);var s=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),u=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),c=u.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(u.objectId):null;return o("MAWDexieTable").dexieAll([L(e,n,r,c,void 0,a),o("MAWDbChunkTxns").hasMediaChunk(e,s)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,i,l,o)})}function v(e,t,n,r,a,i,l,s){a===void 0&&(a=!1),i===void 0&&(i=!1),s===void 0&&(s=!0);var u={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},c=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),d=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),m=d.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(d.objectId):null;return o("MAWDexieTable").dexieAll([S(e,n,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,u,m,void 0,a,t.accessibilitySummaryText),o("MAWDbChunkTxns").hasMediaChunk(e,c)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,l,s,o)})}function S(e,t,n,r,o,a,i,l,s,u,c){return u===void 0&&(u=!1),R(e,t.msgId,t.type,n,r,o,a,i,l,s,u,void 0,c).then(function(n){return L(e,t,n,l,void 0,u)})}function R(t,n,r,a,i,l,d,m,p,_,f,h,y){return f===void 0&&(f=!1),h===void 0&&(h=0),y===void 0&&(y=null),o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(t,a).then(function(C){var b=new Map(C==null?void 0:C.mediaEntries),v=x(d,p,_);if(v!=null&&b.set(n,v),C){var S;h>0&&g.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(a)),C.msgIds||g.mustfix("Media missing msgIds: media type=%s",C.mediaType),C.mediaType||g.mustfix("Media missing mediaType: type=%s ; msg type=%s",i,r);var L=babelHelpers.extends({},C,m,{accessibilitySummaryText:y!=null?y:void 0,mediaEntries:b,mediaType:(S=C.mediaType)!=null?S:i,msgIds:o("WASortedLists").addToSet(C.msgIds||o("WASortedLists").emptySet(),n)});return t.media.put(L).then(function(){return L})}else{var E=o("MAWMediaUtils").genHMACPlaintextHash(a),k=babelHelpers.extends({accessibilitySummaryText:y!=null?y:void 0,fbid:_!=null?_:void 0,hashedPlaintextHash:E,mediaEntries:b,mediaType:i,msgIds:o("WASortedLists").singleElement(n),objectId:p!=null?p:void 0,plaintextHash:a,size:l,ts:o("WATimeUtils").unixTime()},m);return t.media.add(k).then(function(e){return babelHelpers.extends({},k,{mediaId:e})}).catch(function(e){var C=o("WAErrorMessage").maybeGetMessageFromError(e);if(h>0)throw g.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry: plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),g.catching(e).MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry."]))),e;return g.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_MEDIA,key:"retry"}),R(t,n,r,a,i,l,d,m,p,_,f,h+1,y)})}})}function L(e,t,n,r,a,i){i===void 0&&(i=!1);var l=i?o("MAWDexieTable").dexieResolve():o("MAWDbMsgTxns").updateMediaId(e,t,n.mediaId,n.plaintextHash);return l.then(function(){return o("MAWMediaBackupTxns").linkMediaBackup(e,n.mediaId,t.msgId,r,a).then(function(){return n})})}function E(e,t,n,r,a,i,l){return r===void 0&&(r=!1),i===void 0&&(i=!0),o("EBLogger").EBLogger().tags(["restore","handleUnstoredDbMedia"]).DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Inserted media with plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(n.plaintextHash)),t.type!==o("MAWMsgType").MSG_TYPE.REVOKED&&!r&&i?o("MAWMediaAfterTxns").handleNewMediaAfterTxn(t,n,l,e,void 0,a).then(function(){return n}):o("MAWDexieTable").dexieResolve(n)}var k=function(t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n).then(function(e){if(e==null)throw g.mustfixThrow("Do not have the media message in db when attachHashToMediaMsg");return S(t,e,r,l,s,m,u,a,i,c,d)})},I=function(t,n,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=babelHelpers.extends({},e);return a.validatedAudioInfo!=null&&(n.validatedAudioInfo=babelHelpers.extends({},e.validatedAudioInfo,a.validatedAudioInfo)),a.validatedVideoInfo!=null&&(n.validatedVideoInfo=babelHelpers.extends({},e.validatedVideoInfo,a.validatedVideoInfo)),a.validatedImageInfo!=null&&(n.validatedImageInfo=babelHelpers.extends({},e.validatedImageInfo,a.validatedImageInfo)),a.validatedDocumentFileInfo!=null&&(n.validatedDocumentFileInfo=babelHelpers.extends({},e.validatedDocumentFileInfo,a.validatedDocumentFileInfo)),t.media.update(n.mediaId,n).then(r("emptyFunction"))}else g.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"])))})},T=function(t,n,r,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=a?e.mediaEntries.set(r,a):e.mediaEntries,i=babelHelpers.extends({},e,{mediaEntries:n});return t.media.update(i.mediaId,i)}else return g.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]))),o("MAWDexieTable").dexieResolve()})};function D(e,t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDexieTable").dexieAll([k(e,t,r,a,i,l,u.size,s,c,d,m),o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(e,r,n,u.type)]).then(function(e){var t=e[0];return t})}function x(e,t,n){var r,a=e;return a!=null&&t!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(r,t)),a!=null&&n!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(r,n)),a}function $(e,t,n){var r=new Map;return e.mediaEntries.forEach(function(e,a){var i=o("WAMediaUtils").decodeMediaEntryData(e),l=i.objectId===t?o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(i,n):e;r.set(a,l)}),r}function P(e,t,n,r,a){a===void 0&&(a=!0);var i=new Map;return t.forEach(function(e){var t,n=(t=i.get(e.hashedPlaintextHash))!=null?t:[];n.push(e),i.set(e.hashedPlaintextHash,n)}),o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,[].concat(Array.from(i.keys()))).then(function(l){var s=new Map(l.map(function(e){return[e.hashedPlaintextHash,e]})),u=new Map;t.forEach(function(e){var t=s.get(e.hashedPlaintextHash);if(e!=null){var n=x(e==null?void 0:e.entry,e==null?void 0:e.objectId,e==null?void 0:e.fbId);if(t){var r=n?t.mediaEntries.set(e.msgId,n):t.mediaEntries,a=babelHelpers.extends({},t,{mediaEntries:r,msgIds:o("WASortedLists").addToSet(t.msgIds,e.msgId)});s.set(e.hashedPlaintextHash,a)}else B(u,e,n)}});var c=new Map,d=new Map,m=Array.from(u.values()).filter(function(e){return N(e,c,d)});return o("MAWDexieTable").dexieAll([e.media.bulkAdd(m),e.media.bulkPut(Array.from(s.values()))]).then(function(){return M(e,[].concat(Array.from(i.keys())),i,n,r,a)})})}function N(e,t,n){if(e.objectId!=null){var r=t.get(e.objectId);if(r!=null&&r!==e.hashedPlaintextHash)return g.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""])),e.objectId,r,e.hashedPlaintextHash),!1}if(e.fbid!=null){var o=n.get(e.fbid);if(o!=null&&o!==e.hashedPlaintextHash)return g.MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""])),e.fbid,o,e.hashedPlaintextHash),!1}return e.objectId!=null&&t.set(e.objectId,e.hashedPlaintextHash),e.fbid!=null&&n.set(e.fbid,e.hashedPlaintextHash),!0}function M(e,t,n,r,a,i){return o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,t).then(function(t){return o("MAWDexieTable").dexieAll([F(e,t,n)]).then(function(){return i&&w(t,n,r,e,a),t})})}function w(e,t,n,a,i){e.forEach(function(e){var l=t.get(e.hashedPlaintextHash);l!=null&&!A(l)&&r("promiseDone")(o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(a.messages.where("msgId").anyOf(e.msgIds).toArray().then(function(t){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(t),l=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(t,n),hasMediaForUI:!1,hdTypes:r,media:e,transportKey:i});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,l)})))})}function A(e){return e.reduce(function(e,t){return e||t.isXMAShare},!1)}function F(e,t,n){var r=t.reduce(function(e,t){var r;return(r=n.get(t.hashedPlaintextHash))==null||r.filter(function(e){return e!=null&&!e.isXMAShare}).forEach(function(n){return e.set(n.msgId,t.mediaId)}),e},new Map);return o("MAWDbMsgTxns").bulkUpdateMediaId(e,r)}function O(e,t){var n,r,a=e?new Map([[t.msgId,e]]):new Map;return babelHelpers.extends({fbid:(n=t.fbId)!=null?n:void 0,hashedPlaintextHash:t.hashedPlaintextHash,mediaEntries:a,mediaType:t.mediaType,msgIds:o("WASortedLists").singleElement(t.msgId),objectId:(r=t.objectId)!=null?r:void 0,plaintextHash:t.plaintextHash,size:t.size,ts:o("WATimeUtils").unixTime()},t.mediaInfo)}function B(e,t,n){var r=e.get(t.hashedPlaintextHash);r==null?e.set(t.hashedPlaintextHash,O(n,t)):(n!=null&&r.mediaEntries.set(t.msgId,n),r.msgIds.push(t.msgId))}l.prepareMediaWriteData=y,l.handleUnstoredDbMediaCreation=C,l.handleUnstoredDbMediaLinking=b,l.handleUnstoredDbMedia=v,l.linkMedia=S,l.createOrUpdateMediaRow=R,l.attachHashToMediaMsg=k,l.updateMediaEntryWithValidatedMediaInfo=I,l.updateMediaWithEncodedMediaEntryData=T,l.attachHashAndSaveMedia=D,l.updateBackupFbidInMediaEntries=$,l.bulkLinkMedia=P,l.linkMessageAndMediaBackupForMediaList=M}),98);
__d("MAWMediaRetryInfo",[],(function(t,n,r,o,a,i){"use strict";var e=new Map;function l(t,n){e.set(t,n)}function s(t){return e.get(t)}function u(t){e.has(t)&&e.delete(t)}i.setRetriedMediaInfo=l,i.getRetriedMediaInfo=s,i.clearRetriedMediaInfo=u}),66);
__d("WAAPI",["cr:21048"],(function(t,n,r,o,a,i,l){"use strict";l.default=n("cr:21048")}),98);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EBLSResignCdnUrlDeferred","EBLogger","EchoMessage","EchoMessageMediaFieldUtils","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWEncodeMediaTransportProtocol","MAWFrontendMediaUtils","MAWGetMsgForProtocolMsgIdTxn","MAWHandleMediaDownloadApi","MAWIndexedDb","MAWJids","MAWJobDefinitions","MAWJobManager","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWSupportedDocumentTypes","MAWTransactionMode","WAAPI","WAArmadilloXMA.pb","WABase64","WAGetAgeBucketForMediaKeyTimestamp","WAGetStorageQplAnnotations","WAHashUtils","WAIsMediaExpiredError","WAJids","WAJobOrchestratorTypes","WAMediaUtils","WAStartMediaDownloadQplFlow","WATimeUtils","getErrorSafe","gkx","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O,B,W,q,U=o("EBLogger").EBLogger().tags(["restore"]);function V(e){var t=j(e);return t.then(function(t){var n=new Map;return e.forEach(function(e){var r=t.get(e),o=r==null?void 0:r.blobData;n.set(e,o)}),Promise.resolve(n)})}function H(e){return e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG?"image/jpeg":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG?"image/png":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER?"image/webp":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF?"image/gif":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4?"audio/mp4":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV?"audio/wav":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA?"xma":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}async function G(t,n,a){if(t.length===0)return Promise.resolve();var i=[],l=[],v=new Map,S=new Map;t.map(function(t){var n,a=t.mediaData,h=t.messageTimestamp,y=Q(a.plaintextHash),C=a.attachmentObjectId,b=a.attachmentType,R=a.backupEntFbid,L=a.directPath,E=a.filename,k=a.height,I=a.mediaContentType,T=a.mediaKeyTimestamp,D=a.mediaPlayableDuration,x=a.previewContentHeight,$=a.previewContentType,P=a.previewContentWidth,N=a.size,M=a.width,w=o("WAHashUtils").stringToPlaintextHash(y),A=o("MAWMediaUtils").genHMACPlaintextHash(w);l.push(A);var F=I!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(I,t.isXMA):$!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(H($)):null;if(F==null)return U.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null, msg id: ",""])),t.externalId),U.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null"]))),Promise.resolve();if(b===o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!o("MAWSupportedDocumentTypes").isAllowedType(E))return U.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - document extension is disallowed, msg id: ",""])),t.externalId),Promise.resolve();var O=t.mediaData.encryptedHash;if(O==null)return U.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null, msg id: ",""])),t.externalId),U.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null"]))),Promise.resolve();var B=t.mediaData.mediaKey;if(B==null)return U.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null, msg id: ",""])),t.externalId),U.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null"]))),Promise.resolve();var W=F.mediaType,q=F.serverMediaType,V=o("WAMediaUtils").stringToDeliveryObjectId(C),G=R!=null?o("WAMediaUtils").stringToBackupEntFbid(R):void 0,z=t.threadJId,j=X({filename:E,height:k,mediaPlayableDuration:D,mediaType:W,previewContentHeight:x,previewContentWidth:P,width:M});S.set(V,{filename:E,height:k,mediaPlayableDuration:D,mediaType:W,messageTimestamp:h,plaintextHash:w,previewContentHeight:x,previewContentWidth:P,serverMediaType:q,threadJId:z,width:M});var K=null;if(t.previewMediaData!=null)try{K=J(t.previewMediaData),K!=null&&K.objectId==null&&U.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["downloadableThumbnail was created without metadata, source: echo"])))}catch(e){var Z=r("getErrorSafe")(e);U.catching(Z).DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData, msg id: ",""])),t.externalId),U.catching(Z).MUSTFIX(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData"])))}if(O!=null){var ee=Y(y,O,B,L,T,q,E,G,V,K,N);i.push({entry:ee,fbId:G,hashedPlaintextHash:A,isXMAShare:t.isXMA,mediaInfo:j,mediaType:W,msgId:t.msgId,objectId:V,plaintextHash:w,size:N!=null?N:0})}var te=(n=v.get(A))!=null?n:[];te.push(t),v.set(A,te)});var R=a!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,L=await z(i,n,R),E=await V(l),k=[];E.forEach(function(e,t){var l=v.get(t);l==null||l.forEach(function(l){if(l!=null){if(e!=null){U.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["media for message: "," is already downloaded on the device"])),l.externalId);var s=L.find(function(e){return e.plaintextHash===l.mediaData.plaintextHash});if(s==null){U.DEBUG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message with mediaKey ",""])),l.mediaData.mediaKey);return}return K(s.msgIds).then(function(e){var t=e.filter(function(e){return o("MAWDbMsg").isMediaMsg(e)});if(t.length>0){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(t),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:l.threadJId,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(t,n),hasMediaForUI:!0,hdTypes:r,media:s,transportKey:"EncryptedBackups"}),i=o("MAWMediaUtils").annotateBridgeMediaForDisplay(a,t);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:i}]})}})}var u=S.get(o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId));if(!(l==null||u==null)){var c=u.filename,d=u.height,m=u.mediaPlayableDuration,p=u.mediaType,_=u.messageTimestamp,f=u.plaintextHash,g=u.previewContentHeight,v=u.previewContentWidth,R=u.serverMediaType,E=u.threadJId,I=u.width,T=o("WAJids").extractUserId(o("MAWJids").toUserJid(l.threadJId)),D=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(R,l.isXMA);if(D!=null){var x={attachmentObjectId:o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId),mediaType:D,messageId:l.externalId,messageTimeStamp:l.messageTimestamp,msgId:l.msgId,plaintextHash:f,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,threadId:T,threadJid:E},$=i.find(function(e){return e.hashedPlaintextHash===t}),P=$==null?void 0:$.entry;if(P==null){U.DEBUG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message, plaintextHash: ",", msg id: ",""])),o("WAHashUtils").sanitisePlaintextHash(o("WAHashUtils").stringToPlaintextHash(l.mediaData.plaintextHash)),l.externalId),U.MUSTFIX(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message"])));return}if(a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)return;var N=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:{author:l.author,chat:l.threadJId,externalId:l.externalId},triggerUIView:null});k.push(Z({author:l.author,directPath:l.mediaData.directPath,echoMsg:l.echoMsg,externalId:l.externalId,filename:c,hashedPlaintextHash:t,height:d,isXMA:l.isXMA,mediaPlayableDuration:m,mediaType:p,messageTimestamp:_,plaintextHash:f,previewContentHeight:g,previewContentWidth:v,threadJId:E,width:I},void 0,x,void 0,o("WAMediaUtils").decodeMediaEntryData(P),N))}}}})}),await Promise.all(k)}var z=(W=o("MAWIndexedDb")).makeMsgrTransactor({media:(q=o("MAWTransactionMode")).READWRITE,mediaBackup:q.READWRITE,messages:q.READWRITE},"restoreLinkMedias",function(e){return(function(t,n,r){return o("MAWMediaManagementTxns").bulkLinkMedia(e,t,n,"EncryptedBackups",r)})}),j=W.makeMsgrTransactor({chunk:q.READONLY},"getChunksByHash",function(e){return function(t){return o("MAWDbChunkTxns").maybeBulkGetChunksFromHash(e,t)}}),K=W.makeMsgrTransactor({messages:q.READONLY},"getMessagesForMsgIds",function(e){return function(t){return e.messages.where("msgId").anyOf(t).toArray()}});function Q(e){if(e.endsWith("="))for(var t="",n=0;n<e.length;n++){var r=e.charAt(n);if(r==="=")return t;t+=r}return e}function X(e){var t=e.height,n=e.mediaType,r=e.width,a=e.previewContentHeight,i=e.previewContentWidth,l=e.mediaPlayableDuration,s=e.filename;return{validatedAudioInfo:n==="Ptt"&&l!=null?{duration:ne(l),mimetype:o("MAWEncodeMediaTransportProtocol").AUDIO_WAV_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:n==="DocumentFile"?{filename:s,mimetype:o("MAWEncodeMediaTransportProtocol").FILE_MIME_TYPE}:null,validatedImageInfo:n==="Image"?{height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,width:r}:n==="Gif"||n==="Sticker"?{height:t,jpegThumbnailHeight:t,jpegThumbnailWidth:r,width:r}:null,validatedVideoInfo:n==="Video"?{duration:l,height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,mimetype:o("MAWEncodeMediaTransportProtocol").VIDEO_MIME_TYPE,width:r}:null}}function Y(e,t,n,r,a,i,l,s,u,c,d){var m=o("WABase64").decodeB64UrlSafe(e,!0),p=o("WABase64").decodeB64UrlSafe(t,!0),_=o("WABase64").decodeB64UrlSafe(n,!0);return o("WAMediaUtils").rawDataToMediaEntry({directPath:r,downloadableThumbnail:c!=null?c:void 0,fbid:s!=null?s:void 0,fileEncSha256:p,filename:l,fileSha256:m,mediaKey:_,mediaKeyTimestamp:a!=null?o("WATimeUtils").castToUnixTime(a):void 0,objectId:u!=null?u:void 0,serverMediaType:i,size:d!=null?d:void 0})}function J(e){var t=e.attachmentObjectId,n=e.directPath,r=e.encryptedHash,a=e.mediaKey,i=e.mediaKeyTimestamp,l=e.plaintextHash;if(r==null){U.MUSTFIX(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"])));return}else{var s=i!=null?o("WATimeUtils").castToUnixTime(i):void 0,u=a!=null?o("WAMediaUtils").castToMediaKey(o("WABase64").decodeB64UrlSafe(a,!0)):void 0,c=o("WABase64").decodeB64UrlSafe(l,!0),d=o("WABase64").decodeB64UrlSafe(r,!0);return{directPath:n,fileEncSha256:d,fileSha256:c,mediaKey:u,mediaKeyTimestamp:s,objectId:t}}}var Z=async function(t,n,a,i,l,s){var e,u,c,d,m,p;U.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["start media download from whatsapp infra. traceId: ",""])),n);var _=t.author,f=t.externalId,g=t.filename,h=t.hashedPlaintextHash,y=t.height,C=t.mediaPlayableDuration,b=t.mediaType,v=t.messageTimestamp,x=t.plaintextHash,$=t.previewContentHeight,P=t.previewContentWidth,N=t.threadJId,M=t.width,w={author:_,chat:N,externalId:f},A=s!=null?s:o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:w,triggerUIView:null});o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore",hash:x,status:r("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});var F=((e=(u=o("MAWMediaRetryInfo").getRetriedMediaInfo(f))==null?void 0:u.isXMA)!=null?e:!1)||((c=t==null?void 0:t.isXMA)!=null?c:!1),O=((d=o("MAWMediaRetryInfo").getRetriedMediaInfo(f))==null||(d=d.echoMsg)==null?void 0:d.serializationOrigin)||(t==null||(m=t.echoMsg)==null?void 0:m.serializationOrigin)||o("EchoMessage").EchoSerializationOriginType.UNKNOWN,B=r("gkx")("23960");if(A.addPoint("download_media_start",{bool:{isEBDownloadEnforced:a==null&&B,isRetryFromMI:a==null,isXMA:F,pathMismatch:i!==l.directPath},int:{mediaEntrySize:l.size},string:{oldDirectPath:(p=t==null?void 0:t.oldDirectPath)!=null?p:"",origin:O,restorationCdnUrl:i!=null?i:""}}),o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){A.addAnnotations(e)}),a!=null&&B)return U.DEBUG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["downloading media from MI directly. externalId ","."])),w.externalId),oe({decodedMediaEntry:l,isEBDownloadEnforced:B,mediaDownloadRequest:t,protocolMsgId:w,retryPayload:a});var W=o("WAMediaUtils").validateDecodedMediaEntryForDownload(l);if(!W.success){U.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. externalId ",". traceId: ",". error: ","."])),w.externalId,n,W.error),U.MUSTFIX(E||(E=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. error: ","."])),W.error),A.endFail("download_media_fail",{string:{failReason:W.error}});return}var q=await r("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:A,hash:x,mediaEntry:W.value});if(q.success){A.addPoint("download_media_end");var V=q.value,H=V.mimeType,G=V.plaintext;await o("MAWHandleMediaDownloadApi").handleMediaDownload(x,H,G,w),o("MAWMediaRetryInfo").clearRetriedMediaInfo(f);var z=X({filename:g,height:y,mediaPlayableDuration:C,mediaType:b,previewContentHeight:$,previewContentWidth:P,width:M});await te(h,z),U.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["media download complete. externalId ",". traceId: ",""])),w.externalId,n),A.endSuccess(),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore_success",hash:x,status:r("MAWMediaDownloadStatus").SUCCESS,type:"main"})}else{var j=q.error;if(o("WAIsMediaExpiredError").isMediaExpiredError(j)&&a)A.addPoint("eb_resign_requested"),A.endSuccess(),U.WARN(I||(I=babelHelpers.taggedTemplateLiteralLoose(["Retry download media as signature has expired and should be renewed. externalId ",". traceId: ",""])),w.externalId,n),await oe({decodedMediaEntry:l,isEBDownloadEnforced:!1,mediaDownloadRequest:t,protocolMsgId:w,retryPayload:a});else{U.DEBUG(T||(T=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: "," "," when downloading. Message timestamp: ",". traceId: ",""])),f,j,v,n),U.MUSTFIX(D||(D=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: ",""])),j);var K={string:{directPath:l.directPath,error:"media_download_failure",restorationCdnUrl:i!=null?i:""}};A.endFail(j,K),o("MAWMediaRetryInfo").clearRetriedMediaInfo(f),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:j,hash:x,status:o("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(j),type:"main"})}}},ee=W.makeMsgrTransactor({media:q.READONLY,mediaBackup:q.READONLY,messages:q.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(e){return(function(t,n,r){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,n.plaintextHash).then(function(a){if(a){U.DEBUG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["start resign cdn url through sproc"])));var i=ae(a,n.attachmentObjectId);return o("MAWDbMsgTxns").getMsgsByMsgIds(e,i).then(function(e){var i,l=e.find(function(e){return e.externalId===t});r.addPoint("resign_cdn_url_bridge_call",{bool:{isForwarded:(i=l==null?void 0:l.isForwarded)!=null?i:!1},int:{duplicateMsgsCount:e.length,msgXMAType:l==null?void 0:l.xmaMessageType,totalMediaEntries:a.mediaEntries.size},int_array:{duplicateXMATypes:e.map(function(e){var t;return(t=e.xmaMessageType)!=null?t:0})},string:{msgType:l==null?void 0:l.type},string_array:{duplicateMsgs:e.map(function(e){return e.externalId}),duplicateMsgTypes:e.map(function(e){return e.type})}}),o("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:n.attachmentObjectId,mediaType:n.mediaType,messageId:t,msgId:n.msgId,plaintextHash:n.plaintextHash,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:n.messageTimeStamp,threadId:n.threadId,threadJid:n.threadJid,traceId:r.getQPLAttrs().instanceKey}})})}else U.DEBUG($||($=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ",". traceId: ",""])),t,r.getQPLAttrs().instanceKey),U.MUSTFIX(P||(P=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ","."])),t),r.endFail("missing-media")})})}),te=W.makeMsgrTransactor({media:q.READWRITE,messages:q.READWRITE},"updateMediaWithDownloadedChunkBlob",function(e){return(function(t,n){return o("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(e,t,n)})});function ne(e){var t=Math.floor(e/1e3);return t>0?t:e}function re(e){return e==null?!1:e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY||e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION}async function oe(e){var t,n=e.decodedMediaEntry,a=e.isEBDownloadEnforced,i=e.mediaDownloadRequest,l=e.protocolMsgId,s=e.retryPayload,u=await o("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn(l);if(u.success===!0&&re(u.value.xmaMessageType))return U.DEBUG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Skipping media restore for expirable XMA. externalId ",". xmamessageType: ",""])),l.externalId,u.value.xmaMessageType),Promise.resolve();var c=l.externalId;o("MAWMediaRetryInfo").setRetriedMediaInfo(l.externalId,i);var d=((t=n.mediaKeyTimestamp)!=null?t:0)>1725105600,m={bool:{is_after_S441705_fix:d,isEBDownloadEnforced:a},int:{mediaKeyTimestamp:n.mediaKeyTimestamp},string:{externalId:c,mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(n.mediaKeyTimestamp),mediaType:s.mediaType,objectId:s.attachmentObjectId,restoreEntry:"EB",restoreMethod:"gql"}},p=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:l,triggerUIView:null});p.addAnnotations(m),U.DEBUG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["start restore media from backup. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(s.plaintextHash),c,p.getQPLAttrs().instanceKey);var _=n.mediaKey;if(_==null){U.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["media key is missing from media entry. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(s.plaintextHash),c,p.getQPLAttrs().instanceKey),p.endFail("missing-media-key");return}return U.DEBUG(A||(A=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [gql]. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(s.plaintextHash),c,p.getQPLAttrs().instanceKey),o("EBLSResignCdnUrlDeferred").eblsResignCdnUrlWithGraphQL({chatJid:l.chat,deliveryObjectId:s.attachmentObjectId,externalId:c,mediaKey:_,mediaType:s.mediaType,sortOrderMs:s.messageTimeStamp}).then(function(e){if(r("vulture")("zP4BquwZMLWLp2xHPcGqA0y9_YQ="),e.success===!1){U.DEBUG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". hash: ",". externalId ",""])),e.error,o("WAHashUtils").sanitisePlaintextHash(s.plaintextHash),c),p.endFail(e.error);return}U.DEBUG(O||(O=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. hash: ",". externalId ",""])),o("WAHashUtils").sanitisePlaintextHash(s.plaintextHash),c);var t=o("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:s.attachmentObjectId,msgId:s.msgId,plaintextHash:s.plaintextHash,restorationCdnUrl:e.value,scheduleConfig:{priority:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW},traceId:p.getQPLAttrs().instanceKey});return o("MAWJobManager").getJobManager().fireAndForget(t)}).catch(function(e){var t=r("getErrorSafe")(e);U.catching(t).MUSTFIX(B||(B=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error"]))),p.endFail("runtime-error",{string:{restoreError:t.toString()}})})}function ae(e,t){var n,r=[];return(n=e.mediaEntries)==null||n.forEach(function(e,n){var a=o("WAMediaUtils").decodeMediaEntryData(e);a.objectId===t&&r.push(n)}),r}l.downloadMediaAndWriteToMediaStore=G,l.getBase64WithoutPadding=Q,l.getMediaInfo=X,l.constructMediaEntry=Y,l.constructRawDownloadableThumbnail=J,l.handleDownloadMedia=Z,l.invokeRestoreAccessCheckSprocToDownloadAttachment=ee}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EBLogger","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWEBRestoreTrackingUtils","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("EBLogger").EBLogger().tags(["restore"]),g=n("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function h(t,n){var r=n==null?f:f.tags([n]),a=t.contentType;switch(a){case o("EchoMessage").EchoMessageContentType.TEXT:return t.xContentType===o("EchoMessage").EchoXMessageContentType.BUMP?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE):o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.TEXT);case o("EchoMessage").EchoMessageContentType.MEDIA:return t.receiverFetchId!=null&&t.receiverFetchData!=null?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH):t.mediaData==null?o("WAResultOrError").makeError("media_mandatory_fields_missing"):o("WAResultOrError").makeResult(y(t.mediaData));case o("EchoMessage").EchoMessageContentType.PLACEHOLDER:return t.contentSubtype===o("EchoMessage").EchoMessageContentSubtype.UNSEND?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.REVOKED):(r.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""])),o("EchoMessage").EchoMessageContentType.getName(a),t.xContentType!=null?o("EchoMessage").EchoXMessageContentType.getName(t.xContentType):"unknown",o("EchoMessage").EchoMessageContentSubtype.getName(t.contentSubtype),t.serializationOrigin!=null?o("EchoMessage").EchoSerializationOriginType.getName(t.serializationOrigin):"unknown"),o("WAResultOrError").makeError("unsupported_message_type"));case o("EchoMessage").EchoMessageContentType.XMA:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.XMA);case o("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.CIPHERTEXT);default:return r.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",""])),o("EchoMessage").EchoMessageContentType.getName(a)),o("WAResultOrError").makeError("unsupported_message_type")}}function y(e){switch(e.attachmentType){case o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return o("MAWMsgType").MSG_TYPE.IMAGE;case o("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return o("MAWMsgType").MSG_TYPE.STICKER;case o("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return o("MAWMsgType").MSG_TYPE.VIDEO;case o("EchoMessageMediaFieldUtils").AttachmentType.GIF:return o("MAWMsgType").MSG_TYPE.GIF;case o("EchoMessageMediaFieldUtils").AttachmentType.PTT:return o("MAWMsgType").MSG_TYPE.PTT;case o("EchoMessageMediaFieldUtils").AttachmentType.XMA:return o("MAWMsgType").MSG_TYPE.XMA;case o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}}function C(e,t,n,r,a,i){var l,s=e.from;if(s==null)return f.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Author info is missing from msg: ",""])),r),o("WAResultOrError").makeError("author_missing");var d=h(e,a);if(d.success===!1)return o("WAResultOrError").makeError(d.error);if(d==null)return o("WAResultOrError").makeError("unsupported_message_type");var m=d.value;if((l=e.isTombstoned)!=null&&l)return o("WAResultOrError").makeError("message_tombstoned");switch(m){case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return k(e,t,n,s,m,r,a,i);case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return b(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.XMA:return S(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("WAResultOrError").makeResult(D(e,t,n,s,m,r));case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return R(e,t,n,s,m,r);default:return f.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Encountered unsupported media type: ",""])),m),o("WAResultOrError").makeError("unsupported_message_type")}}function b(e,t,n,r,o,a){var i=I(e,t,n,r,o,a);return v(o,i)}function v(e,t){switch(e){case o("MAWMsgType").MSG_TYPE.IMAGE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.IMAGE}));case o("MAWMsgType").MSG_TYPE.STICKER:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.STICKER}));case o("MAWMsgType").MSG_TYPE.VIDEO:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.VIDEO}));case o("MAWMsgType").MSG_TYPE.GIF:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.GIF}));case o("MAWMsgType").MSG_TYPE.PTT:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.PTT}));case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}));default:return f.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unsupported media message type: ",""])),e),o("WAResultOrError").makeError("unsupported_media_type")}}function S(e,t,n,r,a,i){var l;if(((l=e.xmaData)==null?void 0:l.xmaTargetType)==null)return f.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Mandatory XMA Data missing for XMA message: ",""])),i),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var s=e.xmaData.xmaTargetType,u=I(e,t,n,r,a,i),c=babelHelpers.extends({},u,{type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(s)}),d=e.text;return d!=null&&(c.msgContent={content:d}),o("WAResultOrError").makeResult(c)}function R(e,t,n,r,a,i){if(e.receiverFetchData==null)return f.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Mandatory receiver fetch data missing for receiver fetch message: ",""])),i),o("WAResultOrError").makeError("receiver_fetch_mandatory_fields_missing");var l=I(e,t,n,r,a,i);return o("WAResultOrError").makeResult(babelHelpers.extends({},l,{receiverFetchId:e.receiverFetchId,type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}))}function L(e){if(e!=null)switch(e){case o("EchoMessage").MessageTextSize.SMALL:return 1;case o("EchoMessage").MessageTextSize.MEDIUM:return 2;case o("EchoMessage").MessageTextSize.LARGE:return 3;default:return}}function E(e){return e.text==null?null:e.editHistory.length===0?e.text:e.editHistory.sort(function(e,t){return e.timestamp-t.timestamp})[0].text}function k(e,t,n,r,a,i,l,s){var u=l==null?f:f.tags([l]),c=s==="first_edit_content"?E(e):e.text;if(c==null)return o("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{empty_content_msg_type:a}},pointName:"unstored_text_message_empty",traceId:l}),u.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",", type: ",""])),i,a),o("WAResultOrError").makeError("text_message_content_empty");var d=I(e,t,n,r,a,i,l);if(a===o("MAWMsgType").MSG_TYPE.REVOKED)return c!=null&&(d.msgContent={content:c}),e.revokeSentTimestampMs!=null&&(d.originalTs=o("WATimeUtils").castToUnixTime(e.revokeSentTimestampMs)),o("WAResultOrError").makeResult(babelHelpers.extends({},d,{revokedExternalId:o("WAStanzaUtils").toStanzaId("0"),type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:e.revokeUnsentTimestampMS!=null?o("WATimeUtils").castToUnixTime(e.revokeUnsentTimestampMS):d.ts}));if(a===o("MAWMsgType").MSG_TYPE.CIPHERTEXT)return o("WAResultOrError").makeResult(babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}));var m=babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.TEXT});return o("WAResultOrError").makeResult(babelHelpers.extends({},m,{editCount:Math.max(e.editHistory.length-1,0),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize}))}function I(e,t,n,r,a,i,l){var s=T(r,n),u={ack:s===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s,externalId:i,groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:e.isForwarded,sortOrderMs:e.sortOrderMs,threadJid:t,ts:o("WATimeUtils").castToUnixTime(e.displayTimestampMs/1e3),type:a};if(e.authoritativeTimestampMs!=null?u.serverTs=o("WATimeUtils").castToUnixTime(e.authoritativeTimestampMs/1e3):u.serverTs=o("WATimeUtils").castToUnixTime(e.sortOrderMs/1e3),e.quoteData!=null){var c=o("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(e,n);c!=null&&(u.quote=c,u.quoteExternalId=c.content.externalId)}return u}function T(e,t){var n=o("MAWJids").toUserJid(e.localKey);return n===t?o("WAJids").AUTHOR_ME:n}function D(e,t,n,r,a,i){var l=I(e,t,n,r,a,i);return babelHelpers.extends({},l,{type:o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}l.MAWRestoreType=g,l.getDbMsgTypeFromEchoMessage=h,l.getUnstoredDbMessageFromEchoMessage=C,l.resolveAuthorFromEchoAddress=T}),98);
__d("MAWRepliesRestoreUtils",["FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e=["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"],s,u;function c(e,t){if(t==null||!o("MAWMsgType").isQuotedMsgType(t.type))return e;var n={author:t.author,externalId:t.externalId,ts:t.ts,type:t.type},r={content:n,remoteJid:null};return babelHelpers.extends({},e,{quote:r})}function d(e,t){if(e.quoteData!=null&&e.quoteData.quoteMessageId!=null&&e.quoteData.quoteMessageSender!=null){var n,r={author:o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(e.quoteData.quoteMessageSender,t),externalId:(n=e.quoteData)==null?void 0:n.quoteMessageId,ts:e.displayTimestampMs,type:o("MAWMsgType").MSG_TYPE.TEXT};return{content:r,remoteJid:null}}else o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""])),e.messageId);return null}var m=o("MAWIndexedDb").makeMsgrTransactor({chunk:(u=o("MAWTransactionMode")).READONLY,media:u.READONLY,messages:u.READWRITE,threads:u.READWRITE,xma:u.READONLY},"updateQuoteDataForReplyMessages",function(e){return(function(t,n,r){n==null||n.addPoint("replies_restore_start");var a=t.restoredMsgsData;if(a){var i=a.existingMsgs,l=a.newlyAddedMsgs,s=l.concat(i);return o("MAWDexieTable").dexieAll(s.map(function(t){return o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,t.threadJid,t).then(function(e){var n=[];return t.quoteExternalId!=null&&n.push(t),e!=null&&n.push.apply(n,e),n})})).then(function(t){var n=t.flat();return p(e,n,r)}).then(function(e){return n==null||n.addPoint("replies_restore_end",{int:{replies:e}}),e})}return o("MAWDexieTable").dexieResolve(0)})});function p(e,t,n){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=_(t);if(t.threadJid!=null)return o("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(e,n,t.threadJid).then(function(e){return babelHelpers.extends({},e,{msgId:t.msgId,originalTs:t.originalTs,protocolMsgId:t.protocolMsgId,rowId:t.rowId,threadJid:t.threadJid,unsendMsgContentDeleteTs:t.unsendMsgContentDeleteTs})});r("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(e){return e.filter(Boolean).filter(function(e){return e.quote!=null})}).then(function(e){return e.map(function(e){return e.source="eb_restore",e})}).then(function(t){return e.messages.bulkPut(t).then(function(r){return t.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){n!==!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(e){var n;return(n=t==null?void 0:t.length)!=null?n:0})})}function _(t){var n=t.msgId,r=t.originalTs,o=t.rowId,a=t.threadJid,i=t.unsendMsgContentDeleteTs,l=babelHelpers.objectWithoutPropertiesLoose(t,e);return l}l.addQuoteDataToReplyMessage=c,l.getQuoteDataFromEchoMessage=d,l.updateQuoteDataForReplyMessages=m,l.enhanceAndPersistReplyMessagesWithQuoteData=p}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(e,t,r){r==null||r.addPoint("reactions_restore_start");var o=e.echoMsgMap,a=e.restoredMsgsData,i=0;if(a){var l=a.existingMsgs,s=a.newlyAddedMsgs,u=s.concat(l),c=a.threadJid,d=u.filter(function(e){var t=o.get(e.externalId);return y(o,e)&&t!=null&&C(t)});if(d.length===0)return(f||(f=n("Promise"))).resolve();var m=d.flatMap(function(e){var n=o.get(e.externalId),r=S(a.threadJid,t,e.externalId,e.msgId,e.author,n);return r.map(function(e){return{chatJid:c,unstoredReaction:e}})});return m.length===0?(f||(f=n("Promise"))).resolve():h(m).then(function(e){i+=m.length,r==null||r.addPoint("reactions_restore_end",{int:{reactions:i}})})}return(f||(f=n("Promise"))).resolve()}var h=o("MAWIndexedDb").makeMsgrTransactor({groupInfo:(_=o("MAWTransactionMode")).READWRITE,messages:_.READWRITE,reactions:_.READWRITE,threads:_.READWRITE},"restoreWriteReactionsToDb",function(e){return(function(t){return o("MAWBulkWriteReactionsTxns").prepareReactionsData(e,t).then(function(t){return o("MAWBulkWriteReactionsTxns").bulkWriteReactions(e,t)})})});function y(t,n){var r=t.get(n.externalId);return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]))),!1):o("WAJids").isAuthorSystem(n.author)?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]))),!1):o("MAWAuthor").getAuthorUserJid(n.author)==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]))),!1):!0}function C(e){return e.reactions!=null&&e.reactions.length!==0&&e.reactionXOfflineThreadingIds!=null&&e.reactionXOfflineThreadingIds.length!==0&&e.reactionAuthoritativeTimestampMs!=null&&e.reactionAuthoritativeTimestampMs.length!==0}function b(e,t,n){return(e==null?void 0:e.length)===0?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]))),!1):t==null?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]))),!1):n==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]))),!1):!0}function v(e,t,n){return(e||[]).map(function(e,r){return n==null||t==null||(n==null?void 0:n.length)<=r||(t==null?void 0:t.length)<=r?(o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]))),[]):[e,t[r],n[r]]})}function S(e,t,n,r,a,i){var l=o("MAWAuthor").getAuthorUserJid(a);if(i==null||l==null)return[];var s=i.reactionAuthoritativeTimestampMs,u=s===void 0?[]:s,c=i.reactionXOfflineThreadingIds,d=c===void 0?[]:c,m=i.reactions;return v(m,d,u).filter(function(e){var t=e[0],n=e[1];return n!=null&&b(t.displayName,n.displayName,o("MAWAuthor").getAuthorUserJid(a))}).map(function(a){var i=a[0],s=a[1],u=a[2],c=i.displayName,d=o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(i,t),m={ack:d===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,author:d,externalId:o("WAStanzaUtils").toStanzaId(s.displayName||""),groupingKey:c,reaction:c,reactToAuthor:l,reactToExternalId:n,senderTimestampMs:null,threadJid:e,ts:o("WATimeUtils").castToUnixTime(Number(u.displayName)/1e3)};return r!=null?babelHelpers.extends({},m,{reactToMsgId:r}):m})}l.writeEchoReactionsToReactionsStore=g,l.getReactionsForReactionStore=S}),98);
__d("MAWMessageParseError",[],(function(t,n,r,o,a,i){"use strict";var e=(function(e){function t(t){var n;return n=e.call(this,t)||this,n.name="MAWMessageParseError",n.message=t,n}return babelHelpers.inheritsLoose(t,e),t})(babelHelpers.wrapNativeSuper(Error));i.MAWMessageParseError=e}),66);
__d("WAMessageKey",["WAGlobals","WAJids","WAStanzaUtils","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e===o("WAJids").AUTHOR_ME||e==o("WAGlobals").getMyUserJid()}function s(t,n,a){if(a==null)throw r("err")("messageKey is null");var i=a.id,l=a.remoteJid;if(i==null)throw r("err")("messageKey.id is null");if(l==null)throw r("err")("messageKey.remoteJid is null");var s=o("WAJids").interpretAndValidateJid(l);if(s.jidType==="unknown")throw r("err")("messageKey.remoteJid is invalid");var u,c=o("WAJids").AUTHOR_ME;if(s.jidType==="group")if(u=s.groupJid,e(n)&&a.fromMe===!0)c=o("WAJids").AUTHOR_ME;else if(a.fromMe==!0)c=n;else{var d=a.participant;if(d==null)throw r("err")("key.participant is null");var m=o("WAJids").interpretAndValidateJid(d);if(m.jidType==="msgrUser")c=m.userJid;else throw r("err")("key.participant is invalid")}else if(s.jidType==="msgrUser"||s.jidType==="msgrDevice"){var p=o("WAJids").interpretAndValidateJid(t);if(p.jidType!=="msgrUser")throw r("err")("expected user type jid.");u=p.userJid,e(n)?a.fromMe===!0?c=o("WAJids").AUTHOR_ME:c=p.userJid:a.fromMe===!0&&(c=p.userJid)}else throw r("err")("Unsupported jidtype type");return{chat:u,author:e(c)?o("WAJids").AUTHOR_ME:c,externalId:o("WAStanzaUtils").toStanzaId(i)}}l.extractProtocolMessageId=s}),98);
__d("WAParseConsumerMessagePollCreation",["WAGlobals","WAHex","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){var a={unstoredMsg:{type:o("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:o("WAHex").bytesToBuffer(e),subtype:"pollCreationMessage"},id:t.id,ts:t.ts,sentTs:t.sentTs,serverTs:t.serverTs,ack:t.ack,reportingMeta:n},unstoredMedia:null,unstoredQuotedMedia:null};if(!r||!o("WAGlobals").getConfig().isPollsEnabled())return a;var i=r.encKey,l=r.name,s=r.options,u=r.selectableOptionsCount,c=t.ack,d=t.id,m=t.ts;if(i==null||l==null||u==null)return a;var p=s.map(function(e){return e.optionName}).filter(Boolean);return{unstoredMsg:{ack:c,id:d,ts:m,type:o("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE},unstoredGroupPollCreateInfo:{encKey:i,name:l,selectableOptionsCount:u,options:p},unstoredMedia:null,unstoredQuotedMedia:null}}l.default=e}),98);
__d("WAParseConsumerMessagePollUpdate",["WAGlobals","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){var a=t.ack,i=t.id,l=t.ts;return r==null||!o("WAGlobals").getConfig().isPollsEnabled()?{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}:{unstoredMsg:{ack:a,id:i,ts:l,type:o("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredGroupPollUpdateInfo:{pollUpdateMessage:r,type:o("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredMedia:null,unstoredQuotedMedia:null}}l.default=e}),98);
__d("WAParseProtocolUtils",["WAGlobals","WALogger","WALongInt","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){var n=c(t,e.serverTs),r=n==null?void 0:n.expirationTs,o=n==null?void 0:n.deleteTs,a=n==null?void 0:n.ephemeralSetting;return{expirationTs:r,deleteTs:o,ephemeralSetting:a}}function u(e,t){var n=d(t);return n!=null&&(e.reportingMeta=n),n}function c(e,t){var n,r,a=e==null||(n=e.chatEphemeralSetting)==null?void 0:n.ephemeralExpiration,i=e==null||(r=e.chatEphemeralSetting)==null?void 0:r.ephemeralSettingTimestamp;if(a==null||i==null||a===0)return null;var l=o("WATimeUtils").castToUnixTime(t+o("WAGlobals").getDependencies().ephemeralMaxDeletionWindowForUnseenMessage()),s=l,u=null;try{var c=o("WALongInt").numberOrThrowIfTooLarge(i)/1e3;u=o("WATimeUtils").castToUnixTime(c)}catch(e){return null}return{expirationTs:l,deleteTs:s,ephemeralSetting:{expirationTs:a,updatedTs:u}}}function d(t){var n=t==null?void 0:t.frankingVersion;return n!=null&&n!==0&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unsupported franking version ",""])),n),{frankingKey:void 0,frankingTag:void 0,frankingVersion:n,reportingContent:void 0,reportingTag:void 0}}l.parseEphemerality=s,l.enhanceReportingMeta=u}),98);
__d("WAParseConsumerMessageProtocol",["WACommon.pb","WAConsumerApplication.pb","WAGlobals","WAHex","WAJids","WALogger","WAMediaTransport.pb","WAMessageKey","WAMsgType","WAParseConsumerMessagePollCreation","WAParseConsumerMessagePollUpdate","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassUtils","WAResultOrError","WAStanzaUtils","WATimeUtils","decodeProtobuf","err","maybeConvertMessageTextMentionsV2ToV1"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=90*o("WATimeUtils").DAY_SECONDS,c=1,d=0,m=1,p=o("WAGlobals").getConfig().armadilloWebProcessFutureproof()?m+1:m;function _(t,n,a,i,l,c){var d,m,p,_,f=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAConsumerApplication.pb").ConsumerApplicationSpec,n),g=(d=f.payload)==null||(d=d.applicationData)==null||(d=d.revoke)==null||(d=d.key)==null?void 0:d.id;if(g!=null)return{unstoredMsg:{type:o("WAMsgType").MSG_TYPE.REVOKED,id:a.id,ts:a.ts,sentTs:a.sentTs,serverTs:a.serverTs,ack:a.ack,reportingMeta:a.reportingMeta,revokedExternalId:o("WAStanzaUtils").toStanzaId(g),unsendMsgContentDeleteTs:null,msgContent:null,ebTimestampMs:c},unstoredMedia:null,unstoredQuotedMedia:null};var h=(l==null?void 0:l.isForwarded)||!1,k=o("WAParseProtocolUtils").parseEphemerality(a,l),I=k.deleteTs,T=k.ephemeralSetting,D=k.expirationTs;if(T!=null&&(T.expirationTs<0||T.expirationTs>u)){var x=o("WAJids").interpretAndValidateJid(t),$=x.jidType,P=T.expirationTs;o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["WAParseConsumerMessageProtocol - ephemeralSetting duration is invalid ",", jidType: ",""])),P,$)}var N=o("WAParseProtocolUtils").enhanceReportingMeta(a,l),M=(m=C(l))!=null?m:void 0,w=(p=f.payload)==null?void 0:p.content;if(!w)return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};var A=(_=f.metadata)==null?void 0:_.specialTextSize,F=L(w),O={contentTypeForLogging:F,unstoredMsg:{type:o("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:o("WAHex").bytesToBuffer(i),subtype:null},id:a.id,ts:a.ts,sentTs:a.sentTs,serverTs:a.serverTs,ack:a.ack,reportingMeta:N},unstoredMedia:null,unstoredQuotedMedia:null},B=function(t){return babelHelpers.extends({},O,{unstoredMsg:babelHelpers.extends({},O.unstoredMsg,{msgContent:babelHelpers.extends({},O.unstoredMsg.msgContent,{subtype:t})})})},W=(function(){try{switch(F){case"messageText":{var e,n=w[F]&&r("maybeConvertMessageTextMentionsV2ToV1")(w[F]);if(n==null)throw r("err")("consumerMessage has no messageText");var u=((e=n.commands)==null?void 0:e.some(function(e){return e.commandType===o("WACommon.pb").COMMAND_COMMAND_TYPE.AI}))===!0;if(u&&!o("WAGlobals").getConfig().isMetaAiInvocationMessageRenderEnabled())return B("metaAiMessage");if(o("WAParseReadOnlyMetadataDataclassUtils").isNoteMention(l))return B("noteMention");if(n.text==null)throw r("err")("consumerMessage has no messageText");return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:n.text,mentionedJids:n.mentionedJid.map(o("WAJids").validateUserJid).filter(Boolean),commands:n.commands},quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h},a,{specialTextSize:A,ebTimestampMs:c}),unstoredMedia:null,unstoredQuotedMedia:null}}case"reactionMessage":return{unstoredMsg:y(t,a,w[F]),unstoredMedia:null,unstoredQuotedMedia:null};case"imageMessage":{var d=b(w,a.ts);return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.IMAGE,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,mediaId:d.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:d,unstoredQuotedMedia:null}}case"videoMessage":{var m,p,_,f,g=w[F];if(g==null)throw r("err")("consumerMessage has no videoMessage");var C=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").VideoTransportSpec,g==null||(m=g.video)==null?void 0:m.payload),L=C==null||(p=C.integral)==null||(p=p.transport)==null||(p=p.ancillary)==null?void 0:p.mimetype,k=(C==null||(_=C.ancillary)==null?void 0:_.gifPlayback)===!0&&L==="image/gif",x=o("WAParseMediaTransportProtocol").parseVideoMsg(C,a.ts,k);if(x==null)throw r("err")("consumerMessage has no video media info");if(o("WAParseReadOnlyMetadataDataclassUtils").isPowerUp(l)&&((f=g.caption)==null?void 0:f.text)!=null){var $;return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:($=g.caption)==null?void 0:$.text,mentionedJids:g.caption.mentionedJid.map(o("WAJids").validateUserJid).filter(Boolean)},quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h},a,{specialTextSize:A,ebTimestampMs:c}),unstoredMedia:null,unstoredQuotedMedia:null}}return{unstoredMsg:k?babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.GIF},a,{quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N,mediaId:x.plaintextHash}):babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.VIDEO},a,{quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,mediaId:x.plaintextHash}),unstoredMedia:x,unstoredQuotedMedia:null}}case"audioMessage":{var P=v(w,a.ts);return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.PTT,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,mediaId:P.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:P,unstoredQuotedMedia:null}}case"stickerMessage":{var W,q,U=S(w),V=o("WAParseMediaTransportProtocol").parseStickerMsg(U,a.ts),H=((W=U.integral)==null?void 0:W.receiverFetchId)!=null||((q=U.ancillary)==null?void 0:q.receiverFetchId)!=null;if(V==null){if(H){var G=o("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(U);if(G==null)throw r("err")("consumerMessage has no sticker receiver fetch info");return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.RECEIVER_FETCH,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N},a,{ebTimestampMs:c}),unstoredMedia:null,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:G}}throw r("err")("consumerMessage has no sticker media info")}return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.STICKER,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N,mediaId:V.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:V,unstoredQuotedMedia:null}}case"documentMessage":{if(o("WAGlobals").getConfig().isDocumentReceiveEnabled()){var z=R(w,a.ts);return{unstoredMsg:babelHelpers.extends({type:o("WAMsgType").MSG_TYPE.DOCUMENT_FILE,quote:M,expirationTs:D,deleteTs:I,ephemeralSetting:T,isForwarded:h,reportingMeta:N,mediaId:z.plaintextHash},a,{ebTimestampMs:c}),unstoredMedia:z,unstoredQuotedMedia:null}}return O}case"groupInviteMessage":return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null,unstoredIncomingGroupInvite:E(a,w)};case"editMessage":{var j,K=w[F],Q=K==null?void 0:K.message,X=Q==null?void 0:Q.text,Y=K==null||(j=K.key)==null?void 0:j.id;if(K==null||Q==null||X==null)throw r("err")("consumerMessage with editMessage type has no editMessage");if(Y==null)throw r("err")("consumerMessage with editMessage type has no original Msg External Id.");var J=o("WAStanzaUtils").toStanzaId(Y);return{unstoredEditMsg:{type:o("WAMsgType").MSG_TYPE.EDIT_ACTION,editMsgContent:{content:X,mentionedJids:Q.mentionedJid.map(o("WAJids").validateUserJid).filter(Boolean),commands:Q.commands},originalMsgExternalId:J,id:a.id,ts:a.ts,sentTs:a.sentTs,serverTs:a.serverTs,ack:a.ack,reportingMeta:N,specialTextSize:A},unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}case"pollCreationMessage":return r("WAParseConsumerMessagePollCreation")(i,a,N,w[F]);case"pollUpdateMessage":return r("WAParseConsumerMessagePollUpdate")(i,a,N,w[F]);case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return O}}catch(e){return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["parseConsumerMessageProtocol error :",""])),e),{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}})();return babelHelpers.extends({},W,{contentTypeForLogging:F})}function f(e){if(o("WAJids").isAuthorSystem(e))throw r("err")("Got system author");return e}var g=30;function h(e){return e==null?o("WAResultOrError").makeResult(null):e.length>g?o("WAResultOrError").makeError("invalid-reaction-text-length"):o("WAResultOrError").makeResult(e)}function y(e,t,n){if(n==null)throw r("err")("consumerMessage has no reactionMessage");var a=f(t.id.author),i=o("WAMessageKey").extractProtocolMessageId(e,a,n.key),l=n.groupingKey,s=n.senderTimestampMs,u=n.text,c=h(u);if(!c.success)throw r("err")('"'+(u!=null?u:"")+'" is not a valid reaction ['+c.error+"]");return{type:o("WAMsgType").MSG_TYPE.REACTION,ack:t.ack,id:t.id,reactToExternalId:i.externalId,reactToAuthor:i.author,reaction:c.value,groupingKey:l,ts:t.ts,senderTimestampMs:s}}function C(e){var t,n,a,i=e==null||(t=e.quotedMessage)==null?void 0:t.stanzaId,l=e==null||(n=e.quotedMessage)==null?void 0:n.participant,s=e==null||(a=e.quotedMessage)==null?void 0:a.remoteJid,u=l!=null?o("WAJids").interpretAndValidateJid(l):null,c;if((u==null?void 0:u.jidType)==="msgrUser"&&u.userJid===o("WAGlobals").getMyUserJid()?c=o("WAJids").AUTHOR_ME:(u==null?void 0:u.jidType)==="msgrUser"?c=u.userJid:c=o("WAJids").AUTHOR_ME,i==null)return null;var d={type:o("WAMsgType").MSG_TYPE.UNAVAILABLE,author:c,externalId:o("WAStanzaUtils").toStanzaId(i),ts:null};if(s!=null){var m=o("WAJids").interpretAndValidateJid(s);if(m.jidType==="group")return{remoteJid:m.groupJid,content:d};throw r("err")("not supported")}else return{remoteJid:null,content:d}}function b(e,t){var n,a=e.imageMessage;if(a==null)throw r("err")("consumerMessage has no imageMessage");return o("WAParseMediaTransportProtocol").decodeImageTransport(a==null||(n=a.image)==null?void 0:n.payload,t,"image")}function v(e,t){var n,a=e.audioMessage;if(a==null)throw r("err")("consumerMessage has no audioMessage");var i=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").AudioTransportSpec,a==null||(n=a.audio)==null?void 0:n.payload),l=o("WAParseMediaTransportProtocol").parseAudioMsg(i,(a==null?void 0:a.ptt)||!1,t);if(l==null)throw r("err")("consumerMessage has no audio media info");return l}function S(e){var t,n=e.stickerMessage;if(n==null)throw r("err")("consumerMessage has no stickerMessage");return o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").StickerTransportSpec,n==null||(t=n.sticker)==null?void 0:t.payload)}function R(e,t){var n,a=e.documentMessage;if(a==null)throw r("err")("consumerMessage has no documentMessage");var i=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").DocumentTransportSpec,a==null||(n=a.document)==null?void 0:n.payload),l=a==null?void 0:a.fileName,s=o("WAParseMediaTransportProtocol").parseDocumentMsg(i,l,t);if(s==null)throw r("err")("consumerMessage has no document media info");return s}function L(e){var t=Object.keys(e).filter(function(e){return e!=="$$unknownFieldCount"});if(t.length!==1)throw r("err")(JSON.stringify(e)+" consumerMessage payload content should have exactly one field, instead found "+JSON.stringify(t));return t[0]}function E(e,t){var n=t.groupInviteMessage;if(n==null)throw r("err")("consumerMessage has no GroupInvite Data");return babelHelpers.extends({ack:e.ack,author:e.id.author,externalId:e.id.externalId,ts:e.ts},n)}l.MINIMAL_MEDIA_DURATION=c,l.DEFAULT_FILE_SIZE=d,l.SUPPORTED_TYPES_VERSION=p,l.parseConsumerMessageProtocol=_,l.interpretAsNonSystemAuthor=f,l.validReactionMessageText=h,l.parseReactionMessage=y,l.parsedQuotedConsumerMessage=C,l.parseOneOfContentType=L}),98);
__d("WAParseMediaTransportProtocol",["WAHashUtils","WALogger","WALongInt","WAMedia","WAMediaHdType","WAMediaTransport.pb","WAMediaUtils","WAMsgMap","WAParseConsumerMessageProtocol","WAProgressiveJpegGetScanLengths","WATimeUtils","decodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n,r,a){var i,l,c,d,m,p,_,f,g,h,y,C,b,v;if(!((i=t.integral)!=null&&i.transport))return null;var S=(l=t.integral)==null?void 0:l.transport;if(o("decodeProtobuf").getUnknownFields(S.integral)!=null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["There is unknown fileds in integral of VideoTransport"]))),null;var R=(c=S.integral)==null?void 0:c.fileSha256;if(!R)return r||o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with no plaintext hash"]))),null;var L=null;if(((d=t.ancillary)==null?void 0:d.scansSidecar)!=null&&((m=t.ancillary)==null?void 0:m.scanLengths)!=null){var E,k;L={sidecar:(E=t.ancillary)==null?void 0:E.scansSidecar,scanLengths:(k=t.ancillary)==null||(k=k.scanLengths)==null?void 0:k.map(o("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength)}}if(((p=S.integral)==null?void 0:p.fileSha256)==null||((_=S.integral)==null?void 0:_.fileEncSha256)==null||((f=S.integral)==null?void 0:f.mediaKey)==null||((g=S.integral)==null?void 0:g.directPath)==null||((h=S.integral)==null?void 0:h.mediaKeyTimestamp)==null||((y=S.ancillary)==null?void 0:y.objectId)==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]))),null;var I=(C=S.ancillary)==null?void 0:C.fileLength,T=(b=S.ancillary.thumbnail)==null?void 0:b.downloadableThumbnail,D=o("WAMediaUtils").rawDataToMediaEntry({fileSha256:S.integral.fileSha256,fileEncSha256:S.integral.fileEncSha256,mediaKey:S.integral.mediaKey,directPath:S.integral.directPath,mediaKeyTimestamp:o("WATimeUtils").castLongIntToUnixTime(S.integral.mediaKeyTimestamp),serverMediaType:n,objectId:(v=S.ancillary)==null?void 0:v.objectId,fbid:void 0,downloadableThumbnail:{directPath:T==null?void 0:T.directPath,fileEncSha256:T==null?void 0:T.fileEncSha256,fileSha256:T==null?void 0:T.fileSha256,mediaKey:T==null?void 0:T.mediaKey,mediaKeyTimestamp:(T==null?void 0:T.mediaKeyTimestamp)==null?null:o("WATimeUtils").castLongIntToUnixTime(T==null?void 0:T.mediaKeyTimestamp),objectId:T==null?void 0:T.objectId},filename:a,progressiveJpegDetails:L,size:I==null?I:o("WALongInt").numberOrThrowIfTooLarge(I)});return{size:I==null?o("WAParseConsumerMessageProtocol").DEFAULT_FILE_SIZE:o("WALongInt").numberOrThrowIfTooLarge(I),plaintextHash:o("WAHashUtils").toPlaintextHash(new Uint8Array(R)),mediaEntry:D}}function d(e){switch(e){case o("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.NONE:return o("WAMediaHdType").HD_TYPE_NONE;case o("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.LQ_4K:return o("WAMediaHdType").HD_TYPE_LQ_4K;case o("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.HQ_4K:return o("WAMediaHdType").HD_TYPE_HQ_4K;default:return o("WAMediaHdType").HD_TYPE_NONE}}function m(e,t,n){var r,a,i,l,s,u,m=c(e,n,!1);if(!m)return null;var p=C(m,t),_=(r=e.ancillary)==null?void 0:r.width,f=(a=e.ancillary)==null?void 0:a.height;e.ancillary!=null&&(e.ancillary.width!=null&&e.ancillary.width===4294967295&&(_=void 0),e.ancillary.height!=null&&e.ancillary.height===4294967295&&(f=void 0));var g=babelHelpers.extends({},p,{mediaType:o("WAMedia").MEDIA_TYPE.IMAGE,validatedVideoInfo:null,validatedImageInfo:{width:_,height:f,jpegThumbnail:(i=e.integral)==null||(i=i.transport)==null||(i=i.ancillary)==null||(i=i.thumbnail)==null?void 0:i.jpegThumbnail,jpegThumbnailHeight:(l=e.integral)==null||(l=l.transport)==null||(l=l.ancillary)==null||(l=l.thumbnail)==null?void 0:l.thumbnailHeight,jpegThumbnailWidth:(s=e.integral)==null||(s=s.transport)==null||(s=s.ancillary)==null||(s=s.thumbnail)==null?void 0:s.thumbnailWidth,hdType:d((u=e.ancillary)==null?void 0:u.hdType)},validatedAudioInfo:null,validatedDocumentFileInfo:null});return g}function p(e,t,n){var a=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").ImageTransportSpec,e),i=m(a,t,n);if(i==null)throw r("err")("consumerMessage has no image media info");return i}function _(e,t,n){var r,a,i,l,s,u,d,m,p,_,f,g,h,y,b,v,S;if(!((r=e.integral)!=null&&r.transport))return null;var R=c(e,n?"gif":"video",!1);if(!R)return null;var L=C(R,t),E=babelHelpers.extends({},L,{accessibilitySummaryText:(a=e.ancillary)==null?void 0:a.accessibilityLabel,mediaType:n?o("WAMedia").MEDIA_TYPE.GIF:o("WAMedia").MEDIA_TYPE.VIDEO,validatedVideoInfo:n?null:{duration:(e==null||(i=e.ancillary)==null?void 0:i.seconds)!=null&&(e==null||(l=e.ancillary)==null?void 0:l.seconds)>o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?e==null||(s=e.ancillary)==null?void 0:s.seconds:o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,width:e==null||(u=e.ancillary)==null?void 0:u.width,height:e==null||(d=e.ancillary)==null?void 0:d.height,mimetype:e==null||(m=e.integral)==null||(m=m.transport)==null||(m=m.ancillary)==null?void 0:m.mimetype,jpegThumbnail:(p=e.integral)==null||(p=p.transport)==null||(p=p.ancillary)==null||(p=p.thumbnail)==null?void 0:p.jpegThumbnail,jpegThumbnailHeight:(_=e.integral)==null||(_=_.transport)==null||(_=_.ancillary)==null||(_=_.thumbnail)==null?void 0:_.thumbnailHeight,jpegThumbnailWidth:(f=e.integral)==null||(f=f.transport)==null||(f=f.ancillary)==null||(f=f.thumbnail)==null?void 0:f.thumbnailWidth,gifPlayback:(g=e.ancillary)==null?void 0:g.gifPlayback},validatedImageInfo:n?{width:(h=e.ancillary)==null?void 0:h.width,height:(y=e.ancillary)==null?void 0:y.height,jpegThumbnail:(b=e.integral)==null||(b=b.transport)==null||(b=b.ancillary)==null||(b=b.thumbnail)==null?void 0:b.jpegThumbnail,jpegThumbnailHeight:(v=e.integral)==null||(v=v.transport)==null||(v=v.ancillary)==null||(v=v.thumbnail)==null?void 0:v.thumbnailHeight,jpegThumbnailWidth:(S=e.integral)==null||(S=S.transport)==null||(S=S.ancillary)==null||(S=S.thumbnail)==null?void 0:S.thumbnailWidth}:null,validatedAudioInfo:null,validatedDocumentFileInfo:null});return E}function f(e,t,n){var r,a,i,l,s,u;if(!((r=e.integral)!=null&&r.transport))return null;var d=c(e,"ptt",!1);if(!d)return null;var m=C(d,n),p=babelHelpers.extends({},m,{mediaType:o("WAMedia").MEDIA_TYPE.PTT,validatedVideoInfo:null,validatedImageInfo:null,validatedDocumentFileInfo:null,validatedAudioInfo:{duration:(e==null||(a=e.ancillary)==null?void 0:a.seconds)!=null&&(e==null||(i=e.ancillary)==null?void 0:i.seconds)>o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?e==null||(l=e.ancillary)==null?void 0:l.seconds:o("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,mimetype:e==null||(s=e.integral)==null||(s=s.transport)==null||(s=s.ancillary)==null?void 0:s.mimetype,played:!1,waveform:e==null||(u=e.ancillary)==null?void 0:u.waveform}});return p}function g(e,t){var n,r,a,i,l,s,u,d;if(!((n=e.integral)!=null&&n.transport))return null;var m=((r=e.integral)==null?void 0:r.receiverFetchId)!=null,p=c(e,"sticker",m);if(!p)return null;var _=C(p,t),f=babelHelpers.extends({},_,{accessibilitySummaryText:(a=e.ancillary)==null?void 0:a.accessibilityLabel,mediaType:o("WAMedia").MEDIA_TYPE.STICKER,validatedVideoInfo:null,validatedImageInfo:{width:(i=e.ancillary)==null?void 0:i.width,height:(l=e.ancillary)==null?void 0:l.height,jpegThumbnail:(s=e.integral)==null||(s=s.transport)==null||(s=s.ancillary)==null||(s=s.thumbnail)==null?void 0:s.jpegThumbnail,jpegThumbnailHeight:(u=e.integral)==null||(u=u.transport)==null||(u=u.ancillary)==null||(u=u.thumbnail)==null?void 0:u.thumbnailHeight,jpegThumbnailWidth:(d=e.integral)==null||(d=d.transport)==null||(d=d.ancillary)==null||(d=d.thumbnail)==null?void 0:d.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return f}function h(e){var t,n,r,o,a,i,l;if(!((t=e.integral)!=null&&t.transport))return null;var s=(n=e.ancillary)==null?void 0:n.width,u=(r=e.ancillary)==null?void 0:r.height,c=(o=(a=e.integral)==null?void 0:a.receiverFetchId)!=null?o:(i=e.ancillary)==null?void 0:i.receiverFetchId,d=e==null||(l=e.integral)==null||(l=l.transport)==null||(l=l.ancillary)==null?void 0:l.mimetype;if(s==null||u==null||c==null||d==null)return null;var m={receiverFetchId:c,previewWidth:s,previewHeight:u,mimetype:d,type:"sticker"};return m}function y(e,t,n){var r,a;if(!((r=e.integral)!=null&&r.transport))return null;var i=c(e,"document",!1,t);if(!i)return null;var l=C(i,n);return babelHelpers.extends({},l,{mediaType:o("WAMedia").MEDIA_TYPE.DOCUMENT_FILE,validatedVideoInfo:null,validatedImageInfo:null,validatedAudioInfo:null,validatedDocumentFileInfo:{mimetype:e==null||(a=e.integral)==null||(a=a.transport)==null||(a=a.ancillary)==null?void 0:a.mimetype,filename:t!=null?t:void 0}})}function C(e,t){return{mediaEntry:e.mediaEntry,plaintextHash:e.plaintextHash,size:e.size,msgIds:[],mediaEntries:new(o("WAMsgMap")).MsgMap,ts:t}}l.getMediaMeta=c,l.decodeImageTransport=p,l.parseVideoMsg=_,l.parseAudioMsg=f,l.parseStickerMsg=g,l.parseStickerReceiverFetchInfo=h,l.parseDocumentMsg=y}),98);
__d("MAWParseBumpExistingMessageMsg",["FBLogger","WAMessageKey","WAParseConsumerMessageProtocol","WAParseProtocolUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.chat,n=e.content,a=e.meta,i=e.metadata,l=n.bumpExistingMessage;if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no content");var s=l.key;if(s==null)throw r("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no message key");var u=o("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.id.author),c=o("WAMessageKey").extractProtocolMessageId(t,u,s),d=c.author,m=c.externalId,p=o("WAParseProtocolUtils").parseEphemerality(a,i),_=p.deleteTs,f=p.ephemeralSetting,g=p.expirationTs,h={ack:a.ack,deleteTs:_,ephemeralSetting:f,expirationTs:g,id:{author:a.id.author,chat:a.id.chat,externalId:a.id.externalId},quote:{content:{author:d,externalId:m,ts:null,type:"Unavailable"},remoteJid:t},reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"BumpExistingMessage"};return{contentTypeForLogging:"bumpExistingMessage",unstoredMedia:null,unstoredMsg:h,unstoredQuotedMedia:null,unstoredXMA:null}}l.default=e}),98);
__d("MAWMessageDropError",[],(function(t,n,r,o,a,i){"use strict";var e=(function(e){function t(t){var n;return n=e.call(this,t)||this,n.name="MAWMessageDropError",n.message=t,n}return babelHelpers.inheritsLoose(t,e),t})(babelHelpers.wrapNativeSuper(Error));i.MAWMessageDropError=e}),66);
__d("MAWParseNetworkVerificationMsg",["MAWMessageDropError","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){throw o("WALogger").EXPECTED_ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Web does not support network verification code"]))),new(o("MAWMessageDropError")).MAWMessageDropError("Web does not support network verification")}l.parseNetworkVerificationMsg=s}),98);
__d("MAWParseNoteReplyMsg",["FBLogger","MAWJids","MAWMsgType","WAJids","WALongInt","WAMediaTransport.pb","WAMsgType","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassUtils","WATimeUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t,n,a=e.content,i=e.ebTimestampMs,l=e.meta,s=e.metadata,u=a.noteReplyMessage;if(o("WAParseReadOnlyMetadataDataclassUtils").isNoteMention(s))return"noteMention";if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no content");var c=(t=u.noteText)==null?void 0:t.text;if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no note text");var d=u.noteTimestampMs!=null?o("WATimeUtils").castMilliSecondsToUnixTime(o("WALongInt").numberOrThrowIfTooLarge(u.noteTimestampMs)):void 0,m=o("MAWJids").toUserJid(l.id.author),p=o("MAWJids").toUserJid(l.id.chat),_=p===m?o("WAJids").AUTHOR_ME:p,f=o("WAParseProtocolUtils").parseEphemerality(l,s),g=f.deleteTs,h=f.ephemeralSetting,y=f.expirationTs,C={ack:l.ack,deleteTs:g,ebTimestampMs:i,ephemeralSetting:h,expirationTs:y,forwardingScore:l.forwardingScore,id:{author:l.id.author,chat:l.id.chat,externalId:l.id.externalId},quote:{content:{author:_,expirationTs:d,externalId:l.id.externalId,msgContent:{content:c},ts:l.serverTs,type:o("WAMsgType").NOTE_REPLY},remoteJid:l.id.chat},ts:l.serverTs},b,v,S,R=(n=u.textContent)==null?void 0:n.text,L=u.stickerContent,E=u.videoContent;if(R!=null){var k=babelHelpers.extends({msgContent:{content:R},type:o("MAWMsgType").MSG_TYPE.TEXT},C);b=k}else if(L!=null){var I=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,L==null?void 0:L.payload);if(v=o("WAParseMediaTransportProtocol").parseStickerMsg(I,l.ts),v){var T=babelHelpers.extends({mediaId:v.plaintextHash,type:o("MAWMsgType").MSG_TYPE.STICKER},C);b=T}else{var D;if(((D=I.integral)==null?void 0:D.receiverFetchId)!=null){if(S=o("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(I),S==null)throw r("FBLogger")("messenger_web").mustfixThrow("consumerMessage has no sticker receiver fetch info");var x=babelHelpers.extends({type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH},C);b=x}else throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage sticker has no media")}}else if(E!=null){var $,P,N=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").VideoTransportSpec,E==null?void 0:E.payload),M=N==null||($=N.integral)==null||($=$.transport)==null||($=$.ancillary)==null?void 0:$.mimetype,w=(N==null||(P=N.ancillary)==null?void 0:P.gifPlayback)===!0&&M==="image/gif";if(v=o("WAParseMediaTransportProtocol").parseVideoMsg(N,l.ts,w),v&&w){var A=babelHelpers.extends({mediaId:v.plaintextHash,type:o("MAWMsgType").MSG_TYPE.GIF},C);b=A}else throw v?r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video is not a gif"):r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video has no media")}else throw r("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no valid content");return{contentTypeForLogging:"noteReplyMessage",unstoredMedia:v,unstoredMsg:b,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:S,unstoredXMA:null}}l.default=e}),98);
__d("MAWParseRavenActionNotificationMsg",["FBLogger","MAWMsg","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t,n,a,i,l=e.content,s=e.meta,u=(t=l.ravenActionNotifMessage)==null?void 0:t.actionType,c=o("MAWMsg").MAWRavenActionNotifType.cast(u),d=(n=l.ravenActionNotifMessage)==null?void 0:n.actionTimestamp,m;if(d!=null){var p=Number(d);p>o("WATimeUtils").MAX_INT?m=o("WATimeUtils").castMilliSecondsToUnixTime(p):m=o("WATimeUtils").castToUnixTime(p)}var _=((a=l.ravenActionNotifMessage)==null||(a=a.key)==null?void 0:a.id)!=null?o("WAStanzaUtils").toStanzaId((i=l.ravenActionNotifMessage)==null||(i=i.key)==null?void 0:i.id):null;if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when getting actionType for RavenNotificationMessage "+s.id.externalId);if(m==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when getting actionTimestamp for RavenNotificationMessage "+s.id.externalId);if(_==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when getting ravenActionToMsgExternalId for RavenNotificationMessage "+s.id.externalId);var f={ack:s.ack,actionTimestamp:m,actionType:c,id:s.id,ravenActionToMsgExternalId:_,sentTs:s.sentTs,serverTs:s.serverTs,ts:s.serverTs,type:"RavenAction"};return{unstoredMedia:null,unstoredMsg:f,unstoredQuotedMedia:null,unstoredXMA:null}}l.parseRavenActionNotificationMessage=e}),98);
__d("MAWParseRavenMsg",["FBLogger","MAWMsg","MAWMsgType","MAWParseSubprotocolVersionConsts","WALogger","WAMediaTransport.pb","WAParseMediaTransportProtocol","WAParseProtocolUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){var n=t.content,a=t.ebTimestampMs,i=t.meta,l=t.metadata,u=n.ravenMessageMsgr;if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("Raven message payload has no content");var c=o("MAWMsg").MAWRavenMsgEphemeralType.cast(u.ephemeralType);if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error when casting ephemeralType for Raven message");var d=void 0,m=void 0;if(u.imageMessage)(u.imageMessage.version==null||u.imageMessage.version<o("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["\n        received image messsage version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION),d=o("WAParseMediaTransportProtocol").decodeImageTransport(u.imageMessage.payload,i.ts,"image"),m=o("MAWMsg").MAWRavenMsgMediaType.IMAGE;else if(u.videoMessage){(u.videoMessage.version==null||u.videoMessage.version<o("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["\n        received video messsage version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION);var p=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMediaTransport.pb").VideoTransportSpec,u.videoMessage.payload);d=o("WAParseMediaTransportProtocol").parseVideoMsg(p,i.ts,!1),m=o("MAWMsg").MAWRavenMsgMediaType.VIDEO}else throw r("FBLogger")("messenger_web").mustfixThrow("Error unsupported Raven message type");if(d==null)throw r("FBLogger")("messenger_web").mustfixThrow("Error Raven message has no associated image or video");var _=o("WAParseProtocolUtils").parseEphemerality(i,l),f=_.deleteTs,g=_.ephemeralSetting,h=_.expirationTs,y={ack:i.ack,deleteTs:f,ebTimestampMs:a,ephemeralSetting:g,expirationTs:h,id:i.id,mediaId:d.plaintextHash,ravenEphemeralMediaState:c===o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?o("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:c,ravenMediaType:m,reportingMeta:i.reportingMeta,sentTs:i.sentTs,serverTs:i.serverTs,ts:i.ts,type:o("MAWMsgType").MSG_TYPE.RAVEN};return{unstoredMedia:d,unstoredMsg:y,unstoredQuotedMedia:null,unstoredXMA:null}}l.parseRavenMessage=u}),98);
__d("MAWParseScreenshotActionMsg",["FBLogger","MAWExternalId","MAWMsgType","WAAckLevel","WAArmadilloApplication.pb","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.content,n=e.meta,a=t.screenshotAction;if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("screenshotAction has no content");var i=a.screenshotType;if(i==null)throw r("FBLogger")("messenger_web").mustfixThrow("Missing screenshot type in payload");if(![o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE,o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING].includes(i))throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type");var l={ack:o("WAAckLevel").ACK.SENT,id:{author:o("WAJids").AUTHOR_SYSTEM,chat:n.id.chat,externalId:o("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:[],adminType:"youEphemeralTakeScreenshot",screenshotActionType:i},ts:n.serverTs,type:o("MAWMsgType").EPHEMERAL_SCREENSHOT_ACTION};return{contentTypeForLogging:"screenshotAction",unstoredMedia:null,unstoredMsg:l,unstoredQuotedMedia:null,unstoredXMA:null}}l.parseEphemeralScreenshotActionProtocol=e}),98);
__d("MAWParseArmadilloProtocol",["FBLogger","MAWMessageParseError","MAWMsgType","MAWParseBumpExistingMessageMsg","MAWParseNetworkVerificationMsg","MAWParseNoteReplyMsg","MAWParseRavenActionNotificationMsg","MAWParseRavenMsg","MAWParseScreenshotActionMsg","MAWParseXMAProtocol","WAArmadilloApplication.pb","WAHex","WALogger","decodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null},c=new Map([["screenshotAction",o("MAWParseScreenshotActionMsg").parseEphemeralScreenshotActionProtocol],["extendedContentMessage",o("MAWParseXMAProtocol").parseXMAProtocol],["paymentsTransactionMessage",o("MAWParseXMAProtocol").parseXMAProtocol],["noteReplyMessage",r("MAWParseNoteReplyMsg")],["bumpExistingMessage",r("MAWParseBumpExistingMessageMsg")],["ravenMessageMsgr",o("MAWParseRavenMsg").parseRavenMessage],["ravenActionNotifMessage",o("MAWParseRavenActionNotificationMsg").parseRavenActionNotificationMessage],["networkVerificationMessage",o("MAWParseNetworkVerificationMsg").parseNetworkVerificationMsg]]);function d(t,n,a,i,l,u){var d,_=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAArmadilloApplication.pb").ArmadilloSpec,n),f=(d=_.payload)==null?void 0:d.content;if(!f)throw new(o("MAWMessageParseError")).MAWMessageParseError("parse_armadillo_protocol_error:: empty_payload_content");var g=p(f);try{var h=c.get(g),y=null;if(h!=null){var C=h({chat:t,content:f,ebTimestampMs:u,meta:a,metadata:l,protobuf:i});if(typeof C!="string")return C;y=C}return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - handling futureproof message for contentType: ",""])),g),{contentTypeForLogging:g,unstoredMedia:null,unstoredMsg:{ack:a.ack,id:a.id,msgContent:{protobuf:o("WAHex").bytesToBuffer(i),subtype:y!=null?y:m(g)},reportingMeta:a.reportingMeta,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.ts,type:o("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null}}catch(e){var b=r("getErrorSafe")(e);throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - Dropping message. contentType: ",", reason: ",""])),g,b.message),new(o("MAWMessageParseError")).MAWMessageParseError("parse_armadillo_protocol_error:: contentType:: "+g+" reason:: "+b.message)}}function m(e){switch(e){case"bumpExistingMessage":return"bumpMessage";default:return null}}function p(e){var t=Object.keys(e).filter(function(e){return e!=="$$unknownFieldCount"});if(t.length!==1)throw r("FBLogger")("messenger_web").mustfixThrow(JSON.stringify(e)+" armadillo payload content should only have one field");var n=t[0];return n}l.EMPTY_CONTENT=u,l.parseArmadilloProtocol=d,l.parseOneOfContentType=p}),98);
__d("MAWXMALoggingUtils",["WAArmadilloXMA.pb","objectEntries"],(function(t,n,r,o,a,i,l){"use strict";var e=r("objectEntries")(o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE).reduce(function(e,t){var n=t[0],r=t[1];return e.set(r,n),e},new Map);function s(t){return t!=null?e.get(t):void 0}l.getXmaTargetTypeStringFromEnum=s}),98);
__d("MAWParseXMAProtocol",["FBLogger","MAWMsgType","MAWODSProxy","MAWParseArmadilloProtocol","MAWParseCollapsibleIdFromXMADataClass","MAWParseSubprotocolVersionConsts","MAWParseXMAFBConfig","MAWParseXMAUnsupportedMessageType","MAWXMALoggingUtils","MWXMAV2IsCollapsibleXMA","MWXMAV2XmaDataClass","WAArmadilloXMA.pb","WAGetPlatformFromStanzaId","WAHex","WAJids","WALogger","WAMedia","WAMsgApplication.pb","WAOdsEnums","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAParseProtocolUtils","WAStanzaUtils","WATimeUtils","decodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["actionContentBlob"],s,u,c,d,m,p,_,f,g,h,y,C,b,v=new Set([o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY]);function S(e,t){if(!(e==null||e.payload==null))return o("WAParseMediaTransportProtocol").decodeImageTransport(e.payload,t,"xma-image")}function R(e,t,n,a,i){if(t==null||t.payload==null)return null;t.version!==o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[XMA] received associated message with incorrect version ",""])),t.version);var l=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgApplication.pb").MessageApplicationSpec,t.payload),u=o("WAParseMessageApplication").parseMessageApplication(l);if(u.type==="error")throw r("FBLogger")("messenger_web").mustfixThrow("XMA contains unparseable message application.");var c=u;if(c.subprotocolType!=="consumerMessage")throw r("FBLogger")("messenger_web").mustfixThrow("XMA contains incorrect message application type: "+c.subprotocolType);return o("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(e,c.payload,n,a,i)}var L="https://www.instagram.com/stories/",E="https://www.instagram.com/reel/",k="https://www.instagram.com/tv/",I="https://www.instagram.com/_n/profile_shop?",T="https://www.instagram.com/",D="https://www.alpha.facebook.com/share/",x="https://m.facebook.com/share/",$="https://www.facebook.com/share/",P="https://m.alpha.facebook.com/share/",N="https://facebook.com/share/",M="https://www.alpha.facebook.com/stories/",w="https://www.facebook.com/stories/",A="https://fb.gg/",F="https://www.facebook.com/",O="https://m.facebook.com/",B="https://www.alpha.facebook.com/",W="https://m.alpha.facebook.com/",q="https://facebook.com/",U="https://fb.watch/",V="https://www.facebook.com/l.php",H="https://m.facebook.com/l.php",G="https://www.alpha.facebook.com/l.php",z="https://m.alpha.facebook.com/l.php",j="https://facebook.com/l.php",K="https://l.facebook.com/l.php",Q="https://facebook.com/events/",X="https://www.facebook.com/events/",Y="https://www.alpha.facebook.com/events/",J="https://m.facebook.com/events/",Z="https://m.alpha.facebook.com/events/",ee="fb-messenger://payments/receipt?product_id=",te="messenger://location_share",ne="http://m.me/",re=":",oe="http://",ae="https://";function ie(t){var n,a,i,l,s,_=t.chat,f=t.content,g=t.ebTimestampMs,h=t.meta,y=t.metadata,C=t.protobuf,b=o("MAWParseArmadilloProtocol").parseOneOfContentType(f),L=b==="paymentsTransactionMessage",E=null;if(L){var k;E=(k=f.paymentsTransactionMessage)==null?void 0:k.extendedContentMessage}else E=f.extendedContentMessage;if(E==null&&L)return"paymentsTransactionMessage";if(E==null)throw r("FBLogger")("messenger_web").mustfixThrow("extendedContentMessage has no content");var I=E,T=I.targetType,D=I.xmaDataclass,x=o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(h.id.externalId);if(D!=null&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_dataclass.exists."+(T!=null?T:"null")}),T==null||!o("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:T,xmaDataclass:D}))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:{ack:h.ack,id:h.id,msgContent:{protobuf:o("WAHex").bytesToBuffer(C),subtype:o("MAWParseXMAUnsupportedMessageType").getXMAUnsupportedMessageType(T,D,L)},reportingMeta:h.reportingMeta,sentTs:h.sentTs,serverTs:h.serverTs,ts:h.ts,type:o("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null,xmaTargetTypeForLogging:T};var $=o("WAParseProtocolUtils").parseEphemerality(h,y),P=$.deleteTs,N=$.ephemeralSetting,M=$.expirationTs,w=o("WAParseProtocolUtils").enhanceReportingMeta(h,y),A=E,F=A.associatedMessage,O=A.commands,B=A.contentRef,W=A.ctas,q=A.favicon,U=A.headerImage,V=A.headerTitle,H=A.maxSubtitleNumOfLines,G=A.maxTitleNumOfLines,z=A.mentionedJid,j=A.messageText,K=A.overlayDescription,Q=A.overlayIconGlyph,X=A.overlayTitle,Y=A.previews,J=A.sentWithMessageId,Z=A.subtitleText,ee=A.targetId,te=A.targetUsername,ne=A.titleText,re=A.xmaLayoutType;F!=null&&(F.version==null||F.version<o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["\n      received associatedMessage version is older than expected "," as expected. "])),o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION),U!=null&&(U.version==null||U.version<o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["\n    received headerImage version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION),q!=null&&(q.version==null||q.version<o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["\n    received favicon version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION),Y.every(function(e){(e.version==null||e.version<o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)&&o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["\n      received previews version is older than expected ",". "])),o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)});var oe=E.targetExpiringAtSec!=null?o("WATimeUtils").castLongIntToUnixTime(E.targetExpiringAtSec):void 0,ae=F!=null&&J!=null?[o("WAStanzaUtils").toStanzaId(J),h.id.externalId]:[h.id.externalId,void 0],ie=ae[0],le=ae[1],se=[];if(Y!=null)for(var ue=0;ue<Y.length;ue++){var ce,de,me=S(Y[ue],h.ts);me!=null&&!((T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE||T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE)&&me.mediaType===o("WAMedia").MEDIA_TYPE.IMAGE&&((ce=me.validatedImageInfo)==null?void 0:ce.height)===1&&((de=me.validatedImageInfo)==null?void 0:de.width)===1)&&se.push(me)}var pe=S(U,h.ts),_e=S(q,h.ts),fe=(n=o("WAParseConsumerMessageProtocol").parsedQuotedConsumerMessage(y))!=null?n:void 0,ge=o("MWXMAV2XmaDataClass").parseXmaDataClass(D),he;if(o("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(ge))try{he=o("MAWParseCollapsibleIdFromXMADataClass").parseCollapsibleIdFromXMADataClass(ge)}catch(e){var ye=r("getErrorSafe")(e);throw o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation."+x+"."+(T||0)+".error"}),r("FBLogger")("messenger_web").mustfixThrow("Unexpected error trying to parse collapsible ID: "+ye.message)}var Ce=babelHelpers.extends({collapsibleId:he,deleteTs:P,ebTimestampMs:g,ephemeralSetting:N,expirationTs:M,id:babelHelpers.extends({},h.id,{externalId:ie}),quote:fe,reportingMeta:w,type:o("MAWMsgType").MSG_TYPE.XMA},h),be=W.map(function(t){var n=t.actionContentBlob,r=babelHelpers.objectWithoutPropertiesLoose(t,e);return r}),ve=be.slice(1);T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE&&W.length===1&&(ve=be);var Se=T===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT,Re={author:h.id.author,commands:O,contentRef:B,ctas:ve,defaultCTA:be[0],externalId:ie,faviconMediaId:Se?pe==null?void 0:pe.plaintextHash:_e==null?void 0:_e.plaintextHash,headerMediaId:Se?_e==null?void 0:_e.plaintextHash:pe==null?void 0:pe.plaintextHash,headerTitle:V,isTombstoned:oe!=null?o("WATimeUtils").unixTime()>oe:!1,maxSubtitleNumOfLines:H,maxTitleNumOfLines:G,mentionedJids:z.map(o("WAJids").validateUserJid).filter(Boolean),overlayDescription:K,overlayIconGlyph:Q,overlayTitle:X,previewMediaIds:se.length>0?se.map(function(e){return e.plaintextHash}):void 0,sentWithMessage:j,subtitleText:Z,targetExpiringAtSec:oe,targetId:ee,targetType:T,targetUsername:te,threadJid:_,titleText:ne,xmaDataclass:D,xmaLayoutType:re},Le;if(F!=null&&J==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA associatedMessage cannot be received without sentWithMessageId field");F!=null&&le!=null&&(Le=R(_,F,h,C,y));var Ee=(a=(i=Le)==null?void 0:i.unstoredMedia)!=null?a:null,ke=v.has(T);if(Ee!=null&&!ke){var Ie=o("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(T);throw o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"assoc_msg_media_"+(Ie!=null?Ie:"unknown")}),r("FBLogger")("messenger_web").mustfixThrow("XMA associated msg cannot have additioinal dbMedia")}var Te=(l=(s=Le)==null?void 0:s.unstoredMsg)!=null?l:null;if(le!=null&&Te!=null&&(o("WALogger").DEV(p||(p=babelHelpers.taggedTemplateLiteralLoose(["ExternalId: "," textId: ",""])),ie,le),Te.id=babelHelpers.extends({},Te.id,{externalId:le}),Ce.id=babelHelpers.extends({},Te.id,{externalId:ie}),Re.externalId=ie),ke&&Ee!=null&&((Te==null?void 0:Te.type)==="Gif"||(Te==null?void 0:Te.type)==="Sticker"))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:Ce,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:Ee,unstoredAssociatedMsg:Te,unstoredFavicon:Se?se[0]:_e,unstoredHeaderMedia:pe,unstoredPreviews:se.length>0?se:void 0,xma:Re},xmaTargetTypeForLogging:T};if(Te!=null&&Te.type!=="Text")throw r("FBLogger")("messenger_web").mustfixThrow('XMA associated msg cannot have type different from "Text". Received type: '+Te.type);return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:Ce,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:Te,unstoredFavicon:Se?se[0]:_e,unstoredHeaderMedia:pe,unstoredPreviews:se.length>0&&!Se?se:void 0,xma:Re},xmaTargetTypeForLogging:T}}function le(e){var t=e.ebRestore,n=e.hasActionUrl,r=e.hasNativeUrl,a=e.isActionUrlValid,i=e.isNativeUrlValid,l=e.targetType;!i&&!a?o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action and native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),t!=null&&t?"[labyrinth_web]":"[S410301][transport]",l,r,n):i&&!a?o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),t!=null&&t?"[labyrinth_web]":"[S410301][transport]",l,r,n):a&&!i&&o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),t!=null&&t?"[labyrinth_web]":"[S410301][transport]",l,r,n)}function se(e,t,n){var r=e.nativeUrl,o=e.actionUrl,a=ue(r,t,n),i=ue(o,t,n);return le({ebRestore:n,hasActionUrl:o!=null,hasNativeUrl:r!=null,isActionUrlValid:i,isNativeUrlValid:a,targetType:t}),a&&i}function ue(e,t,n,r){return r===void 0&&(r=!1),e==null?!0:_e(e,t)===!1?(n!=null&&n&&!r&&o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid url prefix during XMA restore"]))),!1):fe(e)?!0:(n!=null&&n&&!r&&o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid message text during XMA restore"]))),!1)}function ce(e){return e.startsWith(D)||e.startsWith(x)||e.startsWith($)||e.startsWith(P)||e.startsWith(N)}function de(e){return e.startsWith(V)||e.startsWith(H)||e.startsWith(G)||e.startsWith(z)||e.startsWith(j)||e.startsWith(K)}function me(e){return e.startsWith(F)||e.startsWith(O)||e.startsWith(B)||e.startsWith(W)||e.startsWith(q)}function pe(e){return e.startsWith(Q)||e.startsWith(X)||e.startsWith(Y)||e.startsWith(J)||e.startsWith(Z)}function _e(e,t){if(e==null)return!0;switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REACTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:return e.startsWith(L);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return e.startsWith(E);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return e.startsWith(k);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return e.startsWith(I);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_IG_MEDIA_SHARE:return e.startsWith(T);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return e.startsWith(w)||e.startsWith(M)||ce(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:return me(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return e.startsWith(A);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:return(me(e)||e.startsWith(U))&&!de(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return e.startsWith(te);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_LOCAL_EVENT_REPLY:return pe(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return pe(e)||ce(e);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:return me(e)||e.startsWith(ne);case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_EXTERNAL_LINK:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL:if(e.includes(re)&&!e.startsWith(oe)&&!e.startsWith(ae)){var n=e.indexOf("://");return n===-1&&o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(['S410301 The url is invalid. It contains a colon separator, but not "://"']))),!1}break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_RECEIVER_FETCH:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.DATACLASS_SENDER_COPY:return!0;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_P2P_PAYMENT:return e.startsWith(ee)}return!0}function fe(e){for(var t=0;t<e.length;t++){var n=e.charAt(t);switch(n){case"\u202C":case"\u202D":case"\u202E":return o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["S410301 The url contains RTL characters"]))),!1;default:break}}return!0}l.SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES=v,l.kIGStoryCtaPrefix=L,l.kIGClipsCtaPrefix=E,l.kIGTVCtaPrefix=k,l.kIGShopCtaPrefix=I,l.kIGDefaultCtaPrefix=T,l.kFBStoryCtaPrefix=w,l.kFBGamingCustomUpdateCtaPrefix=A,l.kFBDefaultWWWCtaPrefix=F,l.kFBEventCtaPrefix=Q,l.kMSGP2PPaymentUrlPrefix=ee,l.kMessengerLocationSharePrefix=te,l.kHttpPrefix=oe,l.parseXMAProtocol=ie,l.isValidCTA=se,l.isURLValid=ue}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","MAWBridge","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTransactionMode","WAArmadilloXMA.pb","WAHashUtils","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=function(t,n,r){n==null||n.addPoint("xma_restore_start");var e=t.restoredMsgsData;if(e){var a=e.newlyAddedMsgs,i=a.concat(e.existingMsgs),l=[];return i.map(function(e){var n=e.externalId,r=t.echoMsgMap.get(n);r!=null&&r.contentType===o("EchoMessage").EchoMessageContentType.XMA&&l.push(e)}),l.length===0?Promise.resolve():y(l,t.echoMsgMap,r).then(function(e){return n==null||n.addPoint("xma_restore_end",{int:{xma:e.length}}),Promise.resolve()})}return n==null||n.addPoint("xma_restore_end",{int:{xma:0}}),Promise.resolve()};function y(t,n,r){var a=new Map,i=new Map;t.forEach(function(e){var t,r,l=n.get(e.externalId),s=l==null||(t=l.mediaData)==null?void 0:t.attachmentObjectId;s!=null&&a.set(o("WAMediaUtils").stringToDeliveryObjectId(s),e);var u=l==null||(r=l.mediaData)==null?void 0:r.plaintextHash;if(u!=null){var c=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(u)),d=i.get(c);i.set(c,d!=null?[].concat(d,[e.msgId]):[e.msgId])}});var l=Array.from(a.keys()),u=new Map;return C(i).then(function(i){var c=[];return l.forEach(function(e){var t,n=(t=a.get(e))==null?void 0:t.externalId;n!=null&&u.set(n,e)}),t.filter(function(e){return o("MAWDbMsg").isXMAMsg(e)}).forEach(function(t){var r=n.get(t.externalId);if(r){var a=u.get(t.externalId),l;if(a!=null){var d=i.get(a);d!=null&&(l=d.mediaId)}var m=r.serializationOrigin;m==null&&(m=o("EchoMessage").EchoSerializationOriginType.UNKNOWN);var p=v(t,r,l,m);p==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""])),m):(p.targetType===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&t.msgContent==null&&(o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""])),m),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),c.push(p))}}),b(c).then(function(e){return e.length>0&&e.map(async function(e){var t=u.get(e.externalId);if(r!==!0){var n;t!=null&&(n=i.get(t));var a=await o("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(n,e);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:a}]})}}),e})})}var C=o("MAWIndexedDb").makeMsgrTransactor({media:o("MAWTransactionMode").READONLY,mediaBackup:o("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(e){return function(t){var n=Array.from(t.keys());return o("MAWDbMediaTxns").maybeBulkGetMediaFromPlaintextHash(e,n).then(function(e){var n=new Map;return e.forEach(function(e){var r=t.get(e.plaintextHash);r==null||r.forEach(function(t){var r=e==null?void 0:e.mediaEntries.get(t);if(e!=null&&r!=null){var a=o("WAMediaUtils").decodeMediaEntryData(r);a.objectId!=null&&n.set(o("WAMediaUtils").stringToDeliveryObjectId(a.objectId),e)}else o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][getMediaForXMAByObjectIds] mediaEntry is null for media restore"])))})}),n})}}),b=o("MAWIndexedDb").makeMsgrTransactor({xma:o("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(e){return function(t){return e.xma.bulkAdd(t,{allKeys:!0}).then(function(e){return e.map(function(e,n){return babelHelpers.extends({},t[n],{xmaId:e})})})}});function v(e,t,n,r){var a,i,l,s,u,h,y,C,b,v,R,L,E,k,I,T;if(t.xmaData==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""])),r),null;var D;if(t.xmaData.xmaDefaultCTA!=null){var x;D=S((x=t.xmaData)==null?void 0:x.xmaDefaultCTA)}else o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""])),r);var $;if(((a=t.xmaData)==null?void 0:a.xmaTargetType)!=null)$=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(t.xmaData.xmaTargetType);else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""])),r),null;var P;((i=t.xmaData)==null?void 0:i.xmaGatingType)!=null?P=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(t.xmaData.xmaGatingType):o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""])),r);var N;((l=t.xmaData)==null?void 0:l.xmaLayoutType)!=null?N=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(t.xmaData.xmaLayoutType):o("WALogger").WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""])),r);var M;if(e.threadJid!=null)M=e.threadJid;else return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""])),r),null;if(D!=null&&!o("MAWParseXMAProtocol").isValidCTA(D,$,!0))return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""])),r),null;var w;return((s=t.xmaData)==null?void 0:s.xmaContentRef)!=null&&(w=t.xmaData.xmaContentRef),{author:e.author,contentRef:w,ctas:[],defaultCTA:D,defaultPreviewMediaId:n!=null?n:void 0,externalId:e.externalId,headerTitle:t==null||(u=t.xmaData)==null?void 0:u.xmaHeaderTitle,isTombstoned:t==null||(h=t.xmaData)==null?void 0:h.xmaIsTombstoned,maxSubtitleNumOfLines:t==null||(y=t.xmaData)==null?void 0:y.xmaMaxSubtitleNumLines,maxTitleNumOfLines:t==null||(C=t.xmaData)==null?void 0:C.xmaMaxTitleNumLines,msgId:e.msgId,overlayIconGlyph:P,overlayTitle:t==null||(b=t.xmaData)==null?void 0:b.xmaHeaderSubtitle,previewMediaIds:n!=null?[n]:[],subtitleText:t==null||(v=t.xmaData)==null?void 0:v.xmaSubtitleText,targetExpiringAtSec:((R=t.xmaData)==null?void 0:R.xmaTargetExpiry)!=null?o("WATimeUtils").castToUnixTime(Number((L=t.xmaData)==null?void 0:L.xmaTargetExpiry)):void 0,targetId:t==null||(E=t.xmaData)==null?void 0:E.xmaTargetId,targetType:$,targetUsername:t==null||(k=t.xmaData)==null?void 0:k.xmaTargetUsername,threadJid:M,titleText:(I=t.xmaData)==null?void 0:I.xmaTitleText,xmaDataclass:(T=t.xmaData)==null?void 0:T.xmaDataclass,xmaLayoutType:N}}function S(e){return{actionUrl:e,buttonType:o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:e}}l.writeXMAToXMAStore=h,l.getMediaForXMAByObjectIds=C,l.writeXMAsToDb=b,l.getDefaultCTA=S}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum","MAWJids","WAGlobals","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message"}),s=":";function u(e,t){return""+e+s+t}function c(e){return e.split(s)[1]}function d(e,t){var n=t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),r=new RegExp("^"+n,"i");return r.test(e)}function m(t){return d(t,e.REACTION)}function p(t){return d(t,e.EDIT)}function _(t){return d(t,e.RAVEN_ACTION_MESSAGE)}function f(t){var n=t.split(s);if(n.length===1)return{rawIdentifierString:t,type:"poll_update"};var r=n[0];if(n.length<2||n.length>3)return{prefix:r,rawIdentifierString:t,type:"unknown"};var a=n[1],i=o("MAWJids").toUserJid(a);if(r===e.REACTION)return{senderJid:i,type:"reaction"};var l=n.length===3?o("WATimeUtils").castToMillisTime(Number(n[2])):null;return r===e.RAVEN_ACTION_MESSAGE?{senderJid:i,type:"raven_action_message"}:l==null?{prefix:r,rawIdentifierString:t,type:"unknown"}:r===e.EDIT?{senderJid:i,ts:l,type:"edit"}:{prefix:r,rawIdentifierString:t,type:"unknown"}}function g(t){switch(t.type){case"edit":return""+e.EDIT+s+o("WAJids").extractUserId(t.senderJid)+s+t.ts.toString();case"reaction":return""+e.REACTION+s+o("WAJids").extractUserId(t.senderJid);case"raven_action_message":return""+e.RAVEN_ACTION_MESSAGE+s+o("WAJids").extractUserId(t.senderJid);case"poll_update":return t.rawIdentifierString}}function h(t){var n;if(o("WAJids").isAuthorMe(t))n=o("WAGlobals").getMyUserJid();else{var r=o("WAJids").interpretAndValidateJid(t);if(r.jidType==="msgrUser")n=r.userJid;else return null}var a=o("WAJids").userIdFromJid(n);return""+e.REACTION+s+a}function y(t,n){var r;if(o("WAJids").isAuthorMe(t))r=o("WAGlobals").getMyUserJid();else{var a=o("WAJids").interpretAndValidateJid(t);if(a.jidType==="msgrUser")r=a.userJid;else return null}var i=o("WAJids").userIdFromJid(r);return""+e.EDIT+s+i+s+n.toString()}l.SupplementalKeyPrefix=e,l.SUPPLEMENTAL_KEY_DELIMITER=s,l.createMessageSupplementalKey_DEPRECATED=u,l.getSupplementalSenderId_DEPRECATED=c,l.isSupplementalProtobufAReaction=m,l.isSupplementalProtobufAnEdit=p,l.isSupplementalProtobufARavenAction=_,l.parseIdentifierString=f,l.toIdentifierString=g,l.createReactionSupplementalKey=h,l.createEditSupplementalKey=y}),98);
__d("PersistedQueuesSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";var e={autoIncrement:!0,indexes:{"[jid+priority+stanzaId]":{fields:["jid","priority","stanzaId"],unique:!1},priority:{fields:["priority"],unique:!1}},nonEncryptedFields:["priority","stanzaId"],primaryKey:"stanzaQueueId",secure:!0},s={autoIncrement:!0,indexes:{},nonEncryptedFields:["uploadStatus","uploadTsSec","backupActionType"],primaryKey:"queueId",secure:!0},u={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},c={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},d={danglingQueue:u,ebSenderUploadQueueV3:c,ebUploadQueue:s,stanzaQueue:e};function m(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="pqdb",u=new(o("WormEAR")).WormEAR(d,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,d,u,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.makePersistedQueueSchema=m}),98);
__d("PersistedQueueDB",["FBLogger","PersistedQueuesSchema","WAResolvable","WormEAR","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){var n=t.blockingErrorThreshold,a=t.dbName,i=t.onBlockingError,l=t.qplEvent,u=t.strEncKey;try{var c=o("PersistedQueuesSchema").makePersistedQueueSchema(a,u,n,i,function(t){if(t instanceof o("WormEAR").DecryptionError){var n,a,i=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",i.store),r("promiseDone")((n=(a=e)==null?void 0:a.runInTransaction([i.store],"readwrite",function(e){var t=e.stores[i.store];return i.maybeHashedPk!=null?t.delete(i.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?n:Promise.resolve())}},l);return e=c,await c.init(),s.resolve(c),c}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing PersistedQueue init"),e}}function c(){if(e==null)throw r("err")("PersistedQueue is not initialized");return e}function d(){return s.promise}l.makePersistedQueues=u,l.getPersistedQueues=c,l.getDbPromise=d}),98);
__d("WAThrottle",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=0,r=null,o;function a(){for(var a=Date.now(),i=a-n,l=arguments.length,s=new Array(l),u=0;u<l;u++)s[u]=arguments[u];o=s,i>=t?(clearTimeout(r),r=null,e.apply(void 0,s),n=Date.now()):r==null&&(r=setTimeout(function(){return e.apply(void 0,o)},t-i))}return a}i.throttle=e}),66);
__d("PersistedQueueApi",["PersistedQueueDB","WALogger","WAThrottle"],(function(t,n,r,o,a,i,l){"use strict";var e,s=36e5,u=function(t,n){return"PersistedQueue:"+t+":"+n};function c(){return{ack:p,clear:_,count:b,delete:f,get:d,index:m,keys:h,read:g,write:y}}function d(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){var r=n.stores[e];return r.get(t)},u(e,"get"))}function m(e,t){return{equals:function(r){return{read:function(a){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexRange(t,{only:r},a)},u(e,"index-equal"))}}},keys:function(){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexKeys(t)},"index-keys")},read:async function(r){var n=await o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndex(t,void 0,r)},u(e,"index-read"));return n}}}function p(e,t){return f(e,t)}function _(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(t){return t.stores[e].clear()},u(e,"clear"))}function f(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",async function(n){var r=n.stores[e];await r.bulkDelete(t),v(e)},u(e,"delete"))}function g(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readAll(t)},u(e,"read"))}function h(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].readKeys()},u(e,"keys"))}function y(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(n){return n.stores[e].bulkAdd(t)},u(e,"write"))}function C(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",async function(t){var n=t.stores[e],r=await n.readAll({limit:1});r.length===0&&await n.clear()},u(e,"ClearIfEmpty"))}function b(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].count()},u(e,"count"))}var v=o("WAThrottle").throttle(function(t){C(t).catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueueV2] Error during PQ clear operation of ",": ",""])),t,n)})},s);l.persistedQueueApi=c,l.persistedQueueGet=d,l.persistedQueueIndex=m,l.persistedQueueAck=p,l.persistedQueueClear=_,l.persistedQueueDelete=f,l.persistedQueueRead=g,l.persistedQueueKeys=h,l.persistedQueueWrite=y,l.clearIfEmpty=C,l.persistedQueueCount=b}),98);
__d("WAMapContentTypeToFbType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"text":return"text";case"media":return"media";case"reaction":return"reaction";case"live_location":case"pay":case"product_list":case"poll_creation":case"poll_vote":case"scheduled_call":return"text";default:return"text"}}i.mapContentTypeToFbType=e}),66);
__d("WAPersistedQueueCache",["WAResolvable","WAShiftTimer","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("WATagsLogger").TAGS(["PersistedQueue",t,"cache"]),i=[],l=new(o("WAResolvable")).Resolvable,s=r!=null?r:{},u=new(o("WAShiftTimer")).ShiftTimer(function(){m()});return{commit:function(){return m()},add:function(t){i.push(t);var e=l;return c(),d(),e.promise},config:function(t){s=t}};function c(){s.cacheSize!=null&&i.length>=s.cacheSize&&m()}function d(){if(s.maxDelay!=null){var e=s.maxDelay;u.cancel(),u.onOrAfter(e)}}async function m(){if(i.length!==0){u.cancel();var t=i;i=[];var r=l;l=new(o("WAResolvable")).Resolvable;try{await n(t),r.resolve()}catch(t){throw a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during flush: ",""])),t),r.reject(t),t}}}}l.makePersistedQueueCache=s}),98);
__d("WAPersistedQueue",["WAPersistedQueueCache","WAPubSub"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n){var r=this;this.$1=o("WAPubSub").simplePubSub(),this.$3=e,this.$4=t,this.$2=o("WAPersistedQueueCache").makePersistedQueueCache(e,function(n){return t.write(e,n).then(function(e){r.$1.publish({type:"flush"})})},n)}var t=e.prototype;return t.subscribe=function(t){return this.$1.subscribe(t)},t.index=function(e){return this.$4.index(this.$3,e)},t.keys=function(){return this.$4.keys(this.$3)},t.get=function(t){return this.$4.get(this.$3,t)},t.read=function(t){return this.$4.read(this.$3,t)},t.addAndCommit=function(t){var e=this;return this.$1.publish({type:"new_entity"}),this.$4.write(this.$3,t).then(function(t){return e.$1.publish({type:"flush"}),t})},t.commit=function(){return this.$2.commit()},t.ack=function(t){return this.$4.ack(this.$3,t)},t.delete=function(t){return this.$4.delete(this.$3,t)},t.clear=function(){return this.$4.clear(this.$3)},t.count=function(){return this.$4.count(this.$3)},e})();function s(t,n,r){return new e(t,n,r)}l.PersistedQueue=e,l.initPersistedQueue=s}),98);
__d("WAProtocolQueue",["PersistedQueueApi","WAGlobals","WAJids","WALogger","WAMapContentTypeToFbType","WAPersistedQueue"],(function(t,n,r,o,a,i,l){"use strict";var e,s=5e3,u=null;function c(t){if(u!=null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Protocol Queue is already initialized"]))),u;var n=o("WAPersistedQueue").initPersistedQueue("stanzaQueue",t,{cacheSize:null,maxDelay:s});return u=n,u}function d(){return u||c(o("PersistedQueueApi").persistedQueueApi())}var m=(function(){function e(){this.$1=[],this.$2=[],this.$3=[]}var t=e.prototype;return t.enqueue=function(t,n,r){this.$1.push(t),n&&this.$2.push(n),r&&this.$3.push(r)},t.flush=function(t,n,r,o){var e=this.$1,a=this.$2,i=this.$3;return this.$1=[],this.$2=[],this.$3=[],d().addAndCommit(e).then(function(){return a.forEach(function(e){return e()})}).catch(function(e){return i.forEach(function(t){return t(e)})})},e})(),p=new m;function _(e){return e.map(function(e){return e.type==="message"?f(e):babelHelpers.extends({},e)})}function f(e){switch(e.subtype){case"unavailable":{var t=e,n=o("WAJids").extractUserJid(t.from),r={id:{author:o("WAGlobals").getMyUserJid()===n?"@me":n,chat:t.jid,externalId:t.stanzaId},ts:t.serverTs,type:"UnavailableMsg"};return{incomingType:"wa-incoming",jid:t.jid,message:{decrypted:r,details:{count:null,externalId:t.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(t.jid,{group:function(n){return{author:t.from,chat:n,groupJid:n,type:"group"}},user:function(n){return{author:t.from,chat:n,deviceJid:t.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:t.offline,recipient:t.recipient,reportingMeta:t.reportingMeta,retryCount:t.retryCount,ts:t.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(t.contentType)}},priority:t.priority,stanzaId:t.stanzaId,stanzaQueueId:e.stanzaQueueId,type:t.type}}case"armadillo":{var a=e,i=o("WAJids").extractUserJid(a.from),l={folder:a.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===i?"@me":i,chat:a.jid,externalId:a.stanzaId},msg:a.message,recipientsCount:null,reportingMeta:a.reportingMeta,ts:a.serverTs,type:"IncomingMsg"};return{incomingType:e.incomingType,jid:a.jid,message:{decrypted:l,details:{count:null,externalId:a.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(t){return{author:a.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:a.from,chat:t,deviceJid:a.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:a.offline,recipient:a.recipient,reportingMeta:a.reportingMeta,retryCount:a.retryCount,ts:a.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(a.contentType)}},priority:a.priority,stanzaId:a.stanzaId,stanzaQueueId:e.stanzaQueueId,type:a.type,ebTimestampMs:a.ebTimestampMs}}case"instamadillo":{var s=e,u=o("WAJids").extractUserJid(s.from),c={folder:s.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===u?"@me":u,chat:s.jid,externalId:s.stanzaId},msg:s.message,recipientsCount:null,reportingMeta:s.reportingMeta,ts:s.serverTs,type:"InstamadilloMsg"};return{incomingType:"wa-incoming",jid:s.jid,message:{decrypted:c,details:{count:null,externalId:s.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(s.jid,{group:function(t){return{author:s.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:s.from,chat:t,deviceJid:s.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!0,offline:s.offline,recipient:s.recipient,reportingMeta:s.reportingMeta,retryCount:s.retryCount,ts:s.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(s.contentType)}},priority:s.priority,stanzaId:s.stanzaId,stanzaQueueId:e.stanzaQueueId,type:s.type}}case"ciphertext":{var d=function(){return!(m.contentType==="reaction"||m.hideDecryptionFailure===!0)},m=e,p=o("WAJids").extractUserJid(m.from),_={createPlaceholder:d(),id:{author:o("WAGlobals").getMyUserJid()===p?"@me":p,chat:m.jid,externalId:m.stanzaId},ts:m.serverTs,type:"IncomingCiphertextMsg"};return{incomingType:"wa-incoming",jid:m.jid,message:{decrypted:_,details:{count:null,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(m.contentType),externalId:m.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(m.jid,{group:function(t){return{author:m.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:m.from,chat:t,deviceJid:m.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:m.offline,recipient:m.recipient,reportingMeta:m.reportingMeta,retryCount:m.retryCount,ts:m.serverTs}},priority:m.priority,stanzaId:m.stanzaId,stanzaQueueId:e.stanzaQueueId,type:m.type}}default:return babelHelpers.extends({},e)}}var g=9,h=7,y=5,C=2;function b(e){return e}function v(e){return e}function S(e){return e}l.initProtocolQueue=c,l.protocolQueue=d,l.PQFlushable=m,l.pqFlushable=p,l.mapProtocolEntriesV2toV1=_,l.mapProcolQueueMessageV2toV1=f,l.WAProtocolQueuePriorityHigh=g,l.WAProtocolQueuePriorityMid=h,l.WAProtocolQueuePriorityLow=y,l.WAProtocolQueuePriorityBackground=C,l.appdataApplicationProtocol=b,l.extractSubProtocolFromAppdataProtocol=v,l.numberToStanzaQueueId=S}),98);
__d("MAWHandleEBRestoreWithHIM",["EBAPIWorkerCheck","EchoMessage","EncryptedBackupsUploadEntity","FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWBulkEditMsgsTxns","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMsg","MAWEchoToProtobufConversionLoggingUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWJids","MAWMsgType","MAWODSProxy","MAWParseXMAProtocol","MAWUnsafeCoerce","MAWUserJidWrapper","MessageBackupSupplementalKeyGenerator","MpsTags","Random","WAGlobals","WAHashUtils","WAJids","WALogger","WALongInt","WAOdsEnums","WAProtocolQueue","WAResultOrError","WASortedLists","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["originalTs","threadJid","unsendMsgContentDeleteTs"],s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k;function I(e,t){return e==="@me"||e==="@system"?t:e}function T(e,t,n,r,a){var i=[];if(e.reactionXOfflineThreadingIds!=null)for(var l=0;l<e.reactionXOfflineThreadingIds.length;++l){var s=o("MAWHandleEchoReactionsRestore").getReactionsForReactionStore(t,n,r,null,a,e),u=s.map(function(e){return{decodedMsg:{unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:e,unstoredDbReceiverFetchInfo:void 0},stanza:P(e.externalId,e.ts,I(e.author,n),t,"reaction")}});i.push.apply(i,u)}return i}function D(e,t,n,r,a){return r.map(function(r){if(r.messageId==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] messageId is null in edit, original externalId: ",""])),e),a!=null&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(a,"getUnstoredDbEditsFromEcho_messageId_missing"),null;var i=r.messageId;return{decodedMsg:{unstoredDbEditActionMsg:{ack:o("MAWAckLevel").ACK.sent,author:n,editMsgContent:{content:r.text},externalId:o("WAStanzaUtils").toStanzaId(i),originalMsgExternalId:e,serverTs:o("WATimeUtils").castToUnixTime(r.timestamp),ts:o("WATimeUtils").castToUnixTime(r.timestamp),type:o("MAWMsgType").MSG_TYPE.EDIT_ACTION},unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:void 0},stanza:P(o("WAStanzaUtils").toStanzaId(i),o("WATimeUtils").castToUnixTime(r.timestamp),n,t,"text")}}).filter(Boolean)}function x(e,t){return e.map(F).filter(Boolean).map(function(e){return $(e,t)})}function $(e,t){var n,a=o("MAWUserJidWrapper").getMyUserJid(),i=e.from,l=o("MAWHandleEchoMsgsRestoreApiUtils").getDbMsgTypeFromEchoMessage(e);if(i==null||l==null)return[];var s=e.xOfflineThreadingId;if(s==null)return r("FBLogger")("wmi_eb").warn("xOfflineThreadingId is null for Echo message"),[];var u=o("WAStanzaUtils").toStanzaId(s),c=o("WATimeUtils").castToUnixTime(((n=e.authoritativeTimestampMs)!=null?n:e.sortOrderMs)/1e3),d=o("MAWJids").toUserJid(i.localKey),m=A(e,t,a,u,"echo_content");if(m.success===!1)return[];var p=m.value,_=T(e,t,a,u,d),f=e.contentType===o("EchoMessage").EchoMessageContentType.TEXT||e.contentType===o("EchoMessage").EchoMessageContentType.PLACEHOLDER?"text":"media",g=D(u,t,d,e.editHistory);return[{decodedMsg:p,stanza:P(u,c,d,t,f)}].concat(_,g)}function P(e,t,n,r,a){var i={applicationPayload:new Uint8Array(0).buffer,backupDirective:null,icdc:null,metadata:null,protobuf:new Uint8Array(0),subprotocol:new Uint8Array(0),subprotocolType:"consumerMessage",type:"subprotocol",version:"v3"},l={folder:null,id:{author:n,chat:r,externalId:e},msg:i,recipientsCount:null,reportingMeta:null,ts:t,type:"IncomingMsg"};return{incomingType:"ebrestore",jid:r,message:{decrypted:l,details:{count:0,externalId:e,from:o("WAJids").switchOnMsgrChatJidType(r,{group:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,groupJid:t,type:"group"}},user:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,deviceJid:o("WAJids").defaultDeviceJidForUser(n),type:"device"}}}),hideDecryptionFailure:!0,isInstamadillo:!1,offline:null,recipient:null,reportingMeta:null,retryCount:0,ts:t,type:a}},priority:o("WAProtocolQueue").WAProtocolQueuePriorityLow,stanzaId:e,stanzaQueueId:o("MAWUnsafeCoerce").unsafeCoerce(-1),type:"message"}}function N(e){if(e.mediaData==null)return o("WAResultOrError").makeResult(null);var t=e.previewMediaData,n=e.sortOrderMs,r=e.xOfflineThreadingId,a=e.mediaData,i=a.attachmentObjectId,l=a.backupEntFbid,s=a.directPath,d=a.encryptedHash,m=a.filename,p=a.height,_=a.mediaContentType,f=a.mediaKey,g=a.mediaKeyTimestamp,h=a.mediaPlayableDuration,y=a.plaintextHash,C=a.previewContentHeight,b=a.previewContentWidth,v=a.size,S=a.width,R=e.contentType===o("EchoMessage").EchoMessageContentType.XMA,L=o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(_||"",R),E=L.mediaType,k=L.serverMediaType,I=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(y)),T=null;if(t!=null)try{T=o("MAWHandleEchoMediaMsgsRestoreV2").constructRawDownloadableThumbnail(t),T!=null&&T.objectId==null&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloadableThumbnail was created without metadata, source: protobuf"])))}catch(t){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",". Echo message origin ",""])),t,r,e.serializationOrigin)}if(f==null)return o("WAResultOrError").makeError("missing_media_key");if(d==null)return o("WAResultOrError").makeError("missing_encrypted_hash");var D=o("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(I,d,f,s,g,k,m,l,i,T,v),x=o("MAWHandleEchoMediaMsgsRestoreV2").getMediaInfo({filename:m,height:p,mediaPlayableDuration:h,mediaType:E,previewContentHeight:C,previewContentWidth:b,width:S}),$=x.validatedAudioInfo,P=x.validatedDocumentFileInfo,N=x.validatedImageInfo,M=x.validatedVideoInfo;return o("WAResultOrError").makeResult({mediaEntry:D,mediaType:E,msgIds:o("WASortedLists").asSortedSet(new Set),plaintextHash:o("WAHashUtils").stringToPlaintextHash(y),size:v||0,ts:g!=null?o("WATimeUtils").castToUnixTime(g):o("WATimeUtils").castMilliSecondsToUnixTime(n),validatedAudioInfo:$,validatedDocumentFileInfo:P,validatedImageInfo:N,validatedVideoInfo:M})}function M(e,t){if(e.xmaData==null||e.from==null||e.xOfflineThreadingId==null)return o("WAResultOrError").makeResult(null);var n=e.from,r=e.serializationOrigin,a=e.xmaData,i=e.xOfflineThreadingId,l=a.xmaContentRef,s=a.xmaDataclass,u=a.xmaDefaultCTA,c=a.xmaGatingType,p=a.xmaHeaderSubtitle,_=a.xmaHeaderTitle,f=a.xmaIsTombstoned,g=a.xmaLayoutType,h=a.xmaMaxSubtitleNumLines,y=a.xmaMaxTitleNumLines,C=a.xmaSubtitleText,b=a.xmaTargetExpiry,v=a.xmaTargetId,S=a.xmaTargetType,R=a.xmaTargetUsername,L=a.xmaTitleText;if(S==null)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Mandatory XMA Data missing for XMA message. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var E=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(S),k;if(u!=null&&(k=o("MAWHandleEchoXMARestoreV2").getDefaultCTA(u)),k!=null&&!o("MAWParseXMAProtocol").isValidCTA(k,E,!0))return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] defautlCTA failed validation check. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_cta_validation_failure");var I;c!=null&&(I=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(c));var T;b!=null&&(T=o("WATimeUtils").castToUnixTime(b));var D;return g!=null&&(D=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(g)),o("WAResultOrError").makeResult({unstoredDbXMA:{author:o("MAWJids").toUserJid(n.localKey),contentRef:l,ctas:[],defaultCTA:k,externalId:o("WAStanzaUtils").toStanzaId(i),headerTitle:_,isTombstoned:f,maxSubtitleNumOfLines:h,maxTitleNumOfLines:y,overlayDescription:p,overlayIconGlyph:I,overlayTitle:_,subtitleText:C,targetExpiringAtSec:T,targetId:v,targetType:E,targetUsername:R,threadJid:t,titleText:L,xmaDataclass:s,xmaLayoutType:D}})}function w(e){if(e.receiverFetchId==null||e.receiverFetchData==null)return o("WAResultOrError").makeResult(null);var t=e.receiverFetchData,n=e.receiverFetchId;return t.type!=="sticker"?(o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unsupported receiver fetch message type: ",". Echo message origin ",""])),t.type,e.serializationOrigin),o("WAResultOrError").makeError("unsupported_message_type")):o("WAResultOrError").makeResult({mimetype:t.mimetype,previewHeight:t.previewHeight,previewWidth:t.previewWidth,receiverFetchId:n,type:t.type})}function A(t,n,r,a,i){var l=o("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(t,n,r,a,void 0,i);if(l.success===!1)return o("WAResultOrError").makeError(l.error);var s=l.value,u=s.originalTs,c=s.threadJid,d=s.unsendMsgContentDeleteTs,m=babelHelpers.objectWithoutPropertiesLoose(s,e);m.sortOrderMs=t.sortOrderMs;var p=N(t);if(p.success===!1)return p;var _=M(t,n);if(_.success===!1)return o("WAResultOrError").makeError(_.error);var f=_.value,g=w(t);if(g.success===!1)return o("WAResultOrError").makeError(g.error);var h=g.value;return o("WAResultOrError").makeResult({unstoredDbMedia:p.value,unstoredDbMsg:m,unstoredDbReaction:void 0,unstoredDbReceiverFetchInfo:h!=null?h:void 0,unstoredXMA:f!=null?f:void 0})}function F(e){try{return o("EchoMessage").decodeEchoMessage(e)}catch(e){return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode echo message: ",""])),e),null}}function O(e,t){if(!o("EBAPIWorkerCheck").runningInWorker())throw r("FBLogger")("messenger_web").mustfixThrow("convertEchoMessagesToEBProtobufs should be called from the worker thread");var n=e.map(function(e){return B(e,t)}).filter(Boolean);return o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.success"}),n.length!==e.length&&(o("WALogger").WARN(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to convert all echo messages to protobuf. Chat: ",", echo messages count: ",", converted echo messages count: ",""])),t,e.length,n.length),o("MAWODSProxy").odsBumpEntityKey({amount:e.length-n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.fail"})),n}function B(e,t){var n=r("Random").uint32();o("MAWEchoToProtobufConversionLoggingUtils").startQplUserFlow(n);var a=F(e);if(a==null)return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to decode echo message"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_decode_failure"),null;var i=o("WAGlobals").getMyUserJid(),l=a.from,s=a.sortOrderMs,u=a.xOfflineThreadingId,c=o("WATimeUtils").castToMillisTime(s);if(u==null||l==null)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] One of the mandatory fields is null for Echo message. Echo message origin ",""])),a.serializationOrigin),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"mandatory_fields_missing"),null;var d=o("MAWJids").toUserJid(l.localKey),m=o("WAStanzaUtils").toStanzaId(u),p=A(a,t,i,m,"first_edit_content");if(p.success===!1)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: ",""])),p.error),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_message_parsing_failure_"+p.error),null;if(p.value.unstoredDbMsg==null)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: unstoredDbMsg missing in UnstoredDbContent"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"unstoredDbMsg_conversion_failure_unstoredDbMsg_missing"),null;var _=p.value,f=_.unstoredDbMedia,I=_.unstoredDbMsg,x=_.unstoredDbReceiverFetchInfo,$=_.unstoredXMA,P={author:d,chat:t,externalId:m};I!=null&&(I.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),($==null?void 0:$.unstoredDbXMA)!=null&&($.unstoredDbXMA.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),f!=null&&(f.msgIds=o("WASortedLists").asSortedSet(new Set([o("MAWDbMsg").stanzaIdToMsgId(m)])));var N;($==null?void 0:$.unstoredDbXMA)!=null&&(N={associatedMessage:null,defaultPreview:f!=null?f:null,favicon:null,header:f!=null?f:null,previews:f!=null?[f]:null,xma:$.unstoredDbXMA});var M={frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},w;try{w={decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeMessageApplication(I,f,null,N,t,x),msgId:P,reportingMeta:M,sortOrderMs:c})),protobufTimestampMS:c}}catch(e){return o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"top_level_protobuf_encoding_failure"),o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Exception when trying to encode top-level protobuf: ",""])),e),null}var O=new Map,B=D(m,t,d,a.editHistory).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbEditActionMsg}).filter(Boolean).filter(function(e){return e.externalId!==e.originalMsgExternalId}).map(function(e){return o("MAWBulkEditMsgsTxns").getMessageHistory(e,t)});B.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_edits"),B.forEach(function(e){var r=e.author,a=e.editTs,i=o("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(r,o("WATimeUtils").castUnixTimeToMillisTime(a));if(i==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create edit supplemental key"])));return}if(e.editExternalId==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to fetch edit external id"])));return}var l=e.editExternalId;try{O.set(i,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeEditMessageApplication(e),msgId:{author:d,chat:t,externalId:l},reportingMeta:M,sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(e.editTs)})),protobufTimestampMS:o("WATimeUtils").castUnixTimeToMillisTime(a)})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode edit supplemental protobuf: ",""])),e)}});var W=T(a,t,i,m,d).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbReaction}).filter(Boolean);W.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_reactions"),W.forEach(function(e){var r=e.author,a=e.senderTimestampMs,i=e.ts,l=a!=null?o("WATimeUtils").castToMillisTime(o("WALongInt").numberOrThrowIfTooLarge(a)):o("WATimeUtils").castUnixTimeToMillisTime(i),s=o("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(r);if(s==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_key_generation_failure"),o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create reaction supplemental key"])));return}try{O.set(s,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeReactionMessageApplication(e),msgId:{author:d,chat:t,externalId:e.externalId},reportingMeta:M,sortOrderMs:l})),protobufTimestampMS:l})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode reaction supplemental protobuf: ",""])),e)}}),o("MAWEchoToProtobufConversionLoggingUtils").endSuccess(n);var q;try{q=o("MpsTags").getTagFromProto(w.decryptedProtobuf)}catch(e){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get tag from proto: ",""])),e)}return{otid:m,supplementalProtobufs:O,tags:q!=null?[q]:[],toplevelProtobuf:w}}l.convertEchoMessages=x,l.convertEchoMessagesToEBProtobufs=O}),98);
__d("MAWUICacheServicesBase",["FBLogger","MAWCacheServiceDB","MAWCacheServiceQPL"],(function(t,n,r,o,a,i,l){"use strict";var e=["id"];function s(e){return e+"_mps_reactive"}var u=(function(){function t(e){this.$1=new Map,this.QPLMetadata=new Map,this.$2=e}var n=t.prototype;return n.resetInMemoryCache=function(t,n){var e=this.$1.get(t);e!=null&&(n==null||n.length===0||(r("FBLogger")("MAWUICacheServices").info("Reset in memory cache. Namespace: %s",t),n.forEach(function(t){e.delete(t)})))},n.updateInMemoryCacheAndTriggerCallback=function(t,n,o,a,i){this.$3(t,n);var e=this.$2[t];e!=null&&(a!=null&&(r("MAWCacheServiceQPL").addPointQPL(a,"triggering_callback",o),(o==="cache-invalidation"||o==="realtime-update"||o==="from-scratch"&&this.QPLMetadata.get(a)==="all-from-scratch"||o==="in-memory"&&i===!0)&&(r("MAWCacheServiceQPL").endSuccessQPL(a),this.QPLMetadata.delete(a))),e.onCacheChange(n,o))},n.checkInMemoryCacheAndTriggerCallback=function(t,n,o){var e=this,a=[],i=[];n.forEach(function(n){var r=e.$4(t,n);r==null?a.push(n):i.push([n,r])});var l=a.length===0;return l&&o!=null&&r("MAWCacheServiceQPL").addPointQPL(o,"all_in_memory"),i.length>0&&this.updateInMemoryCacheAndTriggerCallback(t,i,"in-memory",o,l),a},n.checkPersistedCacheAndTriggerCallback=async function(n,a,i){var t=await o("MAWCacheServiceDB").getOrSetupMAWCacheDB(),l=await t.runInTransaction([n],"readonly",function(e){return Promise.all(a.map(function(t){return e.stores[n].getByIndex("key",[s(t)])}))},"read_from_persisted_"+n),u=[],c=[];return l.forEach(function(t,n){if(t==null)u.push(a[n]);else{var r=t.id,o=babelHelpers.objectWithoutPropertiesLoose(t,e);c.push([a[n],o])}}),i!=null&&r("MAWCacheServiceQPL").addAnnotationsQPL(i,{int:{numPersistedHit:c.length,numPersistedMiss:u.length}}),u.length===0&&i!=null&&r("MAWCacheServiceQPL").addPointQPL(i,"all_in_persisted"),c.length>0&&this.updateInMemoryCacheAndTriggerCallback(n,c,"persisted",i),u},n.$3=function(t,n){var e,r=(e=this.$1.get(t))!=null?e:new Map;n.forEach(function(e){var t=e[0],n=e[1];r.set(t,n)}),this.$1.set(t,r)},n.$4=function(t,n){var e=this.$1.get(t);if(e==null)return null;var r;return(r=e.get(n))!=null?r:null},t})();l.adjustCacheKey=s,l.MAWUICacheServicesBase=u}),98);
__d("MWChatEncryptedBackupsLogging",["MWEBODSCategory","MWEBODSEntityKey.enum","ODS","QPLUserFlow"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){var t=e.cancelEndPoint,n=e.event,o=e.instanceKey,a=e.source;a!=null&&r("QPLUserFlow").addAnnotations(n,{string:{source:a}},{instanceKey:o}),r("QPLUserFlow").addPoint(n,"cancel",{instanceKey:o}),r("QPLUserFlow").addAnnotations(n,{string:{cancel_end_point:t}},{instanceKey:o}),r("QPLUserFlow").endCancel(n,{instanceKey:o})}function u(e){var t=e.event,n=e.instanceKey,o=e.onClose,a=e.source;a!=null&&r("QPLUserFlow").addAnnotations(t,{string:{source:a}},{instanceKey:n}),s({cancelEndPoint:"dialog_x_button",event:t,instanceKey:n}),o()}function c(t){var n=t.annotations,a=t.event,i=t.instanceKey,l=t.odsEntityName;r("QPLUserFlow").addPoint(a,"success",{instanceKey:i}),r("QPLUserFlow").endSuccess(a,{annotations:n,instanceKey:i}),l&&(e||(e=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),l,r("MWEBODSEntityKey.enum").SUCCESS)}function d(t){var n=t.annotations,a=t.errorName,i=t.event,l=t.instanceKey,s=t.odsEntityKey,u=t.odsEntityName;r("QPLUserFlow").addPoint(i,"failure",{instanceKey:l}),r("QPLUserFlow").endFailure(i,a,{annotations:n,instanceKey:l}),u&&(e||(e=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),u,s!=null?s:r("MWEBODSEntityKey.enum").FAIL)}l.cancelFlow=s,l.closeDialogCancelFlow=u,l.endSuccess=c,l.endFailure=d}),98);
__d("WAAppData",[],(function(t,n,r,o,a,i){"use strict";var e=1,l=2;i.EPOCH_STATUS_OPEN=e,i.EPOCH_STATUS_CLOSE=l}),66);
__d("WAArmadilloICDC.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="ICDCIdentityList",s.internalSpec={seq:[1,(e=o("WAProtoConst")).TYPES.INT32],timestamp:[2,e.TYPES.INT64],devices:[3,e.FLAGS.REPEATED|e.TYPES.BYTES],signingDeviceIndex:[4,e.TYPES.INT32]},u.name="SignedICDCIdentityList",u.internalSpec={details:[1,e.TYPES.BYTES],signature:[2,e.TYPES.BYTES]},l.ICDCIdentityListSpec=s,l.SignedICDCIdentityListSpec=u}),98);
__d("WAArrayChunk",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n,r){n===void 0&&(n=!1);for(var o=0,a=[];o<e.length;){for(var i=[],l=0;o<e.length;){var s=e[o],u=r?r(s):1;if(!n&&l===0||l+u<=t)l+=u,i.push(s),o++;else{n&&u>t&&o++;break}}i.length>0&&a.push(i)}return a}i.chunk=e}),66);
__d("WACryptoPkcs7",["WACryptoDependencies","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=new Uint8Array(1);do o("WACryptoDependencies").getCrypto().getRandomValues(t);while(t[0]===0);u(e,t[0])}function s(e){var t=new Uint8Array(1);o("WACryptoDependencies").getCrypto().getRandomValues(t),u(e,(t[0]&15)+1)}function u(e,t){for(var n=0;n<t;n++)e.writeUint8(t)}function c(e){if(e.length===0)throw r("err")("unpadPkcs7 given empty bytes");var t=e[e.length-1];if(t>e.length)throw r("err")("unpadPkcs7 given "+e.length+" bytes, but pad is "+t);return new Uint8Array(e.buffer,e.byteOffset,e.length-t)}l.writeRandomPad=e,l.writeRandomPadMax16=s,l.writePad=u,l.unpadPkcs7=c}),98);
__d("WAMsgTransport.pb",["WACommon.pb","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={NOOP:0,UPSERT:1,DELETE:2,UPSERT_AND_DELETE:3},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={};u.name="MessageTransport",u.internalSpec={payload:[1,(e=o("WAProtoConst")).TYPES.MESSAGE,c],protocol:[2,e.TYPES.MESSAGE,d]},c.name="MessageTransport$Payload",c.internalSpec={applicationPayload:[1,e.TYPES.MESSAGE,o("WACommon.pb").SubProtocolSpec],futureProof:[3,e.TYPES.ENUM,o("WACommon.pb").FUTURE_PROOF_BEHAVIOR]},d.name="MessageTransport$Protocol",d.internalSpec={integral:[1,e.TYPES.MESSAGE,h],ancillary:[2,e.TYPES.MESSAGE,m]},m.name="MessageTransport$Protocol$Ancillary",m.internalSpec={skdm:[2,e.TYPES.MESSAGE,g],deviceListMetadata:[3,e.TYPES.MESSAGE,C],icdc:[4,e.TYPES.MESSAGE,_],backupDirective:[5,e.TYPES.MESSAGE,p]},p.name="MessageTransport$Protocol$Ancillary$BackupDirective",p.internalSpec={messageId:[1,e.TYPES.STRING],actionType:[2,e.TYPES.ENUM,s],supplementalKey:[3,e.TYPES.STRING]},_.name="MessageTransport$Protocol$Ancillary$ICDCParticipantDevices",_.internalSpec={senderIdentity:[1,e.TYPES.MESSAGE,f],recipientIdentities:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,f],recipientUserJids:[3,e.FLAGS.REPEATED|e.TYPES.STRING]},f.name="MessageTransport$Protocol$Ancillary$ICDCParticipantDevices$ICDCIdentityListDescription",f.internalSpec={seq:[1,e.TYPES.INT32],signingDevice:[2,e.TYPES.BYTES],unknownDevices:[3,e.FLAGS.REPEATED|e.TYPES.BYTES],unknownDeviceIds:[4,e.FLAGS.REPEATED|e.TYPES.INT32]},g.name="MessageTransport$Protocol$Ancillary$SenderKeyDistributionMessage",g.internalSpec={groupId:[1,e.TYPES.STRING],axolotlSenderKeyDistributionMessage:[2,e.TYPES.BYTES]},h.name="MessageTransport$Protocol$Integral",h.internalSpec={padding:[1,e.TYPES.BYTES],dsm:[2,e.TYPES.MESSAGE,y]},y.name="MessageTransport$Protocol$Integral$DeviceSentMessage",y.internalSpec={destinationJid:[1,e.TYPES.STRING],phash:[2,e.TYPES.STRING]},C.name="DeviceListMetadata",C.internalSpec={senderKeyHash:[1,e.TYPES.BYTES],senderTimestamp:[2,e.TYPES.UINT64],recipientKeyHash:[8,e.TYPES.BYTES],recipientTimestamp:[9,e.TYPES.UINT64]},l.MESSAGE_TRANSPORT_PROTOCOL_ANCILLARY_BACKUP_DIRECTIVE_ACTION_TYPE=s,l.MessageTransportSpec=u,l.MessageTransport$PayloadSpec=c,l.MessageTransport$ProtocolSpec=d,l.MessageTransport$Protocol$AncillarySpec=m,l.MessageTransport$Protocol$Ancillary$BackupDirectiveSpec=p,l.MessageTransport$Protocol$Ancillary$ICDCParticipantDevicesSpec=_,l.MessageTransport$Protocol$Ancillary$ICDCParticipantDevices$ICDCIdentityListDescriptionSpec=f,l.MessageTransport$Protocol$Ancillary$SenderKeyDistributionMessageSpec=g,l.MessageTransport$Protocol$IntegralSpec=h,l.MessageTransport$Protocol$Integral$DeviceSentMessageSpec=y,l.DeviceListMetadataSpec=C}),98);
__d("WAAsMessageTransport",["WABinary","WACryptoPkcs7","WAJids","WAMsgTransport.pb"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e.type){case"text":return{actionType:o("WAMsgTransport.pb").MESSAGE_TRANSPORT_PROTOCOL_ANCILLARY_BACKUP_DIRECTIVE_ACTION_TYPE.UPSERT,messageId:e.externalId,supplementalKey:null};case"media":return{actionType:o("WAMsgTransport.pb").MESSAGE_TRANSPORT_PROTOCOL_ANCILLARY_BACKUP_DIRECTIVE_ACTION_TYPE.UPSERT,messageId:e.externalId,supplementalKey:null};case"reaction":return{actionType:o("WAMsgTransport.pb").MESSAGE_TRANSPORT_PROTOCOL_ANCILLARY_BACKUP_DIRECTIVE_ACTION_TYPE.UPSERT,messageId:e.originalMsgExternalId,supplementalKey:"reaction:"+o("WAJids").extractChatId__DANGEROUS(e.chatJid)};case"edit":return{actionType:o("WAMsgTransport.pb").MESSAGE_TRANSPORT_PROTOCOL_ANCILLARY_BACKUP_DIRECTIVE_ACTION_TYPE.UPSERT,messageId:e.originalMsgExternalId,supplementalKey:"edit:"+o("WAJids").extractChatId__DANGEROUS(e.chatJid)+":"+(e.timestamp*1e3).toString()}}}function s(e,t,n,r,a,i){i===void 0&&(i=2);var l;t!=null&&(l={destinationJid:t});var s;e!=null&&(s={applicationPayload:{payload:e,version:i}});var u=new(o("WABinary")).Binary;return o("WACryptoPkcs7").writeRandomPadMax16(u),{payload:s,protocol:{integral:{padding:u.readBuffer(),dsm:l},ancillary:{skdm:n==null?void 0:n,icdc:r==null?void 0:r,backupDirective:a==null?void 0:{actionType:a.actionType,messageId:a.messageId,supplementalKey:a.supplementalKey}}}}}l.backupDirectiveActionType=o("WAMsgTransport.pb").MESSAGE_TRANSPORT_PROTOCOL_ANCILLARY_BACKUP_DIRECTIVE_ACTION_TYPE,l.constructBackupDirective=e,l.asMessageTransport=s}),98);
__d("WAConvertRegistrationIdMixin",["WAParsableXmlNode"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WAParsableXmlNode").convertBytesToUint(e.registrationElementValue,4)}l.registrationIdMixin=e}),98);
__d("WAConvertSignedPreKeyMixin",["WAParsableXmlNode"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{id:o("WAParsableXmlNode").convertBytesToUint(e.skeyIdKeyIDMixin.elementValue,3),pubkey:e.skeyValueKeyDataMixin.elementValue,signature:e.skeySignatureElementValue}}l.convertSignedPreKeyMixin=e}),98);
__d("WASmaxInPreKeysIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",r.value);if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","error");return s.success?o("WAResultOrError").makeResult({type:s.value}):s}l.parseIQErrorResponseMixin=e}),98);
__d("WASmaxInPreKeysIQErrorBadRequestMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","bad-request");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",400);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorBadRequestMixin=e}),98);
__d("WASmaxInPreKeysIQErrorFallbackClientMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").attrString(e,"text");if(!n.success)return n;var r=o("WASmaxParseUtils").attrIntRange(e,"code",400,499);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorFallbackClientMixin=e}),98);
__d("WASmaxInPreKeysIQErrorNoValidJIDMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","not-acceptable");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",406);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorNoValidJIDMixin=e}),98);
__d("WASmaxInPreKeysRequestErrorsFetch",["WAResultOrError","WASmaxInPreKeysIQErrorBadRequestMixin","WASmaxInPreKeysIQErrorFallbackClientMixin","WASmaxInPreKeysIQErrorNoValidJIDMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:t.value});var n=o("WASmaxInPreKeysIQErrorNoValidJIDMixin").parseIQErrorNoValidJIDMixin(e);if(n.success)return o("WAResultOrError").makeResult({name:"IQErrorNoValidJID",value:n.value});var r=o("WASmaxInPreKeysIQErrorFallbackClientMixin").parseIQErrorFallbackClientMixin(e);return r.success?o("WAResultOrError").makeResult({name:"IQErrorFallbackClient",value:r.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorBadRequest","IQErrorNoValidJID","IQErrorFallbackClient"],[t,n,r])}l.parseRequestErrorsFetch=e}),98);
__d("WASmaxInPreKeysFetchKeyBundlesResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrorsFetch","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrorsFetch").parseRequestErrorsFetch(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrorsFetch:i.value})):i}l.parseFetchKeyBundlesResponseRequestError=e}),98);
__d("WASmaxInPreKeysIQErrorFallbackServerMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").attrString(e,"text");if(!n.success)return n;var r=o("WASmaxParseUtils").attrIntRange(e,"code",500,599);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorFallbackServerMixin=e}),98);
__d("WASmaxInPreKeysIQErrorServiceUnavailableMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","service-unavailable");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",503);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorServiceUnavailableMixin=e}),98);
__d("WASmaxInPreKeysServerErrors",["WAResultOrError","WASmaxInPreKeysIQErrorFallbackServerMixin","WASmaxInPreKeysIQErrorServiceUnavailableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysIQErrorServiceUnavailableMixin").parseIQErrorServiceUnavailableMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorServiceUnavailable",value:t.value});var n=o("WASmaxInPreKeysIQErrorFallbackServerMixin").parseIQErrorFallbackServerMixin(e);return n.success?o("WAResultOrError").makeResult({name:"IQErrorFallbackServer",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorServiceUnavailable","IQErrorFallbackServer"],[t,n])}l.parseServerErrors=e}),98);
__d("WASmaxInPreKeysFetchKeyBundlesResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseFetchKeyBundlesResponseServerError=e}),98);
__d("WASmaxInPreKeysEnums",["WAJids"],(function(t,n,r,o,a,i,l){var e,s={validators:[(e=o("WAJids")).validateDeviceJid,e.validateDeviceJid],typeName:"DeviceJid|DeviceJid"},u={validators:[e.validateDeviceJid,e.validateDeviceJid,e.validateInteropDeviceJid,e.validateInteropDeviceJid],typeName:"DeviceJid|DeviceJid|InteropDeviceJid|InteropDeviceJid"},c={validators:[e.validateDeviceJid,e.validateDomainJid],typeName:"DeviceJid|DomainJid"},d={validators:[e.validateUserJid,e.validateUserJid],typeName:"UserJid|UserJid"};l.DEVICEJID_DEVICEJID=s,l.DEVICEJID_DEVICEJID_INTEROPDEVICEJID_INTEROPDEVICEJID=u,l.DEVICEJID_DOMAINJID=c,l.USERJID_USERJID=d}),98);
__d("WASmaxInPreKeysIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",r.value);if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","result");return s.success?o("WAResultOrError").makeResult({type:s.value}):s}l.parseIQResultResponseMixin=e}),98);
__d("WASmaxInPreKeysResponsePaddingMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"iq");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(e,"padding");if(!n.success)return n;var r=o("WASmaxParseUtils").contentBytesRange(n.value,0,524288);return r.success?o("WAResultOrError").makeResult({paddingElementValue:r.value}):r}l.parseResponsePaddingMixin=e}),98);
__d("WASmaxInPreKeysFetchKeyBundlesUserErrorFallbackMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"user");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(n.value,"text");if(!r.success)return r;var a=o("WASmaxParseUtils").attrIntRange(n.value,"code",500,599);return a.success?o("WAResultOrError").makeResult({errorText:r.value,errorCode:a.value}):a}l.parseFetchKeyBundlesUserErrorFallbackMixin=e}),98);
__d("WASmaxInPreKeysFetchKeyBundlesUserErrorMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"user");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(n.value,"text");if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,n.value,"code",500);return a.success?o("WAResultOrError").makeResult({errorText:r.value,errorCode:a.value}):a}l.parseFetchKeyBundlesUserErrorMixin=e}),98);
__d("WASmaxInPreKeysDeviceIdentityMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"device-identity");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytes(t.value);return n.success?o("WAResultOrError").makeResult({deviceIdentityElementValue:n.value}):n}l.parseDeviceIdentityMixin=e}),98);
__d("WASmaxInPreKeysKeyDataMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").contentBytesRange(e,32,32);return t.success?o("WAResultOrError").makeResult({elementValue:t.value}):t}l.parseKeyDataMixin=e}),98);
__d("WASmaxInPreKeysIdentityKeyMixin",["WASmaxInPreKeysKeyDataMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"identity");if(!t.success)return t;var n=o("WASmaxInPreKeysKeyDataMixin").parseKeyDataMixin(t.value);return n.success,n}l.parseIdentityKeyMixin=e}),98);
__d("WASmaxInPreKeysKeyTypeMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"type");if(!t.success)return t;var n=o("WASmaxParseUtils").contentLiteralBytes(t.value,new Uint8Array([5]));return n.success?o("WAResultOrError").makeResult({typeElementValue:n.value}):n}l.parseKeyTypeMixin=e}),98);
__d("WASmaxInPreKeysKeyIDMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"id");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytesRange(e,3,3);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}l.parseKeyIDMixin=e}),98);
__d("WASmaxInPreKeysPreKeyMixin",["WAResultOrError","WASmaxInPreKeysKeyDataMixin","WASmaxInPreKeysKeyIDMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"key");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(t.value,"id");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(t.value,"value");if(!r.success)return r;var a=o("WASmaxInPreKeysKeyIDMixin").parseKeyIDMixin(n.value);if(!a.success)return a;var i=o("WASmaxInPreKeysKeyDataMixin").parseKeyDataMixin(r.value);return i.success?o("WAResultOrError").makeResult({keyIdKeyIDMixin:a.value,keyValueKeyDataMixin:i.value}):i}l.parsePreKeyMixin=e}),98);
__d("WASmaxInPreKeysRegistrationIDMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"registration");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytesRange(t.value,4,4);return n.success?o("WAResultOrError").makeResult({registrationElementValue:n.value}):n}l.parseRegistrationIDMixin=e}),98);
__d("WASmaxInPreKeysSignedPreKeyMixin",["WAResultOrError","WASmaxInPreKeysKeyDataMixin","WASmaxInPreKeysKeyIDMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"skey");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(t.value,"id");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(t.value,"value");if(!r.success)return r;var a=o("WASmaxParseUtils").flattenedChildWithTag(t.value,"signature");if(!a.success)return a;var i=o("WASmaxParseUtils").contentBytesRange(a.value,64,64);if(!i.success)return i;var l=o("WASmaxInPreKeysKeyIDMixin").parseKeyIDMixin(n.value);if(!l.success)return l;var s=o("WASmaxInPreKeysKeyDataMixin").parseKeyDataMixin(r.value);return s.success?o("WAResultOrError").makeResult({skeySignatureElementValue:i.value,skeyIdKeyIDMixin:l.value,skeyValueKeyDataMixin:s.value}):s}l.parseSignedPreKeyMixin=e}),98);
__d("WASmaxInPreKeysFetchKeyBundlesUserSuccessMixin",["WAResultOrError","WASmaxInPreKeysDeviceIdentityMixin","WASmaxInPreKeysIdentityKeyMixin","WASmaxInPreKeysKeyTypeMixin","WASmaxInPreKeysPreKeyMixin","WASmaxInPreKeysRegistrationIDMixin","WASmaxInPreKeysSignedPreKeyMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"user");if(!t.success)return t;var n=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,e,"t",0,void 0);if(!n.success)return n;var r=o("WASmaxParseUtils").optionalLiteral(o("WASmaxParseUtils").attrString,e,"is_cloud_api","true");if(!r.success)return r;var a=o("WASmaxInPreKeysRegistrationIDMixin").parseRegistrationIDMixin(e);if(!a.success)return a;var i=o("WASmaxInPreKeysKeyTypeMixin").parseKeyTypeMixin(e),l=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(e);if(!l.success)return l;var s=o("WASmaxInPreKeysPreKeyMixin").parsePreKeyMixin(e),u=o("WASmaxInPreKeysSignedPreKeyMixin").parseSignedPreKeyMixin(e);if(!u.success)return u;var c=o("WASmaxInPreKeysDeviceIdentityMixin").parseDeviceIdentityMixin(e);return o("WAResultOrError").makeResult(babelHelpers.extends({t:n.value,isCloudApi:r.value},a.value,{keyTypeMixin:i.success?i.value:null},l.value,{preKeyMixin:s.success?s.value:null},u.value,{deviceIdentityMixin:c.success?c.value:null}))}l.parseFetchKeyBundlesUserSuccessMixin=e}),98);
__d("WASmaxInPreKeysUserFetchKeyBundlesSuccessOrFetchKeyBundlesErrorOrFetchKeyBundlesErrorFallbackMixinGroup",["WAResultOrError","WASmaxInPreKeysFetchKeyBundlesUserErrorFallbackMixin","WASmaxInPreKeysFetchKeyBundlesUserErrorMixin","WASmaxInPreKeysFetchKeyBundlesUserSuccessMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysFetchKeyBundlesUserSuccessMixin").parseFetchKeyBundlesUserSuccessMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"FetchKeyBundlesUserSuccess",value:t.value});var n=o("WASmaxInPreKeysFetchKeyBundlesUserErrorMixin").parseFetchKeyBundlesUserErrorMixin(e);if(n.success)return o("WAResultOrError").makeResult({name:"FetchKeyBundlesUserError",value:n.value});var r=o("WASmaxInPreKeysFetchKeyBundlesUserErrorFallbackMixin").parseFetchKeyBundlesUserErrorFallbackMixin(e);return r.success?o("WAResultOrError").makeResult({name:"FetchKeyBundlesUserErrorFallback",value:r.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["UserSuccess","UserError","UserErrorFallback"],[t,n,r])}l.parseUserFetchKeyBundlesSuccessOrFetchKeyBundlesErrorOrFetchKeyBundlesErrorFallbackMixinGroup=e}),98);
__d("WASmaxInPreKeysFetchKeyBundlesResponseSuccess",["WAResultOrError","WASmaxInPreKeysEnums","WASmaxInPreKeysIQResultResponseMixin","WASmaxInPreKeysResponsePaddingMixin","WASmaxInPreKeysUserFetchKeyBundlesSuccessOrFetchKeyBundlesErrorOrFetchKeyBundlesErrorFallbackMixinGroup","WASmaxParseJid","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"user");if(!t.success)return t;var n=o("WASmaxParseJid").attrJidEnum(e,"jid",o("WASmaxInPreKeysEnums").DEVICEJID_DEVICEJID);if(!n.success)return n;var r=o("WASmaxInPreKeysUserFetchKeyBundlesSuccessOrFetchKeyBundlesErrorOrFetchKeyBundlesErrorFallbackMixinGroup").parseUserFetchKeyBundlesSuccessOrFetchKeyBundlesErrorOrFetchKeyBundlesErrorFallbackMixinGroup(e);return r.success?o("WAResultOrError").makeResult({jid:n.value,userFetchKeyBundlesSuccessOrFetchKeyBundlesErrorOrFetchKeyBundlesErrorFallbackMixinGroup:r.value}):r}function s(t,n){var r=o("WASmaxParseUtils").assertTag(t,"iq");if(!r.success)return r;var a=o("WASmaxParseUtils").flattenedChildWithTag(t,"list");if(!a.success)return a;var i=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(t,n);if(!i.success)return i;var l=o("WASmaxInPreKeysResponsePaddingMixin").parseResponsePaddingMixin(t),s=o("WASmaxParseUtils").mapChildrenWithTag(a.value,"user",0,1e5,e);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({},i.value,{responsePaddingMixin:l.success?l.value:null,listUser:s.value})):s}l.parseFetchKeyBundlesResponseSuccessListUser=e,l.parseFetchKeyBundlesResponseSuccess=s}),98);
__d("WASmaxAttrs",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return t==null?o("WAWap").DROP_ATTR:e(t)}function s(e,t){return t?e:o("WAWap").DROP_ATTR}l.OPTIONAL=e,l.OPTIONAL_LITERAL=s}),98);
__d("WASmaxChildren",["WADeepEquals"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return t==null?null:e(t)}function s(e,t){if(t==null)return null;if(t)return e()}function u(e,t){if(t){for(var n=1;n<t.length;n++)if(!o("WADeepEquals").deepEqual(t[n],t[0]))throw new Error("expected all homogeneous children to be equal, but they were not")}var r=d(e,t,0,1/0);return r}function c(e,t){return m(e,t,0,1/0)}function d(e,t,n,r){if(t==null){if(n>0)throw new Error("expected at least "+n+" children, but none provided");return[]}var o=t.length;if(o<n)throw new Error("expected at least "+n+" children, but found "+o);if(o>r)throw new Error("expected at most "+r+" children, but found "+o);return t.map(function(t){return e(t)})}function m(e,t,n,r){if(t===0){if(n>0)throw new Error("expected at least "+n+" children, but none provided");return[]}if(t<n)throw new Error("expected at least "+n+" children, but found "+t);if(t>r)throw new Error("expected at most "+r+" children, but found "+t);for(var o=[],a=0;a<t;a++)o.push(e());return o}l.OPTIONAL_CHILD=e,l.HAS_OPTIONAL_CHILD=s,l.HOMOGENEOUS_CHILD=u,l.HOMOGENEOUS_CHILD_COUNT=c,l.REPEATED_CHILD=d,l.REPEATED_CHILD_COUNT=m}),98);
__d("WASmaxOutPreKeysClientRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("iq",{id:o("WAWap").generateId(),xmlns:"encrypt",to:o("WAWap").S_WHATSAPP_NET});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeClientRequestMixin=s}),98);
__d("WASmaxOutPreKeysFetchKeyBundlesRequest",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxOutPreKeysClientRequestMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.userJid,n=e.hasUserReasonIdentity,r=o("WASmaxJsx").smax("user",{jid:o("WAWap").JID(t),reason:o("WASmaxAttrs").OPTIONAL_LITERAL("identity",n)});return r}function s(t){var n=t.userArgs,r=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"get"},o("WASmaxJsx").smax("key",null,o("WASmaxChildren").REPEATED_CHILD(e,n,1,1e5))));return r}l.makeFetchKeyBundlesRequestKeyUser=e,l.makeFetchKeyBundlesRequest=s}),98);
__d("WASmaxParsingFailure",[],(function(t,n,r,o,a,i){"use strict";var e=(function(e){function t(t){var n;return n=e.call(this,"SmaxParsingFailure: "+t)||this,n.name="SmaxParsingFailure",n.reason=t,n}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"SmaxParsingFailure: "+this.reason},t})(babelHelpers.wrapNativeSuper(Error));i.SmaxParsingFailure=e}),66);
__d("WASmaxRpcUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=Object.keys(t).map(function(e){var n=e==="Request"?"<request>":'<response name="'+e+'">';return"Tried "+n+", but failed with "+t[e].error+"."}).join(" ");return'Failed to parse incoming stanza of <rpc name="'+e+'">. '+n}i.errorMessageRpcParsing=e}),66);
__d("WASmaxPreKeysFetchKeyBundlesRPC",["WAComms","WASmaxInPreKeysFetchKeyBundlesResponseRequestError","WASmaxInPreKeysFetchKeyBundlesResponseServerError","WASmaxInPreKeysFetchKeyBundlesResponseSuccess","WASmaxOutPreKeysFetchKeyBundlesRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(t,n,r,o,a,i,l){async function e(e,t){var n=o("WASmaxOutPreKeysFetchKeyBundlesRequest").makeFetchKeyBundlesRequest(e),r=await o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInPreKeysFetchKeyBundlesResponseSuccess").parseFetchKeyBundlesResponseSuccess(r,n);if(a.success)return{name:"FetchKeyBundlesResponseSuccess",value:a.value};var i=o("WASmaxInPreKeysFetchKeyBundlesResponseRequestError").parseFetchKeyBundlesResponseRequestError(r,n);if(i.success)return{name:"FetchKeyBundlesResponseRequestError",value:i.value};var l=o("WASmaxInPreKeysFetchKeyBundlesResponseServerError").parseFetchKeyBundlesResponseServerError(r,n);if(l.success)return{name:"FetchKeyBundlesResponseServerError",value:l.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("FetchKeyBundles",{Success:a,RequestError:i,ServerError:l}))}l.sendFetchKeyBundlesRPC=e}),98);
__d("WAFetchPreKeyBundlesProtocol",["WAConvertRegistrationIdMixin","WAConvertSignedPreKeyMixin","WAParsableXmlNode","WAResultOrError","WASignalKeys","WASmaxPreKeysFetchKeyBundlesRPC","WATagsLogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS(["fetchPreKeyBundlesProtocol"]);async function m(t){d.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start fetching prekey of ","..."])),t.join(", "));var n=await o("WASmaxPreKeysFetchKeyBundlesRPC").sendFetchKeyBundlesRPC({userArgs:t.map(function(e){return{userJid:e,hasUserReasonIdentity:!1}})});switch(n.name){case"FetchKeyBundlesResponseSuccess":{d.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["fetched prekey successfully"])));var r=new Map;return n.value.listUser.map(function(e){var t=e.userFetchKeyBundlesSuccessOrFetchKeyBundlesErrorOrFetchKeyBundlesErrorFallbackMixinGroup;t.name==="FetchKeyBundlesUserSuccess"&&r.set(e.jid,p(t.value))}),o("WAResultOrError").makeResult(r)}case"FetchKeyBundlesResponseServerError":{var a=n.value.errorServerErrors.name;return d.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ServerError: ",""])),a),o("WAResultOrError").makeError({type:"server-error",payload:a})}case"FetchKeyBundlesResponseRequestError":{var i=n.value.errorRequestErrorsFetch.name;return d.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["RequestError: ",""])),i),o("WAResultOrError").makeError({type:"request-error",payload:i})}}}function p(e){var t=o("WAConvertRegistrationIdMixin").registrationIdMixin(e),n=o("WASignalKeys").serializeIdentity(e.elementValue),r=o("WAConvertSignedPreKeyMixin").convertSignedPreKeyMixin(e),a=e.preKeyMixin?_(e.preKeyMixin):null,i=o("WATimeUtils").castToUnixTime(e.t||0);return{keys:{regId:t,identity:n,oneTimeKey:a,signedKey:{id:r.id,signature:r.signature,publicKey:o("WASignalKeys").serializeIdentity(r.pubkey)}},timestamp:i}}function _(e){return{id:o("WAParsableXmlNode").convertBytesToUint(e.keyIdKeyIDMixin.elementValue,3),publicKey:o("WASignalKeys").serializeIdentity(e.keyValueKeyDataMixin.elementValue)}}l.fetchPreKeyBundlesProtocol=m}),98);
__d("WABulkRequestKeys",["WAFetchPreKeyBundlesProtocol","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=await o("WAFetchPreKeyBundlesProtocol").fetchPreKeyBundlesProtocol(e);return t.success?o("WAResultOrError").makeResult(t.value):o("WAResultOrError").makeError("errRequestKeysParsingFailed")}l.bulkRequestKeys=e}),98);
__d("WALock",["Promise","WAResolvable","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return{lock:function(a,i){var r=new(o("WAResolvable")).Resolvable,l=a.map(function(e){return[e,new(o("WAResolvable")).Resolvable]});return(s||(s=n("Promise"))).all(l.map(function(e){var n=e[0],o=e[1];return t.enqueue(n,function(){return o.resolve(),r.promise})})).catch(function(){o("WATagsLogger").TAGS(["WALock"]).ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Lock failed for ",""])),a)}),s.all(l.map(function(e){var t=e[0],n=e[1];return n.promise})).then(function(){return i()}).finally(function(){r.resolve()})},wait:function(n){return t.wait(n)}}}l.makeLock=u}),98);
__d("WALockMap",["WALock","WAPromiseQueue"],(function(t,n,r,o,a,i,l){"use strict";function e(e){e===void 0&&(e=-1);var t=new(o("WAPromiseQueue")).PromiseQueueMap(e);return o("WALock").makeLock(t)}l.makeLockMap=e}),98);
__d("WACryptoCurveConstants",[],(function(t,n,r,o,a,i){"use strict";var e=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),l=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),s=BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),u=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),c=BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989");i.P=e,i.I=l,i.D=s,i.A=u,i.L=c}),66);
__d("WACryptoCurveEncoding",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){for(var t=BigInt(0),n=0;n<e.length;n++)t|=BigInt(e[n])<<BigInt(8)*BigInt(n);return t}function s(e){for(var t=new Uint8Array(32),n=e,r=0;r<32;r++)t[r]=Number(n&BigInt(255)),n>>=BigInt(8);return t}function u(e){if(e.length%2)throw r("err")("hexToU8: odd string length");for(var t=new Uint8Array(e.length/2),n=0;n<t.length;n++)t[n]=parseInt(e.slice(2*n,2*n+2),16);return t}l.bytesToBigIntLE=e,l.bigIntTo32LE=s,l.hexToU8=u}),98);
__d("WACryptoCurveTransformations",["WACryptoCurveConstants","WACryptoCurveEncoding","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return(e%o("WACryptoCurveConstants").P+o("WACryptoCurveConstants").P)%o("WACryptoCurveConstants").P}function s(e){return u(e,o("WACryptoCurveConstants").P-BigInt(2))}function u(t,n){for(var r=e(t),o=n,a=BigInt(1);o>BigInt(0);)o&BigInt(1)&&(a=e(a*r)),r=e(r*r),o>>=BigInt(1);return a}function c(t,n){var a=e(t*s(n)),i=u(a,o("WACryptoCurveConstants").P+BigInt(3)>>BigInt(3)),l=e(i*i);if(l!==a&&(i=e(i*o("WACryptoCurveConstants").I),l=e(i*i),l!==a))throw r("err")("Montgomery u is on the twist (no sqrt for v)");return i}function d(t){var n=e(o("WACryptoCurveEncoding").bytesToBigIntLE(t));if(n===o("WACryptoCurveConstants").P-BigInt(1))throw r("err")("u == -1 (mod p): cannot convert");var a=e(e(n-BigInt(1))*s(e(n+BigInt(1))));return o("WACryptoCurveEncoding").bigIntTo32LE(a)}function m(t,n){return{X:t,Y:n,Z:BigInt(1),T:e(t*n)}}function p(t){var n=e(t.x),o=e(t.y),a=e(BigInt(1)-o);if(a===BigInt(0))throw r("err")("y == 1: map undefined");var i=e((BigInt(1)+o)*s(a)),l=n===BigInt(0)?void 0:e(i*s(n));return{u:i,v:l}}function _(e){var t=e.x,n=e.y,r=o("WACryptoCurveEncoding").bigIntTo32LE(n),a=(t&BigInt(1))===BigInt(1)?128:0;return r[31]|=a,r}function f(t){if(!(t instanceof Uint8Array)||t.length!==32)throw r("err")("Compressed Ed25519 key is not 32 bytes");var n=t[31],a=(n&128)!==0,i=t.slice();i[31]&=127;var l=e(o("WACryptoCurveEncoding").bytesToBigIntLE(i)),s=e(l*l),u=e(s-BigInt(1)),d=e(o("WACryptoCurveConstants").D*s+BigInt(1)),m=c(u,d);if((m&BigInt(1))!==(a?BigInt(1):BigInt(0))&&(m=e(-m)),m===BigInt(0)&&a)throw r("err")("Error during decompression of Ed25519: x coord is 0 but sign bit set");return{x:m,y:l}}l.mod=e,l.toEdwardsCompressed=d,l.affineToExtended=m,l.fromAffineToMontgomeryUV=p,l.compressEd25519=_,l.decompressEd25519=f}),98);
__d("WACryptoCurveEd25519PointOps",["WACryptoCurveConstants","WACryptoCurveTransformations","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n,r=e.T,a=e.X,i=e.Y,l=e.Z,s=t.T,u=t.X,c=t.Y,d=t.Z,m=(n=o("WACryptoCurveTransformations")).mod(a*u),p=n.mod(i*c),_=n.mod(r*o("WACryptoCurveConstants").D*s),f=n.mod(l*d),g=n.mod((a+i)*(u+c)-m-p),h=n.mod(f-_),y=n.mod(f+_),C=n.mod(p-o("WACryptoCurveConstants").A*m),b=n.mod(g*h),v=n.mod(y*C),S=n.mod(h*y),R=n.mod(g*C);return{X:b,Y:v,Z:S,T:R}}function s(e){var t,n=e.X,r=e.Y,a=e.Z,i=(t=o("WACryptoCurveTransformations")).mod(n*n),l=t.mod(r*r),s=t.mod(BigInt(2)*t.mod(a*a)),u=t.mod(o("WACryptoCurveConstants").A*i),c=n+r,d=t.mod(t.mod(c*c)-i-l),m=t.mod(u+l),p=t.mod(m-s),_=t.mod(u-l);return{X:t.mod(d*p),Y:t.mod(m*_),Z:t.mod(p*m),T:t.mod(d*_)}}function u(e,t){var n,r=e.X,a=e.Y,i=e.Z,l=t.X,s=t.Y,u=t.Z,c=(n=o("WACryptoCurveTransformations")).mod(r*u),d=n.mod(l*i),m=n.mod(a*u),p=n.mod(s*i);return c===d&&m===p}function c(t,n){for(var r={X:BigInt(0),Y:BigInt(1),Z:BigInt(1),T:BigInt(0)},o=t,a=n;a>BigInt(0);)a&BigInt(1)&&(r=e(r,o)),o=s(o),a>>=BigInt(1);return r}function d(e){var t,n=e.T,a=e.X,i=e.Y,l=e.Z,s=(t=o("WACryptoCurveTransformations")).mod(a*a),u=t.mod(i*i),c=t.mod(l*l),d=t.mod(c*c),m=t.mod(s*o("WACryptoCurveConstants").A),p=t.mod(c*t.mod(m+u)),_=t.mod(d+t.mod(o("WACryptoCurveConstants").D*t.mod(s*u)));if(p!==_)throw r("err")("bad point: equation left != right (1)");var f=o("WACryptoCurveTransformations").mod(a*i),g=o("WACryptoCurveTransformations").mod(l*n);if(f!==g)throw r("err")("bad point: equation left != right (2)");return!0}l.addPoints=e,l.doublePoint=s,l.equalPoints=u,l.scalarMult=c,l.isPointValid=d}),98);
__d("WACryptoCurveKeyCanonicalCheck",["WACryptoCurveConstants","WACryptoCurveEd25519PointOps","WACryptoCurveEncoding","WACryptoCurveTransformations"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WACryptoCurveEd25519PointOps").equalPoints(e,{X:BigInt(0),Y:BigInt(1),Z:BigInt(1),T:BigInt(0)})}function s(e){var t=o("WACryptoCurveEncoding").bytesToBigIntLE(e);return t<o("WACryptoCurveConstants").P}function u(t){try{var n=o("WACryptoCurveTransformations").toEdwardsCompressed(t),r=o("WACryptoCurveTransformations").decompressEd25519(n),a=r.x,i=r.y,l=o("WACryptoCurveTransformations").affineToExtended(a,i),s=o("WACryptoCurveEd25519PointOps").scalarMult(l,o("WACryptoCurveConstants").L);return e(s)}catch(e){return!1}}function c(e){return u(e)&&s(e)}l.isIdentity=e,l.isInRange=s,l.isTorsionFree=u,l.isCanonical=c}),98);
__d("WACryptoLibraryConfig",[],(function(t,n,r,o,a,i){"use strict";var e={signalFutureMessagesMax:2e3,S508658AutoAcknowledgeStaleSessions:!1,baseKeyCanonicalCheck:!1};function l(){return e}function s(t){e=t}i.getCryptoLibraryConfig=l,i.setCryptoLibraryConfig=s}),66);
__d("WASignalSessions",["WABinary","WACryptoLibraryConfig","WASignalKeys","WASignalOther","err"],(function(t,n,r,o,a,i,l){"use strict";var e=3;function s(e){return!o("WACryptoLibraryConfig").getCryptoLibraryConfig().S508658AutoAcknowledgeStaleSessions||e.initialExchangeInfo==null?e:y(e.local,e.remote,e.rootKey,e.recvChains,e.sendChain,null,e.prevSendChainHighestIndex,e.prevSessions,e.aliceBaseKey)}function u(e,t){return c(e,0,t,[])}function c(e,t,n,r){return{ratchetPubKey:e,nextMsgIndex:t,chainKey:n,unusedMsgKeys:r}}function d(e,t){return m(e,0,t)}function m(e,t,n){return{ratchetKey:e,nextMsgIndex:t,chainKey:n}}function p(e,t,n){return{remoteOneTimeId:e,remoteSignedId:t,localOneTimePubKey:n}}function _(e,t){return y(e.local,e.remote,e.rootKey,e.recvChains,e.sendChain,e.initialExchangeInfo,e.prevSendChainHighestIndex,t,e.aliceBaseKey)}function f(e,t,n){return y(e.local,e.remote,e.rootKey,t,n,e.initialExchangeInfo,e.prevSendChainHighestIndex,e.prevSessions,e.aliceBaseKey)}function g(e,t,n,r){return n===void 0&&(n=e.sendChain),y(e.local,e.remote,r,t,n,null,Math.max(e.sendChain.nextMsgIndex-1,0),e.prevSessions,e.aliceBaseKey)}function h(e,t,n,r,o,a,i){return y(e,t,n,r,o,a,0,[],i)}function y(e,t,n,r,o,a,i,l,s){return{local:e,remote:t,rootKey:n,sendChain:o,recvChains:r,initialExchangeInfo:a,prevSendChainHighestIndex:i,prevSessions:l,aliceBaseKey:s}}function C(e,t){var n=new(o("WABinary")).Binary(t),r=o("WASignalOther").readBytes(n,32),a=o("WASignalOther").readBytes(n,32),i=o("WASignalOther").readBytes(n,16);return b(e,r,a,i)}function b(e,t,n,r){return{index:e,cipherKey:t,macKey:n,iv:r}}function v(e){return{senderRatchetKey:e.ratchetPubKey,chainKey:{index:e.nextMsgIndex,key:e.chainKey},messageKeys:e.unusedMsgKeys}}function S(e){var t=e.ratchetKey;return{senderRatchetKey:t.serializedPubKey,senderRatchetKeyPrivate:t.privateKey,chainKey:{index:e.nextMsgIndex,key:e.chainKey}}}function R(t){var n=t.initialExchangeInfo,r=t.local,o=t.remote,a=void 0;if(n){var i=n.remoteOneTimeId;a={preKeyId:i!=null?i:void 0,signedPreKeyId:n.remoteSignedId,baseKey:n.localOneTimePubKey}}return{currentSession:{sessionVersion:e,localIdentityPublic:r.pubKey,remoteIdentityPublic:o.pubKey,rootKey:t.rootKey,previousCounter:t.prevSendChainHighestIndex,senderChain:S(t.sendChain),receiverChains:t.recvChains.map(v),pendingPreKey:a,remoteRegistrationId:o.regId,localRegistrationId:r.regId,aliceBaseKey:t.aliceBaseKey},previousSessions:t.prevSessions}}function L(t){var n=t.initialExchangeInfo,r=t.local,a=t.remote,i=t.sendChain,l=void 0;if(n){var s=n.remoteOneTimeId;l={preKeyId:s!=null?s:void 0,signedPreKeyId:n.remoteSignedId,baseKey:o("WASignalOther").toBuffer(n.localOneTimePubKey)}}return{sessionVersion:e,localIdentityPublic:o("WASignalOther").toBuffer(r.pubKey),remoteIdentityPublic:o("WASignalOther").toBuffer(a.pubKey),rootKey:o("WASignalOther").toBuffer(t.rootKey),previousCounter:t.prevSendChainHighestIndex,senderChain:{senderRatchetKey:o("WASignalOther").toBuffer(i.ratchetKey.serializedPubKey),senderRatchetKeyPrivate:o("WASignalOther").toBuffer(i.ratchetKey.privateKey),chainKey:{index:i.nextMsgIndex,key:o("WASignalOther").toBuffer(i.chainKey)},messageKeys:[]},receiverChains:t.recvChains.map(function(e){return{senderRatchetKey:o("WASignalOther").toBuffer(e.ratchetPubKey),chainKey:{index:e.nextMsgIndex,key:o("WASignalOther").toBuffer(e.chainKey)},messageKeys:e.unusedMsgKeys.map(function(e){return{index:e.index,cipherKey:o("WASignalOther").toBuffer(e.cipherKey),macKey:o("WASignalOther").toBuffer(e.macKey),iv:o("WASignalOther").toBuffer(e.iv)}})}}),pendingPreKey:l,remoteRegistrationId:a.regId,localRegistrationId:r.regId,aliceBaseKey:t.aliceBaseKey==null?void 0:o("WASignalOther").toBuffer(t.aliceBaseKey)}}function E(e){var t=$(e.currentSession,"currentSession");return I(t,e.previousSessions)}function k(e){return I(e,[])}function I(t,n){var a=$(t.sessionVersion,"sessionVersion");if(a!==e)throw r("err")("Signal: bad session version "+a);var i=$(t.senderChain,"senderChain"),l=$(i.chainKey,"senderChain.chainKey"),s=m(o("WASignalKeys").makeSerializedKeyPairFrom(x(i.senderRatchetKeyPrivate,32,"senderRatchetKeyPrivate"),D(i.senderRatchetKey,"senderRatchetKey")),$(l.index,"senderChain.chainKey.index"),x(l.key,32,"senderChain.chainKey.key")),u=$(t.receiverChains,"receiverChains").map(function(e){var t=$(e.chainKey,"receiverChains[].chainKey");return c(D(e.senderRatchetKey,"receiverChains[].senderRatchetKey"),$(t.index,"receiverChains[].chainKey.index"),x(t.key,32,"receiverChains[].chainKey.key"),T(e.messageKeys))}),d={regId:o("WASignalOther").castRegistrationId($(t.localRegistrationId,"localRegistrationId")),pubKey:D(t.localIdentityPublic,"localIdentityPublic")},_={regId:o("WASignalOther").castRegistrationId($(t.remoteRegistrationId,"remoteRegistrationId")),pubKey:D(t.remoteIdentityPublic,"remoteIdentityPublic")},f=t.pendingPreKey,g=null;if(f){var h=f.preKeyId;g=p(h!=null?o("WASignalKeys").castToPreKeyId(h):null,o("WASignalKeys").castToSignedPreKeyId($(f.signedPreKeyId,"pendingPreKey.signedPreKeyId")),D(f.baseKey,"pendingPreKey.baseKey"))}var C=t.aliceBaseKey==null?null:D(t.aliceBaseKey,"aliceBaseKey");return y(d,_,x(t.rootKey,32,"rootKey"),u,s,g,t.previousCounter||0,n,C)}function T(e){return e.map(function(e){return{index:$(e.index,"messageKeys[].index"),cipherKey:x(e.cipherKey,32,"messageKeys[].cipherKey"),macKey:x(e.macKey,32,"messageKeys[].macKey"),iv:x(e.iv,16,"messageKeys[].iv")}})}function D(e,t){return o("WASignalKeys").castToSerializedPubKey(new Uint8Array($(e,t)))}function x(e,t,n){return o("WASignalOther").toBytes($(e,n),t)}function $(e,t){if(e==null)throw r("err")("Signal: protobuf is missing "+t);return e}l.FORMAT_VERSION=e,l.maybeClearPendingPreKey=s,l.makeFreshRecvChain=u,l.makeRecvChain=c,l.makeFreshSendChain=d,l.makeSendChain=m,l.makeInitialExchangeInfo=p,l.setPrevSessions=_,l.updateChains=f,l.ratchetSession=g,l.makeFreshSession=h,l.makeSession=y,l.splitMsgKey=C,l.serializeSession=R,l.detachSession=L,l.parseSessionFromRecord=E,l.parseSession=k,l._parseSession=I,l.bytesOrThrow=x,l.definedOrThrow=$}),98);
__d("WACryptoEd25519",["WACryptoPrimitives","err"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){var n=e;e=[];try{return t()}finally{(e!=null?e:[]).forEach(function(e){return void e.fill(0)}),e=n}}function u(t,n){if(e==null)throw r("err")("allocate called outside of active scope");return new t(n)}function c(e,t,n){o("WACryptoPrimitives").lowlevel.crypto_hash(e,t,n)}function d(e,t){for(var n=0;n<64;++n)t[n]=e[n],e[n]=0;_(e,t),t.fill(0)}function m(e,t){var n=[p(),p(),p(),p()];o("WACryptoPrimitives").lowlevel.scalarbase(n,t),j(e,n)}function p(e){var t=u(Float64Array,16);if(e){if(e.length>16)throw r("err")("Incorrect initialiser array provided to the fieldElement");for(var n=0;n<e.length;n++)t[n]=e[n]}return t}function _(e,t){o("WACryptoPrimitives").lowlevel.modL(e,t)}var f=function(){return p([0])},g=function(){return p([1])},h=function(){return p([2])},y=function(){return p([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139])};function C(){return[p(),p(),p(),p()]}function b(){return[p(),p(),p(),p()]}function v(){return[p(),p(),p()]}function S(e,t){for(var n=0,r=t;r>0;){var o=r%65536;e[n]=o,r=(r-o)/65536,n++}}function R(e,t){return Q(e,t)?0:1}function L(e){var t=o("WACryptoPrimitives").lowlevel.pack25519,n=u(Uint8Array,32);return t(n,e),n[0]&1}function E(e,t){var n=o("WACryptoPrimitives").lowlevel.M,r=o("WACryptoPrimitives").lowlevel.S,a=h(),i=p();r(i,t),n(e,a,i)}function k(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.S,i=f(),l=g(),s=p(),u=p(),c=p(),d=p();S(i,486662),a(s,t),r(u,i,t),n(c,s,u),n(d,c,l),r(e,t,d)}function I(e,t,n){n===1&&e.set(t)}var T=new Uint8Array([176,160,14,74,39,27,238,196,120,228,47,173,6,24,67,47,167,215,251,61,153,0,77,43,11,223,193,79,128,36,131,43]);function D(e,t){var n,r=(n=o("WACryptoPrimitives")).lowlevel.M,a=n.lowlevel.S,i=n.lowlevel.pow2523,l=n.lowlevel.unpack25519,s=p();l(s,T);var u=p();i(u,t);var c=p();r(c,t,u);var d=p();a(d,c);var m=p();r(m,c,s),I(c,m,1^R(d,t)),e.set(c)}function x(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.Z,i=g(),l=p(),s=p(),u=p();a(l,t,i),n(s,t,i),K(u,s),r(e,l,u)}function $(e,t){var n=o("WACryptoPrimitives").lowlevel.Z,r=f();n(e,r,t)}function P(e,t){var n=o("WACryptoPrimitives").lowlevel.M;n(e[0],t[0],t[3]),n(e[1],t[1],t[2]),n(e[2],t[2],t[3])}function N(e,t){var n=o("WACryptoPrimitives").lowlevel.M;n(e[0],t[0],t[3]),n(e[1],t[1],t[2]),n(e[2],t[2],t[3]),n(e[3],t[0],t[1])}function M(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.S,a=o("WACryptoPrimitives").lowlevel.Z;r(e[0],t[0]),r(e[2],t[1]),E(e[3],t[2]),n(e[1],t[0],t[1]);var i=p();r(i,e[1]),n(e[1],e[2],e[0]),a(e[2],e[2],e[0]),a(e[0],i,e[1]),a(e[3],e[3],e[2])}var w=new Uint8Array([6,126,69,255,170,4,110,204,130,26,125,75,209,211,161,197,126,79,252,3,220,8,123,210,187,6,160,96,244,237,38,15]);function A(e,t,n){var r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.unpack25519,i=p();a(i,w);var l=p();x(l,t);var s=p();k(s,t);var u=p();D(u,s);var c=p();r(c,t,i);var d=p();K(d,u);var m=p();r(m,c,d);var _=p();$(_,m),I(m,_,L(m)^n),e[0].set(m),e[1].set(l),e[2].set(g()),r(e[3],e[0],e[1])}function F(e,t){e[0].set(t[0]),e[1].set(t[1]),e[2].set(t[2])}function O(e,t){var n=v();F(n,t),M(e,n)}function B(e,t){var n=b(),r=v();O(n,t),P(r,n),M(n,r),P(r,n),M(n,r),N(e,n)}function W(e){var t,n=(t=o("WACryptoPrimitives")).lowlevel.M,r=t.lowlevel.S,a=t.lowlevel.pack25519,i=t.lowlevel.pow2523,l=p(),s=p(),u=p(),c=p(),d=p();i(l,e),r(s,l),r(u,s),n(c,u,e),n(d,c,e);var m=new Uint8Array(32);return a(m,d),1&m[31]}function q(e,t){$(e[0],t[0]),e[1].set(t[1]),e[2].set(t[2]),$(e[3],t[3])}function U(e,t){var n=C(),r=X(n,t);return r!==0?-1:(q(e,n),0)}function V(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.M,a=t,i=g(),l=f();S(l,486662);var s=p();E(s,a);var u=p();n(u,s,i);var c=p();K(c,u);var d=p();r(d,c,l);var m=p();$(m,d);var _=p();k(_,m);var h=W(_),y=p([0]);I(y,l,h);var C=p();n(C,m,y);var b=p();$(b,C),I(C,b,h),e.set(C)}function H(e){var t=o("WACryptoPrimitives").lowlevel.unpack25519,n=o("WACryptoPrimitives").hash(e),r=(n[31]&128)>>7;n[31]&=127;var a=p();t(a,n);var i=p();G(i,a);var l=C();A(l,i,r);var s=C();return B(s,l),s}function G(e,t){return s(function(){return V(e,t)})}function z(e){return s(function(){return H(e)})}function j(e,t){var n=p(),r=p(),a=p(),i=o("WACryptoPrimitives").lowlevel.M,l=o("WACryptoPrimitives").lowlevel.pack25519;K(a,t[2]),i(n,t[0],a),i(r,t[1],a),l(e,r);var s=new Uint8Array(32);l(s,n),e[31]^=(s[0]&1)<<7}function K(e,t){var n=p();n.set(t);for(var r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.S,i=253;i>=0;--i)a(n,n),i!==2&&i!==4&&r(n,n,t);e.set(n)}function Q(e,t){var n=o("WACryptoPrimitives").lowlevel.crypto_verify_32,r=o("WACryptoPrimitives").lowlevel.pack25519,a=new Uint8Array(32),i=new Uint8Array(32);return r(a,e),r(i,t),n(a,0,i,0)}function X(e,t){var n,r=(n=o("WACryptoPrimitives")).lowlevel.A,a=n.lowlevel.D,i=n.lowlevel.M,l=n.lowlevel.S,s=n.lowlevel.Z,u=n.lowlevel.pow2523,c=n.lowlevel.set25519,d=n.lowlevel.unpack25519,m=p(),_=p(),h=p(),C=p(),b=p(),v=p(),S=p();return c(e[2],g()),d(e[1],t),l(h,e[1]),i(C,h,a),s(h,h,e[2]),r(C,e[2],C),l(b,C),l(v,b),i(S,v,b),i(m,S,h),i(m,m,C),u(m,m),i(m,m,h),i(m,m,C),i(m,m,C),i(e[0],m,C),l(_,e[0]),i(_,_,C),Q(_,h)&&i(e[0],e[0],y()),l(_,e[0]),i(_,_,C),Q(_,h)?-1:(Y(e[0])===t[31]>>7&&s(e[0],f(),e[0]),i(e[3],e[0],e[1]),0)}function Y(e){var t=o("WACryptoPrimitives").lowlevel.pack25519,n=new Uint8Array(32);return t(n,e),n[0]&1}l.runInAllocationScope=s,l.allocate=u,l.hashSha512=c,l.reduce=d,l.scalarmultBase=m,l.fieldElement=p,l.modL=_,l.p3Element=C,l.unpack=U,l.elligator=G,l.hashToPoint=z,l.pack=j,l.inv25519=K,l.unpackneg=X}),98);
__d("WASignalSignatures",["Promise","WACryptoDependencies","WACryptoEd25519","WACryptoPrimitives","WAHex","WALongInt","WASignalKeys","WASignalLocalStorageProtocol.pb","WASignalOther","decodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("WACryptoEd25519").runInAllocationScope(function(){var r,a=t.length,i=e.privateKey,l=new Uint8Array(32);(r=o("WACryptoEd25519")).scalarmultBase(l,i);var s=l[31]&128,u=new Uint8Array(a+128);u[0]=254,u.fill(255,1,32),u.set(i,32),u.set(t,64),u.set(n,a+64);var c=r.allocate(Uint8Array,64);r.hashSha512(c,u,a+128),u.set(l,32);var d=r.allocate(Float64Array,64);r.reduce(c,d),r.scalarmultBase(u,c);var m=r.allocate(Uint8Array,64);r.hashSha512(m,u,a+64),r.reduce(m,d);var p,_;for(p=0;p<32;++p)d[p]=c[p];for(p=0;p<32;++p)for(_=0;_<32;++_)d[p+_]+=m[p]*i[_];return r.modL(u.subarray(32,64),d),{pubKeyNegative:s!==0,signedMsg:u}})}function u(t,r){return(e||(e=n("Promise"))).resolve().then(function(){var e=o("WASignalOther").makeBytes(64);return o("WACryptoDependencies").getCrypto().getRandomValues(e),d(t,r,e)})}function c(e,t,n){var r=n[63];return r&96?!1:o("WACryptoEd25519").runInAllocationScope(function(){var a,i,l=(a=o("WACryptoPrimitives")).lowlevel.A,s=a.lowlevel.M,u=a.lowlevel.Z,c=a.lowlevel.pack25519,d=a.lowlevel.unpack25519,m=(i=o("WACryptoEd25519")).allocate(Uint8Array,64);m.set(n),m[63]=r&127;var p=i.fieldElement(),_=i.fieldElement(),f=i.fieldElement(),g=i.fieldElement(),h=i.fieldElement(),y=i.allocate(Uint8Array,32),C=i.fieldElement();return C[0]=1,d(p,e.subarray(1)),u(_,p,C),l(f,p,C),i.inv25519(g,f),s(h,_,g),c(y,h),y[31]=y[31]&127|r&128,a.signDetachedVerify(t,m,y)})}function d(e,t,n){var r=s(e,t,n),a=o("WASignalOther").sliceBytes(r.signedMsg,0,64);return a[63]=a[63]&127|(r.pubKeyNegative?128:0),a}function m(e,t,n){var a=o("WASignalKeys").makeKeyPair(),i=o("WASignalOther").makeBytes(64);o("WACryptoDependencies").getCrypto().getRandomValues(i);var l=d(n,o("WASignalKeys").serializePubKey(a),i);if(!Number.isSafeInteger(t))throw r("err")("Expected timestamp to be a safe integer, given "+String(t));return{id:o("WASignalKeys").castToPreKeyId(e),ts:t,keyPair:a,signature:l}}function p(e,t){var n=o("WASignalOther").makeBytes(64);return o("WACryptoDependencies").getCrypto().getRandomValues(n),d(e,t,n)}function _(e){var t=e.id,n=e.keyPair;return o("WASignalOther").encodeSignalProto(o("WASignalLocalStorageProtocol.pb").SignedPreKeyRecordStructureSpec,{id:t,publicKey:o("WASignalKeys").serializePubKey(n),privateKey:n.privateKey,signature:e.signature,timestamp:e.ts})}function f(e){try{var t=o("decodeProtobuf").decodeProtobuf(o("WASignalLocalStorageProtocol.pb").SignedPreKeyRecordStructureSpec,e),n=t.id,r=t.privateKey,a=t.publicKey,i=t.signature,l=t.timestamp;return n==null||a==null||r==null||i==null||l==null?null:{id:o("WASignalKeys").castToSignedPreKeyId(n),ts:o("WALongInt").numberOrThrowIfTooLarge(l),keyPair:o("WASignalKeys").makeKeyPairFromSerialized(o("WASignalOther").toBytes(r,32),o("WASignalKeys").castToSerializedPubKey(new Uint8Array(a))),signature:o("WASignalOther").toBytes(i,64)}}catch(e){return null}}function g(e){return new Uint8Array(o("WAHex").parseHex(e))}function h(e){if(e.length===33)return o("WASignalKeys").castToSerializedPubKey(e);if(e.length===32)return o("WASignalKeys").serializeIdentity(e);throw r("err")("verifyCertificate publicKey incorrect length")}function y(t,r,o){return(e||(e=n("Promise"))).resolve().then(function(){var e=m(t,r,o),n=_(e);return{plainObject:e,record:n}})}l.signMsg=u,l.verifyMsgSignalVariant=c,l.makeSignature=d,l.makeSignedPreKey=m,l.signSenderKeyMessage=p,l.serializeSignedPreKeyForPrivateStorage=_,l.deserializeSignedPreKey=f,l.convertPublicKeyHexToUint8Array=g,l.convertPublicKeyToSerializedPubKey=h,l.generateSignedPreKey=y}),98);
__d("WASignalWhisperTextProtocol.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={};s.name="SignalMessage",s.internalSpec={ratchetKey:[1,(e=o("WAProtoConst")).TYPES.BYTES],counter:[2,e.TYPES.UINT32],previousCounter:[3,e.TYPES.UINT32],ciphertext:[4,e.TYPES.BYTES]},u.name="PreKeySignalMessage",u.internalSpec={registrationId:[5,e.TYPES.UINT32],preKeyId:[1,e.TYPES.UINT32],signedPreKeyId:[6,e.TYPES.UINT32],baseKey:[2,e.TYPES.BYTES],identityKey:[3,e.TYPES.BYTES],message:[4,e.TYPES.BYTES]},c.name="KeyExchangeMessage",c.internalSpec={id:[1,e.TYPES.UINT32],baseKey:[2,e.TYPES.BYTES],ratchetKey:[3,e.TYPES.BYTES],identityKey:[4,e.TYPES.BYTES],baseKeySignature:[5,e.TYPES.BYTES]},d.name="SenderKeyMessage",d.internalSpec={id:[1,e.TYPES.UINT32],iteration:[2,e.TYPES.UINT32],ciphertext:[3,e.TYPES.BYTES]},m.name="SenderKeyDistributionMessage",m.internalSpec={id:[1,e.TYPES.UINT32],iteration:[2,e.TYPES.UINT32],chainKey:[3,e.TYPES.BYTES],signingKey:[4,e.TYPES.BYTES]},p.name="DeviceConsistencyCodeMessage",p.internalSpec={generation:[1,e.TYPES.UINT32],signature:[2,e.TYPES.BYTES]},l.SignalMessageSpec=s,l.PreKeySignalMessageSpec=u,l.KeyExchangeMessageSpec=c,l.SenderKeyMessageSpec=d,l.SenderKeyDistributionMessageSpec=m,l.DeviceConsistencyCodeMessageSpec=p}),98);
__d("WASignalGroupSession",["WASignalKeys","WASignalSessions"],(function(t,n,r,o,a,i,l){"use strict";var e=5,s=3;function u(e){var t=o("WASignalSessions").definedOrThrow(e.senderSigningKey,"senderSigningKey"),n=o("WASignalSessions").definedOrThrow(e.senderMessageKeys,"senderMessageKeys"),r=o("WASignalSessions").definedOrThrow(e.senderChainKey,"senderChainKey");return{senderSigningKeyPublic:S(t.public,"public"),senderSigningKeyPrivate:t.private?o("WASignalSessions").bytesOrThrow(t.private,32,"private"):void 0,senderKeyId:o("WASignalSessions").definedOrThrow(e.senderKeyId,"senderKeyId"),unusedMsgKeys:n.map(function(e){return _(o("WASignalSessions").definedOrThrow(e.iteration,"iteration"),o("WASignalSessions").bytesOrThrow(e.seed,50,"seed"))}),senderKeyChainKey:f(o("WASignalSessions").definedOrThrow(r.iteration,"iteration"),o("WASignalSessions").bytesOrThrow(r.seed,32,"seed"))}}function c(e,t,n,r,o){return{senderSigningKeyPublic:e,senderSigningKeyPrivate:t,senderKeyChainKey:n,senderKeyId:r,unusedMsgKeys:o==null?[]:o}}function d(e,t){var n=e.senderKeyStates.findIndex(function(e){return e.senderKeyId===t.senderKeyId});return{senderKeyStates:e.senderKeyStates.map(function(e,r){return r===n?t:e})}}function m(t,n){var r=t.senderKeyStates.slice(t.senderKeyStates.length>e-1?1:0);return r.push(n),{senderKeyStates:r}}function p(e){return{senderKeyStates:[e]}}function _(e,t){return{iteration:e,seed:t}}function f(e,t){return{nextMsgIndex:e,chainKey:t}}function g(e){var t=o("WASignalSessions").definedOrThrow(e.senderKeyStates,"senderKeyStates");return h(t)}function h(e){return y(e)}function y(e){var t=e.map(function(e){return u(e)});return{senderKeyStates:t}}function C(e,t){var n=e.senderKeyStates.findIndex(function(e){return e.senderKeyId===t});if(n!==-1)return e.senderKeyStates[n]}function b(e){return{senderKeyStates:e.senderKeyStates.map(function(e){return v(e)})}}function v(e){return{senderKeyId:e.senderKeyId,senderChainKey:{iteration:e.senderKeyChainKey.nextMsgIndex,seed:e.senderKeyChainKey.chainKey},senderSigningKey:{public:e.senderSigningKeyPublic,private:e.senderSigningKeyPrivate},senderMessageKeys:e.unusedMsgKeys.map(function(e){var t=e.iteration,n=e.seed;return{iteration:t,seed:n}})}}function S(e,t){return o("WASignalKeys").castToSerializedPubKey(new Uint8Array(o("WASignalSessions").definedOrThrow(e,t)))}function R(e){return e}l.FORMAT_VERSION=s,l.makeSenderKeyState=c,l.updateSessionWithUpdatedSenderKeyState=d,l.updateSessionWithNewSenderKeyState=m,l.makeNewSenderKeySession=p,l.makeSenderKeyMsgKey=_,l.makeSenderKeyChainKey=f,l.parseSessionFromRecord=g,l._parseSession=h,l.makeSenderKeySessionFromRecord=y,l.findSenderKeyState=C,l.serializeSession=b,l.serializeSenderKeyState=v,l.convertFromRawToSenderKeyState=R}),98);
__d("WASignalWhitepaper",["WABinary","WACryptoDependencies","WASignalGroupSession","WASignalKeys","WASignalOther","WASignalSessions"],(function(t,n,r,o,a,i,l){"use strict";var e=new Uint8Array(32);e.fill(255);var s=new Uint8Array([1]),u=new Uint8Array([2]);async function c(t,n,r){var a,i=t.regId,l=t.staticKeyPair,s=n.identity,u=n.signedKey.publicKey,c=r.privateKey,d=l.privateKey,m=(a=n.oneTimeKey)==null?void 0:a.publicKey,p=o("WABinary").Binary.build(e,y(d,u),y(c,s),y(c,u),m&&y(c,m)).readByteArrayView(),_=await h(p,"WhisperText"),f=_[0],C=_[1],b=n.ratchetKey,v=o("WASignalSessions").makeFreshRecvChain(b,C),S=o("WASignalKeys").makeSerializedKeyPair(),R=await g(f,S,b),L=o("WASignalSessions").makeInitialExchangeInfo(n.oneTimeKey==null?null:n.oneTimeKey.id,n.signedKey.id,o("WASignalKeys").serializePubKey(r));return o("WASignalSessions").makeFreshSession({regId:i,pubKey:o("WASignalKeys").serializePubKey(l)},{regId:n.regId,pubKey:s},R.rootKey,[v],o("WASignalSessions").makeFreshSendChain(S,R.chainKey),L,o("WASignalKeys").serializePubKey(r))}async function d(t,n,r,a){var i,l=t.regId,s=t.staticKeyPair,u=s.privateKey,c=a.signed.privateKey,d=r,m=n.pubKey,p=(i=a.oneTime)==null?void 0:i.privateKey,_=o("WABinary").Binary.build(e,C(m,c),C(d,u),C(d,c),p&&C(d,p)).readByteArrayView(),f=await h(_,"WhisperText"),g=f[0],y=f[1],b=a.ratchet,v=o("WASignalSessions").makeFreshSendChain(b,y);return o("WASignalSessions").makeSession({regId:l,pubKey:o("WASignalKeys").serializePubKey(s)},n,g,[],v,null,0,[],r)}function m(e){var t=o("WASignalGroupSession").makeSenderKeyState(o("WASignalKeys").serializePubKey(e),e.privateKey,o("WASignalGroupSession").makeSenderKeyChainKey(0,o("WASignalKeys").makeRawSenderKey()),o("WASignalOther").makeSenderKeyId(),[]);return Promise.resolve(o("WASignalGroupSession").makeNewSenderKeySession(t))}function p(e,t,n,r,a){var i=o("WASignalGroupSession").makeSenderKeyState(n,void 0,o("WASignalGroupSession").makeSenderKeyChainKey(t,r),e,[]),l=null;return a?l=o("WASignalGroupSession").updateSessionWithNewSenderKeyState(a,i):l=o("WASignalGroupSession").makeNewSenderKeySession(i),Promise.resolve(l)}async function _(e,t){var n=await o("WASignalOther").makeCryptoKey(t,"hmac-sha256"),r=function(t){return o("WACryptoDependencies").getCrypto().subtle.sign({name:"HMAC",hash:"SHA-256"},n,t)},a=r(s).then(function(e){return o("WASignalOther").hkdf(new Uint8Array(e),null,"WhisperMessageKeys",80)}).then(function(t){return o("WASignalSessions").splitMsgKey(e,t)}),i=r(u).then(function(e){return o("WASignalOther").toBytes(e,32)});return Promise.all([i,a])}async function f(e,t){var n=await o("WASignalOther").makeCryptoKey(t,"hmac-sha256"),r=function(t){return o("WACryptoDependencies").getCrypto().subtle.sign({name:"HMAC",hash:"SHA-256"},n,t)},a=r(s).then(function(e){return o("WASignalOther").hkdf(new Uint8Array(e),null,"WhisperGroup",50)}).then(function(t){return o("WASignalGroupSession").makeSenderKeyMsgKey(e,t)}),i=r(u).then(function(e){return o("WASignalOther").toBytes(e,32)});return Promise.all([i,a])}async function g(e,t,n){var r=t.privateKey,a=n,i=o("WASignalKeys").ecdh(r,a),l=await h(new Uint8Array(i),"WhisperRatchet",e),s=l[0],u=l[1];return{rootKey:s,chainKey:u}}async function h(e,t,n){n===void 0&&(n=null);var r=await o("WASignalOther").hkdf(e,n,t,64);return[o("WASignalOther").sliceBytes(r,0,32),o("WASignalOther").sliceBytes(r,32,32)]}function y(e,t){return new Uint8Array(o("WASignalKeys").ecdh(e,t))}function C(e,t){return y(t,e)}l.initiateSessionOutgoing=c,l.initiateSessionIncoming=d,l.initiateSenderKeySessionOutgoing=m,l.initiateSenderKeySessionIncoming=p,l.deriveMsgKey=_,l.deriveSenderKeyMsgKey=f,l.calculateRatchet=g}),98);
__d("WASignalCipher",["WABinary","WACryptoCurveKeyCanonicalCheck","WACryptoDependencies","WACryptoLibraryConfig","WACryptoUtils","WAResultOrError","WASignalKeys","WASignalOther","WASignalSessions","WASignalSignatures","WASignalWhisperTextProtocol.pb","WASignalWhitepaper","decodeProtobuf","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e=40,s=8,u=2e3;async function c(e,t){var n=e.sendChain,r=await o("WASignalWhitepaper").deriveMsgKey(n.nextMsgIndex,n.chainKey),a=r[0],i=r[1],l=await S(i),u=l.cipherKey,c=l.macKey,d=await o("WACryptoDependencies").getCrypto().subtle.encrypt({name:"AES-CBC",iv:i.iv},u,t),m=new(o("WABinary")).Binary;m.writeByteArray(e.local.pubKey),m.writeByteArray(e.remote.pubKey);var p=m.size();m.writeUint8(C(o("WASignalSessions").FORMAT_VERSION,o("WASignalSessions").FORMAT_VERSION)),o("encodeProtobuf").encodeProtobuf(o("WASignalWhisperTextProtocol.pb").SignalMessageSpec,{ratchetKey:n.ratchetKey.serializedPubKey,counter:i.index,previousCounter:e.prevSendChainHighestIndex,ciphertext:d},m);var _=m.readByteArrayView(),f=await v(c,_),g=_.subarray(p),h=o("WABinary").Binary.build(g,new Uint8Array(f,0,s)).readByteArrayView(),y,b,R=e.initialExchangeInfo;if(R!=null){var L,E=new(o("WABinary")).Binary;E.writeUint8(C(o("WASignalSessions").FORMAT_VERSION,o("WASignalSessions").FORMAT_VERSION)),o("encodeProtobuf").encodeProtobuf(o("WASignalWhisperTextProtocol.pb").PreKeySignalMessageSpec,{registrationId:e.local.regId,preKeyId:(L=R.remoteOneTimeId)!=null?L:void 0,signedPreKeyId:R.remoteSignedId,baseKey:R.localOneTimePubKey,identityKey:e.local.pubKey,message:h},E),y="pkmsg",b=E.readByteArrayView()}else y="msg",b=h;var k=o("WASignalSessions").makeSendChain(n.ratchetKey,i.index+1,a),I=o("WASignalSessions").updateChains(e,e.recvChains,k);return[I,{type:y,ciphertext:b}]}async function d(e,t){if(e==null)return o("WAResultOrError").makeError("errSignalNoSession");var n=await g(e,t);if(n.success){var r=n.value,a=r[0],i=r[1];return o("WAResultOrError").makeResult({newSessionInfo:null,updatedSession:a,plaintext:i})}else{for(var l=e.prevSessions,s=n,u=0;!s.success&&u<l.length;u++){var c=o("WASignalSessions").maybeClearPendingPreKey(o("WASignalSessions").parseSession(l[u])),d=await g(c,t);if(d.success){var m=d.value,p=m[0],_=m[1],f=o("WASignalSessions").setPrevSessions(p,[o("WASignalSessions").detachSession(e)].concat(l.slice(0,u),l.slice(u+1))),h=!e||!o("WACryptoUtils").serializedPubKeysEqual(f.remote.pubKey,e.remote.pubKey)?f.remote.pubKey:null;s=o("WAResultOrError").makeResult({newSessionInfo:{newIdentity:h,baseSession:c,usedPreKey:null},updatedSession:f,plaintext:_})}}return s}}function m(e,t){if(e==null)return o("WAResultOrError").makeResult(null);var n=e;if(R(n,t))return o("WAResultOrError").makeResult(n);for(var r=n.prevSessions,a=0;a<r.length;a++){var i=o("WASignalSessions").parseSession(r[a]);if(R(i,t))return o("WAResultOrError").makeError("errSignalInvalidMsg")}return o("WAResultOrError").makeResult(null)}async function p(t,n,r,a){var i,l=a.localSignedPreKey;if(l==null)return o("WAResultOrError").makeError("errSignalInvalidSignedPreKey");var s=o("WASignalSignatures").deserializeSignedPreKey(l);if(s==null)return o("WAResultOrError").makeError("errSignalSignedPreKeyDeserialization");if(s.id!==r.localSignedPreKeyId)return o("WAResultOrError").makeError("errSignalSignedPreKeyIdMismatch");var u=null;if(r.localOneTimeKeyId!=null){var c=a.localOneTimeKey;if(c==null)return o("WAResultOrError").makeError("errSignalInvalidOneTimeKey");if(u=o("WASignalKeys").deserializePreKey(c),u==null)return o("WAResultOrError").makeError("errSignalOneTimeKeyDeserialization");if(u.id!==r.localOneTimeKeyId)return o("WAResultOrError").makeError("errSignalOneTimeKeyMismatch")}if(o("WACryptoLibraryConfig").getCryptoLibraryConfig().baseKeyCanonicalCheck&&!o("WACryptoCurveKeyCanonicalCheck").isCanonical(r.sessionBaseKey.subarray(1)))return o("WAResultOrError").makeError("errSignalBaseKeyIsNotCanonical");var d=await o("WASignalWhitepaper").initiateSessionIncoming(t,r.remote,r.sessionBaseKey,{signed:s.keyPair,oneTime:(i=u)==null?void 0:i.keyPair,ratchet:o("WASignalKeys").toSerializedKeyPair(s.keyPair)}),m=d.remote.pubKey,p=!n||!o("WACryptoUtils").serializedPubKeysEqual(m,n.remote.pubKey)?m:null;n&&!p&&(d=o("WASignalSessions").setPrevSessions(d,[o("WASignalSessions").detachSession(n)].concat(n.prevSessions.slice(0,e-1))));var _=await g(d,r);if(!_.success)return _;var f=_.value,h=f[0],y=f[1];return o("WAResultOrError").makeResult({newIdentity:p,baseSession:d,updatedSession:h,plaintext:y})}function _(e){var t,n,r=null;try{var a=y(e,o("WASignalSessions").FORMAT_VERSION,s);if(!a.success)return a;var i=o("decodeProtobuf").decodeProtobuf(o("WASignalWhisperTextProtocol.pb").SignalMessageSpec,a.value),l=i.ratchetKey;if(r=i.counter,n=i.ciphertext,l==null||r==null||n==null)return o("WAResultOrError").makeError("errSignalDeserializeInvalidProtoFormat");t=o("WASignalKeys").castToSerializedPubKey(new Uint8Array(l))}catch(e){return o("WAResultOrError").makeError("errSignalDeserializeRatchetKeyBadFormat")}var u={ratchetPubKey:t,counter:r,ciphertext:new Uint8Array(n),versionContentMac:e};return o("WAResultOrError").makeResult(u)}function f(e){var t=y(e,o("WASignalSessions").FORMAT_VERSION,0);if(!t.success)return t;var n,r,a,i,l;try{var s=o("decodeProtobuf").decodeProtobuf(o("WASignalWhisperTextProtocol.pb").PreKeySignalMessageSpec,t.value),u=s.baseKey,c=s.identityKey,d=s.message,m=s.preKeyId,p=s.registrationId,f=s.signedPreKeyId;if(p==null||f==null||u==null||c==null||d==null)return o("WAResultOrError").makeError("errSignalDeserializePkInvalidProtoFormat");i=o("WASignalKeys").castToSerializedPubKey(new Uint8Array(u)),n={regId:o("WASignalOther").castRegistrationId(p),pubKey:o("WASignalKeys").castToSerializedPubKey(new Uint8Array(c))},a=m!=null?o("WASignalKeys").castToPreKeyId(m):null,r=o("WASignalKeys").castToSignedPreKeyId(f),l=new Uint8Array(d)}catch(e){return o("WAResultOrError").makeError("errSignalDeserializePkKeyBadFormat")}var g=_(l);return g.success?o("WAResultOrError").makeResult(babelHelpers.extends({},g.value,{remote:n,sessionBaseKey:i,localSignedPreKeyId:r,localOneTimeKeyId:a})):g}async function g(e,t){var n=t.ciphertext,r=t.counter,a=t.ratchetPubKey,i=t.versionContentMac,l=e.recvChains,u=e.recvChains.findIndex(function(e){return o("WACryptoUtils").serializedPubKeysEqual(e.ratchetPubKey,a)}),c,d;if(u===-1){var m=await o("WASignalWhitepaper").calculateRatchet(e.rootKey,e.sendChain.ratchetKey,a),p=o("WASignalSessions").makeFreshRecvChain(a,m.chainKey),_=await h(p,r);if(!_.success)return _;var f=_.value,g=o("WASignalKeys").makeSerializedKeyPair(),y=await o("WASignalWhitepaper").calculateRatchet(m.rootKey,g,a),C=l.slice(-4);C.push(f.updatedChain),d=f.msgKey,c=o("WASignalSessions").ratchetSession(e,C,o("WASignalSessions").makeFreshSendChain(g,y.chainKey),y.rootKey)}else{var b=await h(l[u],r);if(!b.success)return b;var R=b.value,L=l.slice();L[u]=R.updatedChain,d=R.msgKey,c=o("WASignalSessions").updateChains(e,L,e.sendChain)}var E=await S(d),k=E.cipherKey,I=E.macKey,T=o("WABinary").Binary.build(e.remote.pubKey,e.local.pubKey,i.subarray(0,-s)).readByteArrayView(),D=await v(I,T),x=i.subarray(-s),$=!o("WACryptoUtils").uint8ArraysEqual(new Uint8Array(D,0,s),x),P=null;try{P=await o("WACryptoDependencies").getCrypto().subtle.decrypt({name:"AES-CBC",iv:d.iv},k,n)}catch(e){}return $&&P==null?u===-1?o("WAResultOrError").makeError("errInvalidMacInvalidCipherKeyNewChain"):o("WAResultOrError").makeError("errInvalidMacInvalidCipherKey"):$?o("WAResultOrError").makeError("errInvalidMacWithDecryptedPlaintext"):P==null?o("WAResultOrError").makeError("errUnknownInvalidCipherKey"):o("WAResultOrError").makeResult([c,P])}async function h(e,t){var n=t-e.nextMsgIndex,r=o("WACryptoLibraryConfig").getCryptoLibraryConfig().signalFutureMessagesMax;if(n>r)return o("WAResultOrError").makeError("errSignalTooManyMessagesInFuture");var a=e.unusedMsgKeys;if(n<0){var i=a.findIndex(function(e){return e.index===t});return i===-1?o("WAResultOrError").makeError("errDuplicateMsg"):o("WAResultOrError").makeResult({msgKey:a[i],updatedChain:o("WASignalSessions").makeRecvChain(e.ratchetPubKey,e.nextMsgIndex,e.chainKey,b(a,i))})}var l=e.nextMsgIndex,s=await o("WASignalWhitepaper").deriveMsgKey(l,e.chainKey),c=s[0],d=s[1],m=null;if(n>0){var p=n+a.length-u;p>0?(m=a.slice(p),p-=a.length):m=a.slice();for(var _=l+1;_<=t;_++){p>0?p--:m.push(d);var f=await o("WASignalWhitepaper").deriveMsgKey(_,c);c=f[0],d=f[1]}}return o("WAResultOrError").makeResult({msgKey:d,updatedChain:o("WASignalSessions").makeRecvChain(e.ratchetPubKey,t+1,c,m||a)})}function y(e,t,n){if(e.length<1)return o("WAResultOrError").makeError("errSignalEmptyVersionContentSuffix");var r=e[0]>>>4;if(r!==t)return r<t?o("WAResultOrError").makeError("errSignalLegacyMsg"):o("WAResultOrError").makeError("errSignalInvalidVersion");var a=e.length-n;return a<1?o("WAResultOrError").makeError("errSignalContentExceededExpectedLength"):o("WAResultOrError").makeResult(e.subarray(1,a))}function C(e,t){return(e<<4|t)&255}function b(e,t){for(var n=[],r=0;r<e.length;r++)r!==t&&n.push(e[r]);return n}function v(e,t){return o("WACryptoDependencies").getCrypto().subtle.sign(o("WASignalOther").HMAC_SHA256,e,t)}function S(e){return Promise.all([o("WASignalOther").makeCryptoKey(e.cipherKey,"aes-cbc"),o("WASignalOther").makeCryptoKey(e.macKey,"hmac-sha256")]).then(function(e){var t=e[0],n=e[1];return{cipherKey:t,macKey:n}})}function R(e,t){var n=e.aliceBaseKey;return n?o("WACryptoUtils").serializedPubKeysEqual(n,t):!1}l.MAX_UNUSED_KEYS=u,l.encryptMsg=c,l.decryptMsg=d,l.findMatchingSession=m,l.decryptPkMsgWithNewSession=p,l.deserializeMsg=_,l.deserializePkMsg=f,l.decryptMsgFromSession=g,l.readContent=y,l.versionByte=C}),98);
__d("WASignalGroupCipher",["WABinary","WACryptoDependencies","WACryptoLibraryConfig","WALogger","WAResultOrError","WASignalCipher","WASignalGroupSession","WASignalKeys","WASignalOther","WASignalSessions","WASignalSignatures","WASignalWhisperTextProtocol.pb","WASignalWhitepaper","decodeProtobuf","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s=64;async function u(e,t){var n=p(e);if(!n.success)return n;var r=n.value,a=r.chainKey,i=r.iteration,l=r.senderKeyId,s=r.signingKeyPublic,u=await o("WASignalWhitepaper").initiateSenderKeySessionIncoming(l,i,s,a,t);return o("WAResultOrError").makeResult(u)}function c(e){var t=o("WASignalGroupSession").serializeSenderKeyState(e),n=new(o("WABinary")).Binary;return n.writeUint8(o("WASignalCipher").versionByte(o("WASignalGroupSession").FORMAT_VERSION,o("WASignalGroupSession").FORMAT_VERSION)),o("encodeProtobuf").encodeProtobuf(o("WASignalWhisperTextProtocol.pb").SenderKeyDistributionMessageSpec,{id:t.senderKeyId,iteration:o("WASignalSessions").definedOrThrow(t.senderChainKey,"senderChainKey").iteration,chainKey:o("WASignalSessions").definedOrThrow(t.senderChainKey,"senderChainKey").seed,signingKey:o("WASignalSessions").definedOrThrow(t.senderSigningKey,"senderSigningKey").public},n),n.readByteArrayView()}async function d(e,t){if(!e.senderKeyStates||e.senderKeyStates.length===0)return o("WAResultOrError").makeError("errSignalNoSession");var n=e.senderKeyStates[e.senderKeyStates.length-1],r=await o("WASignalWhitepaper").deriveSenderKeyMsgKey(n.senderKeyChainKey.nextMsgIndex,n.senderKeyChainKey.chainKey),a=r[0],i=r[1],l=await f(i.seed),s=l[0],u=l[1],c=await o("WACryptoDependencies").getCrypto().subtle.encrypt({name:"AES-CBC",iv:u},s,t),d=new(o("WABinary")).Binary;o("encodeProtobuf").encodeProtobuf(o("WASignalWhisperTextProtocol.pb").SenderKeyMessageSpec,{id:n.senderKeyId,iteration:i.iteration,ciphertext:c},d);var m=new(o("WABinary")).Binary;m.writeUint8(o("WASignalCipher").versionByte(o("WASignalGroupSession").FORMAT_VERSION,o("WASignalGroupSession").FORMAT_VERSION)),m.writeBinary(d);var p=o("WASignalKeys").makeKeyPairFromSerialized(o("WASignalSessions").definedOrThrow(n.senderSigningKeyPrivate,"senderSigningKeyPrivate"),n.senderSigningKeyPublic),_=o("WASignalSignatures").signSenderKeyMessage(p,m.readByteArrayView()),g=new(o("WABinary")).Binary;g.writeUint8(o("WASignalCipher").versionByte(o("WASignalGroupSession").FORMAT_VERSION,o("WASignalGroupSession").FORMAT_VERSION)),g.writeBinary(d),g.writeByteArray(_);var h=o("WASignalGroupSession").makeSenderKeyChainKey(i.iteration+1,a),y=o("WASignalGroupSession").updateSessionWithUpdatedSenderKeyState(e,o("WASignalGroupSession").makeSenderKeyState(n.senderSigningKeyPublic,n.senderSigningKeyPrivate,h,n.senderKeyId,n.unusedMsgKeys));return o("WAResultOrError").makeResult([y,g.readByteArrayView()])}async function m(e,t){var n=t.ciphertext,r=t.iteration,a=t.senderKeyMessageId,i=t.versionContentMac,l=o("WASignalGroupSession").findSenderKeyState(e,a);if(l==null)return o("WAResultOrError").makeError("errSignalNoSession");var s=l.senderSigningKeyPublic,u=g(i,s);if(!u)return o("WAResultOrError").makeError("errSignalInvalidKey");var c=await h(l,r);if(!c.success)return c;var d=c.value,m=d.msgKey,p=o("WASignalGroupSession").updateSessionWithUpdatedSenderKeyState(e,d.updatedSenderKeyState),_=await f(m.seed),y=_[0],C=_[1],b=await o("WACryptoDependencies").getCrypto().subtle.decrypt({name:"AES-CBC",iv:C},y,n);return o("WAResultOrError").makeResult([p,b])}function p(e){var t,n,r,a,i;try{if(i=o("WASignalCipher").readContent(e,o("WASignalGroupSession").FORMAT_VERSION,0),!i.success)return i;var l=o("decodeProtobuf").decodeProtobuf(o("WASignalWhisperTextProtocol.pb").SenderKeyDistributionMessageSpec,i.value);t=l.id,n=l.iteration;var s=o("WASignalSessions").bytesOrThrow(l.signingKey,33,"signingKey");if(r=o("WASignalKeys").castToSerializedPubKey(s),a=o("WASignalSessions").bytesOrThrow(l.chainKey,32,"chainKey"),t==null||n==null)return o("WAResultOrError").makeError("errSignalGrpInvalidProtoFormat")}catch(e){return o("WAResultOrError").makeError("errSignalGrpInvalidKeyFormat")}return o("WAResultOrError").makeResult({senderKeyId:t,iteration:n,signingKeyPublic:r,chainKey:a})}function _(t){if(t.length<1)return o("WAResultOrError").makeError("errSignalGrpVersionContentEmpty");var n=t[0]>>>4;if(n!==o("WASignalGroupSession").FORMAT_VERSION)return n<o("WASignalGroupSession").FORMAT_VERSION?o("WAResultOrError").makeError("errSignalLegacyMsg"):o("WAResultOrError").makeError("errSignalInvalidVersion");if(t.length<1+s)return o("WAResultOrError").makeError("errSignalGrpInvalidVersionContentLength");var r,a,i;try{var l=t.subarray(1,-s),u=o("decodeProtobuf").decodeProtobuf(o("WASignalWhisperTextProtocol.pb").SenderKeyMessageSpec,l);if(r=u.id,a=u.iteration,i=u.ciphertext,r==null||a==null||i==null)return o("WAResultOrError").makeError("errSignalGrpSenderKeyInvalidProtoFormat")}catch(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Exception caught during SenderKeyMessageSpec Proto: ",""])),t),o("WAResultOrError").makeError("errSignalGrpSenderKeyProtoError")}return o("WAResultOrError").makeResult({senderKeyMessageId:r,iteration:a,ciphertext:new Uint8Array(i),versionContentMac:t})}async function f(e){var t=new(o("WABinary")).Binary(e),n=o("WASignalOther").readBytes(t,16),r=o("WASignalOther").readBytes(t,32);return[await o("WASignalOther").makeCryptoKey(r,"aes-cbc"),n]}function g(e,t){var n=e.subarray(e.length-s),r=e.subarray(0,e.length-s);return o("WASignalSignatures").verifyMsgSignalVariant(t,r,o("WASignalOther").toBytes(o("WASignalOther").toBuffer(n),64))}async function h(e,t){var n=e,r=t-n.senderKeyChainKey.nextMsgIndex,a=o("WACryptoLibraryConfig").getCryptoLibraryConfig().signalFutureMessagesMax;if(r>a)return o("WAResultOrError").makeError("errSignalGrpTooManyMessagesInFuture");var i=e.unusedMsgKeys||[];if(r<0){var l=i.findIndex(function(e){return e.iteration===t});return l===-1?o("WAResultOrError").makeError("errDuplicateMsg"):o("WAResultOrError").makeResult({msgKey:i[l],updatedSenderKeyState:o("WASignalGroupSession").makeSenderKeyState(n.senderSigningKeyPublic,n.senderSigningKeyPrivate,n.senderKeyChainKey,n.senderKeyId,y(i,l))})}var s=n.senderKeyChainKey.nextMsgIndex,u=await o("WASignalWhitepaper").deriveSenderKeyMsgKey(s,n.senderKeyChainKey.chainKey),c=u[0],d=u[1],m=null;if(r>0){var p=r+i.length-o("WASignalCipher").MAX_UNUSED_KEYS;p>0?(m=i.slice(p),p-=i.length):m=i.slice();for(var _=s+1;_<=t;_++){p>0?p--:m.push(d);var f=await o("WASignalWhitepaper").deriveSenderKeyMsgKey(_,c);c=f[0],d=f[1]}}return o("WAResultOrError").makeResult({msgKey:d,updatedSenderKeyState:o("WASignalGroupSession").makeSenderKeyState(n.senderSigningKeyPublic,n.senderSigningKeyPrivate,o("WASignalGroupSession").makeSenderKeyChainKey(t+1,c),e.senderKeyId,m||i)})}function y(e,t){for(var n=[],r=0;r<e.length;r++)r!==t&&n.push(e[r]);return n}l.processSenderKeyDistributionMsg=u,l.createSenderKeyDistributionProto=c,l.encryptSenderKeyMsgWithSession=d,l.decryptSenderKeyMsgFromSession=m,l.deserializeSenderKeyMsg=_}),98);
__d("WACryptoLibrary",["WACryptoUtils","WAJids","WALockMap","WALogger","WAResultOrError","WASignalCipher","WASignalGroupCipher","WASignalGroupSession","WASignalKeys","WASignalOther","WASignalSignatures","WASignalWhitepaper"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("WALockMap").makeLockMap(6e4),u=[],c=300;function d(e){u.push(e),u.length>=c&&u.shift()}function m(e){e(u),u=[]}async function p(e,t){d("createOutgoingSession");var n=R(t),r=n.signedKey,a=await o("WASignalSignatures").verifyMsgSignalVariant(n.identity,r.publicKey,r.signature);if(!a)return d("createOutgoingSession: errSignalInvalidKey"),o("WAResultOrError").makeError("errSignalInvalidKey");var i=await o("WASignalWhitepaper").initiateSessionOutgoing(e,n,o("WASignalKeys").makeKeyPair());return o("WAResultOrError").makeResult(i)}async function _(e,t,n,r,o){var a=e.handleNewSession;d("establishOutgoingSession");var i=await p(t,r);if(!i.success)return i;var l=i.value;return a(n,l,l.remote.pubKey,null,o)}function f(e,t,n,r){var a=e.handleNewSession,i=e.loadSession;return d("encryptContent"),s.lock([o("WAJids").extractUserJid(t)],async function(){var e=null;do{var l=await i(t,"cryptoLibraryEncryptContent");if(l==null)return d("encryptContent: errSignalInvalidKey"),o("WAResultOrError").makeError("errSignalInvalidKey");if(r!=null&&!o("WACryptoUtils").uint8ArraysEqual(r,l.remote.pubKey))return d("encryptContent: identity-mismatch"),o("WAResultOrError").makeError("identity-mismatch");var s=await o("WASignalCipher").encryptMsg(l,n),u=s[0],c=s[1],m=await a(t,u,u.remote.pubKey);m.success?e=o("WAResultOrError").makeResult(babelHelpers.extends({},c,{baseKey:u.aliceBaseKey})):m.error}while(e==null);return e})}function g(e,t,n,r,a){var i=e.handleNewSession,l=e.loadOneTimePreKey,u=e.loadSession,c=e.loadSignedPreKey;return d("decryptContent"),s.lock([o("WAJids").extractUserJid(n)],async function(){var e=!1,s=await u(n,"decryptContent"),m;if(r.type==="pkmsg"){var p=o("WASignalCipher").deserializePkMsg(r.ciphertext);if(!p.success)return d("decryptContent: errCryptoDeserialization"),o("WAResultOrError").makeError("errCryptoDeserialization");var _=p.value,f=await h({loadSignedPreKey:c,loadOneTimePreKey:l},t,_,s);if(!f.success)return f;m=f.value}else{r.type;var g=o("WASignalCipher").deserializeMsg(r.ciphertext);if(!g.success)return d("decryptContent: errCryptoDeserialization"),o("WAResultOrError").makeError("errCryptoDeserialization");var y=g.value,C=await o("WASignalCipher").decryptMsg(s,y);if(!C.success)return C;m=C.value}var b=m,v=b.newSessionInfo;if(v&&(v.newIdentity!=null||v.usedPreKey!=null)&&await i(n,v.baseSession,v.newIdentity,v.usedPreKey),!e){var S=v==null?void 0:v.baseSession.remote.pubKey;await a(new Uint8Array(m.plaintext),S),e=!0}return await i(n,m.updatedSession,m.updatedSession.remote.pubKey),o("WAResultOrError").makeResult()})}async function h(e,t,n,r){var a=e.loadOneTimePreKey,i=e.loadSignedPreKey;d("decryptPkMsg");var l=o("WASignalCipher").findMatchingSession(r,n.sessionBaseKey);if(!l.success)return l;var s=l.value;if(s){var u=await o("WASignalCipher").decryptMsgFromSession(s,n);if(!u.success)return u;var c=u.value,m=c[0],p=c[1];return o("WAResultOrError").makeResult({newSessionInfo:null,updatedSession:m,plaintext:p})}else{var _=n.localOneTimeKeyId,f=await i(n.localSignedPreKeyId),g=_==null?null:await a(_),h=await o("WASignalCipher").decryptPkMsgWithNewSession(t,r,n,{localSignedPreKey:f,localOneTimeKey:g});if(!h.success)return h;var y=h.value,C=y.baseSession,b=y.newIdentity,v=y.plaintext,S=y.updatedSession;return o("WAResultOrError").makeResult({newSessionInfo:{newIdentity:b,baseSession:C,usedPreKey:_},updatedSession:S,plaintext:v})}}function y(e,t,n,r){var a=e.loadSenderKeySession,i=e.saveSenderKeySession;return d("encryptGroupContent"),s.lock([t,o("WAJids").extractUserJid(n)],async function(){var e=null;do{var l=await a(t,n);if(!l.success)return o("WAResultOrError").makeError(l.error);var s=l.value,u=await o("WASignalGroupCipher").encryptSenderKeyMsgWithSession(s,r);if(u.success){var c=u.value,m=c[0],p=c[1];await i(t,n,m);var _=s.senderKeyStates[s.senderKeyStates.length-1];e=o("WAResultOrError").makeResult({ciphertext:{ciphertext:p,type:"skmsg"},senderKeyId:_.senderKeyId,senderKeyDistributionProto:o("WASignalGroupCipher").createSenderKeyDistributionProto(o("WASignalGroupSession").convertFromRawToSenderKeyState(_))})}else return d("encryptGroupContent: sender-key-no-session"),o("WAResultOrError").makeError("sender-key-no-session")}while(e==null);return e})}function C(t,n,r,a,i){var l=t.loadSenderKeySession,u=t.saveSenderKeySession;return d("decryptGroupContent"),s.lock([n,o("WAJids").extractUserJid(r)],async function(){var t=!1,s=await l(n,r);if(!s.success)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[WACryptoLibrary] Unable to load sender key session for group during decryptGroupContent: ",", author: ",""])),n,r),o("WAResultOrError").makeError(s.error);var c=o("WASignalGroupCipher").deserializeSenderKeyMsg(a);if(!c.success)return d("decryptGroupContent: errCryptoDeserialization"),o("WAResultOrError").makeError("errCryptoDeserialization");var m=s.value,p=await o("WASignalGroupCipher").decryptSenderKeyMsgFromSession(m,c.value);if(!p.success)return p;var _=p.value,f=_[0],g=_[1];return t||(await i(new Uint8Array(g)),t=!0),await u(n,r,f),o("WAResultOrError").makeResult()})}function b(e,t,n,r){var a=e.loadSenderKeySession,i=e.saveSenderKeySession;return d("saveSenderKeySession"),s.lock([t,o("WAJids").extractUserJid(n)],async function(){var e=null;if(a){var l=await a(t,n);e=l.success?l.value:null}var s=await o("WASignalGroupCipher").processSenderKeyDistributionMsg(r,e);if(!s.success)return s;var u=s.value;return await i(t,n,u),o("WAResultOrError").makeResult()})}function v(e,t,n,r){var a=e.saveSenderKeySession;return d("rotateGroupSenderKey"),s.lock([t,o("WAJids").extractUserJid(n)],async function(){var e=await o("WASignalWhitepaper").initiateSenderKeySessionOutgoing(r),i=e.senderKeyStates[0].senderKeyId;return await a(t,n,e),{senderKeyId:i}})}async function S(e,t,n){var r=e.loadSenderKeySession,a=e.saveSenderKeySession;d("createSenderKeyDistributionMsg");var i=await r(t,n),l=i.error;if(!i.success&&l==="errLoadSenderKeySession"){var s=await o("WASignalKeys").makeKeyPair();await v({saveSenderKeySession:a},t,n,s),i=await r(t,n)}if(i.success){var u=i.value.senderKeyStates.slice(-1);if(u.length>0)return o("WAResultOrError").makeResult(o("WASignalGroupCipher").createSenderKeyDistributionProto(o("WASignalGroupSession").convertFromRawToSenderKeyState(u[0])))}return d("createSenderKeyDistributionMsg: errGetSenderKeyProto"),o("WAResultOrError").makeError("errGetSenderKeyProto")}function R(e){var t=e.identity,n=e.oneTimeKey,r=e.regId,a=e.signedKey;d("sanitizeInitialSessionInfo");var i=o("WASignalKeys").castToSerializedPubKey(a.publicKey);return{regId:o("WASignalOther").castRegistrationId(r),identity:o("WASignalKeys").castToSerializedPubKey(t),signedKey:{id:o("WASignalKeys").castToSignedPreKeyId(a.id),publicKey:i,signature:o("WASignalOther").ensureSize(a.signature,64)},oneTimeKey:n&&{id:o("WASignalKeys").castToPreKeyId(n.id),publicKey:o("WASignalKeys").castToSerializedPubKey(n.publicKey)},ratchetKey:i}}l.publishLogs=m,l.createOutgoingSession=p,l.establishOutgoingSession=_,l.encryptContent=f,l.decryptContent=g,l.encryptGroupContent=y,l.decryptGroupContent=C,l.saveSenderKeySession=b,l.rotateGroupSenderKey=v,l.createSenderKeyDistributionMsg=S}),98);
__d("WACryptoManager",["WABridge","WACryptoLibrary","WACryptoUtils","WAGlobals","WAJids","WALogger","WALoggerTag","WANullthrows","WAOdsEnums","WAPromiseQueue","WAResultOrError","WASignalCipher","WASignalGroupSession","WASignalKeys","WASignalLocalStorageProtocol.pb","WASignalOther","WASignalSessions","WASignalSignatures","WATagsLogger","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("WATagsLogger").TAGS([r("WALoggerTag").CryptoManager]),_={type:"default"};function f(e){return{flush:function(){return e.storage.savePendingToDatabase().then(function(){})}}}function g(e){return{regInfo:e.regInfo,network:e.network,storage:e.storage}}async function h(e,t,n,r,a){var i=await r(t,a);if(i!=null&&n.type!=="requestNewSession"){var l=i;if(n.type==="default")return o("WAResultOrError").makeResult(l);if(l.aliceBaseKey!=null&&n.session.baseKey!=null&&(n.type,!o("WACryptoUtils").uint8ArraysEqual(n.session.baseKey,l.aliceBaseKey)))return o("WAResultOrError").makeResult(l)}var s;if(n.type==="useSession")s=n.session.keys;else{n.type;var u=await e.network.requestKeys(t);if(!u.success)return u;s=u.value.keys,n.type==="compareTSAndUseSession"&&n.session.timestamp>=u.value.timestamp&&(s=n.session.keys)}var c=await o("WACryptoLibrary").createOutgoingSession(e.regInfo,s);return c.success?o("WAResultOrError").makeResult(c.value):c}function y(e,t,n,r){return o("WACryptoLibrary").establishOutgoingSession({handleNewSession:e.storage.handleNewSession},e.regInfo,t,n,r)}async function C(t,n){var r=await t.storage.loadSessions(n),a=n.filter(function(e){return!r.has(e)});if(a.length===0)return r;var i=await t.network.bulkRequestKeys(a);if(!i.success)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[sessions] fail during key requesting"]))),r;for(var l of r.entries()){var u=l[0],c=l[1];c.sendChain.nextMsgIndex>=o("WAGlobals").getConfig().sessionDropIfTooOld()&&(r.delete(u),o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.WA_LONG_SESSION_DROP,key:"decryption"}))}var d=i.value,m=new(o("WAPromiseQueue")).PromiseQueue;return d.forEach(function(e,n){m.enqueue(function(){return o("WACryptoLibrary").createOutgoingSession(t.regInfo,e.keys).then(function(e){e.success===!1?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[sessions] Failed to create a session"]))):r.set(n,e.value)})})}),await m.wait(),r}async function b(e,t){var n=Array.from(t.keys());o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[SendMessage] sendWrittenMsg bulkEncryptContent"])));var a=await C(e,n),i=new Map;return Promise.all(Array.from(a.entries()).map(async function(n){var a,l=n[0],s=n[1],u=await o("WASignalCipher").encryptMsg(s,r("WANullthrows")((a=t.get(l))==null?void 0:a.plaintext)),c=u[0],d=u[1];return i.set(l,babelHelpers.extends({},d,{baseKey:null})),e.storage.handleNewSession(l,c,c.remote.pubKey)})).then(function(){return o("WAResultOrError").makeResult(i)})}function v(e,t,n,r,a){return o("WACryptoLibrary").encryptContent({loadSession:function(n){return h(e,n,r,e.storage.loadSession,"cryptoManagerEncryptContent").then(function(e){return e.success===!0?e.value:null})},handleNewSession:e.storage.handleNewSession},t,n,a)}function S(e,t,n,r){return o("WACryptoLibrary").decryptContent({loadSession:e.storage.loadSession,handleNewSession:e.storage.handleNewSession,loadSignedPreKey:e.storage.loadSignedPreKey,loadOneTimePreKey:e.storage.loadOneTimePreKey},e.regInfo,t,n,r)}async function R(e,t){var n=await e.storage.loadSession(t,"getParticipantInfo");return n==null?void 0:n.remote}async function L(e){var t,n,a=await e.storage.getLastPreKeyGenerationId(),i=((t=a==null?void 0:a.lastPreKeyId)!=null?t:0)+1,l=o("WASignalKeys").makePreKeys(i,1)[0],s=await e.storage.saveOneTimePreKey({keyId:l.plainObject.id,encoded:l.record});if(s.success)return l.plainObject;throw r("err")("Cannot save one time prekey: "+s.error+", LastPreKeyId: "+((n=a==null?void 0:a.lastPreKeyId)!=null?n:0))}async function E(e,t){var n;t===void 0&&(t=o("WAGlobals").getConfig().maxPrekeysToUpload());var r=await e.storage.getLastPreKeyGenerationId(),a=o("WASignalKeys").makePreKeys(((n=r==null?void 0:r.lastPreKeyId)!=null?n:0)+1,t);return e.storage.savePreKeysGeneration(a.map(function(e){var t=e.plainObject,n=e.record;return{keyId:t.id,encoded:n}}))}function k(e){return e.storage.loadLatestSignedPreKey().then(function(t){if(t.success===!1){var n,a,i;throw p.TAGS([r("WALoggerTag").SignedPrekey]).ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate signed prekey ",""])),t==null||(n=t.payload)==null?void 0:n.toString()),r("err")("Failed to generate signed prekey: "+((a=t==null||(i=t.payload)==null?void 0:i.message)!=null?a:""))}var l=t.value,s=o("WASignalSignatures").deserializeSignedPreKey(l);if(s==null)throw p.TAGS([r("WALoggerTag").SignedPrekey]).ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to deserialize signed prekey: ",""])),t),r("err")("failed to deserialize signed prekey");var u=s.id+1>=o("WASignalKeys").PRE_KEY_NON_INCLUSIVE_UPPER_BORDER?1:s.id+1;return I(e,u)})}function I(e,t){var n=o("WASignalSignatures").makeSignedPreKey(t,o("WATimeUtils").unixTimeMs(),e.regInfo.staticKeyPair),a=o("WASignalSignatures").serializeSignedPreKeyForPrivateStorage(n);return e.storage.saveSignedPreKeyIfNew(n.id,a).then(function(e){return e.type==="success"?o("WAResultOrError").makeResult(n):(e.type,o("WAResultOrError").makeResult(e.key))}).then(function(e){if(!e.success){var t,n;throw p.TAGS([r("WALoggerTag").SignedPrekey]).ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate signed prekey with id: ",""])),e),r("err")("Unexpected error when generateSignedPreKeyWithId: "+((t=e==null||(n=e.payload)==null?void 0:n.message)!=null?t:e.error))}return e.value})}function T(e,t,n,r){return o("WACryptoLibrary").encryptGroupContent({loadSenderKeySession:e.storage.loadSenderKeySession,saveSenderKeySession:e.storage.saveSenderKeySession},t,n,r)}function D(e,t,n,r,a){return o("WACryptoLibrary").decryptGroupContent({loadSenderKeySession:e.storage.loadSenderKeySession,saveSenderKeySession:e.storage.saveSenderKeySession},t,n,r,a)}function x(e,t,n,r){return o("WACryptoLibrary").saveSenderKeySession({saveSenderKeySession:e.storage.saveSenderKeySession},t,n,r)}async function $(e,t,n){var r=await L(e);return o("WACryptoLibrary").rotateGroupSenderKey({saveSenderKeySession:e.storage.saveSenderKeySession},t,n,r.keyPair)}function P(e){return Promise.resolve().then(function(){return{regId:o("WASignalOther").makeRegistrationId(e),staticKeyPair:o("WASignalKeys").makeKeyPair(),authKeyPair:o("WASignalKeys").makeKeyPair()}})}function N(e){return o("WASignalOther").encodeSignalProto(o("WASignalLocalStorageProtocol.pb").RecordStructureSpec,o("WASignalSessions").serializeSession(e))}function M(e){return o("WASignalOther").decodeSignalProto(o("WASignalLocalStorageProtocol.pb").RecordStructureSpec,e,o("WASignalSessions").parseSessionFromRecord)}function w(e){return o("WASignalOther").encodeSignalProto(o("WASignalLocalStorageProtocol.pb").SenderKeyRecordStructureSpec,o("WASignalGroupSession").serializeSession(e))}function A(e){return o("WASignalOther").decodeSignalProto(o("WASignalLocalStorageProtocol.pb").SenderKeyRecordStructureSpec,e,o("WASignalGroupSession").parseSessionFromRecord)}function F(e){return e}function O(e,t){return e+"|"+t}function B(e){var t=e.split("|");if(t.length!==2)throw r("err")("Incorrect ComplexSenderKey");return{groupId:o("WAJids").unsafeCoerceToGroupJid(t[0]),deviceId:o("WAJids").unsafeCoerceToDeviceJid(t[1])}}l.DEFAULT_SESSION_REQUEST=_,l.cryptoManagerFlushable=f,l.initCryptoManager=g,l.getSessionForRecipient=h,l.establishOutgoingSession=y,l.ensureSessionsExists=C,l.bulkEncryptContent=b,l.encryptContent=v,l.decryptContent=S,l.getParticipantInfo=R,l.generateOneTimePreKey=L,l.generatePreKeys=E,l.generateSignedPreKey=k,l.generateSignedPreKeyWithId=I,l.encryptGroupContent=T,l.decryptGroupContent=D,l.saveSenderKeySession=x,l.rotateGroupSenderKey=$,l.generateRegistrationInfo=P,l.encodeSession=N,l.decodeSession=M,l.encodeSenderKeySession=w,l.decodeSenderKeySession=A,l.castToPreKeyGenerationId=F,l.encodeSenderKey=O,l.decodeSenderKey=B}),98);
__d("WADbSignal",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}function l(e,t,n){return e+"_"+t+"_"+n}var s={abProps:"abProps",authKeyPair:"authKeyPair",cat:"cat",certificateChain:"certificateChain",clockSkew:"clockSkew",deviceId:"deviceId",deviceUUID:"deviceUUID",edgeInfo:"edgeInfo",fbid:"fbid",identityKeyPair:"identityKeyPair",lastPrekeyGenerationId:"lastPrekeyGenerationId",lastPrekeyId:"lastPrekeyId",lastSessionDeviceWasLinkedTo:"lastSessionDeviceWasLinkedTo",lastSignedPrekeyId:"lastSignedPrekeyId",regId:"regId",registrationVersion:"registrationVersion",deviceRegUnixTime:"deviceRegUnixTime"},u={msgrDeviceId:"msgrDeviceId"},c={registrationHistory:"registrationHistory"};i.unsafeCoerceToSenderKeySessionId=e,i.buildSenderKeySessionId=l,i.MetaKeysEnum=s,i.PlainTextMetaKeysEnum=c}),66);
__d("WABulkSaveSignalDataApi",["WACryptoManager","WADbSignal","WAJids","WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=async function(t){var e=t.dhashUpdate,n=t.icdcUpdate,r=t.identityRemove,a=t.identityUpdate,i=t.lastSyncTsUpdate,l=t.preKeyRemove,c=t.senderKeySessionUpdate,d=t.sessionRemove,m=t.sessionUpdate,p=m.map(function(e){var t=e.id,n=e.updated;return{id:t,session:o("WACryptoManager").encodeSession(n)}}),_=[];c.forEach(function(e){var t=e.author,n=e.groupId,r=e.updated,a=o("WAJids").extractUserJid(t),i=o("WAJids").extractDeviceId(t),l=o("WADbSignal").buildSenderKeySessionId(n,a,i);_.push({deviceId:i,groupJid:n,id:l,record:o("WACryptoManager").encodeSenderKeySession(r),userJid:a})}),await o("WASignalDB").getDb().runInTransaction(["contacts","identity","prekey","senderKeySessions","session"],"readwrite",function(t){var o=t.stores,c=o.identity,m=o.prekey,f=o.senderKeySessions,g=o.session;return Promise.all([g.bulkDelete(d),c.bulkDelete(r),g.bulkPut(p),f.bulkPut(_),u(t.stores,a),s(t.stores,n,a,e,i),m.bulkDelete(l.map(function(e){var t=e.id;return t}))])},o("WASignalDB").signalOp("bulkSaveSignalData"))};async function s(e,t,n,r,a){var i=new Set;for(var l of n)i.add(o("WAJids").extractUserJid(l.id));var s=Array.from(i);for(var u of t)i.add(u.id);var c=await e.contacts.bulkGet(Array.from(i)),d=new Map;for(var m of c)m!=null&&d.set(m.contactJid,m);for(var p of s){var _=d.get(p);_==null?(_={contactJid:p,dhash:null},d.set(p,_)):_.dhash=null}for(var f of t){var g=d.get(f.id);g==null?(g={contactJid:f.id,dhash:null,icdcInfo:f.icdc},d.set(f.id,g)):g.icdcInfo=f.icdc}for(var h of r){var y=d.get(h.id);y==null?(y={contactJid:h.id,dhash:h.dhash},d.set(h.id,y)):y.dhash=h.dhash}for(var C of a){var b=d.get(C.id);b==null?(b={contactJid:C.id,dhash:null,lastSyncTs:C.lastSyncTs},d.set(C.id,b)):b.lastSyncTs=C.lastSyncTs}await e.contacts.bulkPut(Array.from(d.values()))}async function u(e,t){if(t.length!==0){var n=t.map(function(e){var t=e.id,n=e.identity;return{deviceJid:t,identity:n,userJid:o("WAJids").extractUserJid(t)}});await e.identity.bulkPut(n)}}l.bulkSaveSignalData=e}),98);
__d("WAIdentityUtils",["WABinary","WACryptoDependencies","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.length===33&&e[0]===5;return t?e.slice(1):e}function s(e,t){for(var n=0;n<e.length&&n<t.length;++n)if(e[n]!==t[n])return e[n]-t[n];return e.length-t.length}function u(t){var n=t.map(function(t){return e(t)}),r=new(o("WABinary")).Binary;n.sort(s).forEach(function(e){return r.writeByteArray(e)});var a=o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",r.readByteArrayView());return a.then(function(e){var t=new Uint8Array(e);return o("WASignalOther").sliceBytes(t,0,10)})}l.removeKeyTypeIfNeeded=e,l.computeIdentitiesHash=u}),98);
__d("WAICDCUtils",["WAArmadilloICDC.pb","WABase64","WABinary","WACryptoDependencies","WACryptoEd25519","WACryptoUtils","WAIdentityUtils","WALogger","WASignalKeys","WASignalOther","WASignalSignatures","WATimeUtils","decodeProtobuf","encodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(t,n,r,a){if(t!==a.details.seq)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received ICDC has mismatched sequence between XML node and byte structure"]))),null;if(r!==a.details.timestamp)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Received ICDC has mismatched timestamp between XML node and byte structure"]))),null;if(a.details.signingDeviceIndex==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Received ICDC has mismatched missed signingDeviceIndex"]))),null;var i=a.details.signingDeviceIndex;return{dirty:n,sequence:t,timestamp:r,signingDeviceIndex:i,devices:a.details.devices.map(function(e){return new Uint8Array(e)})}}function p(e){return e.signingDeviceIndex<0||e.signingDeviceIndex>=e.devices.length}function _(e){var t=o("decodeProtobuf").decodeProtobuf(o("WAArmadilloICDC.pb").SignedICDCIdentityListSpec,e),n=t.signature,r=o("decodeProtobuf").decodeProtobuf(o("WAArmadilloICDC.pb").ICDCIdentityListSpec,t.details);return{signature:n,details:r}}function f(e){return e.map(function(e){return o("WASignalKeys").serializeIdentity(new Uint8Array(o("WABase64").decodeB64UrlSafe(e)))})}function g(e,t,n,a,i){var l=o("WAIdentityUtils").removeKeyTypeIfNeeded(e.publicKey),s=n.map(function(e){return o("WAIdentityUtils").removeKeyTypeIfNeeded(e)}),u=s.findIndex(function(e){return o("WACryptoUtils").uint8ArraysEqual(e,l)});if(u===-1)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["signingDeviceIndex not found. This should never happen. ",". caller: ",""])),a,i),r("err")("signingDeviceIndex not found");var m=t==null?1:t+1,p=o("WATimeUtils").unixTime();p<0&&o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["ICDC timestamp is negative. time: ",", closkSkew: ",""])),Date.now(),o("WATimeUtils").getClockSkew());var _={seq:m,timestamp:p,devices:s,signingDeviceIndex:u},f=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloICDC.pb").ICDCIdentityListSpec,_).readBuffer(),g=h(e,o("WABinary").Binary.build(f).readByteArrayView()),y={details:f,signature:g},C=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloICDC.pb").SignedICDCIdentityListSpec,y).readBuffer();return{icdcInfo:_,encodedSignedICDC:C}}function h(e,t){var n=o("WASignalOther").makeBytes(64);o("WACryptoDependencies").getCrypto().getRandomValues(n);var r=new Uint8Array(64);o("WACryptoEd25519").hashSha512(r,t,t.length);var a=o("WASignalSignatures").makeSignature(e,t,n);return o("WABinary").Binary.build(a).readBuffer()}var y=4*o("WATimeUtils").HOUR_SECONDS;function C(e){return e==null?!0:!o("WATimeUtils").happenedWithin(e,y)}l.validateAndPrepareICDCFromNotification=m,l.isICDCIndexInvalid=p,l.decodeICDCInfo=_,l.base64DeviceIdentitiesToSerializedPubKeys=f,l.computeICDCInfoForUpload=g,l.isLastSyncTsExpired=C}),98);
__d("WAComputeAndUploadICDCInfo",["WABase64","WADeprecatedSendIq","WADeprecatedWapParser","WAGetDevices","WAGlobals","WAICDCUtils","WAIdentityUtils","WALogger","WAPromiseBackoffs","WAWap","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=new(r("WADeprecatedWapParser"))("parseUploadICDCInfoResponse",function(e){e.assertTag("iq"),e.assertFromServer(),e.assertAttr("type","result")}),m=0,p=async function(n){var t=n.caller,a=n.reason,i=n.sequence;o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["computeAndUploadICDCInfo called ",""])),i);var l;try{l=await o("WAGlobals").getWaOneQueue().enqueue(async function(e){var t=e.cryptoManager,n=await t.storage.loadIdentities(o("WAGlobals").getMyUserJid()),r=t.regInfo;return{regInfo:r,identities:Array.from(n.values())}},{operationType:"icdc_load_identities",flush:!1,afterInit:!0})}catch(e){var p=r("getErrorSafe")(e);o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Loading identities fails with error: ",""])),p.toString())}if(l!=null){var _=l,f=_.identities,g=_.regInfo,h=o("WAICDCUtils").computeICDCInfoForUpload(g.staticKeyPair,i,f,a,t),y=h.encodedSignedICDC,C=h.icdcInfo,b=await o("WAIdentityUtils").computeIdentitiesHash(f),v=o("WAWap").wap("iq",{id:o("WAWap").generateId(),to:o("WAWap").S_WHATSAPP_NET,type:"set",xmlns:"fbid:devices"},o("WAWap").wap("icdc",{ihash:o("WAWap").CUSTOM_STRING(o("WABase64").encodeB64(b)),seq:o("WAWap").INT(C.seq),ts:o("WAWap").INT(C.timestamp)},y)),S=await o("WADeprecatedSendIq").deprecatedSendIq(v,d);S.success?(m=0,await o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return t.storage.saveICDC(o("WAGlobals").getMyUserJid(),{sequence:C.seq,timestamp:C.timestamp,devices:C.devices,signingDeviceIndex:C.signingDeviceIndex,dirty:!1})},{operationType:"save_icdc",flush:!0,afterInit:!0})):(m+=1,S.errorCode===406||S.errorCode===500?setTimeout(function(){o("WAGetDevices").getDevices({ignoreDhash:!0,reason:"compute-Upload-icdc",users:new Set().add(o("WAGlobals").getMyUserJid())}).catch(function(e){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed getting devices ",""])),e.toString())})},o("WAPromiseBackoffs").getDelay(m,{jitter:.1,max:3e4,algo:{type:"fibonacci",first:1e3,second:1e3}})):o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Cannot update ICDC for user, because of "," server response"])),S.errorCode))}};l.computeAndUploadICDCInfo=p}),98);
__d("WAFetchAndSaveDevices",["WAComputeAndUploadICDCInfo","WAGlobals","WAICDCUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){if(t.length!==0){var n=[];await o("WAGlobals").getWaOneQueue().enqueue(function(r){var a=r.cryptoManager;return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Update user devices signal and DB"]))),Promise.all(t.map(function(e){var t;return n.push({contactJid:e.jid,dhash:e.dhash,lastSyncTs:e.lastSyncTs,icdcInfo:(t=e.icdcInfo)!=null?t:void 0}),a.storage.updateUserDevicesInfo([e])}))},{operationType:"get_devices",flush:!0,afterInit:!0});var r=o("WAGlobals").getMyUserJid(),a=t.find(function(e){return e.jid===r});if(a!=null){var i=a.icdcInfo;if(i==null||o("WAICDCUtils").isICDCIndexInvalid(i)||i!=null&&i.dirty){var l;i==null?l="empty":i.dirty?l="dirty":l="invalidIndex",o("WAComputeAndUploadICDCInfo").computeAndUploadICDCInfo({reason:l,caller:"get_devices",sequence:i==null?void 0:i.sequence}).catch(function(e){})}}}}l.updateUsersDevicesSignalAndDB=s}),98);
__d("WAPushSafeTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.unsafeNotNullable=e}),66);
__d("WAGetDevices",["WADevicesState","WALogger","WAPushSafeTypes"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){var n=o("WAPushSafeTypes").unsafeNotNullable(t),r=n.ignoreDhash,a=r===void 0?!1:r,i=n.reason,l=n.users;o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["fetchAndSaveDevices: ",""])),i),a&&o("WADevicesState").getDevicesState().reset(Array.from(l)),await o("WADevicesState").getDevicesState().waitForUserDevices(Array.from(l),"getDevices job: "+i,a)}l.getDevices=s}),98);
__d("WAHandleFbDeviceChangeNotificationProtocol",["WAICDCUtils","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.dhash}function s(e){var t,n=((t=e.iCDCDirtyMixin)==null?void 0:t.dirty)==="true",r=o("WATimeUtils").castToUnixTime(e.ts),a=e.seq,i=o("WAICDCUtils").decodeICDCInfo(e.elementValue),l=o("WAICDCUtils").validateAndPrepareICDCFromNotification(a,n,r,i);return l==null?o("WAResultOrError").makeError("icdc-validation-failure"):o("WAResultOrError").makeResult(l)}l.parseDhash=e,l.parseICDCFromServer=s}),98);
__d("WALoadContactsApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["contacts"],"readonly",function(e){return e.stores.contacts.bulkGet(t).then(function(e){return new Map(e.filter(Boolean).map(function(e){return[e.contactJid,{contactJid:e.contactJid,dhash:e.dhash,icdcFails:e.icdcFails,icdcInfo:e.icdcInfo,lastSyncTs:e.lastSyncTs}]}))})},o("WASignalDB").signalOp("loadContacts"))};l.loadContacts=e}),98);
__d("WARPCAbortController",["Promise"],(function(t,n,r,o,a,i){"use strict";var e,l="rpc-timeout";function s(t,r){var o,a=new(e||(e=n("Promise")))(function(e,t){o=setTimeout(function(){t(l)},r)});return e.race([t,a]).finally(function(){clearTimeout(o)})}i.RPC_TIMEOUT=l,i.rpcAbortController=s}),66);
__d("WASmaxInDevicesIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",r.value);if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","error");return s.success?o("WAResultOrError").makeResult({type:s.value}):s}l.parseIQErrorResponseMixin=e}),98);
__d("WASmaxInDevicesIQErrorBadRequestMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","bad-request");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",400);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorBadRequestMixin=e}),98);
__d("WASmaxInDevicesNonRetryableIQErrorMixin",["WASmaxInDevicesIQErrorBadRequestMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxInDevicesIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(e);return n.success,n}l.parseNonRetryableIQErrorMixin=e}),98);
__d("WASmaxInDevicesIQErrorInternalServerErrorMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","internal-server-error");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",500);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorInternalServerErrorMixin=e}),98);
__d("WASmaxInDevicesIQErrorServiceUnavailableMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","service-unavailable");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",503);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorServiceUnavailableMixin=e}),98);
__d("WASmaxInDevicesIQErrorInternalServerErrorOrServiceUnavailableMixinGroup",["WAResultOrError","WASmaxInDevicesIQErrorInternalServerErrorMixin","WASmaxInDevicesIQErrorServiceUnavailableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInDevicesIQErrorInternalServerErrorMixin").parseIQErrorInternalServerErrorMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorInternalServerError",value:t.value});var n=o("WASmaxInDevicesIQErrorServiceUnavailableMixin").parseIQErrorServiceUnavailableMixin(e);return n.success?o("WAResultOrError").makeResult({name:"IQErrorServiceUnavailable",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorInternalServerError","IQErrorServiceUnavailable"],[t,n])}l.parseIQErrorInternalServerErrorOrServiceUnavailableMixinGroup=e}),98);
__d("WASmaxInDevicesRetryableIQErrorMixin",["WAResultOrError","WASmaxInDevicesIQErrorInternalServerErrorOrServiceUnavailableMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,e,"backoff",0,86400);if(!n.success)return n;var r=o("WASmaxInDevicesIQErrorInternalServerErrorOrServiceUnavailableMixinGroup").parseIQErrorInternalServerErrorOrServiceUnavailableMixinGroup(e);return r.success?o("WAResultOrError").makeResult({backoff:n.value,iQErrorInternalServerErrorOrServiceUnavailableMixinGroup:r.value}):r}l.parseRetryableIQErrorMixin=e}),98);
__d("WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup",["WAResultOrError","WASmaxInDevicesNonRetryableIQErrorMixin","WASmaxInDevicesRetryableIQErrorMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInDevicesRetryableIQErrorMixin").parseRetryableIQErrorMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"RetryableIQError",value:t.value});var n=o("WASmaxInDevicesNonRetryableIQErrorMixin").parseNonRetryableIQErrorMixin(e);return n.success?o("WAResultOrError").makeResult({name:"NonRetryableIQError",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["RetryableIQError","NonRetryableIQError"],[t,n])}l.parseRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup=e}),98);
__d("WASmaxInDevicesFetchResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup").parseRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup:i.value})):i}l.parseFetchResponseError=e}),98);
__d("WASmaxInDevicesIQErrorItemNotFoundMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","item-not-found");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",404);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorItemNotFoundMixin=e}),98);
__d("WASmaxInDevicesFetchNonRetryableUserErrorMixin",["WASmaxInDevicesIQErrorItemNotFoundMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxInDevicesIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(e);return n.success,n}l.parseFetchNonRetryableUserErrorMixin=e}),98);
__d("WASmaxInDevicesFetchRetryableUserErrorMixin",["WAResultOrError","WASmaxInDevicesIQErrorInternalServerErrorOrServiceUnavailableMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxInDevicesIQErrorInternalServerErrorOrServiceUnavailableMixinGroup").parseIQErrorInternalServerErrorOrServiceUnavailableMixinGroup(e);return n.success?o("WAResultOrError").makeResult({iQErrorInternalServerErrorOrServiceUnavailableMixinGroup:n.value}):n}l.parseFetchRetryableUserErrorMixin=e}),98);
__d("WASmaxInDevicesFetchOrFetchNonRetryableUserErrorMixinGroup",["WAResultOrError","WASmaxInDevicesFetchNonRetryableUserErrorMixin","WASmaxInDevicesFetchRetryableUserErrorMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInDevicesFetchRetryableUserErrorMixin").parseFetchRetryableUserErrorMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"FetchRetryableUserError",value:t.value});var n=o("WASmaxInDevicesFetchNonRetryableUserErrorMixin").parseFetchNonRetryableUserErrorMixin(e);return n.success?o("WAResultOrError").makeResult({name:"FetchNonRetryableUserError",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["RetryableUserError","NonRetryableUserError"],[t,n])}l.parseFetchOrFetchNonRetryableUserErrorMixinGroup=e}),98);
__d("WASmaxInDevicesFetchUserResponseFailureMixin",["WAResultOrError","WASmaxInDevicesFetchOrFetchNonRetryableUserErrorMixinGroup","WASmaxParseJid","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"user");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!n.success)return n;var r=o("WASmaxParseJid").attrUserJid(e,"jid");if(!r.success)return r;var a=o("WASmaxInDevicesFetchOrFetchNonRetryableUserErrorMixinGroup").parseFetchOrFetchNonRetryableUserErrorMixinGroup(n.value);return a.success?o("WAResultOrError").makeResult({jid:r.value,errorFetchOrFetchNonRetryableUserErrorMixinGroup:a.value}):a}l.parseFetchUserResponseFailureMixin=e}),98);
__d("WASmaxInDevicesDeviceModelInfoMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"platform");if(!t.success)return t;var n=o("WASmaxParseUtils").contentString(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function s(e){var t=o("WASmaxParseUtils").assertTag(e,"model");if(!t.success)return t;var n=o("WASmaxParseUtils").contentString(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function u(t){var n=o("WASmaxParseUtils").optionalChildWithTag(t,"platform",e);if(!n.success)return n;var r=o("WASmaxParseUtils").optionalChildWithTag(t,"model",s);return r.success?o("WAResultOrError").makeResult({platform:n.value,model:r.value}):r}l.parseDeviceModelInfoPlatform=e,l.parseDeviceModelInfoModel=s,l.parseDeviceModelInfoMixin=u}),98);
__d("WASmaxInDevicesDhashMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").attrString(e,"dhash");return t.success?o("WAResultOrError").makeResult({dhash:t.value}):t}l.parseDhashMixin=e}),98);
__d("WASmaxInDevicesKeyDataMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").contentBytesRange(e,32,32);return t.success?o("WAResultOrError").makeResult({elementValue:t.value}):t}l.parseKeyDataMixin=e}),98);
__d("WASmaxInDevicesIdentityKeyMixin",["WASmaxInDevicesKeyDataMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"identity");if(!t.success)return t;var n=o("WASmaxInDevicesKeyDataMixin").parseKeyDataMixin(t.value);return n.success,n}l.parseIdentityKeyMixin=e}),98);
__d("WASmaxInDevicesDeviceListMixin",["WAResultOrError","WASmaxInDevicesDeviceModelInfoMixin","WASmaxInDevicesDhashMixin","WASmaxInDevicesIdentityKeyMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"device");if(!t.success)return t;var n=o("WASmaxParseUtils").attrIntRange(e,"id",1,999);if(!n.success)return n;var r=o("WASmaxInDevicesIdentityKeyMixin").parseIdentityKeyMixin(e);if(!r.success)return r;var a=o("WASmaxInDevicesDeviceModelInfoMixin").parseDeviceModelInfoMixin(e);return o("WAResultOrError").makeResult(babelHelpers.extends({id:n.value},r.value,{deviceModelInfoMixin:a.success?a.value:null}))}function s(t){var n=o("WASmaxParseUtils").assertTag(t,"devices");if(!n.success)return n;var r=o("WASmaxInDevicesDhashMixin").parseDhashMixin(t),a=o("WASmaxParseUtils").mapChildrenWithTag(t,"device",0,25,e);return a.success?o("WAResultOrError").makeResult({dhashMixin:r.success?r.value:null,device:a.value}):a}l.parseDeviceListDevice=e,l.parseDeviceListMixin=s}),98);
__d("WASmaxInDevicesICDCDirtyMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"icdc");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"dirty","true");return n.success?o("WAResultOrError").makeResult({dirty:n.value}):n}l.parseICDCDirtyMixin=e}),98);
__d("WASmaxInDevicesICDCSeqMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").attrIntRange(e,"seq",0,2147483647);return t.success?o("WAResultOrError").makeResult({seq:t.value}):t}l.parseICDCSeqMixin=e}),98);
__d("WASmaxInDevicesICDCSignedListMixin",["WAResultOrError","WASmaxInDevicesICDCSeqMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"icdc");if(!t.success)return t;var n=o("WASmaxParseUtils").attrIntRange(e,"ts",0,void 0);if(!n.success)return n;var r=o("WASmaxParseUtils").contentBytesRange(e,1,40072);if(!r.success)return r;var a=o("WASmaxInDevicesICDCSeqMixin").parseICDCSeqMixin(e);return a.success?o("WAResultOrError").makeResult(babelHelpers.extends({ts:n.value,elementValue:r.value},a.value)):a}l.parseICDCSignedListMixin=e}),98);
__d("WASmaxInDevicesICDCFromServerMixin",["WAResultOrError","WASmaxInDevicesICDCDirtyMixin","WASmaxInDevicesICDCSignedListMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"icdc");if(!t.success)return t;var n=o("WASmaxInDevicesICDCSignedListMixin").parseICDCSignedListMixin(e);if(!n.success)return n;var r=o("WASmaxInDevicesICDCDirtyMixin").parseICDCDirtyMixin(e);return o("WAResultOrError").makeResult(babelHelpers.extends({},n.value,{iCDCDirtyMixin:r.success?r.value:null}))}l.parseICDCFromServerMixin=e}),98);
__d("WASmaxInDevicesFetchUserResponseSuccessMixin",["WAResultOrError","WASmaxInDevicesDeviceListMixin","WASmaxInDevicesICDCFromServerMixin","WASmaxParseJid","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"devices");if(!t.success)return t;var n=o("WASmaxInDevicesDeviceListMixin").parseDeviceListMixin(e);return n.success,n}function s(e){var t=o("WASmaxParseUtils").assertTag(e,"icdc");if(!t.success)return t;var n=o("WASmaxInDevicesICDCFromServerMixin").parseICDCFromServerMixin(e);return n.success,n}function u(t){var n=o("WASmaxParseUtils").assertTag(t,"user");if(!n.success)return n;var r=o("WASmaxParseUtils").optionalChildWithTag(t,"devices",e);if(!r.success)return r;var a=o("WASmaxParseUtils").optionalChildWithTag(t,"icdc",s);if(!a.success)return a;var i=o("WASmaxParseJid").attrUserJid(t,"jid");return i.success?o("WAResultOrError").makeResult({jid:i.value,devices:r.value,icdc:a.value}):i}l.parseFetchUserResponseSuccessDevices=e,l.parseFetchUserResponseSuccessIcdc=s,l.parseFetchUserResponseSuccessMixin=u}),98);
__d("WASmaxInDevicesUserResponseFetchFailureOrFetchSuccessMixinGroup",["WAResultOrError","WASmaxInDevicesFetchUserResponseFailureMixin","WASmaxInDevicesFetchUserResponseSuccessMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInDevicesFetchUserResponseFailureMixin").parseFetchUserResponseFailureMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"FetchUserResponseFailure",value:t.value});var n=o("WASmaxInDevicesFetchUserResponseSuccessMixin").parseFetchUserResponseSuccessMixin(e);return n.success?o("WAResultOrError").makeResult({name:"FetchUserResponseSuccess",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["UserResponseFailure","UserResponseSuccess"],[t,n])}l.parseUserResponseFetchFailureOrFetchSuccessMixinGroup=e}),98);
__d("WASmaxInDevicesFetchUserResponseMixin",["WAResultOrError","WASmaxInDevicesUserResponseFetchFailureOrFetchSuccessMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"user");if(!t.success)return t;var n=o("WASmaxInDevicesUserResponseFetchFailureOrFetchSuccessMixinGroup").parseUserResponseFetchFailureOrFetchSuccessMixinGroup(e);return n.success?o("WAResultOrError").makeResult({userResponseFetchFailureOrFetchSuccessMixinGroup:n.value}):n}l.parseFetchUserResponseMixin=e}),98);
__d("WASmaxInDevicesIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",r.value);if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","result");return s.success?o("WAResultOrError").makeResult({type:s.value}):s}l.parseIQResultResponseMixin=e}),98);
__d("WASmaxInDevicesFetchResponseSuccess",["WAResultOrError","WASmaxInDevicesFetchUserResponseMixin","WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"user");if(!t.success)return t;var n=o("WASmaxInDevicesFetchUserResponseMixin").parseFetchUserResponseMixin(e);return n.success,n}function s(t,n){var r=o("WASmaxParseUtils").assertTag(t,"iq");if(!r.success)return r;var a=o("WASmaxParseUtils").flattenedChildWithTag(t,"users");if(!a.success)return a;var i=o("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(t,n);if(!i.success)return i;var l=o("WASmaxParseUtils").mapChildrenWithTag(a.value,"user",0,25,e);return l.success?o("WAResultOrError").makeResult(babelHelpers.extends({},i.value,{usersUser:l.value})):l}l.parseFetchResponseSuccessUsersUser=e,l.parseFetchResponseSuccess=s}),98);
__d("WASmaxOutDevicesBaseIQGetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("iq",{id:o("WAWap").generateId(),type:"get"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeBaseIQGetRequestMixin=s}),98);
__d("WASmaxOutDevicesDhashMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyDhash,n=o("WASmaxJsx").smax("smax$any",{dhash:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeDhashMixin=s}),98);
__d("WASmaxOutDevicesICDCSeqMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anySeq,n=o("WASmaxJsx").smax("smax$any",{seq:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeICDCSeqMixin=s}),98);
__d("WASmaxOutDevicesFetchRequest",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutDevicesBaseIQGetRequestMixin","WASmaxOutDevicesDhashMixin","WASmaxOutDevicesICDCSeqMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.userJid,n=e.dhashMixinArgs,r=e.iCDCSeqMixinArgs,a=o("WASmaxMixins").optionalMerge(o("WASmaxOutDevicesICDCSeqMixin").mergeICDCSeqMixin,o("WASmaxMixins").optionalMerge(o("WASmaxOutDevicesDhashMixin").mergeDhashMixin,o("WASmaxJsx").smax("user",{jid:o("WAWap").USER_JID(t)}),n),r);return a}function s(t){var n=t.userArgs,r=o("WASmaxOutDevicesBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(o("WASmaxJsx").smax("iq",{to:o("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},o("WASmaxJsx").smax("users",null,o("WASmaxChildren").REPEATED_CHILD(e,n,1,25))));return r}l.makeFetchRequestUsersUser=e,l.makeFetchRequest=s}),98);
__d("WASmaxDevicesFetchRPC",["WAComms","WASmaxInDevicesFetchResponseError","WASmaxInDevicesFetchResponseSuccess","WASmaxOutDevicesFetchRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(t,n,r,o,a,i,l){async function e(e,t){var n=o("WASmaxOutDevicesFetchRequest").makeFetchRequest(e),r=await o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInDevicesFetchResponseSuccess").parseFetchResponseSuccess(r,n);if(a.success)return{name:"FetchResponseSuccess",value:a.value};var i=o("WASmaxInDevicesFetchResponseError").parseFetchResponseError(r,n);if(i.success)return{name:"FetchResponseError",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("Fetch",{Success:a,Error:i}))}l.sendFetchRPC=e}),98);
__d("WAFetchFbDevicesProtocolV2",["WAArrayChunk","WAHandleFbDeviceChangeNotificationProtocol","WAJids","WALoadContactsApi","WARPCAbortController","WASignalKeys","WASmaxDevicesFetchRPC","WATagsLogger","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=25,c=1e4,d=o("WATagsLogger").TAGS(["wa-devices-protocol"]);async function m(e,t){if(e.length===0)return new Map;var n=await p(e,t),r=o("WAArrayChunk").chunk(e.map(function(e){var t=n.get(e),r=t!=null?{anyDhash:t}:null;return{userJid:e,dhashMixinArgs:r}}),u),a=new Map;return await Promise.allSettled(r.map(function(e){return _(a,e)})),a}async function p(e,t){if(t)return new Map;var n=await o("WALoadContactsApi").loadContacts(e),r=new Map;return n.forEach(function(e){e&&e.dhash!=null&&r.set(e.contactJid,e.dhash)}),r}async function _(t,n){try{var a=new Set(n.map(function(e){return e.userJid})),i=await o("WARPCAbortController").rpcAbortController(o("WASmaxDevicesFetchRPC").sendFetchRPC({userArgs:n}),c);if(i.name==="FetchResponseError")throw r("err")("Failed to fetch user devices");i.value.usersUser.map(function(e){var n=e.userResponseFetchFailureOrFetchSuccessMixinGroup;if(n.name!=="FetchUserResponseFailure"){var r=n.value,i=r.devices,l=r.icdc,s=r.jid;a.delete(s),t.set(s,{newState:f(s,i,l,o("WATimeUtils").unixTime()),stateIsUpToDate:!1})}}),a.forEach(function(e){t.set(e,{stateIsUpToDate:!0})})}catch(t){if(t===o("WARPCAbortController").RPC_TIMEOUT){d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Timeout for fetchAndSaveDevices"])));return}d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)}}function f(e,t,n,r){r===void 0&&(r=null);var a=[],i=null;if(t){var l;a=t.device.map(function(e){var t,n;return{id:o("WAJids").interpretAsDeviceId(e.id),identity:o("WASignalKeys").serializeIdentity(e.elementValue),platform:(t=e.deviceModelInfoMixin)==null||(t=t.platform)==null?void 0:t.elementValue,model:(n=e.deviceModelInfoMixin)==null||(n=n.model)==null?void 0:n.elementValue}}),i=(l=t.dhashMixin)==null?void 0:l.dhash}var s=null;if(n){var u=o("WAHandleFbDeviceChangeNotificationProtocol").parseICDCFromServer(n);s=u.success?u.value:null}return{jid:e,devices:a,lastSyncTs:o("WATimeUtils").unixTime(),dhash:i,icdcInfo:s,notificationTs:r}}l.fetchFbDevicesProtocol=m}),98);
__d("WADevicesState",["WAFetchAndSaveDevices","WAFetchFbDevicesProtocolV2","WAResolvable","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=3e4,m=1e3*60*60,p=o("WATagsLogger").TAGS(["WADevicesState"]),_=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.$2=function(t){var e=this;setTimeout(function(){t.forEach(function(t){var n=t[0],r=t[1];r.resolveWasCalled()||(r.resolve(o("WAResultOrError").makeError()),e.$1.get(n)===r&&e.$1.delete(n))})},d),setTimeout(function(){t.forEach(function(t){var n=t[0],r=t[1];e.$1.get(n)===r&&e.$1.delete(n)})},m)},n.waitForUserDevices=async function(n,r,a){var t=this;a===void 0&&(a=!1);var i=[],l=[];a===!0&&n.forEach(function(e){t.$1.delete(e)}),n.forEach(function(e){var n=t.$1.get(e);if(n==null){var r=new(o("WAResolvable")).Resolvable;i.push([e,r]),t.$1.set(e,r)}else l.push([e,n.promise])}),this.$2(i),p.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["getDevices called for users ",", reason: ",""])),Array.from(n),r);var d=await o("WAFetchFbDevicesProtocolV2").fetchFbDevicesProtocol(i.map(function(e){var t=e[0];return t}),a).catch(function(e){return p.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["fetchFBDevicesProtocol failed: ",""])),e),new Map}),m=!0;p.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["getDevices -> update devices signal"]))),await o("WAFetchAndSaveDevices").updateUsersDevicesSignalAndDB(Array.from(d.values()).map(function(e){return e.newState}).filter(Boolean)).catch(function(e){m=!1,p.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["updateDevicesSignalAndDB failed: ",""])),e)}),i.forEach(function(e){var n=e[0],r=e[1];if(!m){r.resolve(o("WAResultOrError").makeError()),t.$1.delete(n);return}d.has(n)?r.resolve(o("WAResultOrError").makeResult()):(r.resolve(o("WAResultOrError").makeError()),t.$1.delete(n))}),await Promise.allSettled(l.map(function(e){var t=e[0],n=e[1];return n}))},n.reset=function(t){var e=this;t.forEach(function(t){return e.$1.delete(t)})},t})(),f=new _;function g(){return f}l.DeviceStateClassV2=_,l.getDevicesState=g}),98);
__d("WAComputeICDC",["WAGetDevices","WAICDCUtils","WAIdentityUtils","WAJids","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS(["WAComputeICDC"]);async function m(t,n,r,a){var i=new Set,l=[].concat(t),m=t.find(function(e){return e.user===n});if(m==null){var p=await a.cryptoManager.storage.loadIdentities(n),_=p.get(r);if(_==null){d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Sender does not have identity"])));return}l.push({user:n,devicesInfo:[{identity:_,jid:r}]})}var f=void 0,g=[],h=[];return await Promise.all(l.map(async function(e){var t=await Promise.all([a.cryptoManager.storage.loadICDC(e.user),a.cryptoManager.storage.loadLastSyncTs(e.user)]),r=t[0],l=t[1];o("WAICDCUtils").isLastSyncTsExpired(l)&&i.add(e.user);var u=new Set;if(r==null)i.add(e.user);else if(o("WAICDCUtils").isICDCIndexInvalid(r))i.add(e.user),d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ICDC has invalid index"]))),r=null;else for(var c of r.devices)u.add(c.toString());var m=[],p=[];for(var _ of e.devicesInfo){var y=o("WAJids").extractDeviceId(_.jid),C=o("WAIdentityUtils").removeKeyTypeIfNeeded(_.identity);u.has(C.toString())||(m.push(y),p.push(C.buffer))}var b={unknownDevices:p,unknownDeviceIds:m};r!=null&&(b.seq=r.sequence,b.signingDevice=r.devices[r.signingDeviceIndex].buffer),e.user===n?f=b:(g.push(b),h.push(e.user))})),i.size>0&&(d.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Triggering getDevices for users with missing or incorrect icdc info."]))),o("WAGetDevices").getDevices({ignoreDhash:!0,reason:"missing-icdc-info",users:i}).catch(function(e){d.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Error during get devices for users with missing icdc info: ",""])),e)})),{senderIdentity:f,recipientIdentities:g,recipientUserJids:h}}l.computeICDC=m}),98);
__d("WAMultiDevice.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={};s.name="MultiDevice",s.internalSpec={payload:[1,(e=o("WAProtoConst")).TYPES.MESSAGE,c],metadata:[2,e.TYPES.MESSAGE,u]},u.name="MultiDevice$Metadata",u.internalSpec={},c.name="MultiDevice$Payload",c.internalSpec={applicationData:[1,e.TYPES.MESSAGE,d],signal:[2,e.TYPES.MESSAGE,y],__oneofs__:{payload:["applicationData","signal"]}},d.name="MultiDevice$ApplicationData",d.internalSpec={appStateSyncKeyShare:[1,e.TYPES.MESSAGE,p],appStateSyncKeyRequest:[2,e.TYPES.MESSAGE,m],__oneofs__:{applicationData:["appStateSyncKeyShare","appStateSyncKeyRequest"]}},m.name="MultiDevice$ApplicationData$AppStateSyncKeyRequestMessage",m.internalSpec={keyIds:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,h]},p.name="MultiDevice$ApplicationData$AppStateSyncKeyShareMessage",p.internalSpec={keys:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,_]},_.name="MultiDevice$ApplicationData$AppStateSyncKey",_.internalSpec={keyId:[1,e.TYPES.MESSAGE,h],keyData:[2,e.TYPES.MESSAGE,f]},f.name="MultiDevice$ApplicationData$AppStateSyncKey$AppStateSyncKeyData",f.internalSpec={keyData:[1,e.TYPES.BYTES],fingerprint:[2,e.TYPES.MESSAGE,g],timestamp:[3,e.TYPES.INT64]},g.name="MultiDevice$ApplicationData$AppStateSyncKey$AppStateSyncKeyData$AppStateSyncKeyFingerprint",g.internalSpec={rawId:[1,e.TYPES.UINT32],currentIndex:[2,e.TYPES.UINT32],deviceIndexes:[3,e.FLAGS.REPEATED|e.FLAGS.PACKED|e.TYPES.UINT32]},h.name="MultiDevice$ApplicationData$AppStateSyncKeyId",h.internalSpec={keyId:[1,e.TYPES.BYTES]},y.name="MultiDevice$Signal",y.internalSpec={},l.MultiDeviceSpec=s,l.MultiDevice$MetadataSpec=u,l.MultiDevice$PayloadSpec=c,l.MultiDevice$ApplicationDataSpec=d,l.MultiDevice$ApplicationData$AppStateSyncKeyRequestMessageSpec=m,l.MultiDevice$ApplicationData$AppStateSyncKeyShareMessageSpec=p,l.MultiDevice$ApplicationData$AppStateSyncKeySpec=_,l.MultiDevice$ApplicationData$AppStateSyncKey$AppStateSyncKeyDataSpec=f,l.MultiDevice$ApplicationData$AppStateSyncKey$AppStateSyncKeyData$AppStateSyncKeyFingerprintSpec=g,l.MultiDevice$ApplicationData$AppStateSyncKeyIdSpec=h,l.MultiDevice$SignalSpec=y}),98);
__d("WAParseAppStateSyncKeyRequest",["WASyncdKeyTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=[];for(var n of e.keyIds)n.keyId!=null&&t.push(o("WASyncdKeyTypes").toSyncKeyId(n.keyId));return{keyIds:t}}l.parseAppStateSyncKeyRequest=e}),98);
__d("WASyncdKeyManagementUtils",["WASyncdKeyTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return new DataView(o("WASyncdKeyTypes").fromSyncKeyId(e)).getUint16(0)}function s(e){return new DataView(o("WASyncdKeyTypes").fromSyncKeyId(e)).getUint32(2)}function u(e){return s(e)+1}l.getKeyDeviceId=e,l.getKeyEpoch=s,l.generateNewKeyEpoch=u}),98);
__d("WAParseAppStateSyncKeyShare",["WALogger","WALongInt","WASyncdKeyManagementUtils","WASyncdKeyTypes"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){var t=[],n=[];for(var r of e.keys){var o=u(r);o!=null&&(o.type==="orphan"?n.push(o.keyId):(o.type,t.push(o.keyData)))}return{keys:t,orphanKeys:n}}function u(t){var n,r,a,i,l,s;if(((n=t.keyId)==null?void 0:n.keyId)==null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Key missing keyId"]))),null;var u=o("WASyncdKeyTypes").toSyncKeyId(t.keyId.keyId),c=(r=t.keyData)==null?void 0:r.keyData,d=o("WALongInt").maybeNumberOrThrowIfTooLarge((a=t.keyData)==null?void 0:a.timestamp),m=(i=t.keyData)==null||(i=i.fingerprint)==null?void 0:i.currentIndex,p=(l=t.keyData)==null||(l=l.fingerprint)==null?void 0:l.deviceIndexes,_=(s=t.keyData)==null||(s=s.fingerprint)==null?void 0:s.rawId;return t.keyData==null||c==null||d==null||m==null||p==null||_==null?{keyId:u,type:"orphan"}:{keyData:{fingerprint:{currentIndex:m,deviceIndexes:p,rawId:_},keyData:o("WASyncdKeyTypes").toSyncKeyData(c),keyEpoch:o("WASyncdKeyManagementUtils").getKeyEpoch(u),keyId:u,timestamp:d},type:"key"}}l.parseAppStateSyncKeyShare=s}),98);
__d("WAConvertAppData",["WAAppData","WAArmadilloApplication.pb","WAJids","WALogger","WAMultiDevice.pb","WAParseAppStateSyncKeyRequest","WAParseAppStateSyncKeyShare","WAStanzaUtils","WASyncdKeyTypes","WATimeUtils","decodeProtobuf","encodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b;function v(e){var t=o("WAJids").interpretAndValidateJid(e);if(t.jidType==="msgrUser")return t.userJid;if(t.jidType==="group")return t.groupJid;throw t.jidType,r("err")("Incorrect jid type: "+t.jidType)}function S(e){var t=o("WAJids").interpretAndValidateJid(e);if(t.jidType==="msgrUser")return t.userJid;if(t.jidType==="msgrDevice")return o("WAJids").extractUserJid(t.deviceJid);throw t.jidType,r("err")("Incorrect jid type: "+t.jidType)}function R(e){return e!=null?typeof e=="number"&&e>o("WATimeUtils").MAX_INT?o("WATimeUtils").castMilliSecondsToUnixTime(e):o("WATimeUtils").castLongIntToUnixTime(e):void 0}function L(e){return e==null?void 0:{lastMessageTimestamp:R(e.lastMessageTimestamp),lastSystemMessageTimestamp:R(e.lastSystemMessageTimestamp),messages:e.messages==null?[]:e.messages.map(function(e){return{key:e.key==null?void 0:{fromMe:e.key.fromMe,id:e.key.id},ts:R(e.timestamp)}})}}function E(t,n){var r=t.chatId;if(r==null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Missing chatId in chat action: ",""])),t),null;if(t.chatArchive!=null){var a=t.chatArchive,i=L(a.messageRange);return{chatJid:v(r),messageRange:i,ts:n,type:"chat_archive"}}else if(t.chatDelete!=null){var l=t.chatDelete,u=L(l.messageRange);return{chatJid:v(r),messageRange:u,ts:n,type:"chat_delete"}}else if(t.chatRead!=null){var c=t.chatRead,d=L(c.messageRange);return{chatJid:v(r),messageRange:d,read:c.read,ts:n,type:"chat_read"}}else return o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata sync action type: ",""])),t),null}function k(e){var t=e.key,n=t==null?void 0:t.remoteJid,r=t==null?void 0:t.id,a=t==null?void 0:t.fromMe;if(t==null||n==null||a==null||r==null)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing messageKey in message action: ",""])),e),null;var i=v(n),l=o("WAJids").interpretAsGroupJid(i)!=null,s;if(l&&!a){if((t==null?void 0:t.participant)==null)return o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["No participant in messageKey in message action when it is group chat and message is not fromMe: ",""])),e),null;s=S(t.participant)}else a?s=o("WAJids").AUTHOR_ME:s=S(n);var m={author:s,chat:i,externalId:o("WAStanzaUtils").toStanzaId(r)};return e.messageDelete!=null?{protocolMsgId:m,type:"delete_for_me"}:(o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata sync action type: ",""])),e),null)}function I(e){var t=[];for(var n of e){var r=R(n.actionTimestamp);if(n.chatAction!=null){var a=E(n.chatAction,r);a!=null&&t.push({chatAction:a})}else if(n.messageAction!=null){var i=k(n.messageAction);i!=null&&t.push({messageAction:i})}else o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata sync action type: ",""])),n)}return t}function T(e){var t=e.anonId,n=e.id,r=e.rootKey,a=e.status;if(a==null||n==null||t==null||r==null)return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["missing keys in EncryptedBackupsSecretsEpoch"]))),null;var i;if(a===o("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCH_STATUS.ES_OPEN)i=o("WAAppData").EPOCH_STATUS_OPEN;else if(a===o("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCH_STATUS.ES_CLOSE)i=o("WAAppData").EPOCH_STATUS_CLOSE;else return o("WALogger").WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["status in EncryptedBackupsSecretsEpoch has invalid value"]))),null;return{anonId:t,id:n,rootKey:r,status:i}}function D(e){var t=e.backupId,n=e.epoch,r=e.mailboxRootKey,a=e.obliviousValidationToken,i=e.serverDataId,l=e.tempOcmfClientState;return t==null||i==null||l==null||r==null||a==null?(o("WALogger").WARN(f||(f=babelHelpers.taggedTemplateLiteralLoose(["missing keys in EncryptedBackupsSecrets"]))),null):{backupId:t,epoch:n.map(T).reduce(function(e,t){return t!=null?e.concat([t]):e},[]),mailboxRootKey:r,obliviousValidationToken:a,serverDataId:i,tempOcmfClientState:l}}function x(e){var t,n;if(((t=e.applicationData)==null||(t=t.metadataSync)==null?void 0:t.actions)!=null){var r;return{actions:I((r=e.applicationData)==null||(r=r.metadataSync)==null?void 0:r.actions),type:"meta_sync"}}else if(((n=e.signal)==null?void 0:n.encryptedBackupsSecrets)!=null){var a=D(e.signal.encryptedBackupsSecrets);return a==null?null:{encryptedBackupsSecrets:a,type:"backups_secrets"}}else return o("WALogger").WARN(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),e),null}function $(e){var t,n;if(((t=e.applicationData)==null?void 0:t.appStateSyncKeyShare)!=null){var r;return{syncKeyShare:o("WAParseAppStateSyncKeyShare").parseAppStateSyncKeyShare((r=e.applicationData)==null?void 0:r.appStateSyncKeyShare),type:"sync_key_share"}}else if(((n=e.applicationData)==null?void 0:n.appStateSyncKeyRequest)!=null){var a;return{syncKeyRequest:o("WAParseAppStateSyncKeyRequest").parseAppStateSyncKeyRequest((a=e.applicationData)==null?void 0:a.appStateSyncKeyRequest),type:"sync_key_request"}}else return o("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),e),null}function P(e){if(e.subprotocolType==="armadillo"){var t=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAArmadilloApplication.pb").ArmadilloSpec,e.payload);if(t.payload==null)throw r("err")("Appdata contains unparseable armadillo data.");return x(t.payload)}else if(e.subprotocolType==="multiDevice"){var n=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMultiDevice.pb").MultiDeviceSpec,e.payload);if(n.payload==null)throw r("err")("Appdata contains unparseable armadillo data.");return $(n.payload)}else throw r("err")("Appdata contains unexpected message application: "+e.subprotocolType)}function N(e){return e==null?void 0:{lastMessageTimestamp:e.lastMessageTimestamp,lastSystemMessageTimestamp:e.lastSystemMessageTimestamp,messages:e.messages.map(function(e){return{key:e.key==null?void 0:{fromMe:e.key.fromMe,id:e.key.id},timestamp:e.ts}})}}function M(e){switch(e.type){case"meta_sync":return{payload:{applicationData:V(e)}};case"backups_secrets":return{payload:{signal:{encryptedBackupsSecrets:q(e.encryptedBackupsSecrets)}}};default:return e.type,o("WALogger").WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),e.type),{}}}function w(e){return{keyId:o("WASyncdKeyTypes").fromSyncKeyId(e)}}function A(e){return{keyData:{fingerprint:{currentIndex:e.fingerprint.currentIndex,deviceIndexes:e.fingerprint.deviceIndexes,rawId:e.fingerprint.rawId},keyData:o("WASyncdKeyTypes").fromSyncKeyData(e.keyData),timestamp:e.timestamp},keyId:w(e.keyId)}}function F(e){var t=e.keys.map(A),n=e.orphanKeys==null?[]:e.orphanKeys.map(function(e){return{keyId:w(e)}});return t.push.apply(t,n),{keys:t}}function O(e){return{keyIds:e.keyIds.map(w)}}function B(e){switch(e.type){case"sync_key_share":return{payload:{applicationData:{appStateSyncKeyShare:F(e.syncKeyShare)}}};case"sync_key_request":return{payload:{applicationData:{appStateSyncKeyRequest:O(e.syncKeyRequest)}}};default:return e.type,o("WALogger").WARN(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),e.type),{}}}function W(e){var t;switch(e.type){case"meta_sync":case"backups_secrets":{var n=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,M(e));t={armadillo:{payload:n.readByteArrayView(),version:1}};break}case"sync_key_share":case"sync_key_request":{var r=o("encodeProtobuf").encodeProtobuf(o("WAMultiDevice.pb").MultiDeviceSpec,B(e));t={multiDevice:{payload:r.readByteArrayView(),version:1}};break}default:e.type,o("WALogger").WARN(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),e.type),t={}}return{payload:{subProtocol:t}}}function q(e){return{backupId:e.backupId,epoch:e.epoch.map(U),mailboxRootKey:e.mailboxRootKey,obliviousValidationToken:e.obliviousValidationToken,serverDataId:e.serverDataId,tempOcmfClientState:e.tempOcmfClientState}}function U(e){var t;return e.status===o("WAAppData").EPOCH_STATUS_OPEN?t=o("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCH_STATUS.ES_OPEN:e.status===o("WAAppData").EPOCH_STATUS_CLOSE&&(t=o("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCH_STATUS.ES_CLOSE),{anonId:e.anonId,id:e.id,rootKey:e.rootKey,status:t}}function V(e){return{metadataSync:{actions:e.actions.map(function(e){return e.chatAction?{actionTimestamp:e.chatAction.ts,chatAction:H(e.chatAction)}:{messageAction:G(e.messageAction)}})}}}function H(e){var t=N(e.messageRange),n=e.chatJid;switch(e.type){case"chat_archive":return{chatArchive:{archived:e.archived,messageRange:t},chatId:n};case"chat_delete":return{chatDelete:{messageRange:t},chatId:n};default:return e.type,{chatId:n,chatRead:{messageRange:t,read:e.read}}}}function G(e){if(e.type==="delete_for_me"){var t=e.protocolMsgId.chat,n=o("WAJids").interpretAsGroupJid(t)!=null;return{key:{fromMe:o("WAJids").isAuthorMe(e.protocolMsgId.author),id:e.protocolMsgId.externalId,participant:!o("WAJids").isAuthorMe(e.protocolMsgId.author)&&n?e.protocolMsgId.author:void 0,remoteJid:t},messageDelete:{}}}else throw r("err")("No other available type")}function z(e){if(e.type!=="meta_sync")return[];var t=e.actions.map(function(e){var t,n=e.chatAction,r=e.messageAction;return(t=r==null?void 0:r.protocolMsgId.chat)!=null?t:n==null?void 0:n.chatJid}).filter(Boolean);return Array.from(new Set(t))}l.parseArmadilloAppData=x,l.parseMultiDeviceAppData=$,l.parseAppData=P,l.convertArmadilloAppData=M,l.convertMultiDeviceAppData=B,l.convertAppData=W,l.getChatJidForAppData=z}),98);
__d("WADbPersonalSenderKeyStatusTxns",["WASignalDB","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["groupJid","senderKeyTs"],s=["groupJid","senderKeyTs"],u={hasSenderKey:new Set,rotateSenderKey:!0,senderKeyId:null,senderKeyTs:o("WATimeUtils").castToUnixTime(0)},c=function(t){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",function(e){return e.stores.personalSenderKeyStatuses.bulkPut(t.map(function(e){return babelHelpers.extends({},u,{groupJid:e})}))},o("WASignalDB").signalOp("bulkPutNewPersonalSenderKeyStatus")).then(function(){})},d=function(t,n,r){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",async function(e){var o=await e.stores.personalSenderKeyStatuses.get(t);await e.stores.personalSenderKeyStatuses.bulkPut([babelHelpers.extends({},o||u,{groupJid:t,rotateSenderKey:!1,senderKeyId:n,senderKeyTs:r})])},o("WASignalDB").signalOp("markSenderKeyAsRotated"))},m=function(n){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",async function(t){var r=await t.stores.personalSenderKeyStatuses.get(n);if(r!=null){var o=r.groupJid,a=r.senderKeyTs,i=babelHelpers.objectWithoutPropertiesLoose(r,e);return babelHelpers.extends({},i,{ts:a})}var l=babelHelpers.extends({},u,{groupJid:n});await t.stores.personalSenderKeyStatuses.bulkPut([l]);var c=l.groupJid,d=l.senderKeyTs,m=babelHelpers.objectWithoutPropertiesLoose(l,s);return babelHelpers.extends({},m,{ts:d})},"Signal - getSenderKeyStatus")},p=function(t){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",async function(e){var n=await e.stores.personalSenderKeyStatuses.bulkGet(t);await e.stores.personalSenderKeyStatuses.bulkPut(n.filter(function(e){return e!=null}).map(function(e){return babelHelpers.extends({},e,{rotateSenderKey:!0})}))},o("WASignalDB").signalOp("bulkSetRotateSenderKeyToTrue"))},_=function(t){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",function(e){return e.stores.personalSenderKeyStatuses.bulkDelete(t)},o("WASignalDB").signalOp("deletePersonalSenderKeyStatus"))};l.bulkPutNewPersonalSenderKeyStatus=c,l.markSenderKeyAsRotated=d,l.getSenderKeyStatus=m,l.bulkSetRotateSenderKeyToTrue=p,l.deletePersonalSenderKeyStatus=_}),98);
__d("WACreateGroup",["WADbPersonalSenderKeyStatusTxns","WAGlobals"],(function(t,n,r,o,a,i,l){"use strict";var e=async function(t){await o("WAGlobals").getDependencies().createGroups(t),await o("WADbPersonalSenderKeyStatusTxns").bulkPutNewPersonalSenderKeyStatus(t.map(function(e){return e.groupToCreate.jid}))};l.createGroups=e}),98);
__d("WAGetPrekeyIdsInRange",["WASignalKeys"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e}function s(t,n){var r=[],a=t,i=n;if(a<=i)for(var l=a;l<=n;l++)r.push(o("WASignalKeys").castToPreKeyId(l));else{for(var s=a;s<o("WASignalKeys").PRE_KEY_NON_INCLUSIVE_UPPER_BORDER;s++)r.push(o("WASignalKeys").castToPreKeyId(s));for(var u=1;u<=i;u++)r.push(o("WASignalKeys").castToPreKeyId(u))}return r}l.getPrekeyIdsInRange=s}),98);
__d("WADeletePreKeyGenerationsApi",["WAGetPrekeyIdsInRange","WALogger","WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(n){return o("WASignalDB").getDb().runInTransaction(["prekey","prekeyGeneration"],"readwrite",async function(t){var r=await t.stores.prekeyGeneration.bulkGet(n),a=[];for(var i of r){if(i==null){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Attempting to delete non-existent prekey generation"])));continue}for(var l of o("WAGetPrekeyIdsInRange").getPrekeyIdsInRange(i.startingId,i.endingId))a.push(l)}await Promise.all([t.stores.prekeyGeneration.bulkDelete(n),t.stores.prekey.bulkDelete(a)])},o("WASignalDB").signalOp("deletePreKeyGenerations"))};l.deletePreKeyGenerations=s}),98);
__d("WAGetLastPreKeyGenerationIdApi",["WADbSignal","WASignalDB","err"],(function(t,n,r,o,a,i,l){"use strict";var e=async function(){var e=await o("WASignalDB").getDb().runInTransaction(["meta"],"readonly",function(e){return Promise.all([e.stores.meta.get(o("WADbSignal").MetaKeysEnum.lastPrekeyId).then(function(e){return e==null?void 0:e.value.lastPrekeyId}),e.stores.meta.get(o("WADbSignal").MetaKeysEnum.lastPrekeyGenerationId).then(function(e){return e==null?void 0:e.value.lastPrekeyGenerationId})])},o("WASignalDB").signalOp("getLastPreKeyGenerationId")),t=e[0],n=e[1];if(t==null&&n!=null||t!=null&&n==null)throw r("err")("Last prekey id and Last prekey generation id should both be non-null");return t!=null&&n!=null?{lastGenerationId:n,lastPreKeyId:t}:null};l.getLastPreKeyGenerationId=e}),98);
__d("WAGetPreKeyGenerationsTimestampsApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return o("WASignalDB").getDb().runInTransaction(["prekeyGeneration"],"readonly",async function(e){var t=await e.stores.prekeyGeneration.readAll();return t.map(function(e){return{id:e.generationId,timestamp:e.createdTs}})},o("WASignalDB").signalOp("getPreKeyGenerationsTimestamps"))};l.getPreKeyGenerationsTimestamps=e}),98);
__d("WALoadICDCApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["contacts"],"readonly",function(e){return e.stores.contacts.bulkGet([t]).then(function(e){var t,n=e.filter(Boolean).length>0?e[0]:null;return(t=n==null?void 0:n.icdcInfo)!=null?t:null})},o("WASignalDB").signalOp("loadICDC"))};l.loadICDC=e}),98);
__d("WALoadIdentitiesApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["identity"],"readonly",async function(e){var n=await e.stores.identity.readIndex("userJid",[t]);return new Map(n.filter(Boolean).map(function(e){return[e.deviceJid,e.identity]}))},o("WASignalDB").signalOp("loadIdentities"))},s=function(t){return o("WASignalDB").getDb().runInTransaction(["identity"],"readonly",async function(e){var n=await Promise.all(t.map(function(t){return e.stores.identity.readIndex("userJid",[t])})),r=new Map;for(var o of n)for(var a of o)if(a!=null){var i=r.get(a.userJid);i==null&&(i=new Map),i.set(a.deviceJid,a.identity),r.set(a.userJid,i)}return r},o("WASignalDB").signalOp("bulkLoadIdentities"))};l.loadIdentities=e,l.bulkLoadIdentities=s}),98);
__d("WALoadLastSyncTsApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["contacts"],"readonly",function(e){return e.stores.contacts.bulkGet([t]).then(function(e){var t,n=e.filter(Boolean).length>0?e[0]:null;return(t=n==null?void 0:n.lastSyncTs)!=null?t:null})},o("WASignalDB").signalOp("loadLastSyncTs"))};l.loadLastSyncTs=e}),98);
__d("WADbMetaTxns",["WADbSignal","WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.meta.bulkGet([o("WADbSignal").MetaKeysEnum.lastSignedPrekeyId,o("WADbSignal").MetaKeysEnum.identityKeyPair]).then(function(e){var t=e[0],n=e[1],r=t==null?void 0:t.value.lastSignedPrekeyId,o=n==null?void 0:n.value.identityKeyPair;return{identityPair:o,keyId:r}})}var s=function(t){return o("WASignalDB").getDb().runInTransaction(["meta"],"readwrite",async function(e){return await e.stores.meta.bulkPut([{key:o("WADbSignal").MetaKeysEnum.cat,value:{cat:t}}]),t},o("WASignalDB").signalOp("saveCAT"))};l.maybeGetLastSignedPrekeyIdAndIdentity=e,l.saveCAT=s}),98);
__d("WADbSignedPrekeyTxns",["WADbMetaTxns","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=await o("WADbMetaTxns").maybeGetLastSignedPrekeyIdAndIdentity(e),n=t.identityPair,r=t.keyId;if(r==null)return n==null?o("WAResultOrError").makeError("missing-last-signed-prekey-id-and-registration"):o("WAResultOrError").makeError("missing-last-signed-prekey-id");var a=await e.signedPrekey.get(r);return a==null?o("WAResultOrError").makeError("missing-last-signed-prekey"):o("WAResultOrError").makeResult(a.encoded)}l.getLatestSignedPreKey=e}),98);
__d("WALoadLatestSignedPreKeyApi",["WADbSignedPrekeyTxns","WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return o("WASignalDB").getDb().runInTransaction(["meta","signedPrekey"],"readonly",function(e){return o("WADbSignedPrekeyTxns").getLatestSignedPreKey(e.stores)},o("WASignalDB").signalOp("loadLatestSignedPreKey"))};l.loadLatestSignedPreKey=e}),98);
__d("WALoadOneTimePreKeyApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["prekey"],"readonly",function(e){return e.stores.prekey.get(t).then(function(e){return e==null?void 0:e.encoded})},o("WASignalDB").signalOp("loadOneTimePreKey"))};l.loadOneTimePreKey=e}),98);
__d("WADbPrekeyTxns",["WAGetPrekeyIdsInRange","err"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t){var n=await e.prekeyGeneration.get(t);if(n==null)throw r("err")("Expected a prekey generation row");var a=o("WAGetPrekeyIdsInRange").getPrekeyIdsInRange(n.startingId,n.endingId),i=await e.prekey.bulkGet(a);return i.filter(Boolean).map(function(e){return e.encoded})}l.getPrekeysForGeneration=e}),98);
__d("WALoadPreKeysApi",["WADbPrekeyTxns","WADbSignal","WADbSignedPrekeyTxns","WALoggerTag","WASignalDB","WASignalSignatures","WATagsLogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS([r("WALoggerTag").SignedPrekey]),d=function(n){return o("WASignalDB").getDb().runInTransaction(["identity","meta","prekey","prekeyGeneration","signedPrekey"],"readonly",async function(t){var a=await o("WADbSignedPrekeyTxns").getLatestSignedPreKey(t.stores);if(!a.success){var i;throw c.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to get latest signed prekey"]))),(i=a.error)!=null?i:r("err")("Failed to get latest signed prekey")}var l=o("WASignalSignatures").deserializeSignedPreKey(a.value);if(l==null)throw c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to deserialize signed prekey"]))),r("err")("Failed to deserialize signed prekey");var d=n!=null?n:await t.stores.meta.get(o("WADbSignal").MetaKeysEnum.lastPrekeyGenerationId).then(function(e){return e==null?void 0:e.value.lastPrekeyGenerationId});if(d==null)throw c.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["No last prekey generation id"]))),r("err")("No last prekey generation id");return o("WADbPrekeyTxns").getPrekeysForGeneration(t.stores,d).then(function(e){return{preKeys:e,signedPreKey:l}})},o("WASignalDB").signalOp("loadPreKeys"))};l.loadPreKeys=d}),98);
__d("WALoadSenderKeySessionApi",["WACryptoManager","WADbSignal","WAJids","WAResultOrError","WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n){var e=o("WAJids").extractUserJid(n),r=o("WAJids").extractDeviceId(n),a=o("WADbSignal").buildSenderKeySessionId(t,e,r);return o("WASignalDB").getDb().runInTransaction(["senderKeySessions"],"readonly",async function(e){var t=await e.stores.senderKeySessions.get(a);if(t==null)return o("WAResultOrError").makeError("errLoadSenderKeySession");var n=o("WACryptoManager").decodeSenderKeySession(t.record);return o("WAResultOrError").makeResult(n)},o("WASignalDB").signalOp("loadSenderKeySession"))};l.loadSenderKeySession=e}),98);
__d("WALoadSignedPreKeyApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["signedPrekey"],"readonly",function(e){return e.stores.signedPrekey.get(t).then(function(e){return e==null?void 0:e.encoded})},o("WASignalDB").signalOp("loadSignedPreKey"))};l.loadSignedPreKey=e}),98);
__d("WASaveOneTimePreKeyApi",["WADbSignal","WAResultOrError","WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["meta","prekey"],"readwrite",async function(e){var n=await e.stores.meta.get(o("WADbSignal").MetaKeysEnum.lastPrekeyId),r=n==null?void 0:n.value.lastPrekeyId;return r==null?o("WAResultOrError").makeError("missing_last_prekey"):(await Promise.all([e.stores.prekey.bulkPut([babelHelpers.extends({},t,{isDeleted:!1})]),e.stores.meta.bulkPut([{key:o("WADbSignal").MetaKeysEnum.lastPrekeyId,value:{lastPrekeyId:t.keyId}}])]),o("WAResultOrError").makeResult())},o("WASignalDB").signalOp("saveOneTimePreKey"))};l.saveOneTimePreKey=e}),98);
__d("WASavePreKeysGenerationApi",["WACryptoManager","WADbSignal","WAResultOrError","WASignalDB","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";var e=async function(t){if(t.length===0)throw r("err")("Keys provided to savePreKeysGeneration cannot be empty");var e=await o("WASignalDB").getDb().runInTransaction(["meta","prekey","prekeyGeneration"],"readwrite",async function(e){var n,r=await e.stores.meta.get(o("WADbSignal").MetaKeysEnum.lastPrekeyGenerationId),a=o("WACryptoManager").castToPreKeyGenerationId(((n=r==null?void 0:r.value.lastPrekeyGenerationId)!=null?n:0)+1),i=t[0].keyId,l=t[t.length-1].keyId,s=t.map(function(e){return babelHelpers.extends({},e,{isDeleted:!1})});return await Promise.all([e.stores.prekey.bulkPut(s),e.stores.meta.bulkPut([{key:o("WADbSignal").MetaKeysEnum.lastPrekeyId,value:{lastPrekeyId:l}},{key:o("WADbSignal").MetaKeysEnum.lastPrekeyGenerationId,value:{lastPrekeyGenerationId:a}}]),e.stores.prekeyGeneration.bulkPut([{createdTs:o("WATimeUtils").unixTime(),endingId:l,generationId:a,startingId:i}])]),o("WAResultOrError").makeResult(a)},o("WASignalDB").signalOp("savePreKeysGeneration"));return e};l.savePreKeysGeneration=e}),98);
__d("WASaveSignedPreKeyIfNewApi",["WADbSignal","WASignalDB","WASignalSignatures"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n){return o("WASignalDB").getDb().runInTransaction(["meta","signedPrekey"],"readwrite",async function(e){var r=await e.stores.signedPrekey.get(t);if(r!=null){var a=o("WASignalSignatures").deserializeSignedPreKey(r.encoded);if(a!=null)return{key:a,type:"duplicate"}}return await Promise.all([e.stores.signedPrekey.bulkPut([{encoded:n,keyId:t}]),e.stores.meta.bulkPut([{key:o("WADbSignal").MetaKeysEnum.lastSignedPrekeyId,value:{lastSignedPrekeyId:t}}])]),{type:"success"}},o("WASignalDB").signalOp("saveSignedPreKeyIfNew"))};l.saveSignedPreKeyIfNew=e}),98);
__d("WASessionApi",["WACryptoManager","WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().store("session").get(t).then(function(e){return e==null?null:o("WACryptoManager").decodeSession(e.session)})},s=function(t){return o("WASignalDB").getDb().store("session").bulkGet(t).then(u)};function u(e){var t=new Map;for(var n of e)if(n!=null){var r=o("WACryptoManager").decodeSession(n.session);t.set(n.id,r)}return t}l.loadSession=e,l.bulkLoadSession=s}),98);
__d("WACryptoDbCallbacks",["WABulkSaveSignalDataApi","WADeletePreKeyGenerationsApi","WAGetLastPreKeyGenerationIdApi","WAGetPreKeyGenerationsTimestampsApi","WALoadICDCApi","WALoadIdentitiesApi","WALoadLastSyncTsApi","WALoadLatestSignedPreKeyApi","WALoadOneTimePreKeyApi","WALoadPreKeysApi","WALoadSenderKeySessionApi","WALoadSignedPreKeyApi","WASaveOneTimePreKeyApi","WASavePreKeysGenerationApi","WASaveSignedPreKeyIfNewApi","WASessionApi"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return{bulkLoadIdentities:o("WALoadIdentitiesApi").bulkLoadIdentities,bulkSaveSignalData:o("WABulkSaveSignalDataApi").bulkSaveSignalData,deletePreKeyGenerations:o("WADeletePreKeyGenerationsApi").deletePreKeyGenerations,getLastPreKeyGenerationId:o("WAGetLastPreKeyGenerationIdApi").getLastPreKeyGenerationId,getPreKeyGenerationsTimestamps:o("WAGetPreKeyGenerationsTimestampsApi").getPreKeyGenerationsTimestamps,loadICDC:o("WALoadICDCApi").loadICDC,loadIdentities:o("WALoadIdentitiesApi").loadIdentities,loadLastSyncTs:o("WALoadLastSyncTsApi").loadLastSyncTs,loadLatestSignedPreKey:o("WALoadLatestSignedPreKeyApi").loadLatestSignedPreKey,loadOneTimePreKey:o("WALoadOneTimePreKeyApi").loadOneTimePreKey,loadPreKeys:o("WALoadPreKeysApi").loadPreKeys,loadSenderKeySession:o("WALoadSenderKeySessionApi").loadSenderKeySession,loadSession:o("WASessionApi").loadSession,loadSessions:o("WASessionApi").bulkLoadSession,loadSignedPreKey:o("WALoadSignedPreKeyApi").loadSignedPreKey,saveOneTimePreKey:o("WASaveOneTimePreKeyApi").saveOneTimePreKey,savePreKeysGeneration:o("WASavePreKeysGenerationApi").savePreKeysGeneration,saveSignedPreKeyIfNew:o("WASaveSignedPreKeyIfNewApi").saveSignedPreKeyIfNew}};l.getCryptoDbCallbacks=e}),98);
__d("WAMPSFlushable",["MpsTypes","WebMps","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(){this.$1=[],this.$2=new Map,this.$3=new Set}var t=e.prototype;return t.enqueue=function(t,n,r){t!=null&&(this.$1.push(t),this.$2.set(t.messageId,n),this.$3.add(r))},t.flush=async function(t,n,a,i){if(this.$1.length!==0){var e=this.$1,l=Array.from(this.$3).join(", "),s=this.$2;this.$1=[],this.$2=new Map,this.$3=new Set;try{var u=await o("WebMps").mps().saveNewMessages(e.map(function(e){return{directive:null,message:e,insertionSource:o("MpsTypes").InsertionSource.Receive}}),{source:l});s.forEach(function(e,t){e(u.get(t))})}catch(e){var c=r("getErrorSafe")(e);s.forEach(function(e){e(c)})}}},e})(),s=new e;l.MPSFlushable=e,l.mpsFlushable=s}),98);
__d("WASignalEntityStoreV2",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum").Mirrored(["NOT_PERSISTED","PERSIST_IN_PROGRESS","PERSISTED"]),l=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.TEST_ONLY_LOAD_FROM_MEMORY=function(t){return this.$2(t)},n.$2=function(t){var e=this.$1.get(t);return e!=null?{entity:e.entity,deleted:e.deleted}:null},n.load=async function(t,n){var e=this.$2(t);if(e!=null&&e.deleted)return null;if(e!=null&&e.entity!=null)return e.entity;var r=await n(t);return this.$3(t,r),r},n.bulkLoad=async function(t,n){var e=[],r=new Map;for(var o of t){var a=this.$2(o);if(a==null){e.push(o);continue}a.deleted||(a.entity!=null?r.set(o,a.entity):e.push(o))}var i=await n(e);for(var l of i.entries()){var s=l[0],u=l[1];r.set(s,u),this.$3(s,u)}return r},n.$3=function(n,r){this.$1.set(n,{entity:r,status:e.PERSISTED,deleted:!1})},n.store=function(n,r){this.$1.set(n,{entity:r,status:e.NOT_PERSISTED,deleted:!1})},n.remove=function(n){this.$1.set(n,{entity:null,status:e.NOT_PERSISTED,deleted:!0})},n.pureSnapshot=function(){var t=[],n=Array.from(this.$1.entries()).filter(function(t){var n=t[0],r=t[1];return r.status===e.NOT_PERSISTED}).filter(function(e){var n=e[0],r=e[1];return r.deleted&&t.push({id:n}),!r.deleted}).filter(function(e){var t=e[0],n=e[1];return n.entity!=null}).map(function(e){var t=e[0],n=e[1];return{id:t,cachedEntity:n.entity}});return{update:n,remove:t}},n.snapshot=function(){var t=this,n=this.pureSnapshot();return n.remove.forEach(function(n){var r=n.id,o=t.$1.get(r);o&&(o.status=e.PERSIST_IN_PROGRESS)}),n.update.forEach(function(n){var r=n.id,o=t.$1.get(r);o&&(o.status=e.PERSIST_IN_PROGRESS)}),n},n.markSnapshotAsCommitted=function(){this.$1.forEach(function(t){t.status===e.PERSIST_IN_PROGRESS&&(t.status=e.PERSISTED)})},n.markSnapshotAsFailed=function(){this.$1.forEach(function(t){t.status===e.PERSIST_IN_PROGRESS&&(t.status=e.NOT_PERSISTED)})},n.clear=function(){this.$1=new Map},t})();i.PersistStatus=e,i.SignalEntityStore=l}),66);
__d("WASignalIdentityStore",["WAJids","WALogger","WASignalEntityStoreV2"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function t(){this.$1=new Map,this.$2=new(o("WASignalEntityStoreV2")).SignalEntityStore}var n=t.prototype;return n.bulkLoadIdentities=async function(t){var e=this,n=async function(){var t=r[0],n=r[1];await e.loadIdentitiesByUser(t,function(){return Promise.resolve(n)})};for(var r of t)await n();return t},n.loadIdentitiesByUser=async function(n,r){var t=this.$1.get(n);if(t==null){var a=this.$3(n,await r(n)),i=Array.from(a.keys());return this.$1.set(n,new Set(i)),this.$2.bulkLoad(i,function(){return Promise.resolve(a)})}else return this.$2.bulkLoad(Array.from(t),function(t){return t.length>0&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[WASignalIdentityStore] This should never happen."]))),Promise.resolve(new Map)})},n.$3=function(t,n){var e=new Map(n),r=this.$2.pureSnapshot(),a=r.remove,i=r.update;for(var l of a){var s=l.id;e.delete(s)}for(var u of i){var c=u.cachedEntity,d=u.id;c!=null&&o("WAJids").extractUserJid(d)===t&&e.set(d,c)}return e},n.store=function(t,n){this.$2.store(t,n);var e=o("WAJids").extractUserJid(t),r=this.$1.get(e);r!=null&&r.add(t)},n.remove=function(t){this.$2.remove(t);var e=o("WAJids").extractUserJid(t),n=this.$1.get(e);n!=null&&n.delete(t)},n.clear=function(){this.$2.clear(),this.$1=new Map},n.load=function(t,n){return this.$2.load(t,n)},n.bulkLoad=function(t,n){return this.$2.bulkLoad(t,n)},n.snapshot=function(){return this.$2.snapshot()},n.pureSnapshot=function(){return this.pureSnapshot()},n.markSnapshotAsCommitted=function(){this.$2.markSnapshotAsCommitted()},n.markSnapshotAsFailed=function(){this.$2.markSnapshotAsFailed()},t})();l.SignalIdentityStore=s}),98);
__d("WAInMemorySignalStore",["MAWMpsGating","WAArmadilloTransportEvent.pb","WABuildMpsPayload","WACryptoManager","WACryptoUtils","WAGlobals","WAIdentityUtils","WAJids","WAMPSFlushable","WAProtocolQueue","WAResultOrError","WASignalEntityStoreV2","WASignalIdentityStore","WATagsLogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C=o("WATagsLogger").TAGS(["CryptoManager","InMemorySignalStore"]),b=(function(){function t(e,t){var n=this,r;this.loadSession=function(e,t){return n.$1.load(e,function(e){return n.$9.loadSession(e,t)})},this.loadSessions=function(e){return n.$1.bulkLoad(e,function(e){return n.$9.loadSessions(e).then(function(e){return new Map(Array.from(e.entries()).map(function(e){return[e[0],e[1]]}))})}).then(function(e){return new Map(Array.from(e.entries()).map(function(e){return[e[0],e[1]]}))})},this.loadSignedPreKey=function(e){return n.$7.load(e,function(){return n.$9.loadSignedPreKey(e)})},this.bulkLoadIdentities=function(e){var t=new Map;return Promise.all(e.map(function(e){return n.loadIdentities(e).then(function(n){t.set(e,n)})})).then(function(){return t})},this.loadIdentities=function(e){return n.$5.loadIdentitiesByUser(e,function(){return n.$9.loadIdentities(e)})},this.saveIdentity=function(e,t){return Promise.resolve(n.storeIdentity(e,t))},this.loadOneTimePreKey=function(e){return n.$6.load(e,function(){return n.$9.loadOneTimePreKey(e)})},this.saveSenderKeySession=function(e,t,r){return n.storeSenderKeySession(e,t,r),Promise.resolve()},this.saveSignedPreKeyIfNew=function(e,t){return n.$9.saveSignedPreKeyIfNew(e,t)},this.loadSenderKeySession=async function(e,t){var r=await n.$8.load(o("WACryptoManager").encodeSenderKey(e,t),async function(){var r=await n.$9.loadSenderKeySession(e,t);return r.success?r.value:null});return r==null?o("WAResultOrError").makeError("errLoadSenderKeySession"):o("WAResultOrError").makeResult(r)},this.handleNewSession=function(e,t,r,a,i){return n.storeSession(e,t),r!=null&&n.storeIdentity(e,r),a!=null&&n.removeOneTimePreKey(a),Promise.resolve(o("WAResultOrError").makeResult())},this.saveICDC=function(e,t){return n.$3.store(e,t),Promise.resolve()},this.loadICDC=function(e){return n.$3.load(e,function(){return n.$9.loadICDC(e)})},this.saveLastSyncTs=function(e,t){return n.$4.store(e,t),Promise.resolve()},this.loadLastSyncTs=function(e){return n.$4.load(e,function(){return n.$9.loadLastSyncTs(e)})},this.saveDhash=function(e,t){return n.$2.store(e,t),Promise.resolve()},this.getLastPreKeyGenerationId=function(){return n.$9.getLastPreKeyGenerationId()},this.savePreKeysGeneration=function(e){return n.$9.savePreKeysGeneration(e)},this.getPreKeyGenerationsTimestamps=function(){return n.$9.getPreKeyGenerationsTimestamps()},this.deletePreKeyGenerations=function(e){return n.$9.deletePreKeyGenerations(e)},this.saveOneTimePreKey=function(e){return n.$9.saveOneTimePreKey(e)},this.loadPreKeys=function(e){return n.$9.loadPreKeys(e)},this.loadLatestSignedPreKey=function(){return n.$9.loadLatestSignedPreKey()},this.$9=e,this.$10=t,this.$5=new(o("WASignalIdentityStore")).SignalIdentityStore,this.$1=new(r=o("WASignalEntityStoreV2")).SignalEntityStore,this.$2=new r.SignalEntityStore,this.$3=new r.SignalEntityStore,this.$4=new r.SignalEntityStore,this.$6=new r.SignalEntityStore,this.$7=new r.SignalEntityStore,this.$8=new r.SignalEntityStore}var n=t.prototype;return n.storeSession=function(t,n){this.$1.store(t,n)},n.storeIdentity=function(t,n){n&&this.$5.store(t,n)},n.removeOneTimePreKey=function(t){this.$6.remove(t)},n.storeSenderKeySession=function(t,n,r){this.$8.store(o("WACryptoManager").encodeSenderKey(t,n),r)},n.updateUserDevicesInfo=function(n){var t=this;return Promise.all(n.map(async function(n){var r=await t.loadIdentities(n.jid),a=n.devices,i=n.dhash,l=n.icdcInfo,_=n.jid,f=n.lastSyncTs,g=n.notificationTs;C.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Update user devices: userJid: ","; new identities: ","; previous identities: ","}"])),_,a.map(function(e){var t=e.id;return o("WAJids").toDeviceJid(n.jid,t)}).join(","),Array.from(r.keys()).join(","));var h=new Set(r.keys()),y=[],b=[];for(var v of a){var S=v.id,R=v.identity,L=v.model,E=v.platform,k=o("WAJids").toDeviceJid(n.jid,S),I=r.get(k);if(o("WAGlobals").getMyDeviceJid()===k){var T=o("WACryptoUtils").uint8ArraysEqual(o("WAIdentityUtils").removeKeyTypeIfNeeded(t.$10.staticKeyPair.publicKey),o("WAIdentityUtils").removeKeyTypeIfNeeded(R));T||C.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Receiving an identity for my device but it is different from original one"])))}if(h.delete(k),I==null)b.push({instruction:"identityAdded",jid:o("WAJids").extractUserJid(k),type:"instruction",device:k,identity:R,model:L,platform:E,notificationTs:g,priority:o("WAProtocolQueue").WAProtocolQueuePriorityLow});else if(!o("WACryptoUtils").uint8ArraysEqual(I,R)){if(o("WAJids").extractUserJid(k)!==_){C.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Device notification of one user cannot remove session the other one"])));continue}y.push(k),C.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Removing session dur to identity mismatch: ",""])),k),b.push({instruction:"identityChanged",jid:o("WAJids").extractUserJid(k),type:"instruction",device:k,identity:R,model:L,platform:E,notificationTs:g,priority:o("WAProtocolQueue").WAProtocolQueuePriorityLow})}}var D=[];for(var x of h){if(o("WAJids").extractUserJid(x)!==_){C.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Device notification of one user cannot remove identity the other one "])));continue}D.push(x),o("WAGlobals").getMyDeviceJid()===x&&C.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Removing my device identity. This should not happen"]))),C.DEV(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Removing old identity: ",""])),x),b.push({instruction:"identityRemoved",jid:o("WAJids").extractUserJid(x),type:"instruction",device:x,notificationTs:g,priority:o("WAProtocolQueue").WAProtocolQueuePriorityLow})}return Promise.all([i!=null?t.saveDhash(_,i):Promise.resolve(),f!=null?t.saveLastSyncTs(_,f):Promise.resolve(),l!=null?t.saveICDC(_,l):Promise.resolve()].concat(Array.from(D).map(function(e){return t.deleteIdentity(e)}),[D.concat(y).map(function(e){return t.$11(e)})],a.map(function(e){var n=e.id,r=e.identity;return t.saveIdentity(o("WAJids").toDeviceJid(_,n),r)}))).then(function(){return b})})).then(function(e){var t=e.flat();t.forEach(function(e){var t,n;switch(e.instruction){case"identityAdded":n=o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.ADDED;break;case"identityChanged":n=o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED;break;case"identityRemoved":n=o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REMOVED;break;default:return}var r=o("WAGlobals").getDependencies().generateExternalId();o("WAMPSFlushable").mpsFlushable.enqueue(o("WABuildMpsPayload").buildMpsDeviceChangeAdminMessage(e.jid,(t=e.notificationTs)!=null?t:o("WATimeUtils").unixTime(),r,n,e.platform,e.model),function(e){if(e!=null){C.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to save device change admin message: ",""])),e);return}},"handle_device_change"),o("MAWMpsGating").isFullMpsEnabled()||o("WAProtocolQueue").pqFlushable.enqueue(e)}),o("MAWMpsGating").isFullMpsEnabled()&&o("WAGlobals").getDependencies().recordDeviceChangeHistory(t.map(function(e){var t,n,r;if(e.device==null)return null;var a=e.device;switch(e.instruction){case"identityAdded":return{jid:e.jid,deviceChangeType:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.ADDED,platform:e.platform,model:e.model,device:a,identity:e.identity,ts:(t=e.notificationTs)!=null?t:o("WATimeUtils").unixTime()};case"identityChanged":return{jid:e.jid,deviceChangeType:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED,platform:e.platform,model:e.model,device:a,identity:e.identity,ts:(n=e.notificationTs)!=null?n:o("WATimeUtils").unixTime()};case"identityRemoved":return{jid:e.jid,deviceChangeType:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REMOVED,device:a,ts:(r=e.notificationTs)!=null?r:o("WATimeUtils").unixTime()};default:return null}}).filter(Boolean)).catch(function(e){C.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Failed to record device change history: ",""])),e)})}).then(function(){})},n.savePendingToDatabase=function(){var e=this,t=this.$12();return t==null?Promise.resolve():(C.DEV(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Snapshot: ",""])),t),C.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Snapshot save: start"]))),this.$9.bulkSaveSignalData(t).then(function(){C.LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Snapshot save: end"]))),e.$13()},function(t){return e.$14(),Promise.reject(t)}))},n.clear=function(){this.$1.clear(),this.$5.clear(),this.$6.clear(),this.$7.clear(),this.$8.clear(),this.$2.clear(),this.$3.clear()},n.deleteIdentity=function(t){return this.$5.remove(t),Promise.resolve()},n.$11=function(t){return this.$1.remove(t),Promise.resolve()},n.$13=function(){this.$1.markSnapshotAsCommitted(),this.$2.markSnapshotAsCommitted(),this.$3.markSnapshotAsCommitted(),this.$4.markSnapshotAsCommitted(),this.$5.markSnapshotAsCommitted(),this.$6.markSnapshotAsCommitted(),this.$7.markSnapshotAsCommitted(),this.$8.markSnapshotAsCommitted()},n.$14=function(){this.$1.markSnapshotAsFailed(),this.$2.markSnapshotAsFailed(),this.$3.markSnapshotAsFailed(),this.$4.markSnapshotAsFailed(),this.$5.markSnapshotAsFailed(),this.$6.markSnapshotAsFailed(),this.$7.markSnapshotAsFailed(),this.$8.markSnapshotAsFailed()},n.$12=function(){var e=this.$1.snapshot(),t=[],n=e.remove.map(function(e){return e.id});e.update.forEach(function(e){var n=e.cachedEntity,r=e.id;n!=null&&t.push({id:r,updated:n})});var r=[];this.$8.snapshot().update.forEach(function(e){var t=o("WACryptoManager").decodeSenderKey(e.id),n=t.deviceId,a=t.groupId;e.cachedEntity!=null&&a&&n&&r.push({groupId:a,author:n,updated:e.cachedEntity})});var a=this.$5.snapshot(),i=a.remove.map(function(e){return e.id}),l=[];a.update.forEach(function(e){var t=e.cachedEntity,n=e.id;t!=null&&l.push({id:n,identity:t})});var s=this.$6.snapshot().remove,u=this.$2.snapshot(),c=[];for(var d of u.update){var m=d.cachedEntity,p=d.id;m!=null&&c.push({id:p,dhash:m})}var _=this.$4.snapshot(),f=[];for(var g of _.update){var h=g.cachedEntity,y=g.id;h!=null&&f.push({id:y,lastSyncTs:h})}var C=this.$3.snapshot(),b=[];for(var v of C.update){var S=v.cachedEntity,R=v.id;S!=null&&b.push({id:R,icdc:S})}return t.length===0&&n.length===0&&l.length===0&&r.length===0&&s.length===0&&b.length===0&&c.length===0&&f.length===0&&i.length===0?null:{dhashUpdate:c,icdcUpdate:b,identityRemove:i,identityUpdate:l,preKeyRemove:s,senderKeySessionUpdate:r,sessionRemove:n,sessionUpdate:t,lastSyncTsUpdate:f}},n.warmCache=async function(t){var e=this,n=t.map(o("WAJids").interpretAsUserJid).filter(Boolean),r=await this.$9.bulkLoadIdentities(n).then(function(t){return e.$5.bulkLoadIdentities(t)}),a=Array.from(r.values()).reduce(function(e,t){return e.concat(Array.from(t.keys()))},[]);await this.loadSessions(a)},t})();l.InMemorySignalStoreImpl=b}),98);
__d("WARequestKeysBatcher",["WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e={delayMs:50,maxSize:100};function s(t,n){var r=n===void 0?e:n,a=r.delayMs,i=r.maxSize,l=null;function s(e){return l&&l.args===e&&(l=null),t(e)}return function(e){if(l!=null)l.args.push(e);else{var t=[e],n=new(o("WAResolvable")).Resolvable,r=n.promise.then(s),u=function(){return void n.resolve(t)},c=setTimeout(u,a);l={args:t,batchPromise:r,run:u,timer:c}}var d=l,m=d.args,p=d.batchPromise,_=m.length-1;if(m.length>=i){var f;clearTimeout((f=l)==null?void 0:f.timer),l.run(),l=null}return p.then(function(e){return e[_]})}}l.makeSimpleBatcher=s}),98);
__d("WARequestKeys",["WABulkRequestKeys","WAPromiseManagement","WARequestKeysBatcher","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WARequestKeysBatcher").makeSimpleBatcher(async function(e){var t=await o("WABulkRequestKeys").bulkRequestKeys(e);return t.success===!1?e.map(function(){return t}):e.map(function(e){var n=t.value.get(e);return n?o("WAResultOrError").makeResult(n):o("WAResultOrError").makeError("errRequestKeysNoKeys")})}),s=o("WAPromiseManagement").cacheWhilePending(function(e){return e},e);l.requestKeys=s}),98);
__d("WACryptoManagerUtils",["WABulkRequestKeys","WACryptoDbCallbacks","WACryptoManager","WAGlobals","WAHandleFailureUtils","WAInMemorySignalStore","WALogger","WALoggerTag","WARequestKeys","WAResultOrError","WASignalKeys","WASignalSignatures","WATagsLogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS([r("WALoggerTag").SignedPrekey]);function f(e){var t=new(o("WAInMemorySignalStore")).InMemorySignalStoreImpl(o("WACryptoDbCallbacks").getCryptoDbCallbacks(),e),n=g();return{manager:o("WACryptoManager").initCryptoManager({regInfo:e,storage:t,network:n}),storage:t}}function g(){return{requestKeys:o("WARequestKeys").requestKeys,bulkRequestKeys:o("WABulkRequestKeys").bulkRequestKeys}}function h(t,n,r,a){var i=null;return o("WACryptoManager").decryptContent(a.cryptoManager,n,{ciphertext:r,type:t},function(e,t){return i={plaintext:e,remoteIdentity:t},Promise.resolve()}).then(function(e){return e.success?o("WAResultOrError").makeResult(i):e}).catch(function(t){throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["DecryptMsg runtime error: ",""])),t),t})}function y(e,t,n,r){var a=null;return o("WACryptoManager").decryptGroupContent(r.cryptoManager,e,t,n,function(e){return a={plaintext:e},Promise.resolve()}).then(function(e){return e.success?o("WAResultOrError").makeResult(a):e}).catch(function(e){throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["DecryptMsg runtime error: ",""])),e),e})}function C(e,t){return o("WACryptoManager").getParticipantInfo(t,e)}function b(e){return e.storage.getPreKeyGenerationsTimestamps()}function v(e,t){return t.storage.deletePreKeyGenerations(e)}function S(e,t,n,r){return o("WACryptoManager").saveSenderKeySession(r.cryptoManager,e,t,n)}async function R(e){var t=await e.storage.loadLatestSignedPreKey();if(t.success===!1)throw _.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing signed prekey: ",", triggering reregistration"])),t.error),await o("WAHandleFailureUtils").reregisterPhone(),r("err")("No signed prekey: "+t.error);var n=o("WASignalSignatures").deserializeSignedPreKey(t.value);if(n==null)throw _.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Cannot deserialize signed prekey"]))),r("err")("Cannot deserialize signed prekey");var a=await o("WACryptoManager").generateOneTimePreKey(e);if(a==null)throw o("WATagsLogger").TAGS([r("WALoggerTag").OneTimePrekey]).ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Cannot generate one time prekey"]))),r("err")("Cannot generate one time prekey");var i=e.regInfo,l=i.regId,s=i.staticKeyPair;return Promise.resolve({regId:l,keyType:o("WASignalKeys").KEY_TYPE,publicKey:s.publicKey,signedPreKey:n,preKey:a})}function L(e,t,n){return o("WACryptoManager").encryptGroupContent(n.cryptoManager,e,o("WAGlobals").getMyDeviceJid(),t).catch(function(e){return o("WATagsLogger").TAGS(["EncryptGroupContent"]).ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Runtime excpetion when encrypting group content: ",""])),e),o("WAResultOrError").makeError("runtime-exception")})}function E(e,t){return o("WACryptoManager").bulkEncryptContent(t.cryptoManager,e)}function k(e,t,n,r,a){return o("WACryptoManager").encryptContent(n.cryptoManager,e,t,r||o("WACryptoManager").DEFAULT_SESSION_REQUEST,a)}function I(e,t){return o("WACryptoManager").bulkEncryptContent(t.cryptoManager,e).then(function(e){return e.success===!1?(o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[SendMessage] Fail encrypt messages"]))),new Map):e.value})}async function T(e,t){var n=await o("WACryptoManager").ensureSessionsExists(t.cryptoManager,e);await Promise.all(Array.from(n.entries()).map(function(e){var n=e[0],r=e[1];return t.cryptoManager.storage.handleNewSession(n,r,r.remote.pubKey)}))}l.createCryptoManager=f,l.decryptMsg=h,l.decryptGroupMsg=y,l.getParticipantInfo=C,l.getPreKeyGenerationsTimestamps=b,l.deletePreKeyGenerations=v,l.saveSenderKeySession=S,l.getSignalInfoForRetry=R,l.encryptGroupContentWithMetrics=L,l.bulkEncryptMsgWithMetrics=E,l.encryptMsgWithMetrics=k,l.bulkEncrypt=I,l.bulkPreEstablishOutgoingSession=T}),98);
__d("WADbRegistrationApi",["WADbSignal","WAJids","WALogger","WASignalDB","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(t,n){return o("WASignalDB").getDb().runInTransaction(["contacts"],"readwrite",async function(e){var r=await e.stores.contacts.get(t);return r!=null?e.stores.contacts.bulkPut([babelHelpers.extends({},r,{icdcInfo:n})]):e.stores.contacts.bulkPut([{contactJid:t,dhash:null,icdcInfo:n}])},o("WASignalDB").signalOp("saveICDC")).then(function(){})};function u(e){return o("WASignalDB").getDb().runInTransaction(["meta"],"readwrite",function(t){return t.stores.meta.bulkPut([{key:o("WADbSignal").MetaKeysEnum.deviceId,value:{deviceId:e}}])},o("WASignalDB").signalOp("saveDeviceId")).then(function(){})}function c(e,t){return o("WASignalDB").getDb().runInTransaction(["meta","signedPrekey"],"readwrite",async function(n){var r;await Promise.all([n.stores.meta.bulkPut([{key:(r=o("WADbSignal")).MetaKeysEnum.deviceUUID,value:{deviceUUID:t.deviceUUID}},{key:r.MetaKeysEnum.fbid,value:{fbid:e}},{key:r.MetaKeysEnum.regId,value:{regId:t.signalRegInfo.regId}},{key:r.MetaKeysEnum.identityKeyPair,value:{identityKeyPair:t.signalRegInfo.identityKeyPair}},{key:r.MetaKeysEnum.lastSignedPrekeyId,value:{lastSignedPrekeyId:t.signalRegInfo.signedPreKey.keyId}},{key:r.MetaKeysEnum.registrationVersion,value:{registrationVersion:t.registrationVersion}},{key:r.MetaKeysEnum.authKeyPair,value:{authKeyPair:t.signalRegInfo.authKeyPair}},{key:r.MetaKeysEnum.deviceRegUnixTime,value:{deviceRegUnixTime:t.registrationUnixTime}}]),n.stores.signedPrekey.bulkPut([t.signalRegInfo.signedPreKey])])},o("WASignalDB").signalOp("saveRegistrationMeta"))}var d=function(t){var e=t.sessionId;return o("WASignalDB").getDb().runInTransaction(["meta"],"readwrite",function(t){return t.stores.meta.bulkPut([{key:o("WADbSignal").MetaKeysEnum.lastSessionDeviceWasLinkedTo,value:{lastSessionDeviceWasLinkedTo:e}}])},o("WASignalDB").signalOp("saveLastSessionDeviceWasLinkedTo")).then(function(){})};function m(){return o("WASignalDB").getDb().runInTransaction(["meta"],"readonly",async function(t){var n,a=await t.stores.meta.bulkGet([(n=o("WADbSignal")).MetaKeysEnum.fbid,n.MetaKeysEnum.deviceId,n.MetaKeysEnum.cat,n.MetaKeysEnum.regId,n.MetaKeysEnum.identityKeyPair,n.MetaKeysEnum.authKeyPair]),i=a[0],l=a[1],s=a[2],u=a[3],c=a[4],d=a[5];o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["worker: got db data"])));var m=i==null?void 0:i.value.fbid,p=l==null?void 0:l.value.deviceId,_=s==null?void 0:s.value.cat,f=u==null?void 0:u.value.regId,g=c==null?void 0:c.value.identityKeyPair,h=d==null?void 0:d.value.authKeyPair;if(m==null)throw r("err")("fbid not set");if(p==null)throw r("err")("deviceId not set");if(_==null)throw r("err")("fbCat not set");if(f==null||g==null)throw r("err")("regInfo not set");return{deviceJid:o("WAJids").toDeviceJid(o("WAJids").toMsgrUserJid(m),p),fbCat:_.encrypted_serialized_cat,regInfo:{authKeyPair:h,regId:f,staticKeyPair:g},userJid:o("WAJids").toMsgrUserJid(m)}},o("WASignalDB").signalOp("loadAllRegistrationMeta"))}l.saveICDC=s,l.saveDeviceId=u,l.saveRegistrationMeta=c,l.saveLastSessionDeviceWasLinkedTo=d,l.loadAllRegistrationMetaInTransaction=m}),98);
__d("WAMapUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return new Map(Array.from(e.entries()).map(function(e){return[e[0],t(e[1],e[0])]}))}i.mapValues=e}),66);
__d("WAProtocolMediaType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"image":case"sticker":case"gif":case"video":case"ptt":case"audio":case"document":return e;case"xma-image":return"document";default:return null}}i.castToProtocolMediaType=e}),66);
__d("WAEncNode",["WAAsMessageTransport","WACryptoManagerUtils","WAGlobals","WALogger","WAMapUtils","WAMsgTransport.pb","WANullthrows","WAProtocolMediaType","encodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n,a,i){var l=new Set,s=new Set,u=new Set,c=o("WAMapUtils").mapValues(t,function(e,t){var n=e.icdc,r=e.params,o;switch(l.add(r.type),r.type){case"message":{o=d({messageBytes:r.messageBytes,to:t,icdc:n,chat:r.chat,backupDirective:r.backupDirective,applicationPayloadVersion:r.applicationPayloadVersion}),s.add(r.messageType.type),r.messageType.mediaType!=null&&u.add(r.messageType.mediaType);break}case"appdata":{o=m({messageBytes:r.messageBytes});break}default:r.type,o=p({skdm:r.skdm,icdc:n})}return{plaintext:o}});return o("WACryptoManagerUtils").bulkEncryptMsgWithMetrics(c,n).then(function(n){return n.success?o("WAMapUtils").mapValues(n.value,function(e,n){var a,l,s=e.baseKey,u=e.ciphertext,c=e.type,d=r("WANullthrows")((a=t.get(n))==null?void 0:a.params),m=d.type==="message"&&d.messageType.type==="media"?o("WAProtocolMediaType").castToProtocolMediaType(d.messageType.mediaType):null;return{encType:"device",to:n,v:((l=d.messageBytes)==null?void 0:l.version)==="v2"?"2":"3",type:c,mediaType:m,count:i,ciphertext:u,baseKey:s}}):(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to encrypt message: ",""])),n.error),null)})}function c(e,t,n,r,a,i,l,u){var c;switch(t.type){case"message":{c=d({messageBytes:t.messageBytes,to:e,icdc:l,chat:t.chat,backupDirective:u,applicationPayloadVersion:t.applicationPayloadVersion});break}case"appdata":{c=m({messageBytes:t.messageBytes});break}default:t.type,c=p({skdm:t.skdm,icdc:l})}var _=o("WACryptoManagerUtils").encryptMsgWithMetrics(e,c,n,a,i);return _.then(function(n){var a;if(!n.success)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to encrypt message: ",""])),n.error),null;var i=t.type==="message"&&t.messageType.type==="media"?o("WAProtocolMediaType").castToProtocolMediaType(t.messageType.mediaType):null,l=n.value,u=l.ciphertext,c=l.type;return{encType:"device",to:e,v:((a=t.messageBytes)==null?void 0:a.version)==="v2"?"2":"3",type:c,mediaType:i,count:r,ciphertext:u,baseKey:n.value.baseKey}})}function d(e){var t=e.applicationPayloadVersion,n=e.backupDirective,r=e.chat,a=e.icdc,i=e.messageBytes,l=e.to;if(i.version==="v3"){var s=null;o("WAGlobals").isPeerDevice(l)&&(s=r);var u=o("WAAsMessageTransport").asMessageTransport(i.bytes,s,null,a,n,t);return o("encodeProtobuf").encodeProtobuf(o("WAMsgTransport.pb").MessageTransportSpec,u).readByteArrayView()}else return o("WAGlobals").isPeerDevice(l)?i.bytesForPeer:i.bytes}function m(e){var t=e.messageBytes;if(t.version==="v3"){var n=o("WAAsMessageTransport").asMessageTransport(t.bytes);return o("encodeProtobuf").encodeProtobuf(o("WAMsgTransport.pb").MessageTransportSpec,n).readByteArrayView()}else throw r("err")("Plaintext v2 not supported yet")}function p(e){var t=e.icdc,n=e.skdm,r=o("WAAsMessageTransport").asMessageTransport(null,null,n,t);return o("encodeProtobuf").encodeProtobuf(o("WAMsgTransport.pb").MessageTransportSpec,r).readByteArrayView()}l.getEncNodes=u,l.getEncNode=c}),98);
__d("WAPhash",["Promise","WABase64","WABinary","WACryptoDependencies","WALogger","WASortedLists"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Calculate pHash -- Start"])));for(var r=o("WASortedLists").sortAndDedupe(t),a=new(o("WABinary")).Binary,i=0;i<r.length;i++)a.writeString(r[i]);return(u||(u=n("Promise"))).resolve(o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",a.readByteArrayView()).then(function(e){o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Calculate pHash -- end"])));var t=new Uint8Array(e,0,6);return"2:"+o("WABase64").encodeB64(t)}))}l.calculatePHash=c}),98);
__d("WAEncUserMsg",["WAComputeICDC","WAEncNode","WAGlobals","WAJids","WAPhash","WATagsLogger","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=o("WATagsLogger").TAGS(["WAEncUserMsg"]);async function y(t,n,a,i){h.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg -- encryptUserMsg -- user message -- START"]))),t.length===0&&h.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["WAEncUserMsg -- no recipient"]))),h.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg -- encryptUserMsg -- user message -- ICDC"])));var l=t.flatMap(function(e){return e.devicesInfo}).map(function(e){return e.jid});R(t)&&h.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg -- encryptUserMsg -- user message -- OTHER_RECIPENT_DEVICE_EMPTY"])));var m;return n.type==="message"&&!r("gkx")("3176")&&(m=await L(t,a,i)),Promise.all([b(l,n,a,m,i),o("WAPhash").calculatePHash(l.concat(o("WAGlobals").getMyDeviceJid()))]).then(function(e){var t=e[0],n=e[1];return h.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg -- encryptUserMsg -- user message -- DONE"]))),{participants:t,phash:n}})}function C(e,t,n){return b(e,t,n)}function b(e,t,n,r,o){return S(e,t,n,r,o).then(function(e){if(e.length===0){h.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["WAEncUserMsg -- getParticipantNodes -- EMPTY NODE"]))),o==null||o.addPoint("getParticipantNodes_empty_node");return}return e})}function v(e,t,n,r,a,i){return o("WAEncNode").getEncNode(e,t,n,r,a,i)}function S(e,t,n,r,a){var i=!1;h.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["WAEncUserMsg -- encrypt -- getParticipantNodes -- START"]))),(t.type!=="message"||o("WAJids").interpretAsGroupJid(t.chat)!=null)&&(i=!0);var l=o("WAEncNode").getEncNodes(new Map(e.map(function(e){return[e,{params:t,icdc:r}]})),n).then(function(e){return e==null?(h.WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["WAEncUserMsg -- encrypt - getParticipantNodes -- EMPTY DEVICE JIDS"]))),a==null||a.addPoint("getParticipantNodes_empty_device_jids"),[]):(t.type==="message"&&(i=i||Array.from(e.keys()).some(function(e){return o("WAJids").extractUserJid(e)===t.chat})),Array.from(e==null?void 0:e.values()))});return l.then(function(e){return i?e:(h.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["WAEncUserMsg -- getParticipantNodes -- receiverEncypted -- FALSE"]))),a==null||a.addPoint("getParticipantNodes_receiverEncypted_false"),[])}).then(function(e){return e.filter(Boolean)})}function R(e){return e.filter(function(e){return e.user!==o("WAGlobals").getMyUserJid()}).flatMap(function(e){return e.devicesInfo}).length===0}async function L(e,t,n){var r;try{n==null||n.addPoint("icdc_start"),r=await o("WAComputeICDC").computeICDC(e,o("WAGlobals").getMyUserJid(),o("WAGlobals").getMyDeviceJid(),t),n==null||n.addPoint("icdc_end",{bool:{isICDCEmpty:r==null}})}catch(e){n==null||n.addPoint("icdc-error"),h.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["WAEncUserMsg -- ICDC calc error: ",""])),e)}return r}l.encryptUserMsg=y,l.encryptGroupFanoutMsg=C,l.encryptDeviceJidMessage=v}),98);
__d("WAGetUserDevices",[],(function(t,n,r,o,a,i){"use strict";async function e(e,t){var n=await t.storage.bulkLoadIdentities(e);return Array.from(n).flatMap(function(e){var t=e[1];return Array.from(t.keys())})}i.getUserDevices=e}),66);
__d("WAEncGroupMsg",["WAAsMessageTransport","WABridge","WACryptoManager","WACryptoManagerUtils","WADbPersonalSenderKeyStatusTxns","WAEncUserMsg","WAGetUserDevices","WAGlobals","WAHex","WAMsgTransport.pb","WAOdsEnums","WAPhash","WAPromiseQueue","WAProtocolMediaType","WAResultOrError","WASortedLists","WATagsLogger","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["WAEncGroupMsg"]),f=30*o("WATimeUtils").DAY_SECONDS,g=new(o("WAPromiseQueue")).PromiseQueue;async function h(e,t,n){var r=e.senderKeyId;if(r==null||e.rotateSenderKey||!o("WATimeUtils").happenedWithin(e.ts,f))return o("WAResultOrError").makeError("sender-key-invalid");var a=await n.cryptoManager.storage.loadSenderKeySession(t,o("WAGlobals").getMyDeviceJid());if(a.success===!1||a.value.senderKeyStates.length===0)return o("WAResultOrError").makeError("sender-key-missing");var i=a.value.senderKeyStates.at(-1);return i==null?o("WAResultOrError").makeError("sender-key-missing"):i.senderKeyId!==e.senderKeyId?o("WAResultOrError").makeError("sender-key-id-mismatch"):o("WAResultOrError").makeResult({senderKeyId:r})}async function y(e,t){var n=await o("WACryptoManager").rotateGroupSenderKey(t.cryptoManager,e,o("WAGlobals").getMyDeviceJid());return await o("WADbPersonalSenderKeyStatusTxns").markSenderKeyAsRotated(e,n.senderKeyId,o("WATimeUtils").unixTime()),{senderKeyId:n.senderKeyId}}function C(t,n,r,a){return g.enqueue(async function(){var i=await o("WADbPersonalSenderKeyStatusTxns").getSenderKeyStatus(t),l=await h(i,t,r),s=await o("WAGetUserDevices").getUserDevices(n,r.cryptoManager),u=new Set(s);if(l.success===!1){_.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Rotating sender key for group "," because ",""])),t,l.error),o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.GROUP_SKS_INVALID,key:l.error}),a.addPoint("sender_key_rotation_start");var c=await y(t,r);return a.addPoint("sender_key_rotation_end"),{senderKeyId:c.senderKeyId,needsSenderKey:u,groupParticipants:new Set(s)}}else{var d;return((d=i.hasSenderKey)!=null?d:[]).forEach(function(e){return u.delete(e)}),a.addPoint("no_sk_rotation",{int:{noRotationNeedsSK:u.size}}),{senderKeyId:l.value.senderKeyId,needsSenderKey:u,groupParticipants:new Set(s)}}})}async function b(e,t,n,r,a,i,l){l.addPoint("enc_group_start");var f=await C(e,t.map(function(e){return e.user}),a,l),g=f.groupParticipants,h=f.needsSenderKey,y=f.senderKeyId;_.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Finish rotate participant info"]))),l.addPoint("rotated_participant_info");var b=null,S,R,L=t.flatMap(function(e){return e.devicesInfo}).map(function(e){return e.jid});g.delete(o("WAGlobals").getMyDeviceJid());var E=!o("WASortedLists").areEqual(o("WASortedLists").asSortedSet(g),o("WASortedLists").sortAndDedupe(L)),k=r.type==="text"&&r.isRevoked,I=r.type==="media"?o("WAProtocolMediaType").castToProtocolMediaType(r.mediaType):null;if(E||k){var T=await o("WAEncUserMsg").encryptGroupFanoutMsg(L,{type:"message",messageBytes:n,messageType:r,chat:e,backupDirective:i},a);T&&!(r.type==="text"&&r.isInvisible===!0)&&(S=T,R={encType:"group",to:e,v:n.version==="v3"?"3":"2",type:"skmsg",mediaType:I,ciphertext:null}),_.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Finish group fanout msg"]))),l.addPoint("finish_group_fanout_msg")}else{var D;if(n.version==="v3"){var x=o("WAAsMessageTransport").asMessageTransport(n.bytes);D=o("encodeProtobuf").encodeProtobuf(o("WAMsgTransport.pb").MessageTransportSpec,x).readByteArrayView()}else D=n.bytes;var $=await o("WACryptoManagerUtils").encryptGroupContentWithMetrics(e,D,a);if(_.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Finish encrypt group content"]))),l.addPoint("finish_encrypt_group_content"),$.success){_.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Encrypt success"])));var P=$.value;if(y!==P.senderKeyId&&g.forEach(function(e){return h.add(e)}),h.size>0){var N={groupId:e,axolotlSenderKeyDistributionMessage:o("WAHex").bytesToBuffer(P.senderKeyDistributionProto)};_.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["start key distribution"])));var M=L.filter(function(e){return h.has(e)}),w=await v(M,N,a);_.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["end key distribution"]))),l.addPoint("finish_skdm_enc_node"),w.length>0&&(S=w,b={group:e,senderKeyId:P.senderKeyId,knowsSenderKey:new Set(M)})}R={encType:"group",to:e,v:n.version==="v2"?"2":"3",type:P.ciphertext.type,mediaType:I,ciphertext:P.ciphertext.ciphertext},r.type==="text"&&r.isInvisible===!0&&(R={encType:"group",to:e,v:n.version==="v2"?"2":"3",type:"skmsg",mediaType:null,ciphertext:null})}}var A=await o("WAPhash").calculatePHash(L.concat(o("WAGlobals").getMyDeviceJid()));return l.addPoint("phash_finish"),{phash:A,participants:S,encNode:R,senderKeyDistributionInfo:b}}function v(e,t,n){var r=o("WAAsMessageTransport").asMessageTransport(null,null,t,null),a=o("encodeProtobuf").encodeProtobuf(o("WAMsgTransport.pb").MessageTransportSpec,r).readByteArrayView();return o("WACryptoManagerUtils").bulkEncrypt(new Map(e.map(function(e){return[e,{plaintext:a}]})),n).then(function(e){var t=[];return e.forEach(function(e,n){t.push({encType:"device",to:n,v:"3",type:e.type,ciphertext:e.ciphertext,mediaType:null,count:null,baseKey:null})}),t})}l.encryptGroupMsg=b}),98);
__d("WAFrankingNode",["Promise","WAFranking","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,r,a){return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Franking key is missing"]))),(u||(u=n("Promise"))).resolve(null)):a!=null&&a!==0?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Can't handle franking version ",""])),a),(u||(u=n("Promise"))).resolve(null)):o("WAFranking").genFrankingTag(r,t)}l.genFrankingTagFromMessageApplicationEncode=c}),98);
__d("WAGenReportingMeta",["WAByteArray","WAFranking","WAFrankingNode"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n){var r=await o("WAFrankingNode").genFrankingTagFromMessageApplicationEncode(e,t,n);return{frankingKey:t,frankingTag:r,frankingVersion:o("WAFranking").getFrankingVersion(n),reportingContent:o("WAByteArray").uint8ArrayToBuffer(e),reportingTag:null}}l.genReportingMeta=e}),98);
__d("WAGetKeysForUpload",["WALoggerTag","WAResultOrError","WASignalKeys","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("WATagsLogger").TAGS([r("WALoggerTag").PrekeyGenerateAndUpload,r("WALoggerTag").SignedPrekey]);function u(t,n){return t.storage.loadPreKeys(n).then(function(n){var r=n.preKeys,a=n.signedPreKey,i=[];return r.forEach(function(t){var n=o("WASignalKeys").deserializePreKey(t);n==null?s.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to deserialize prekey received from the db"]))):i.push(n)}),o("WAResultOrError").makeResult({regInfo:t.regInfo,keyType:o("WASignalKeys").KEY_TYPE,preKeys:i,signedPreKey:a})})}l.getKeysForUpload=u}),98);
__d("WAMakeSignedPreKeyMixin",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t={idElementValue:o("WAWap").BIG_ENDIAN_CONTENT(e.id,3)},n={anyElementValue:e.keyPair.publicKey},r=e.signature;return{keyIDMixinArgs:t,keyDataMixinArgs:n,signatureElementValue:r}}l.makeSignedPreKeyMixin=e}),98);
__d("WARandomJitter",[],(function(t,n,r,o,a,i){"use strict";function e(){return Math.round(Math.random()*500-250)}i.getRandomJitter=e}),66);
__d("WARetryUtils",["WARandomJitter"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e?{algo:{backoff:{first:1,second:1,type:"fibonacci"},toMs:function(t){return(1+t)*1e3+o("WARandomJitter").getRandomJitter()},type:"adjust"},relativeDelay:!0,max:6e5}:{algo:{type:"adjust",backoff:{type:"fibonacci",first:1,second:1},toMs:function(t){return(9+t)*1e3}},max:62e4}}l.fibonacciBackoff=e}),98);
__d("WASmaxInPreKeysSetVnameFailureBadRequestMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","bad-request");return n.success?o("WAResultOrError").makeResult({text:n.value}):n}l.parseSetVnameFailureBadRequestMixin=e}),98);
__d("WASmaxInPreKeysSetVnameFailureFallbackMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").attrString(e,"text");return n.success?o("WAResultOrError").makeResult({text:n.value}):n}l.parseSetVnameFailureFallbackMixin=e}),98);
__d("WASmaxInPreKeysSetVnameFailureInternalServerErrorMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","internal-server-error");return n.success?o("WAResultOrError").makeResult({text:n.value}):n}l.parseSetVnameFailureInternalServerErrorMixin=e}),98);
__d("WASmaxInPreKeysSetVnameFailureNotAcceptableMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(e,"violation");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","not-acceptable");if(!r.success)return r;var a=o("WASmaxParseUtils").attrString(n.value,"reason");if(!a.success)return a;var i=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrInt,n.value,"max");if(!i.success)return i;var l=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrInt,n.value,"length");return l.success?o("WAResultOrError").makeResult({text:r.value,violationReason:a.value,violationMax:i.value,violationLength:l.value}):l}l.parseSetVnameFailureNotAcceptableMixin=e}),98);
__d("WASmaxInPreKeysVnameFailures",["WAResultOrError","WASmaxInPreKeysSetVnameFailureBadRequestMixin","WASmaxInPreKeysSetVnameFailureFallbackMixin","WASmaxInPreKeysSetVnameFailureInternalServerErrorMixin","WASmaxInPreKeysSetVnameFailureNotAcceptableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysSetVnameFailureNotAcceptableMixin").parseSetVnameFailureNotAcceptableMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"SetVnameFailureNotAcceptable",value:t.value});var n=o("WASmaxInPreKeysSetVnameFailureBadRequestMixin").parseSetVnameFailureBadRequestMixin(e);if(n.success)return o("WAResultOrError").makeResult({name:"SetVnameFailureBadRequest",value:n.value});var r=o("WASmaxInPreKeysSetVnameFailureInternalServerErrorMixin").parseSetVnameFailureInternalServerErrorMixin(e);if(r.success)return o("WAResultOrError").makeResult({name:"SetVnameFailureInternalServerError",value:r.value});var a=o("WASmaxInPreKeysSetVnameFailureFallbackMixin").parseSetVnameFailureFallbackMixin(e);return a.success?o("WAResultOrError").makeResult({name:"SetVnameFailureFallback",value:a.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["VnameFailureNotAcceptable","VnameFailureBadRequest","VnameFailureInternalServerError","VnameFailureFallback"],[t,n,r,a])}l.parseVnameFailures=e}),98);
__d("WASmaxInPreKeysSetResponsePreKeySuccessVnameFailure",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysVnameFailures","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxParseUtils").flattenedChildWithTag(r.value,"error");if(!a.success)return a;var i=o("WASmaxParseUtils").attrString(r.value,"text");if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,r.value,"code",207);if(!l.success)return l;var s=o("WASmaxParseUtils").attrIntRange(a.value,"code",400,599);if(!s.success)return s;var u=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!u.success)return u;var c=o("WASmaxInPreKeysVnameFailures").parseVnameFailures(a.value);return c.success?o("WAResultOrError").makeResult(babelHelpers.extends({errorText:i.value,errorCode:l.value,errorErrorCode:s.value},u.value,{errorErrorVnameFailures:c.value})):c}l.parseSetResponsePreKeySuccessVnameFailure=e}),98);
__d("WASmaxInPreKeysIQErrorNotAcceptableMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"field");if(!t.success)return t;var n=o("WASmaxParseUtils").attrString(e,"name");if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(e,"reason");return r.success?o("WAResultOrError").makeResult({name:n.value,reason:r.value}):r}function s(t){var n=o("WASmaxParseUtils").assertTag(t,"error");if(!n.success)return n;var r=o("WASmaxParseUtils").optionalChildWithTag(t,"field",e);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,t,"text","not-acceptable");if(!a.success)return a;var i=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,t,"code",406);return i.success?o("WAResultOrError").makeResult({text:a.value,code:i.value,field:r.value}):i}l.parseIQErrorNotAcceptableField=e,l.parseIQErrorNotAcceptableMixin=s}),98);
__d("WASmaxInPreKeysRequestErrors",["WAResultOrError","WASmaxInPreKeysIQErrorFallbackClientMixin","WASmaxInPreKeysIQErrorNotAcceptableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysIQErrorNotAcceptableMixin").parseIQErrorNotAcceptableMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorNotAcceptable",value:t.value});var n=o("WASmaxInPreKeysIQErrorFallbackClientMixin").parseIQErrorFallbackClientMixin(e);return n.success?o("WAResultOrError").makeResult({name:"IQErrorFallbackClient",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorNotAcceptable","IQErrorFallbackClient"],[t,n])}l.parseRequestErrors=e}),98);
__d("WASmaxInPreKeysSetResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrors").parseRequestErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrors:i.value})):i}l.parseSetResponseRequestError=e}),98);
__d("WASmaxInPreKeysSetResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseSetResponseServerError=e}),98);
__d("WASmaxInPreKeysSetResponseSuccess",["WASmaxInPreKeysIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return r.success,r}l.parseSetResponseSuccess=e}),98);
__d("WASmaxOutPreKeysKeyDataMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyElementValue,n=o("WASmaxJsx").smax("smax$any",null,t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeKeyDataMixin=s}),98);
__d("WASmaxOutPreKeysIdentityKeyMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutPreKeysKeyDataMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxJsx").smax("smax$any",null,o("WASmaxOutPreKeysKeyDataMixin").mergeKeyDataMixin(o("WASmaxJsx").smax("identity",null),e));return t}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIdentityKeyMixin=s}),98);
__d("WASmaxOutPreKeysKeyTypeMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("type",null,new Uint8Array([5])));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeKeyTypeMixin=s}),98);
__d("WASmaxOutPreKeysKeyIDMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.idElementValue,n=o("WASmaxJsx").smax("id",null,t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeKeyIDMixin=s}),98);
__d("WASmaxOutPreKeysPreKeyListMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutPreKeysKeyDataMixin","WASmaxOutPreKeysKeyIDMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.keyIDMixinArgs,n=e.keyDataMixinArgs,r=o("WASmaxJsx").smax("key",null,o("WASmaxOutPreKeysKeyIDMixin").mergeKeyIDMixin(o("WASmaxJsx").smax("id",null),t),o("WASmaxOutPreKeysKeyDataMixin").mergeKeyDataMixin(o("WASmaxJsx").smax("value",null),n));return r}function s(t){var n=t.keyArgs,r=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("list",null,o("WASmaxChildren").REPEATED_CHILD(e,n,0,2e4)));return r}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makePreKeyListListKey=e,l.mergePreKeyListMixin=u}),98);
__d("WASmaxOutPreKeysRegistrationIDMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.registrationElementValue,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("registration",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeRegistrationIDMixin=s}),98);
__d("WASmaxOutPreKeysRequestPaddingMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.paddingElementValue,n=o("WASmaxJsx").smax("iq",null,o("WASmaxJsx").smax("padding",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeRequestPaddingMixin=s}),98);
__d("WASmaxOutPreKeysSignedPreKeyMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutPreKeysKeyDataMixin","WASmaxOutPreKeysKeyIDMixin"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.keyIDMixinArgs,r=e.keyDataMixinArgs,a=e.signatureElementValue,i=(t=o("WASmaxJsx")).smax("smax$any",null,t.smax("skey",null,o("WASmaxOutPreKeysKeyIDMixin").mergeKeyIDMixin(t.smax("id",null),n),o("WASmaxOutPreKeysKeyDataMixin").mergeKeyDataMixin(t.smax("value",null),r),t.smax("signature",null,a)));return i}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeSignedPreKeyMixin=s}),98);
__d("WASmaxOutPreKeysVerifiedNameMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.verifiedNameElementValue,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("verified_name",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeVerifiedNameMixin=s}),98);
__d("WASmaxOutPreKeysIdentityKeyBundleMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutPreKeysIdentityKeyMixin","WASmaxOutPreKeysKeyTypeMixin","WASmaxOutPreKeysPreKeyListMixin","WASmaxOutPreKeysRegistrationIDMixin","WASmaxOutPreKeysRequestPaddingMixin","WASmaxOutPreKeysSignedPreKeyMixin","WASmaxOutPreKeysVerifiedNameMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.verifiedNameMixinArgs,n=e.requestPaddingMixinArgs,r=o("WASmaxMixins").optionalMerge(o("WASmaxOutPreKeysRequestPaddingMixin").mergeRequestPaddingMixin,o("WASmaxMixins").optionalMerge(o("WASmaxOutPreKeysVerifiedNameMixin").mergeVerifiedNameMixin,o("WASmaxOutPreKeysKeyTypeMixin").mergeKeyTypeMixin(o("WASmaxOutPreKeysSignedPreKeyMixin").mergeSignedPreKeyMixin(o("WASmaxOutPreKeysPreKeyListMixin").mergePreKeyListMixin(o("WASmaxOutPreKeysIdentityKeyMixin").mergeIdentityKeyMixin(o("WASmaxOutPreKeysRegistrationIDMixin").mergeRegistrationIDMixin(o("WASmaxJsx").smax("iq",null),e),e),e),e)),t),n);return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIdentityKeyBundleMixin=s}),98);
__d("WASmaxOutPreKeysSetRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin","WASmaxOutPreKeysIdentityKeyBundleMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutPreKeysIdentityKeyBundleMixin").mergeIdentityKeyBundleMixin(o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"set"})),e);return t}l.makeSetRequest=e}),98);
__d("WASmaxPreKeysSetRPC",["WAComms","WASmaxInPreKeysSetResponsePreKeySuccessVnameFailure","WASmaxInPreKeysSetResponseRequestError","WASmaxInPreKeysSetResponseServerError","WASmaxInPreKeysSetResponseSuccess","WASmaxOutPreKeysSetRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(t,n,r,o,a,i,l){async function e(e,t){var n=o("WASmaxOutPreKeysSetRequest").makeSetRequest(e),r=await o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInPreKeysSetResponseSuccess").parseSetResponseSuccess(r,n);if(a.success)return{name:"SetResponseSuccess",value:a.value};var i=o("WASmaxInPreKeysSetResponsePreKeySuccessVnameFailure").parseSetResponsePreKeySuccessVnameFailure(r,n);if(i.success)return{name:"SetResponsePreKeySuccessVnameFailure",value:i.value};var l=o("WASmaxInPreKeysSetResponseRequestError").parseSetResponseRequestError(r,n);if(l.success)return{name:"SetResponseRequestError",value:l.value};var s=o("WASmaxInPreKeysSetResponseServerError").parseSetResponseServerError(r,n);if(s.success)return{name:"SetResponseServerError",value:s.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("Set",{Success:a,PreKeySuccessVnameFailure:i,RequestError:l,ServerError:s}))}l.sendSetRPC=e}),98);
__d("WAGenerateAndUploadPreKeysProtocol",["WACryptoManager","WAGetKeysForUpload","WAGlobals","WAMakeSignedPreKeyMixin","WAPromiseRetryLoop","WAResultOrError","WARetryUtils","WASmaxPreKeysSetRPC","WATagsLogger","WAWap"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("WATagsLogger").TAGS(["generateAndUploadPreKeysProtocol"]);async function p(){var t=await o("WAGlobals").getWaOneQueue().enqueue(async function(t){var n=t.cryptoManager,r=await o("WACryptoManager").generatePreKeys(n);return r.success?(m.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["About to upload pre keys"]))).devConsole("generation "+r.value),o("WAGetKeysForUpload").getKeysForUpload(n,r.value)):r},{operationType:"generate_prekeys",flush:!0,afterInit:!0}),n=t.value,r=n.preKeys,a=n.regInfo,i=n.signedPreKey,l=babelHelpers.extends({registrationElementValue:o("WAWap").BIG_ENDIAN_CONTENT(a.regId),anyElementValue:a.staticKeyPair.publicKey,keyArgs:r.map(_)},o("WAMakeSignedPreKeyMixin").makeSignedPreKeyMixin(i)),p=new(o("WAPromiseRetryLoop")).PromiseRetryLoop({name:"uploadKeys",timer:o("WARetryUtils").fibonacciBackoff(!1),code:async function(t){m.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Attempt to upload keys"])));var e=await o("WASmaxPreKeysSetRPC").sendSetRPC(l);switch(e.name){case"SetResponseSuccess":{m.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Keys are successfully uploaded"]))),t(o("WAResultOrError").makeResult({preKeys:r}));return}case"SetResponseRequestError":{m.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Got Malformed upload keys IQ on upload pre keys attempt"]))),t(o("WAResultOrError").makeError("request-error"));return}default:e.name,m.WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Got unexpected error: ",", will retry after backoff"])),e.name)}}});return p.start(),p.promise()}function _(e){var t={idElementValue:o("WAWap").BIG_ENDIAN_CONTENT(e.id,3)},n={anyElementValue:e.keyPair.publicKey};return{keyIDMixinArgs:t,keyDataMixinArgs:n}}l.generateAndUploadPreKeysProtocol=p}),98);
__d("WAGenerateAndUploadPreKeys",["WABridge","WAGenerateAndUploadPreKeysProtocol","WALoggerTag","WAOdsEnums","WATagsLogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS([r("WALoggerTag").PrekeyGenerateAndUpload,r("WALoggerTag").SignedPrekey]);function c(t){var n=t.reason;return u.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["About to generate and upload pre keys with reason: ",""])),n),o("WAGenerateAndUploadPreKeysProtocol").generateAndUploadPreKeysProtocol().then(function(e){var t;if(e.success){o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_UPLOAD,key:"success",amount:e.value.preKeys.length},!0);return}var n=e.error;if(n==="request-error")throw o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_UPLOAD,key:"malformed"},!0),r("err")("Malformed upload keys IQ");u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate and upload prekeys with error ",": ","}"])),n,(t=e.payload)==null?void 0:t.message)})}l.generateAndUploadPreKeys=c}),98);
__d("WAGetCurrentUserDeviceInfoApi",["WAGetMetaApi","WASignalKeys"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return o("WAGetMetaApi").getMeta().then(function(e){var t=e==null?void 0:e.deviceId,n=e==null?void 0:e.identityKeyPair;if(t==null||n==null)return null;var r=o("WASignalKeys").serializePubKey(n);return{deviceId:t,identityKey:r}})},s=function(){return o("WAGetMetaApi").getMeta().then(function(e){return(e==null?void 0:e.deviceId)==null?null:{deviceId:e==null?void 0:e.deviceId}})};l.getCurrentUserDeviceInfo=e,l.getCurrentUserDeviceId=s}),98);
__d("WAGetDeviceIdentityMixin",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e!=null?{deviceIdentityElementValue:e}:null}i.getDeviceIdentityMixin=e}),66);
__d("WAGetLocalPublicPrivateIdentityKeyApi",["WADbSignal","WALogger","WASignalDB","WASignalKeys","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(){return o("WASignalDB").getDb().runInTransaction(["meta"],"readonly",async function(t){var n,a=await t.stores.meta.get(o("WADbSignal").MetaKeysEnum.identityKeyPair);if((a==null||(n=a.value)==null?void 0:n.identityKeyPair)==null){var i="[Remote Presence Error] Identity key pair was null";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),i),r("err")(i)}return o("WASignalKeys").toSerializedKeyPair(a.value.identityKeyPair)},o("WASignalDB").signalOp("getLocalPublicPrivateIdentityKey"))};l.getLocalPublicPrivateIdentityKey=s}),98);
__d("WAGetIdentityKeys",["WAGetLocalPublicPrivateIdentityKeyApi"],(function(t,n,r,o,a,i,l){"use strict";async function e(){var e=await o("WAGetLocalPublicPrivateIdentityKeyApi").getLocalPublicPrivateIdentityKey(),t=e.privateKey,n=e.serializedPubKey;return{identityPrivateKey:t,identityPublicKey:n}}l.getIdentityKeysInWorker=e}),98);
__d("WALoadReceiptApi",["MAWTransactionMode","WADbTransactor","WAMsg","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READONLY},"loadReceipt",function(e){return(function(t){var n=o("WAMsg").craftWAMsgIdString(t);return e.receipts.get({waMsgId:n}).then(function(e){var n;return e==null?o("WAResultOrError").makeError("missing-receipt"):o("WAResultOrError").makeResult({id:t,permittedIdentitiesPerDevice:(n=e.permittedIdentitiesPerDevice)!=null?n:new Map,recipientDevices:e.recipientDevices})})})});l.loadReceipt=e}),98);
__d("WAMarkSenderKeyAsSentApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,r){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",async function(e){var o=await e.stores.personalSenderKeyStatuses.get(t);o!=null&&o.senderKeyId===n&&(r.forEach(function(e){o.hasSenderKey.add(e)}),await e.stores.personalSenderKeyStatuses.bulkPut([o]))},o("WASignalDB").signalOp("markSenderKeyAsSent"))};l.markSenderKeyAsSent=e}),98);
__d("WASmaxInDevicesNotifyResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup").parseRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup:i.value})):i}l.parseNotifyResponseError=e}),98);
__d("WASmaxInDevicesNotifyResponseSuccess",["WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(e,t);return r.success,r}l.parseNotifyResponseSuccess=e}),98);
__d("WASmaxOutDevicesBaseIQSetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("iq",{id:o("WAWap").generateId(),type:"set"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeBaseIQSetRequestMixin=s}),98);
__d("WASmaxOutDevicesNotifyRequest",["WASmaxChildren","WASmaxJsx","WASmaxOutDevicesBaseIQSetRequestMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.userJid,n=o("WASmaxJsx").smax("user",{jid:o("WAWap").USER_JID(t)});return n}function s(t){var n=t.userArgs,r=o("WASmaxOutDevicesBaseIQSetRequestMixin").mergeBaseIQSetRequestMixin(o("WASmaxJsx").smax("iq",{to:o("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},o("WASmaxJsx").smax("users",null,o("WASmaxChildren").REPEATED_CHILD(e,n,1,25))));return r}l.makeNotifyRequestUsersUser=e,l.makeNotifyRequest=s}),98);
__d("WASmaxDevicesNotifyRPC",["WAComms","WASmaxInDevicesNotifyResponseError","WASmaxInDevicesNotifyResponseSuccess","WASmaxOutDevicesNotifyRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(t,n,r,o,a,i,l){async function e(e,t){var n=o("WASmaxOutDevicesNotifyRequest").makeNotifyRequest(e),r=await o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInDevicesNotifyResponseSuccess").parseNotifyResponseSuccess(r,n);if(a.success)return{name:"NotifyResponseSuccess",value:a.value};var i=o("WASmaxInDevicesNotifyResponseError").parseNotifyResponseError(r,n);if(i.success)return{name:"NotifyResponseError",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("Notify",{Success:a,Error:i}))}l.sendNotifyRPC=e}),98);
__d("WANotifyDeviceChange",["WAGlobals","WALogger","WAPersistedJobManager","WASmaxDevicesNotifyRPC","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.users;if(n.size===0)return Promise.resolve();var r=o("WAGlobals").getConfig().maxUsersForNotifyDeviceChange(),a=Array.from(n);return n.size>r&&(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["The maximum number of users that can be notified is ",""])),r),a=a.slice(0,r)),u(a)}async function u(e){var t=await o("WASmaxDevicesNotifyRPC").sendNotifyRPC({userArgs:e.map(function(e){return{userJid:e}})});if(t.name!=="NotifyResponseSuccess"){t.name;var n=t.value.errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup;if(n.name==="RetryableIQError"){var a=n.value.backoff;throw a!=null?new(o("WAPersistedJobManager")).RetryOnBackoff({algo:{type:"constant",delay:a},jitter:0}):new(o("WAPersistedJobManager")).RetryOnBackoff({algo:{type:"exponential",first:o("WATimeUtils").HOUR_MILLISECONDS/60},jitter:.1})}throw r("err")("Failed with an unexpected error code "+n.value.code)}}l.notifyDeviceChange=s}),98);
__d("WAParseFranking",["WAFranking","WAFrankingTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t,n;if(e==null)return null;var r=(t=e.maybeChild("franking_tag"))==null?void 0:t.contentBytes(),a=(n=e.maybeChild("reporting_tag"))==null?void 0:n.contentBytes();return{frankingKey:null,frankingTag:r!=null?o("WAFrankingTypes").castToFrankingTag(r):null,reportingTag:a!=null?o("WAFrankingTypes").castToReportingTag(a):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null}}l.parseFrankingNode=e}),98);
__d("WAQueryGroupsAndSync",["FBLogger","WACreateGroup","WAGetDevices","WAGlobals","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s;async function u(t,n){if(n===void 0&&(n=!1),t!=null){if(t.type==="all"){r("FBLogger")("wmi").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["queryGroupsAndSync: unsupported input type: all"])));return}var o=t.groups;if(o==null||o.length===0){r("FBLogger")("wmi").MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["queryGroupsAndSync: empty groups list"])));return}await c({groupJids:o,ignoreDhash:n})}}async function c(e){var t=e.groupJids,n=e.ignoreDhash,r=n===void 0?!1:n,a=await d({groupJids:t});if(a.length!==0){await o("WACreateGroup").createGroups(a.map(function(e){return{groupStatus:"queried",groupToCreate:e,serverTs:o("WATimeUtils").unixTime(),extras:void 0,folder:void 0,key:void 0}}));var i=m(a);i.size!==0&&await o("WAGetDevices").getDevices({users:i,reason:"query-groups",ignoreDhash:r})}}async function d(e){var t=e.groupJids,n=await Promise.all(t.map(function(e){return o("WAGlobals").getDependencies().queryGroup({groupJid:e})})),r=[];for(var a of n)a.success&&r.push(a.value);return r}function m(e){var t=new Set;for(var n of e)for(var r of n.participants)r.success?t.add(r.value.user):t.add(r.error.user);return t}l.queryGroupsLegacyWAAPI=u,l.queryGroupsAndSync=c}),98);
__d("WASmaxInMessagePublishAckAdminEditMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"edit","3");return n.success?o("WAResultOrError").makeResult({edit:n.value}):n}l.parseAckAdminEditMixin=e}),98);
__d("WASmaxInMessagePublishAckAdminRevokeMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"edit","8");return n.success?o("WAResultOrError").makeResult({edit:n.value}):n}l.parseAckAdminRevokeMixin=e}),98);
__d("WASmaxInMessagePublishAckMessageEditMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"edit","1");return n.success?o("WAResultOrError").makeResult({edit:n.value}):n}l.parseAckMessageEditMixin=e}),98);
__d("WASmaxInMessagePublishAckMessagePinMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"edit","2");return n.success?o("WAResultOrError").makeResult({edit:n.value}):n}l.parseAckMessagePinMixin=e}),98);
__d("WASmaxInMessagePublishEnums",["WAJids"],(function(t,n,r,o,a,i,l){var e,s={CBP:"CBP",NBP:"NBP",PMP:"PMP"},u={delivery:"delivery",no_optimization:"no_optimization"},c={false:"false",true:"true"},d={free_customer_service:"free_customer_service",free_entry_point:"free_entry_point",regular:"regular"},m={lid:"lid",pn:"pn"},p={validators:[(e=o("WAJids")).validateDeviceJid,e.validateDeviceJid,e.validateUserJid,e.validateUserJid],typeName:"DeviceJid|DeviceJid|UserJid|UserJid"},_={validators:[e.validateUserJid,e.validateUserJid],typeName:"UserJid|UserJid"};l.ENUM_CBP_NBP_PMP=s,l.ENUM_DELIVERY_NOOPTIMIZATION=u,l.ENUM_FALSE_TRUE=c,l.ENUM_FREECUSTOMERSERVICE_FREEENTRYPOINT_REGULAR=d,l.ENUM_LID_PN=m,l.DEVICEJID_DEVICEJID_USERJID_USERJID=p,l.USERJID_USERJID=_}),98);
__d("WASmaxInMessagePublishAckPaidConversationMixin",["WAResultOrError","WASmaxInMessagePublishEnums","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"delivery_context");if(!t.success)return t;var n=o("WASmaxParseUtils").attrStringEnum(e,"optimization_goal",o("WASmaxInMessagePublishEnums").ENUM_DELIVERY_NOOPTIMIZATION);return n.success?o("WAResultOrError").makeResult({optimizationGoal:n.value}):n}function s(e){var t=o("WASmaxParseUtils").assertTag(e,"source_url");if(!t.success)return t;var n=o("WASmaxParseUtils").contentString(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function u(e){var t=o("WASmaxParseUtils").assertTag(e,"referral");if(!t.success)return t;var n=o("WASmaxParseUtils").optionalChildWithTag(e,"source_url",s);if(!n.success)return n;var r=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,e,"source_type");return r.success?o("WAResultOrError").makeResult({sourceType:r.value,sourceUrl:n.value}):r}function c(e){var t=o("WASmaxParseUtils").assertTag(e,"origin");if(!t.success)return t;var n=o("WASmaxParseUtils").optionalChildWithTag(e,"referral",u);if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(e,"type");return r.success?o("WAResultOrError").makeResult({type:r.value,referral:n.value}):r}function d(e){var t=o("WASmaxParseUtils").assertTag(e,"pricing");if(!t.success)return t;var n=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,e,"consumer_country_code");if(!n.success)return n;var r=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,e,"business_country_code");if(!r.success)return r;var a=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,e,"conversation_status",0,void 0);if(!a.success)return a;var i=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,e,"latest_c2b_timestamp",0,void 0);if(!i.success)return i;var l=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,e,"analytics_conversation_id");if(!l.success)return l;var s=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,e,"b2c_timestamp",0,void 0);return s.success?o("WAResultOrError").makeResult({consumerCountryCode:n.value,businessCountryCode:r.value,conversationStatus:a.value,latestC2bTimestamp:i.value,analyticsConversationId:l.value,b2cTimestamp:s.value}):s}function m(t){var n=o("WASmaxParseUtils").assertTag(t,"ack");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(t,"biz");if(!r.success)return r;var a=o("WASmaxParseUtils").optionalChildWithTag(r.value,"delivery_context",e);if(!a.success)return a;var i=o("WASmaxParseUtils").optionalChildWithTag(r.value,"origin",c);if(!i.success)return i;var l=o("WASmaxParseUtils").optionalChildWithTag(r.value,"pricing",d);if(!l.success)return l;var s=o("WASmaxParseUtils").attrString(r.value,"paid_convo_id");if(!s.success)return s;var u=o("WASmaxParseUtils").attrStringEnum(r.value,"pricing_model",o("WASmaxInMessagePublishEnums").ENUM_CBP_NBP_PMP);if(!u.success)return u;var m=o("WASmaxParseUtils").attrStringEnum(r.value,"billable",o("WASmaxInMessagePublishEnums").ENUM_FALSE_TRUE);if(!m.success)return m;var p=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,r.value,"expiration_timestamp",0,void 0);if(!p.success)return p;var _=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,r.value,"pricing_category");if(!_.success)return _;var f=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrStringEnum,r.value,"pricing_type",o("WASmaxInMessagePublishEnums").ENUM_FREECUSTOMERSERVICE_FREEENTRYPOINT_REGULAR);return f.success?o("WAResultOrError").makeResult({bizPaidConvoId:s.value,bizPricingModel:u.value,bizBillable:m.value,bizExpirationTimestamp:p.value,bizPricingCategory:_.value,bizPricingType:f.value,bizDeliveryContext:a.value,bizOrigin:i.value,bizPricing:l.value}):f}l.parseAckPaidConversationBizDeliveryContext=e,l.parseAckPaidConversationBizOriginReferralSourceUrl=s,l.parseAckPaidConversationBizOriginReferral=u,l.parseAckPaidConversationBizOrigin=c,l.parseAckPaidConversationBizPricing=d,l.parseAckPaidConversationMixin=m}),98);
__d("WASmaxInMessagePublishAckPaidGroupConversationMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(e,"biz");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(n.value,"pricing");if(!r.success)return r;var a=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,r.value,"business_country_code");return a.success?o("WAResultOrError").makeResult({bizPricingBusinessCountryCode:a.value}):a}l.parseAckPaidGroupConversationMixin=e}),98);
__d("WASmaxInMessagePublishAckPaidAckPaidConversationOrAckPaidGroupConversationConversationMixinGroup",["WAResultOrError","WASmaxInMessagePublishAckPaidConversationMixin","WASmaxInMessagePublishAckPaidGroupConversationMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInMessagePublishAckPaidConversationMixin").parseAckPaidConversationMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"AckPaidConversation",value:t.value});var n=o("WASmaxInMessagePublishAckPaidGroupConversationMixin").parseAckPaidGroupConversationMixin(e);return n.success?o("WAResultOrError").makeResult({name:"AckPaidGroupConversation",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["AckPaidConversation","AckPaidGroupConversation"],[t,n])}l.parseAckPaidAckPaidConversationOrAckPaidGroupConversationConversationMixinGroup=e}),98);
__d("WASmaxInMessagePublishAckRevokeMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"edit","7");return n.success?o("WAResultOrError").makeResult({edit:n.value}):n}l.parseAckRevokeMixin=e}),98);
__d("WASmaxInMessagePublishServerFrankingTagMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"franking");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(t.value,"reporting_tag");if(!n.success)return n;var r=o("WASmaxParseUtils").contentBytesRange(n.value,9,128);return r.success?o("WAResultOrError").makeResult({frankingReportingTagElementValue:r.value}):r}l.parseServerFrankingTagMixin=e}),98);
__d("WASmaxInMessagePublishAckMixin",["WAResultOrError","WASmaxInMessagePublishAckAdminEditMixin","WASmaxInMessagePublishAckAdminRevokeMixin","WASmaxInMessagePublishAckMessageEditMixin","WASmaxInMessagePublishAckMessagePinMixin","WASmaxInMessagePublishAckPaidAckPaidConversationOrAckPaidGroupConversationConversationMixinGroup","WASmaxInMessagePublishAckRevokeMixin","WASmaxInMessagePublishServerFrankingTagMixin","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"ack");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",r.value);if(!a.success)return a;var i=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"class","message");if(!i.success)return i;var l=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",l.value);if(!s.success)return s;var u=o("WASmaxParseUtils").attrIntRange(e,"t",0,void 0);if(!u.success)return u;var c=o("WASmaxInMessagePublishAckMessageEditMixin").parseAckMessageEditMixin(e),d=o("WASmaxInMessagePublishAckAdminEditMixin").parseAckAdminEditMixin(e),m=o("WASmaxInMessagePublishAckMessagePinMixin").parseAckMessagePinMixin(e),p=o("WASmaxInMessagePublishAckAdminRevokeMixin").parseAckAdminRevokeMixin(e),_=o("WASmaxInMessagePublishAckRevokeMixin").parseAckRevokeMixin(e),f=o("WASmaxInMessagePublishServerFrankingTagMixin").parseServerFrankingTagMixin(e),g=o("WASmaxInMessagePublishAckPaidAckPaidConversationOrAckPaidGroupConversationConversationMixinGroup").parseAckPaidAckPaidConversationOrAckPaidGroupConversationConversationMixinGroup(e);return o("WAResultOrError").makeResult({class:i.value,t:u.value,ackMessageEditMixin:c.success?c.value:null,ackAdminEditMixin:d.success?d.value:null,ackMessagePinMixin:m.success?m.value:null,ackAdminRevokeMixin:p.success?p.value:null,ackRevokeMixin:_.success?_.value:null,serverFrankingTagMixin:f.success?f.value:null,ackPaidAckPaidConversationOrAckPaidGroupConversationConversationMixinGroup:g.success?g.value:null})}l.parseAckMixin=e}),98);
__d("WASmaxInMessagePublishApplicationNegativeAckMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").attrIntRange(e,"application_error",0,void 0);return n.success?o("WAResultOrError").makeResult({applicationError:n.value}):n}l.parseApplicationNegativeAckMixin=e}),98);
__d("WASmaxInMessagePublishMessageNackRetryAttributesMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").attrIntRange(e,"backoff",0,86400);return n.success?o("WAResultOrError").makeResult({backoff:n.value}):n}l.parseMessageNackRetryAttributesMixin=e}),98);
__d("WASmaxInMessagePublishNegativeAckMixin",["WAResultOrError","WASmaxInMessagePublishAckMixin","WASmaxInMessagePublishApplicationNegativeAckMixin","WASmaxInMessagePublishMessageNackRetryAttributesMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"ack");if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(e,"error");if(!r.success)return r;var a=o("WASmaxInMessagePublishAckMixin").parseAckMixin(e,t);if(!a.success)return a;var i=o("WASmaxInMessagePublishApplicationNegativeAckMixin").parseApplicationNegativeAckMixin(e),l=o("WASmaxInMessagePublishMessageNackRetryAttributesMixin").parseMessageNackRetryAttributesMixin(e);return o("WAResultOrError").makeResult(babelHelpers.extends({error:r.value},a.value,{applicationNegativeAckMixin:i.success?i.value:null,messageNackRetryAttributesMixin:l.success?l.value:null}))}l.parseNegativeAckMixin=e}),98);
__d("WASmaxInMessagePublishIndividualResponseNegative",["WAResultOrError","WASmaxInMessagePublishNegativeAckMixin","WASmaxParseJid","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"ack");if(!n.success)return n;var r=o("WASmaxParseUtils").optional(o("WASmaxParseJid").attrUserJid,e,"recipient");if(!r.success)return r;var a=o("WASmaxInMessagePublishNegativeAckMixin").parseNegativeAckMixin(e,t);return a.success?o("WAResultOrError").makeResult(babelHelpers.extends({recipient:r.value},a.value)):a}l.parseIndividualResponseNegative=e}),98);
__d("WASmaxInMessagePublishAckRcatMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").flattenedChildWithTag(e,"rcat");if(!n.success)return n;var r=o("WASmaxParseUtils").contentBytes(n.value);return r.success?o("WAResultOrError").makeResult({rcatElementValue:r.value}):r}l.parseAckRcatMixin=e}),98);
__d("WASmaxInMessagePublishDeviceListStaleMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").attrString(e,"phash");return n.success?o("WAResultOrError").makeResult({phash:n.value}):n}l.parseDeviceListStaleMixin=e}),98);
__d("WASmaxInMessagePublishRefreshLIDMixin",["WAResultOrError","WASmaxInMessagePublishEnums","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").attrStringEnum(e,"refresh_lid",o("WASmaxInMessagePublishEnums").ENUM_FALSE_TRUE);return n.success?o("WAResultOrError").makeResult({refreshLid:n.value}):n}l.parseRefreshLIDMixin=e}),98);
__d("WASmaxInMessagePublishIndividualResponseSuccess",["WAResultOrError","WASmaxInMessagePublishAckMixin","WASmaxInMessagePublishAckRcatMixin","WASmaxInMessagePublishDeviceListStaleMixin","WASmaxInMessagePublishEnums","WASmaxInMessagePublishRefreshLIDMixin","WASmaxParseJid","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"ack");if(!n.success)return n;var r=o("WASmaxParseUtils").optional(o("WASmaxParseJid").attrUserJid,e,"recipient");if(!r.success)return r;var a=o("WASmaxParseUtils").optional(o("WASmaxParseJid").attrJidEnum,e,"participant",o("WASmaxInMessagePublishEnums").USERJID_USERJID);if(!a.success)return a;var i=o("WASmaxInMessagePublishAckMixin").parseAckMixin(e,t);if(!i.success)return i;var l=o("WASmaxInMessagePublishDeviceListStaleMixin").parseDeviceListStaleMixin(e),s=o("WASmaxInMessagePublishRefreshLIDMixin").parseRefreshLIDMixin(e),u=o("WASmaxInMessagePublishAckRcatMixin").parseAckRcatMixin(e);return o("WAResultOrError").makeResult(babelHelpers.extends({recipient:r.value,participant:a.value},i.value,{deviceListStaleMixin:l.success?l.value:null,refreshLIDMixin:s.success?s.value:null,ackRcatMixin:u.success?u.value:null}))}l.parseIndividualResponseSuccess=e}),98);
__d("WASmaxOutMessagePublishAppdataMetaAttributeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaAppdata,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{appdata:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeAppdataMetaAttributeMixin=s}),98);
__d("WASmaxOutMessagePublishArmadilloOriginalMessageTimestampMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaOriginalMsgT,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{original_msg_t:o("WAWap").INT(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeArmadilloOriginalMessageTimestampMixin=s}),98);
__d("WASmaxOutMessagePublishAutomatedMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("automated",null));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeAutomatedMixin=s}),98);
__d("WASmaxOutMessagePublishAuthMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.authVerificationTimestamp,n=e.authDisableIosAutofill,r=e.authEnableRiskCheck,a=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("auth",{verification_timestamp:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,t),disable_ios_autofill:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,n),enable_risk_check:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,r)})));return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeAuthMixin=s}),98);
__d("WASmaxOutMessagePublishBizAcceptTsMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.bizAcceptTs,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",{accept_ts:o("WAWap").INT(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizAcceptTsMixin=s}),98);
__d("WASmaxOutMessagePublishBizAutoResponseMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.bizAutoResponse,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",{auto_response:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizAutoResponseMixin=s}),98);
__d("WASmaxOutMessagePublishBizCampaignMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.bizCampaignId,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",{campaign_id:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizCampaignMixin=s}),98);
__d("WASmaxOutMessagePublishBizEngagementDataMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.engagementConversationState,n=e.engagementCustomerServiceState,r=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("engagement",{conversation_state:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t),customer_service_state:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,n)})));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizEngagementDataMixin=s}),98);
__d("WASmaxOutMessagePublishBizMetadataMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n,r=e.metadataAppOwner,a=e.metadataCsidBm,i=e.metadataPaymentBm,l=e.metadataCustomerCategory,s=e.metadataDidBepRun,u=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("metadata",{app_owner:(t=o("WASmaxAttrs")).OPTIONAL((n=o("WAWap")).CUSTOM_STRING,r),csid_bm:t.OPTIONAL(n.CUSTOM_STRING,a),payment_bm:t.OPTIONAL(n.CUSTOM_STRING,i),customer_category:t.OPTIONAL(n.CUSTOM_STRING,l),did_bep_run:t.OPTIONAL(n.CUSTOM_STRING,s)})));return u}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizMetadataMixin=s}),98);
__d("WASmaxOutMessagePublishBizPricingDataMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.pricingConsumerCountryCode,n=e.pricingBusinessCountryCode,r=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("pricing",{consumer_country_code:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t),business_country_code:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,n)})));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizPricingDataMixin=s}),98);
__d("WASmaxOutMessagePublishBizRolesMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.bizHostStorage,n=e.bizActualActors,r=e.bizPrivacyModeTs,a=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",{host_storage:o("WAWap").INT(t),actual_actors:o("WAWap").INT(n),privacy_mode_ts:o("WAWap").INT(r)}));return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizRolesMixin=s}),98);
__d("WASmaxMixinGroupExhaustiveError",[],(function(t,n,r,o,a,i){"use strict";var e=(function(e){function t(){for(var t,n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return t=e.call.apply(e,[this].concat(r))||this,t.name="SmaxMixinGroupExhaustiveError",babelHelpers.assertThisInitialized(t)||babelHelpers.assertThisInitialized(t)}return babelHelpers.inheritsLoose(t,e),t})(babelHelpers.wrapNativeSuper(Error));i.SmaxMixinGroupExhaustiveError=e}),66);
__d("WASmaxOutMessagePublishButtonsMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("buttons",null)));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeButtonsMixin=s}),98);
__d("WASmaxOutMessagePublishExtensionsMetadataMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.capabilityArgs,n=o("WASmaxJsx").smax("capabilities",null,o("WASmaxChildren").REPEATED_CHILD(s,t,1,50));return n}function s(e){var t=e.capabilityName,n=o("WASmaxJsx").smax("capability",{name:o("WAWap").CUSTOM_STRING(t)});return n}function u(t){var n=t.capabilitiesArgs,r=t.extensionsMetadataWellVersion,a=t.extensionsMetadataDataApiVersion,i=t.extensionsMetadataFlowMessageVersion,l=o("WASmaxJsx").smax("native_flow",null,o("WASmaxJsx").smax("extensions_metadata",{well_version:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,r),data_api_version:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,a),flow_message_version:o("WAWap").INT(i)},o("WASmaxChildren").OPTIONAL_CHILD(e,n)));return l}function c(e,t){var n=u(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeExtensionsMetadataExtensionsMetadataCapabilities=e,l.makeExtensionsMetadataExtensionsMetadataCapabilitiesCapability=s,l.mergeExtensionsMetadataMixin=c}),98);
__d("WASmaxOutMessagePublishMixedMetadataMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.paymentsMetadataVersion,n=o("WASmaxJsx").smax("native_flow",null,o("WASmaxJsx").smax("mixed_metadata",null,o("WASmaxJsx").smax("payments_metadata",{version:o("WAWap").INT(t)})));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMixedMetadataMixin=s}),98);
__d("WASmaxOutMessagePublishNativeFlowMessageTypeMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishExtensionsMetadataMixin","WASmaxOutMessagePublishMixedMetadataMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.nativeFlowName,n=e.nativeFlowV,r=e.extensionsMetadataMixinArgs,a=e.mixedMetadataMixinArgs,i=o("WASmaxJsx").smax("interactive",{type:"native_flow"},o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishMixedMetadataMixin").mergeMixedMetadataMixin,o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishExtensionsMetadataMixin").mergeExtensionsMetadataMixin,o("WASmaxJsx").smax("native_flow",{name:o("WAWap").CUSTOM_STRING(t),v:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,n)}),r),a));return i}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeNativeFlowMessageTypeMixin=s}),98);
__d("WASmaxOutMessagePublishInteractiveMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishNativeFlowMessageTypeMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.hasInteractiveV1,n=e.nativeFlowMessageTypeMixinArgs,r=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxOutMessagePublishNativeFlowMessageTypeMixin").mergeNativeFlowMessageTypeMixin(o("WASmaxJsx").smax("interactive",{v:o("WASmaxAttrs").OPTIONAL_LITERAL("1",t)}),n)));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeInteractiveMixin=s}),98);
__d("WASmaxOutMessagePublishNativeFlowMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.bizNativeFlowName,n=e.bizNativeFlowVersion,r=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",{native_flow_name:o("WAWap").CUSTOM_STRING(t),native_flow_version:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,n)}));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeNativeFlowMixin=s}),98);
__d("WASmaxOutMessagePublishButtonsOrNativeFlowOrInteractiveMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishButtonsMixin","WASmaxOutMessagePublishInteractiveMixin","WASmaxOutMessagePublishNativeFlowMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isButtons)return o("WASmaxOutMessagePublishButtonsMixin").mergeButtonsMixin(e);if(t.nativeFlow)return o("WASmaxOutMessagePublishNativeFlowMixin").mergeNativeFlowMixin(e,t.nativeFlow);if(t.interactive)return o("WASmaxOutMessagePublishInteractiveMixin").mergeInteractiveMixin(e,t.interactive);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeButtonsOrNativeFlowOrInteractiveMixinGroup=e}),98);
__d("WASmaxOutMessagePublishConversionRecipientStatusMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.conversionRecipientStatus,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("conversion",{recipient_status:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeConversionRecipientStatusMixin=s}),98);
__d("WASmaxOutMessagePublishClickToWhatsAppAttributionMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.ctwaAttributionElementValue,n=o("WASmaxJsx").smax("ctwa_attribution",null,t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeClickToWhatsAppAttributionMixin=s}),98);
__d("WASmaxOutMessagePublishCtwaAttributionMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishClickToWhatsAppAttributionMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishClickToWhatsAppAttributionMixin").mergeClickToWhatsAppAttributionMixin(o("WASmaxJsx").smax("ctwa_attribution",null),e);return t}function s(t){var n=t.ctwaAttributionArgs,r=o("WASmaxJsx").smax("message",null,o("WASmaxChildren").OPTIONAL_CHILD(e,n));return r}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeCtwaAttributionCtwaAttribution=e,l.mergeCtwaAttributionMixin=u}),98);
__d("WASmaxOutMessagePublishClickToWhatsAppTypeMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.sourceUrlElementValue,n=o("WASmaxJsx").smax("source_url",null,t);return n}function s(t){var n,r,a=t.sourceUrlArgs,i=t.ctwaConversionSource,l=t.ctwaConversionData,s=t.ctwaSourceType,u=t.ctwaEntryPointConversionSource,c=t.ctwaEntryPointConversionApp,d=t.ctwaSignals,m=o("WASmaxJsx").smax("ctwa",{conversion_source:(n=o("WASmaxAttrs")).OPTIONAL((r=o("WAWap")).CUSTOM_STRING,i),conversion_data:n.OPTIONAL(r.CUSTOM_STRING,l),source_type:n.OPTIONAL(r.CUSTOM_STRING,s),entry_point_conversion_source:n.OPTIONAL(r.CUSTOM_STRING,u),entry_point_conversion_app:n.OPTIONAL(r.CUSTOM_STRING,c),signals:n.OPTIONAL(r.CUSTOM_STRING,d)},o("WASmaxChildren").OPTIONAL_CHILD(e,a));return m}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeClickToWhatsAppTypeSourceUrl=e,l.mergeClickToWhatsAppTypeMixin=u}),98);
__d("WASmaxOutMessagePublishCtwaConversionMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishClickToWhatsAppTypeMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishClickToWhatsAppTypeMixin").mergeClickToWhatsAppTypeMixin(o("WASmaxJsx").smax("ctwa",null),e);return t}function s(t){var n=t.ctwaArgs,r=o("WASmaxJsx").smax("message",null,o("WASmaxChildren").OPTIONAL_CHILD(e,n));return r}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeCtwaConversionCtwa=e,l.mergeCtwaConversionMixin=u}),98);
__d("WASmaxOutMessagePublishDeliveryContextMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n,r=e.deliveryContextHsmMaxBid,a=e.deliveryContextOptimizationGoal,i=e.deliveryContextTemplateId,l=e.deliveryContextCampaignId,s=e.deliveryContextSourceType,u=e.deliveryContextTierType,c=e.deliveryContextDeliveryType,d=e.deliveryContextClientToken,m=e.deliveryContextPrice,p=e.deliveryContextWabaId,_=e.deliveryContextQualityFlag,f=e.deliveryContextIsZeroRatedTemplate,g=e.deliveryContextPartnerId,h=e.deliveryContextAppId,y=e.deliveryContextVertical,C=e.deliveryContextBmMessageLimitStatus,b=e.deliveryContextDisableIosAutofill,v=e.deliveryContextAuthBlockRecentRegisters,S=e.deliveryContextMaskLinkedDevicesWithoutResend,R=e.deliveryContextEncryptedDeterministicTemplateId,L=e.deliveryContextShouldBypassIntegrityPhoneLimit,E=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("delivery_context",{hsm_max_bid:(t=o("WASmaxAttrs")).OPTIONAL((n=o("WAWap")).INT,r),optimization_goal:t.OPTIONAL(n.CUSTOM_STRING,a),template_id:t.OPTIONAL(n.CUSTOM_STRING,i),campaign_id:t.OPTIONAL(n.CUSTOM_STRING,l),source_type:t.OPTIONAL(n.CUSTOM_STRING,s),tier_type:t.OPTIONAL(n.CUSTOM_STRING,u),delivery_type:t.OPTIONAL(n.CUSTOM_STRING,c),client_token:t.OPTIONAL(n.CUSTOM_STRING,d),price:t.OPTIONAL(n.INT,m),waba_id:t.OPTIONAL(n.CUSTOM_STRING,p),quality_flag:t.OPTIONAL(n.CUSTOM_STRING,_),is_zero_rated_template:t.OPTIONAL(n.CUSTOM_STRING,f),partner_id:t.OPTIONAL(n.CUSTOM_STRING,g),app_id:t.OPTIONAL(n.CUSTOM_STRING,h),vertical:t.OPTIONAL(n.INT,y),bm_message_limit_status:t.OPTIONAL(n.CUSTOM_STRING,C),disable_ios_autofill:t.OPTIONAL(n.CUSTOM_STRING,b),auth_block_recent_registers:t.OPTIONAL(n.CUSTOM_STRING,v),mask_linked_devices_without_resend:t.OPTIONAL(n.CUSTOM_STRING,S),encrypted_deterministic_template_id:t.OPTIONAL(n.CUSTOM_STRING,R),should_bypass_integrity_phone_limit:t.OPTIONAL(n.CUSTOM_STRING,L)})));return E}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeDeliveryContextMixin=s}),98);
__d("WASmaxOutMessagePublishCapabilitiesMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.hasFeatureV1,n=o("WASmaxJsx").smax("feature",{name:"full_catalog",v:o("WASmaxAttrs").OPTIONAL_LITERAL("1",t)});return n}function s(t){var n=t.featureArgs,r=o("WASmaxJsx").smax("hsm",null,o("WASmaxJsx").smax("capabilities",null,o("WASmaxChildren").OPTIONAL_CHILD(e,n)));return r}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeCapabilitiesCapabilitiesFeature=e,l.mergeCapabilitiesMixin=u}),98);
__d("WASmaxOutMessagePublishHSMReviewMetadataMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n,r=e.anyCategory,a=e.anyTag,i=e.anyId,l=e.anySubTag,s=e.anyLibraryTemplateId,u=e.anyIsTemplateFromLibraryEdited,c=o("WASmaxJsx").smax("smax$any",{category:(t=o("WASmaxAttrs")).OPTIONAL((n=o("WAWap")).CUSTOM_STRING,r),tag:t.OPTIONAL(n.CUSTOM_STRING,a),id:t.OPTIONAL(n.CUSTOM_STRING,i),sub_tag:t.OPTIONAL(n.CUSTOM_STRING,l),library_template_id:t.OPTIONAL(n.CUSTOM_STRING,s),is_template_from_library_edited:t.OPTIONAL(n.CUSTOM_STRING,u)});return c}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeHSMReviewMetadataMixin=s}),98);
__d("WASmaxOutMessagePublishQualityTokenMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.hasQualityTokenV1,n=e.qualityTokenElementValue,r=o("WASmaxJsx").smax("hsm",null,o("WASmaxJsx").smax("quality_token",{v:o("WASmaxAttrs").OPTIONAL_LITERAL("1",t)},n));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeQualityTokenMixin=s}),98);
__d("WASmaxOutMessagePublishHsmMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishCapabilitiesMixin","WASmaxOutMessagePublishHSMReviewMetadataMixin","WASmaxOutMessagePublishQualityTokenMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.messageTtl,r=e.hasHsmV1,a=e.hasHsmButtons1,i=e.hsmObjective,l=e.hSMReviewMetadataMixinArgs,s=e.capabilitiesMixinArgs,u=e.qualityTokenMixinArgs,c=o("WASmaxJsx").smax("message",{ttl:(t=o("WASmaxAttrs")).OPTIONAL(o("WAWap").INT,n)},o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishQualityTokenMixin").mergeQualityTokenMixin,o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishCapabilitiesMixin").mergeCapabilitiesMixin,o("WASmaxOutMessagePublishHSMReviewMetadataMixin").mergeHSMReviewMetadataMixin(o("WASmaxJsx").smax("hsm",{v:t.OPTIONAL_LITERAL("1",r),buttons:t.OPTIONAL_LITERAL("1",a),objective:t.OPTIONAL(o("WAWap").CUSTOM_STRING,i)}),l),s),u));return c}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeHsmMixin=s}),98);
__d("WASmaxOutMessagePublishQualityControlMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.decisionSourceValue,n=o("WASmaxJsx").smax("decision_source",{value:o("WAWap").CUSTOM_STRING(t)});return n}function s(t){var n=t.decisionSourceArgs,r=t.qualityControlSourceType,a=t.qualityControlDecisionId,i=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("quality_control",{source_type:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,r),decision_id:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,a)},o("WASmaxChildren").REPEATED_CHILD(e,n,0,1/0))));return i}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeQualityControlBizQualityControlDecisionSource=e,l.mergeQualityControlMixin=u}),98);
__d("WASmaxOutMessagePublishBizMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishAuthMixin","WASmaxOutMessagePublishBizAcceptTsMixin","WASmaxOutMessagePublishBizAutoResponseMixin","WASmaxOutMessagePublishBizCampaignMixin","WASmaxOutMessagePublishBizEngagementDataMixin","WASmaxOutMessagePublishBizMetadataMixin","WASmaxOutMessagePublishBizPricingDataMixin","WASmaxOutMessagePublishBizRolesMixin","WASmaxOutMessagePublishButtonsOrNativeFlowOrInteractiveMixinGroup","WASmaxOutMessagePublishConversionRecipientStatusMixin","WASmaxOutMessagePublishCtwaAttributionMixin","WASmaxOutMessagePublishCtwaConversionMixin","WASmaxOutMessagePublishDeliveryContextMixin","WASmaxOutMessagePublishHsmMixin","WASmaxOutMessagePublishQualityControlMixin"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.hsmMixinArgs,r=e.bizRolesMixinArgs,a=e.bizAutoResponseMixinArgs,i=e.bizAcceptTsMixinArgs,l=e.bizCampaignMixinArgs,s=e.deliveryContextMixinArgs,u=e.qualityControlMixinArgs,c=e.authMixinArgs,d=e.conversionRecipientStatusMixinArgs,m=e.ctwaConversionMixinArgs,p=e.bizMetadataMixinArgs,_=e.ctwaAttributionMixinArgs,f=e.bizEngagementDataMixinArgs,g=e.bizPricingDataMixinArgs,h=e.buttonsOrNativeFlowOrInteractiveMixinGroupArgs,y=(t=o("WASmaxMixins")).optionalMerge(o("WASmaxOutMessagePublishButtonsOrNativeFlowOrInteractiveMixinGroup").mergeButtonsOrNativeFlowOrInteractiveMixinGroup,t.optionalMerge(o("WASmaxOutMessagePublishBizPricingDataMixin").mergeBizPricingDataMixin,t.optionalMerge(o("WASmaxOutMessagePublishBizEngagementDataMixin").mergeBizEngagementDataMixin,t.optionalMerge(o("WASmaxOutMessagePublishCtwaAttributionMixin").mergeCtwaAttributionMixin,t.optionalMerge(o("WASmaxOutMessagePublishBizMetadataMixin").mergeBizMetadataMixin,t.optionalMerge(o("WASmaxOutMessagePublishCtwaConversionMixin").mergeCtwaConversionMixin,t.optionalMerge(o("WASmaxOutMessagePublishConversionRecipientStatusMixin").mergeConversionRecipientStatusMixin,t.optionalMerge(o("WASmaxOutMessagePublishAuthMixin").mergeAuthMixin,t.optionalMerge(o("WASmaxOutMessagePublishQualityControlMixin").mergeQualityControlMixin,t.optionalMerge(o("WASmaxOutMessagePublishDeliveryContextMixin").mergeDeliveryContextMixin,t.optionalMerge(o("WASmaxOutMessagePublishBizCampaignMixin").mergeBizCampaignMixin,t.optionalMerge(o("WASmaxOutMessagePublishBizAcceptTsMixin").mergeBizAcceptTsMixin,t.optionalMerge(o("WASmaxOutMessagePublishBizAutoResponseMixin").mergeBizAutoResponseMixin,t.optionalMerge(o("WASmaxOutMessagePublishBizRolesMixin").mergeBizRolesMixin,t.optionalMerge(o("WASmaxOutMessagePublishHsmMixin").mergeHsmMixin,o("WASmaxJsx").smax("message",null),n),r),a),i),l),s),u),c),d),m),p),_),f),g),h);return y}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBizMixin=s}),98);
__d("WASmaxOutMessagePublishClientFrankingTagMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.frankingTagElementValue,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("franking",null,o("WASmaxJsx").smax("franking_tag",null,t)));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeClientFrankingTagMixin=s}),98);
__d("WASmaxOutMessagePublishClientReportingTokenMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.reportingTokenV,n=e.reportingTokenElementValue,r=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("reporting",null,o("WASmaxJsx").smax("reporting_token",{v:o("WAWap").INT(t)},n)));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeClientReportingTokenMixin=s}),98);
__d("WASmaxOutMessagePublishDeviceIdentityMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.deviceIdentityElementValue,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("device-identity",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeDeviceIdentityMixin=s}),98);
__d("WASmaxOutMessagePublishInternalTestMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.testConfig,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("test",{config:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeInternalTestMixin=s}),98);
__d("WASmaxOutMessagePublishLIDSessionDeprecationMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaDeprecatedLidSession,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{deprecated_lid_session:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeLIDSessionDeprecationMixin=s}),98);
__d("WASmaxOutMessagePublishMessageAssociationTypeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaMessageAssociationType,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{message_association_type:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMessageAssociationTypeMixin=s}),98);
__d("WASmaxOutMessagePublishMetaHideDecryptionPlaceholderMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("meta",{"decrypt-fail":"hide"}));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeMetaHideDecryptionPlaceholderMixin=s}),98);
__d("WASmaxOutMessagePublishMulticastMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("multicast",null));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeMulticastMixin=s}),98);
__d("WASmaxOutMessagePublishNoExtraFanoutMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{device_fanout:"false"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeNoExtraFanoutMixin=s}),98);
__d("WASmaxOutMessagePublishAnonPaddingMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.taPadElementValue,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("ta_pad",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeAnonPaddingMixin=s}),98);
__d("WASmaxOutMessagePublishWireSizePaddingMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.paddingElementValue,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("padding",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeWireSizePaddingMixin=s}),98);
__d("WASmaxOutMessagePublishPaddingMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishAnonPaddingMixin","WASmaxOutMessagePublishWireSizePaddingMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anonPaddingMixinArgs,n=e.wireSizePaddingMixinArgs,r=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishWireSizePaddingMixin").mergeWireSizePaddingMixin,o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishAnonPaddingMixin").mergeAnonPaddingMixin,o("WASmaxJsx").smax("message",null),t),n);return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePaddingMixin=s}),98);
__d("WASmaxOutMessagePublishPreFilledNumberMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("url_number",null));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergePreFilledNumberMixin=s}),98);
__d("WASmaxOutMessagePublishPreFilledTextMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("url_text",null));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergePreFilledTextMixin=s}),98);
__d("WASmaxOutMessagePublishSenderIntentMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{sender_intent:"hosted"}));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeSenderIntentMixin=s}),98);
__d("WASmaxOutMessagePublishRequestIDMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.requestIdElementValue,n=o("WASmaxJsx").smax("trace",null,o("WASmaxJsx").smax("request_id",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeRequestIDMixin=s}),98);
__d("WASmaxOutMessagePublishTraceIDMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.edgeIdElementValue,n=o("WASmaxJsx").smax("edge_id",null,t);return n}function s(e){var t=e.deviceArgs,n=e.correlationIdType,r=e.idElementValue,a=o("WASmaxJsx").smax("correlation_id",{type:o("WAWap").CUSTOM_STRING(n)},o("WASmaxJsx").smax("id",null,r),o("WASmaxChildren").OPTIONAL_CHILD(c,t));return a}function u(e){var t=e.observabilityFlagsId,n=o("WASmaxJsx").smax("observability_flags",{id:o("WAWap").INT(t)});return n}function c(e){var t=e.deviceId,n=o("WASmaxJsx").smax("device",{id:o("WAWap").INT(t)});return n}function d(t){var n=t.edgeIdArgs,r=t.correlationIdArgs,a=t.observabilityFlagsArgs,i=t.traceIdElementValue,l=o("WASmaxJsx").smax("trace",null,[o("WASmaxJsx").smax("trace_id",null,i),o("WASmaxChildren").OPTIONAL_CHILD(e,n)].concat(o("WASmaxChildren").REPEATED_CHILD(s,r,0,10),[o("WASmaxChildren").OPTIONAL_CHILD(u,a)]));return l}function m(e,t){var n=d(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeTraceIDEdgeId=e,l.makeTraceIDCorrelationId=s,l.makeTraceIDObservabilityFlags=u,l.makeTraceIDCorrelationIdDevice=c,l.mergeTraceIDMixin=m}),98);
__d("WASmaxOutMessagePublishRequestOrTraceIDMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishRequestIDMixin","WASmaxOutMessagePublishTraceIDMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.requestID)return o("WASmaxOutMessagePublishRequestIDMixin").mergeRequestIDMixin(e,t.requestID);if(t.traceID)return o("WASmaxOutMessagePublishTraceIDMixin").mergeTraceIDMixin(e,t.traceID);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeRequestOrTraceIDMixinGroup=e}),98);
__d("WASmaxOutMessagePublishTraceContextMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishRequestOrTraceIDMixinGroup"],(function(t,n,r,o,a,i,l){function e(e){var t=e.requestOrTraceIDMixinGroupArgs,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxOutMessagePublishRequestOrTraceIDMixinGroup").mergeRequestOrTraceIDMixinGroup(o("WASmaxJsx").smax("trace",null),t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeTraceContextMixin=s}),98);
__d("WASmaxOutMessagePublishVerifiedNameNameMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.messageVerifiedName,n=o("WASmaxJsx").smax("message",{verified_name:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeVerifiedNameNameMixin=s}),98);
__d("WASmaxOutMessagePublishWebDriverConfigMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaWebdriverConfig,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{webdriver_config:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeWebDriverConfigMixin=s}),98);
__d("WASmaxOutMessagePublishBaseMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishAutomatedMixin","WASmaxOutMessagePublishBizMixin","WASmaxOutMessagePublishClientFrankingTagMixin","WASmaxOutMessagePublishClientReportingTokenMixin","WASmaxOutMessagePublishDeviceIdentityMixin","WASmaxOutMessagePublishInternalTestMixin","WASmaxOutMessagePublishLIDSessionDeprecationMixin","WASmaxOutMessagePublishMessageAssociationTypeMixin","WASmaxOutMessagePublishMetaHideDecryptionPlaceholderMixin","WASmaxOutMessagePublishMulticastMixin","WASmaxOutMessagePublishNoExtraFanoutMixin","WASmaxOutMessagePublishPaddingMixin","WASmaxOutMessagePublishPreFilledNumberMixin","WASmaxOutMessagePublishPreFilledTextMixin","WASmaxOutMessagePublishSenderIntentMixin","WASmaxOutMessagePublishTraceContextMixin","WASmaxOutMessagePublishVerifiedNameNameMixin","WASmaxOutMessagePublishWebDriverConfigMixin"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.deviceIdentityMixinArgs,r=e.hasNoExtraFanout,a=e.hasMulticast,i=e.hasPreFilledText,l=e.hasPreFilledNumber,s=e.hasAutomated,u=e.bizMixinArgs,c=e.verifiedNameNameMixinArgs,d=e.clientFrankingTagMixinArgs,m=e.clientReportingTokenMixinArgs,p=e.internalTestMixinArgs,_=e.hasMetaHideDecryptionPlaceholder,f=e.traceContextMixinArgs,g=e.hasSenderIntent,h=e.lIDSessionDeprecationMixinArgs,y=e.paddingMixinArgs,C=e.webDriverConfigMixinArgs,b=e.messageAssociationTypeMixinArgs,v=(t=o("WASmaxMixins")).optionalMerge(o("WASmaxOutMessagePublishMessageAssociationTypeMixin").mergeMessageAssociationTypeMixin,t.optionalMerge(o("WASmaxOutMessagePublishWebDriverConfigMixin").mergeWebDriverConfigMixin,t.optionalMerge(o("WASmaxOutMessagePublishPaddingMixin").mergePaddingMixin,t.optionalMerge(o("WASmaxOutMessagePublishLIDSessionDeprecationMixin").mergeLIDSessionDeprecationMixin,t.optionalMerge(o("WASmaxOutMessagePublishSenderIntentMixin").mergeSenderIntentMixin,t.optionalMerge(o("WASmaxOutMessagePublishTraceContextMixin").mergeTraceContextMixin,t.optionalMerge(o("WASmaxOutMessagePublishMetaHideDecryptionPlaceholderMixin").mergeMetaHideDecryptionPlaceholderMixin,t.optionalMerge(o("WASmaxOutMessagePublishInternalTestMixin").mergeInternalTestMixin,t.optionalMerge(o("WASmaxOutMessagePublishClientReportingTokenMixin").mergeClientReportingTokenMixin,t.optionalMerge(o("WASmaxOutMessagePublishClientFrankingTagMixin").mergeClientFrankingTagMixin,t.optionalMerge(o("WASmaxOutMessagePublishVerifiedNameNameMixin").mergeVerifiedNameNameMixin,t.optionalMerge(o("WASmaxOutMessagePublishBizMixin").mergeBizMixin,t.optionalMerge(o("WASmaxOutMessagePublishAutomatedMixin").mergeAutomatedMixin,t.optionalMerge(o("WASmaxOutMessagePublishPreFilledNumberMixin").mergePreFilledNumberMixin,t.optionalMerge(o("WASmaxOutMessagePublishPreFilledTextMixin").mergePreFilledTextMixin,t.optionalMerge(o("WASmaxOutMessagePublishMulticastMixin").mergeMulticastMixin,t.optionalMerge(o("WASmaxOutMessagePublishNoExtraFanoutMixin").mergeNoExtraFanoutMixin,t.optionalMerge(o("WASmaxOutMessagePublishDeviceIdentityMixin").mergeDeviceIdentityMixin,o("WASmaxJsx").smax("message",null),n),r),a),i),l),s),u),c),d),m),p),_),f),g),h),y),C),b);return v}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBaseMixin=s}),98);
__d("WASmaxOutMessagePublishGroupInviteTargetMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaGroupInvite,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{group_invite:o("WAWap").GROUP_JID(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeGroupInviteTargetMixin=s}),98);
__d("WASmaxOutMessagePublishBotFeedbackMessageTypeMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("bot",{type:"feedback"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeBotFeedbackMessageTypeMixin=s}),98);
__d("WASmaxOutMessagePublishEncRetryMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encCount,n=o("WASmaxJsx").smax("enc",{count:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncRetryMixin=s}),98);
__d("WASmaxOutMessagePublishAvatarStickerTypeMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("enc",{sticker_type:"avatar"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeAvatarStickerTypeMixin=s}),98);
__d("WASmaxOutMessagePublishMediaTypeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encMediatype,n=o("WASmaxJsx").smax("enc",{mediatype:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMediaTypeMixin=s}),98);
__d("WASmaxOutMessagePublishEncMediaTypeMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishAvatarStickerTypeMixin","WASmaxOutMessagePublishMediaTypeMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encNativeFlowName,n=e.hasAvatarStickerType,r=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishAvatarStickerTypeMixin").mergeAvatarStickerTypeMixin,o("WASmaxOutMessagePublishMediaTypeMixin").mergeMediaTypeMixin(o("WASmaxJsx").smax("enc",{native_flow_name:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)}),e),n);return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncMediaTypeMixin=s}),98);
__d("WASmaxOutMessagePublishEncPayloadMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encElementValue,n=o("WASmaxJsx").smax("enc",null,t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncPayloadMixin=s}),98);
__d("WASmaxOutMessagePublishEncSessionTypeMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("enc",{session_type:"pq"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeEncSessionTypeMixin=s}),98);
__d("WASmaxOutMessagePublishEncStateMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encState,n=o("WASmaxJsx").smax("enc",{state:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncStateMixin=s}),98);
__d("WASmaxOutMessagePublishEncStateOrSessionTypeMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishEncSessionTypeMixin","WASmaxOutMessagePublishEncStateMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.encState)return o("WASmaxOutMessagePublishEncStateMixin").mergeEncStateMixin(e,t.encState);if(t.isEncSessionType)return o("WASmaxOutMessagePublishEncSessionTypeMixin").mergeEncSessionTypeMixin(e);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeEncStateOrSessionTypeMixinGroup=e}),98);
__d("WASmaxOutMessagePublishEncTypeIndividualMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishEncMediaTypeMixin","WASmaxOutMessagePublishEncPayloadMixin","WASmaxOutMessagePublishEncStateOrSessionTypeMixinGroup","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encType,n=e.encMediaTypeMixinArgs,r=e.encStateOrSessionTypeMixinGroupArgs,a=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishEncStateOrSessionTypeMixinGroup").mergeEncStateOrSessionTypeMixinGroup,o("WASmaxOutMessagePublishEncPayloadMixin").mergeEncPayloadMixin(o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishEncMediaTypeMixin").mergeEncMediaTypeMixin,o("WASmaxJsx").smax("enc",{type:o("WAWap").CUSTOM_STRING(t)}),n),e),r);return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncTypeIndividualMixin=s}),98);
__d("WASmaxOutMessagePublishEncVersion2Mixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("enc",{v:"2"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeEncVersion2Mixin=s}),98);
__d("WASmaxOutMessagePublishEncVersionFutureproofMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encV,n=o("WASmaxJsx").smax("enc",{v:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncVersionFutureproofMixin=s}),98);
__d("WASmaxOutMessagePublishEncVersionBot",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishEncVersion2Mixin","WASmaxOutMessagePublishEncVersionFutureproofMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isEncVersion2)return o("WASmaxOutMessagePublishEncVersion2Mixin").mergeEncVersion2Mixin(e);if(t.encVersionFutureproof)return o("WASmaxOutMessagePublishEncVersionFutureproofMixin").mergeEncVersionFutureproofMixin(e,t.encVersionFutureproof);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeEncVersionBot=e}),98);
__d("WASmaxOutMessagePublishEncLiveLocationDeprecatedMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encDuration,n=o("WASmaxJsx").smax("enc",{mediatype:"livelocation",duration:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncLiveLocationDeprecatedMixin=s}),98);
__d("WASmaxOutMessagePublishEncLiveLocationMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encDuration,n=o("WASmaxJsx").smax("enc",{mediatype:"livelocation",duration:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncLiveLocationMixin=s}),98);
__d("WASmaxOutMessagePublishMediaTypeOrEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishEncLiveLocationDeprecatedMixin","WASmaxOutMessagePublishEncLiveLocationMixin","WASmaxOutMessagePublishMediaTypeMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.mediaType)return o("WASmaxOutMessagePublishMediaTypeMixin").mergeMediaTypeMixin(e,t.mediaType);if(t.encLiveLocation)return o("WASmaxOutMessagePublishEncLiveLocationMixin").mergeEncLiveLocationMixin(e,t.encLiveLocation);if(t.encLiveLocationDeprecated)return o("WASmaxOutMessagePublishEncLiveLocationDeprecatedMixin").mergeEncLiveLocationDeprecatedMixin(e,t.encLiveLocationDeprecated);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeMediaTypeOrEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup=e}),98);
__d("WASmaxOutMessagePublishBotRequestMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishEncRetryMixin","WASmaxOutMessagePublishEncTypeIndividualMixin","WASmaxOutMessagePublishEncVersionBot","WASmaxOutMessagePublishMediaTypeOrEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.toJid,n=e.encRetryMixinArgs,r=e.encTypeIndividualMixinArgs,a=e.encVersionBotArgs,i=e.mediaTypeOrEncLiveLocationOrEncLiveLocationDeprecatedMixinGroupArgs,l=o("WASmaxJsx").smax("to",{jid:o("WAWap").JID(t)},o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishMediaTypeOrEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup").mergeMediaTypeOrEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup,o("WASmaxOutMessagePublishEncVersionBot").mergeEncVersionBot(o("WASmaxOutMessagePublishEncTypeIndividualMixin").mergeEncTypeIndividualMixin(o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishEncRetryMixin").mergeEncRetryMixin,o("WASmaxJsx").smax("enc",null),n),r),a),i));return l}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotRequestMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeMediaMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{type:"media"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeContentTypeMediaMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeTextMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{type:"text"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeContentTypeTextMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeTextOrMediaMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishContentTypeMediaMixin","WASmaxOutMessagePublishContentTypeTextMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isContentTypeText)return o("WASmaxOutMessagePublishContentTypeTextMixin").mergeContentTypeTextMixin(e);if(t.isContentTypeMedia)return o("WASmaxOutMessagePublishContentTypeMediaMixin").mergeContentTypeMediaMixin(e);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeContentTypeTextOrMediaMixinGroup=e}),98);
__d("WASmaxOutMessagePublishBotMetricsEntryPointMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaOrigin,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{origin:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotMetricsEntryPointMixin=s}),98);
__d("WASmaxOutMessagePublishBotClientMultiThreadIDMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botClientThreadId,n=o("WASmaxJsx").smax("bot",{client_thread_id:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotClientMultiThreadIDMixin=s}),98);
__d("WASmaxOutMessagePublishBotConversationThreadIDMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botConversationThreadId,n=o("WASmaxJsx").smax("bot",{conversation_thread_id:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotConversationThreadIDMixin=s}),98);
__d("WASmaxOutMessagePublishBotClientMultiThreadIDMessageMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBotClientMultiThreadIDMixin","WASmaxOutMessagePublishBotConversationThreadIDMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botClientMultiThreadIDMixinArgs,n=e.botConversationThreadIDMixinArgs,r=o("WASmaxJsx").smax("message",null,o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishBotConversationThreadIDMixin").mergeBotConversationThreadIDMixin,o("WASmaxOutMessagePublishBotClientMultiThreadIDMixin").mergeBotClientMultiThreadIDMixin(o("WASmaxJsx").smax("bot",null),t),n));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotClientMultiThreadIDMessageMixin=s}),98);
__d("WASmaxOutMessagePublishBotLocalAutomatedTypeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botLocalAutomatedType,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("bot",{local_automated_type:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotLocalAutomatedTypeMixin=s}),98);
__d("WASmaxOutMessagePublishBotMessageTypeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botType,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("bot",{type:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotMessageTypeMixin=s}),98);
__d("WASmaxOutMessagePublishBotMetricsThreadEntryPointMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaThreadOrigin,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{thread_origin:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotMetricsThreadEntryPointMixin=s}),98);
__d("WASmaxOutMessagePublishBotModeSelectionMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botModeSelection,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("bot",{mode_selection:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotModeSelectionMixin=s}),98);
__d("WASmaxOutMessagePublishBotPersonaTypeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botPersonaType,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("bot",{persona_type:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotPersonaTypeMixin=s}),98);
__d("WASmaxOutMessagePublishBusinessBotMessageFeedbackRequestedMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botFeedbackRequested,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("bot",{feedback_requested:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBusinessBotMessageFeedbackRequestedMixin=s}),98);
__d("WASmaxOutMessagePublishBusinessBotMessageMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.botBizBot,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("bot",{biz_bot:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBusinessBotMessageMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeEventMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaEventType,n=o("WASmaxJsx").smax("message",{type:"event"},o("WASmaxJsx").smax("meta",{event_type:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeContentTypeEventMixin=s}),98);
__d("WASmaxOutMessagePublishProductListMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("list",{type:"product_list"})));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeProductListMixin=s}),98);
__d("WASmaxOutMessagePublishSingleSelectListMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.listV,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("biz",null,o("WASmaxJsx").smax("list",{type:"single_select",v:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)})));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeSingleSelectListMixin=s}),98);
__d("WASmaxOutMessagePublishSingleSelectOrProductListMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishProductListMixin","WASmaxOutMessagePublishSingleSelectListMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.singleSelectList)return o("WASmaxOutMessagePublishSingleSelectListMixin").mergeSingleSelectListMixin(e,t.singleSelectList);if(t.isProductList)return o("WASmaxOutMessagePublishProductListMixin").mergeProductListMixin(e);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeSingleSelectOrProductListMixinGroup=e}),98);
__d("WASmaxOutMessagePublishContentTypeListFanoutMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaMixin","WASmaxOutMessagePublishSingleSelectOrProductListMixinGroup"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("to",null,o("WASmaxJsx").smax("enc",{mediatype:"list"}));return e}function s(t){var n=t.toCount,r=t.singleSelectOrProductListMixinGroupArgs,a=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishSingleSelectOrProductListMixinGroup").mergeSingleSelectOrProductListMixinGroup,o("WASmaxOutMessagePublishContentTypeMediaMixin").mergeContentTypeMediaMixin(o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").HOMOGENEOUS_CHILD_COUNT(e,n)))),r);return a}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeContentTypeListFanoutParticipantsTo=e,l.mergeContentTypeListFanoutMixin=u}),98);
__d("WASmaxOutMessagePublishLiveLocationModeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaLivelocMode,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{liveloc_mode:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeLiveLocationModeMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeLiveLocationFanoutMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaMixin","WASmaxOutMessagePublishLiveLocationModeMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encDuration,n=o("WASmaxJsx").smax("to",null,o("WASmaxJsx").smax("enc",{mediatype:"livelocation",duration:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,t)}));return n}function s(t){var n=t.toArgs,r=t.liveLocationModeMixinArgs,a=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishLiveLocationModeMixin").mergeLiveLocationModeMixin,o("WASmaxOutMessagePublishContentTypeMediaMixin").mergeContentTypeMediaMixin(o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").HOMOGENEOUS_CHILD(e,n)))),r);return a}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeContentTypeLiveLocationFanoutParticipantsTo=e,l.mergeContentTypeLiveLocationFanoutMixin=u}),98);
__d("WASmaxOutMessagePublishContentTypeMedianotifyMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{type:"medianotify"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeContentTypeMedianotifyMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeMediaOrMedianotifyMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishContentTypeMediaMixin","WASmaxOutMessagePublishContentTypeMedianotifyMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isContentTypeMedia)return o("WASmaxOutMessagePublishContentTypeMediaMixin").mergeContentTypeMediaMixin(e);if(t.isContentTypeMedianotify)return o("WASmaxOutMessagePublishContentTypeMedianotifyMixin").mergeContentTypeMedianotifyMixin(e);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeContentTypeMediaOrMedianotifyMixinGroup=e}),98);
__d("WASmaxOutMessagePublishSenderContentBindingMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.senderContentBindingElementValue,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("sender_content_binding",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeSenderContentBindingMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeMediaFanoutDeprecatedMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaOrMedianotifyMixinGroup","WASmaxOutMessagePublishSenderContentBindingMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encMediatype,n=e.hasEncStickerTypeAvatar,r=e.encNativeFlowName,a=o("WASmaxJsx").smax("to",null,o("WASmaxJsx").smax("enc",{mediatype:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t),sticker_type:o("WASmaxAttrs").OPTIONAL_LITERAL("avatar",n),native_flow_name:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,r)}));return a}function s(t){var n=t.toArgs,r=t.senderContentBindingMixinArgs,a=t.contentTypeMediaOrMedianotifyMixinGroupArgs,i=o("WASmaxOutMessagePublishContentTypeMediaOrMedianotifyMixinGroup").mergeContentTypeMediaOrMedianotifyMixinGroup(o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishSenderContentBindingMixin").mergeSenderContentBindingMixin,o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").HOMOGENEOUS_CHILD(e,n))),r),a);return i}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeContentTypeMediaFanoutDeprecatedParticipantsTo=e,l.mergeContentTypeMediaFanoutDeprecatedMixin=u}),98);
__d("WASmaxOutMessagePublishContentTypeMediaFanoutMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaOrMedianotifyMixinGroup","WASmaxOutMessagePublishSenderContentBindingMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encMediatype,n=e.hasEncStickerTypeAvatar,r=e.encNativeFlowName,a=o("WASmaxJsx").smax("to",null,o("WASmaxJsx").smax("enc",{mediatype:o("WAWap").CUSTOM_STRING(t),sticker_type:o("WASmaxAttrs").OPTIONAL_LITERAL("avatar",n),native_flow_name:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,r)}));return a}function s(t){var n=t.toArgs,r=t.senderContentBindingMixinArgs,a=t.contentTypeMediaOrMedianotifyMixinGroupArgs,i=o("WASmaxOutMessagePublishContentTypeMediaOrMedianotifyMixinGroup").mergeContentTypeMediaOrMedianotifyMixinGroup(o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishSenderContentBindingMixin").mergeSenderContentBindingMixin,o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").HOMOGENEOUS_CHILD(e,n))),r),a);return i}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeContentTypeMediaFanoutParticipantsTo=e,l.mergeContentTypeMediaFanoutMixin=u}),98);
__d("WASmaxOutMessagePublishContentTypePollCreationMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaContenttype,n=o("WASmaxJsx").smax("message",{type:"poll"},o("WASmaxJsx").smax("meta",{polltype:"creation",contenttype:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeContentTypePollCreationMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypePollResultSnapshotMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{type:"poll"},o("WASmaxJsx").smax("meta",{polltype:"result_snapshot"}));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeContentTypePollResultSnapshotMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypePollVoteMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaContenttype,n=o("WASmaxJsx").smax("message",{type:"poll"},o("WASmaxJsx").smax("meta",{polltype:"vote",contenttype:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeContentTypePollVoteMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeReactionMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{type:"reaction"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeContentTypeReactionMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypePayMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{type:"pay"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeContentTypePayMixin=s}),98);
__d("WASmaxOutMessagePublishPayNodeTypeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.payType,n=o("WASmaxJsx").smax("pay",{type:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePayNodeTypeMixin=s}),98);
__d("WASmaxOutMessagePublishBasePayNodeMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishPayNodeTypeMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.payCountry,n=e.payVersion,r=e.payIsFirstSend,a=o("WASmaxOutMessagePublishPayNodeTypeMixin").mergePayNodeTypeMixin(o("WASmaxJsx").smax("pay",{country:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t),version:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,n),is_first_send:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,r)}),e);return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBasePayNodeMixin=s}),98);
__d("WASmaxOutMessagePublishLegacyAmountMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.payCurrency,n=e.payAmount,r=o("WASmaxJsx").smax("pay",{currency:o("WAWap").CUSTOM_STRING(t),amount:o("WAWap").CUSTOM_STRING(n)});return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeLegacyAmountMixin=s}),98);
__d("WASmaxOutMessagePublishMoneyMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.moneyValue,n=e.moneyOffset,r=e.moneyCurrency,a=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("money",{value:o("WAWap").CUSTOM_STRING(t),offset:o("WAWap").CUSTOM_STRING(n),currency:o("WAWap").CUSTOM_STRING(r)}));return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMoneyMixin=s}),98);
__d("WASmaxOutMessagePublishBaseIndividualPublishSendPayNodeMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBasePayNodeMixin","WASmaxOutMessagePublishLegacyAmountMixin","WASmaxOutMessagePublishMoneyMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishMoneyMixin").mergeMoneyMixin(o("WASmaxJsx").smax("amount",null),e);return t}function s(t){var n=t.amountArgs,r=t.payCredentialId,a=t.payDeviceId,i=t.payRequestId,l=t.legacyAmountMixinArgs,s=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishLegacyAmountMixin").mergeLegacyAmountMixin,o("WASmaxOutMessagePublishBasePayNodeMixin").mergeBasePayNodeMixin(o("WASmaxJsx").smax("pay",{"credential-id":o("WAWap").CUSTOM_STRING(r),"device-id":o("WAWap").CUSTOM_STRING(a),"request-id":o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,i)},o("WASmaxChildren").OPTIONAL_CHILD(e,n)),t),l);return s}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeBaseIndividualPublishSendPayNodeAmount=e,l.mergeBaseIndividualPublishSendPayNodeMixin=u}),98);
__d("WASmaxOutMessagePublishInstallmentMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishMoneyMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishMoneyMixin").mergeMoneyMixin(o("WASmaxJsx").smax("due_amount",null),e);return t}function s(e){var t=o("WASmaxOutMessagePublishMoneyMixin").mergeMoneyMixin(o("WASmaxJsx").smax("interest",null),e);return t}function u(t){var n=t.dueAmountArgs,r=t.interestArgs,a=t.installmentMaxCount,i=t.installmentSelectedCount,l=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("installment",{max_count:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,a),selected_count:o("WAWap").INT(i)},o("WASmaxChildren").OPTIONAL_CHILD(e,n),o("WASmaxChildren").OPTIONAL_CHILD(s,r)));return l}function c(e,t){var n=u(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeInstallmentInstallmentDueAmount=e,l.makeInstallmentInstallmentInterest=s,l.mergeInstallmentMixin=c}),98);
__d("WASmaxOutMessagePublishBeneficiaryMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n,r=e.beneficiaryName,a=e.beneficiaryAddressLine1,i=e.beneficiaryAddressLine2,l=e.beneficiaryCity,s=e.beneficiaryState,u=e.beneficiaryPhoneNumber,c=e.beneficiaryCountry,d=e.beneficiaryPostalCode,m=o("WASmaxJsx").smax("beneficiary",{name:(t=o("WAWap")).CUSTOM_STRING(r),address_line1:t.CUSTOM_STRING(a),address_line2:(n=o("WASmaxAttrs")).OPTIONAL(t.CUSTOM_STRING,i),city:n.OPTIONAL(t.CUSTOM_STRING,l),state:n.OPTIONAL(t.CUSTOM_STRING,s),phone_number:n.OPTIONAL(t.CUSTOM_STRING,u),country:t.CUSTOM_STRING(c),postal_code:t.CUSTOM_STRING(d)});return m}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBeneficiaryMixin=s}),98);
__d("WASmaxOutMessagePublishBeneficiariesMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBeneficiaryMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishBeneficiaryMixin").mergeBeneficiaryMixin(o("WASmaxJsx").smax("beneficiary",null),e);return t}function s(t){var n=t.beneficiaryArgs,r=o("WASmaxJsx").smax("smax$any",null,o("WASmaxChildren").REPEATED_CHILD(e,n,1,5));return r}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeBeneficiariesBeneficiary=e,l.mergeBeneficiariesMixin=u}),98);
__d("WASmaxOutMessagePublishOrderInPaymentMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBeneficiariesMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishBeneficiariesMixin").mergeBeneficiariesMixin(o("WASmaxJsx").smax("beneficiaries",null),e);return t}function s(t){var n,r=t.beneficiariesArgs,a=t.orderId,i=t.orderMessageId,l=t.orderPaymentConfigId,s=t.orderType,u=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("order",{id:(n=o("WAWap")).CUSTOM_STRING(a),message_id:o("WASmaxAttrs").OPTIONAL(n.STANZA_ID,i),payment_config_id:o("WASmaxAttrs").OPTIONAL(n.CUSTOM_STRING,l),type:o("WASmaxAttrs").OPTIONAL(n.CUSTOM_STRING,s)},o("WASmaxChildren").OPTIONAL_CHILD(e,r)));return u}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeOrderInPaymentOrderBeneficiaries=e,l.mergeOrderInPaymentMixin=u}),98);
__d("WASmaxOutMessagePublishPaymentInitiatorMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyPaymentInitiator,n=o("WASmaxJsx").smax("smax$any",{payment_initiator:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePaymentInitiatorMixin=s}),98);
__d("WASmaxOutMessagePublishBRPublishSendPayNodeP2MMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishInstallmentMixin","WASmaxOutMessagePublishOrderInPaymentMixin","WASmaxOutMessagePublishPaymentInitiatorMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.orderInPaymentMixinArgs,n=e.paymentInitiatorMixinArgs,r=e.installmentMixinArgs,a=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishInstallmentMixin").mergeInstallmentMixin,o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishPaymentInitiatorMixin").mergePaymentInitiatorMixin,o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishOrderInPaymentMixin").mergeOrderInPaymentMixin,o("WASmaxJsx").smax("pay",{"transaction-type":"p2m"}),t),n),r);return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBRPublishSendPayNodeP2MMixin=s}),98);
__d("WASmaxOutMessagePublishBRPublishSendPayNodeP2PMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("pay",{"transaction-type":"p2p"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeBRPublishSendPayNodeP2PMixin=s}),98);
__d("WASmaxOutMessagePublishBRPublishSendPayNodeP2POrMMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishBRPublishSendPayNodeP2MMixin","WASmaxOutMessagePublishBRPublishSendPayNodeP2PMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isBRPublishSendPayNodeP2P)return o("WASmaxOutMessagePublishBRPublishSendPayNodeP2PMixin").mergeBRPublishSendPayNodeP2PMixin(e);if(t.bRPublishSendPayNodeP2M)return o("WASmaxOutMessagePublishBRPublishSendPayNodeP2MMixin").mergeBRPublishSendPayNodeP2MMixin(e,t.bRPublishSendPayNodeP2M);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeBRPublishSendPayNodeP2POrMMixinGroup=e}),98);
__d("WASmaxOutMessagePublishBRSendPayEloNodeMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.eloDeviceSignature,r=e.eloWalletSignature,a=e.eloChallengeId,i=e.eloCardholderVerificationMethod,l=o("WASmaxJsx").smax("pay",null,o("WASmaxJsx").smax("elo",{device_signature:(t=o("WAWap")).CUSTOM_STRING(n),wallet_signature:t.CUSTOM_STRING(r),challenge_id:t.CUSTOM_STRING(a),cardholder_verification_method:t.CUSTOM_STRING(i)}));return l}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBRSendPayEloNodeMixin=s}),98);
__d("WASmaxOutMessagePublishBRPublishSendPayNodeMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBRPublishSendPayNodeP2POrMMixinGroup","WASmaxOutMessagePublishBRSendPayEloNodeMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.payId,r=e.payPaymentRails,a=e.payTrustedDeviceInfo,i=e.payNonce,l=e.bRSendPayEloNodeMixinArgs,s=e.bRPublishSendPayNodeP2POrMMixinGroupArgs,u=o("WASmaxOutMessagePublishBRPublishSendPayNodeP2POrMMixinGroup").mergeBRPublishSendPayNodeP2POrMMixinGroup(o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishBRSendPayEloNodeMixin").mergeBRSendPayEloNodeMixin,o("WASmaxJsx").smax("pay",{id:(t=o("WAWap")).CUSTOM_STRING(n),"payment-rails":t.CUSTOM_STRING(r),"trusted-device-info":t.CUSTOM_STRING(a),nonce:t.CUSTOM_STRING(i)}),l),s);return u}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBRPublishSendPayNodeMixin=s}),98);
__d("WASmaxOutMessagePublishUPILiteDetailsMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.upiLiteDetailsLiteReferenceNumber,r=e.upiLiteDetailsLiteArqc,a=e.upiLiteDetailsLiteTimestamp,i=e.upiLiteDetailsLitePurpose,l=o("WASmaxJsx").smax("upi_lite_details",{lite_reference_number:(t=o("WAWap")).CUSTOM_STRING(n),lite_arqc:t.CUSTOM_STRING(r),lite_timestamp:t.INT(a),lite_purpose:t.CUSTOM_STRING(i)});return l}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeUPILiteDetailsMixin=s}),98);
__d("WASmaxOutMessagePublishOrderMessageMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n,r=e.orderOrderId,a=e.orderOrderMessageId,i=e.orderExpiryTs,l=e.orderOrderType,s=e.orderDiscountProgramName,u=o("WASmaxJsx").smax("order",{"order-id":(t=o("WAWap")).CUSTOM_STRING(r),"order-message-id":(n=o("WASmaxAttrs")).OPTIONAL(t.CUSTOM_STRING,a),"expiry-ts":n.OPTIONAL(t.INT,i),"order-type":n.OPTIONAL(t.CUSTOM_STRING,l),"discount-program-name":n.OPTIONAL(t.CUSTOM_STRING,s)});return u}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeOrderMessageMixin=s}),98);
__d("WASmaxOutMessagePublishUPIPublishSendPayNodeP2MMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishOrderMessageMixin","WASmaxOutMessagePublishPaymentInitiatorMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.orderArgs,n=e.paymentLinkArgs,r=o("WASmaxJsx").smax("upi",null,o("WASmaxChildren").OPTIONAL_CHILD(s,t),o("WASmaxChildren").OPTIONAL_CHILD(u,n));return r}function s(e){var t=o("WASmaxOutMessagePublishOrderMessageMixin").mergeOrderMessageMixin(o("WASmaxJsx").smax("order",null),e);return t}function u(e){var t=e.paymentLinkOrderId,n=e.paymentLinkMessageId,r=o("WASmaxJsx").smax("payment_link",{order_id:o("WAWap").CUSTOM_STRING(t),message_id:o("WAWap").CUSTOM_STRING(n)});return r}function c(t){var n=t.upiArgs,r=t.paymentInitiatorMixinArgs,a=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishPaymentInitiatorMixin").mergePaymentInitiatorMixin,o("WASmaxJsx").smax("pay",{"transaction-type":"p2m"},o("WASmaxChildren").OPTIONAL_CHILD(e,n)),r);return a}function d(e,t){var n=c(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeUPIPublishSendPayNodeP2MUpi=e,l.makeUPIPublishSendPayNodeP2MUpiOrder=s,l.makeUPIPublishSendPayNodeP2MUpiPaymentLink=u,l.mergeUPIPublishSendPayNodeP2MMixin=d}),98);
__d("WASmaxOutMessagePublishUPIPublishSendPayNodeP2PMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.hasPayTransactionTypeP2P,n=o("WASmaxJsx").smax("pay",{"transaction-type":o("WASmaxAttrs").OPTIONAL_LITERAL("p2p",t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeUPIPublishSendPayNodeP2PMixin=s}),98);
__d("WASmaxOutMessagePublishUPIPublishSendPayNodeP2POrMMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishUPIPublishSendPayNodeP2MMixin","WASmaxOutMessagePublishUPIPublishSendPayNodeP2PMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.uPIPublishSendPayNodeP2P)return o("WASmaxOutMessagePublishUPIPublishSendPayNodeP2PMixin").mergeUPIPublishSendPayNodeP2PMixin(e,t.uPIPublishSendPayNodeP2P);if(t.uPIPublishSendPayNodeP2M)return o("WASmaxOutMessagePublishUPIPublishSendPayNodeP2MMixin").mergeUPIPublishSendPayNodeP2MMixin(e,t.uPIPublishSendPayNodeP2M);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeUPIPublishSendPayNodeP2POrMMixinGroup=e}),98);
__d("WASmaxOutMessagePublishUPIPublishSendPayNodeMixin",["WASmaxAttrs","WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishUPILiteDetailsMixin","WASmaxOutMessagePublishUPIPublishSendPayNodeP2POrMMixinGroup","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.upiLiteDetailsArgs,n=e.upiToken,r=o("WASmaxJsx").smax("upi",{token:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,n)},o("WASmaxChildren").OPTIONAL_CHILD(s,t));return r}function s(e){var t=o("WASmaxOutMessagePublishUPILiteDetailsMixin").mergeUPILiteDetailsMixin(o("WASmaxJsx").smax("upi_lite_details",null),e);return t}function u(t){var n,r,a=t.upiArgs,i=t.payId,l=t.payMpin,s=t.payReceiverVpa,u=t.payReceiverVpaId,c=t.payReceiverName,d=t.paySenderVpa,m=t.paySenderVpaId,p=t.paySenderName,_=t.paySeqNo,f=t.payUpiBankInfo,g=t.payMode,h=t.payPurposeCode,y=t.payMcc,C=t.payRefId,b=t.payDeviceSsid,v=t.payNote,S=t.uPIPublishSendPayNodeP2POrMMixinGroupArgs,R=o("WASmaxOutMessagePublishUPIPublishSendPayNodeP2POrMMixinGroup").mergeUPIPublishSendPayNodeP2POrMMixinGroup(o("WASmaxJsx").smax("pay",{id:(n=o("WASmaxAttrs")).OPTIONAL((r=o("WAWap")).CUSTOM_STRING,i),mpin:n.OPTIONAL(r.CUSTOM_STRING,l),"receiver-vpa":r.CUSTOM_STRING(s),"receiver-vpa-id":n.OPTIONAL(r.CUSTOM_STRING,u),"receiver-name":n.OPTIONAL(r.CUSTOM_STRING,c),"sender-vpa":r.CUSTOM_STRING(d),"sender-vpa-id":n.OPTIONAL(r.CUSTOM_STRING,m),"sender-name":n.OPTIONAL(r.CUSTOM_STRING,p),"seq-no":r.CUSTOM_STRING(_),"upi-bank-info":r.CUSTOM_STRING(f),mode:n.OPTIONAL(r.CUSTOM_STRING,g),"purpose-code":n.OPTIONAL(r.CUSTOM_STRING,h),mcc:n.OPTIONAL(r.CUSTOM_STRING,y),"ref-id":n.OPTIONAL(r.CUSTOM_STRING,C),device_ssid:n.OPTIONAL(r.CUSTOM_STRING,b),note:n.OPTIONAL(r.CUSTOM_STRING,v)},o("WASmaxChildren").OPTIONAL_CHILD(e,a)),S);return R}function c(e,t){var n=u(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeUPIPublishSendPayNodeUpi=e,l.makeUPIPublishSendPayNodeUpiUpiLiteDetails=s,l.mergeUPIPublishSendPayNodeMixin=c}),98);
__d("WASmaxOutMessagePublishBRPublishOrUPIPublishSendPayNodeMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishBRPublishSendPayNodeMixin","WASmaxOutMessagePublishUPIPublishSendPayNodeMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.bRPublishSendPayNode)return o("WASmaxOutMessagePublishBRPublishSendPayNodeMixin").mergeBRPublishSendPayNodeMixin(e,t.bRPublishSendPayNode);if(t.uPIPublishSendPayNode)return o("WASmaxOutMessagePublishUPIPublishSendPayNodeMixin").mergeUPIPublishSendPayNodeMixin(e,t.uPIPublishSendPayNode);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeBRPublishOrUPIPublishSendPayNodeMixinGroup=e}),98);
__d("WASmaxOutMessagePublishIntegrationPublishPayNodeMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBRPublishOrUPIPublishSendPayNodeMixinGroup"],(function(t,n,r,o,a,i,l){function e(e){var t=e.bRPublishOrUPIPublishSendPayNodeMixinGroupArgs,n=o("WASmaxOutMessagePublishBRPublishOrUPIPublishSendPayNodeMixinGroup").mergeBRPublishOrUPIPublishSendPayNodeMixinGroup(o("WASmaxJsx").smax("pay",null),t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIntegrationPublishPayNodeMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualNonNoviPublishSendPayNodeMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBaseIndividualPublishSendPayNodeMixin","WASmaxOutMessagePublishIntegrationPublishPayNodeMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishIntegrationPublishPayNodeMixin").mergeIntegrationPublishPayNodeMixin(o("WASmaxOutMessagePublishBaseIndividualPublishSendPayNodeMixin").mergeBaseIndividualPublishSendPayNodeMixin(o("WASmaxJsx").smax("pay",null),e),e);return t}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualNonNoviPublishSendPayNodeMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualPublishSendPayNodeMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishIndividualNonNoviPublishSendPayNodeMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishIndividualNonNoviPublishSendPayNodeMixin").mergeIndividualNonNoviPublishSendPayNodeMixin(o("WASmaxJsx").smax("pay",null),e);return t}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualPublishSendPayNodeMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualRequestPayNodeMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBasePayNodeMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.paySender,n=e.payExpiryTs,r=e.payRequestId,a=o("WASmaxOutMessagePublishBasePayNodeMixin").mergeBasePayNodeMixin(o("WASmaxJsx").smax("pay",{sender:o("WASmaxAttrs").OPTIONAL(o("WAWap").USER_JID,t),"expiry-ts":o("WAWap").CUSTOM_STRING(n),"request-id":o("WAWap").CUSTOM_STRING(r)}),e);return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualRequestPayNodeMixin=s}),98);
__d("WASmaxOutMessagePublishPayInviteNodeMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.payService,n=o("WASmaxJsx").smax("pay",{type:"invite",service:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePayInviteNodeMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualPublishSendPayOrIndividualRequestPayOrPayInviteNodeMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishIndividualPublishSendPayNodeMixin","WASmaxOutMessagePublishIndividualRequestPayNodeMixin","WASmaxOutMessagePublishPayInviteNodeMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.individualPublishSendPayNode)return o("WASmaxOutMessagePublishIndividualPublishSendPayNodeMixin").mergeIndividualPublishSendPayNodeMixin(e,t.individualPublishSendPayNode);if(t.individualRequestPayNode)return o("WASmaxOutMessagePublishIndividualRequestPayNodeMixin").mergeIndividualRequestPayNodeMixin(e,t.individualRequestPayNode);if(t.payInviteNode)return o("WASmaxOutMessagePublishPayInviteNodeMixin").mergePayInviteNodeMixin(e,t.payInviteNode);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeIndividualPublishSendPayOrIndividualRequestPayOrPayInviteNodeMixinGroup=e}),98);
__d("WASmaxOutMessagePublishIndividualPublishPayNodeMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishIndividualPublishSendPayOrIndividualRequestPayOrPayInviteNodeMixinGroup"],(function(t,n,r,o,a,i,l){function e(e){var t=e.individualPublishSendPayOrIndividualRequestPayOrPayInviteNodeMixinGroupArgs,n=o("WASmaxOutMessagePublishIndividualPublishSendPayOrIndividualRequestPayOrPayInviteNodeMixinGroup").mergeIndividualPublishSendPayOrIndividualRequestPayOrPayInviteNodeMixinGroup(o("WASmaxJsx").smax("pay",null),t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualPublishPayNodeMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualIndividualPublishPayNodeMessageMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishIndividualPublishPayNodeMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxJsx").smax("message",null,o("WASmaxOutMessagePublishIndividualPublishPayNodeMixin").mergeIndividualPublishPayNodeMixin(o("WASmaxJsx").smax("pay",null),e));return t}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualIndividualPublishPayNodeMessageMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualContentTypePayIndividualMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypePayMixin","WASmaxOutMessagePublishIndividualIndividualPublishPayNodeMessageMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.individualIndividualPublishPayNodeMessageMixinArgs,n=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishIndividualIndividualPublishPayNodeMessageMixin").mergeIndividualIndividualPublishPayNodeMessageMixin,o("WASmaxOutMessagePublishContentTypePayMixin").mergeContentTypePayMixin(o("WASmaxJsx").smax("message",null)),t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualContentTypePayIndividualMixin=s}),98);
__d("WASmaxOutMessagePublishContentFanoutMixins",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishContentTypeEventMixin","WASmaxOutMessagePublishContentTypeListFanoutMixin","WASmaxOutMessagePublishContentTypeLiveLocationFanoutMixin","WASmaxOutMessagePublishContentTypeMediaFanoutDeprecatedMixin","WASmaxOutMessagePublishContentTypeMediaFanoutMixin","WASmaxOutMessagePublishContentTypeMedianotifyMixin","WASmaxOutMessagePublishContentTypePollCreationMixin","WASmaxOutMessagePublishContentTypePollResultSnapshotMixin","WASmaxOutMessagePublishContentTypePollVoteMixin","WASmaxOutMessagePublishContentTypeReactionMixin","WASmaxOutMessagePublishContentTypeTextMixin","WASmaxOutMessagePublishIndividualContentTypePayIndividualMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isContentTypeText)return o("WASmaxOutMessagePublishContentTypeTextMixin").mergeContentTypeTextMixin(e);if(t.contentTypeMediaFanout)return o("WASmaxOutMessagePublishContentTypeMediaFanoutMixin").mergeContentTypeMediaFanoutMixin(e,t.contentTypeMediaFanout);if(t.contentTypeMediaFanoutDeprecated)return o("WASmaxOutMessagePublishContentTypeMediaFanoutDeprecatedMixin").mergeContentTypeMediaFanoutDeprecatedMixin(e,t.contentTypeMediaFanoutDeprecated);if(t.contentTypeLiveLocationFanout)return o("WASmaxOutMessagePublishContentTypeLiveLocationFanoutMixin").mergeContentTypeLiveLocationFanoutMixin(e,t.contentTypeLiveLocationFanout);if(t.individualContentTypePayIndividual)return o("WASmaxOutMessagePublishIndividualContentTypePayIndividualMixin").mergeIndividualContentTypePayIndividualMixin(e,t.individualContentTypePayIndividual);if(t.contentTypeListFanout)return o("WASmaxOutMessagePublishContentTypeListFanoutMixin").mergeContentTypeListFanoutMixin(e,t.contentTypeListFanout);if(t.isContentTypeReaction)return o("WASmaxOutMessagePublishContentTypeReactionMixin").mergeContentTypeReactionMixin(e);if(t.contentTypePollCreation)return o("WASmaxOutMessagePublishContentTypePollCreationMixin").mergeContentTypePollCreationMixin(e,t.contentTypePollCreation);if(t.contentTypePollVote)return o("WASmaxOutMessagePublishContentTypePollVoteMixin").mergeContentTypePollVoteMixin(e,t.contentTypePollVote);if(t.isContentTypePollResultSnapshot)return o("WASmaxOutMessagePublishContentTypePollResultSnapshotMixin").mergeContentTypePollResultSnapshotMixin(e);if(t.isContentTypeMedianotify)return o("WASmaxOutMessagePublishContentTypeMedianotifyMixin").mergeContentTypeMedianotifyMixin(e);if(t.contentTypeEvent)return o("WASmaxOutMessagePublishContentTypeEventMixin").mergeContentTypeEventMixin(e,t.contentTypeEvent);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeContentFanoutMixins=e}),98);
__d("WASmaxOutMessagePublishLidChatOriginMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{origin:"ctwa"}));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeLidChatOriginMixin=s}),98);
__d("WASmaxOutMessagePublishMsgMetaOriginMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaOrigin,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{origin:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMsgMetaOriginMixin=s}),98);
__d("WASmaxOutMessagePublishPeripheralOriginMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaPeripheral,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{peripheral:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePeripheralOriginMixin=s}),98);
__d("WASmaxOutMessagePublishTDeprecatedMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.messageT,n=o("WASmaxJsx").smax("message",{t:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeTDeprecatedMixin=s}),98);
__d("WASmaxOutMessagePublishToContentBindingMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.toJid,n=e.contentBindingElementValue,r=o("WASmaxJsx").smax("to",{jid:o("WAWap").JID(t)},o("WASmaxJsx").smax("content_binding",null,n));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeToContentBindingMixin=s}),98);
__d("WASmaxOutMessagePublishEncMediaTypeDeprecatedMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishAvatarStickerTypeMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encMediatype,n=e.encNativeFlowName,r=e.hasAvatarStickerType,a=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishAvatarStickerTypeMixin").mergeAvatarStickerTypeMixin,o("WASmaxJsx").smax("enc",{mediatype:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t),native_flow_name:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,n)}),r);return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncMediaTypeDeprecatedMixin=s}),98);
__d("WASmaxOutMessagePublishEncVersion3Mixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("enc",{v:"3"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeEncVersion3Mixin=s}),98);
__d("WASmaxOutMessagePublishEncVersion",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishEncVersion2Mixin","WASmaxOutMessagePublishEncVersion3Mixin","WASmaxOutMessagePublishEncVersionFutureproofMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isEncVersion2)return o("WASmaxOutMessagePublishEncVersion2Mixin").mergeEncVersion2Mixin(e);if(t.isEncVersion3)return o("WASmaxOutMessagePublishEncVersion3Mixin").mergeEncVersion3Mixin(e);if(t.encVersionFutureproof)return o("WASmaxOutMessagePublishEncVersionFutureproofMixin").mergeEncVersionFutureproofMixin(e,t.encVersionFutureproof);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeEncVersion=e}),98);
__d("WASmaxOutMessagePublishToDeviceMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishEncMediaTypeDeprecatedMixin","WASmaxOutMessagePublishEncTypeIndividualMixin","WASmaxOutMessagePublishEncVersion","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.toJid,n=e.encTypeIndividualMixinArgs,r=e.encMediaTypeDeprecatedMixinArgs,a=e.encVersionArgs,i=o("WASmaxJsx").smax("to",{jid:o("WAWap").JID(t)},o("WASmaxOutMessagePublishEncVersion").mergeEncVersion(o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishEncMediaTypeDeprecatedMixin").mergeEncMediaTypeDeprecatedMixin,o("WASmaxOutMessagePublishEncTypeIndividualMixin").mergeEncTypeIndividualMixin(o("WASmaxJsx").smax("enc",null),n),r),a));return i}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeToDeviceMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualIndividualFanoutMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBotClientMultiThreadIDMessageMixin","WASmaxOutMessagePublishBotLocalAutomatedTypeMixin","WASmaxOutMessagePublishBotMessageTypeMixin","WASmaxOutMessagePublishBotMetricsEntryPointMixin","WASmaxOutMessagePublishBotMetricsThreadEntryPointMixin","WASmaxOutMessagePublishBotModeSelectionMixin","WASmaxOutMessagePublishBotPersonaTypeMixin","WASmaxOutMessagePublishBusinessBotMessageFeedbackRequestedMixin","WASmaxOutMessagePublishBusinessBotMessageMixin","WASmaxOutMessagePublishContentFanoutMixins","WASmaxOutMessagePublishLidChatOriginMixin","WASmaxOutMessagePublishMsgMetaOriginMixin","WASmaxOutMessagePublishPeripheralOriginMixin","WASmaxOutMessagePublishTDeprecatedMixin","WASmaxOutMessagePublishToContentBindingMixin","WASmaxOutMessagePublishToDeviceMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.toContentBindingMixinArgs,n=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishToContentBindingMixin").mergeToContentBindingMixin,o("WASmaxOutMessagePublishToDeviceMixin").mergeToDeviceMixin(o("WASmaxJsx").smax("to",null),e),t);return n}function s(){var e=o("WASmaxJsx").smax("enc",null);return e}function u(t){var n,r=t.toArgs,a=t.messageTo,i=t.tDeprecatedMixinArgs,l=t.botMessageTypeMixinArgs,s=t.businessBotMessageMixinArgs,u=t.botMetricsEntryPointMixinArgs,c=t.botMetricsThreadEntryPointMixinArgs,d=t.msgMetaOriginMixinArgs,m=t.hasLidChatOrigin,p=t.botLocalAutomatedTypeMixinArgs,_=t.businessBotMessageFeedbackRequestedMixinArgs,f=t.botPersonaTypeMixinArgs,g=t.botClientMultiThreadIDMessageMixinArgs,h=t.botModeSelectionMixinArgs,y=t.peripheralOriginMixinArgs,C=t.contentFanoutMixinsArgs,b=o("WASmaxOutMessagePublishContentFanoutMixins").mergeContentFanoutMixins((n=o("WASmaxMixins")).optionalMerge(o("WASmaxOutMessagePublishPeripheralOriginMixin").mergePeripheralOriginMixin,n.optionalMerge(o("WASmaxOutMessagePublishBotModeSelectionMixin").mergeBotModeSelectionMixin,n.optionalMerge(o("WASmaxOutMessagePublishBotClientMultiThreadIDMessageMixin").mergeBotClientMultiThreadIDMessageMixin,n.optionalMerge(o("WASmaxOutMessagePublishBotPersonaTypeMixin").mergeBotPersonaTypeMixin,n.optionalMerge(o("WASmaxOutMessagePublishBusinessBotMessageFeedbackRequestedMixin").mergeBusinessBotMessageFeedbackRequestedMixin,n.optionalMerge(o("WASmaxOutMessagePublishBotLocalAutomatedTypeMixin").mergeBotLocalAutomatedTypeMixin,n.optionalMerge(o("WASmaxOutMessagePublishLidChatOriginMixin").mergeLidChatOriginMixin,n.optionalMerge(o("WASmaxOutMessagePublishMsgMetaOriginMixin").mergeMsgMetaOriginMixin,n.optionalMerge(o("WASmaxOutMessagePublishBotMetricsThreadEntryPointMixin").mergeBotMetricsThreadEntryPointMixin,n.optionalMerge(o("WASmaxOutMessagePublishBotMetricsEntryPointMixin").mergeBotMetricsEntryPointMixin,n.optionalMerge(o("WASmaxOutMessagePublishBusinessBotMessageMixin").mergeBusinessBotMessageMixin,n.optionalMerge(o("WASmaxOutMessagePublishBotMessageTypeMixin").mergeBotMessageTypeMixin,n.optionalMerge(o("WASmaxOutMessagePublishTDeprecatedMixin").mergeTDeprecatedMixin,o("WASmaxJsx").smax("message",{to:o("WAWap").JID(a)},o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").REPEATED_CHILD(e,r,1,1997))),i),l),s),u),c),d),m),p),_),f),g),h),y),C);return b}function c(e,t){var n=u(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeIndividualIndividualFanoutParticipantsTo=e,l.makeIndividualIndividualFanoutEnc=s,l.mergeIndividualIndividualFanoutMixin=c}),98);
__d("WASmaxOutMessagePublishEncListMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("enc",{mediatype:"list"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeEncListMixin=s}),98);
__d("WASmaxOutMessagePublishContentTypeListMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaMixin","WASmaxOutMessagePublishEncListMixin","WASmaxOutMessagePublishSingleSelectOrProductListMixinGroup"],(function(t,n,r,o,a,i,l){function e(e){var t=e.singleSelectOrProductListMixinGroupArgs,n=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishSingleSelectOrProductListMixinGroup").mergeSingleSelectOrProductListMixinGroup,o("WASmaxOutMessagePublishContentTypeMediaMixin").mergeContentTypeMediaMixin(o("WASmaxJsx").smax("message",null,o("WASmaxOutMessagePublishEncListMixin").mergeEncListMixin(o("WASmaxJsx").smax("enc",null)))),t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeContentTypeListMixin=s}),98);
__d("WASmaxOutMessagePublishEncLiveLocationEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishEncLiveLocationDeprecatedMixin","WASmaxOutMessagePublishEncLiveLocationMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.encLiveLocation)return o("WASmaxOutMessagePublishEncLiveLocationMixin").mergeEncLiveLocationMixin(e,t.encLiveLocation);if(t.encLiveLocationDeprecated)return o("WASmaxOutMessagePublishEncLiveLocationDeprecatedMixin").mergeEncLiveLocationDeprecatedMixin(e,t.encLiveLocationDeprecated);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeEncLiveLocationEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup=e}),98);
__d("WASmaxOutMessagePublishContentTypeLiveLocationSingleMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaMixin","WASmaxOutMessagePublishEncLiveLocationEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup","WASmaxOutMessagePublishLiveLocationModeMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.liveLocationModeMixinArgs,n=e.encLiveLocationEncLiveLocationOrEncLiveLocationDeprecatedMixinGroupArgs,r=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishLiveLocationModeMixin").mergeLiveLocationModeMixin,o("WASmaxOutMessagePublishContentTypeMediaMixin").mergeContentTypeMediaMixin(o("WASmaxJsx").smax("message",null,o("WASmaxOutMessagePublishEncLiveLocationEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup").mergeEncLiveLocationEncLiveLocationOrEncLiveLocationDeprecatedMixinGroup(o("WASmaxJsx").smax("enc",null),n))),t);return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeContentTypeLiveLocationSingleMixin=s}),98);
__d("WASmaxOutMessagePublishEncMediaTypeEncMediaTypeOrEncMediaTypeDeprecatedMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishEncMediaTypeDeprecatedMixin","WASmaxOutMessagePublishEncMediaTypeMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.encMediaType)return o("WASmaxOutMessagePublishEncMediaTypeMixin").mergeEncMediaTypeMixin(e,t.encMediaType);if(t.encMediaTypeDeprecated)return o("WASmaxOutMessagePublishEncMediaTypeDeprecatedMixin").mergeEncMediaTypeDeprecatedMixin(e,t.encMediaTypeDeprecated);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeEncMediaTypeEncMediaTypeOrEncMediaTypeDeprecatedMixinGroup=e}),98);
__d("WASmaxOutMessagePublishContentTypeMediaSingleMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaOrMedianotifyMixinGroup","WASmaxOutMessagePublishEncMediaTypeEncMediaTypeOrEncMediaTypeDeprecatedMixinGroup","WASmaxOutMessagePublishSenderContentBindingMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.senderContentBindingMixinArgs,n=e.contentTypeMediaOrMedianotifyMixinGroupArgs,r=e.encMediaTypeEncMediaTypeOrEncMediaTypeDeprecatedMixinGroupArgs,a=o("WASmaxOutMessagePublishContentTypeMediaOrMedianotifyMixinGroup").mergeContentTypeMediaOrMedianotifyMixinGroup(o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishSenderContentBindingMixin").mergeSenderContentBindingMixin,o("WASmaxJsx").smax("message",null,o("WASmaxOutMessagePublishEncMediaTypeEncMediaTypeOrEncMediaTypeDeprecatedMixinGroup").mergeEncMediaTypeEncMediaTypeOrEncMediaTypeDeprecatedMixinGroup(o("WASmaxJsx").smax("enc",null),r)),t),n);return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeContentTypeMediaSingleMixin=s}),98);
__d("WASmaxOutMessagePublishContentMixins",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishContentTypeEventMixin","WASmaxOutMessagePublishContentTypeListMixin","WASmaxOutMessagePublishContentTypeLiveLocationSingleMixin","WASmaxOutMessagePublishContentTypeMediaSingleMixin","WASmaxOutMessagePublishContentTypePollCreationMixin","WASmaxOutMessagePublishContentTypePollResultSnapshotMixin","WASmaxOutMessagePublishContentTypePollVoteMixin","WASmaxOutMessagePublishContentTypeReactionMixin","WASmaxOutMessagePublishContentTypeTextMixin","WASmaxOutMessagePublishIndividualContentTypePayIndividualMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isContentTypeText)return o("WASmaxOutMessagePublishContentTypeTextMixin").mergeContentTypeTextMixin(e);if(t.contentTypeMediaSingle)return o("WASmaxOutMessagePublishContentTypeMediaSingleMixin").mergeContentTypeMediaSingleMixin(e,t.contentTypeMediaSingle);if(t.contentTypeLiveLocationSingle)return o("WASmaxOutMessagePublishContentTypeLiveLocationSingleMixin").mergeContentTypeLiveLocationSingleMixin(e,t.contentTypeLiveLocationSingle);if(t.individualContentTypePayIndividual)return o("WASmaxOutMessagePublishIndividualContentTypePayIndividualMixin").mergeIndividualContentTypePayIndividualMixin(e,t.individualContentTypePayIndividual);if(t.contentTypeList)return o("WASmaxOutMessagePublishContentTypeListMixin").mergeContentTypeListMixin(e,t.contentTypeList);if(t.isContentTypeReaction)return o("WASmaxOutMessagePublishContentTypeReactionMixin").mergeContentTypeReactionMixin(e);if(t.contentTypePollCreation)return o("WASmaxOutMessagePublishContentTypePollCreationMixin").mergeContentTypePollCreationMixin(e,t.contentTypePollCreation);if(t.contentTypePollVote)return o("WASmaxOutMessagePublishContentTypePollVoteMixin").mergeContentTypePollVoteMixin(e,t.contentTypePollVote);if(t.isContentTypePollResultSnapshot)return o("WASmaxOutMessagePublishContentTypePollResultSnapshotMixin").mergeContentTypePollResultSnapshotMixin(e);if(t.contentTypeEvent)return o("WASmaxOutMessagePublishContentTypeEventMixin").mergeContentTypeEventMixin(e,t.contentTypeEvent);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeContentMixins=e}),98);
__d("WASmaxOutMessagePublishIndividualIndividualRetryToPeerMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.messageRecipient,n=o("WASmaxJsx").smax("message",{recipient:o("WAWap").JID(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualIndividualRetryToPeerMixin=s}),98);
__d("WASmaxOutMessagePublishRetryMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishEncRetryMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.messageT,n=e.encRetryMixinArgs,r=o("WASmaxJsx").smax("message",{t:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,t)},o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishEncRetryMixin").mergeEncRetryMixin,o("WASmaxJsx").smax("enc",null),n));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeRetryMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualIndividualRetryMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishIndividualIndividualRetryToPeerMixin","WASmaxOutMessagePublishRetryMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.individualIndividualRetryToPeerMixinArgs,n=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishIndividualIndividualRetryToPeerMixin").mergeIndividualIndividualRetryToPeerMixin,o("WASmaxOutMessagePublishRetryMixin").mergeRetryMixin(o("WASmaxJsx").smax("message",null),e),t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualIndividualRetryMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualSingleContentBindingMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.contentBindingElementValue,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("content_binding",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualSingleContentBindingMixin=s}),98);
__d("WASmaxOutMessagePublishReceiverAccountKindMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaReceiverAccountKind,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{receiver_account_kind:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeReceiverAccountKindMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualIndividualSingleMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBotClientMultiThreadIDMessageMixin","WASmaxOutMessagePublishBotLocalAutomatedTypeMixin","WASmaxOutMessagePublishBotMessageTypeMixin","WASmaxOutMessagePublishBotMetricsEntryPointMixin","WASmaxOutMessagePublishBotMetricsThreadEntryPointMixin","WASmaxOutMessagePublishBotModeSelectionMixin","WASmaxOutMessagePublishBotPersonaTypeMixin","WASmaxOutMessagePublishBusinessBotMessageFeedbackRequestedMixin","WASmaxOutMessagePublishBusinessBotMessageMixin","WASmaxOutMessagePublishContentMixins","WASmaxOutMessagePublishEncMediaTypeDeprecatedMixin","WASmaxOutMessagePublishEncTypeIndividualMixin","WASmaxOutMessagePublishEncVersion","WASmaxOutMessagePublishIndividualIndividualRetryMixin","WASmaxOutMessagePublishIndividualSingleContentBindingMixin","WASmaxOutMessagePublishLidChatOriginMixin","WASmaxOutMessagePublishMsgMetaOriginMixin","WASmaxOutMessagePublishPeripheralOriginMixin","WASmaxOutMessagePublishReceiverAccountKindMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.messageTo,r=e.individualIndividualRetryMixinArgs,a=e.individualSingleContentBindingMixinArgs,i=e.botMessageTypeMixinArgs,l=e.businessBotMessageMixinArgs,s=e.botMetricsEntryPointMixinArgs,u=e.botMetricsThreadEntryPointMixinArgs,c=e.msgMetaOriginMixinArgs,d=e.hasLidChatOrigin,m=e.botLocalAutomatedTypeMixinArgs,p=e.businessBotMessageFeedbackRequestedMixinArgs,_=e.botPersonaTypeMixinArgs,f=e.botClientMultiThreadIDMessageMixinArgs,g=e.botModeSelectionMixinArgs,h=e.peripheralOriginMixinArgs,y=e.receiverAccountKindMixinArgs,C=e.contentMixinsArgs,b=e.encTypeIndividualMixinArgs,v=e.encMediaTypeDeprecatedMixinArgs,S=e.encVersionArgs,R=o("WASmaxOutMessagePublishContentMixins").mergeContentMixins((t=o("WASmaxMixins")).optionalMerge(o("WASmaxOutMessagePublishReceiverAccountKindMixin").mergeReceiverAccountKindMixin,t.optionalMerge(o("WASmaxOutMessagePublishPeripheralOriginMixin").mergePeripheralOriginMixin,t.optionalMerge(o("WASmaxOutMessagePublishBotModeSelectionMixin").mergeBotModeSelectionMixin,t.optionalMerge(o("WASmaxOutMessagePublishBotClientMultiThreadIDMessageMixin").mergeBotClientMultiThreadIDMessageMixin,t.optionalMerge(o("WASmaxOutMessagePublishBotPersonaTypeMixin").mergeBotPersonaTypeMixin,t.optionalMerge(o("WASmaxOutMessagePublishBusinessBotMessageFeedbackRequestedMixin").mergeBusinessBotMessageFeedbackRequestedMixin,t.optionalMerge(o("WASmaxOutMessagePublishBotLocalAutomatedTypeMixin").mergeBotLocalAutomatedTypeMixin,t.optionalMerge(o("WASmaxOutMessagePublishLidChatOriginMixin").mergeLidChatOriginMixin,t.optionalMerge(o("WASmaxOutMessagePublishMsgMetaOriginMixin").mergeMsgMetaOriginMixin,t.optionalMerge(o("WASmaxOutMessagePublishBotMetricsThreadEntryPointMixin").mergeBotMetricsThreadEntryPointMixin,t.optionalMerge(o("WASmaxOutMessagePublishBotMetricsEntryPointMixin").mergeBotMetricsEntryPointMixin,t.optionalMerge(o("WASmaxOutMessagePublishBusinessBotMessageMixin").mergeBusinessBotMessageMixin,t.optionalMerge(o("WASmaxOutMessagePublishBotMessageTypeMixin").mergeBotMessageTypeMixin,t.optionalMerge(o("WASmaxOutMessagePublishIndividualSingleContentBindingMixin").mergeIndividualSingleContentBindingMixin,t.optionalMerge(o("WASmaxOutMessagePublishIndividualIndividualRetryMixin").mergeIndividualIndividualRetryMixin,o("WASmaxJsx").smax("message",{to:o("WAWap").JID(n)},o("WASmaxOutMessagePublishEncVersion").mergeEncVersion(t.optionalMerge(o("WASmaxOutMessagePublishEncMediaTypeDeprecatedMixin").mergeEncMediaTypeDeprecatedMixin,o("WASmaxOutMessagePublishEncTypeIndividualMixin").mergeEncTypeIndividualMixin(o("WASmaxJsx").smax("enc",null),b),v),S)),r),a),i),l),s),u),c),d),m),p),_),f),g),h),y),C);return R}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualIndividualSingleMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualIndividualSingleOrIndividualIndividualFanoutOrBotMetricsEntryPointMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishBotMetricsEntryPointMixin","WASmaxOutMessagePublishIndividualIndividualFanoutMixin","WASmaxOutMessagePublishIndividualIndividualSingleMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.individualIndividualSingle)return o("WASmaxOutMessagePublishIndividualIndividualSingleMixin").mergeIndividualIndividualSingleMixin(e,t.individualIndividualSingle);if(t.individualIndividualFanout)return o("WASmaxOutMessagePublishIndividualIndividualFanoutMixin").mergeIndividualIndividualFanoutMixin(e,t.individualIndividualFanout);if(t.botMetricsEntryPoint)return o("WASmaxOutMessagePublishBotMetricsEntryPointMixin").mergeBotMetricsEntryPointMixin(e,t.botMetricsEntryPoint);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeIndividualIndividualSingleOrIndividualIndividualFanoutOrBotMetricsEntryPointMixinGroup=e}),98);
__d("WASmaxOutMessagePublishIndividualBotRequestMessageMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBotFeedbackMessageTypeMixin","WASmaxOutMessagePublishBotRequestMixin","WASmaxOutMessagePublishContentTypeTextOrMediaMixinGroup","WASmaxOutMessagePublishIndividualIndividualSingleOrIndividualIndividualFanoutOrBotMetricsEntryPointMixinGroup","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.messageTo,n=e.contentTypeTextOrMediaMixinGroupArgs,r=e.individualIndividualSingleOrIndividualIndividualFanoutOrBotMetricsEntryPointMixinGroupArgs,a=e.hasBotFeedbackMessageType,i=e.botRequestMixinArgs,l=o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishIndividualIndividualSingleOrIndividualIndividualFanoutOrBotMetricsEntryPointMixinGroup").mergeIndividualIndividualSingleOrIndividualIndividualFanoutOrBotMetricsEntryPointMixinGroup,o("WASmaxOutMessagePublishContentTypeTextOrMediaMixinGroup").mergeContentTypeTextOrMediaMixinGroup(o("WASmaxJsx").smax("message",{to:o("WAWap").USER_JID(t)},o("WASmaxMixins").optionalMerge(o("WASmaxOutMessagePublishBotFeedbackMessageTypeMixin").mergeBotFeedbackMessageTypeMixin,o("WASmaxJsx").smax("bot",null,o("WASmaxOutMessagePublishBotRequestMixin").mergeBotRequestMixin(o("WASmaxJsx").smax("to",null),i)),a)),n),r);return l}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualBotRequestMessageMixin=s}),98);
__d("WASmaxOutMessagePublishBotResponseMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.botEditTargetId,r=e.botSenderTimestampMs,a=e.botEdit,i=e.hasBotTypeVoice,l=o("WASmaxJsx").smax("bot",{edit_target_id:(t=o("WASmaxAttrs")).OPTIONAL(o("WAWap").CUSTOM_STRING,n),sender_timestamp_ms:t.OPTIONAL(o("WAWap").INT,r),edit:t.OPTIONAL(o("WAWap").CUSTOM_STRING,a),type:t.OPTIONAL_LITERAL("voice",i)});return l}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBotResponseMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualContentTypeBotResponseMediaFanoutMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishContentTypeMediaMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.toCount,n=o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").REPEATED_CHILD_COUNT(s,t,2,2));return n}function s(){var e=o("WASmaxJsx").smax("to",null,o("WASmaxJsx").smax("enc",{mediatype:"image"}));return e}function u(t){var n=t.participantsArgs,r=o("WASmaxOutMessagePublishContentTypeMediaMixin").mergeContentTypeMediaMixin(o("WASmaxJsx").smax("message",null,o("WASmaxChildren").OPTIONAL_CHILD(e,n)));return r}function c(e,t){var n=u(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeIndividualContentTypeBotResponseMediaFanoutParticipants=e,l.makeIndividualContentTypeBotResponseMediaFanoutParticipantsTo=s,l.mergeIndividualContentTypeBotResponseMediaFanoutMixin=c}),98);
__d("WASmaxOutMessagePublishContentTypeTextOrIndividualBotResponseMediaFanoutMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishContentTypeTextMixin","WASmaxOutMessagePublishIndividualContentTypeBotResponseMediaFanoutMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isContentTypeText)return o("WASmaxOutMessagePublishContentTypeTextMixin").mergeContentTypeTextMixin(e);if(t.individualContentTypeBotResponseMediaFanout)return o("WASmaxOutMessagePublishIndividualContentTypeBotResponseMediaFanoutMixin").mergeIndividualContentTypeBotResponseMediaFanoutMixin(e,t.individualContentTypeBotResponseMediaFanout);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeContentTypeTextOrIndividualBotResponseMediaFanoutMixinGroup=e}),98);
__d("WASmaxOutMessagePublishEncTypeMessageSecretMessageMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishEncPayloadMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxOutMessagePublishEncPayloadMixin").mergeEncPayloadMixin(o("WASmaxJsx").smax("enc",{type:"msmsg"}),e);return t}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncTypeMessageSecretMessageMixin=s}),98);
__d("WASmaxOutMessagePublishMessageTargetMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.metaTargetId,r=e.metaTargetSenderJid,a=e.metaTargetChatJid,i=e.metaTargetChatJidLid,l=o("WASmaxJsx").smax("meta",{target_id:(t=o("WAWap")).STANZA_ID(n),target_sender_jid:o("WASmaxAttrs").OPTIONAL(t.USER_JID,r),target_chat_jid:o("WASmaxAttrs").OPTIONAL(t.JID,a),target_chat_jid_lid:o("WASmaxAttrs").OPTIONAL(t.JID,i)});return l}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMessageTargetMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualBotResponseFanoutMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishBotResponseMixin","WASmaxOutMessagePublishContentTypeTextOrIndividualBotResponseMediaFanoutMixinGroup","WASmaxOutMessagePublishEncTypeMessageSecretMessageMixin","WASmaxOutMessagePublishEncVersionBot","WASmaxOutMessagePublishMessageTargetMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.toArgs,n=o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").REPEATED_CHILD(s,t,2,2));return n}function s(e){var t=e.toJid,n=o("WASmaxJsx").smax("to",{jid:o("WAWap").USER_JID(t)});return n}function u(t){var n,r=t.participantsArgs,a=t.messageTo,i=t.contentTypeTextOrIndividualBotResponseMediaFanoutMixinGroupArgs,l=t.botResponseMixinArgs,s=t.messageTargetMixinArgs,u=t.encTypeMessageSecretMessageMixinArgs,c=t.encVersionBotArgs,d=o("WASmaxOutMessagePublishContentTypeTextOrIndividualBotResponseMediaFanoutMixinGroup").mergeContentTypeTextOrIndividualBotResponseMediaFanoutMixinGroup((n=o("WASmaxJsx")).smax("message",{to:o("WAWap").USER_JID(a)},o("WASmaxOutMessagePublishBotResponseMixin").mergeBotResponseMixin(n.smax("bot",null),l),o("WASmaxOutMessagePublishMessageTargetMixin").mergeMessageTargetMixin(n.smax("meta",null),s),o("WASmaxOutMessagePublishEncVersionBot").mergeEncVersionBot(o("WASmaxOutMessagePublishEncTypeMessageSecretMessageMixin").mergeEncTypeMessageSecretMessageMixin(n.smax("enc",null),u),c),o("WASmaxChildren").OPTIONAL_CHILD(e,r)),i);return d}function c(e,t){var n=u(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeIndividualBotResponseFanoutParticipants=e,l.makeIndividualBotResponseFanoutParticipantsTo=s,l.mergeIndividualBotResponseFanoutMixin=c}),98);
__d("WASmaxOutMessagePublishIndividualBotResponseFanoutOrIndividualBotRequestMessageOrIndividualIndividualSingleOrIndividualIndividualFanoutMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishIndividualBotRequestMessageMixin","WASmaxOutMessagePublishIndividualBotResponseFanoutMixin","WASmaxOutMessagePublishIndividualIndividualFanoutMixin","WASmaxOutMessagePublishIndividualIndividualSingleMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.individualBotResponseFanout)return o("WASmaxOutMessagePublishIndividualBotResponseFanoutMixin").mergeIndividualBotResponseFanoutMixin(e,t.individualBotResponseFanout);if(t.individualBotRequestMessage)return o("WASmaxOutMessagePublishIndividualBotRequestMessageMixin").mergeIndividualBotRequestMessageMixin(e,t.individualBotRequestMessage);if(t.individualIndividualSingle)return o("WASmaxOutMessagePublishIndividualIndividualSingleMixin").mergeIndividualIndividualSingleMixin(e,t.individualIndividualSingle);if(t.individualIndividualFanout)return o("WASmaxOutMessagePublishIndividualIndividualFanoutMixin").mergeIndividualIndividualFanoutMixin(e,t.individualIndividualFanout);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeIndividualBotResponseFanoutOrIndividualBotRequestMessageOrIndividualIndividualSingleOrIndividualIndividualFanoutMixinGroup=e}),98);
__d("WASmaxOutMessagePublishIndividualRecipientDeprecaredMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.messageRecipient,n=o("WASmaxJsx").smax("message",{recipient:o("WAWap").JID(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIndividualRecipientDeprecaredMixin=s}),98);
__d("WASmaxOutMessagePublishMessageEditMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{edit:"1"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeMessageEditMixin=s}),98);
__d("WASmaxOutMessagePublishMessagePinMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{edit:"2"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeMessagePinMixin=s}),98);
__d("WASmaxOutMessagePublishRevokeMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",{edit:"7"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeRevokeMixin=s}),98);
__d("WASmaxOutMessagePublishMessageEditOrMessagePinOrRevokeMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishMessageEditMixin","WASmaxOutMessagePublishMessagePinMixin","WASmaxOutMessagePublishRevokeMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.isMessageEdit)return o("WASmaxOutMessagePublishMessageEditMixin").mergeMessageEditMixin(e);if(t.isMessagePin)return o("WASmaxOutMessagePublishMessagePinMixin").mergeMessagePinMixin(e);if(t.isRevoke)return o("WASmaxOutMessagePublishRevokeMixin").mergeRevokeMixin(e);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeMessageEditOrMessagePinOrRevokeMixinGroup=e}),98);
__d("WASmaxOutMessagePublishMetaConverstationThreadIdMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaConversationThreadId,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{conversation_thread_id:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMetaConverstationThreadIdMixin=s}),98);
__d("WASmaxOutMessagePublishMetaDestinationIdMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaDestinationId,n=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{destination_id:o("WAWap").CUSTOM_STRING(t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMetaDestinationIdMixin=s}),98);
__d("WASmaxOutMessagePublishMetaScheduledMessageMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaSt,n=e.keyRkid,r=e.keyElementValue,a=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{type:"scheduled_message",st:o("WAWap").INT(t)},o("WASmaxJsx").smax("key",{rkid:o("WAWap").CUSTOM_STRING(n)},r)));return a}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeMetaScheduledMessageMixin=s}),98);
__d("WASmaxOutMessagePublishPeerRecipientUsernameMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyPeerRecipientUsername,n=o("WASmaxJsx").smax("smax$any",{peer_recipient_username:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePeerRecipientUsernameMixin=s}),98);
__d("WASmaxOutMessagePublishPeerRecipientLIDMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyPeerRecipientLid,n=o("WASmaxJsx").smax("smax$any",{peer_recipient_lid:o("WAWap").JID(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePeerRecipientLIDMixin=s}),98);
__d("WASmaxOutMessagePublishPeerRecipientPNMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyPeerRecipientPn,n=o("WASmaxJsx").smax("smax$any",{peer_recipient_pn:o("WAWap").JID(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePeerRecipientPNMixin=s}),98);
__d("WASmaxOutMessagePublishRecipientPNMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.messageRecipientPn,n=o("WASmaxJsx").smax("message",{recipient_pn:o("WAWap").JID(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeRecipientPNMixin=s}),98);
__d("WASmaxOutMessagePublishRecipientPNOrPeerRecipientPNOrPeerRecipientLIDMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishPeerRecipientLIDMixin","WASmaxOutMessagePublishPeerRecipientPNMixin","WASmaxOutMessagePublishRecipientPNMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.recipientPN)return o("WASmaxOutMessagePublishRecipientPNMixin").mergeRecipientPNMixin(e,t.recipientPN);if(t.peerRecipientPN)return o("WASmaxOutMessagePublishPeerRecipientPNMixin").mergePeerRecipientPNMixin(e,t.peerRecipientPN);if(t.peerRecipientLID)return o("WASmaxOutMessagePublishPeerRecipientLIDMixin").mergePeerRecipientLIDMixin(e,t.peerRecipientLID);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeRecipientPNOrPeerRecipientPNOrPeerRecipientLIDMixinGroup=e}),98);
__d("WASmaxOutMessagePublishStatusMentionMessageMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{is_status_mention:"true"}));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeStatusMentionMessageMixin=s}),98);
__d("WASmaxOutMessagePublishPrivacyTokenContentsMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyElementValue,n=o("WASmaxJsx").smax("smax$any",null,t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePrivacyTokenContentsMixin=s}),98);
__d("WASmaxOutMessagePublishTCTokenMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishPrivacyTokenContentsMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.tctokenT,n=e.privacyTokenContentsMixinArgs,r=o("WASmaxJsx").smax("smax$any",null,o("WASmaxOutMessagePublishPrivacyTokenContentsMixin").mergePrivacyTokenContentsMixin(o("WASmaxJsx").smax("tctoken",{t:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,t)}),n));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeTCTokenMixin=s}),98);
__d("WASmaxOutMessagePublishThreadTypeTagEnumMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaThreadType,n=o("WASmaxJsx").smax("meta",{thread_type:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeThreadTypeTagEnumMixin=s}),98);
__d("WASmaxOutMessagePublishThreadTypeTagLegacyMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.metaThreadType,n=o("WASmaxJsx").smax("meta",{thread_type:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeThreadTypeTagLegacyMixin=s}),98);
__d("WASmaxOutMessagePublishThreadTypeTagEnumOrLegacyMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMessagePublishThreadTypeTagEnumMixin","WASmaxOutMessagePublishThreadTypeTagLegacyMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.threadTypeTagEnum)return o("WASmaxOutMessagePublishThreadTypeTagEnumMixin").mergeThreadTypeTagEnumMixin(e,t.threadTypeTagEnum);if(t.threadTypeTagLegacy)return o("WASmaxOutMessagePublishThreadTypeTagLegacyMixin").mergeThreadTypeTagLegacyMixin(e,t.threadTypeTagLegacy);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeThreadTypeTagEnumOrLegacyMixinGroup=e}),98);
__d("WASmaxOutMessagePublishThreadTypeTagMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishThreadTypeTagEnumOrLegacyMixinGroup"],(function(t,n,r,o,a,i,l){function e(e){var t=e.threadTypeTagEnumOrLegacyMixinGroupArgs,n=o("WASmaxJsx").smax("message",null,o("WASmaxOutMessagePublishThreadTypeTagEnumOrLegacyMixinGroup").mergeThreadTypeTagEnumOrLegacyMixinGroup(o("WASmaxJsx").smax("meta",null),t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeThreadTypeTagMixin=s}),98);
__d("WASmaxOutMessagePublishViewOnceMetaAttributeMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("message",null,o("WASmaxJsx").smax("meta",{view_once:"true"}));return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeViewOnceMetaAttributeMixin=s}),98);
__d("WASmaxOutMessagePublishIndividualRequest",["WASmaxJsx","WASmaxMixins","WASmaxOutMessagePublishAppdataMetaAttributeMixin","WASmaxOutMessagePublishArmadilloOriginalMessageTimestampMixin","WASmaxOutMessagePublishBaseMixin","WASmaxOutMessagePublishGroupInviteTargetMixin","WASmaxOutMessagePublishIndividualBotResponseFanoutOrIndividualBotRequestMessageOrIndividualIndividualSingleOrIndividualIndividualFanoutMixinGroup","WASmaxOutMessagePublishIndividualRecipientDeprecaredMixin","WASmaxOutMessagePublishMessageEditOrMessagePinOrRevokeMixinGroup","WASmaxOutMessagePublishMetaConverstationThreadIdMixin","WASmaxOutMessagePublishMetaDestinationIdMixin","WASmaxOutMessagePublishMetaScheduledMessageMixin","WASmaxOutMessagePublishPeerRecipientUsernameMixin","WASmaxOutMessagePublishPeripheralOriginMixin","WASmaxOutMessagePublishRecipientPNOrPeerRecipientPNOrPeerRecipientLIDMixinGroup","WASmaxOutMessagePublishStatusMentionMessageMixin","WASmaxOutMessagePublishTCTokenMixin","WASmaxOutMessagePublishThreadTypeTagMixin","WASmaxOutMessagePublishViewOnceMetaAttributeMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.messageId,r=e.groupInviteTargetMixinArgs,a=e.threadTypeTagMixinArgs,i=e.peerRecipientUsernameMixinArgs,l=e.individualRecipientDeprecaredMixinArgs,s=e.appdataMetaAttributeMixinArgs,u=e.hasStatusMentionMessage,c=e.tCTokenMixinArgs,d=e.hasViewOnceMetaAttribute,m=e.metaDestinationIdMixinArgs,p=e.metaConverstationThreadIdMixinArgs,_=e.metaScheduledMessageMixinArgs,f=e.peripheralOriginMixinArgs,g=e.armadilloOriginalMessageTimestampMixinArgs,h=e.individualBotResponseFanoutOrIndividualBotRequestMessageOrIndividualIndividualSingleOrIndividualIndividualFanoutMixinGroupArgs,y=e.messageEditOrMessagePinOrRevokeMixinGroupArgs,C=e.recipientPNOrPeerRecipientPNOrPeerRecipientLIDMixinGroupArgs,b=(t=o("WASmaxMixins")).optionalMerge(o("WASmaxOutMessagePublishRecipientPNOrPeerRecipientPNOrPeerRecipientLIDMixinGroup").mergeRecipientPNOrPeerRecipientPNOrPeerRecipientLIDMixinGroup,t.optionalMerge(o("WASmaxOutMessagePublishMessageEditOrMessagePinOrRevokeMixinGroup").mergeMessageEditOrMessagePinOrRevokeMixinGroup,o("WASmaxOutMessagePublishIndividualBotResponseFanoutOrIndividualBotRequestMessageOrIndividualIndividualSingleOrIndividualIndividualFanoutMixinGroup").mergeIndividualBotResponseFanoutOrIndividualBotRequestMessageOrIndividualIndividualSingleOrIndividualIndividualFanoutMixinGroup(t.optionalMerge(o("WASmaxOutMessagePublishArmadilloOriginalMessageTimestampMixin").mergeArmadilloOriginalMessageTimestampMixin,t.optionalMerge(o("WASmaxOutMessagePublishPeripheralOriginMixin").mergePeripheralOriginMixin,t.optionalMerge(o("WASmaxOutMessagePublishMetaScheduledMessageMixin").mergeMetaScheduledMessageMixin,t.optionalMerge(o("WASmaxOutMessagePublishMetaConverstationThreadIdMixin").mergeMetaConverstationThreadIdMixin,t.optionalMerge(o("WASmaxOutMessagePublishMetaDestinationIdMixin").mergeMetaDestinationIdMixin,t.optionalMerge(o("WASmaxOutMessagePublishViewOnceMetaAttributeMixin").mergeViewOnceMetaAttributeMixin,t.optionalMerge(o("WASmaxOutMessagePublishTCTokenMixin").mergeTCTokenMixin,t.optionalMerge(o("WASmaxOutMessagePublishStatusMentionMessageMixin").mergeStatusMentionMessageMixin,t.optionalMerge(o("WASmaxOutMessagePublishAppdataMetaAttributeMixin").mergeAppdataMetaAttributeMixin,t.optionalMerge(o("WASmaxOutMessagePublishIndividualRecipientDeprecaredMixin").mergeIndividualRecipientDeprecaredMixin,t.optionalMerge(o("WASmaxOutMessagePublishPeerRecipientUsernameMixin").mergePeerRecipientUsernameMixin,t.optionalMerge(o("WASmaxOutMessagePublishThreadTypeTagMixin").mergeThreadTypeTagMixin,t.optionalMerge(o("WASmaxOutMessagePublishGroupInviteTargetMixin").mergeGroupInviteTargetMixin,o("WASmaxOutMessagePublishBaseMixin").mergeBaseMixin(o("WASmaxJsx").smax("message",{id:o("WAWap").STANZA_ID(n)}),e),r),a),i),l),s),u),c),d),m),p),_),f),g),h),y),C);return b}l.makeIndividualRequest=e}),98);
__d("WASmaxMessagePublishIndividualRPC",["WAComms","WASmaxInMessagePublishIndividualResponseNegative","WASmaxInMessagePublishIndividualResponseSuccess","WASmaxOutMessagePublishIndividualRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(t,n,r,o,a,i,l){async function e(e,t){var n=o("WASmaxOutMessagePublishIndividualRequest").makeIndividualRequest(e),r=await o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInMessagePublishIndividualResponseNegative").parseIndividualResponseNegative(r,n);if(a.success)return{name:"IndividualResponseNegative",value:a.value};var i=o("WASmaxInMessagePublishIndividualResponseSuccess").parseIndividualResponseSuccess(r,n);if(i.success)return{name:"IndividualResponseSuccess",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("Individual",{Negative:a,Success:i}))}l.sendIndividualRPC=e}),98);
__d("WASendMsgRPC",["WADeprecatedSendIq","WADeprecatedWapParser","WAFrankingTypes","WAGetDeviceIdentityMixin","WAJids","WALogger","WAParseFranking","WASmaxMessagePublishIndividualRPC","WATimeUtils","WAWap"],(function(t,n,r,o,a,i,l){"use strict";var e,s;async function u(e,t,n,r,a){a===void 0&&(a=!1);var i=o("WAJids").interpretAsGroupJid(e.protocolMsgId.chat),l=e.messageType.type==="text"&&e.messageType.invitedParticipantUserJid!=null;if(t.type==="direct_user"){var s={individualIndividualSingle:{messageTo:t.message.to,individualIndividualRetryMixinArgs:p(e.count,t.recipient),contentMixinsArgs:m(e,t.message),encTypeIndividualMixinArgs:_(t.message),encVersionArgs:f(t.message)}},u=e.type==="direct"?e.originalMsgTimestampMs:void 0,C={messageId:e.externalId,deviceIdentityMixinArgs:o("WAGetDeviceIdentityMixin").getDeviceIdentityMixin(e.deviceIdentity),hasNoExtraFanout:e.messageType.isInvisible===!0?!0:null,messageEditOrMessagePinOrRevokeMixinGroupArgs:g(e.messageType),clientFrankingTagMixinArgs:n!=null&&n.frankingTag?{frankingTagElementValue:n.frankingTag}:null,hasMetaHideDecryptionPlaceholder:y(e.messageType)?!0:null,groupInviteTargetMixinArgs:l&&i!=null?{metaGroupInvite:i}:null,individualBotResponseFanoutOrIndividualBotRequestMessageOrIndividualIndividualSingleOrIndividualIndividualFanoutMixinGroupArgs:s,internalTestMixinArgs:a?{testConfig:"armadillo_express"}:null,armadilloOriginalMessageTimestampMixinArgs:u!=null?{metaOriginalMsgT:u}:null};r==null||r.addPoint("send_individual_rpc");var b=await o("WASmaxMessagePublishIndividualRPC").sendIndividualRPC(C);if(b.name==="IndividualResponseSuccess"){var v,S=((v=b.value.deviceListStaleMixin)==null?void 0:v.phash)!=null?{type:"mismatch",local:null,server:b.value.deviceListStaleMixin.phash}:{type:"ok"},R=b.value.serverFrankingTagMixin!=null&&n!=null?babelHelpers.extends({},n,{reportingTag:o("WAFrankingTypes").castToReportingTag(b.value.serverFrankingTagMixin.frankingReportingTagElementValue)}):null;return{type:"success",ts:o("WATimeUtils").castToUnixTime(b.value.t),phash:S,count:null,reportingMeta:R}}else{var L,E;return b.name,{type:"error",errorCode:parseInt(b.value.error,10),backoff:parseInt((L=b.value.messageNackRetryAttributesMixin)==null?void 0:L.backoff,10),applicationError:(E=b.value.applicationNegativeAckMixin)==null?void 0:E.applicationError}}}var k=e.messageType.isInvisible===!0?"false":o("WAWap").DROP_ATTR,I=t.participant!=null?o("WAWap").JID(t.participant):o("WAWap").DROP_ATTR,T=t.phash!=null&&t.type==="group"?o("WAWap").CUSTOM_STRING(t.phash):o("WAWap").DROP_ATTR;function D(){return e.messageType.type==="text"&&e.messageType.isRevoked?"7":e.messageType.type==="text"&&e.messageType.isEdit===!0?"1":o("WAWap").DROP_ATTR}var x=D();function $(){return l&&i!=null?o("WAWap").wap("meta",{"decrypt-fail":"hide",group_invite:o("WAWap").CUSTOM_STRING(i)}):y(e.messageType)?o("WAWap").wap("meta",{"decrypt-fail":"hide"}):null}var P=$(),N=a?o("WAWap").wap("test",{config:o("WAWap").CUSTOM_STRING("armadillo_express")}):null,M=e.deviceIdentity!=null?o("WAWap").wap("device-identity",null,e.deviceIdentity):null,w=(n==null?void 0:n.frankingTag)!=null?o("WAWap").wap("franking",null,o("WAWap").wap("franking_tag",null,n.frankingTag)):null,A=null;t.participants!=null&&(A=o("WAWap").wap("participants",null,t.participants.map(function(e){return c(e)})));var F=null;t.message!=null&&(F=c(t.message,!0));var O=o("WAWap").wap("message",{device_fanout:k,edit:x,id:o("WAWap").CUSTOM_STRING(e.externalId),participant:I,phash:T,to:o("WAWap").JID(t.messageTo),type:e.messageType.type},P,w,A,F,M,N);h(e.externalId),r==null||r.addPoint("send_stanza_and_return_ack");var B=await o("WADeprecatedSendIq").deprecatedSendStanzaAndReturnAck(O,{id:e.externalId,class:"message",from:t.messageTo,participant:t.participant!=null?t.participant:null});r==null||r.addPoint("send_msg_ack_parser");var W=d.parse(B);if(W.success){r==null||r.addPoint("send_msg_ack_parser_success");var q=W.success,U=q.applicationError,V=q.backoff,H=q.errorCode;if(H==null){var G,z=W.success,j=z.count,K=z.phash,Q=z.ts,X=n!=null?babelHelpers.extends({},n,{reportingTag:(G=W.success.reportingMeta)==null?void 0:G.reportingTag}):null;return{type:"success",ts:Q,phash:K==null||K===t.phash?{type:"ok"}:{type:"mismatch",local:t.phash,server:K},count:j,reportingMeta:X}}else return r==null||r.addPoint("send_msg_ack_parser_failed",{int:{errorCode:H,applicationError:U}}),{type:"error",errorCode:H,applicationError:U,backoff:V}}else return{type:"parsing_error"}}function c(e,t){t===void 0&&(t=!1);var n=o("WAWap").wap("enc",{count:e.count!=null?o("WAWap").INT(e.count):o("WAWap").DROP_ATTR,mediatype:e.mediaType!=null?o("WAWap").CUSTOM_STRING(e.mediaType):o("WAWap").DROP_ATTR,type:o("WAWap").CUSTOM_STRING(e.type),v:o("WAWap").CUSTOM_STRING(e.v)},e.ciphertext);return t||e.encType==="group"?n:o("WAWap").wap("to",{jid:o("WAWap").DEVICE_JID(e.to)},n)}var d=new(r("WADeprecatedWapParser"))("sendMsgAck",function(e){return e.assertTag("ack"),{count:e.maybeAttrInt("count"),errorCode:e.maybeAttrInt("error"),phash:e.maybeAttrString("phash"),applicationError:e.maybeAttrInt("application_error"),ts:e.attrTime("t"),reportingMeta:o("WAParseFranking").parseFrankingNode(e.maybeChild("franking")),backoff:e.maybeAttrInt("backoff")}});function m(t,n){if(t.messageType.type==="reaction")return{isContentTypeReaction:!0};if(t.messageType.type==="text")return{isContentTypeText:!0};if(t.messageType.type,n.mediaType!=null){var r={contentTypeMediaOrMedianotifyMixinGroupArgs:{isContentTypeMedia:!0},encMediaTypeEncMediaTypeOrEncMediaTypeDeprecatedMixinGroupArgs:{encMediaType:{encMediatype:n.mediaType}}};return{contentTypeMediaSingle:r}}return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["WASendMsgRPC: Wrong media type: ",""])),t.messageType.mediaType),{isContentTypeText:!0}}function p(e,t){var n=e!=null?{encCount:e}:null,r=t!=null?{messageRecipient:t}:null;return{encRetryMixinArgs:n,individualIndividualRetryToPeerMixinArgs:r}}function _(e){return{encType:e.type,encElementValue:e.ciphertext}}function f(e){return e.v==="2"?{isEncVersion2:!0}:{isEncVersion3:!0}}function g(e){return e.type==="text"&&e.isRevoked?{isRevoke:!0}:null}function h(e){try{var t=BigInt(e)}catch(t){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[WASendMsgRPC] Sending message with not allowed stanzaId: ",", error: ",""])),e,t)}}function y(e){return e.type==="reaction"||e.isInvisible===!0||e.isEdit===!0}l.sendStanza=u,l.createEncWapNode=c}),98);
__d("WASendMsgInternal",["FBLogger","WABridge","WADevicesState","WAEncGroupMsg","WAEncUserMsg","WAGlobals","WAJids","WALogger","WAMarkSenderKeyAsSentApi","WAOdsEnums","WAQueryGroupsAndSync","WAResultOrError","WASendMsgRPC"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=10002,_=10009;async function f(e,t){var n,a,i,l;t.addPoint("encrypt_start",{string:{sentMessageType:e.messageType.isRevoked===!0?"revoke":e.messageType.type},bool:{isInvisibleMsg:e.messageType.type==="text"&&e.messageType.isInvisible===!0}});var s=await o("WAGlobals").getWaOneQueue().enqueue(function(n){var r=n.cryptoManager;return e.type==="chat"?b(e,t,2,{cryptoManager:r}):C(e,{cryptoManager:r},2)},{operationType:"encrypt",flush:!0});if(t.addPoint("finish_encrypt",{string:{chatType:s.success?s.value.type:s.error}}),s.success===!1)throw r("FBLogger")("wmi").mustfixThrow("Encryption failed %s",s.error);var u=s.value;t.addPoint("sending_stanza_start",{string:{encryptionType:u.type},int:{ciphertextByteLength:(n=(a=(i=u.message)==null||(i=i.ciphertext)==null?void 0:i.length)!=null?a:(l=u.participants)==null||(l=l[0].ciphertext)==null?void 0:l.length)!=null?n:0}});var c=await o("WASendMsgRPC").sendStanza(e,u,e.reportingMeta,t);return t.addPoint("sending_stanza_end",{bool:{wai:c.type==="success"}}),{serverResponse:c,encryption:u}}async function g(t,n,r){var a,i,l,s;r===void 0&&(r=!1),R(t,n);var u=r?3:2,c=function(r){return t.type==="chat"?b(t,n,u,{cryptoManager:r}):C(t,{cryptoManager:r},u)},d=await o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return c(t)},{operationType:"encrypt",flush:!0}),m=d.success?d.value.type:d.error;if(n.addPoint("finish_encrypt",{string:{chatType:m}}),d.success===!1)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MAWSendMsg Failed to encrypt message for "," message"])),m),o("WAResultOrError").makeError({type:"encryption-error",isRetriable:!1});var _=d.value;n.addPoint("sending_stanza_start",{string:{encryptionType:_.type},int:{ciphertextByteLength:(a=(i=(l=_.message)==null||(l=l.ciphertext)==null?void 0:l.length)!=null?i:(s=_.participants)==null||(s=s[0].ciphertext)==null?void 0:s.length)!=null?a:0}});var f=await o("WASendMsgRPC").sendStanza(t,_,t.reportingMeta,n,r);if(n.addPoint("sending_stanza_end"),f.type==="success"){n.addPoint("send_stanza_success");try{var g,h=await Promise.all([v(t,_,f,n),S(_)]),y=h[0];return n.addPoint("mark_sender_key_sent"),o("WAResultOrError").makeResult({baseKey:(g=_.message)==null?void 0:g.baseKey,reportingMeta:f.reportingMeta,serverTs:f.ts,meta:{pOrDhashMismatch:y}})}catch(e){throw n.addPoint("send_stanza_failed"),e}}if(f.type,L(f,m,n),f.applicationError===p&&await o("WAGlobals").getDependencies().handleReachabilityErrorAdminMsg(t.chat),f.type==="parsing_error")return o("WAResultOrError").makeError({type:"result-parsing-error",isRetriable:!0});if(f.type==="error"){var E=f.errorCode!=null&&f.errorCode>=500;return E?o("WAResultOrError").makeError({type:"retryable-error",backoff:f.backoff,isRetriable:!0}):o("WAResultOrError").makeError({type:"non-retryable-error",applicationErrorCode:f.applicationError,errorCode:f.errorCode,isRetriable:!1})}return o("WAResultOrError").makeError({type:"unexpected-message-codepath",details:"impossible-server-error-result",isRetriable:!0,applicationErrorCode:f.applicationError})}function h(e){return o("WADevicesState").getDevicesState().reset([e]),o("WADevicesState").getDevicesState().waitForUserDevices([e],"SendMsgUtil_recoverUser",!0)}function y(e){return o("WAJids").switchOnChatJidType(e,{interopUser:h,msgrUser:h,lidUser:h,phoneUser:h,group:function(t){return o("WAQueryGroupsAndSync").queryGroupsAndSync({groupJids:[t],ignoreDhash:!0})}})}async function C(e,t,n){var r=e.backupDirective,a=e.chat,i=e.count,l=e.identityKey,s=e.messageBytes,u=e.messageType,c=e.sessionInfo,d=e.to,m=await o("WAEncUserMsg").encryptDeviceJidMessage(d,{type:"message",chat:a,messageBytes:s,messageType:u,applicationPayloadVersion:n,backupDirective:r},t,i,c,l);return o("WAJids").switchOnUserChatJidType(a,{user:function(n){return m!=null?o("WAResultOrError").makeResult({type:"direct_user",messageTo:e.to,message:m,recipient:o("WAGlobals").isPeerDevice(e.to)?n:null}):o("WAResultOrError").makeError("direct_user")},group:function(n){return m!=null?o("WAResultOrError").makeResult({type:"direct_group",messageTo:n,participant:e.to,message:m}):o("WAResultOrError").makeError("direct_group")}})}function b(e,t,n,r){var a=e.backupDirective,i=e.chat,l=e.messageBytes,c=e.messageType,d=e.recipients;return o("WAJids").switchOnUserChatJidType(i,{user:async function(i){var e=await o("WAEncUserMsg").encryptUserMsg(d,{type:"message",messageBytes:l,messageType:c,chat:i,applicationPayloadVersion:n,backupDirective:a},r,t),s=e.participants;return s!=null&&s.length>0?o("WAResultOrError").makeResult({type:"user",messageTo:i,participants:s,phash:e.phash}):o("WAResultOrError").makeError("user")},group:async function(n){o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg -- encryptChatMessage -- group message"])));var e=await o("WAEncGroupMsg").encryptGroupMsg(n,d,l,c,r,a,t);o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg -- encryptChatMessage -- finish encrypt group message"])));var i=e.encNode,m=e.participants;return m==null&&i==null?o("WAResultOrError").makeError("group"):o("WAResultOrError").makeResult({type:"group",messageTo:n,participants:m,message:i,senderKeyDistributionInfo:e.senderKeyDistributionInfo,phash:e.phash})}})}async function v(e,t,n,r){if(n.type!=="success")return!1;var a=n.phash;return a.type==="mismatch"?(r.addPoint("phash_mismatch"),o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch, local[","] server[","]"])),a.local,a.server),o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PHASH_MISMATCH,key:t.type}),await y(e.chat),r.addPoint("participant_recovery_finished"),!0):!1}async function S(e){if(e.senderKeyDistributionInfo!=null){var t=e.senderKeyDistributionInfo,n=t.group,r=t.knowsSenderKey,a=t.senderKeyId;await o("WAMarkSenderKeyAsSentApi").markSenderKeyAsSent(n,a,r)}}function R(e,t){var n=0;e.type==="chat"&&(n=e.recipients.reduce(function(e,t){return e+t.devicesInfo.length},0)),t.addPoint("start_encrypt",{int:{numDevices:n},bool:{isInvisibleMsg:e.messageType.type==="text"&&e.messageType.isInvisible===!0}})}function L(e,t,n){if(e.type!=="success"){e.type==="parsing_error"&&(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["sendMessage ack success is false, chatType:",""])),t),n.addPoint("ack_parse_fail"));var r=e.applicationError,a=e.errorCode;r===p&&n.addPoint("reachability_error_code"),o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["sendMessage ack success is true, error: ",", applicationError: ",", chatType:",""])),a,r,t),a!=null&&n.addPoint("ack_success_error_"+a,{int:{applicationError:r}}),r===_&&n.addPoint("sender_blocked",{})}}l.sendMessageV2=f,l.sendMessage=g}),98);
__d("WASentBytesCacheApi",["MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(e=o("WADbTransactor")).makeSignalTransactor({sentBytesCache:(s=o("MAWTransactionMode")).READWRITE},"deleteSentBytes",function(e){return function(t){return e.sentBytesCache.bulkDelete(t)}}),c=e.makeSignalTransactor({sentBytesCache:s.READONLY},"loadExpired",function(e){return function(t){return e.sentBytesCache.where("ts").belowOrEqual(t).toArray().then(function(e){return e.map(function(e){return e.waMsgId})})}}),d=e.makeSignalTransactor({sentBytesCache:s.READONLY},"loadSentBytes",function(e){return function(t){return e.sentBytesCache.bulkGet(t).then(function(e){return e.filter(Boolean)})}}),m=e.makeSignalTransactor({sentBytesCache:s.READWRITE},"saveSentBytes",function(e){return function(t){return e.sentBytesCache.put(t).then(function(){})}});l.deleteSentBytes=u,l.loadExpired=c,l.loadSentBytes=d,l.saveSentBytes=m}),98);
__d("WASentBytesCache",["WAGlobals","WAJids","WAMsg","WASentBytesCacheApi","WATagsLogger","WATimeUtils","WAWaitForUserUnblocked","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["SentBytesCache"]),c=720*60*60,d=(function(){function t(){var t=this;o("WAWaitForUserUnblocked").waitForUserUnblocked().then(function(){t.$1().catch(function(t){u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to prune sent bytes: ",""])),t)})})}var n=t.prototype;return n.loadSentBytes=function(t){return o("WASentBytesCacheApi").loadSentBytes(t)},n.getMsgsForRetry=async function(t){var e=Array.from(new Set(t.map(function(e){var t=e.deviceJid;return o("WAJids").extractUserJid(t)}))),n=new Map;try{n=await o("WAGlobals").getWaOneQueue().enqueue(function(t){var n=t.cryptoManager;return n.storage.bulkLoadIdentities(e)},{operationType:"retries_load_identities",flush:!1,afterInit:!0})}catch(e){var a=r("getErrorSafe")(e);u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["It fails to bulkLoadIdentities: ",""])),a.toString())}var i=await this.loadSentBytes(t.map(function(e){var t=e.protocolMsgId;return o("WAMsg").craftWAMsgIdString({author:t.author,chat:t.chat,externalId:t.externalId})}));return t.map(function(e){var t,r=e.deviceJid,a=e.protocolMsgId,l=o("WAMsg").craftWAMsgIdString({author:a.author,chat:a.chat,externalId:a.externalId}),s=(t=n.get(o("WAJids").extractUserJid(r)))==null?void 0:t.get(r);if(s==null)return{type:"unauthorized"};var u=i.find(function(e){return e.waMsgId===l});return u==null?{type:"missing"}:o("WATimeUtils").happenedWithin(u.ts,c)?{frankingKey:u.frankingKey,frankingVersion:u.frankingVersion,messageBytes:u.messageBytes,backupDirective:u.backupDirective,messageType:u.messageType,protocolMsgId:u.protocolMsgId,retryCount:e.retryCount+1,type:"unacked",serverTs:u.ts}:{type:"unauthorized"}})},n.saveSentBytes=function(t){return o("WASentBytesCacheApi").saveSentBytes(t)},n.$1=function(){return o("WASentBytesCacheApi").loadExpired(o("WATimeUtils").pastUnixTime(c)).then(function(e){return o("WASentBytesCacheApi").deleteSentBytes(e)})},t})(),m=new d;function p(){return m}l.SentBytesCache=d,l.sentBytesCache=p}),98);
__d("WASmaxInAppdataPublishAckMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"ack");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",r.value);if(!a.success)return a;var i=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"class","appdata");if(!i.success)return i;var l=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",l.value);if(!s.success)return s;var u=o("WASmaxParseUtils").attrIntRange(e,"t",0,void 0);return u.success?o("WAResultOrError").makeResult({class:i.value,t:u.value}):u}l.parseAckMixin=e}),98);
__d("WASmaxInAppdataPublishPeerResponseNegative",["WAResultOrError","WASmaxInAppdataPublishAckMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"ack");if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(e,"error");if(!r.success)return r;var a=o("WASmaxInAppdataPublishAckMixin").parseAckMixin(e,t);return a.success?o("WAResultOrError").makeResult(babelHelpers.extends({error:r.value},a.value)):a}l.parsePeerResponseNegative=e}),98);
__d("WASmaxInAppdataPublishDeviceListStaleMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"ack");if(!t.success)return t;var n=o("WASmaxParseUtils").attrString(e,"phash");return n.success?o("WAResultOrError").makeResult({phash:n.value}):n}l.parseDeviceListStaleMixin=e}),98);
__d("WASmaxInAppdataPublishPeerResponseSuccess",["WAResultOrError","WASmaxInAppdataPublishAckMixin","WASmaxInAppdataPublishDeviceListStaleMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"ack");if(!n.success)return n;var r=o("WASmaxInAppdataPublishAckMixin").parseAckMixin(e,t);if(!r.success)return r;var a=o("WASmaxInAppdataPublishDeviceListStaleMixin").parseDeviceListStaleMixin(e);return o("WAResultOrError").makeResult(babelHelpers.extends({},r.value,{deviceListStaleMixin:a.success?a.value:null}))}l.parsePeerResponseSuccess=e}),98);
__d("WASmaxOutAppdataPublishDeviceIdentityMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.deviceIdentityElementValue,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("device-identity",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeDeviceIdentityMixin=s}),98);
__d("WASmaxOutAppdataPublishInternalTestMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.testConfig,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxJsx").smax("test",{config:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t)}));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeInternalTestMixin=s}),98);
__d("WASmaxOutAppdataPublishRequestIDMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.requestIdElementValue,n=o("WASmaxJsx").smax("trace",null,o("WASmaxJsx").smax("request_id",null,t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeRequestIDMixin=s}),98);
__d("WASmaxOutAppdataPublishTraceIDMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.edgeIdElementValue,n=o("WASmaxJsx").smax("edge_id",null,t);return n}function s(e){var t=e.deviceArgs,n=e.correlationIdType,r=e.idElementValue,a=o("WASmaxJsx").smax("correlation_id",{type:o("WAWap").CUSTOM_STRING(n)},o("WASmaxJsx").smax("id",null,r),o("WASmaxChildren").OPTIONAL_CHILD(u,t));return a}function u(e){var t=e.deviceId,n=o("WASmaxJsx").smax("device",{id:o("WAWap").INT(t)});return n}function c(t){var n=t.edgeIdArgs,r=t.correlationIdArgs,a=t.traceIdElementValue,i=o("WASmaxJsx").smax("trace",null,[o("WASmaxJsx").smax("trace_id",null,a),o("WASmaxChildren").OPTIONAL_CHILD(e,n)].concat(o("WASmaxChildren").REPEATED_CHILD(s,r,0,10)));return i}function d(e,t){var n=c(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makeTraceIDEdgeId=e,l.makeTraceIDCorrelationId=s,l.makeTraceIDCorrelationIdDevice=u,l.mergeTraceIDMixin=d}),98);
__d("WASmaxOutAppdataPublishRequestOrTraceIDMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutAppdataPublishRequestIDMixin","WASmaxOutAppdataPublishTraceIDMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.requestID)return o("WASmaxOutAppdataPublishRequestIDMixin").mergeRequestIDMixin(e,t.requestID);if(t.traceID)return o("WASmaxOutAppdataPublishTraceIDMixin").mergeTraceIDMixin(e,t.traceID);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergeRequestOrTraceIDMixinGroup=e}),98);
__d("WASmaxOutAppdataPublishTraceContextMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutAppdataPublishRequestOrTraceIDMixinGroup"],(function(t,n,r,o,a,i,l){function e(e){var t=e.requestOrTraceIDMixinGroupArgs,n=o("WASmaxJsx").smax("smax$any",null,o("WASmaxOutAppdataPublishRequestOrTraceIDMixinGroup").mergeRequestOrTraceIDMixinGroup(o("WASmaxJsx").smax("trace",null),t));return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeTraceContextMixin=s}),98);
__d("WASmaxOutAppdataPublishWithDeviceListCheckMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.appdataDeviceListCheck,n=o("WASmaxJsx").smax("appdata",{device_list_check:o("WAWap").CUSTOM_STRING(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeWithDeviceListCheckMixin=s}),98);
__d("WASmaxOutAppdataPublishBaseMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutAppdataPublishDeviceIdentityMixin","WASmaxOutAppdataPublishInternalTestMixin","WASmaxOutAppdataPublishTraceContextMixin","WASmaxOutAppdataPublishWithDeviceListCheckMixin"],(function(t,n,r,o,a,i,l){function e(e){var t,n=e.deviceIdentityMixinArgs,r=e.withDeviceListCheckMixinArgs,a=e.internalTestMixinArgs,i=e.traceContextMixinArgs,l=(t=o("WASmaxMixins")).optionalMerge(o("WASmaxOutAppdataPublishTraceContextMixin").mergeTraceContextMixin,t.optionalMerge(o("WASmaxOutAppdataPublishInternalTestMixin").mergeInternalTestMixin,t.optionalMerge(o("WASmaxOutAppdataPublishWithDeviceListCheckMixin").mergeWithDeviceListCheckMixin,t.optionalMerge(o("WASmaxOutAppdataPublishDeviceIdentityMixin").mergeDeviceIdentityMixin,o("WASmaxJsx").smax("appdata",null),n),r),a),i);return l}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeBaseMixin=s}),98);
__d("WASmaxOutAppdataPublishEncPayloadMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encElementValue,n=o("WASmaxJsx").smax("enc",null,t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncPayloadMixin=s}),98);
__d("WASmaxOutAppdataPublishEncTypeIndividualMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutAppdataPublishEncPayloadMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encType,n=o("WASmaxOutAppdataPublishEncPayloadMixin").mergeEncPayloadMixin(o("WASmaxJsx").smax("enc",{type:o("WAWap").CUSTOM_STRING(t)}),e);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncTypeIndividualMixin=s}),98);
__d("WASmaxOutAppdataPublishEncVersionFutureproofMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encV,n=o("WASmaxJsx").smax("enc",{v:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncVersionFutureproofMixin=s}),98);
__d("WASmaxOutAppdataPublishPeerPeerFanoutMixin",["WASmaxChildren","WASmaxJsx","WASmaxMixins","WASmaxOutAppdataPublishEncTypeIndividualMixin","WASmaxOutAppdataPublishEncVersionFutureproofMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.toJid,n=e.encVersionFutureproofMixinArgs,r=e.encTypeIndividualMixinArgs,a=o("WASmaxJsx").smax("to",{jid:o("WAWap").DEVICE_JID(t)},o("WASmaxOutAppdataPublishEncTypeIndividualMixin").mergeEncTypeIndividualMixin(o("WASmaxOutAppdataPublishEncVersionFutureproofMixin").mergeEncVersionFutureproofMixin(o("WASmaxJsx").smax("enc",null),n),r));return a}function s(t){var n=t.toArgs,r=t.appdataTo,a=o("WASmaxJsx").smax("appdata",{to:o("WAWap").USER_JID(r)},o("WASmaxJsx").smax("participants",null,o("WASmaxChildren").REPEATED_CHILD(e,n,1,24)));return a}function u(e,t){var n=s(t);return o("WASmaxMixins").mergeStanzas(e,n)}l.makePeerPeerFanoutParticipantsTo=e,l.mergePeerPeerFanoutMixin=u}),98);
__d("WASmaxOutAppdataPublishEncRetryMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.encCount,n=o("WASmaxJsx").smax("enc",{count:o("WAWap").INT(t)});return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeEncRetryMixin=s}),98);
__d("WASmaxOutAppdataPublishRetryMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutAppdataPublishEncRetryMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.appdataT,n=e.encRetryMixinArgs,r=o("WASmaxJsx").smax("appdata",{t:o("WAWap").INT(t)},o("WASmaxOutAppdataPublishEncRetryMixin").mergeEncRetryMixin(o("WASmaxJsx").smax("enc",null),n));return r}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeRetryMixin=s}),98);
__d("WASmaxOutAppdataPublishPeerPeerSingleMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutAppdataPublishEncTypeIndividualMixin","WASmaxOutAppdataPublishEncVersionFutureproofMixin","WASmaxOutAppdataPublishRetryMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.appdataTo,n=e.retryMixinArgs,r=e.encVersionFutureproofMixinArgs,a=e.encTypeIndividualMixinArgs,i=o("WASmaxMixins").optionalMerge(o("WASmaxOutAppdataPublishRetryMixin").mergeRetryMixin,o("WASmaxJsx").smax("appdata",{to:o("WAWap").DEVICE_JID(t)},o("WASmaxOutAppdataPublishEncTypeIndividualMixin").mergeEncTypeIndividualMixin(o("WASmaxOutAppdataPublishEncVersionFutureproofMixin").mergeEncVersionFutureproofMixin(o("WASmaxJsx").smax("enc",null),r),a)),n);return i}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergePeerPeerSingleMixin=s}),98);
__d("WASmaxOutAppdataPublishPeerMsgTypes",["WASmaxMixinGroupExhaustiveError","WASmaxOutAppdataPublishPeerPeerFanoutMixin","WASmaxOutAppdataPublishPeerPeerSingleMixin"],(function(t,n,r,o,a,i,l){function e(e,t){if(t.peerPeerFanout)return o("WASmaxOutAppdataPublishPeerPeerFanoutMixin").mergePeerPeerFanoutMixin(e,t.peerPeerFanout);if(t.peerPeerSingle)return o("WASmaxOutAppdataPublishPeerPeerSingleMixin").mergePeerPeerSingleMixin(e,t.peerPeerSingle);throw new(o("WASmaxMixinGroupExhaustiveError")).SmaxMixinGroupExhaustiveError}l.mergePeerMsgTypes=e}),98);
__d("WASmaxOutAppdataPublishPeerRequest",["WASmaxAttrs","WASmaxJsx","WASmaxOutAppdataPublishBaseMixin","WASmaxOutAppdataPublishPeerMsgTypes","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.appdataId,n=e.appdataPushPriority,r=e.peerMsgTypesArgs,a=o("WASmaxOutAppdataPublishPeerMsgTypes").mergePeerMsgTypes(o("WASmaxOutAppdataPublishBaseMixin").mergeBaseMixin(o("WASmaxJsx").smax("appdata",{id:o("WAWap").STANZA_ID(t),category:"peer",push_priority:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,n)}),e),r);return a}l.makePeerRequest=e}),98);
__d("WASmaxAppdataPublishPeerRPC",["WAComms","WASmaxInAppdataPublishPeerResponseNegative","WASmaxInAppdataPublishPeerResponseSuccess","WASmaxOutAppdataPublishPeerRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(t,n,r,o,a,i,l){async function e(e,t){var n=o("WASmaxOutAppdataPublishPeerRequest").makePeerRequest(e),r=await o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInAppdataPublishPeerResponseNegative").parsePeerResponseNegative(r,n);if(a.success)return{name:"PeerResponseNegative",value:a.value};var i=o("WASmaxInAppdataPublishPeerResponseSuccess").parsePeerResponseSuccess(r,n);if(i.success)return{name:"PeerResponseSuccess",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("Peer",{Negative:a,Success:i}))}l.sendPeerRPC=e}),98);